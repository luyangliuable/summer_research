 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2009 Nokia Corporation

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

 *

 * VENC settings from TI's DSS driver

 Venc registers */

 from TRM */

 863 */

 624 */

 from TRM */

 the magical sleep that makes things work */

 XXX more info? What bug this circumvents? */

 S-Video */

/* -----------------------------------------------------------------------------

 * DRM Bridge Operations

/* -----------------------------------------------------------------------------

 * Component Bind & Unbind

/* -----------------------------------------------------------------------------

 * Probe & Remove, Suspend & Resume

 sentinel */ }

 The OMAP34xx, OMAP35xx and AM35xx VENC require the TV DAC clock. */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * HDMI driver for OMAP5

 *

 * Copyright (C) 2014 Texas Instruments Incorporated - https://www.ti.com/

 *

 * Authors:

 *	Yong Zhi

 *	Mythri pk

 *	Archit Taneja <archit@ti.com>

 *	Tomi Valkeinen <tomi.valkeinen@ti.com>

		/*

		 * If we get both connect and disconnect interrupts at the same

		 * time, turn off the PHY, clear interrupts, and restart, which

		 * raises connect interrupt if a cable is connected, or nothing

		 * if cable is not connected.

		/*

		 * We always get bogus CONNECT & DISCONNECT interrupts when

		 * setting the PHY to LDOON. To ignore those, we force the RXDET

		 * line to 0 until the PHY power state has been changed.

 FORCE_RXDET_HIGH */

 RXDET_LINE */

 Make selection of HDMI in DSS */

 DSS_HDMI_TCLK is bitclk / 10 */

 disable and clear irqs */

/* -----------------------------------------------------------------------------

 * DRM Bridge Operations

	/*

	 * None of these should fail, as the bridge can't be enabled without a

	 * valid CRTC to connector path with fully populated new states.

 No-idle mode */

/* -----------------------------------------------------------------------------

 * Audio Callbacks

/* -----------------------------------------------------------------------------

 * Component Bind & Unbind

/* -----------------------------------------------------------------------------

 * Probe & Remove, Suspend & Resume

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2011 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Chandrabhanu Mahapatra <cmahapatra@ti.com>

		/*

		 * When upscaling more than two times, blockiness and outlines

		 * around the image are observed when M8 tables are used. M11,

		 * M16 and M19 tables are used to prevent this.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Archit Taneja <archit@ti.com>

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2009 Nokia Corporation

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

 Note: for some reason video mode seems to work only if VC_VIDEO is 0 */

 first busyloop to see if the bit changes right away */

 then loop for 500ms, sleeping for 1ms in between */

 IRQ is not for us */

 flush posted write */

 flush posted write */

 flush posted write */

	/* make a copy and unlock, so that isrs can unregister

 dsi->irq_lock has to be locked by the caller */

 clear the irqstatus for newly enabled irqs */

 flush posted writes */

 dsi->irq_lock has to be locked by the caller */

 dsi->irq_lock has to be locked by the caller */

 dsi->irq_lock has to be locked by the caller */

 check for duplicate entry and find a free slot */

	/* A dummy read using the SCP interface to any DSIPHY register is

	 * required after DSIPHY reset to complete the reset of the DSI complex

 IF_EN */

 DSI FCLK source is DSS_CLK_FCK */

 DSI FCLK source is dsi_pll_hsdiv_dsi_clk */

 LP_CLK_DIVISOR */

 LP_RX_SYNCHRO_ENABLE */

 CIO_CLK_ICG */

 CIO_CLK_ICG */

 DSI-PLL power command 0x3 is not working */

 PLL_PWR_CMD */

 PLL_PWR_STATUS */

	/*

	 * Note: SCP CLK is not required on OMAP3, but it is required on OMAP4.

 XXX PLL does not come out of reset without this... */

	/* XXX ... but if left on, we get problems when planes do not

 PWR_CMD */

 PWR_STATUS */

 line buffer on OMAP3 is 1024 x 24bits */

	/* XXX: for some reason using full buffer size causes

	 * considerable TX slowdown with update sizes that fill the

 VP1_LINE_BUFFER_SIZE */

 512x24 bits */

 682x24 bits */

 853x24 bits */

 1024x24 bits */

 1194x24 bits */

 1365x24 bits */

 1920x24 bits */

 clear the unused lanes */

 convert time in ns to ddr ticks, rounding up */

 calculate timings */

 1 * DDR_CLK = 2 * UI */

 min 40ns + 4*UI	max 85ns + 6*UI */

 min 145ns + 10*UI */

 min max(8*UI, 60ns+4*UI) */

 min 100ns */

 tlpx min 50n */

 min 60ns */

 min 38ns, max 95ns */

 min tclk-prepare + tclk-zero = 300ns */

 program timings */

 DCCEN = disable */

 CLKINP_DIVBY2EN = enable */

 CLKINP_SEL = enable */

 return bitmask of enabled lanes, lane0 being the lsb */

 OMAP4 CONTROL_DSIPHY */

 OMAP5 CONTROL_DSIPHY */

	/* A dummy read using the SCP interface to any DSIPHY register is

	 * required after DSIPHY reset to complete the reset of the DSI complex

 set TX STOP MODE timer to maximum for this operation */

 FORCE_TX_STOP_MODE_IO */

 STOP_STATE_X16_IO */

 STOP_STATE_X4_IO */

 STOP_STATE_COUNTER_IO */

 LP_CLK_ENABLE */

 FORCE_TX_STOP_MODE_IO */

 DDR_CLK_ALWAYS_ON */

 LP_CLK_ENABLE */

 DDR_CLK_ALWAYS_ON */

DSSDBG("TX FIFO vc %d: size %d, add %d\n", i, size, add); */

DSSDBG("RX FIFO vc %d: size %d, add %d\n", i, size, add); */

 FORCE_TX_STOP_MODE_IO */

 Wait for completion only if TE_EN/TE_START is still set */

 Wait for completion only if TX_FIFO_NOT_EMPTY is still set */

 VC_BUSY */

 SOURCE, 0 = L4 */

 BTA_SHORT_EN  */

 BTA_LONG_EN */

 MODE, 0 = command */

 CS_TX_EN */

 ECC_TX_EN */

 MODE_SPEED, high speed on/off */

 OCP_WIDTH = 32 bit */

 DMA_RX_REQ_NB = no dma */

 DMA_TX_REQ_NB = no dma */

 RX_FIFO_NOT_EMPTY */

 RX_FIFO_NOT_EMPTY */

 BTA_EN */

 flush posted write */

/*	DSSDBG("\twriting %02x, %02x, %02x, %02x (%#010x)\n",

u32 val; */

 len + header */

	/*

	 * TODO: we do not always have to do the BTA sync, for example

	 * we can improve performance by setting the update window

	 * information without sending BTA sync between the commands.

	 * In that case we can return early.

 RX_FIFO_NOT_EMPTY */

 RX_FIFO_NOT_EMPTY */

 two byte checksum ends the packet, not included in len */

 we discard the 2 byte checksum */

 ticks in DSI_FCK */

 LP_RX_TO */

 LP_RX_TO_X16 */

 LP_RX_TO_X4 */

 LP_RX_COUNTER */

 ticks in DSI_FCK */

 TA_TO */

 TA_TO_X16 */

 TA_TO_X8 */

 TA_TO_COUNTER */

 ticks in DSI_FCK */

 FORCE_TX_STOP_MODE_IO */

 STOP_STATE_X16_IO */

 STOP_STATE_X4_IO */

 STOP_STATE_COUNTER_IO */

 ticks in TxByteClkHS */

 HS_TX_TO */

 HS_TX_TO_X16 */

 HS_TX_TO_X8 (4 really) */

 HS_TX_TO_COUNTER */

		/*

		 * Don't use line buffers if width is greater than the video

		 * port's line buffer size

 Use maximum number of line buffers in command mode */

 LINE_BUFFER */

 VP_DE_POL */

 VP_HSYNC_POL */

 VP_VSYNC_POL */

 VP_VSYNC_START */

 VP_VSYNC_END */

 VP_HSYNC_START */

 VP_HSYNC_END */

	/*

	 * 0 = TX FIFO packets sent or LPS in corresponding blanking periods

	 * 1 = Long blanking packets are sent in corresponding blanking periods

 BLANKING_MODE */

 HFP_BLANKING */

 HBP_BLANKING */

 HSA_BLANKING */

/*

 * According to section 'HS Command Mode Interleaving' in OMAP TRM, Scenario 3

 * results in maximum transition time for data and clock lanes to enter and

 * exit HS mode. Hence, this is the scenario where the least amount of command

 * mode data can be interleaved. We program the minimum amount of TXBYTECLKHS

 * clock cycles that can be used to interleave command mode data in HS so that

 * all scenarios are satisfied.

	/*

	 * If DDR_CLK_ALWAYS_ON is set, we need to consider HS mode transition

	 * time of data lanes only, if it isn't set, we need to consider HS

	 * transition time of both data and clock lanes. HS transition time

	 * of Scenario 3 is considered.

/*

 * According to section 'LP Command Mode Interleaving' in OMAP TRM, Scenario 1

 * results in maximum transition time for data lanes to enter and exit LP mode.

 * Hence, this is the scenario where the least amount of command mode data can

 * be interleaved. We program the minimum amount of bytes that can be

 * interleaved in LP so that all scenarios are satisfied.

 time required for a LP transition, in TXBYTECLKHS */

 time left for interleaving commands, in CLKIN4DDR */

 period of LP transmit escape clock, in CLKIN4DDR */

 Period of TXBYTECLKHS clock, in CLKIN4DDR */

 cmd mode data that can be interleaved, in bytes */

 maximum LP transition time according to Scenario 1 */

 CLKIN4DDR = 16 * TXBYTECLKHS */

 XXX what values for the timeouts? */

 CS_RX_EN */

 ECC_RX_EN */

 TX_FIFO_ARBITRATION */

 VP_CLK_RATIO, always 1, see errata*/

 VP_DATA_BUS_WIDTH */

 VP_CLK_POL */

 TRIGGER_RESET_MODE */

 EOT_ENABLE */

 DCS_CMD_ENABLE */

 DCS_CMD_CODE, 1=start, 0=continue */

 min 8*UI */

 min 60ns + 52*UI */

 TODO: Implement a video mode check_timings function */

 TL = t_HS + HSA + t_HE + HFP + ceil((WC + 6) / NDL) + HBP */

 HBP */

 HFP */

 HSA */

 VBP */

 VFP */

 VSA */

 WINDOW_SYNC */

 VACT */

 TL */

 MODE, 1 = video mode */

 MODE, 0 = command mode */

	/* NOTE: packet_payload has to be equal to N * bytespl, where N is

 1 byte for DCS cmd */

 TE_SIZE */

 TE_EN */

 TE_START */

	/* We put SIDLEMODE to no-idle for the duration of the transfer,

	 * because DSS interrupts are not capable of waking up the CPU and the

	 * framedone interrupt could be delayed for quite a long time. I think

	 * the same goes for any DSS interrupts, but for some reason I have not

	 * seen the problem anywhere else than here.

		/* disable LP_RX_TO, so that we can receive TE.  Time to wait

 LP_RX_TO */

 SIDLEMODE back to smart-idle */

 enable LP_RX_TO again after the TE */

 LP_RX_TO */

	/* XXX While extremely unlikely, we could get FRAMEDONE interrupt after

	 * 250ms which would conflict with this timeout work. What should be

	 * done is first cancel the transfer on the HW, and then cancel the

	 * possibly scheduled framedone work. However, cancelling the transfer

	 * on the HW is buggy, and would probably require resetting the whole

	/* Note: We get FRAMEDONE when DISPC has finished sending pixels and

	 * turns itself off. However, DSI still has the pixels in its buffers,

	 * and is sending the data.

	/*

	 * Send NOP between the frames. If we don't send something here, the

	 * updates stop working. This is probably related to DSI spec stating

	 * that the DSI host should transition to LP at least once per frame.

 Display funcs */

 Setup VC_CMD for LP and cpu transfers */

 LP */

 SOURCE_L4 */

 Setup VC_VIDEO for HS and dispc transfers */

 HS */

 SOURCE_VP */

 DCS_CMD_ENABLE */

 start the DDR clock by sending a NULL packet */

 disable interface */

 pixel packet size */

 note: this is not quite accurate */

 PRINT_VERBOSE_VM_TIMINGS */

	/*

	 * Here we should calculate minimum txbyteclk to be able to send the

	 * frame in time, and also to handle TE. That's not very simple, though,

	 * especially as we go to LP between each pixel packet due to HW

	 * "feature". So let's just estimate very roughly and multiply by 1.5.

 pixels */

 pixels */

 byteclks */

	/*

	 * When there are no line buffers, DISPC and DSI must have the

	 * same tput. Otherwise DISPC tput needs to be higher than DSI's.

 DSI tput must be over the min requirement */

 When non-burst mode, DSI tput must be below max requirement. */

 DSI htot to match the panel's nominal pck */

 fail if there would be no time for blanking */

 total DSI blanking needed to achieve panel's TL */

 DISPC htot to match the DSI TL */

 verify that the DSI and DISPC TLs are the same */

 setup DSI videomode */

 we need to take cycles from hbp */

 we need to take cycles from hsa */

 setup DISPC videomode */

 we need to take cycles from hbp */

 we need to take cycles from hsa */

	/*

	 * In burst mode we can let the dispc pck be arbitrarily high, but it

	 * limits our scaling abilities. So for now, don't aim too high.

 these limits should come from the panel driver */

	/*

	 * override interlace, logic level and edge related parameters in

	 * videomode with default values

	/*

	 * HACK: These flags should be handled through the omap_dss_device bus

	 * flags, but this will only be possible when the DSI encoder will be

	 * converted to the omapdrm-managed encoder model.

/*

 * Return a hardcoded dispc channel for the DSI output. This should work for

 * current use cases, but this can be later expanded to either resolve

 * the channel in some more dynamic manner, or get the channel as a user

 * parameter.

 TODO: get from client?

 TODO: get from client?

/* -----------------------------------------------------------------------------

 * PLL

/* -----------------------------------------------------------------------------

 * Component Bind & Unbind

/* -----------------------------------------------------------------------------

 * DRM Bridge Operations

/* -----------------------------------------------------------------------------

 * Probe & Remove, Suspend & Resume

 sentinel */ }

		/*

		 * The OMAP4/5 display DT bindings don't reference the padconf

		 * syscon. Our only option to retrieve it is to find it by name.

 DSI VCs initialization */

	/* DSI on OMAP3 doesn't have register DSI_GNQ, set number

 NB_DATA_LANES */

 ensure the irq handler sees the is_enabled value */

 wait for current handler to finish before turning the DSI off */

 ensure the irq handler sees the is_enabled value */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * OMAP Display Subsystem Base

 *

 * Copyright (C) 2015-2017 Texas Instruments Incorporated - https://www.ti.com/

/* -----------------------------------------------------------------------------

 * OMAP DSS Devices Handling

/*

 * Search for the next output device starting at @from. Release the reference to

 * the @from device, and acquire a reference to the returned device if found.

	/*

	 * Start from the from entry if given or from omapdss_devices_list

	 * otherwise.

		/*

		 * Stop if we reach the omapdss_devices_list, that's the end of

		 * the list.

		/*

		 * The destination is NULL when the source is connected to a

		 * bridge instead of a DSS device. Stop here, we will attach

		 * the bridge later when we will have a DRM encoder.

/* -----------------------------------------------------------------------------

 * Components Handling

	/*

	 * of_graph_get_remote_port_parent() prints an error if there is no

	 * port/ports node. To avoid that, check first that there's the node.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * HDMI wrapper

 *

 * Copyright (C) 2013 Texas Instruments Incorporated - https://www.ti.com/

 flush posted write */

 PHY_PWR_CMD */

 Return if already the state */

 Command for power control of HDMI PHY */

 Status of the power control of HDMI PHY */

 PLL_PWR_CMD */

 Command for power control of HDMI PLL */

 wait till PHY_PWR_STATUS is set */

 VSYNC_POL to dispc active high */

 HSYNC_POL to dispc active high */

 CORE_VSYNC_INV */

 CORE_HSYNC_INV */

 HDMI_TIMING_MASTER_24BIT */

	/*

	 * On OMAP4 and OMAP5 ES1 the HSW field is programmed as is. On OMAP5

	 * ES2+ (including DRA7/AM5 SoCs) HSW field is programmed to hsync_len-1.

	 * However, we don't support OMAP5 ES1 at all, so we can just check for

	 * OMAP4 here.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * HDMI PLL

 *

 * Copyright (C) 2013 Texas Instruments Incorporated - https://www.ti.com/

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Texas Instruments Incorporated - https://www.ti.com/

 CIO_CLK_ICG */

 CIO_CLK_ICG */

 PLL_POWER_ON_ALL */

	/*

	 * DRA7x PLL CTRL's PLL_PWR_STATUS seems to always return 0,

	 * so we have to use fixed delay here.

 PLL_POWER_OFF */

 PLL CONTROL */

 CLOCK CONTROL */

 CLKIN */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * HDMI interface DSS driver for TI's OMAP4 family of SoCs.

 *

 * Copyright (C) 2010-2011 Texas Instruments Incorporated - https://www.ti.com/

 * Authors: Yong Zhi

 *	Mythri pk <mythripk@ti.com>

		/*

		 * If we get both connect and disconnect interrupts at the same

		 * time, turn off the PHY, clear interrupts, and restart, which

		 * raises connect interrupt if a cable is connected, or nothing

		 * if cable is not connected.

 Make selection of HDMI in DSS */

 disable and clear irqs */

 DSS_HDMI_TCLK is bitclk / 10 */

/* -----------------------------------------------------------------------------

 * DRM Bridge Operations

	/*

	 * None of these should fail, as the bridge can't be enabled without a

	 * valid CRTC to connector path with fully populated new states.

/* -----------------------------------------------------------------------------

 * Audio Callbacks

/* -----------------------------------------------------------------------------

 * Component Bind & Unbind

/* -----------------------------------------------------------------------------

 * Probe & Remove, Suspend & Resume

 SPDX-License-Identifier: GPL-2.0

 TODO: When implemented, query deep color mode here. */

	/*

	 * When using deep color, the default N value (as in the HDMI

	 * specification) yields to an non-integer CTS. Hence, we

	 * modify it while keeping the restrictions described in

	 * section 7.2.1 of the HDMI 1.4a specification.

 Calculate CTS. See HDMI 1.3a or 1.4a specifications */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2009 Nokia Corporation

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

 *

 * Some code and ideas taken from drivers/video/omap/ driver

 * by Imre Deak.

 SDI_PDIV */

 SDI_PRSEL */

 SDI_BWSEL */

 SDI_PLL_FREQSEL */

 SDI_PLL_REGN */

 SDI_PLL_REGM */

 Reset SDI PLL */

 SDI_PLL_SYSRESET */

 wait 2x PCLK */

 Lock SDI PLL */

 SDI_PLL_GOBIT */

 Waiting for PLL lock request to complete */

 Clearing PLL_GO bit */

 Waiting for PLL to lock */

 Waiting for SDI reset to complete */

 Reset SDI PLL */

 SDI_PLL_SYSRESET */

 Reset SDI PLL */

 SDI_PLL_SYSRESET */

	/*

	 * We always use PRCM clock as the DISPC func clock, except on DSS3,

	 * where we don't have separate DISPC and LCD clock sources.

 DISPC_CLK_SWITCH */

 DSIx_CLK_SWITCH */

 LCDx_CLK_SWITCH */

 LCDx_CLK_SWITCH */

 LCDx_CLK_SWITCH */

		/* LCD_CLK source is the same as DISPC_FCLK source for

 venc out selection. 0 = comp, 1 = svideo */

 DAC Power-Down Control */

 Complain about invalid selections */

 Select only if we have options */

 VENC_HDMI_SWITCH */

 DEBUGFS */

 CONFIG_OMAP2_DSS_DEBUGFS */

 CONFIG_OMAP2_DSS_DEBUGFS */

 OMAP_DSS_CHANNEL_LCD */

 OMAP_DSS_CHANNEL_DIGIT */

 OMAP_DSS_CHANNEL_LCD */

 OMAP_DSS_CHANNEL_DIGIT */

 OMAP_DSS_CHANNEL_LCD */

 OMAP_DSS_CHANNEL_DIGIT */

 OMAP_DSS_CHANNEL_LCD */

 OMAP_DSS_CHANNEL_LCD */

 OMAP_DSS_CHANNEL_DIGIT */

 OMAP_DSS_CHANNEL_LCD2 */

 OMAP_DSS_CHANNEL_LCD */

 OMAP_DSS_CHANNEL_DIGIT */

 OMAP_DSS_CHANNEL_LCD2 */

 OMAP_DSS_CHANNEL_LCD3 */

	/*

	 * fck div max is really 16, but the divider range has gaps. The range

	 * from 1 to 6 has no gaps, so let's use that as a max.

 DSS HW IP initialisation */

 sentinel */ }

	/*

	 * HACK

	 * We don't have a working driver for rfbi, so skip it here always.

	 * Otherwise dss will never get probed successfully, as it will wait

	 * for rfbi to get probed.

	/*

	 * Handle possible interconnect target modules defined within the DSS.

	 * The DSS components can be children of an interconnect target module

	 * after the device tree has been updated for the module data.

	 * See also omapdss_boot_init() for compatible fixup.

 Select DPLL */

 venc dac demen */

 venc clock 4x enable */

 venc clock mode = normal */

	/*

	 * The various OMAP3-based SoCs can't be told apart using the compatible

	 * string, use SoC device matching.

 Map I/O registers, get and setup clocks. */

 Setup the video PLLs and the DPI and SDI ports. */

 Enable runtime PM and probe the hardware. */

 Initialize debugfs. */

 Add all the child devices as components. */

	/*

	 * Set an arbitrarily high tput request to ensure OPP100.

	 * What we should really do is to make a request to stay in OPP100,

	 * without any tput requirements, but that is not currently possible

	 * via the PM layer.

 INIT */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Texas Instruments Incorporated - https://www.ti.com/

/*

 * clkdco = clkin / n * m * 2

 * clkoutX = clkdco / mX

/*

 * This calculates a PLL config that will provide the target_clkout rate

 * for clkout. Additionally clkdco rate will be the same as clkout rate

 * when clkout rate is >= min_clkdco.

 *

 * clkdco = clkin / n * m + clkin / n * mf / 262144

 * clkout = clkdco / m2

 Fint */

 adjust m2 so that the clkdco will be high enough */

 adjust clkdco with fractional mf */

 sigma-delta */

 first busyloop to see if the bit changes right away */

 then loop for 500ms, sleeping for 1ms in between */

	/*

	 * Required value for each bitfield listed below

	 *

	 * PLL_STATUS[6] = 0  PLL_BYPASS

	 * PLL_STATUS[5] = 0  PLL_HIGHJITTER

	 *

	 * PLL_STATUS[3] = 0  PLL_LOSSREF

	 * PLL_STATUS[2] = 0  PLL_RECAL

	 * PLL_STATUS[1] = 1  PLL_LOCK

	 * PLL_STATUS[0] = 1  PLL_CTRL_RESET_DONE

 PLL_STOPMODE */

 PLL_REGN */

 PLL_REGM */

 M4 */

 M5 */

 M6 */

 M7 */

 PLL_FREQSEL */

 PLL_SELFREQDCO */

 PLL_REFEN */

 PHY_CLKINEN */

 M4_CLOCK_EN */

 M5_CLOCK_EN */

 HSDIVBYPASS */

 REFSEL = sysclk */

 M6_CLOCK_EN */

 M7_CLOCK_EN */

		/*

		 * Calculate wait time for PLL LOCK

		 * 1000 REFCLK cycles in us.

 PLL_GO */

			/**

			 * read the register back to ensure the write is

			 * flushed

 PLL_GO */

 PHY_CLKINEN */

 M4_CLOCK_EN */

 M5_CLOCK_EN */

 HSDIVBYPASS */

 M6_CLOCK_EN */

 M7_CLOCK_EN */

 PLL_REGM */

 PLL_REGN */

 PLL_HIGHFREQ divide by 2 */

 PLL_REFEN */

 PHY_CLKINEN */

 REFSEL = SYSCLK */

 PLL_SELFREQDCO */

 PLL_REGSD */

 PLL_REGM2 */

 PLL_REGM_F */

 PLL_GO */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * HDMI TI81xx, TI38xx, TI OMAP4 etc IP driver Library

 *

 * Copyright (C) 2010-2011 Texas Instruments Incorporated - https://www.ti.com/

 * Authors: Yong Zhi

 *	Mythri pk <mythripk@ti.com>

 Turn on CLK for DDC */

 IN_PROG */

 Abort transaction */

 IN_PROG */

 Clk SCL Devices */

 HDMI_CORE_DDC_STATUS_IN_PROG */

 Clear FIFO */

 HDMI_CORE_DDC_STATUS_IN_PROG */

 HDMI_CORE_DDC_STATUS_IN_PROG */

 Load Segment Address Register */

 Load Slave Address Register */

 Load Offset Address Register */

 Load Byte Count */

 Set DDC_CMD */

 HDMI_CORE_DDC_STATUS_BUS_LOW */

 HDMI_CORE_DDC_STATUS_NO_ACK */

 IN_PROG */

 FIFO_EMPTY */

 video core */

 HDMI_CORE_VIDEO_CONFIG */

 sys_ctrl1 default configuration not tunable */

 Vid_Mode */

 dither truncation configuration */

 HDMI_Ctrl */

 TMDS_CTRL */

 enable/repeat the infoframe */

 enable/repeat the packet */

 HDMI */

 HDMI core */

 video config */

	/*

	 * configure core video part

	 * set software reset in the core

 release software reset in the core */

 enable/repeat the infoframe */

 wakeup */

	/*

	 * Parameters for generation of Audio Clock Recovery packets

 Set ACR clock divisor */

	/*

	 * Use TMDS clock for ACR packets. For devices that use

	 * the MCLK, this is the first part of the MCLK initialization.

 For devices using MCLK, this completes its initialization. */

 Override of SPDIF sample frequency with value in I2S_CHST4 */

	/*

	 * Set IEC-60958-3 channel status word. It is passed to the IP

	 * just as it is received. The user of the driver is responsible

	 * for its contents.

 yes, this is correct: status[3] goes to CHST4 register */

 yes, this is correct: status[4] goes to CHST5 register */

 set I2S parameters */

 Audio channels and mode parameters */

 Audio channel mappings */

	/* TODO: Make channel mapping dynamic. For now, map channels

	 * in the ALSA order: FL/FR/RL/RR/C/LFE/SL/SR. Remapping is needed as

	 * HDMI speaker order is different. See CEA-861 Section 6.6.2.

	/*

	 * Set audio info frame type, version and length as

	 * described in HDMI 1.4a Section 8.2.2 specification.

	 * Checksum calculation is defined in Section 5.3.5.

	/*

	 * The OMAP HDMI IP requires to use the 8-channel channel code when

	 * transmitting more than two channels.

	/*

	 * TODO: Add MPEG and SPD enable and repeat cfg when EDID parsing

	 * is available.

	/*

	 * In the IEC-60958 status word, check if the audio sample word length

	 * is 16-bit as several optimizations can be performed in such case.

 I2S configuration. See Phillips' specification */

	/*

	 * The I2S input word length is twice the length given in the IEC-60958

	 * status word. If the word size is greater than

	 * 20 bits, increment by one.

 convert sample frequency to a number */

 Audio clock regeneration settings */

 Audio channels settings */

	/*

	 * the HDMI IP needs to enable four stereo channels when transmitting

	 * more than 2 audio channels.  Similarly, the channel count in the

	 * Audio InfoFrame has to match the sample_present bits (some channels

	 * are padded with zeroes)

 use sample frequency from channel status word */

 enable ACR packets */

 disable direct streaming digital audio */

 use parallel audio interface */

 DMA settings */

 in number of samples */

 audio FIFO format settings */

 disable start/stop signals of IEC 60958 blocks */

 configure DMA and audio FIFO format*/

 configure the core*/

 configure CEA 861 audio infoframe*/

 sentinel */ }

/*

 * HDMI CEC

 *

 * Based on the CEC code from hdmi_ti_4xxx_ip.c from Android.

 *

 * Copyright (C) 2010-2011 Texas Instruments Incorporated - https://www.ti.com/

 * Authors: Yong Zhi

 *	Mythri pk <mythripk@ti.com>

 *

 * Heavily modified to use the linux CEC framework:

 *

 * Copyright 2016-2017 Cisco Systems, Inc. and/or its affiliates. All rights reserved.

 *

 * This program is free software; you may redistribute it and/or modify

 * it under the terms of the GNU General Public License as published by

 * the Free Software Foundation; version 2 of the License.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND

 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS

 * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN

 * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN

 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

 * SOFTWARE.

 HDMI CEC */

 Not really a debug register, more a low-level control register */

 While there are CEC frames in the FIFO */

 and the frame doesn't have an error */

 then read the message */

 Clear the current frame from the FIFO */

 Wait until the current frame is cleared */

		/*

		 * Re-read the count register and loop to see if there are

		 * more messages in the FIFO.

	/*

	 * Initialize CEC clock divider: CEC needs 2MHz clock hence

	 * set the divider to 24 to get 48/24=2MHz clock

 Clear TX FIFO */

 Clear RX FIFO */

 Clear CEC interrupts */

 Enable HDMI core interrupts */

 Unmask CEC interrupt */

	/*

	 * Enable CEC interrupts:

	 * Transmit Buffer Full/Empty Change event

	 * Receiver FIFO Not Empty event

	/*

	 * Enable CEC interrupts:

	 * Frame Retransmit Count Exceeded event

 cec calibration enable (self clearing) */

		/*

		 * If we enabled CEC in middle of a CEC message on the bus,

		 * we could have start bit irregularity and/or short

		 * pulse event. Clear them now.

 Clear TX FIFO */

 Clear TX interrupts */

 Set the retry count */

 Set the initiator addresses */

 Set destination id */

 Setup command and arguments for the command */

 Operand count */

 Disable clock initially, hdmi_cec_adap_enable() manages it */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2009 Nokia Corporation

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

	/*

	 * DSS fclk gives us very few possibilities, so finding a good pixel

	 * clock may not be possible. We try multiple times to find the clock,

	 * each time widening the pixel clock range we look for, up to

	 * +/- 1MHz.

/* -----------------------------------------------------------------------------

 * DRM Bridge Operations

	/*

	 * LCLK and PCLK divisors are located in shadow registers, and we

	 * normally write them to DISPC registers when enabling the output.

	 * However, SDI uses pck-free as source clock for its PLL, and pck-free

	 * is affected by the divisors. And as we need the PLL before enabling

	 * the output, we need to write the divisors early.

	 *

	 * It seems just writing to the DISPC register is enough, and we don't

	 * need to care about the shadow register mechanism for pck-free. The

	 * exact reason for this is unknown.

/* -----------------------------------------------------------------------------

 * Initialisation and Cleanup

 We have SDI only on OMAP3, where it's on port 1 */

 15.5.9.1.2 */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * HDMI PHY

 *

 * Copyright (C) 2013 Texas Instruments Incorporated - https://www.ti.com/

	/*

	 * Read address 0 in order to get the SCP reset done completed

	 * Dummy access performed to make sure reset is done

	/*

	 * In OMAP5+, the HFBITCLK must be divided by 2 before issuing the

	 * HDMI_PHYPWRCMD_LDOON command.

	/*

	 * If the hfbitclk != lfbitclk, it means the lfbitclk was configured

	 * to be used for TMDS.

	/*

	 * Write to phy address 0 to configure the clock

	 * use HFBITCLK write HDMI_TXPHY_TX_CONTROL_FREQOUT field

 Write to phy address 1 to start HDMI line (TXVALID and TMDSCLKEN) */

 Setup max LDO voltage */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2009 Nokia Corporation

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

 *

 * Some code and ideas taken from drivers/video/omap/ driver

 * by Imre Deak.

/* -----------------------------------------------------------------------------

 * Clock Handling and PLL

	/*

	 * Possible clock sources:

	 * LCD1: FCK/PLL1_1/HDMI_PLL

	 * LCD2: FCK/PLL1_3/HDMI_PLL (DRA74x: PLL2_3)

	 * LCD3: FCK/PLL1_3/HDMI_PLL (DRA74x: PLL2_1)

	/*

	 * XXX we can't currently use DSI PLL for DPI with OMAP3, as the DSI PLL

	 * would also be used for DISPC fclk. Meaning, when the DPI output is

	 * disabled, DISPC clock will be disabled, and TV out will stop.

 inputs */

 outputs */

	/*

	 * Odd dividers give us uneven duty cycle, causing problem when level

	 * shifted. So skip all odd dividers when the pixel clock is on the

	 * higher side.

 DSS_PLL_TYPE_B */

	/*

	 * DSS fck gives us very few possibilities, so finding a good pixel

	 * clock may not be possible. We try multiple times to find the clock,

	 * each time widening the pixel clock range we look for, up to

	 * +/- ~15MHz.

 do initial setup with the PLL to see if it is operational */

/* -----------------------------------------------------------------------------

 * DRM Bridge Operations

/* -----------------------------------------------------------------------------

 * Initialisation and Cleanup

/*

 * Return a hardcoded channel for the DPI output. This should work for

 * current use cases, but this can be later expanded to either resolve

 * the channel in some more dynamic manner, or get the channel as a user

 * parameter.

/* -----------------------------------------------------------------------------

 * Initialisation and Cleanup

 sentinel */ }

	/*

	 * The DPI uses the DSI VDDS on OMAP34xx, OMAP35xx, OMAP36xx, AM37xx and

	 * DM37xx only.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright © 2019-2020 Intel Corporation

 Default setting is 1080p, 4 lanes */

/*

 * This DSI can only be paired with bridges that do config through i2c

 * which is ADV 7535 in the KMB EVM

 Create and register MIPI DSI host */

 Find ADV7535 node and initialize it */

 Locate drm bridge from the hdmi encoder DT node */

 Case 0 not supported according to MDK */

			/* Case 0 and 1 not supported according

			 * to MDK

 Case 0 not supported according to MDK */

 Calculate the word count for each long packet */

	/* Number of PCLK cycles needed to transfer a line

	 * with each PCLK cycle, 4 Bytes are sent through the PPL module

 Frame section packet header */

 Word count bits [15:0] */

 Data type (bits [21:16]) */

 Virtual channel (bits [23:22]) */

 Data mode (bits [24:25]) */

 Unpacked bytes */

	/* There are 4 frame generators and each fg has 4 sections

	 * There are 2 registers for unpacked bytes (# bytes each

	 * section occupies in memory)

	 * REG_UNPACKED_BYTES0: [15:0]-BYTES0, [31:16]-BYTES1

	 * REG_UNPACKED_BYTES1: [15:0]-BYTES2, [31:16]-BYTES3

 Line config */

	/* Packet width has to be a multiple of the minimum packet width

	 * (in pixels) set for each data type

 Caller needs bits_per_clk for additional caluclations */

	/* 500 Mhz system clock minus 50 to account for the difference in

	 * MIPI clock speed in RTL tests

 700 Mhz clk*/

	/* PPL-Pixel Packing Layer, LLP-Low Level Protocol

	 * Frame genartor timing parameters are clocked on the system clock,

	 * whereas as the equivalent parameters in the LLP blocks are clocked

	 * on LLP Tx clock from the D-PHY - BYTE clock

 Multiply by 1000 to maintain precision */

 Frame generator number of lines */

	/* vsync width

	 * There are 2 registers for vsync width (VSA in lines for

	 * channels 0-3)

	 * REG_VSYNC_WIDTH0: [15:0]-VSA for channel0, [31:16]-VSA for channel1

	 * REG_VSYNC_WIDTH1: [15:0]-VSA for channel2, [31:16]-VSA for channel3

 vertical backporch (vbp) */

 vertical frontporch (vfp) */

 vertical active (vactive) */

 hsync width */

 horizontal backporch (hbp) */

 horizontal frontporch (hfp) */

 horizontal active (ha) */

 convert h_active which is wc in bytes to cycles */

 llp hsync width */

 llp h backporch */

 llp h frontporch */

	/* Calculate the total frame generator number of

	 * lines based on it's active sections

 Apply frame generator timing setting */

 Clear all mc fifo channel sizes and thresholds */

	/* MC fifo size for virtual channels 0-3

	 * REG_MC_FIFO_CHAN_ALLOC0: [8:0]-channel0, [24:16]-channel1

	 * REG_MC_FIFO_CHAN_ALLOC1: [8:0]-2, [24:16]-channel3

 Set threshold to half the fifo size, actual size=size*16 */

 Enable the MC FIFO channel corresponding to the Virtual Channel */

 MIPI_TX_HS_SYNC_CFG */

 Enable frame generator */

 MIPI_TX_HS_CTRL */

 type:DSI, source:LCD */

67 ns stop time */

	/* This is the order to initialize MIPI TX:

	 * 1. set frame section parameters

	 * 2. set frame specific parameters

	 * 3. connect lcd to mipi

	 * 4. multi channel fifo cfg

	 * 5. set mipitxcctrlcfg

 Find valid frame, assume only one valid frame */

 Frame Section configuration */

		/* TODO - assume there is only one valid section in a frame,

		 * so bits_per_pclk and word_count are only set once

 Set frame specific parameters */

		/* Stop iterating as only one virtual channel

		 * shall be used for LCD connection

 Multi-Channel FIFO Configuration */

 Frame Generator Enable */

	/* Steps to send test code:

	 * - set testclk HIGH

	 * - set testdin with test code

	 * - set testen HIGH

	 * - set testclk LOW

	 * - set testen LOW

 Set testclk high */

 Set testdin */

 Set testen high */

 Set testclk low */

 Set testen low */

		/*  Steps to send test data:

		 * - set testen LOW

		 * - set testclk LOW

		 * - set testdin with data

		 * - set testclk HIGH

 Set testen low */

 Set testclk low */

 Set data in testdin */

 Set testclk high */

	/* Typical rise/fall time=166, refer Table 1207 databook,

	 * sr_osc_freq_target[7:0]

 Flag this as high nibble */

	/* Typical rise/fall time=166, refer Table 1207 databook,

	 * sr_osc_freq_target[11:7]

	/* pll_ref_clk: - valid range: 2~64 MHz; Typically 24 MHz

	 * Fvco: - valid range: 320~1250 MHz (Gen3 D-PHY)

	 * Fout: - valid range: 40~1250 MHz (Gen3 D-PHY)

	 * n: - valid range [0 15]

	 * N: - N = n + 1

	 *      -valid range: [1 16]

	 *      -conditions: - (pll_ref_clk / N) >= 2 MHz

	 *             -(pll_ref_clk / N) <= 8 MHz

	 * m: valid range [62 623]

	 * M: - M = m + 2

	 *      -valid range [64 625]

	 *      -Fvco = (M/N) * pll_ref_clk

 Search pll n parameter */

		/* Calculate the pll input frequency division ratio

		 * multiply by 1000 for precision -

		 * no floating point, add n for rounding

 Found a valid n parameter */

 Search pll m parameter */

			/* Calculate the Fvco(DPHY PLL output frequency)

			 * using the current n,m params

 Trim the potential pll freq to max supported */

			/* Select the best (closest to target pll freq)

			 * n,m parameters so far

	/* Program vco_cntrl parameter

	 * PLL_VCO_Control[5:0] = pll_vco_cntrl_ovr,

	 * PLL_VCO_Control[6]   = pll_vco_cntrl_ovr_en

 Program m, n pll parameters */

 PLL_Input_Divider_Ratio[3:0] = pll_n_ovr */

	/* m - low nibble PLL_Loop_Divider_Ratio[4:0]

	 * pll_m_ovr[4:0]

	/* m - high nibble PLL_Loop_Divider_Ratio[4:0]

	 * pll_m_ovr[9:5]

 Enable overwrite of n,m parameters :pll_n_ovr_en, pll_m_ovr_en */

 Program Charge-Pump parameters */

 pll_prop_cntrl-fixed values for prop_cntrl from DPHY doc */

 pll_int_cntrl-fixed value for int_cntrl from DPHY doc */

 pll_gmp_cntrl-fixed value for gmp_cntrl from DPHY doci */

 pll_cpbias_cntrl-fixed value for cpbias_cntrl from DPHY doc */

	/* pll_th1 -Lock Detector Phase error threshold,

	 * document gives fixed value

 PLL Lock Configuration */

 pll_th2 - Lock Filter length, document gives fixed value */

 pll_th3- PLL Unlocking filter, document gives fixed value */

	/* pll_lock_sel-PLL Lock Detector Selection,

	 * document gives fixed value

	/* Bypass slew rate calibration algorithm

	 * bits[1:0} srcal_en_ovr_en, srcal_en_ovr

 Disable slew rate calibration */

	/* BitRate: > 1 Gbps && <= 1.5 Gbps: - slew rate control ON

	 * typical rise/fall times: 166 ps

	/* Do not bypass slew rate calibration algorithm

	 * bits[1:0}=srcal_en_ovr_en, srcal_en_ovr, bit[6]=sr_range

 Enable slew rate calibration */

	/* Set sr_osc_freq_target[6:0] low nibble

	 * typical rise/fall time=166, refer Table 1207 databook

	/* Set sr_osc_freq_target[11:7] high nibble

	 * Typical rise/fall time=166, refer Table 1207 databook

	/* lane_rate_mbps <= 1000 Mbps

	 * BitRate:  <= 1 Gbps:

	 * - slew rate control ON

	 * - typical rise/fall times: 225 ps

 Do not bypass slew rate calibration algorithm */

 Enable slew rate calibration */

 Typical rise/fall time=255, refer Table 1207 databook */

 Set sr_osc_freq_target[11:7] high nibble */

 Set PLL regulator in bypass */

 PLL Parameters Setup */

 Set clksel */

 Set pll_shadow_control */

 Send the test code and data */

 bit[6:0] = hsfreqrange_ovr bit[7] = hsfreqrange_ovr_en */

 Set D-PHY in shutdown mode */

 Assert RSTZ signal */

 Assert SHUTDOWNZ signal */

	/* Init D-PHY_n

	 * Pulse testclear signal to make sure the d-phy configuration

	 * starts from a clean base

 Set mastermacro bit - Master or slave mode */

 DPHY has its own clock lane enabled (master) */

 Send the test code and data */

 Set the lane data rate */

	/* High-Speed Tx Slew Rate Calibration

	 * BitRate: > 1.5 Gbps && <= 2.5 Gbps: slew rate control OFF

 Set cfgclkfreqrange */

 Enable config clk for the corresponding d-phy */

 PLL setup */

 Send NORMAL OPERATION test code */

	/* Configure BASEDIR for data lanes

	 * NOTE: basedir only applies to LANE_0 of each D-PHY.

	 * The other lanes keep their direction based on the D-PHY type,

	 * either Rx or Tx.

	 * bits[5:0]  - BaseDir: 1 = Rx

	 * bits[9:6] - BaseDir: 0 = Tx

	/* Enable CLOCK LANE

	 * Clock lane should be enabled regardless of the direction

	 * set for the D-PHY (Rx/Tx)

 Enable DATA LANES */

 Take D-PHY out of shutdown mode */

 Deassert SHUTDOWNZ signal */

 Deassert RSTZ signal */

 TODO-need to add a time out and return failure */

 TODO-need to add a time out and return failure */

 Multiple D-PHYs needed */

		/*

		 *Initialization for Tx aggregation mode is done according to

		 *a. start init PHY1

		 *b. poll for PHY1 FSM state LOCK

		 *   b1. reg addr 0x03[3:0] - state_main[3:0] == 5 (LOCK)

		 *c. poll for PHY1 calibrations done :

		 *   c1. termination calibration lower section: addr 0x22[5]

		 *   - rescal_done

		 *   c2. slewrate calibration (if data rate < = 1500 Mbps):

		 *     addr 0xA7[3:2] - srcal_done, sr_finished

		 *d. start init PHY0

		 *e. poll for PHY0 stopstate

		 *f. poll for PHY1 stopstate

 PHY #N+1 ('slave') */

 PHY #N master */

 Wait for DPHY init to complete */

 Single DPHY */

 DISABLE MIPI->CIF CONNECTION */

 ENABLE LCD->MIPI CONNECTION */

 DISABLE LCD->CIF LOOPBACK */

	/* Lane rate = (vtotal*htotal*fps*bpp)/4 / 1000000

	 * to convert to Mbps

	/* When late rate < 800, modeset fails with 4 lanes,

	 * so switch to 2 lanes

 Initialize mipi controller */

 Dphy initialization */

 Link drm_bridge to encoder */

 Set MIPI clock to 24 Mhz */

 Set MIPI_ECFG clock to 24 Mhz */

 Set MIPI_CFG clock to 24 Mhz */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright © 2018-2020 Intel Corporation

 Conversion (yuv->rgb) matrix from myriadx */

 Graphics layer (layers 2 & 3) formats, only packed formats  are supported */

 Video layer ( 0 & 1) formats, packed and planar formats are supported */

 packed formats */

planar formats */

	/* Due to HW limitations, changing pixel format after initial

	 * plane configuration is not supported.

	/* Due to HW limitations, changing plane height or width after

	 * initial plane configuration is not supported.

 planar formats */

 packed formats */

 looks hw requires B & G to be swapped when RGB */

 YUV to RGB conversion using the fixed matrix csc_coef_lcd */

 Program Cb/Cr for planar formats */

 check if Cb/Cr is swapped*/

 check if Cb/Cr is swapped*/

 Enable CSC if input is planar and output is RGB */

 Configure LCD_CONTROL */

 Set layer blending config */

	/* LCD is connected to MIPI on kmb

	 * Therefore this bit is required for DSI Tx

	/* Enable pipeline AXI read transactions for the DMA

	 * after setting graphics layers. This must be done

	 * in a separate write cycle.

	/* FIXME no doc on how to set output format, these values are taken

	 * from the Myriadx tests

 Leave RGB order,conversion mode and clip mode to default */

 do not interleave RGB channels for mipi Tx compatibility */

 Enable DMA */

 Save initial display config */

	/* Disable pipeline AXI read transactions for the DMA

	 * prior to setting graphics layers

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright © 2018-2020 Intel Corporation

 Set LCD clock to 200 Mhz */

 Enable MSS_CAM_CLK_CTRL for MIPI TX and LCD */

 Map LCD MMIO registers */

 Map MIPI MMIO registers */

 Enable display clocks */

	/* Register irqs here - section 17.3 in databook

	 * lists LCD at 79 and 82 for MIPI under MSS CPU -

	 * firmware has redirected 79 to A53 IRQ 33

 Allocate LCD interrupt resources */

 Get the optional framebuffer memory resource */

 Set the CRTC's port so that the encoder component can find it */

		/* When disabling/enabling LCD layers, the change takes effect

		 * immediately and does not wait for EOF (end of frame).

		 * When kmb_plane_atomic_disable is called, mark the plane as

		 * disabled but actually disable the plane when EOF irq is

		 * being handled.

					/* If no LCD layers are using DMA,

					 * then disable DMA pipelined AXI read

					 * transactions.

 DMA Recovery after underflow */

 disable dma */

 clear line compare interrupt */

 Read VSTATUS */

 Clear vertical compare interrupt */

 LAYER0 - VL0 */

 disable underflow interrupt */

 disable auto restart mode */

 LAYER1 - VL1 */

 disable underflow interrupt */

 disable auto restart mode */

 LAYER1 - VL1 */

 LAYER2 - GL0 */

 LAYER3 - GL1 */

 Clear layer interrupts */

 Clear all interrupts */

 IRQ handler */

 GEM Operations */

 Release clks */

 Unregister DSI host */

	/* The bridge (ADV 7535) will return -EPROBE_DEFER until it

	 * has a mipi_dsi_host to register its device to. So, we

	 * first register the DSI host during probe time, and then return

	 * -EPROBE_DEFER until the bridge is loaded. Probe will be called again

	 *  and then the rest of the driver initialization can proceed

	 *  afterwards and the bridge can be successfully attached.

 Create DRM device */

 Initialize MIPI DSI */

 Register graphics device with the kernel */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright © 2018-2020 Intel Corporation

 Clear interrupt */

 Set which interval to generate vertical interrupt */

 Enable vertical interrupt */

 Clear interrupt */

 Disable vertical interrupt */

 Initialize mipi */

 This is hardcoded as 0 in the Myriadx code */

 Back ground color */

 This is hardcoded as 10 in the Myriadx code */

 due to hw limitations, planes need to be off when crtc is off */

 SPDX-License-Identifier: GPL-2.0

/*

 * ZynqMP DisplayPort Subsystem Driver

 *

 * Copyright (C) 2017 - 2020 Xilinx, Inc.

 *

 * Authors:

 * - Hyun Woo Kwon <hyun.kwon@xilinx.com>

 * - Laurent Pinchart <laurent.pinchart@ideasonboard.com>

/* -----------------------------------------------------------------------------

 * Dumb Buffer & Framebuffer Allocation

 Enforce the alignment constraints of the DMA engine. */

 Enforce the alignment constraints of the DMA engine. */

/* -----------------------------------------------------------------------------

 * DRM/KMS Driver

 Initialize mode config, vblank and the KMS poll helper. */

	/*

	 * Initialize the DISP and DP components. This will creates planes,

	 * CRTC, encoder and connector. The DISP should be initialized first as

	 * the DP encoder needs the CRTC.

 Reset all components and register the DRM device. */

 Initialize fbdev generic emulation. */

/* -----------------------------------------------------------------------------

 * Power Management

/* -----------------------------------------------------------------------------

 * Probe & Remove

 Allocate private data. */

 Try the reserved memory. Proceed if there's none. */

	/*

	 * DP should be probed first so that the zynqmp_disp can set the output

	 * format accordingly.

 end of table */ },

 SPDX-License-Identifier: GPL-2.0

/*

 * ZynqMP DisplayPort Driver

 *

 * Copyright (C) 2017 - 2020 Xilinx, Inc.

 *

 * Authors:

 * - Hyun Woo Kwon <hyun.kwon@xilinx.com>

 * - Laurent Pinchart <laurent.pinchart@ideasonboard.com>

/*

 * Some sink requires a delay after power on request

 Link configuration registers */

 Core enable registers */

 Core ID registers */

 AUX channel interface registers */

 Main stream attribute registers */

 PHY configuration and status registers */

 Audio registers */

/**

 * struct zynqmp_dp_link_config - Common link config between source and sink

 * @max_rate: maximum link rate

 * @max_lanes: maximum number of lanes

/**

 * struct zynqmp_dp_mode - Configured mode of DisplayPort

 * @bw_code: code for bandwidth(link rate)

 * @lane_cnt: number of lanes

 * @pclock: pixel clock frequency of current mode

 * @fmt: format identifier string

/**

 * struct zynqmp_dp_config - Configuration of DisplayPort from DTS

 * @misc0: misc0 configuration (per DP v1.2 spec)

 * @misc1: misc1 configuration (per DP v1.2 spec)

 * @bpp: bits per pixel

/**

 * struct zynqmp_dp - Xilinx DisplayPort core

 * @encoder: the drm encoder structure

 * @connector: the drm connector structure

 * @dev: device structure

 * @dpsub: Display subsystem

 * @drm: DRM core

 * @iomem: device I/O memory for register access

 * @reset: reset controller

 * @irq: irq

 * @config: IP core configuration from DTS

 * @aux: aux channel

 * @phy: PHY handles for DP lanes

 * @num_lanes: number of enabled phy lanes

 * @hpd_work: hot plug detection worker

 * @status: connection status

 * @enabled: flag to indicate if the device is enabled

 * @dpcd: DP configuration data from currently connected sink device

 * @link_config: common link configuration between IP core and sink device

 * @mode: current mode between IP core and sink device

 * @train_set: set of training data

/* -----------------------------------------------------------------------------

 * PHY Handling

 Wait for the (de)assert to complete. */

/**

 * zynqmp_dp_phy_init - Initialize the phy

 * @dp: DisplayPort IP core structure

 *

 * Initialize the phy.

 *

 * Return: 0 if the phy instances are initialized correctly, or the error code

 * returned from the callee functions.

	/*

	 * Power on lanes in reverse order as only lane 0 waits for the PLL to

	 * lock.

/**

 * zynqmp_dp_phy_exit - Exit the phy

 * @dp: DisplayPort IP core structure

 *

 * Exit the phy.

/**

 * zynqmp_dp_phy_probe - Probe the PHYs

 * @dp: DisplayPort IP core structure

 *

 * Probe PHYs for all lanes. Less PHYs may be available than the number of

 * lanes, which is not considered an error as long as at least one PHY is

 * found. The caller can check dp->num_lanes to check how many PHYs were found.

 *

 * Return:

 * * 0				- Success

 * * -ENXIO			- No PHY found

 * * -EPROBE_DEFER		- Probe deferral requested

 * * Other negative value	- PHY retrieval failure

/**

 * zynqmp_dp_phy_ready - Check if PHY is ready

 * @dp: DisplayPort IP core structure

 *

 * Check if PHY is ready. If PHY is not ready, wait 1ms to check for 100 times.

 * This amount of delay was suggested by IP designer.

 *

 * Return: 0 if PHY is ready, or -ENODEV if PHY is not ready.

 Wait for 100 * 1ms. This should be enough time for PHY to be ready */

/* -----------------------------------------------------------------------------

 * DisplayPort Link Training

/**

 * zynqmp_dp_max_rate - Calculate and return available max pixel clock

 * @link_rate: link rate (Kilo-bytes / sec)

 * @lane_num: number of lanes

 * @bpp: bits per pixel

 *

 * Return: max pixel clock (KHz) supported by current link config.

/**

 * zynqmp_dp_mode_configure - Configure the link values

 * @dp: DisplayPort IP core structure

 * @pclock: pixel clock for requested display mode

 * @current_bw: current link rate

 *

 * Find the link configuration values, rate and lane count for requested pixel

 * clock @pclock. The @pclock is stored in the mode to be used in other

 * functions later. The returned rate is downshifted from the current rate

 * @current_bw.

 *

 * Return: Current link rate code, or -EINVAL.

 Downshift from current bandwidth */

 If not given, start with max supported */

/**

 * zynqmp_dp_adjust_train - Adjust train values

 * @dp: DisplayPort IP core structure

 * @link_status: link status from sink which contains requested training values

/**

 * zynqmp_dp_update_vs_emph - Update the training values

 * @dp: DisplayPort IP core structure

 *

 * Update the training values based on the request from sink. The mapped values

 * are predefined, and values(vs, pe, pc) are from the device manual.

 *

 * Return: 0 if vs and emph are updated successfully, or the error code returned

 * by drm_dp_dpcd_write().

/**

 * zynqmp_dp_link_train_cr - Train clock recovery

 * @dp: DisplayPort IP core structure

 *

 * Return: 0 if clock recovery train is done successfully, or corresponding

 * error code.

	/*

	 * 256 loops should be maximum iterations for 4 lanes and 4 values.

	 * So, This loop should exit before 512 iterations

/**

 * zynqmp_dp_link_train_ce - Train channel equalization

 * @dp: DisplayPort IP core structure

 *

 * Return: 0 if channel equalization train is done successfully, or

 * corresponding error code.

/**

 * zynqmp_dp_link_train - Train the link

 * @dp: DisplayPort IP core structure

 *

 * Return: 0 if all trains are done successfully, or corresponding error code.

/**

 * zynqmp_dp_train_loop - Downshift the link rate during training

 * @dp: DisplayPort IP core structure

 *

 * Train the link by downshifting the link rate if training is not successful.

/* -----------------------------------------------------------------------------

 * DisplayPort AUX

/**

 * zynqmp_dp_aux_cmd_submit - Submit aux command

 * @dp: DisplayPort IP core structure

 * @cmd: aux command

 * @addr: aux address

 * @buf: buffer for command data

 * @bytes: number of bytes for @buf

 * @reply: reply code to be returned

 *

 * Submit an aux command. All aux related commands, native or i2c aux

 * read/write, are submitted through this function. The function is mapped to

 * the transfer function of struct drm_dp_aux. This function involves in

 * multiple register reads/writes, thus synchronization is needed, and it is

 * done by drm_dp_helper using @hw_mutex. The calling thread goes into sleep

 * if there's no immediate reply to the command submission. The reply code is

 * returned at @reply if @reply != NULL.

 *

 * Return: 0 if the command is submitted properly, or corresponding error code:

 * -EBUSY when there is any request already being processed

 * -ETIMEDOUT when receiving reply is timed out

 * -EIO when received bytes are less than requested

 Wait for reply to be delivered upto 2ms */

 Number of loops = timeout in msec / aux delay (400 usec) */

/**

 * zynqmp_dp_aux_init - Initialize and register the DP AUX

 * @dp: DisplayPort IP core structure

 *

 * Program the AUX clock divider and filter and register the DP AUX adapter.

 *

 * Return: 0 on success, error value otherwise

	/*

	 * The AUX_SIGNAL_WIDTH_FILTER is the number of APB clock cycles

	 * corresponding to the AUX pulse. Allowable values are 8, 16, 24, 32,

	 * 40 and 48. The AUX pulse width must be between 0.4µs and 0.6µs,

	 * compute the w / 8 value corresponding to 0.4µs rounded up, and make

	 * sure it stays below 0.6µs and within the allowable values.

/**

 * zynqmp_dp_aux_cleanup - Cleanup the DP AUX

 * @dp: DisplayPort IP core structure

 *

 * Unregister the DP AUX adapter.

/* -----------------------------------------------------------------------------

 * DisplayPort Generic Support

/**

 * zynqmp_dp_update_misc - Write the misc registers

 * @dp: DisplayPort IP core structure

 *

 * The misc register values are stored in the structure, and this

 * function applies the values into the registers.

/**

 * zynqmp_dp_set_format - Set the input format

 * @dp: DisplayPort IP core structure

 * @format: input format

 * @bpc: bits per component

 *

 * Update misc register values based on input @format and @bpc.

 *

 * Return: 0 on success, or -EINVAL.

 Update the current bpp based on the format. */

/**

 * zynqmp_dp_encoder_mode_set_transfer_unit - Set the transfer unit values

 * @dp: DisplayPort IP core structure

 * @mode: requested display mode

 *

 * Set the transfer unit, and calculate all transfer unit size related values.

 * Calculation is based on DP and IP core specification.

 Use the max transfer unit size (default) */

 Configure the initial wait cycle based on transfer unit size */

/**

 * zynqmp_dp_encoder_mode_set_stream - Configure the main stream

 * @dp: DisplayPort IP core structure

 * @mode: requested display mode

 *

 * Configure the main stream based on the requested mode @mode. Calculation is

 * based on IP core specification.

 In synchronous mode, set the diviers */

 Only 2 channel audio is supported now */

 Translate to the native 16 bit datapath based on IP core spec */

/* -----------------------------------------------------------------------------

 * DRM Connector

	/*

	 * This is from heuristic. It takes some delay (ex, 100 ~ 500 msec) to

	 * get the HPD signal with some monitors.

 Check with link rate and lane count */

/* -----------------------------------------------------------------------------

 * DRM Encoder

 Some monitors take time to wake up properly */

 Check again as bpp or format might have been chagned */

	/*

	 * ZynqMP DP requires horizontal backporch to be greater than 12.

	 * This limitation may not be compatible with the sink device.

/* -----------------------------------------------------------------------------

 * Interrupt Handling

/**

 * zynqmp_dp_enable_vblank - Enable vblank

 * @dp: DisplayPort IP core structure

 *

 * Enable vblank interrupt

/**

 * zynqmp_dp_disable_vblank - Disable vblank

 * @dp: DisplayPort IP core structure

 *

 * Disable vblank interrupt

 dbg for diagnostic, but not much that the driver can do */

/* -----------------------------------------------------------------------------

 * Initialization & Cleanup

 Create the DRM encoder and connector. */

 Initialize and register the AUX adapter. */

 Now that initialisation is complete, enable interrupts. */

 Acquire all resources (IOMEM, IRQ and PHYs). */

 Initialize the hardware. */

	/*

	 * Now that the hardware is initialized and won't generate spurious

	 * interrupts, request the IRQ.

 SPDX-License-Identifier: GPL-2.0

/*

 * ZynqMP Display Controller Driver

 *

 * Copyright (C) 2017 - 2020 Xilinx, Inc.

 *

 * Authors:

 * - Hyun Woo Kwon <hyun.kwon@xilinx.com>

 * - Laurent Pinchart <laurent.pinchart@ideasonboard.com>

/*

 * Overview

 * --------

 *

 * The display controller part of ZynqMP DP subsystem, made of the Audio/Video

 * Buffer Manager, the Video Rendering Pipeline (blender) and the Audio Mixer.

 *

 *              +------------------------------------------------------------+

 * +--------+   | +----------------+     +-----------+                       |

 * | DPDMA  | --->|                | --> |   Video   | Video +-------------+ |

 * | 4x vid |   | |                |     | Rendering | -+--> |             | |   +------+

 * | 2x aud |   | |  Audio/Video   | --> | Pipeline  |  |    | DisplayPort |---> | PHY0 |

 * +--------+   | | Buffer Manager |     +-----------+  |    |   Source    | |   +------+

 *              | |    and STC     |     +-----------+  |    | Controller  | |   +------+

 * Live Video --->|                | --> |   Audio   | Audio |             |---> | PHY1 |

 *              | |                |     |   Mixer   | --+-> |             | |   +------+

 * Live Audio --->|                | --> |           |  ||   +-------------+ |

 *              | +----------------+     +-----------+  ||                   |

 *              +---------------------------------------||-------------------+

 *                                                      vv

 *                                                Blended Video and

 *                                                Mixed Audio to PL

 *

 * Only non-live input from the DPDMA and output to the DisplayPort Source

 * Controller are currently supported. Interface with the programmable logic

 * for live streams is not implemented.

 *

 * The display controller code creates planes for the DPDMA video and graphics

 * layers, and a CRTC for the Video Rendering Pipeline.

/**

 * struct zynqmp_disp_format - Display subsystem format information

 * @drm_fmt: DRM format (4CC)

 * @buf_fmt: AV buffer format

 * @bus_fmt: Media bus formats (live formats)

 * @swap: Flag to swap R & B for RGB formats, and U & V for YUV formats

 * @sf: Scaling factors for color components

/**

 * enum zynqmp_disp_layer_id - Layer identifier

 * @ZYNQMP_DISP_LAYER_VID: Video layer

 * @ZYNQMP_DISP_LAYER_GFX: Graphics layer

/**

 * enum zynqmp_disp_layer_mode - Layer mode

 * @ZYNQMP_DISP_LAYER_NONLIVE: non-live (memory) mode

 * @ZYNQMP_DISP_LAYER_LIVE: live (stream) mode

/**

 * struct zynqmp_disp_layer_dma - DMA channel for one data plane of a layer

 * @chan: DMA channel

 * @xt: Interleaved DMA descriptor template

 * @sgl: Data chunk for dma_interleaved_template

/**

 * struct zynqmp_disp_layer_info - Static layer information

 * @formats: Array of supported formats

 * @num_formats: Number of formats in @formats array

 * @num_channels: Number of DMA channels

/**

 * struct zynqmp_disp_layer - Display layer (DRM plane)

 * @plane: DRM plane

 * @id: Layer ID

 * @disp: Back pointer to struct zynqmp_disp

 * @info: Static layer information

 * @dmas: DMA channels

 * @disp_fmt: Current format information

 * @drm_fmt: Current DRM format information

 * @mode: Current operation mode

/**

 * struct zynqmp_disp - Display controller

 * @dev: Device structure

 * @drm: DRM core

 * @dpsub: Display subsystem

 * @crtc: DRM CRTC

 * @blend.base: Register I/O base address for the blender

 * @avbuf.base: Register I/O base address for the audio/video buffer manager

 * @audio.base: Registers I/O base address for the audio mixer

 * @audio.clk: Audio clock

 * @audio.clk_from_ps: True of the audio clock comes from PS, false from PL

 * @layers: Layers (planes)

 * @event: Pending vblank event request

 * @pclk: Pixel clock

 * @pclk_from_ps: True of the video clock comes from PS, false from PL

/* -----------------------------------------------------------------------------

 * Audio/Video Buffer Manager

 List of video layer formats */

 List of graphics layer formats */

/**

 * zynqmp_disp_avbuf_set_format - Set the input format for a layer

 * @disp: Display controller

 * @layer: The layer

 * @fmt: The format information

 *

 * Set the video buffer manager format for @layer to @fmt.

/**

 * zynqmp_disp_avbuf_set_clocks_sources - Set the clocks sources

 * @disp: Display controller

 * @video_from_ps: True if the video clock originates from the PS

 * @audio_from_ps: True if the audio clock originates from the PS

 * @timings_internal: True if video timings are generated internally

 *

 * Set the source for the video and audio clocks, as well as for the video

 * timings. Clocks can originate from the PS or PL, and timings can be

 * generated internally or externally.

/**

 * zynqmp_disp_avbuf_enable_channels - Enable buffer channels

 * @disp: Display controller

 *

 * Enable all (video and audio) buffer channels.

/**

 * zynqmp_disp_avbuf_disable_channels - Disable buffer channels

 * @disp: Display controller

 *

 * Disable all (video and audio) buffer channels.

/**

 * zynqmp_disp_avbuf_enable_audio - Enable audio

 * @disp: Display controller

 *

 * Enable all audio buffers with a non-live (memory) source.

/**

 * zynqmp_disp_avbuf_disable_audio - Disable audio

 * @disp: Display controller

 *

 * Disable all audio buffers.

/**

 * zynqmp_disp_avbuf_enable_video - Enable a video layer

 * @disp: Display controller

 * @layer: The layer

 * @mode: Operating mode of layer

 *

 * Enable the video/graphics buffer for @layer.

/**

 * zynqmp_disp_avbuf_disable_video - Disable a video layer

 * @disp: Display controller

 * @layer: The layer

 *

 * Disable the video/graphics buffer for @layer.

/**

 * zynqmp_disp_avbuf_enable - Enable the video pipe

 * @disp: Display controller

 *

 * De-assert the video pipe reset.

/**

 * zynqmp_disp_avbuf_disable - Disable the video pipe

 * @disp: Display controller

 *

 * Assert the video pipe reset.

/* -----------------------------------------------------------------------------

 * Blender (Video Pipeline)

/*

 * Colorspace conversion matrices.

 *

 * Hardcode RGB <-> YUV conversion to full-range SDTV for now.

/**

 * zynqmp_disp_blend_set_output_format - Set the output format of the blender

 * @disp: Display controller

 * @format: Output format

 *

 * Set the output format of the blender to @format.

/**

 * zynqmp_disp_blend_set_bg_color - Set the background color

 * @disp: Display controller

 * @rcr: Red/Cr color component

 * @gy: Green/Y color component

 * @bcb: Blue/Cb color component

 *

 * Set the background color to (@rcr, @gy, @bcb), corresponding to the R, G and

 * B or Cr, Y and Cb components respectively depending on the selected output

 * format.

/**

 * zynqmp_disp_blend_set_global_alpha - Configure global alpha blending

 * @disp: Display controller

 * @enable: True to enable global alpha blending

 * @alpha: Global alpha value (ignored if @enabled is false)

/**

 * zynqmp_disp_blend_layer_set_csc - Configure colorspace conversion for layer

 * @disp: Display controller

 * @layer: The layer

 * @coeffs: Colorspace conversion matrix

 * @offsets: Colorspace conversion offsets

 *

 * Configure the input colorspace conversion matrix and offsets for the @layer.

 * Columns of the matrix are automatically swapped based on the input format to

 * handle RGB and YCrCb components permutations.

 Swap U and V. */

 Swap R and B. */

/**

 * zynqmp_disp_blend_layer_enable - Enable a layer

 * @disp: Display controller

 * @layer: The layer

/**

 * zynqmp_disp_blend_layer_disable - Disable a layer

 * @disp: Display controller

 * @layer: The layer

/* -----------------------------------------------------------------------------

 * Audio Mixer

/**

 * zynqmp_disp_audio_enable - Enable the audio mixer

 * @disp: Display controller

 *

 * Enable the audio mixer by de-asserting the soft reset. The audio state is set to

 * default values by the reset, set the default mixer volume explicitly.

 Clear the audio soft reset register as it's an non-reset flop. */

/**

 * zynqmp_disp_audio_disable - Disable the audio mixer

 * @disp: Display controller

 *

 * Disable the audio mixer by asserting its soft reset.

 Try the live PL audio clock. */

 If the live PL audio clock is not valid, fall back to PS clock. */

/* -----------------------------------------------------------------------------

 * ZynqMP Display external functions for zynqmp_dp

/**

 * zynqmp_disp_handle_vblank - Handle the vblank event

 * @disp: Display controller

 *

 * This function handles the vblank interrupt, and sends an event to

 * CRTC object. This will be called by the DP vblank interrupt handler.

/**

 * zynqmp_disp_audio_enabled - If the audio is enabled

 * @disp: Display controller

 *

 * Return if the audio is enabled depending on the audio clock.

 *

 * Return: true if audio is enabled, or false.

/**

 * zynqmp_disp_get_audio_clk_rate - Get the current audio clock rate

 * @disp: Display controller

 *

 * Return: the current audio clock rate.

/**

 * zynqmp_disp_get_crtc_mask - Return the CRTC bit mask

 * @disp: Display controller

 *

 * Return: the crtc mask of the zyqnmp_disp CRTC.

/* -----------------------------------------------------------------------------

 * ZynqMP Display Layer & DRM Plane

/**

 * zynqmp_disp_layer_find_format - Find format information for a DRM format

 * @layer: The layer

 * @drm_fmt: DRM format to search

 *

 * Search display subsystem format information corresponding to the given DRM

 * format @drm_fmt for the @layer, and return a pointer to the format

 * descriptor.

 *

 * Return: A pointer to the format descriptor if found, NULL otherwise

/**

 * zynqmp_disp_layer_enable - Enable a layer

 * @layer: The layer

 *

 * Enable the @layer in the audio/video buffer manager and the blender. DMA

 * channels are started separately by zynqmp_disp_layer_update().

/**

 * zynqmp_disp_layer_disable - Disable the layer

 * @layer: The layer

 *

 * Disable the layer by stopping its DMA channels and disabling it in the

 * audio/video buffer manager and the blender.

/**

 * zynqmp_disp_layer_set_format - Set the layer format

 * @layer: The layer

 * @state: The plane state

 *

 * Set the format for @layer based on @state->fb->format. The layer must be

 * disabled.

	/*

	 * Set slave_id for each DMA channel to indicate they're part of a

	 * video group.

/**

 * zynqmp_disp_layer_update - Update the layer framebuffer

 * @layer: The layer

 * @state: The plane state

 *

 * Update the framebuffer for the layer by issuing a new DMA engine transaction

 * for the new framebuffer.

 *

 * Return: 0 on success, or the DMA descriptor failure error otherwise

	/*

	 * If the format has changed (including going from a previously

	 * disabled state to any format), reconfigure the format. Disable the

	 * plane first if needed.

 Enable or re-enable the plane is the format has changed. */

 Graphics layer is primary, and video layer is overlay. */

/**

 * zynqmp_disp_layer_release_dma - Release DMA channels for a layer

 * @disp: Display controller

 * @layer: The layer

 *

 * Release the DMA channels associated with @layer.

 Make sure the channel is terminated before release. */

/**

 * zynqmp_disp_destroy_layers - Destroy all layers

 * @disp: Display controller

/**

 * zynqmp_disp_layer_request_dma - Request DMA channels for a layer

 * @disp: Display controller

 * @layer: The layer

 *

 * Request all DMA engine channels needed by @layer.

 *

 * Return: 0 on success, or the DMA channel request error otherwise

/**

 * zynqmp_disp_create_layers - Create and initialize all layers

 * @disp: Display controller

 *

 * Return: 0 on success, or the DMA channel request error otherwise

/* -----------------------------------------------------------------------------

 * ZynqMP Display & DRM CRTC

/**

 * zynqmp_disp_enable - Enable the display controller

 * @disp: Display controller

 Choose clock source based on the DT clock handle. */

/**

 * zynqmp_disp_disable - Disable the display controller

 * @disp: Display controller

 Delay of 3 vblank intervals for timing gen to be stable */

	/*

	 * Disable the plane if active. The old plane state can be NULL in the

	 * .shutdown() path if the plane is already disabled, skip

	 * zynqmp_disp_plane_atomic_disable() in that case.

 Consume the flip_done event from atomic helper. */

 Start with vertical blanking interrupt reporting disabled. */

/* -----------------------------------------------------------------------------

 * Initialization & Cleanup

 Try the live PL video clock */

 If the live PL video clock is not valid, fall back to PS clock */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Hisilicon Hi6220 SoC ADE(Advanced Display Engine)'s crtc&plane driver

 *

 * Copyright (c) 2016 Linaro Limited.

 * Copyright (c) 2014-2016 HiSilicon Limited.

 *

 * Author:

 *	Xinliang Liu <z.liuxinliang@hisilicon.com>

 *	Xinliang Liu <xinliang.liu@linaro.org>

 *	Xinwei Kong <kong.kongxinwei@hisilicon.com>

 output overlay compositor */

 16bpp RGB: */

 24bpp RGB: */

 32bpp [A]RGB: */

 channel 1,2,3,4 */

 convert from fourcc format to ade format */

 not found */

 enable clk gate */

 clear overlay */

 clear reset and reload regs */

	/*

	 * for video mode, all the ade registers should

	 * become effective at frame end.

	/*

	 * Success should be guaranteed in mode_valid call back,

	 * so failure shouldn't happen here

 the configured value is actual value - 1 */

 the configured value is actual value - 1 */

 the configured value is actual value - 1 */

 set overlay compositor output size */

 ctran6 setting */

 the configured value is actual value - 1 */

 dsi pixel off */

 vblank irq */

 enable output overlay compositor */

 display source setting */

 enable ade */

 enable ldi */

 dsi pixel on */

 TODO: Only primary plane now */

 dump channel regs */

 dump rdma regs */

 dump clip regs */

 dump compositor routing regs */

 dump overlay compositor regs */

 only crtc is enabled regs take effect */

 flush ade registers */

 get reg offset */

	/*

	 * TODO: set rotation

 get reg offset */

	/*

	 * clip width, no need to clip height

 bypass */

	/*

	 * get alp_mode

	/*

	 * get alp sel

 1 */

 0 */

 TODO: This is the zpos, only one plane now */

	/* overlay routing setting

 connect this plane/channel to overlay2 compositor */

 TODO: Only primary plane now */

 disable this plane/channel */

 dis-connect this plane/channel of overlay2 compositor */

/*

 * Typicaly, a channel looks like: DMA-->clip-->scale-->ctrans-->compositor

 1) DMA setting */

 2) clip setting */

 3) TODO: scale setting for overlay planes */

 4) TODO: ctran/csc setting for overlay planes */

 5) compositor routing setting */

 disable read DMA */

 disable clip */

 disable compositor routing */

 vblank irq init */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Hisilicon Kirin SoCs drm master driver

 *

 * Copyright (c) 2016 Linaro Limited.

 * Copyright (c) 2014-2016 HiSilicon Limited.

 *

 * Author:

 *	Xinliang Liu <z.liuxinliang@hisilicon.com>

 *	Xinliang Liu <xinliang.liu@linaro.org>

 *	Xinwei Kong <kong.kongxinwei@hisilicon.com>

	/* set crtc port so that

	 * drm_of_find_possible_crtcs call works

	/*

	 * plane init

	 * TODO: Now only support primary plane, overlay planes

	 * need to do.

 crtc init */

 dev->mode_config initialization */

 display controller init */

 bind and init sub drivers */

 vblank init */

 reset all the states of crtc/plane/encoder/connector */

 init kms poll for handling hpd */

 display controller init */

 end node */ },

 SPDX-License-Identifier: GPL-2.0-only

/*

 * DesignWare MIPI DSI Host Controller v1.02 driver

 *

 * Copyright (c) 2016 Linaro Limited.

 * Copyright (c) 2014-2016 HiSilicon Limited.

 *

 * Author:

 *	Xinliang Liu <z.liuxinliang@hisilicon.com>

 *	Xinliang Liu <xinliang.liu@linaro.org>

 *	Xinwei Kong <kong.kongxinwei@hisilicon.com>

	/*

	 * Find a rate >= req_kHz.

	/*

	 * TODO: only support RGB888 now, to support more

/*

 * dsi phy reg write function

	/*

	 * latch reg first

	/*

	 * then latch value

	/*

	 * Set lane value and phy stop wait time.

	/*

	 * Set phy clk division.

	/*

	 * Set lp and hs switching params.

 phy timer setting */

	/*

	 * Reset to clean up phy tst params.

	/*

	 * Clock lane timing control setting: TLPX, THS-PREPARE,

	 * THS-ZERO, THS-TRAIL, TWAKEUP.

	/*

	 * Data lane timing control setting: TLPX, THS-PREPARE,

	 * THS-ZERO, THS-TRAIL, TTA-GO, TTA-GET, TWAKEUP.

	/*

	 * physical configuration: I, pll I, pll II, pll III,

	 * pll IV, pll V.

	/*

	 * wait for phy's clock ready

	/*

	 * The DSI IP accepts vertical timing using lines as normal,

	 * but horizontal timing is a mixture of pixel-clocks for the

	 * active region and byte-lane clocks for the blanking-related

	 * timings.  hfp is specified as the total hline_time in byte-

	 * lane clocks minus hsa, hbp and active.

 all specified in byte-lane clocks */

	/*

	 * choose video mode type

	/*

	 * count phy params

 reset Core */

 set dsi phy params */

 set dsi mode timing */

 set dsi video mode */

 dsi wake up */

 Calculate the lane byte clk using the adjusted mode clk */

	/*

	 * Make sure the adjusted mode clock and the lane byte clk

	 * have a common denominator base frequency

	/*

	 * The crtc might adjust the mode, so go through the

	 * possible crtcs (technically just one) and call

	 * mode_fixup to figure out the adjusted mode before we

	 * validate it.

		/*

		 * reset adj_mode to the mode value each time,

		 * so we don't adjust the mode twice

 do nothing */

 do nothing */

 associate the bridge to dsi encoder */

 do nothing */

	/*

	 * Get the endpoint node. In our case, dsi has one output port1

	 * to which the external HDMI bridge is connected.

 SPDX-License-Identifier: GPL-2.0-or-later

/* Hisilicon Hibmc SoC drm driver

 *

 * Based on the bochs drm driver.

 *

 * Copyright (c) 2016 Huawei Limited.

 *

 * Author:

 *	Rongrong Zou <zourongrong@huawei.com>

 *	Rongrong Zou <zourongrong@gmail.com>

 *	Jianhua Li <lijianhua@huawei.com>

/*

 * It can operate in one of three modes: 0, 1 or Sleep.

 Get current power mode. */

 On hardware reset, power mode 0 is default. */

 Enable display power gate & LOCALMEM power gate*/

	/*

	 * Reset the memory controller. If the memory controller

	 * is not reset in chip,the system might hang when sw accesses

	 * the memory.The memory should be resetted after

	 * changing the MXCLK.

 PCI devices require shared interrupts. */

 reset all the states of crtc/plane/encoder/connector */

 SPDX-License-Identifier: GPL-2.0-or-later

/* Hisilicon Hibmc SoC drm driver

 *

 * Based on the bochs drm driver.

 *

 * Copyright (c) 2016 Huawei Limited.

 *

 * Author:

 *	Rongrong Zou <zourongrong@huawei.com>

 *	Rongrong Zou <zourongrong@gmail.com>

 *	Jianhua Li <lijianhua@huawei.com>

 SPDX-License-Identifier: GPL-2.0-or-later

/* Hisilicon Hibmc SoC drm driver

 *

 * Based on the bochs drm driver.

 *

 * Copyright (c) 2016 Huawei Limited.

 *

 * Author:

 *	Rongrong Zou <zourongrong@huawei.com>

 *	Rongrong Zou <zourongrong@gmail.com>

 *	Jianhua Li <lijianhua@huawei.com>

 Bug: we didn't pin the BO to VRAM in prepare_fb. */

 SET PIXEL FORMAT */

 Enable display power gate & LOCALMEM power gate*/

 Enable display power gate & LOCALMEM power gate*/

	/*

	 * Note that all PLL's have the same format. Here,

	 * we just use Panel PLL parameter to work out the bit

	 * fields in the register.On returning a 32 bit number, the value can

	 * be applied to any PLL in the calling function.

 if found none, we use default value */

/*

 * This function takes care the extra registers and bit fields required to

 * setup a mode in board.

 * Explanation about Display Control register:

 * FPGA only supports 7 predefined pixel clocks, and clock select is

 * in bit 4:0 of new register 0x802a8.

 bit[31:0] of PLL */

 bit[63:32] of PLL */

	/*

	 * Hisilicon has to set up the top-left and bottom-right

	 * registers as well.

	 * Note that normal chip only use those two register for

	 * auto-centering mode.

	/*

	 * Assume common fields in ctrl have been properly set before

	 * calling this function.

	 * This function only sets the extra fields in ctrl.

 Set bit 25 of display controller: Select CRT or VGA clock */

 clock_phase_polarity is 0 */

 Enable display power gate & LOCALMEM power gate*/

 We can add more initialization as needed. */

 SPDX-License-Identifier: GPL-2.0-or-later

/* Hisilicon Hibmc SoC drm driver

 *

 * Based on the bochs drm driver.

 *

 * Copyright (c) 2016 Huawei Limited.

 *

 * Author:

 *      Tian Tao <tiantao6@hisilicon.com>

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright 2015 Freescale Semiconductor, Inc.

 *

 * Freescale DCU drm device driver

 always disable planes on the CRTC */

 INV_PXCK as default (most display sample data on rising edge) */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright 2015 Freescale Semiconductor, Inc.

 *

 * Freescale DCU drm device driver

 Use bypass mode for parallel RGB/LVDS encoder */

 This is for backward compatibility */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright 2015 Freescale Semiconductor, Inc.

 *

 * Freescale DCU drm device driver

 possible_crtc's will be filled in later by crtc_init */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright 2015 Toradex AG

 *

 * Stefan Agner <stefan@agner.ch>

 *

 * Freescale TCON device driver

 TCON node is not mandatory, some devices do not provide TCON */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright 2015 Freescale Semiconductor, Inc.

 *

 * Freescale DCU drm device driver

 legancy binding, use dcu clock as pixel clock input */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright 2015 Freescale Semiconductor, Inc.

 *

 * Freescale DCU drm device driver

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/**************************************************************************

 *

 * Copyright (c) 2007-2010 VMware, Inc., Palo Alto, CA., USA

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors: Thomas Hellstrom <thellstrom-at-vmware-dot-com>

/*

 * Currently we use a spinlock for the lock, but a mutex *may* be

 * more appropriate to reduce scheduling latency if the range manager

 * ends up with very fragmented allocation patterns.

/**

 * ttm_range_man_init

 *

 * @bdev: ttm device

 * @type: memory manager type

 * @use_tt: if the memory manager uses tt

 * @p_size: size of area to be managed in pages.

 *

 * Initialise a generic range manager for the selected memory type.

 * The range manager is installed for this device in the type slot.

/**

 * ttm_range_man_fini

 *

 * @bdev: ttm device

 * @type: memory manager type

 *

 * Remove the generic range manager from a slot and tear it down.

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 * Copyright 2020 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König

/* Pooling of allocated pages is necessary because changing the caching

 * attributes on x86 of the linear mapping requires a costly cross CPU TLB

 * invalidate for those addresses.

 *

 * Additional to that allocations from the DMA coherent API are pooled as well

 * cause they are rather slow compared to alloc_pages+map.

/**

 * struct ttm_pool_dma - Helper object for coherent DMA mappings

 *

 * @addr: original DMA address returned for the mapping

 * @vaddr: original vaddr return for the mapping and order in the lower bits

 Allocate pages of size 1 << order with the given gfp_flags */

	/* Don't set the __GFP_COMP flag for higher order allocations.

	 * Mapping pages directly into an userspace process and calling

	 * put_page() on a TTM allocated page is illegal.

	/* TODO: This is an illegal abuse of the DMA API, but we need to rework

	 * TTM page fault handling and extend the DMA API to clean this up.

 Reset the caching and pages of size 1 << order */

	/* We don't care that set_pages_wb is inefficient here. This is only

	 * used when we have to shrink and CPU overhead is irrelevant then.

 Apply a new caching to an array of pages */

 Map pages of 1 << order size and fill the DMA address array  */

 Unmap pages of 1 << order size */

 Unmapped while freeing the page */

 Give pages into a specific pool_type */

 Take pages from a specific pool_type, return NULL when nothing available */

 Initialize and add a pool type to the global shrinker list */

 Remove a pool_type from the global shrinker list and free all pages */

 Return the pool_type to use for the given caching and order */

 Free pages using the global shrinker list */

 Return the allocation order based for a page */

/**

 * ttm_pool_alloc - Fill a ttm_tt object

 *

 * @pool: ttm_pool to use

 * @tt: ttm_tt object to fill

 * @ctx: operation context

 *

 * Fill the ttm_tt object with pages and also make sure to DMA map them when

 * necessary.

 *

 * Returns: 0 on successe, negative error code otherwise.

/**

 * ttm_pool_free - Free the backing pages from a ttm_tt object

 *

 * @pool: Pool to give pages back to.

 * @tt: ttm_tt object to unpopulate

 *

 * Give the packing pages back to a pool or free them

/**

 * ttm_pool_init - Initialize a pool

 *

 * @pool: the pool to initialize

 * @dev: device for DMA allocations and mappings

 * @use_dma_alloc: true if coherent DMA alloc should be used

 * @use_dma32: true if GFP_DMA32 should be used

 *

 * Initialize the pool and its pool types.

/**

 * ttm_pool_fini - Cleanup a pool

 *

 * @pool: the pool to clean up

 *

 * Free all pages in the pool and unregister the types from the global

 * shrinker.

	/* We removed the pool types from the LRU, but we need to also make sure

	 * that no shrinker is concurrently freeing pages from the pool.

 As long as pages are available make sure to release at least one */

 Return the number of pages available or SHRINK_EMPTY if we have none */

 Count the number of pages available in a pool_type */

 Only used for debugfs, the overhead doesn't matter */

 Print a nice header for the order */

 Dump information about the different pool types */

 Dump the total amount of allocated pages */

 Dump the information for the global pools */

/**

 * ttm_pool_debugfs - Debugfs dump function for a pool

 *

 * @pool: the pool to dump the information for

 * @m: seq_file to dump to

 *

 * Make a debugfs dump with the per pool and global information.

 Test the shrinker functions and dump the result */

/**

 * ttm_pool_mgr_init - Initialize globals

 *

 * @num_pages: default number of pages

 *

 * Initialize the global locks and lists for the MM shrinker.

/**

 * ttm_pool_mgr_fini - Finalize globals

 *

 * Cleanup the global pools and unregister the MM shrinker.

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/**************************************************************************

 *

 * Copyright (c) 2006-2009 VMware, Inc., Palo Alto, CA., USA

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors: Thomas Hellstrom <thellstrom-at-vmware-dot-com>

 default destructor */

	/*

	 * Create and bind a ttm if required.

		/* Zero init the new TTM structure if the old location should

		 * have used one as well.

/*

 * Call bo::reserved.

 * Will release GPU memory type usage on destruction.

 * This is the place to put in driver specific hooks to release

 * driver private resources.

 * Will release the bo::reserved lock.

		/* This works because the BO is about to be destroyed and nobody

		 * reference it any more. The only tricky case is the trylock on

		 * the resv object while holding the lru_lock.

/**

 * ttm_bo_cleanup_refs

 * If bo idle, remove from lru lists, and unref.

 * If not idle, block if possible.

 *

 * Must be called with lru_lock and reservation held, this function

 * will drop the lru lock and optionally the reservation lock before returning.

 *

 * @bo:                    The buffer object to clean-up

 * @interruptible:         Any sleeps should occur interruptibly.

 * @no_wait_gpu:           Never wait for gpu. Return -EBUSY instead.

 * @unlock_resv:           Unlock the reservation lock as well.

			/*

			 * We raced, and lost, someone else holds the reservation now,

			 * and is probably busy in ttm_bo_cleanup_memtype_use.

			 *

			 * Even if it's not the case, because we finished waiting any

			 * delayed destruction would succeed, so just return success

			 * here.

/*

 * Traverse the delayed list, and call ttm_bo_cleanup_refs on all

 * encountered buffers.

			/* Last resort, if we fail to allocate memory for the

			 * fences block for the BO to become idle

 The BO is not idle, resurrect it for delayed destroy */

		/*

		 * Make pinned bos immediately available to

		 * shrinkers, now that they are queued for

		 * destruction.

		 *

		 * FIXME: QXL is triggering this. Can be removed when the

		 * driver is fixed.

 find space in the bounce domain */

 move to the bounce domain */

		/*

		 * Since we've already synced, this frees backing store

		 * immediately.

 try and move to final place now. */

	/* Don't evict this BO if it's outside of the

	 * requested placement range

/*

 * Check the target bo is allowable to be evicted or swapout, including cases:

 *

 * a. if share same reservation object with ctx->resv, have assumption

 * reservation objects should already be locked, so not lock again and

 * return true directly when either the opreation allow_reserved_eviction

 * or the target bo already is in delayed free list;

 *

 * b. Otherwise, trylock it.

/**

 * ttm_mem_evict_wait_busy - wait for a busy BO to become available

 *

 * @busy_bo: BO which couldn't be locked with trylock

 * @ctx: operation context

 * @ticket: acquire ticket

 *

 * Try to lock a busy buffer object to avoid failing eviction.

	/*

	 * TODO: It would be better to keep the BO locked until allocation is at

	 * least tried one more time, but that would mean a much larger rework

	 * of TTM.

 If the inner loop terminated early, we have our candidate */

/*

 * Add the last move fence to the BO and reserve a new shared slot. We only use

 * a shared slot to avoid unecessary sync and rely on the subsequent bo move to

 * either stall or use an exclusive fence respectively set bo->moving.

/*

 * Repeatedly evict memory from the LRU for @mem_type until we create enough

 * space, or we've evicted everything and there isn't enough space.

/*

 * Creates space for memory region @mem according to its type.

 *

 * This function first searches for free space in compatible memory types in

 * the priority order defined by the driver.  If free space isn't found, then

 * ttm_bo_mem_force_space is attempted in priority order to evict and find

 * space.

	/*

	 * Determine where to move the buffer.

	 *

	 * If driver determines move is going to need

	 * an extra step then it will return -EMULTIHOP

	 * and the buffer will be moved to the temporary

	 * stop and the driver will be called to make

	 * the second hop.

 try and move to final place now. */

	/*

	 * Remove the backing store if no placement is given.

	/*

	 * Check whether we need to move buffer.

	/*

	 * We might need to add a TTM.

	/*

	 * For ttm_bo_type_device buffers, allocate

	 * address space from the device.

	/* passed reservation objects should already be locked,

	 * since otherwise lockdep will be angered in radeon.

/*

 * buffer object vm functions.

	/*

	 * While the bo may already reside in SYSTEM placement, set

	 * SYSTEM as new placement to cover also the move further below.

	 * The driver may use the fact that we're moving from SYSTEM

	 * as an indication that we're about to swap out.

 TODO: Cleanup the locking */

	/*

	 * Move to system cached

	/*

	 * Make sure BO is idle.

	/*

	 * Swap out. Buffer will be swapped in again as soon as

	 * anyone tries to access a ttm page.

	/*

	 * Unreserve without putting on LRU to avoid swapping out an

	 * already swapped buffer.

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/**************************************************************************

 *

 * Copyright (c) 2006-2009 VMware, Inc., Palo Alto, CA., USA

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors: Thomas Hellstrom <thellstrom-at-vmware-dot-com>

/*

 * Allocates a ttm structure for the given BO.

/*

 * Allocates storage for pointers to the pages that back the ttm.

/**

 * ttm_tt_swapout - swap out tt object

 *

 * @bdev: TTM device structure.

 * @ttm: The struct ttm_tt.

 * @gfp_flags: Flags to use for memory allocation.

 *

 * Swapout a TT object to a shmem_file, return number of pages swapped out or

 * negative error code.

 Test the shrinker functions and dump the result */

/*

 * ttm_tt_mgr_init - register with the MM shrinker

 *

 * Register with the MM shrinker for swapping out BOs.

/**

 * ttm_kmap_iter_tt_init - Initialize a struct ttm_kmap_iter_tt

 * @iter_tt: The struct ttm_kmap_iter_tt to initialize.

 * @tt: Struct ttm_tt holding page pointers of the struct ttm_resource.

 *

 * Return: Pointer to the embedded struct ttm_kmap_iter.

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/**************************************************************************

 *

 * Copyright (c) 2007-2009 VMware, Inc., Palo Alto, CA., USA

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors: Thomas Hellstrom <thellstrom-at-vmware-dot-com>

/**

 * ttm_move_memcpy - Helper to perform a memcpy ttm move operation.

 * @clear: Whether to clear rather than copy.

 * @num_pages: Number of pages of the operation.

 * @dst_iter: A struct ttm_kmap_iter representing the destination resource.

 * @src_iter: A struct ttm_kmap_iter representing the source resource.

 *

 * This function is intended to be able to move out async under a

 * dma-fence if desired.

 Single TTM move. NOP */

 Don't move nonexistent data. Clear destination instead. */

/**

 * ttm_buffer_object_transfer

 *

 * @bo: A pointer to a struct ttm_buffer_object.

 * @new_obj: A pointer to a pointer to a newly created ttm_buffer_object,

 * holding the data of @bo with the old placement.

 *

 * This is a utility function that may be called after an accelerated move

 * has been scheduled. A new buffer object is created as a placeholder for

 * the old data while it's being copied. When that buffer object is idle,

 * it can be destroyed, releasing the space of the old placement.

 * Returns:

 * !0: Failure.

	/**

	 * Fix up members that we shouldn't copy directly:

	 * TODO: Explicit member copy would probably be better here.

		/*

		 * We're mapping a single page, and the desired

		 * page protection is consistent with the bo.

		/*

		 * We need to use vmap to get the desired page protection

		 * or to make the buffer object look contiguous.

		/*

		 * We need to use vmap to get the desired page protection

		 * or to make the buffer object look contiguous.

	/**

	 * This should help pipeline ordinary buffer moves.

	 *

	 * Hang old buffer memory on a new buffer object,

	 * and leave it to be released when the GPU

	 * operation has completed.

	/**

	 * If we're not moving to fixed memory, the TTM object

	 * needs to stay alive. Otherwhise hang it on the ghost

	 * bo to be unbound and destroyed.

	/**

	 * BO doesn't have a TTM we need to bind/unbind. Just remember

	 * this eviction and free up the allocation

/**

 * ttm_bo_pipeline_gutting - purge the contents of a bo

 * @bo: The buffer object

 *

 * Purge the contents of a bo, async if the bo is not idle.

 * After a successful call, the bo is left unpopulated in

 * system placement. The function may wait uninterruptible

 * for idle on OOM.

 *

 * Return: 0 if successful, negative error code on failure.

 If already idle, no need for ghost object dance. */

 See comment below about clearing. */

	/*

	 * We need an unpopulated ttm_tt after giving our current one,

	 * if any, to the ghost object. And we can't afford to fail

	 * creating one *after* the operation. If the bo subsequently gets

	 * resurrected, make sure it's cleared (if ttm_bo_type_device)

	 * to avoid leaking sensitive information to user-space.

 Last resort, wait for the BO to be idle when we are OOM */

 SPDX-License-Identifier: GPL-2.0 OR MIT */

	/*

	 * Initialize the system memory buffer type.

	 * Other types need to be driver / IOCTL initialized.

/*

 * Copyright 2020 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König

/**

 * ttm_resource_compat - check if resource is compatible with placement

 *

 * @res: the resource to check

 * @placement: the placement to check against

 *

 * Returns true if the placement is compatible.

/**

 * ttm_resource_manager_init

 *

 * @man: memory manager object to init

 * @p_size: size managed area in pages.

 *

 * Initialise core parts of a manager object.

/*

 * ttm_resource_manager_evict_all

 *

 * @bdev - device to use

 * @man - manager to use

 *

 * Evict all the objects out of a memory manager until it is empty.

 * Part of memory manager cleanup sequence.

	/*

	 * Can't use standard list traversal since we're unlocking.

/**

 * ttm_resource_manager_debug

 *

 * @man: manager type to dump.

 * @p: printer to use for debug.

/**

 * ttm_kmap_iter_iomap_init - Initialize a struct ttm_kmap_iter_iomap

 * @iter_io: The struct ttm_kmap_iter_iomap to initialize.

 * @iomap: The struct io_mapping representing the underlying linear io_memory.

 * @st: sg_table into @iomap, representing the memory of the struct

 * ttm_resource.

 * @start: Offset that needs to be subtracted from @st to make

 * sg_dma_address(st->sgl) - @start == 0 for @iomap start.

 *

 * Return: Pointer to the embedded struct ttm_kmap_iter.

/**

 * DOC: Linear io iterator

 *

 * This code should die in the not too near future. Best would be if we could

 * make io-mapping use memremap for all io memory, and have memremap

 * implement a kmap_local functionality. We could then strip a huge amount of

 * code. These linear io iterators are implemented to mimic old functionality,

 * and they don't use kmap_local semantics at all internally. Rather ioremap or

 * friends, and at least on 32-bit they add global TLB flushes and points

 * of failure.

/**

 * ttm_kmap_iter_linear_io_init - Initialize an iterator for linear io memory

 * @iter_io: The iterator to initialize

 * @bdev: The TTM device

 * @mem: The ttm resource representing the iomap.

 *

 * This function is for internal TTM use only. It sets up a memcpy kmap iterator

 * pointing at a linear chunk of io memory.

 *

 * Return: A pointer to the embedded struct ttm_kmap_iter or error pointer on

 * failure.

 If uncached requested or if mapping cached or wc failed */

/**

 * ttm_kmap_iter_linear_io_fini - Clean up an iterator for linear io memory

 * @iter_io: The iterator to initialize

 * @bdev: The TTM device

 * @mem: The ttm resource representing the iomap.

 *

 * This function is for internal TTM use only. It cleans up a memcpy kmap

 * iterator initialized by ttm_kmap_iter_linear_io_init.

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/**************************************************************************

 *

 * Copyright (c) 2006-2009 VMware, Inc., Palo Alto, CA., USA

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors: Thomas Hellstrom <thellstrom-at-vmware-dot-com>

 * 	    Jerome Glisse

/**

 * DOC: TTM

 *

 * TTM is a memory manager for accelerator devices with dedicated memory.

 *

 * The basic idea is that resources are grouped together in buffer objects of

 * certain size and TTM handles lifetime, movement and CPU mappings of those

 * objects.

 *

 * TODO: Add more design background and information here.

/**

 * ttm_prot_from_caching - Modify the page protection according to the

 * ttm cacing mode

 * @caching: The ttm caching mode

 * @tmp: The original page protection

 *

 * Return: The modified page protection

 Cached mappings need no adjustment */

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/**************************************************************************

 *

 * Copyright (c) 2006-2009 VMware, Inc., Palo Alto, CA., USA

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Reserve buffers for validation.

 *

 * If a buffer in the list is marked for CPU access, we back off and

 * wait for that buffer to become free for GPU access.

 *

 * If a buffer is reserved for another validation, the validator with

 * the highest validation sequence backs off and waits for that buffer

 * to become unreserved. This prevents deadlocks when validating multiple

 * buffers in different orders.

		/* uh oh, we lost out, drop every reservation and try

		 * to only reserve this buffer, then start over if

		 * this succeeds.

		/* move this item to the front of the list,

		 * forces correct iteration of the loop without keeping track

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/**************************************************************************

 *

 * Copyright (c) 2006-2009 VMware, Inc., Palo Alto, CA., USA

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors: Thomas Hellstrom <thellstrom-at-vmware-dot-com>

	/*

	 * Quick non-stalling check for idle.

	/*

	 * If possible, avoid waiting for GPU with mmap_lock

	 * held.  We only do this if the fault allows retry and this

	 * is the first attempt.

	/*

	 * Ordinary wait.

/**

 * ttm_bo_vm_reserve - Reserve a buffer object in a retryable vm callback

 * @bo: The buffer object

 * @vmf: The fault structure handed to the callback

 *

 * vm callbacks like fault() and *_mkwrite() allow for the mm_sem to be dropped

 * during long waits, and after the wait the callback will be restarted. This

 * is to allow other threads using the same virtual memory space concurrent

 * access to map(), unmap() completely unrelated buffer objects. TTM buffer

 * object reservations sometimes wait for GPU and should therefore be

 * considered long waits. This function reserves the buffer object interruptibly

 * taking this into account. Starvation is avoided by the vm system not

 * allowing too many repeated restarts.

 * This function is intended to be used in customized fault() and _mkwrite()

 * handlers.

 *

 * Return:

 *    0 on success and the bo was reserved.

 *    VM_FAULT_RETRY if blocking wait.

 *    VM_FAULT_NOPAGE if blocking wait and retrying was not allowed.

	/*

	 * Work around locking order reversal in fault / nopfn

	 * between mmap_lock and bo_reserve: Perform a trylock operation

	 * for reserve, and if it fails, retry the fault after waiting

	 * for the buffer to become unreserved.

		/*

		 * If the fault allows retry and this is the first

		 * fault attempt, we try to release the mmap_lock

		 * before waiting

	/*

	 * Refuse to fault imported pages. This should be handled

	 * (if at all) by redirecting mmap to the exporter.

/**

 * ttm_bo_vm_fault_reserved - TTM fault helper

 * @vmf: The struct vm_fault given as argument to the fault callback

 * @prot: The page protection to be used for this memory area.

 * @num_prefault: Maximum number of prefault pages. The caller may want to

 * specify this based on madvice settings and the size of the GPU object

 * backed by the memory.

 *

 * This function inserts one or more page table entries pointing to the

 * memory backing the buffer object, and then returns a return code

 * instructing the caller to retry the page access.

 *

 * Return:

 *   VM_FAULT_NOPAGE on success or pending signal

 *   VM_FAULT_SIGBUS on unspecified error

 *   VM_FAULT_OOM on out-of-memory

 *   VM_FAULT_RETRY if retryable wait

	/*

	 * Wait for buffer data in transit, due to a pipelined

	 * move.

 Iomem should not be marked encrypted */

	/*

	 * Speculatively prefault a number of pages. Only error on

	 * first page.

		/*

		 * Note that the value of @prot at this point may differ from

		 * the value of @vma->vm_page_prot in the caching- and

		 * encryption bits. This is because the exact location of the

		 * data may not be known at mmap() time and may also change

		 * at arbitrary times while the data is mmap'ed.

		 * See vmf_insert_mixed_prot() for a discussion.

 Never error on prefaulted PTEs */

 Allocate new dummy page to map all the VA range in this VMA to it*/

 Set the page to be freed using drmm release action */

 Prefault the entire VMA range right away to avoid further faults */

	/* Copy a page at a time, that way no extra virtual address

	 * mapping is needed

 Enforce no COW since would have really strange behavior with it. */

	/*

	 * Drivers may want to override the vm_ops field. Otherwise we

	 * use TTM's default callbacks.

	/*

	 * Note: We're transferring the bo reference to

	 * vma->vm_private_data here.

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/**************************************************************************

 *

 * Copyright (c) 2006-2009 VMware, Inc., Palo Alto, CA., USA

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors: Thomas Hellstrom <thellstrom-at-vmware-dot-com>

 *          Keith Packard.

 SPDX-License-Identifier: GPL-2.0 OR MIT */

/*

 * Copyright (c) 2006-2009 VMware, Inc., Palo Alto, CA., USA

 * Copyright 2020 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König

/*

 * ttm_global_mutex - protecting the global state

	/* Limit the number of pages in the pool to about 50% of the total

	 * system memory.

 But for DMA32 we limit ourself to only use 2GiB maximum. */

/*

 * A buffer object shrink method that tries to swap out the first

 * buffer object on the global::swap_lru list.

 ttm_bo_swapout has dropped the lru_lock */

/**

 * ttm_device_init

 *

 * @bdev: A pointer to a struct ttm_device to initialize.

 * @funcs: Function table for the device.

 * @dev: The core kernel device pointer for DMA mappings and allocations.

 * @mapping: The address space to use for this bo.

 * @vma_manager: A pointer to a vma manager.

 * @use_dma_alloc: If coherent DMA allocation API should be used.

 * @use_dma32: If we should use GFP_DMA32 for device memory allocations.

 *

 * Initializes a struct ttm_device:

 * Returns:

 * !0: Failure.

 Take ref against racing releases once lru_lock is unlocked */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Sanity check arguments */

 FIXME support CPU target ie all target value < GPU_VRAM */

	/*

	 * FIXME: For now refuse non 0 stride, we need to change the migrate

	 * kernel function to handle stride to avoid to create a mess within

	 * each device driver.

	/*

	 * Ok we are ask to do something sane, for now we only support migrate

	 * commands but we will add things like memory policy (what to do on

	 * page fault) and maybe some other commands.

 This is a best effort so we ignore errors */

	/*

	 * FIXME Return the number of page we have migrated, again we need to

	 * update the migrate API to return that information so that we can

	 * report it to user space.

 Unlink channel instance from SVMM. */

 Link channel instance to SVMM. */

 Invalidate SVMM address-range on GPU. */

	/*

	 * Ignore invalidation callbacks for device private pages since

	 * the invalidation is handled as part of the migration process.

 We need to fail if svm is disabled */

 Allocate tracking for SVM-enabled VMM. */

 Check that SVM isn't already enabled for the client. */

	/* Allocate a new GPU VMM that can support SVM (managed by the

	 * client, with replayable faults enabled).

	 *

	 * All future channel/memory allocations will make use of this

	 * VMM instead of the standard one.

 Note, ownership of svmm transfers to mmu_notifier */

 Issue fault replay for GPU to retry accesses that faulted previously. */

/* Cancel a replayable fault that could not be handled.

 *

 * Cancelling the fault will trigger recovery to reset the engine

 * and kill the offending channel (ie. GPU SIGSEGV).

	//XXX: i think we're supposed to spin waiting */

	if (WARN_ON(!(info & 0x80000000)))

		return;



	nvif_mask(memory, offset + 0x1c, 0x80000000, 0x00000000);



	if (!buffer->fault[buffer->fault_nr]) {

		fault = kmalloc(sizeof(*fault), GFP_KERNEL);

		if (WARN_ON(!fault)) {

			nouveau_svm_fault_cancel(svm, inst, hub, gpc, client);

			return;

		}

		buffer->fault[buffer->fault_nr] = fault;

	}



	fault = buffer->fault[buffer->fault_nr++];

	fault->inst   = inst;

	fault->addr   = (u64)addrhi << 32 | addrlo;

	fault->time   = (u64)timehi << 32 | timelo;

	fault->engine = engine;

	fault->gpc    = gpc;

	fault->hub    = hub;

	fault->access = (info & 0x000f0000) >> 16;

	fault->client = client;

	fault->fault  = (info & 0x0000001f);



	SVM_DBG(svm, "fault %016llx %016llx %02x",

		fault->inst, fault->addr, fault->access);

}



struct svm_notifier {

	struct mmu_interval_notifier notifier;

	struct nouveau_svmm *svmm;

};



static bool nouveau_svm_range_invalidate(struct mmu_interval_notifier *mni,

					 const struct mmu_notifier_range *range,

					 unsigned long cur_seq)

{

	struct svm_notifier *sn =

		container_of(mni, struct svm_notifier, notifier);



	if (range->event == MMU_NOTIFY_EXCLUSIVE &&

	    range->owner == sn->svmm->vmm->cli->drm->dev)

		return true;





	 */

	if (mmu_notifier_range_blockable(range))

		mutex_lock(&sn->svmm->mutex);

	else if (!mutex_trylock(&sn->svmm->mutex))

		return false;

	mmu_interval_set_seq(mni, cur_seq);

	mutex_unlock(&sn->svmm->mutex);

	return true;

}



static const struct mmu_interval_notifier_ops nouveau_svm_mni_ops = {

	.invalidate = nouveau_svm_range_invalidate,

};



static void nouveau_hmm_convert_pfn(struct nouveau_drm *drm,

				    struct hmm_range *range,

				    struct nouveau_pfnmap_args *args)

{

	struct page *page;





	 */

	if (!(range->hmm_pfns[0] & HMM_PFN_VALID)) {

		args->p.phys[0] = 0;

		return;

	}



	page = hmm_pfn_to_page(range->hmm_pfns[0]);



	 */

	if (hmm_pfn_to_map_order(range->hmm_pfns[0])) {

		unsigned long addr = args->p.addr;



		args->p.page = hmm_pfn_to_map_order(range->hmm_pfns[0]) +

				PAGE_SHIFT;

		args->p.size = 1UL << args->p.page;

		args->p.addr &= ~(args->p.size - 1);

		page -= (addr - args->p.addr) >> PAGE_SHIFT;

	}

	if (is_device_private_page(page))

		args->p.phys[0] = nouveau_dmem_page_addr(page) |

				NVIF_VMM_PFNMAP_V0_V |

				NVIF_VMM_PFNMAP_V0_VRAM;

	else

		args->p.phys[0] = page_to_phys(page) |

				NVIF_VMM_PFNMAP_V0_V |

				NVIF_VMM_PFNMAP_V0_HOST;

	if (range->hmm_pfns[0] & HMM_PFN_WRITE)

		args->p.phys[0] |= NVIF_VMM_PFNMAP_V0_W;

}



static int nouveau_atomic_range_fault(struct nouveau_svmm *svmm,

			       struct nouveau_drm *drm,

			       struct nouveau_pfnmap_args *args, u32 size,

			       struct svm_notifier *notifier)

{

	unsigned long timeout =

		jiffies + msecs_to_jiffies(HMM_RANGE_DEFAULT_TIMEOUT);

	struct mm_struct *mm = svmm->notifier.mm;

	struct page *page;

	unsigned long start = args->p.addr;

	unsigned long notifier_seq;

	int ret = 0;



	ret = mmu_interval_notifier_insert(&notifier->notifier, mm,

					args->p.addr, args->p.size,

					&nouveau_svm_mni_ops);

	if (ret)

		return ret;



	while (true) {

		if (time_after(jiffies, timeout)) {

			ret = -EBUSY;

			goto out;

		}



		notifier_seq = mmu_interval_read_begin(&notifier->notifier);

		mmap_read_lock(mm);

		ret = make_device_exclusive_range(mm, start, start + PAGE_SIZE,

					    &page, drm->dev);

		mmap_read_unlock(mm);

		if (ret <= 0 || !page) {

			ret = -EINVAL;

			goto out;

		}



		mutex_lock(&svmm->mutex);

		if (!mmu_interval_read_retry(&notifier->notifier,

					     notifier_seq))

			break;

		mutex_unlock(&svmm->mutex);

	}



	/* Map the page on the GPU. */

	args->p.page = 12;

	args->p.size = PAGE_SIZE;

	args->p.addr = start;

	args->p.phys[0] = page_to_phys(page) |

		NVIF_VMM_PFNMAP_V0_V |

		NVIF_VMM_PFNMAP_V0_W |

		NVIF_VMM_PFNMAP_V0_A |

		NVIF_VMM_PFNMAP_V0_HOST;



	ret = nvif_object_ioctl(&svmm->vmm->vmm.object, args, size, NULL);

	mutex_unlock(&svmm->mutex);



	unlock_page(page);

	put_page(page);



out:

	mmu_interval_notifier_remove(&notifier->notifier);

	return ret;

}



static int nouveau_range_fault(struct nouveau_svmm *svmm,

			       struct nouveau_drm *drm,

			       struct nouveau_pfnmap_args *args, u32 size,

			       unsigned long hmm_flags,

			       struct svm_notifier *notifier)

{

	unsigned long timeout =

		jiffies + msecs_to_jiffies(HMM_RANGE_DEFAULT_TIMEOUT);

	/* Have HMM fault pages within the fault window to the GPU. */

	unsigned long hmm_pfns[1];

	struct hmm_range range = {

		.notifier = &notifier->notifier,

		.default_flags = hmm_flags,

		.hmm_pfns = hmm_pfns,

		.dev_private_owner = drm->dev,

	};

	struct mm_struct *mm = svmm->notifier.mm;

	int ret;



	ret = mmu_interval_notifier_insert(&notifier->notifier, mm,

					args->p.addr, args->p.size,

					&nouveau_svm_mni_ops);

	if (ret)

		return ret;



	range.start = notifier->notifier.interval_tree.start;

	range.end = notifier->notifier.interval_tree.last + 1;



	while (true) {

		if (time_after(jiffies, timeout)) {

			ret = -EBUSY;

			goto out;

		}



		range.notifier_seq = mmu_interval_read_begin(range.notifier);

		mmap_read_lock(mm);

		ret = hmm_range_fault(&range);

		mmap_read_unlock(mm);

		if (ret) {

			if (ret == -EBUSY)

				continue;

			goto out;

		}



		mutex_lock(&svmm->mutex);

		if (mmu_interval_read_retry(range.notifier,

					    range.notifier_seq)) {

			mutex_unlock(&svmm->mutex);

			continue;

		}

		break;

	}



	nouveau_hmm_convert_pfn(drm, &range, args);



	ret = nvif_object_ioctl(&svmm->vmm->vmm.object, args, size, NULL);

	mutex_unlock(&svmm->mutex);



out:

	mmu_interval_notifier_remove(&notifier->notifier);



	return ret;

}



static int

nouveau_svm_fault(struct nvif_notify *notify)

{

	struct nouveau_svm_fault_buffer *buffer =

		container_of(notify, typeof(*buffer), notify);

	struct nouveau_svm *svm =

		container_of(buffer, typeof(*svm), buffer[buffer->id]);

	struct nvif_object *device = &svm->drm->client.device.object;

	struct nouveau_svmm *svmm;

	struct {

		struct nouveau_pfnmap_args i;

		u64 phys[1];

	} args;

	unsigned long hmm_flags;

	u64 inst, start, limit;

	int fi, fn;

	int replay = 0, atomic = 0, ret;



 Parse available fault buffer entries into a cache, and update

	 */

	SVM_DBG(svm, "fault handler");

	if (buffer->get == buffer->put) {

		buffer->put = nvif_rd32(device, buffer->putaddr);

		buffer->get = nvif_rd32(device, buffer->getaddr);

		if (buffer->get == buffer->put)

			return NVIF_NOTIFY_KEEP;

	}

	buffer->fault_nr = 0;



	SVM_DBG(svm, "get %08x put %08x", buffer->get, buffer->put);

	while (buffer->get != buffer->put) {

		nouveau_svm_fault_cache(svm, buffer, buffer->get * 0x20);

		if (++buffer->get == buffer->entries)

			buffer->get = 0;

	}

	nvif_wr32(device, buffer->getaddr, buffer->get);

	SVM_DBG(svm, "%d fault(s) pending", buffer->fault_nr);



 Sort parsed faults by instance pointer to prevent unnecessary

	 */

	sort(buffer->fault, buffer->fault_nr, sizeof(*buffer->fault),

	     nouveau_svm_fault_cmp, NULL);



	/* Lookup SVMM structure for each unique instance pointer. */

	mutex_lock(&svm->mutex);

	for (fi = 0, svmm = NULL; fi < buffer->fault_nr; fi++) {

		if (!svmm || buffer->fault[fi]->inst != inst) {

			struct nouveau_ivmm *ivmm =

				nouveau_ivmm_find(svm, buffer->fault[fi]->inst);

			svmm = ivmm ? ivmm->svmm : NULL;

			inst = buffer->fault[fi]->inst;

			SVM_DBG(svm, "inst %016llx -> svm-%p", inst, svmm);

		}

		buffer->fault[fi]->svmm = svmm;

	}

	mutex_unlock(&svm->mutex);



	/* Process list of faults. */

	args.i.i.version = 0;

	args.i.i.type = NVIF_IOCTL_V0_MTHD;

	args.i.m.version = 0;

	args.i.m.method = NVIF_VMM_V0_PFNMAP;

	args.i.p.version = 0;



	for (fi = 0; fn = fi + 1, fi < buffer->fault_nr; fi = fn) {

		struct svm_notifier notifier;

		struct mm_struct *mm;



		/* Cancel any faults from non-SVM channels. */

		if (!(svmm = buffer->fault[fi]->svmm)) {

			nouveau_svm_fault_cancel_fault(svm, buffer->fault[fi]);

			continue;

		}

		SVMM_DBG(svmm, "addr %016llx", buffer->fault[fi]->addr);



 We try and group handling of faults within a small

		 */

		start = buffer->fault[fi]->addr;

		limit = start + PAGE_SIZE;

		if (start < svmm->unmanaged.limit)

			limit = min_t(u64, limit, svmm->unmanaged.start);





		 */

		args.i.p.addr = start;

		args.i.p.page = PAGE_SHIFT;

		args.i.p.size = PAGE_SIZE;



		 */

		switch (buffer->fault[fi]->access) {

		case 0: /* READ. */

			hmm_flags = HMM_PFN_REQ_FAULT;

			break;

		case 2: /* ATOMIC. */

			atomic = true;

			break;

		case 3: /* PREFETCH. */

			hmm_flags = 0;

			break;

		default:

			hmm_flags = HMM_PFN_REQ_FAULT | HMM_PFN_REQ_WRITE;

			break;

		}



		mm = svmm->notifier.mm;

		if (!mmget_not_zero(mm)) {

			nouveau_svm_fault_cancel_fault(svm, buffer->fault[fi]);

			continue;

		}



		notifier.svmm = svmm;

		if (atomic)

			ret = nouveau_atomic_range_fault(svmm, svm->drm,

							 &args.i, sizeof(args),

							 &notifier);

		else

			ret = nouveau_range_fault(svmm, svm->drm, &args.i,

						  sizeof(args), hmm_flags,

						  &notifier);

		mmput(mm);



		limit = args.i.p.addr + args.i.p.size;

		for (fn = fi; ++fn < buffer->fault_nr; ) {

 It's okay to skip over duplicate addresses from the

			 */

			if (buffer->fault[fn]->svmm != svmm ||

			    buffer->fault[fn]->addr >= limit ||

			    (buffer->fault[fi]->access == FAULT_ACCESS_READ &&

			     !(args.phys[0] & NVIF_VMM_PFNMAP_V0_V)) ||

			    (buffer->fault[fi]->access != FAULT_ACCESS_READ &&

			     buffer->fault[fi]->access != FAULT_ACCESS_PREFETCH &&

			     !(args.phys[0] & NVIF_VMM_PFNMAP_V0_W)) ||

			    (buffer->fault[fi]->access != FAULT_ACCESS_READ &&

			     buffer->fault[fi]->access != FAULT_ACCESS_WRITE &&

			     buffer->fault[fi]->access != FAULT_ACCESS_PREFETCH &&

			     !(args.phys[0] & NVIF_VMM_PFNMAP_V0_A)))

				break;

		}



		/* If handling failed completely, cancel all faults. */

		if (ret) {

			while (fi < fn) {

				struct nouveau_svm_fault *fault =

					buffer->fault[fi++];



				nouveau_svm_fault_cancel_fault(svm, fault);

			}

		} else

			replay++;

	}



	/* Issue fault replay to the GPU. */

	if (replay)

		nouveau_svm_fault_replay(svm);

	return NVIF_NOTIFY_KEEP;

}



static struct nouveau_pfnmap_args *

nouveau_pfns_to_args(void *pfns)

{

	return container_of(pfns, struct nouveau_pfnmap_args, p.phys);

}



u64 *

nouveau_pfns_alloc(unsigned long npages)

{

	struct nouveau_pfnmap_args *args;



	args = kzalloc(struct_size(args, p.phys, npages), GFP_KERNEL);

	if (!args)

		return NULL;



	args->i.type = NVIF_IOCTL_V0_MTHD;

	args->m.method = NVIF_VMM_V0_PFNMAP;

	args->p.page = PAGE_SHIFT;



	return args->p.phys;

}



void

nouveau_pfns_free(u64 *pfns)

{

	struct nouveau_pfnmap_args *args = nouveau_pfns_to_args(pfns);



	kfree(args);

}



void

nouveau_pfns_map(struct nouveau_svmm *svmm, struct mm_struct *mm,

		 unsigned long addr, u64 *pfns, unsigned long npages)

{

	struct nouveau_pfnmap_args *args = nouveau_pfns_to_args(pfns);

	int ret;



	args->p.addr = addr;

	args->p.size = npages << PAGE_SHIFT;



	mutex_lock(&svmm->mutex);



	ret = nvif_object_ioctl(&svmm->vmm->vmm.object, args, sizeof(*args) +

				npages * sizeof(args->p.phys[0]), NULL);



	mutex_unlock(&svmm->mutex);

}



static void

nouveau_svm_fault_buffer_fini(struct nouveau_svm *svm, int id)

{

	struct nouveau_svm_fault_buffer *buffer = &svm->buffer[id];

	nvif_notify_put(&buffer->notify);

}



static int

nouveau_svm_fault_buffer_init(struct nouveau_svm *svm, int id)

{

	struct nouveau_svm_fault_buffer *buffer = &svm->buffer[id];

	struct nvif_object *device = &svm->drm->client.device.object;

	buffer->get = nvif_rd32(device, buffer->getaddr);

	buffer->put = nvif_rd32(device, buffer->putaddr);

	SVM_DBG(svm, "get %08x put %08x (init)", buffer->get, buffer->put);

	return nvif_notify_get(&buffer->notify);

}



static void

nouveau_svm_fault_buffer_dtor(struct nouveau_svm *svm, int id)

{

	struct nouveau_svm_fault_buffer *buffer = &svm->buffer[id];

	int i;



	if (buffer->fault) {

		for (i = 0; buffer->fault[i] && i < buffer->entries; i++)

			kfree(buffer->fault[i]);

		kvfree(buffer->fault);

	}



	nouveau_svm_fault_buffer_fini(svm, id);



	nvif_notify_dtor(&buffer->notify);

	nvif_object_dtor(&buffer->object);

}



static int

nouveau_svm_fault_buffer_ctor(struct nouveau_svm *svm, s32 oclass, int id)

{

	struct nouveau_svm_fault_buffer *buffer = &svm->buffer[id];

	struct nouveau_drm *drm = svm->drm;

	struct nvif_object *device = &drm->client.device.object;

	struct nvif_clb069_v0 args = {};

	int ret;



	buffer->id = id;



	ret = nvif_object_ctor(device, "svmFaultBuffer", 0, oclass, &args,

			       sizeof(args), &buffer->object);

	if (ret < 0) {

		SVM_ERR(svm, "Fault buffer allocation failed: %d", ret);

		return ret;

	}



	nvif_object_map(&buffer->object, NULL, 0);

	buffer->entries = args.entries;

	buffer->getaddr = args.get;

	buffer->putaddr = args.put;



	ret = nvif_notify_ctor(&buffer->object, "svmFault", nouveau_svm_fault,

			       true, NVB069_V0_NTFY_FAULT, NULL, 0, 0,

			       &buffer->notify);

	if (ret)

		return ret;



	buffer->fault = kvcalloc(sizeof(*buffer->fault), buffer->entries, GFP_KERNEL);

	if (!buffer->fault)

		return -ENOMEM;



	return nouveau_svm_fault_buffer_init(svm, id);

}



void

nouveau_svm_resume(struct nouveau_drm *drm)

{

	struct nouveau_svm *svm = drm->svm;

	if (svm)

		nouveau_svm_fault_buffer_init(svm, 0);

}



void

nouveau_svm_suspend(struct nouveau_drm *drm)

{

	struct nouveau_svm *svm = drm->svm;

	if (svm)

		nouveau_svm_fault_buffer_fini(svm, 0);

}



void

nouveau_svm_fini(struct nouveau_drm *drm)

{

	struct nouveau_svm *svm = drm->svm;

	if (svm) {

		nouveau_svm_fault_buffer_dtor(svm, 0);

		kfree(drm->svm);

		drm->svm = NULL;

	}

}



void

nouveau_svm_init(struct nouveau_drm *drm)

{

	static const struct nvif_mclass buffers[] = {

		{   VOLTA_FAULT_BUFFER_A, 0 },

		{ MAXWELL_FAULT_BUFFER_A, 0 },

		{}

	};

	struct nouveau_svm *svm;

	int ret;



 Disable on Volta and newer until channel recovery is fixed,

	 */

	if (drm->client.device.info.family > NV_DEVICE_INFO_V0_PASCAL)

		return;



	if (!(drm->svm = svm = kzalloc(sizeof(*drm->svm), GFP_KERNEL)))

		return;



	drm->svm->drm = drm;

	mutex_init(&drm->svm->mutex);

	INIT_LIST_HEAD(&drm->svm->inst);



	ret = nvif_mclass(&drm->client.device.object, buffers);

	if (ret < 0) {

		SVM_DBG(svm, "No supported fault buffer class");

		nouveau_svm_fini(drm);

		return;

	}



	ret = nouveau_svm_fault_buffer_ctor(svm, buffers[ret].oclass, 0);

	if (ret) {

		nouveau_svm_fini(drm);

		return;

	}



	SVM_DBG(svm, "Initialised");

}

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 * Copyright (c) 2007-2008 Tungsten Graphics, Inc., Cedar Park, TX., USA,

 * Copyright (c) 2009 VMware, Inc., Palo Alto, CA., USA,

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sub license,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 VRAM init */

 GART init */

 SPDX-License-Identifier: MIT

	/* this has to be the first field so populate/unpopulated in

	 * nouve_bo.c works properly, otherwise have to move them here

/*

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

	/* Initialize the embedded gem-object. We return a single gem-reference

 pin buffer into GTT */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* All our channels are dead now, which means all the fences they

	 * own are signalled, and all callback functions have been called.

	 *

	 * So, after flushing the workqueue, there should be nothing left.

	/* Allocate channel that has access to a (preferably async) copy

	 * engine, to use for TTM buffer moves.

		/* Prior to Kepler, there's only a single runlist, so all

		 * engines can be accessed from any channel.

		 *

		 * We still want to use a separate channel though.

 Allocate channel that has access to the graphics engine. */

	/* A SW class is used on pre-NV50 HW to assist with handling the

	 * synchronisation of page flips, as well as to implement fences

	 * on TNT/TNT2 HW that lacks any kind of support in host.

	/* NvMemoryToMemoryFormat requires a notifier ctxdma for some reason,

	 * even if notification is never requested, so, allocate a ctxdma on

	 * any GPU where it's possible we'll end up using M2MF for BO moves.

 Initialise global support for channels, and synchronisation. */

	/*XXX: this is crap, but the fence/channel stuff is a little

	 *     backwards in some places.  this will be fixed.

 Volta requires access to a doorbell register for kickoff. */

 Allocate channels we need to support various functions. */

 Initialise accelerated TTM buffer moves. */

	/* workaround an odd issue on nvc1 by disabling the device's

	 * nosnoop capability.  hopefully won't cause issues until a

	 * better fix is found - assuming there is one...

	/*

	 * There may be existing clients from as-yet unclosed files. For now,

	 * clean them up here rather than deferring until the file is closed,

	 * but this likely not correct if we want to support hot-unplugging

	 * properly.

/*

 * On some Intel PCIe bridge controllers doing a

 * D0 -> D3hot -> D3cold -> D0 sequence causes Nvidia GPUs to not reappear.

 * Skipping the intermediate D3hot step seems to make it work again. This is

 * probably caused by not meeting the expectation the involved AML code has

 * when the GPU is put into D3hot state before invoking it.

 *

 * This leads to various manifestations of this issue:

 *  - AML code execution to power on the GPU hits an infinite loop (as the

 *    code waits on device memory to change).

 *  - kernel crashes, as all PCI reads return -1, which most code isn't able

 *    to handle well enough.

 *

 * In all cases dmesg will contain at least one line like this:

 * 'nouveau 0000:01:00.0: Refused to change power state, currently in D3'

 * followed by a lot of nouveau timeouts.

 *

 * In the \_SB.PCI0.PEG0.PG00._OFF code deeper down writes bit 0x80 to the not

 * documented PCI config space register 0x248 of the Intel PCIe bridge

 * controller (0x1901) in order to change the state of the PCIe link between

 * the PCIe port and the GPU. There are alternative code paths using other

 * registers, which seem to work fine (executed pre Windows 8):

 *  - 0xbc bit 0x20 (publicly available documentation claims 'reserved')

 *  - 0xb0 bit 0x10 (link disable)

 * Changing the conditions inside the firmware by poking into the relevant

 * addresses does resolve the issue, but it seemed to be ACPI private memory

 * and not any device accessible memory at all, so there is no portable way of

 * changing the conditions.

 * On a XPS 9560 that means bits [0,3] on \CPEX need to be cleared.

 *

 * The only systems where this behavior can be seen are hybrid graphics laptops

 * with a secondary Nvidia Maxwell, Pascal or Turing GPU. It's unclear whether

 * this issue only occurs in combination with listed Intel PCIe bridge

 * controllers and the mentioned GPUs or other devices as well.

 *

 * documentation on the PCIe bridge controller can be found in the

 * "7th Generation Intel® Processor Families for H Platforms Datasheet Volume 2"

 * Section "12 PCI Express* Controller (x16) Registers"

	/* We need to check that the chipset is supported before booting

	 * fbdev off the hardware, as there's no way to put it back.

 Remove conflicting drivers (vesafb, efifb etc). */

 revert our workaround */

 Monitors may have been connected / disconnected during suspend */

 do magic */

 Monitors may have been connected / disconnected during suspend */

 we don't want the main rpm_idle to call suspend - we want to autosuspend */

 need to bring up power immediately if opening device */

	/*

	 * The device is gone, and as it currently stands all clients are

	 * cleaned up in the removal codepath. In the future this may change

	 * so that we can support hot-unplugging, but for now we immediately

	 * return to avoid a double-free situation.

/*

 * Copyright (C) 2007 Ben Skeggs.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/* Fetch and adjust GPU GET pointer

 *

 * Returns:

 *  value >= 0, the adjusted GET pointer

 *  -EINVAL if GET pointer currently outside main push buffer

 *  -EBUSY if timeout exceeded

	/* reset counter as long as GET is still advancing, this is

	 * to avoid misdetecting a GPU lockup if the GPU happens to

	 * just be processing an operation that takes a long time

 Flush writes. */

		/* loop until we have a usable GET pointer.  the value

		 * we read from the GPU may be outside the main ring if

		 * PFIFO is processing a buffer called from the main ring,

		 * discard these values until something sensible is seen.

		 *

		 * the other case we discard GET is while the GPU is fetching

		 * from the SKIPS area, so the code below doesn't have to deal

		 * with some fun corner cases.

			/* engine is fetching behind us, or is completely

			 * idle (GET == PUT) so we have free space up until

			 * the end of the push buffer

			 *

			 * we can only hit that path once per call due to

			 * looping back to the beginning of the push buffer,

			 * we'll hit the fetching-ahead-of-us path from that

			 * point on.

			 *

			 * the *one* exception to that rule is if we read

			 * GET==PUT, in which case the below conditional will

			 * always succeed and break us out of the wait loop.

			/* not enough space left at the end of the push buffer,

			 * instruct the GPU to jump back to the start right

			 * after processing the currently pending commands.

			/* wait for GET to depart from the skips area.

			 * prevents writing GET==PUT and causing a race

			 * condition that causes us to think the GPU is

			 * idle when it's not.

			/* we're now submitting commands at the start of

			 * the push buffer.

		/* engine fetching ahead of us, we have space up until the

		 * current GET pointer.  the "- 1" is to ensure there's

		 * space left to emit a jump back to the beginning of the

		 * push buffer if we require it.  we can never get GET == PUT

		 * here, so this is safe.

/*

 * Copyright 2007 Dave Airlied

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Authors: Dave Airlied <airlied@linux.ie>

 *	    Ben Skeggs   <darktama@iinet.net.au>

 *	    Jeremy Kolb  <jkolb@brandeis.edu>

 SPDX-License-Identifier: MIT

 result of the optimus caps function */

 hda bios control */

 ACPI is little endian, AABBCCDD becomes {DD,CC,BB,AA} */

/*

 * On some platforms, _DSM(nouveau_op_dsm_muid, func0) has special

 * requirements on the fourth parameter, so a private implementation

 * instead of using acpi_check_dsm().

	/*

	 * Function 0 returns a Buffer containing available functions.

	 * The args parameter is ignored for function 0, so just put 0 in it

	/*

	 * ACPI Spec v4 9.14.1: if bit 0 is zero, no function is supported.

	 * If the n-th bit is enabled, function n is supported

	/* Optimus laptops have the card already disabled in

 easy option one - intel vendor ID means Integrated */

 is this device on Bus 0? - this may need improving */

 Does not look like a Nvidia device. */

 lookup the MXM GUID */

 now do DSM detection */

 find the optimus DSM or the old v1 DSM */

 Must be called for Optimus models before the card can be turned off */

/*

 * Copyright 2007 Dave Airlied

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Authors: Dave Airlied <airlied@linux.ie>

 *	    Ben Skeggs   <darktama@iinet.net.au>

 *	    Jeremy Kolb  <jkolb@brandeis.edu>

/*

 * NV10-NV40 tiling helpers

 Kill an unused tile region. */

	/*

	 * If nouveau_bo_new() allocated this buffer, the GEM object was never

	 * initialized, so don't attempt to release it.

	/* This is confusing, and doesn't actually mean we want an uncached

	 * mapping, but is what NOUVEAU_GEM_DOMAIN_COHERENT gets translated

	 * into in nouveau_gem_new().

		/* Determine if we can get a cache-coherent map, forcing

		 * uncached mapping if we can't.

 Determine the desirable target GPU page size for the buffer. */

		/* Because we cannot currently allow VMM maps to fail

		 * during buffer migration, we need to determine page

		 * size for the buffer up-front, and pre-allocate its

		 * page tables.

		 *

		 * Skip page sizes that can't support needed domains.

		/* Select this page size if it's the first that supports

		 * the potential memory domains, or when it's compatible

		 * with the requested compression settings.

 Stop once the buffer is larger than the current page size. */

 Disable compression if suitable settings couldn't be found. */

 ttm will call nouveau_bo_del_ttm if it fails.. */

		/*

		 * Make sure that the color and depth buffers are handled

		 * by independent memory controller units. Up to a 9x

		 * speed up when alpha-blending and depth-test are enabled

		 * at the same time.

 Don't waste time looping if the object is coherent */

 Don't waste time looping if the object is coherent */

	/* create temporary vmas for the transfer and attach them to the

	 * old nvkm_mem node, these will get cleaned up after ttm has

	 * destroyed the ttm_resource

 ttm can now (stupidly) pass the driver bos it didn't create... */

 Fake bo copy. */

 Hardware assisted copy. */

 Fallback to software copy. */

 System memory */

 untiled */

 tiled memory */

 Some BARs do not support being ioremapped WC */

	/* as long as the bo isn't in vram, and isn't tiled, we've got

	 * nothing to do here.

 make sure bo is in mappable vram */

/*

 * Copyright 2007 Dave Airlied

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Authors: Dave Airlied <airlied@linux.ie>

 *	    Ben Skeggs   <darktama@iinet.net.au>

 *	    Jeremy Kolb  <jkolb@brandeis.edu>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Use VRAM if there is any ; otherwise fallback to system memory */

		 /*

		  * fences created in sysmem must be non-cached or we

		  * will lose CPU/GPU coherency!

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * FIXME: this is ugly right now we are using TTM to allocate vram and we pin

 * it in vram while in use. We likely want to overhaul memory management for

 * nouveau to be more page like (not necessarily with system page size but a

 * bigger page size) at lowest level and have some shim layer on top that would

 * provide the same functionality as TTM.

	/*

	 * FIXME when chunk->callocated reach 0 we should add the chunk to

	 * a reclaim list so that it can be freed in case of memory pressure.

		/*

		 * FIXME wait for channel to be IDLE before calling finalizing

		 * the hmem object.

	/*

	 * FIXME what we really want is to find some heuristic to migrate more

	 * than just one page on CPU fault. When such fault happens it is very

	 * likely that more surrounding page will CPU fault too.

 Allocate unused physical address space for device private pages. */

 FIXME handle pin failure */

 This only make sense on PASCAL or newer */

 Initialize migration dma helpers before registering memory */

/*

 * Copyright (C) 2008 Maarten Maathuis.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Use preferred mode if there is one.. */

		/* Otherwise, take the resolution with the largest width, then

		 * height, then vertical refresh

			/* We allow 'None' for EDID modes, even on a fixed

			 * panel (some exist with support for lower refresh

			 * rates, which people might want to use for power-

			 * saving purposes).

			 *

			 * Non-EDID modes will force the use of GPU scaling

			 * to the native mode regardless of this setting.

				/* ... except prior to G80, where the code

				 * doesn't support such things.

 See note in nouveau_conn_atomic_set_property(). */

 Init DVI-I specific properties. */

 Add overscan compensation options to digital outputs. */

 Add hue and saturation options. */

 Scaling mode property. */

 Can only scale on DFPs. */

 Dithering properties. */

 HW is broken */

	/* Outputs are only polled while runtime active, so resuming the

	 * device here is unnecessary (and would deadlock upon runtime suspend

	 * because it waits for polling to finish). We do however, want to

	 * prevent the autosuspend timer from elapsing during this operation

	 * if possible.

		/* Override encoder type for DVI-I based on whether EDID

		 * says the display is digital or analog, both use the

		 * same i2c channel so the value returned from ddc_detect

		 * isn't necessarily correct.

 Try retrieving EDID via DDC */

	/* On some laptops (Sony, i'm looking at you) there appears to

	 * be no direct way of accessing the panel's EDID.  The only

	 * option available to us appears to be to ask ACPI for help..

	 *

	 * It's important this check's before trying straps, one of the

	 * said manufacturer's laptops are configured in such a way

	 * the nouveau decides an entry in the VBIOS FP mode table is

	 * valid - it's not (rh#613284)

	/* If no EDID found above, and the VBIOS indicates a hardcoded

	 * modeline is avalilable for the panel, set it as the panel's

	 * native mode and exit.

	/* Still nothing, some VBIOS images have a hardcoded EDID block

	 * stored for the panel stored in them.

 if the edid is feeling nice enough to provide this info, use it */

 EDID 1.4 is *supposed* to be supported on eDP, but, Apple... */

 we're out of options unless we're LVDS, default to 8bpc */

 LVDS: panel straps */

	/* LVDS: DDC panel, need to first determine the number of links to

	 * know which if_is_24bit flag to check...

	/* destroy the native mode, the attached monitor could have changed.

	/* Determine display colour depth for everything except LVDS now,

	 * DP requires this before mode_valid() is called.

	/* Find the native mode if this is a digital panel, if we didn't

	 * find any modes through DDC previously add the native mode to

	 * the list of modes.

	/* Determine LVDS colour depth, must happen after determining

	 * "native" mode as some VBIOS tables require us to use the

	 * pixel clock as part of the lookup...

		/* Note: these limits are conservative, some Fermi's

		 * can do 297 MHz. Unclear how this can be determined.

 attempt to parse vbios connector type and hotplug gpio */

 Gigabyte NX85T */

 Gigabyte GV-NX86T512H */

	/* no vbios data, or an unknown dcb connector type - attempt to

	 * figure out something suitable ourselves

 HDMI 3D support */

 defaults, will get overridden in detect() */

 Default scaling mode */

 see note in nouveau_connector_set_property() */

 dithering properties */

/*

 * Copyright (c) 2014, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 power provided by generic PM domains */

/*

 * Copyright 2010 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 depth 24 */

 depth 32, just use 24.. */

 depth 30 */

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 block access to objects not created via this interface */

 except client */

	/* USIF slightly abuses some return-only ioctl members in order

	 * to provide interoperability with the older ABI16 objects

/*

 * Copyright 2009 Ben Skeggs

 * Copyright 2008 Stuart Bennett

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 depth 24 */

 depth 32 */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

			/* allocate device object targeting client's default

			 * device (ie. the one that belongs to the fd it

			 * opened)

	/* wait for all activity to stop before releasing notify object, which

 cleanup notifier state */

 destroy channel object, all children will be killed too */

 cleanup channels */

 destroy the device object */

 deprecated */

 hack to allow channel engine type specification on kepler */

 allocate "abi16 channel" data and make up a handle for it */

 create channel object and initialise dma and fence management */

 Named memory object area */

 nvsw: compatibility with older 0x*6e class identifier */

 msvld: compatibility with incorrect version exposure */

 mspdec */

 mspdec: compatibility with incorrect version exposure */

 msppp */

 msppp: compatibility with incorrect version exposure */

 completely unnecessary for these chipsets... */

 synchronize with the user channel and destroy the gpu object */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright (C) 2009 Red Hat <mjg@redhat.com>

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors:

 *  Matthew Garrett <mjg@redhat.com>

 *

 * Register locations derived from NVClock by Roderick Colenbrander

 12 for name + 2 for digits + 1 for '\0'

/*

 * eDP brightness callbacks need to happen under lock, since we need to

 * enable/disable the backlight ourselves for modesets

/* FIXME: perform backlight probing for eDP _before_ this, this only gets called after connector

 * registration which happens after the initial modeset

XXX: not confirmed

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * NVIF client driver - NVKM directly linked

/*

 * Copyright (C) 2009 Red Hat <bskeggs@redhat.com>

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors:

 *  Ben Skeggs <bskeggs@redhat.com>

	/* Set the size of the vbios since we know it, and it's confusing to

	 * userspace if it wants to seek() but the file has a length of 0

/*

 * Copyright (C) 2007 Ben Skeggs.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

	/*

	 * Ensure that all accesses to fence->channel complete before freeing

	 * the channel.

/*

 * In an ideal world, read would not assume the channel context is still alive.

 * This function may be called from another device, running into free memory as a

 * result. The drm node should still be there, so we can derive the index from

 * the fence context.

	/*

	 * caller should have a reference on the fence,

	 * else fence could get freed here

	/*

	 * This needs uevents to work correctly, but dma_fence_add_callback relies on

	 * being able to enable signaling. It will still get signaled eventually,

	 * just not right away.

/*

 * Copyright 2009 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

		/*

		 * Dongle connected, but no display. Don't bother reading

		 * downstream port info

 Clear any cached info */

	/* If we've already read the DPCD on an eDP device, we don't need to

	 * reread it as it won't change

		/* If we're not ready to handle MST state changes yet, just

		 * report the last status of the connector. We'll reprobe it

		 * once we've resumed.

 If we're in MST mode, we're done here */

/* TODO:

 * - Use the minimum possible BPC here, once we add support for the max bpc

 *   property.

 * - Validate against the DP caps advertised by the GPU (we don't check these

 *   yet)

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2007 Dave Airlied

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Authors: Dave Airlied <airlied@linux.ie>

 *	    Ben Skeggs   <darktama@iinet.net.au>

 *	    Jeremy Kolb  <jkolb@brandeis.edu>

/*

 * Copyright (C) 2016 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Authors:

 *  Martin Peres <martin.peres@free.fr>

 PDISPLAY.SOR[1].PWM is connected to the crystal */

 this is what nvidia uses and it should be good-enough */

	/* for now, this is safe to directly poke those registers because:

	 *  - A: nvidia never puts the logo led to any other PWM controler

	 *       than PDISPLAY.SOR[1].PWM.

	 *  - B: nouveau does not touch these registers anywhere else

 check that there is a GPIO controlling the logo LED */

/**

 * \file mga_ioc32.c

 *

 * 32-bit ioctl compatibility routines for the MGA DRM.

 *

 * \author Dave Airlie <airlied@linux.ie> with code from patches by Egbert Eich

 *

 *

 * Copyright (C) Paul Mackerras 2005

 * Copyright (C) Egbert Eich 2003,2004

 * Copyright (C) Dave Airlie 2005

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHOR BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,

 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,

 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS

 * IN THE SOFTWARE.

/**

 * Called whenever a 32-bit process running under a 64-bit kernel

 * performs an ioctl on /dev/dri/card<n>.

 *

 * \param filp file pointer.

 * \param cmd command.

 * \param arg user argument.

 * \return zero on success or negative number on failure.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 allocate memory for dma push buffer */

	/* create dma object covering the *entire* memory space that the

	 * pushbuf lives in, this is because the GEM code requires that

	 * we be able to call out to other (indirect) push buffers

			/* nv04 vram pushbuf hack, retarget to its location in

			 * the framebuffer bar rather than direct vram access..

			 * nfi why this exists, it came from the -nv ddx.

 allocate dma push buffer */

 create channel object */

 allocate dma push buffer */

 create channel object */

 allocate dma objects to cover all allowed vram, and gart */

 initialise dma tracking parameters */

 allocate software object class (used for fences on <= nv05) */

 initialise synchronisation */

 hack until fencenv50 is fixed, and agp access relaxed */

/*

 * Copyright 2005-2006 Erik Waling

 * Copyright 2006 Stephane Marchesin

 * Copyright 2007-2009 Stuart Bennett

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,

 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF

 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

 * SOFTWARE.

 these defines are made up */

 also FEATURE_QUADRO for BMP */

	/*

	 * There's a few checksums in the BIOS, so here's a generic checking

	 * function.

 pre BIT */

 off-on delay in ms */

 Powerbook specific quirks */

	/*

	 * The BIT LVDS table's header has the information to setup the

	 * necessary registers. Following the standard 4 byte header are:

	 * A bitmask byte and a dual-link transition pxclk value for use in

	 * selecting the init script when not using straps; 4 script pointers

	 * for panel power, selected by output and on/off; and 8 table pointers

	 * for panel init, the needed one determined by output, and bits in the

	 * conf byte. These tables are similar to the TMDS tables, consisting

	 * of a list of pxclks and script pointers.

	/*

	 * For now we assume version 3.0 table - g80 support will need some

	 * changes

 using EDID */

	/*

	 * LVDS operations are multiplexed in an effort to present a single API

	 * which works with two vastly differing underlying structures.

	 * This acts as the demux

 don't let script change pll->head binding */

 some scripts set a value in NV_PBUS_POWERCTRL_2 and break video overlay */

	/*

	 * BMP version (0xa) LVDS table has a simple header of version and

	 * record length. The BIT LVDS table has the typical BIT table header:

	 * version byte, header length byte, record length byte, and a byte for

	 * the maximum number of records that can be held in the table.

 pre NV40 */

 NV4x */

 G80/G90 */

	/*

	 * The fp strap is normally dictated by the "User Strap" in

	 * PEXTDEV_BOOT_0[20:16], but on BMP cards when bit 2 of the

	 * Internal_Flags struct at 0x48 is set, the user strap gets overriden

	 * by the PCI subsystem ID during POST, but not before the previous user

	 * strap has been committed to CR58 for CR57=0xf on head A, which may be

	 * read and used instead

 Most laptop cards lack an fp table. They use DDC. */

	/*

	 * BMP version 0x5.0x11 BIOSen have version 1 like tables, but no

	 * version field, and miss one of the spread spectrum/PWM bytes.

	 * This could affect early GF2Go parts (not seen any appropriate ROMs

	 * though). Here we assume that a version of 0x05 matches this case

	 * (combining with a BMP version check would be better), as the

	 * common case for the panel type field is 0x0005, and that is in

	 * fact what we are reading the first byte of.

 some NV10, 11, 15, 16 */

 some NV15/16, and NV11+ */

 NV40+ */

		/*

		 * fptable[4] is the minimum

		 * RAMDAC_FP_HCRTC -> RAMDAC_FP_HSYNC_START gap

 !mobile only needs digital_min_front_porch */

 nv4x cards need both a strap value and fpindex of 0xf to use DDC */

	/*

	 * If either the strap or xlated fpindex value are 0xf there is no

	 * panel using a strap-derived bios mode present.  this condition

	 * includes, but is different from, the DDC panel indicator above

 just checking whether we can produce a mode */

	/*

	 * For version 1.0 (version in byte 0):

	 * bytes 1-2 are "panel type", including bits on whether Colour/mono,

	 * single/dual link, and type (TFT etc.)

	 * bytes 3-6 are bits per colour in RGBX

 bytes 9-10 is HActive */

	/*

	 * bytes 13-14 is HValid Start

	 * bytes 15-16 is HValid End

 bytes 23-24, 27-30 similarly, but vertical */

	/*

	 * bytes 38-39 relate to spread spectrum settings

	 * bytes 40-43 are something to do with PWM

	/*

	 * The LVDS table header is (mostly) described in

	 * parse_lvds_manufacturer_table_header(): the BIT header additionally

	 * contains the dual-link transition pxclk (in 10s kHz), at byte 5 - if

	 * straps are not being used for the panel, this specifies the frequency

	 * at which modes should be set up in the dual link style.

	 *

	 * Following the header, the BMP (ver 0xa) table has several records,

	 * indexed by a separate xlat table, indexed in turn by the fp strap in

	 * EXTDEV_BOOT. Each record had a config byte, followed by 6 script

	 * numbers for use by INIT_SUB which controlled panel init and power,

	 * and finally a dword of ms to sleep between power off and on

	 * operations.

	 *

	 * In the BIT versions, the table following the header serves as an

	 * integrated config and xlat table: the records in the table are

	 * indexed by the FP strap nibble in EXTDEV_BOOT, and each record has

	 * two bytes - the first as a config byte, the second for indexing the

	 * fp mode table pointed to by the BIT 'D' table

	 *

	 * DDC is not used until after card init, so selecting the correct table

	 * entry and setting the dual link flag for EDID equipped panels,

	 * requiring tests against the native-mode pixel clock, cannot be done

	 * until later, when this function should be called with non-zero pxclk

 pre NV40 */

 we're done if this isn't the EDID panel case */

			/* nv17 behaviour

			 *

			 * It seems the old style lvds script pointer is reused

			 * to select 18/24 bit colour depth for EDID panels.

			/* nv28 behaviour (off-chip encoder)

			 *

			 * nv28 does a complex dance of first using byte 121 of

			 * the EDID to choose the lvdsmanufacturerindex, then

			 * later attempting to match the EDID manufacturer and

			 * product IDs in a table (signature 'pidt' (panel id

			 * table?)), setting an lvdsmanufacturerindex of 0 and

			 * an fp strap of the match index (or 0xf if none)

 nv31, nv34 behaviour */

		/*

		 * nvidia set the high nibble of (cr57=f, cr58) to

		 * lvdsmanufacturerindex in this case; we don't

 NV4x */

 G80/G90 */

		/*

		 * No sign of the "power off for reset" or "reset for panel

		 * on" bits, but it's safer to assume we should

		/*

		 * It's ok lvdsofs is wrong for nv4x edid case; dual_link is

		 * over-written, and if_is_24bit isn't used

 set dual_link flag for EDID case */

	/*

	 * the pxclk parameter is in kHz

	 *

	 * This runs the TMDS regs setting code found on BIT bios cards

	 *

	 * For ffs(or) == 1 use the first table, for ffs(or) == 2 and

	 * ffs(or) == 3, use the second.

 pre-nv17 off-chip tmds uses scripts, post nv17 doesn't */

 don't let script change pll->head binding */

	/*

	 * Parses the init table segment for pointers used in script execution.

	 *

	 * offset + 0  (16 bits): init script tables pointer

	 * offset + 2  (16 bits): macro index table pointer

	 * offset + 4  (16 bits): macro table pointer

	 * offset + 6  (16 bits): condition table pointer

	 * offset + 8  (16 bits): io condition table pointer

	 * offset + 10 (16 bits): io flag condition table pointer

	 * offset + 12 (16 bits): init function table pointer

	/*

	 * Parses the load detect values for g80 cards.

	 *

	 * offset + 0 (16 bits): loadval table pointer

 First entry is normal dac, 2nd tv-out perhaps? */

	/*

	 * Parses the flat panel table segment that the bit entry points to.

	 * Starting at bitentry->offset:

	 *

	 * offset + 0  (16 bits): ??? table pointer - seems to have 18 byte

	 * records beginning with a freq.

	 * offset + 2  (16 bits): mode table pointer

	/*

	 * Parses the init table segment that the bit entry points to.

	 *

	 * See parse_script_table_pointers for layout

	/*

	 * BIT 'i' (info?) table

	 *

	 * offset + 0  (32 bits): BIOS version dword (as in B table)

	 * offset + 5  (8  bits): BIOS feature byte (same as for BMP?)

	 * offset + 13 (16 bits): pointer to table containing DAC load

	 * detection comparison values

	 *

	 * There's other things in the table, purpose unknown

	/*

	 * bit 4 seems to indicate a mobile bios (doesn't suffer from BMP's

	 * Quadro identity crisis), other bits possibly as for BMP feature byte

 doesn't exist on g80 */

	/*

	 * The first value in the table, following the header, is the

	 * comparison value, the second entry is a comparison value for

	 * TV load detection.

	/*

	 * Parses the LVDS table segment that the bit entry points to.

	 * Starting at bitentry->offset:

	 *

	 * offset + 0  (16 bits): LVDS strap xlate table pointer

	/*

	 * No idea if it's still called the LVDS manufacturer table, but

	 * the concept's close enough.

	/*

	 * offset + 2  (8  bits): number of options in an

	 * 	INIT_RAM_RESTRICT_ZM_REG_GROUP opcode option set

	 * offset + 3  (16 bits): pointer to strap xlate table for RAM

	 * 	restrict option selection

	 *

	 * There's a bunch of bits in this table other than the RAM restrict

	 * stuff that we don't use - their use currently unknown

	/*

	 * Older bios versions don't have a sufficiently long table for

	 * what we want

	/*

	 * Parses the pointer to the TMDS table

	 *

	 * Starting at bitentry->offset:

	 *

	 * offset + 0  (16 bits): TMDS table pointer

	 *

	 * The TMDS table is typically found just before the DCB table, with a

	 * characteristic signature of 0x11,0x13 (1.1 being version, 0x13 being

	 * length?)

	 *

	 * At offset +7 is a pointer to a script, which I don't know how to

	 * run yet.

	 * At offset +9 is a pointer to another script, likewise

	 * Offset +11 has a pointer to a table where the first word is a pxclk

	 * frequency and the second word a pointer to a script, which should be

	 * run if the comparison pxclk frequency is less than the pxclk desired.

	 * This repeats for decreasing comparison frequencies

	 * Offset +13 has a pointer to a similar table

	 * The selection of table (and possibly +7/+9 script) is dictated by

	 * "or" from the DCB.

 nv50+ has v2.0, but we don't parse it atm */

	/*

	 * These two scripts are odd: they don't seem to get run even when

	 * they are not stubbed.

	/*

	 * The only restriction on parsing order currently is having 'i' first

	 * for use of bios->*_version or bios->feature_byte while parsing;

	 * functions shouldn't be actually *doing* anything apart from pulling

	 * data from the image into the bios struct, thus no interdependencies

 info? */

 g80+ */

 memory? */

	/*

	 * Parses the BMP structure for useful things, but does not act on them

	 *

	 * offset +   5: BMP major version

	 * offset +   6: BMP minor version

	 * offset +   9: BMP feature byte

	 * offset +  10: BCD encoded BIOS version

	 *

	 * offset +  18: init script table pointer (for bios versions < 5.10h)

	 * offset +  20: extra init script table pointer (for bios

	 * versions < 5.10h)

	 *

	 * offset +  24: memory init table pointer (used on early bios versions)

	 * offset +  26: SDR memory sequencing setup data table

	 * offset +  28: DDR memory sequencing setup data table

	 *

	 * offset +  54: index of I2C CRTC pair to use for CRT output

	 * offset +  55: index of I2C CRTC pair to use for TV output

	 * offset +  56: index of I2C CRTC pair to use for flat panel output

	 * offset +  58: write CRTC index for I2C pair 0

	 * offset +  59: read CRTC index for I2C pair 0

	 * offset +  60: write CRTC index for I2C pair 1

	 * offset +  61: read CRTC index for I2C pair 1

	 *

	 * offset +  67: maximum internal PLL frequency (single stage PLL)

	 * offset +  71: minimum internal PLL frequency (single stage PLL)

	 *

	 * offset +  75: script table pointers, as described in

	 * parse_script_table_pointers

	 *

	 * offset +  89: TMDS single link output A table pointer

	 * offset +  91: TMDS single link output B table pointer

	 * offset +  95: LVDS single link output A table pointer

	 * offset + 105: flat panel timings table pointer

	 * offset + 107: flat panel strapping translation table pointer

	 * offset + 117: LVDS manufacturer panel config table pointer

	 * offset + 119: LVDS manufacturer strapping translation table pointer

	 *

	 * offset + 142: PLL limits table pointer

	 *

	 * offset + 156: minimum pixel clock for LVDS dual link

 load needed defaults in case we can't parse this info */

	/*

	 * Make sure that 0x36 is blank and can't be mistaken for a DCB

	 * pointer on early versions

	/*

	 * Seems that the minor version was 1 for all major versions prior

	 * to 5. Version 6 could theoretically exist, but I suspect BIT

	 * happened instead.

 nothing that's currently useful in this version */

 exact for 1.01 */

 exact for 2.01 */

 guessed - mem init tables added in this version */

 don't know if 5.0 exists... */

 guessed - BMP I2C indices added in version 4*/

 exact for 5.01 */

 exact for 5.06 */

 exact for 5.10h */

 exact for 5.11h */

		/*

		 * Not sure of version where pll limits came in;

		 * certainly exist by 0x24 though.

 length not exact: this is long enough to get lvds members */

		/*

		 * Length not exact: this is long enough to get pll limit

		 * member

		/*

		 * Length not exact: this is long enough to get dual link

		 * transition clock.

 checksum */

	/*

	 * Bit 4 seems to indicate either a mobile bios or a quadro card --

	 * mobile behaviour consistent (nv11+), quadro only seen nv18gl-nv36gl

	 * (not nv10gl), bit 5 that the flat panel tables are present, and

	 * bit 6 a tv bios.

 appears in BMP 3 */

 BMP version 2 & 3 */

		/*

		 * Never observed in use with lvds scripts, but is reused for

		 * 18/24 bit panel interface default for EDID equipped panels

		 * (if_is_24bit not set directly to avoid any oscillation).

		/*

		 * v1.4 (some NV15/16, NV11+) seems the same as v1.5, but

		 * always has the same single (crt) entry, even when tv-out

		 * present, so the conclusion is this version cannot really

		 * be used.

		 *

		 * v1.2 tables (some NV6/10, and NV15+) normally have the

		 * same 5 entries, which are not specific to the card and so

		 * no use.

		 *

		 * v1.2 does have an I2C table that read_dcb_i2c_table can

		 * handle, but cards exist (nv11 in #14821) with a bad i2c

		 * table pointer, so use the indices parsed in

		 * parse_bmp_structure.

		 *

		 * v1.1 (NV5+, maybe some NV4) is entirely unhelpful

 seen on an NV11 with DCB v1.5 */

 seen on an NV17 with DCB v2.0 */

 ie OFF CHIP */

		/*

		 * Although the rest of a CRT conf dword is usually

		 * zeros, mac biosen have stuff there so we must mask

			/*

			 * The laptop in bug 14567 lies and claims to not use

			 * straps when it does, so assume all DCB 2.0 laptops

			 * use straps, until a broken EDID using one is produced

			/*

			 * Both 0x4 and 0x8 show up in v2.0 tables; assume they

			 * mean the same thing (probably wrong, but might work)

			/*

			 * Until we even try to use these on G8x, it's

			 * useless reporting unknown bits.  They all are.

 weird g80 mobile type that "nv" treats as a terminator */

		/* Normal entries consist of a single bit, but dual link has

		 * the next most significant bit set too

 unsure what DCB version introduces this, 3.0? */

 same as heads, hopefully safe enough */

	/*

	 * DCB v2.0 lists each output combination separately.

	 * Here we merge compatible entries to have fewer outputs, with

	 * more options

 already merged entry */

 merge heads field when all other fields the same */

 dummy value */

 Compact entries merged into others out of dcb */

	/* Dell Precision M6300

	 *   DCB entry 2: 02025312 00000010

	 *   DCB entry 3: 02026312 00000020

	 *

	 * Identical, except apparently a different connector on a

	 * different SOR link.  Not a clue how we're supposed to know

	 * which one is in use if it even shares an i2c line...

	 *

	 * Ignore the connector on the second SOR link to prevent

	 * nasty problems until this is sorted (assuming it's not a

	 * VBIOS bug).

	/* GeForce3 Ti 200

	 *

	 * DCB reports an LVDS output that should be TMDS:

	 *   DCB entry 1: f2005014 ffffffff

	/* XFX GT-240X-YA

	 *

	 * So many things wrong here, replace the entire encoder table..

 VGA, connector 1 */

 DVI, connector 0 */

 VGA, connector 0 */

 HDMI, connector 2 */

 EOL */

	/* Some other twisted XFX board (rhbz#694914)

	 *

	 * The DVI/VGA encoder combo that's supposed to represent the

	 * DVI-I connector actually point at two different ones, and

	 * the HDMI connector ends up paired with the VGA instead.

	 *

	 * Connector table is missing anything for VGA at all, pointing it

	 * an invalid conntab entry 2 so we figure it out ourself.

 VGA, connector 2 */

 DVI, connector 0 */

 VGA, connector 0 */

 HDMI, connector 1 */

 EOL */

 fdo#50830: connector indices for VGA and DVI-I are backwards */

 Apple iMac G4 NV17 */

 Make up some sane defaults */

 stop parsing */

		/* Ignore the I2C index for on-chip TV-out, as there

		 * are cards with bogus values (nv31m in bug 23212),

		 * and it's otherwise useless.

	/* heuristic: if we ever get a non-zero connector field, assume

	 * that all the indices are valid and we don't need fake them.

	 *

	 * and, as usual, a blacklist of boards with bad bios data..

	/* no useful connector info available, we need to make it up

	 * ourselves.  the rule here is: anything on the same i2c bus

	 * is considered to be on the same connector.  any output

	 * without an associated i2c bus is assigned its own unique

	 * connector index.

	/* if we created more than one connector, destroy the connector

	 * table - just in case it has random, rather than stub, entries.

 handle pre-DCB boards */

	/*

	 * apart for v2.1+ not being known for requiring merging, this

	 * guarantees dcbent->index is the index of the entry in the rom image

 dump connector table entries to log, if any exist */

	/*

	 * The header following the "HWSQ" signature has the number of entries,

	 * and the entry size

	 *

	 * An entry consists of a dword to write to the sequencer control reg

	 * (0x00001304), followed by the ucode bytes, written sequentially,

	 * starting at reg 0x00001400

 set sequencer control */

 write ucode */

 twiddle NV_PBUS_DEBUG_4 */

	/*

	 * BMP based cards, from NV17, need a microcode loading to correctly

	 * control the GPIO etc for LVDS panels

	 *

	 * BIT based cards seem to do this directly in the init scripts

	 *

	 * The microcode entries are found by the "HWSQ" signature.

 always use entry 0? */

 Reset the BIOS head to 0. */

 BMP only */

 only relevant for PCI devices */

 we don't run version 0 bios */

 init script execution disabled */

 ... unless card isn't POSTed already */

 feature_byte on BMP is poor, but init always sets CR4B */

 all BIT systems need p_f_m_t for digital_min_front_porch */

 allow subsequent scripts to execute */

/*

 * Copyright (C) 2008 Maarten Maathuis.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 tile_mode will not be used in this case */

		/*

		 * Extract the block height and kind from the corresponding

		 * modifier fields.  See drm_fourcc.h for details.

 Legacy modifier.  Translate to this dev's 'kind.' */

	/* GOBs per block in the x direction is always one, and GOBs are

	 * 64 bytes wide

 YUV overlays have special requirements pre-NV50 */

 align 64 */

 at most 64k pitch */

 pitches for planes must match */

 Nothing to do, exit early without updating the last busy counter */

				/* If the GPU is already awake, or in a state

				 * where we can't wake it up, it can handle

				 * it's own hotplug events.

				/* We've started resuming the GPU already, so

				 * it will handle scheduling a full reprobe

				 * itself

 acpi-video should not generate keypresses for this */

	/*

	 * Enable hotplug interrupts (done as early as possible, since we need

	 * them for MST)

	/* enable connector detection and polling for connectors without HPD

	 * support

 disable hotplug interrupts */

 -90..+90 */

 -100..+100 */

 Use VRAM if there is any ; otherwise fallback to system memory */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (C) 2008 Ben Skeggs.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

	/* Initialize the embedded gem-object. We return a single gem-reference

	/* we restrict allowed domains on nv50+ to only the types

	 * that were requested at creation time.  not possibly on

	 * earlier chips without busting the ABI.

 drop reference from allocate - handle holds it now */

 Ensure all push buffers are on validate list */

 Validate buffer list */

 Apply any relocations that are required */

 SPDX-License-Identifier: MIT

	/*

	 * FIXME: open_count is protected by drm_global_mutex but that would lead to

	 * locking inversion with the driver load path. And the access here is

	 * completely racy anyway. So don't bother with locking for now.

 only relevant for PCI devices */

 don't register Thunderbolt eGPU with vga_switcheroo */

 only relevant for PCI devices */

/*

 * Copyright 2010 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 depth 24 */

 depth 32, just use 24.. */

 depth 30 */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2007 Dave Airlied

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Authors: Dave Airlied <airlied@linux.ie>

 *	    Ben Skeggs   <darktama@iinet.net.au>

 *	    Jeremy Kolb  <jkolb@brandeis.edu>

/*

 * Copyright 2020 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*XXX: Fixup class to be compatible with NVIDIA's, which will allow sharing

 *     code with KeplerDmaCopyA.

/*

 * Copyright © 2007 David Airlie

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *     David Airlie

	/* Clear the entire fbcon.  The drm will program every connector

	 * with it's preferred mode.  If the sizes differ, one display will

	 * quite likely have garbage around the console.

 setup helper */

 Use default scratch pixmap (info->pixmap.flags = FB_PIXMAP_SYSTEM) */

 To allow resizeing without swapping buffers */

	/* Since runtime resume can happen as a result of a sysfs operation,

	 * it's possible we already have the console locked. So handle fbcon

	 * init/deinit from a seperate work thread

		/* If the GPU was already in the process of suspending before

		 * this event happened, then we can't block here as we'll

		 * deadlock the runtime pmops since they wait for us to

		 * finish. So, just defer this event for when we runtime

		 * resume again. It will be handled by fbcon_work.

 disable all the possible outputs/crtcs before entering KMS mode */

/*

 * Copyright 2007 Dave Airlied

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Authors: Dave Airlied <airlied@linux.ie>

 *	    Ben Skeggs   <darktama@iinet.net.au>

 *	    Jeremy Kolb  <jkolb@brandeis.edu>

/*XXX: Fixup class to be compatible with NVIDIA's, which will allow sharing

 *     code with KeplerDmaCopyA.

/*

 * Copyright 2010 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2007 Dave Airlied

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Authors: Dave Airlied <airlied@linux.ie>

 *	    Ben Skeggs   <darktama@iinet.net.au>

 *	    Jeremy Kolb  <jkolb@brandeis.edu>

 MODE_COPY, QUERY_NONE */);

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

XXX: warn? */

XXX: warn? */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2020 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 determine falcon capabilities */

 wait for 'uc halted' to be signalled before continuing */

 disable all interrupts */

	/* no default ucode provided by the engine implementation, try and

	 * locate a "self-bootstrapping" firmware image for the engine

	/* next step is to try and load "static code/data segment" firmware

	 * images for the engine

 ensure any "self-bootstrapping" firmware image is in vram */

 upload firmware bootloader (or the full code segments) */

 upload data segment (if necessary), zeroing the remainder */

 start it running */

 BLOCK_ON_FIFO */

 ENTRY */

 TRIGGER */

 FIFO | CHSW */

/*

 * Copyright 2013 Ilia Mirkin

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 INTR_EN */

 FIFO_CTRL */

 ?? */

 ?? */

 ?? */

 INTR */

 INTR_EN */

 XT_REGION_BASE */

 XT_REGION_SETUP */

 XT_REGION_LIMIT */

 SCRATCH_H2X */

 XT_REGION_SETUP */

 INTR */

 INTR_EN */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 PIO channel */

 inactive channel */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 search 128 */ |

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 maybe? */

	{ 0x00008000, "" }	seen with null ib push */

 Determine number of PBDMAs by checking valid enable bits. */

 Enable PBDMAs. */

 Assign engines to PBDMAs. */

 PGRAPH */

 PVP */

 PMSPP */

 PMSVLD */

 PCE0 */

 PCE1 */

 PBDMA[n] */

 INTR */

 INTREN */

 ENGINE_INTR_EN */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 SEARCH_FULL */ |

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 prevent fifo context switches */

 if this channel is active, replace it with a null context */

 restore normal operation, after disabling dma mode */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Allocate the channel. */

	/* Hack to support GPUs where even individual channels should be

	 * part of a channel group.

 Clear channel control registers. */

 RAMFC */

 0x002310 */

 0x002350 */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* in some cases the puller may be left in an inconsistent state

	 * if you try to stop it while it's busy translating handles.

	 * sometimes you get a CACHE_ERROR, sometimes it just fails

	 * silently; sending incorrect instance offsets to PGRAPH after

	 * it's started up again.

	 *

	 * to avoid this, we invalidate the most recently calculated

	 * instance.

 NV50+ */, "MEM_FAULT", "UNK"

 subchannel's engine -> software */

 handle -> instance */

 pass method down to sw */

	/* NV_PFIFO_CACHE1_GET actually goes to 0xffc before wrapping on my

	 * G80 chips, but CACHE1 isn't big enough for this much data.. Tests

	 * show that it wraps around to the start at GET=0x800.. No clue as to

	 * why..

 METHOD_COUNT, in DMA_STATE on earlier chipsets */

 search 128 */ |

 inactive channel */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 allocate channel */

 clear channel control registers */

 RAMFC */

 0x002310 */

 0x002350 */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 search 128 */ |

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 NV31- */

/*

 * Copyright (c) 2015, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Determine number of PBDMAs by checking valid enable bits. */

 Block runlist to prevent channel assignment(s) from changing. */

 Schedule recovery. */

 Lookup SW state for channel, and mark it as dead. */

 Disable channel. */

 Block channel assignments from changing during recovery. */

 Schedule recovery for any engines the channel is on. */

 Block channel assignments from changing during recovery. */

 Determine which channel (if any) is currently on the engine. */

 The channel is not longer viable, kill it. */

	/* Determine MMU fault ID for the engine, if we're not being

	 * called from the fault handler already.

	/* Trigger a MMU fault for the engine.

	 *

	 * No good idea why this is needed, but nvgpu does something similar,

	 * and it makes recovery from CTXSW_TIMEOUT a lot more reliable.

 Wait for fault to trigger. */

 Release MMU fault trigger, and ACK the fault. */

 Schedule recovery. */

 Kill the channel that caused the fault. */

	/* Channel recovery will probably have already done this for the

	 * correct engine(s), but just in case we can't find the channel

	 * information...

	/* We need to ACK the SCHED_ERROR here, and prevent it reasserting,

	 * as MMU_FAULT cannot be triggered while it's pending.

 allow mmu fault interrupts, even when we're not using fifo */

 Read PBDMA->runlist(s) mapping from HW. */

 Determine runlist configuration from topology device info. */

 Determine which PBDMA handles requests for this engine. */

 TSG+chan */ *

 Enable PBDMAs. */

 PBDMA[n] */

 INTR */

 INTREN */

 PBDMA[n].HCE */

 INTR */

 INTREN */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

XXX: target? */

XXX: how to wait? can you even wait? */

XXX: this is a bit of a guess at this point in time. */

 Block runlist to prevent channel assignment(s) from changing. */

 Schedule recovery. */

 Lookup SW state for channel, and mark it as dead. */

 Disable channel. */

 Block channel assignments from changing during recovery. */

 Schedule recovery for any engines the channel is on. */

 Block channel assignments from changing during recovery. */

 Determine which channel (if any) is currently on the engine. */

 The channel is not longer viable, kill it. */

 Preempt the runlist */

 Schedule recovery. */

 Kill the channel that caused the fault. */

	/* Channel recovery will probably have already done this for the

	 * correct engine(s), but just in case we can't find the channel

	 * information...

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 instance memory */

 allocate push buffer ctxdma instance */

 channel address space */

 allocate channel id */

 determine address of this channel's user registers */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 SEARCH_FULL */ |

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Block runlist to prevent the channel from being rescheduled. */

 Preempt the channel. */

 Update engine context validity. */

 Resume runlist. */

 Allocate the channel. */

	/* Hack to support GPUs where even individual channels should be

	 * part of a channel group.

 Clear channel control registers. */

 Allocate fault method buffer (magics come from nvgpu). */

 NV_PCE_PCE_MAP */

 RAMFC */

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* HW bug workaround:

	 *

	 * PFIFO will hang forever if the connected engines don't report

	 * that they've processed the context switch request.

	 *

	 * In order for the kickoff to work, we need to ensure all the

	 * connected engines are in a state where they can answer.

	 *

	 * Newer chipsets don't seem to suffer from this issue, and well,

	 * there's also a "ignore these engines" bitmask reg we can use

	 * if we hit the issue there..

 do the kickoff... */

 remove channel from runlist, fifo will unload context */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2014, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Nouveau project

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Samuel Pitoiset

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 HUB */

 GPC */

 PART */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Sources ID start from 1 */

 set enable bit if needed */

 enable the source */

 unset enable bit if needed */

 disable the source */

/*******************************************************************************

 * Perfdom object classes

 enable sources */

 start next batch of counters for sampling */

 sample previous batch of counters */

/*******************************************************************************

 * Perfmon object classes

		/* Currently only global counters (PCOUNTER) are implemented

/*******************************************************************************

 * PPM engine/subdev functions

 No sources are defined for this signal. */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Samuel Pitoiset

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Samuel Pitoiset

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Samuel Pitoiset

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Samuel Pitoiset

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 returns true if the GPU is in the CPU native byte order */

	/* Read NV_PMC_BOOT_1, and assume non-functional endian switch if it

	 * doesn't contain the expected values.

 Assume GPU is LE in this case. */

	/* 0 means LE and 0x01000001 means BE GPU. Condition is true when

	 * GPU/CPU endianness don't match.

 Assume GPU is LE on any unexpected read-back. */

 CPU/GPU endianness should (hopefully) match. */

 identify the chipset, and determine classes of subdev/engines */

 switch mmio to cpu's native endianness */

 chipset can be overridden for devel/testing purposes */

 determine chipset and derive architecture from it */

 vGPU detection */

 read strapping information */

 determine frequency of timing crystal */

/*

 * Copyright (c) 2014, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

		/*

		 * A IOMMU is only usable if it supports page sizes smaller

		 * or equal to the system's PAGE_SIZE, with a preference if

		 * both are equal.

	/**

	 * The IOMMU bit defines the upper limit of the GPU-addressable space.

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 Apple iMac G4 NV18 */

 MSI nForce2 IGP */

 Zotac FX5200 */

 Set DMA mask based on capabilities reported by the MMU subdev. */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 give priviledged clients register access */

 find the device that matches what the client requested */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

		/* XXX: don't currently know how to construct a real one

		 *      of these.  we only use them to represent pushbufs

		 *      on these chipsets, and the classes that use them

		 *      deal with the target themselves.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 rw */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * Graphics object classes

/*******************************************************************************

 * PGRAPH context

/*******************************************************************************

 * PGRAPH engine/subdev functions

 any bit set? */

 There must be a *lot* of these. Will take some time to gather them up. */

 CUDA memory: l[], g[] or stack. */

 g[] read fault? */

 g[] write fault? */

 texture error... unknown for now */

 MP error */

 PROP error */

	/* DISPATCH: Relays commands to other units and handles NOTIFY,

	 * COND, QUERY. If you get a trap from it, the command is still stuck

 Known to be triggered by screwed up NOTIFY and COND... */

 M2MF: Memory to memory copy engine. */

 No sane way found yet -- just reset the bugger. */

 VFETCH: Fetches data from vertex buffers. */

 STRMOUT: DirectX streamout / OpenGL transform feedback. */

 No sane way found yet -- just reset the bugger. */

 CCACHE: Handles code and c[] caches and fills them. */

	/* Unknown, not seen yet... 0x402000 is the only trap status reg

	 * remaining, so try to handle it anyway. Perhaps related to that

 no status modifiction on purpose */

 TEXTURE: CUDA texturing units */

 MP: CUDA execution engines. */

	/* PROP:  Handles TP-initiated uncached memory accesses:

 NV_PGRAPH_DEBUG_3_HW_CTX_SWITCH_ENABLED */

 reset/enable traps and interrupts */

 upload context program, initialise ctxctl defaults */

 some unknown zcull magic */

 zero out zcull regions */

/*

 * Copyright 2010 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

 Pack tile map into register format. */

 Magic. */

 GPC_BROADCAST */

 GPC_BROADCAST.TP_BROADCAST */

 UNK78xx */

XXX: 3

XXX: 5

XXX: 6

XXX: 9

XXX: 10

XXX: 12

XXX: 13

 NV_PGRAPH_FE_PWR_MODE_FORCE_ON. */

 Reset FECS. */

 NV_PGRAPH_FE_PWR_MODE_AUTO. */

 Init SCC RAM. */

	/* Allocate memory to for a "channel", which we'll use to generate

	 * the default context values.

 Setup context pointer. */

 Setup default state for mmio list construction. */

 Make channel current. */

	/* Trigger a context unload by unsetting the "next channel valid" bit

	 * and faking a context switch interrupt.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 patt */

 gdi */

 surf2d */

 beta4 */

 sifm */

 ifc */

 imageblit */

 surf2d (nv40) */

 sifm (nv40) */

 swzsurf (nv40) */

 curie */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2015, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * Graphics object classes

/*******************************************************************************

 * PGRAPH context

/*******************************************************************************

 * PGRAPH engine/subdev functions

 generate and upload context program */

 No context present currently */

 pciid also 0x00Cx */

 case 0x0120: XXX (pciid) */

 G72 */

 G7x-based C51 */

 G70 */

 G71 */

 G73 */

 Tiling related stuff. */

 begin RAM config */

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 patt */

 gdi */

 surf2d */

 beta4 */

 sifm */

 ifc */

 imageblit */

 surf2d (nv40) */

 sifm (nv40) */

 swzsurf (nv40) */

 curie */

 SPDX-License-Identifier: MIT

/*******************************************************************************

 * PGRAPH context

/*******************************************************************************

 * PGRAPH engine/subdev functions

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 patt */

 gdi */

 surf2d */

 beta4 */

 sifm */

 ifc */

 imageblit */

 surf2d (nv30) */

 sifm (nv30) */

 ifc (nv30) */

 swzsurf (nv30) */

 rankine */

 kelvin */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * Zero Bandwidth Clear

 TRIGGER | WRITE | COLOR */

 TRIGGER | WRITE | DEPTH */

/*******************************************************************************

 * Graphics object classes

/*******************************************************************************

 * PGRAPH context

	/* allocate memory for a "mmio list" buffer that's used by the HUB

	 * fuc to modify some per-context register settings on first load

	 * of the context.

 allocate buffers referenced by mmio list */

 finally, fill in the mmio list and point the context at it */

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

	/*XXX: We need to allocate + map the above into PMU's inst block,

	 *     which which means we probably need a proper PMU before we

	 *     even bother.

/**

 * Wait until GR goes idle. GR is considered idle if it is disabled by the

 * MC (0x200) register, or GR is not busy and a context switch is not in

 * progress.

		/*

		 * required to make sure FIFO_ENGINE_STATUS (0x2640) is

		 * up-to-date

			/**

			 * Wait for GR to go idle after submitting a

			 * GO_IDLE bundle

		/*

		 * notifier interrupt, only needed for cyclestats

		 * can be safely ignored

 Initialize context from an external (secure or not) firmware */

 load fuc microcode */

 securely-managed falcons must be reset using secure boot */

 start both of them running */

 Determine how much memory is required to store main context image. */

 Determine how much memory is required to store ZCULL image. */

 Determine how much memory is required to store PerfMon image. */

	/*XXX: We (likely) require PMU support to even bother with this.

	 *

	 *     Also, it seems like not all GPUs support ELPG.  Traces I

	 *     have here show RM enabling it on Kepler/Turing, but none

	 *     of the GPUs between those.  NVGPU decides this by PCIID.

 Generate golden context image. */

 load HUB microcode */

 load GPC microcode */

 load register lists */

 start HUB ucode running, it'll init the GPCs */

 Sort GPCs by TPC count, highest-to-lowest. */

 Determine tile->GPC mapping */

	/* On certain GP107/GP108 boards, we trigger a weird issue where

	 * GR will stop responding to PRI accesses after we've asked the

	 * SEC2 RTOS to boot the GR falcons.  This happens with far more

	 * frequency when cold-booting a board (ie. returning from D3).

	 *

	 * The root cause for this is not known and has proven difficult

	 * to isolate, with many avenues being dead-ends.

	 *

	 * A workaround was discovered by Karol, whereby putting GR into

	 * reset for an extended period right before initialisation

	 * prevents the problem from occuring.

	 *

	 * XXX: As RM does not require any such workaround, this is more

	 *      of a hack than a true fix.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

 guess at it being related */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2007 Matthieu CASTET <castet.matthieu@free.fr>

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragr) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 64 values from 0x400900 to 0x4009fc */

 2 values from 0x400808 to 0x40080c */

 8 values from 0x400f00-0x400f1c */

 8 values from 0x400f20-0x400f3c */

 32 values from 0x400400 to 0x40047c */

 32 values from 0x400480 to 0x4004fc */

/*******************************************************************************

 * Graphics object classes

/*******************************************************************************

 * PGRAPH context

 XXX check haiku comments */

 restore XFMODE */

	/* NV10TCL_DMA_VTXBUF (method 0x18c) modifies hidden state

	 * that cannot be restored via MMIO. Do it through the FIFO

	 * instead.

 Look for a celsius object */

 Save the current ctx object */

 Save the FIFO state */

 Switch to the celsius subchannel */

 Inject NV10TCL_DMA_VTXBUF */

 Restore the FIFO state */

 Restore the current ctx object */

 If previous context is valid, we need to save it */

 load context for next channel */

 is it really needed ??? */

/*******************************************************************************

 * PGRAPH engine/subdev functions

 nvkm_wr32(device, NV04_PGRAPH_DEBUG_2, 0x24E00810); */ 
 beta1 */

 clip */

 null */

 m2mf */

 rop */

 pattern */

 gdi */

 swzsurf */

 blit */

 surf2d */

 beta4 */

 sifm */

 ifc */

 blit */

 surf3d */

 ttri */

 mtri */

 celcius */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 set when any bit is set */

 SPDX-License-Identifier: MIT

/*******************************************************************************

 * PGRAPH context

/*******************************************************************************

 * PGRAPH engine/subdev functions

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 patt */

 gdi */

 surf2d */

 beta4 */

 sifm */

 ifc */

 celcius */

 swzsurf */

 imageblit */

 kelvin */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context implementation

 SPDX-License-Identifier: MIT

/*******************************************************************************

 * PGRAPH context

/*******************************************************************************

 * PGRAPH engine/subdev functions

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 patt */

 gdi */

 surf2d */

 beta4 */

 sifm */

 ifc */

 imageblit */

 surf2d (nv30) */

 sifm (nv30) */

 ifc (nv30) */

 swzsurf (nv30) */

 kelvin */

 rankine */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH engine/subdev functions

XXX: otherwise identical to gm200 aside from mask.. do everywhere? */

 zrop */

 crop */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

	/*XXX: Not real sure where to apply these, there doesn't seem

	 *     to be any pattern to which chipsets it's done on.

	 *

	 *     Perhaps a VBIOS tweak?

XXX: Figure out how to modify this correctly! */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 SPDX-License-Identifier: MIT

/*******************************************************************************

 * PGRAPH context

/*******************************************************************************

 * PGRAPH engine/subdev functions

 0x4 = auto ctx switch */

 begin RAM config */

 interesting.. the below overwrites some of the tile setup above.. */

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 patt */

 gdi */

 surf2d */

 beta4 */

 sifm */

 ifc */

 celcius */

 kelvin */

 swzsurf */

 imageblit */

/*

 * Copyright 2007 Stephane Marchesin

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragr) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*******************************************************************************

 * Graphics object classes

/*

 * Software methods, why they are needed, and how they all work:

 *

 * NV04 and NV05 keep most of the state in PGRAPH context itself, but some

 * 2d engine settings are kept inside the grobjs themselves. The grobjs are

 * 3 words long on both. grobj format on NV04 is:

 *

 * word 0:

 *  - bits 0-7: class

 *  - bit 12: color key active

 *  - bit 13: clip rect active

 *  - bit 14: if set, destination surface is swizzled and taken from buffer 5

 *            [set by NV04_SWIZZLED_SURFACE], otherwise it's linear and taken

 *            from buffer 0 [set by NV04_CONTEXT_SURFACES_2D or

 *            NV03_CONTEXT_SURFACE_DST].

 *  - bits 15-17: 2d operation [aka patch config]

 *  - bit 24: patch valid [enables rendering using this object]

 *  - bit 25: surf3d valid [for tex_tri and multitex_tri only]

 * word 1:

 *  - bits 0-1: mono format

 *  - bits 8-13: color format

 *  - bits 16-31: DMA_NOTIFY instance

 * word 2:

 *  - bits 0-15: DMA_A instance

 *  - bits 16-31: DMA_B instance

 *

 * On NV05 it's:

 *

 * word 0:

 *  - bits 0-7: class

 *  - bit 12: color key active

 *  - bit 13: clip rect active

 *  - bit 14: if set, destination surface is swizzled and taken from buffer 5

 *            [set by NV04_SWIZZLED_SURFACE], otherwise it's linear and taken

 *            from buffer 0 [set by NV04_CONTEXT_SURFACES_2D or

 *            NV03_CONTEXT_SURFACE_DST].

 *  - bits 15-17: 2d operation [aka patch config]

 *  - bits 20-22: dither mode

 *  - bit 24: patch valid [enables rendering using this object]

 *  - bit 25: surface_dst/surface_color/surf2d/surf3d valid

 *  - bit 26: surface_src/surface_zeta valid

 *  - bit 27: pattern valid

 *  - bit 28: rop valid

 *  - bit 29: beta1 valid

 *  - bit 30: beta4 valid

 * word 1:

 *  - bits 0-1: mono format

 *  - bits 8-13: color format

 *  - bits 16-31: DMA_NOTIFY instance

 * word 2:

 *  - bits 0-15: DMA_A instance

 *  - bits 16-31: DMA_B instance

 *

 * NV05 will set/unset the relevant valid bits when you poke the relevant

 * object-binding methods with object of the proper type, or with the NULL

 * type. It'll only allow rendering using the grobj if all needed objects

 * are bound. The needed set of objects depends on selected operation: for

 * example rop object is needed by ROP_AND, but not by SRCCOPY_AND.

 *

 * NV04 doesn't have these methods implemented at all, and doesn't have the

 * relevant bits in grobj. Instead, it'll allow rendering whenever bit 24

 * is set. So we have to emulate them in software, internally keeping the

 * same bits as NV05 does. Since grobjs are aligned to 16 bytes on nv04,

 * but the last word isn't actually used for anything, we abuse it for this

 * purpose.

 *

 * Actually, NV05 can optionally check bit 24 too, but we disable this since

 * there's no use for it.

 *

 * For unknown reasons, NV04 implements surf3d binding in hardware as an

 * exception. Also for unknown reasons, NV04 doesn't implement the clipping

 * methods on the surf3d object, so we have to emulate them too.

 check for valid surf2d/surf_dst/surf_color */

 check for valid surf_src/surf_zeta */

 SRCCOPY_AND, SRCCOPY: no extra objects required */

 ROP_AND: requires pattern and rop */

 BLEND_AND: requires beta1 */

 SRCCOPY_PREMULT, BLEND_PREMULT: beta4 required */

 Old versions of the objects only accept first three operations. */

 changing operation changes set of objects needed for validation */

 too large */

 yes, it accepts negative for some reason. */

 too large */

 yes, it accepts negative for some reason. */

	/* Yes, for some reason even the old versions of objects

	 * accept 0x57 and not 0x17. Consistency be damned.

/*******************************************************************************

 * PGRAPH context

 If previous context is valid, we need to save it */

 load context for next channel */

/*******************************************************************************

 * PGRAPH engine/subdev functions

 Enable PGRAPH interrupts */

	/*nvkm_wr32(device, NV04_PGRAPH_DEBUG_0, 0x000001FF);

1231C000 blob, 001 haiku*/

V_WRITE(NV04_PGRAPH_DEBUG_1, 0xf2d91100);*/

0x72111100 blob , 01 haiku*/

nvkm_wr32(device, NV04_PGRAPH_DEBUG_2, 0x11d5f870);*/

haiku same*/

nvkm_wr32(device, NV04_PGRAPH_DEBUG_3, 0xfad4ff31);*/

haiku and blob 10d4*/

 These don't belong here, they're part of a per-channel context */

 beta1 */

 chroma */

 pattern (nv01) */

 clip */

 line */

 tri */

 rect */

 null */

 dvd subpicture */

 m2mf */

 surf2d */

 rop */

 pattern */

 swzsurf */

 ttri */

 mtri */

 chroma */

 surf_dst */

 surf_src */

 surf_color */

 surf_zeta */

 line */

 tri */

 rect */

 iifc (nv05) */

 ifc (nv05) */

 sifc (nv05) */

 beta4 */

/*

 * Copyright 2009 Marcin Kościelnicki

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * This code deals with PGRAPH contexts on NV50 family cards. Like NV40, it's

 * the GPU itself that does context-switching, but it needs a special

 * microcode to do it. And it's the driver's task to supply this microcode,

 * further known as ctxprog, as well as the initial context values, known

 * as ctxvals.

 *

 * Without ctxprog, you cannot switch contexts. Not even in software, since

 * the majority of context [xfer strands] isn't accessible directly. You're

 * stuck with a single channel, and you also suffer all the problems resulting

 * from missing ctxvals, since you cannot load them.

 *

 * Without ctxvals, you're stuck with PGRAPH's default context. It's enough to

 * run 2d operations, but trying to utilise 3d or CUDA will just lock you up,

 * since you don't have... some sort of needed setup.

 *

 * Nouveau will just disable acceleration if not given ctxprog + ctxvals, since

 * it's too much hassle to handle no-ctxprog as a special case.

/*

 * How ctxprogs work.

 *

 * The ctxprog is written in its own kind of microcode, with very small and

 * crappy set of available commands. You upload it to a small [512 insns]

 * area of memory on PGRAPH, and it'll be run when PFIFO wants PGRAPH to

 * switch channel. or when the driver explicitely requests it. Stuff visible

 * to ctxprog consists of: PGRAPH MMIO registers, PGRAPH context strands,

 * the per-channel context save area in VRAM [known as ctxvals or grctx],

 * 4 flags registers, a scratch register, two grctx pointers, plus many

 * random poorly-understood details.

 *

 * When ctxprog runs, it's supposed to check what operations are asked of it,

 * save old context if requested, optionally reset PGRAPH and switch to the

 * new channel, and load the new context. Context consists of three major

 * parts: subset of MMIO registers and two "xfer areas".

/* TODO:

 *  - document unimplemented bits compared to nvidia

 *  - NVAx: make a TP subroutine, use it.

 *  - use 0x4008fc instead of 0x1540?

 Main function: construct the ctxprog skeleton, call the other functions. */

 decide whether we're loading/unloading the context */

 setup for context load */

 setup for context save */

 general PGRAPH state */

 needed. otherwise, flickering happens. */

 no idea why this is needed, but fixes at least one lockup. */

 pre-exit state updates */

 padding... no idea why you need it */

/*

 * Constructs MMIO part of ctxprog and ctxvals. Just a matter of knowing which

 * registers to save/restore and the default values for them.

 0800: DISPATCH */

 0C00: VFETCH */

 1000 */

 1400 */

 1800: STREAMOUT */

 1C00 */

 2000 */

 2400 */

 2800: CSCHED */

 2C00: ZCULL */

 3000: ENG2D */

 3400 */

 5000: CCACHE */

 6000? */

 6800: M2MF */

 7000: per-ROP group state */

 8000+: per-TP state */

 per-MP state */

 tesla state */

 00000001 UNK0F90 */

 00000001 UNK135C */

 SRC_TIC state */

 00000007 SRC_TILE_MODE_Z */

 00000007 SRC_TILE_MODE_Y */

 00000001 SRC_LINEAR #1 */

 000000ff SRC_ADDRESS_HIGH */

 00000001 SRC_SRGB */

 00000003 eng2d UNK0258 */

 00000fff SRC_DEPTH */

 0000ffff SRC_HEIGHT */

 turing state */

 0000000f TEXTURES_LOG2 */

 0000000f SAMPLERS_LOG2 */

 000000ff CB_DEF_ADDRESS_HIGH */

 ffffffff CB_DEF_ADDRESS_LOW */

 ffffffff SHARED_SIZE */

 ffffffff REG_MODE */

 0000ffff BLOCK_ALLOC_THREADS */

 00000001 LANES32 */

 000000ff UNK370 */

 000000ff USER_PARAM_UNK */

 000000ff USER_PARAM_COUNT */

 000000ff UNK384 bits 8-15 */

 003fffff TIC_LIMIT */

 000fffff TSC_LIMIT */

 0000ffff CB_ADDR_INDEX */

 000007ff BLOCKDIM_X */

 000007ff BLOCKDIM_XMY */

 00000001 BLOCKDIM_XMY_OVERFLOW */

 0003ffff BLOCKDIM_XMYMZ */

 000007ff BLOCKDIM_Y */

 0000007f BLOCKDIM_Z */

 000000ff CP_REG_ALLOC_TEMP */

 00000001 BLOCKDIM_DIRTY */

 00000003 UNK03E8 */

 0000007f BLOCK_ALLOC_HALFWARPS */

 00000007 LOCAL_WARPS_NO_CLAMP */

 00000007 LOCAL_WARPS_LOG_ALLOC */

 00000007 STACK_WARPS_NO_CLAMP */

 00000007 STACK_WARPS_LOG_ALLOC */

 00001fff BLOCK_ALLOC_REGSLOTS_PACKED */

 00001fff BLOCK_ALLOC_REGSLOTS_STRIDED */

 000007ff BLOCK_ALLOC_THREADS */

 compat 2d state */

 0000ffff clip X, Y, W, H */

 ffffffff chroma COLOR_FORMAT */

 ffffffff pattern COLOR_FORMAT */

 ffffffff pattern SHAPE */

 ffffffff pattern PATTERN_SELECT */

 ffffffff surf2d SRC_FORMAT */

 ffffffff surf2d DMA_SRC */

 000000ff surf2d SRC_ADDRESS_HIGH */

 ffffffff surf2d SRC_ADDRESS_LOW */

 0000ffff surf2d SRC_PITCH */

 0000000f surf2d SRC_TILE_MODE_Z */

 0000000f surf2d SRC_TILE_MODE_Y */

 ffffffff surf2d SRC_HEIGHT */

 00000001 surf2d SRC_LINEAR */

 ffffffff surf2d SRC_WIDTH */

 0000ffff gdirect CLIP_B_X */

 0000ffff gdirect CLIP_B_Y */

 0000ffff gdirect CLIP_C_X */

 0000ffff gdirect CLIP_C_Y */

 0000ffff gdirect CLIP_D_X */

 0000ffff gdirect CLIP_D_Y */

 ffffffff gdirect COLOR_FORMAT */

 ffffffff gdirect OPERATION */

 0000ffff gdirect POINT_X */

 0000ffff gdirect POINT_Y */

 0000ffff blit SRC_Y */

 ffffffff blit OPERATION */

 ffffffff ifc OPERATION */

 ffffffff iifc INDEX_FORMAT */

 ffffffff iifc LUT_OFFSET */

 ffffffff iifc COLOR_FORMAT */

 ffffffff iifc OPERATION */

 m2mf state */

 ffffffff m2mf LINE_COUNT */

 ffffffff m2mf LINE_LENGTH_IN */

 ffffffff m2mf OFFSET_IN, OFFSET_OUT */

 ffffffff m2mf TILING_DEPTH_OUT */

 ffffffff m2mf TILING_HEIGHT_OUT */

 ffffffff m2mf TILING_POSITION_OUT_Z */

 00000001 m2mf LINEAR_OUT */

 0000ffff m2mf TILING_POSITION_OUT_X, Y */

 ffffffff m2mf TILING_PITCH_OUT */

 ffffffff m2mf TILING_DEPTH_IN */

 ffffffff m2mf TILING_HEIGHT_IN */

 ffffffff m2mf TILING_POSITION_IN_Z */

 00000001 m2mf LINEAR_IN */

 0000ffff m2mf TILING_POSITION_IN_X, Y */

 ffffffff m2mf TILING_PITCH_IN */

 more compat 2d state */

 ffffffff line COLOR_FORMAT */

 ffffffff line OPERATION */

 ffffffff triangle COLOR_FORMAT */

 ffffffff triangle OPERATION */

 0000000f sifm TILE_MODE_Z */

 0000000f sifm TILE_MODE_Y */

 000000ff sifm FORMAT_FILTER */

 000000ff sifm FORMAT_ORIGIN */

 0000ffff sifm SRC_PITCH */

 00000001 sifm SRC_LINEAR */

 000000ff sifm SRC_OFFSET_HIGH */

 ffffffff sifm SRC_OFFSET */

 0000ffff sifm SRC_HEIGHT */

 0000ffff sifm SRC_WIDTH */

 ffffffff sifm COLOR_FORMAT */

 ffffffff sifm OPERATION */

 ffffffff sifc OPERATION */

 tesla state */

 0000000f GP_TEXTURES_LOG2 */

 0000000f GP_SAMPLERS_LOG2 */

 000000ff */

 ffffffff */

 000000ff UNK12B0_0 */

 000000ff UNK12B0_1 */

 000000ff UNK12B0_3 */

 000000ff UNK12B0_2 */

 0000000f FP_TEXTURES_LOG2 */

 0000000f FP_SAMPLERS_LOG2 */

 ffffffff */

 0000007f MULTISAMPLE_SAMPLES_LOG2 */

 0000000f MULTISAMPLE_SAMPLES_LOG2 */

 000000ff SEMANTIC_COLOR.BFC0_ID */

 00000001 SEMANTIC_COLOR.CLMP_EN */

 000000ff SEMANTIC_COLOR.COLR_NR */

 000000ff SEMANTIC_COLOR.FFC0_ID */

 000000ff SEMANTIC_LAYER */

 00000001 */

 00000001 SEMANTIC_PTSZ.ENABLE */

 000000ff SEMANTIC_PTSZ.PTSZ_ID */

 000000ff SEMANTIC_PRIM */

 000000ff SEMANTIC_LAYER */

 0000000f SMENATIC_CLIP.CLIP_HIGH */

 000000ff SEMANTIC_CLIP.CLIP_LO */

 000000ff UNK0FD4 */

 00000001 UNK1900 */

 00000007 RT_CONTROL_MAP0 */

 00000007 RT_CONTROL_MAP1 */

 00000007 RT_CONTROL_MAP2 */

 00000007 RT_CONTROL_MAP3 */

 00000007 RT_CONTROL_MAP4 */

 00000007 RT_CONTROL_MAP5 */

 00000007 RT_CONTROL_MAP6 */

 00000007 RT_CONTROL_MAP7 */

 0000000f RT_CONTROL_COUNT */

 00000001 RT_HORIZ_UNK */

 ffffffff RT_ADDRESS_LOW */

 000000ff RT_FORMAT */

 000000ff RT_FORMAT */

 1, 1, 1 */

 1, 1 */

 ffffffff GP_ENABLE */

 0000ffff GP_VERTEX_OUTPUT_COUNT*/

 000000ff GP_REG_ALLOC_RESULT */

 000000ff GP_RESULT_MAP_SIZE */

 00000003 */

 00000001 UNK1418. Alone. */

 00000003 UNK15AC */

 ffffffff RASTERIZE_ENABLE */

 00000001 FP_CONTROL.EXPORTS_Z */

 00000001 FP_CONTROL.MULTIPLE_RESULTS */

 000000ff FP_INTERPOLANT_CTRL.COUNT */

 000000ff FP_INTERPOLANT_CTRL.COUNT_NONFLAT */

 000000ff FP_INTERPOLANT_CTRL.OFFSET */

 00000001 FP_INTERPOLANT_CTRL.UMASK.W */

 00000001 FP_INTERPOLANT_CTRL.UMASK.X */

 00000001 FP_INTERPOLANT_CTRL.UMASK.Y */

 00000001 FP_INTERPOLANT_CTRL.UMASK.Z */

 000000ff FP_RESULT_COUNT */

 ffffffff REG_MODE */

 000000ff FP_REG_ALLOC_TEMP */

 ffffffff */

 00000001 GP_BUILTIN_RESULT_EN.LAYER_IDX */

 ffffffff STRMOUT_ENABLE */

 003fffff TIC_LIMIT */

 000fffff TSC_LIMIT */

 00000001 VERTEX_TWO_SIDE_ENABLE*/

 00000001 */

 00000007 VTX_ATTR_DEFINE.COMP */

 00000007 VTX_ATTR_DEFINE.SIZE */

 00000007 VTX_ATTR_DEFINE.TYPE */

 000000ff VTX_ATTR_DEFINE.ATTR */

 0000007f VP_RESULT_MAP_SIZE */

 0000001f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 0000000f VP_TEXTURES_LOG2 */

 0000000f VP_SAMPLERS_LOG2 */

 00000001 */

 00000003 POLYGON_MODE_BACK */

 00000003 VTX_ATTR_DEFINE.SIZE - 1 */

 0000ffff CB_ADDR_INDEX */

 00000003 */

 00000001 CULL_FACE_ENABLE */

 00000003 CULL_FACE */

 00000001 FRONT_FACE */

 00000003 POLYGON_MODE_FRONT */

 00007fff UNK141C */

 7fff */

 7fff */

 7fff */

 00000001 BEGIN_END_ACTIVE */

 00000001 POLYGON_MODE_??? */

 000000ff GP_REG_ALLOC_TEMP / 4 rounded up */

 000000ff FP_REG_ALLOC_TEMP... without /4? */

 000000ff VP_REG_ALLOC_TEMP / 4 rounded up */

 00000001 */

 00000001 */

 00000001 VTX_ATTR_MASK_UNK0 nonempty */

 00000001 VTX_ATTR_MASK_UNK1 nonempty */

 0003ffff GP_VERTEX_OUTPUT_COUNT*GP_REG_ALLOC_RESULT */

 00000001 */

 00000001 */

 000000ff */

 000000ff */

 000000ff */

 00000001 */

 00000001 */

 000000ff */

 000000ff */

 000000ff */

 00000001 */

 000000ff */

 000000ff */

 000000ff */

 00000001 */

 00000001 */

 000000ff */

 000000ff */

 000000ff */

 0000003f UNK114C.COMP,SIZE */

 eng2d state */

 00000001 eng2d COLOR_KEY_ENABLE */

 00000007 eng2d COLOR_KEY_FORMAT */

 ffffffff eng2d DST_DEPTH */

 000000ff eng2d DST_FORMAT */

 ffffffff eng2d DST_LAYER */

 00000001 eng2d DST_LINEAR */

 00000007 eng2d PATTERN_COLOR_FORMAT */

 00000007 eng2d OPERATION */

 00000003 eng2d PATTERN_SELECT */

 000000ff eng2d SIFC_FORMAT */

 00000001 eng2d SIFC_BITMAP_ENABLE */

 00000003 eng2d SIFC_BITMAP_UNK808 */

 ffffffff eng2d BLIT_DU_DX_FRACT */

 ffffffff eng2d BLIT_DU_DX_INT */

 ffffffff eng2d BLIT_DV_DY_FRACT */

 ffffffff eng2d BLIT_DV_DY_INT */

 00000001 eng2d BLIT_CONTROL_FILTER */

 000000ff eng2d DRAW_COLOR_FORMAT */

 000000ff eng2d SRC_FORMAT */

 00000001 eng2d SRC_LINEAR #2 */

/*

 * xfer areas. These are a pain.

 *

 * There are 2 xfer areas: the first one is big and contains all sorts of

 * stuff, the second is small and contains some per-TP context.

 *

 * Each area is split into 8 "strands". The areas, when saved to grctx,

 * are made of 8-word blocks. Each block contains a single word from

 * each strand. The strands are independent of each other, their

 * addresses are unrelated to each other, and data in them is closely

 * packed together. The strand layout varies a bit between cards: here

 * and there, a single word is thrown out in the middle and the whole

 * strand is offset by a bit from corresponding one on another chipset.

 * For this reason, addresses of stuff in strands are almost useless.

 * Knowing sequence of stuff and size of gaps between them is much more

 * useful, and that's how we build the strands in our generator.

 *

 * NVA0 takes this mess to a whole new level by cutting the old strands

 * into a few dozen pieces [known as genes], rearranging them randomly,

 * and putting them back together to make new strands. Hopefully these

 * genes correspond more or less directly to the same PGRAPH subunits

 * as in 400040 register.

 *

 * The most common value in default context is 0, and when the genes

 * are separated by 0's, gene bounduaries are quite speculative...

 * some of them can be clearly deduced, others can be guessed, and yet

 * others won't be resolved without figuring out the real meaning of

 * given ctxval. For the same reason, ending point of each strand

 * is unknown. Except for strand 0, which is the longest strand and

 * its end corresponds to end of the whole xfer.

 *

 * An unsolved mystery is the seek instruction: it takes an argument

 * in bits 8-18, and that argument is clearly the place in strands to

 * seek to... but the offsets don't seem to correspond to offsets as

 * seen in grctx. Perhaps there's another, real, not randomly-changing

 * addressing in strands, and the xfer insn just happens to skip over

 * the unused bits? NV10-NV30 PIPE comes to mind...

 *

 * As far as I know, there's no way to access the xfer areas directly

 * without the help of ctxprog.

 Gene declarations... */

 Strand 0 */

 Strand 1 */

 Strand 2 */

 Strand 3: per-ROP group state */

 Strands 4-7: per-TP state */

 Strand 0 */

 Strand 1 */

 Strand 2 */

 Strand 3 */

 Strand 4 */

 Strand 5 */

 per-ROP context */

 Strand 6 */

 Strand 7 */

/*

 * non-trivial demagiced parts of ctx init go here

 start of strand 0 */

 SEEK */

 SEEK */

 the PGRAPH's internal FIFO */

 and another bonus slot?!? */

 and YET ANOTHER bonus slot? */

 SEEK */

 CTX_SWITCH: caches of gr objects bound to subchannels. 8 values, last used index */

 SEEK */

 SEEK */

 SEEK */

 SEEK */

 SEEK */

 SEEK */

 SEEK */

 SEEK */

 SEEK */

 SEEK */

 Strand 0, right after dispatch */

 SEEK */

 DMA_NOTIFY instance >> 4 */

 DMA_BUFFER_IN instance >> 4 */

 DMA_BUFFER_OUT instance >> 4 */

 OFFSET_IN */

 OFFSET_OUT */

 PITCH_IN */

 PITCH_OUT */

 LINE_LENGTH */

 LINE_COUNT */

 FORMAT: bits 0-4 INPUT_INC, bits 5-9 OUTPUT_INC */

 LINEAR_IN */

 TILING_MODE_IN: bits 0-2 y tiling, bits 3-5 z tiling */

 TILING_PITCH_IN */

 TILING_HEIGHT_IN */

 TILING_DEPTH_IN */

 TILING_POSITION_IN_Z */

 TILING_POSITION_IN */

 LINEAR_OUT */

 TILING_MODE_OUT: bits 0-2 y tiling, bits 3-5 z tiling */

 TILING_PITCH_OUT */

 TILING_HEIGHT_OUT */

 TILING_DEPTH_OUT */

 TILING_POSITION_OUT_Z */

 TILING_POSITION_OUT */

 OFFSET_IN_HIGH */

 OFFSET_OUT_HIGH */

 SEEK */

 20 * ffffffff, 3ffff */

 80 * ffffffff, 3ffff */

 1f/7f, 0, 1f/7f, 0 [1f for smallm2mf, 7f otherwise] */

 SEEK */

 ffffffff */

 ffffffff */

 ff/1ff, 0, 0, 0 [ff for smallm2mf, 1ff otherwise] */

 SEEK */

 20 * bits ffffffff, 3ffff */

 1f, 0, 1f, 0, 1f, 0 */

 RO */

 ffffffff */

	/* CB bindings, 0x80 of them. first word is address >> 8, second is

 ffffffff CB_DEF */

 0000007f CB_ADDR_BUFFER */

 0 */

 ff SET_PROGRAM_CB */

 3f last SET_PROGRAM_CB */

 RO */

 ffffffff */

 1f, 0, 0, ... */

 ffffffff */

 ffffffff */

 3 */

 ffffffff */

 0000ffff DMA_CODE_CB */

 0000ffff DMA_TIC */

 0000ffff DMA_TSC */

 00000001 LINKED_TSC */

 000000ff TIC_ADDRESS_HIGH */

 ffffffff TIC_ADDRESS_LOW */

 003fffff TIC_LIMIT */

 000000ff TSC_ADDRESS_HIGH */

 ffffffff TSC_ADDRESS_LOW */

 000fffff TSC_LIMIT */

 000000ff VP_ADDRESS_HIGH */

 ffffffff VP_ADDRESS_LOW */

 00ffffff VP_START_ID */

 000000ff CB_DEF_ADDRESS_HIGH */

 ffffffff CB_DEF_ADDRESS_LOW */

 00000001 GP_ENABLE */

 000000ff GP_ADDRESS_HIGH */

 ffffffff GP_ADDRESS_LOW */

 00ffffff GP_START_ID */

 000000ff FP_ADDRESS_HIGH */

 ffffffff FP_ADDRESS_LOW */

 00ffffff FP_START_ID */

 end of area 2 on pre-NVA0, area 1 on NVAx */

 000000ff GP_RESULT_MAP_SIZE */

 0000007f VP_RESULT_MAP_SIZE */

 00000001 GP_ENABLE */

 0000ffff GP_VERTEX_OUTPUT_COUNT */

 000000ff GP_REG_ALLOC_RESULT */

 01ffffff SEMANTIC_COLOR */

 00000001 VERTEX_TWO_SIDE_ENABLE */

 000007ff */

 111/113 */

 ffffffff tesla UNK1A30 */

 ffffffff */

 ffffffff */

 ffffffff */

 3f, 0, 0, 0 */

 ffffffff */

 000000ff GP_RESULT_MAP_SIZE */

 0000007f VP_RESULT_MAP_SIZE */

 00000001 GP_ENABLE */

 0000ffff GP_VERTEX_OUTPUT_COUNT */

 000000ff GP_REG_ALLOC_TEMP */

 00000001 RASTERIZE_ENABLE */

 00000001 tesla UNK1900 */

 000000ff UNK0FD4 */

 0001ffff GP_BUILTIN_RESULT_EN */

 000000ff SEMANTIC_LAYER */

 ffffffff tesla UNK1A30 */

 end of area 2 on pre-NVA0, area 1 on NVAx */

 00000001 VIEWPORT_CLIP_RECTS_EN */

 00000003 VIEWPORT_CLIP_MODE */

 07ffffff VIEWPORT_CLIP_HORIZ*8, VIEWPORT_CLIP_VERT*8 */

 00000001 POLYGON_STIPPLE_ENABLE */

 ffffffff POLYGON_STIPPLE */

 00007fff WINDOW_OFFSET_XY */

 ffff0ff3 */

 ffffffff UNK0D64 */

 ffffffff UNK0DF4 */

 00000003 WINDOW_ORIGIN */

 00000007 */

 0001ffff tesla UNK0FAC */

 middle of area 2 on pre-NVA0, beginning of area 2 on NVA0, area 7 on >NVA0 */

 ffffffff */

 01ffffff SEMANTIC_COLOR */

 00000001 */

 000003ff */

 00000fff SEMANTIC_CLIP */

 00000001 */

 7f, ff */

 1fffffff FP_INTERPOLANT_CTRL */

 ffffffff tesla UNK1A30 */

 0000007f VP_RESULT_MAP_SIZE */

 000000ff GP_RESULT_MAP_SIZE */

 00000001 GP_ENABLE */

 7f/ff VIEW_VOLUME_CLIP_CTRL */

 000000ff VP_CLIP_DISTANCE_ENABLE */

 3ff */

 000000ff tesla UNK1940 */

 00000001 tesla UNK0D7C */

 00000fff SEMANTIC_CLIP */

 00000001 VIEWPORT_TRANSFORM_EN */

 0000001f POLYGON_MODE */

 000000ff tesla UNK0FFC */

 ffffffff tesla UNK1A30 */

 00000001 SHADE_MODEL */

 01ffffff SEMANTIC_COLOR */

 00000001 tesla UNK1900 */

 1fffffff FP_INTERPOLANT_CTRL */

 0000007f VP_RESULT_MAP_SIZE */

 000000ff GP_RESULT_MAP_SIZE */

 00000001 GP_ENABLE */

 7f/ff VIEW_VOLUME_CLIP_CTRL */

 00000001 tesla UNK0D7C */

 00000001 tesla UNK0F8C */

 ffffffff tesla UNK1A30 */

 00000001 VIEWPORT_TRANSFORM_EN */

 1fffffff FP_INTERPOLANT_CTRL */

 ffffffff NOPERSPECTIVE_BITMAP */

 00000001 tesla UNK1900 */

 0000000f */

 000003ff tesla UNK0D68 */

 000007ff tesla UNK0D68 */

 01ffffff SEMANTIC_COLOR */

 00000001 VERTEX_TWO_SIDE_ENABLE */

 ffffffff VIEWPORT_SCALE: X0, Y0, Z0, X1, Y1, ... */

 f, 0, 0 */

 ffffffff last VIEWPORT_SCALE? */

 ffffffff tesla UNK1A30 */

 00000001 VIEWPORT_TRANSFORM_EN */

 00000001 tesla UNK1900 */

 00000001 tesla UNK1924 */

 000000ff VIEW_VOLUME_CLIP_CTRL */

 00000001 */

 ffffffff VIEWPORT_TRANSLATE */

 f, 0, 0 */

 ffffffff */

 ffffffff tesla UNK1A30 */

 000001ff tesla UNK19D8 */

 00000001 tesla UNK1924 */

 ffffffff tesla UNK1A30 */

 0000000f CULL_MODE */

 07ffffff SCREEN_SCISSOR */

 00007fff WINDOW_OFFSET_XY */

 00000003 WINDOW_ORIGIN */

 00000001 SCISSOR_ENABLE */

 0001ffff GP_BUILTIN_RESULT_EN */

 000000ff SEMANTIC_LAYER */

 00000001 tesla UNK1900 */

 0000000f */

 ffffffff LINE_WIDTH */

 00000001 LINE_STIPPLE_ENABLE */

 00000001 LINE_SMOOTH_ENABLE */

 00000007 MULTISAMPLE_SAMPLES_LOG2 */

 00000001 */

 0000001f POLYGON_MODE */

 000000ff VIEW_VOLUME_CLIP_CTRL */

 ffffffff */

 00000001 */

 000003ff */

 10xbits ffffffff, 3fffff. SCISSOR_* */

 f */

 0? */

 ffffffff */

 003fffff */

 ffffffff tesla UNK1A30 */

 000001ff SEMANTIC_PTSZ */

 0001ffff GP_BUILTIN_RESULT_EN */

 000000ff SEMANTIC_LAYER */

 00000001 tesla UNK1900 */

 0000007f VP_RESULT_MAP_SIZE */

 000000ff GP_RESULT_MAP_SIZE */

 00000001 GP_ENABLE */

 0000001f POLYGON_MODE */

 00000001 LINE_SMOOTH_ENABLE */

 00000001 LINE_STIPPLE_ENABLE */

 00ffffff LINE_STIPPLE_PATTERN */

 0000000f */

 end of strand 0 on pre-NVA0, beginning of strand 6 on NVAx */

 SEEK */

 0000003f UNK1590 */

 00000001 ALPHA_TEST_ENABLE */

 00000007 MULTISAMPLE_SAMPLES_LOG2 */

 00000001 tesla UNK1534 */

 00000007 STENCIL_BACK_FUNC_FUNC */

 000000ff STENCIL_BACK_FUNC_MASK */

 000000ff STENCIL_BACK_FUNC_REF */

 000000ff STENCIL_BACK_MASK */

 00000007 STENCIL_BACK_OP_FAIL, ZFAIL, ZPASS */

 00000003 tesla UNK143C */

 07ffffff tesla UNK0D6C */

 ffff0ff3 */

 00000001 CLIPID_ENABLE */

 ffffffff DEPTH_BOUNDS */

 00000001 */

 00000007 DEPTH_TEST_FUNC */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 0000000f CULL_MODE */

 0000ffff */

 00000001 UNK0FB0 */

 00000001 POLYGON_STIPPLE_ENABLE */

 00000007 FP_CONTROL */

 ffffffff */

 0001ffff GP_BUILTIN_RESULT_EN */

 000000ff CLEAR_STENCIL */

 00000007 STENCIL_FRONT_FUNC_FUNC */

 000000ff STENCIL_FRONT_FUNC_MASK */

 000000ff STENCIL_FRONT_FUNC_REF */

 000000ff STENCIL_FRONT_MASK */

 00000007 STENCIL_FRONT_OP_FAIL, ZFAIL, ZPASS */

 00000001 STENCIL_FRONT_ENABLE */

 00000001 STENCIL_BACK_ENABLE */

 ffffffff CLEAR_DEPTH */

 00000007 */

 00000003 tesla UNK1108 */

 00000001 SAMPLECNT_ENABLE */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 00001fff ZETA_ARRAY_MODE */

 SEEK */

 0000ffff MSAA_MASK */

 00000001 SCISSOR_ENABLE */

 ffffffff DEPTH_RANGE_NEAR */

 ffffffff DEPTH_RANGE_FAR */

 7f/ff/3ff VIEW_VOLUME_CLIP_CTRL */

 00000001 VIEWPORT_CLIP_RECTS_EN */

 00000003 FP_CTRL_UNK196C */

 00000003 tesla UNK1968 */

 0fffffff tesla UNK1104 */

 00000001 tesla UNK151C */

 middle of strand 0 on pre-NVA0 [after 24xx], middle of area 6 on NVAx */

 SEEK */

 00000007 UNK0FB4 */

 SEEK */

 07ffffff CLIPID_REGION_HORIZ */

 07ffffff CLIPID_REGION_VERT */

 07ffffff SCREEN_SCISSOR */

 07ffffff UNK1508 */

 00000001 CLIPID_ENABLE */

 00003fff CLIPID_WIDTH */

 000000ff CLIPID_ID */

 000000ff CLIPID_ADDRESS_HIGH */

 ffffffff CLIPID_ADDRESS_LOW */

 00003fff CLIPID_HEIGHT */

 0000ffff DMA_CLIPID */

 middle of strand 0 on pre-NVA0 [after m2mf], end of strand 2 on NVAx */

 SEEK */

 SEEK */

 SEEK */

 00000001 GP_ENABLE */

 0000007f VP_RESULT_MAP_SIZE */

 000000ff GP_RESULT_MAP_SIZE */

 SEEK */

 RO */

 190 * 9: 8*ffffffff, 7ff */

 1ff */

 0? */

 ffffffff, 7ff */

 RO */

 190 * 9: 8*ffffffff, 7ff */

 1ff */

 0? */

 ffffffff, 7ff */

 RO */

 SEEK */

 190 * 9: 8*ffffffff, 7ff */

 1ff */

 0? */

 SEEK */

 RO */

 SEEK */

 190 * 9: 8*ffffffff, 7ff */

 1ff */

 0? */

 SEEK */

 00000001 GP_ENABLE */

 000000ff GP_RESULT_MAP_SIZE */

 0000007f VP_RESULT_MAP_SIZE */

 1fffffff FP_INTERPOLANT_CTRL */

 00000003 tesla UNK1100 */

 SEEK */

 00000001 GP_ENABLE */

 1fffffff FP_INTERPOLANT_CTRL */

 0000000f VP_GP_BUILTIN_ATTR_EN */

 01ffffff SEMANTIC_COLOR */

 00000001 */

 SEEK */

 000000ff */

 01ffffff SEMANTIC_COLOR */

 00000001 VERTEX_TWO_SIDE_ENABLE */

 00000001 POINT_SPRITE_ENABLE */

 1fffffff FP_INTERPOLANT_CTRL */

 000000ff SEMANTIC_PRIM_ID */

 00000001 GP_ENABLE */

 0000000f */

 00000001 */

 SEEK */

 ffffffff */

 3, 0, 0.... */

 ffffffff */

 SEEK */

 00000001 POINT_SPRITE_CTRL */

 00000001 */

 ffffffff */

 ffffffff NOPERSPECTIVE_BITMAP */

 00ffffff POINT_COORD_REPLACE_MAP */

 00000003 WINDOW_ORIGIN */

 1fffffff FP_INTERPOLANT_CTRL */

 000003ff */

 beginning of strand 1 on pre-NVA0, strand 3 on NVAx */

 SEEK */

 ffffffff tesla UNK13A4 */

 00000fff tesla UNK1318 */

 ffffffff VERTEX_BUFFER_FIRST */

 00000001 PRIMITIVE_RESTART_ENABLE */

 00000001 UNK0DE8 */

 ffffffff PRIMITIVE_RESTART_INDEX */

 ffffffff VP_ATTR_EN */

 ffffffff VP_ATTR_EN */

 ffffffff VTX_ATR_MASK_UNK0DD0 */

 0000000f VP_GP_BUILTIN_ATTR_EN */

 0000ffff tesla UNK129C */

 000000ff turing UNK370??? */

 0000ffff turing USER_PARAM_COUNT */

 ffffffff tesla UNK1A30 */

 SEEK */

 RO */

 RO */

 RO */

 SEEK */

 00000001 EDGE_FLAG */

 00000001 PROVOKING_VERTEX_LAST */

 00000001 GP_ENABLE */

 0000001f POLYGON_MODE */

 SEEK */

 RO */

 SEEK */

 7f/ff */

 7f/ff VP_REG_ALLOC_RESULT */

 7f/ff VP_RESULT_MAP_SIZE */

 0000000f VP_GP_BUILTIN_ATTR_EN */

 000001ff UNK1A28 */

 000001ff UNK0DF0 */

 00000001 GP_ENABLE */

 3ff tesla UNK0D68 */

 7ff tesla UNK0D68 */

 7fff */

 SEEK */

 RO or close */

 SEEK */

 ffffffff VP_ATTR_EN */

 ffffffff VP_ATTR_EN */

 0000000f VP_GP_BUILTIN_ATTR_EN */

 ffffffff */

 ffffffff */

 00000003 tesla UNK0FD8 */

 SEEK */

 0? */

 weird... */

 RO */

 0? */

 weird... */

 RO */

 SEEK */

 ffffffff VB_ELEMENT_BASE */

 ffffffff UNK1438 */

 1 tesla UNK1000 */

 ffffffff tesla UNK1118? */

 SEEK */

 ffffffff VERTEX_ARRAY_UNK90C */

 f/1f */

 SEEK */

 ffffffff VERTEX_ARRAY_UNK90C */

 f/1f */

 SEEK */

 RO */

 RO */

 SEEK */

 ffffffff tesla UNK111C? */

 RO */

 SEEK */

 000000ff UNK15F4_ADDRESS_HIGH */

 ffffffff UNK15F4_ADDRESS_LOW */

 000000ff UNK0F84_ADDRESS_HIGH */

 ffffffff UNK0F84_ADDRESS_LOW */

 SEEK */

 00003fff VERTEX_ARRAY_ATTRIB_OFFSET */

 f/1f */

 SEEK */

 00000fff VERTEX_ARRAY_STRIDE */

 f/1f */

 SEEK */

 ffffffff VERTEX_ARRAY_LOW */

 f/1f */

 SEEK */

 000000ff VERTEX_ARRAY_HIGH */

 f/1f */

 SEEK */

 ffffffff VERTEX_LIMIT_LOW */

 f/1f */

 SEEK */

 000000ff VERTEX_LIMIT_HIGH */

 f/1f */

 SEEK */

 f */

 f/1f */

 SEEK */

 RO */

 RO */

 SEEK */

 ffff DMA_VTXBUF */

 SEEK */

 RO */

 SEEK */

 RO */

 RO */

 RO */

 SEEK */

 ffffffff VP_ATTR_EN */

 ffffffff VP_ATTR_EN */

 1 UNK0DEC */

 SEEK */

 ffffffff VTX_ATTR */

 f/1f, 0, 0, 0 */

 SEEK */

 RO */

 RO */

 SEEK */

 ffffffff VP_ATTR_EN */

 ffffffff VP_ATTR_EN */

 SEEK */

 RO */

 RO */

 RO */

 SEEK */

 RO */

 SEEK */

 ffffffff */

 ffffffff */

 7f/ff, 0, 0, 0 */

 ffffffff */

 SEEK */

 113/111 */

 ffffffff VP_ATTR_EN */

 ffffffff VP_ATTR_EN */

 ffffffff VTX_ATTR_MASK_UNK0DD0 */

 0000000f VP_GP_BUILTIN_ATTR_EN */

 ffffffff tesla UNK1A30 */

 SEEK */

 weird... */

 weird... */

 middle of strand 1 on pre-NVA0 [after vfetch], middle of strand 6 on NVAx */

 SEEK */

 0001ffff CLIP_X, CLIP_Y */

 0000ffff CLIP_W, CLIP_H */

 00000001 CLIP_ENABLE */

		/* this is useless on everything but the original NV50,

 0000ffff IFC_CLIP_X, Y */

 0000ffff IFC_CLIP_W, H */

 00000001 IFC_CLIP_ENABLE */

 00000001 DST_LINEAR */

 0001ffff DST_WIDTH */

 0001ffff DST_HEIGHT */

 3f[NV50]/7f[NV84+] DST_FORMAT */

 0001ffff DRAW_POINT_X */

 0000000f DRAW_UNK58C */

 000fffff SIFC_DST_X_FRACT */

 0001ffff SIFC_DST_X_INT */

 000fffff SIFC_DST_Y_FRACT */

 0001ffff SIFC_DST_Y_INT */

 000fffff SIFC_DX_DU_FRACT */

 0001ffff SIFC_DX_DU_INT */

 000fffff SIFC_DY_DV_FRACT */

 0001ffff SIFC_DY_DV_INT */

 0000ffff SIFC_WIDTH */

 0000ffff SIFC_HEIGHT */

 000000ff SIFC_FORMAT */

 00000003 SIFC_BITMAP_UNK808 */

 00000003 SIFC_BITMAP_LINE_PACK_MODE */

 00000001 SIFC_BITMAP_LSB_FIRST */

 00000001 SIFC_BITMAP_ENABLE */

 0000ffff BLIT_DST_X */

 0000ffff BLIT_DST_Y */

 000fffff BLIT_DU_DX_FRACT */

 0001ffff BLIT_DU_DX_INT */

 000fffff BLIT_DV_DY_FRACT */

 0001ffff BLIT_DV_DY_INT */

 0000ffff BLIT_DST_W */

 0000ffff BLIT_DST_H */

 000fffff BLIT_SRC_X_FRACT */

 0001ffff BLIT_SRC_X_INT */

 000fffff BLIT_SRC_Y_FRACT */

 00000001 UNK888 */

 0000003f UNK884 */

 00000007 UNK880 */

 0000001f tesla UNK0FB8 */

 000000ff tesla UNK128C */

 00000007, ffff0ff3 */

 00000001 UNK260 */

 1fffffff UNK870 */

 SEEK */

 SEEK */

 middle of strand 1 on pre-NVA0 [after eng2d], middle of strand 0 on NVAx */

 SEEK */

 00007fff WINDOW_OFFSET_XY... what is it doing here??? */

 00000001 tesla UNK1924 */

 00000003 WINDOW_ORIGIN */

 1fffffff FP_INTERPOLANT_CTRL */

 000003ff */

 SEEK */

 ffffffff turing UNK364 */

 0000000f turing UNK36C */

 0000ffff USER_PARAM_COUNT */

 00ffffff turing UNK384 */

 0000000f turing UNK2A0 */

 0000ffff GRIDID */

 ffffffff GRIDDIM_XY */

 ffffffff */

 ffffffff BLOCKDIM_XY */

 0000ffff BLOCKDIM_Z */

 00ffffff BLOCK_ALLOC */

 00000001 LANES32 */

 000000ff FP_REG_ALLOC_TEMP */

 00000003 REG_MODE */

 SEEK */

 ffffffff USER_PARAM */

 7, 0, 0, 0, ... */

 fff */

 ff, fff */

 ffffffff, 1f */

 7, 0, 0, 0, ... */

 fff */

 ff, fff */

 ffffffff, 1f */

 7, 0, 0, 0, ... */

 fff */

 ff, fff */

 ffffffff, 1f */

 f, 0, 0, 0 */

 fff */

 ff, fff */

 ffffffff, 1f */

 7, 0, 0, 0, ... */

 fff */

 ff, fff */

 ffffffff, 1f */

 7, 0, 0, 0, ... */

 fff */

 ff, fff */

 ffffffff, 1f */

 7, 0, 0, 0, ... */

 fff */

 ff, fff */

 ffffffff, 1f */

 f, 0, 0, 0 */

 fff */

 ff, fff */

 ffffffff, 1f */

 0000000f */

 00000000 */

 ffffffff */

 0000001f */

 ffffffff */

 00000003 turing UNK35C */

 ffffffff */

 ffffffff */

 00000003 turing UNK35C */

 ffffffff */

 000000ff */

 00007fff WINDOW_OFFSET_XY */

 ffffffff LINE_WIDTH */

 00000001 LINE_SMOOTH_ENABLE */

 00000001 tesla UNK1658 */

 00000001 POLYGON_SMOOTH_ENABLE */

 00000001 POLYGON_OFFSET_*_ENABLE */

 0000000f CULL_MODE */

 0000001f POLYGON_MODE */

 0000000f ZETA_FORMAT */

 00000001 POINT_SPRITE_ENABLE */

 00000001 tesla UNK165C */

 00000001 SCISSOR_ENABLE */

 00000001 tesla UNK1534 */

 00000001 LINE_STIPPLE_ENABLE */

 00ffffff LINE_STIPPLE_PATTERN */

 ffffffff POLYGON_OFFSET_UNITS */

 ffffffff POLYGON_OFFSET_FACTOR */

 00000003 tesla UNK1668 */

 07ffffff SCREEN_SCISSOR */

 00000001 tesla UNK1900 */

 0000000f COLOR_MASK */

 0000000f COLOR_MASK */

 0fffffff RT_CONTROL */

 0000007f RT_FORMAT */

 0000007f RT_FORMAT */

 00000001 RT_HORIZ_LINEAR */

 00000007 FP_CONTROL */

 00000001 ALPHA_TEST_ENABLE */

 00000007 ALPHA_TEST_FUNC */

 00000003 UNK16B4 */

 00000001 UNK16B4 */

 00000003 MULTISAMPLE_CTRL */

 00000003 tesla UNK0F90 */

 00000003 tesla UNK143C */

 07ffffff tesla UNK0D6C */

 000000ff STENCIL_FRONT_MASK */

 00000001 DEPTH_WRITE_ENABLE */

 00000001 SAMPLECNT_ENABLE */

 0000000f UNK1408 */

 000001ff SEMANTIC_PTSZ */

 ffffffff POINT_SIZE */

 00000001 */

 00000007 tesla UNK0FB4 */

 3ff */

 00000001 tesla UNK1110 */

 00000003 tesla UNK1928 */

 ffffffff DEPTH_RANGE_NEAR */

 ffffffff DEPTH_RANGE_FAR */

 000000ff VIEW_VOLUME_CLIP_CTRL */

 07ffffff VIEWPORT_HORIZ, then VIEWPORT_VERT. (W&0x3fff)<<13 | (X&0x1fff). */

 ffffffff tesla UNK187C */

 00000003 WINDOW_ORIGIN */

 00000001 STENCIL_FRONT_ENABLE */

 00000001 DEPTH_TEST_ENABLE */

 00000001 STENCIL_BACK_ENABLE */

 000000ff STENCIL_BACK_MASK */

 1fffffff FP_INTERPOLANT_CTRL */

 0000000f tesla UNK1220 */

 00000007 MULTISAMPLE_SAMPLES_LOG2 */

 000000ff tesla UNK1A20 */

 00000001 ZETA_ENABLE */

 00000001 VERTEX_TWO_SIDE_ENABLE */

 0000ffff MSAA_MASK */

 00000003 tesla UNK1100 */

 RO */

 00000001 UNK1534 */

 00000001 LINE_SMOOTH_ENABLE */

 00000001 LINE_STIPPLE_ENABLE */

 00ffffff LINE_STIPPLE_PATTERN */

 0000001f POLYGON_MODE */

 00000003 WINDOW_ORIGIN */

 00000003 tesla UNK1100 */

 3ff */

	/* XXX: the following block could belong either to unk1cxx, or

 0000ffff STRMOUT_BUFFER_CTRL */

 ffffffff STRMOUT_PRIMITIVE_COUNT */

 000000ff STRMOUT_NUM_ATTRIBS */

 ffffffff UNK1A8C */

 ffffffff UNK1780 */

 000000ff GP_RESULT_MAP_SIZE */

 0000007f VP_RESULT_MAP_SIZE */

 00000001 GP_ENABLE */

 000003ff tesla UNK0D68 */

 000007ff tesla UNK0D68 */

 ffffffff tesla UNK1A30 */

 SEEK */

 0000ffff STRMOUT_BUFFER_CTRL */

 ffffffff STRMOUT_PRIMITIVE_COUNT */

 000000ff STRMOUT_ADDRESS_HIGH */

 ffffffff STRMOUT_ADDRESS_LOW */

 000000ff STRMOUT_NUM_ATTRIBS */

 ffffffff UNK1A8C */

 ffffffff UNK1780 */

 0000ffff DMA_STRMOUT */

 0000ffff DMA_QUERY */

 000000ff QUERY_ADDRESS_HIGH */

 ffffffff QUERY_ADDRESS_LOW QUERY_COUNTER */

 ffffffff */

 ffffffff tesla UNK1A30 */

 SEEK */

 ffffffff STRMOUT_MAP */

 0000000f */

 00000000? */

 ffffffff */

 ffffffff UNK0D64 */

 ffffffff UNK0DF4 */

 00000007 */

 000003ff */

 000000ff tesla UNK1968 */

 ffffffff tesla UNK1A3C */

 SEEK */

 0000ffff DMA_QUERY */

 0fffffff RT_CONTROL */

 ffffffff */

 000000ff QUERY_ADDRESS_HIGH */

 ffffffff QUERY_ADDRESS_LOW, COUNTER */

 00000001 SAMPLECNT_ENABLE */

 7 */

 SEEK */

 0000ffff DMA_QUERY */

 000000ff QUERY_ADDRESS_HIGH */

 ffffffff QUERY_ADDRESS_LOW, COUNTER */

 ffffffff UNK0D64 */

 ffffffff UNK0DF4 */

 00000001 eng2d UNK260 */

 ff/3ff */

 00000007 */

 000000ff tesla UNK1968 */

 ffffffff tesla UNK1A3C */

 f/7 MUTISAMPLE_SAMPLES_LOG2 */

 00000001 tesla UNK1534 */

 00000007 STENCIL_BACK_FUNC_FUNC */

 000000ff STENCIL_BACK_FUNC_MASK */

 000000ff STENCIL_BACK_MASK */

 00000007 STENCIL_BACK_OP_FAIL, ZFAIL, ZPASS */

 00000003 tesla UNK143C */

 ffff0ff3 */

 001fffff tesla UNK0F78 */

 00000001 DEPTH_BOUNDS_EN */

 00000007 DEPTH_TEST_FUNC */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 0000001f tesla UNK169C */

 00000007 STENCIL_FRONT_FUNC_FUNC */

 000000ff STENCIL_FRONT_FUNC_MASK */

 000000ff STENCIL_FRONT_MASK */

 00000007 STENCIL_FRONT_OP_FAIL, ZFAIL, ZPASS */

 00000001 STENCIL_FRONT_ENABLE */

 000000ff */

 00000001 STENCIL_BACK_ENABLE */

 00000001 tesla UNK15B4 */

 3ff/ff VIEW_VOLUME_CLIP_CTRL */

 ffffffff CLEAR_DEPTH */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 ffffffff tesla UNK1A3C */

 ff, ffffffff, ffffffff */

 7 */

 fffffff */

 ffff */

 1fff */

 0000000f UNK15C8 */

 ff */

 00000007 MULTISAMPLE_SAMPLES_LOG2 */

 00000001 tesla UNK1534 */

 00000007 STENCIL_BACK_FUNC_FUNC */

 000000ff STENCIL_BACK_FUNC_MASK */

 ffff0ff3 */

 00000003 tesla UNK143C */

 00000001 DEPTH_BOUNDS_EN */

 00000007 DEPTH_TEST_FUNC */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 00000007 STENCIL_FRONT_FUNC_FUNC */

 000000ff STENCIL_FRONT_FUNC_MASK */

 00000001 STENCIL_FRONT_ENABLE */

 00000001 STENCIL_BACK_ENABLE */

 00000001 tesla UNK15B4 */

 7f/ff VIEW_VOLUME_CLIP_CTRL */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 ffffffff tesla UNK1A3C */

 00000001 tesla UNK1534 */

 00000001 tesla UNK1900 */

 00000007 STENCIL_BACK_FUNC_FUNC */

 000000ff STENCIL_BACK_FUNC_MASK */

 000000ff STENCIL_BACK_FUNC_REF */

 ffffffff DEPTH_BOUNDS */

 00000001 DEPTH_BOUNDS_EN */

 00000007 DEPTH_TEST_FUNC */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 0000000f */

 00000001 tesla UNK0FB0 */

 00000007 STENCIL_FRONT_FUNC_FUNC */

 000000ff STENCIL_FRONT_FUNC_MASK */

 000000ff STENCIL_FRONT_FUNC_REF */

 00000001 STENCIL_FRONT_ENABLE */

 00000001 STENCIL_BACK_ENABLE */

 7f/ff VIEW_VOLUME_CLIP_CTRL */

 ffffffff DEPTH_RANGE_NEAR */

 ffffffff DEPTH_RANGE_FAR */

 0000000f ZETA_FORMAT */

 00000007 MULTISAMPLE_SAMPLES_LOG2 */

 00000007 STENCIL_BACK_FUNC_FUNC */

 000000ff STENCIL_BACK_FUNC_MASK */

 000000ff STENCIL_BACK_FUNC_REF */

 000000ff STENCIL_BACK_MASK */

 00000007 STENCIL_BACK_OP_FAIL, ZFAIL, ZPASS */

 ffffffff DEPTH_BOUNDS */

 00000001 DEPTH_BOUNDS_EN */

 00000007 DEPTH_TEST_FUNC */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 000000ff CLEAR_STENCIL */

 00000007 STENCIL_FRONT_FUNC_FUNC */

 000000ff STENCIL_FRONT_FUNC_MASK */

 000000ff STENCIL_FRONT_FUNC_REF */

 000000ff STENCIL_FRONT_MASK */

 00000007 STENCIL_FRONT_OP_FAIL, ZFAIL, ZPASS */

 00000001 STENCIL_FRONT_ENABLE */

 00000001 STENCIL_BACK_ENABLE */

 7f/ff VIEW_VOLUME_CLIP_CTRL */

 0000000f ZETA_FORMAT */

 0000003f UNK1590 */

 00000007 MULTISAMPLE_SAMPLES_LOG2 */

 00000001 tesla UNK1534 */

 ffff0ff3, ffff */

 00000001 tesla UNK0FB0 */

 0001ffff GP_BUILTIN_RESULT_EN */

 00000001 tesla UNK15B4 */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 ffffffff CLEAR_DEPTH */

 00000001 tesla UNK19CC */

 00000007 */

 00000001 tesla UNK1534 */

 00000007 MULTISAMPLE_SAMPLES_LOG2 */

 00000001 BLEND_ENABLE */

 ffff0ff3 */

 3f/7f RT_FORMAT */

 3f/7f RT_FORMAT */

 0000000f COLOR_MASK */

 0000000f COLOR_MASK */

 3f/7f */

 00000001 LOGIC_OP_ENABLE */

 0000000f LOGIC_OP */

 000000ff */

 00000007 OPERATION */

 ff/3ff */

 00000003 UNK0F90 */

 00000007 BLEND_EQUATION_RGB, ALPHA */

 00000001 UNK133C */

 0000001f BLEND_FUNC_SRC_RGB */

 0000001f BLEND_FUNC_DST_RGB */

 0000001f BLEND_FUNC_SRC_ALPHA */

 0000001f BLEND_FUNC_DST_ALPHA */

 00000001 */

 001fffff tesla UNK0F78 */

 ffffffff tesla UNK1A3C */

 0fffffff RT_CONTROL */

 00000001 tesla UNK12E4 */

 00000007 IBLEND_EQUATION_RGB */

 00000007 IBLEND_EQUATION_ALPHA */

 00000001 IBLEND_UNK00 */

 0000001f IBLEND_FUNC_SRC_RGB */

 0000001f IBLEND_FUNC_DST_RGB */

 0000001f IBLEND_FUNC_SRC_ALPHA */

 0000001f IBLEND_FUNC_DST_ALPHA */

 00000001 tesla UNK1140 */

 00000001 */

 0000001f tesla UNK169C */

 0000000f */

 00000003 */

 ffffffff */

 00000001 */

 0000001f tesla UNK169C */

 00000001 */

 000003ff */

 00000001 */

 00000007 */

 00000003 */

 ffffffff */

 00000001 */

 00000007 MULTISAMPLE_SAMPLES_LOG2 */

 00000003 tesla UNK1430 */

 ffffffff tesla UNK1A3C */

 ffffffff CLEAR_COLOR */

 ffffffff BLEND_COLOR A R G B */

 00000fff eng2d UNK2B0 */

 00000001 */

 000003ff */

 00000001 BLEND_ENABLE */

 00000001 UNK133C */

 0000001f BLEND_FUNC_SRC_RGB */

 0000001f BLEND_FUNC_DST_RGB */

 00000007 BLEND_EQUATION_RGB */

 0000001f BLEND_FUNC_SRC_ALPHA */

 0000001f BLEND_FUNC_DST_ALPHA */

 00000007 BLEND_EQUATION_ALPHA */

 00000001 UNK19C0 */

 00000001 LOGIC_OP_ENABLE */

 0000000f LOGIC_OP */

 00000001 UNK12E4? NVA3+ only? */

 00000001 IBLEND_UNK00 */

 00000007 IBLEND_EQUATION_RGB */

 0000001f IBLEND_FUNC_SRC_RGB */

 0000001f IBLEND_FUNC_DST_RGB */

 00000007 IBLEND_EQUATION_ALPHA */

 0000001f IBLEND_FUNC_SRC_ALPHA */

 0000001f IBLEND_FUNC_DST_ALPHA */

 00000001 tesla UNK15C4 */

 00000001 */

 00000001 tesla UNK1140 */

 3f/7f DST_FORMAT */

 00000001 DST_LINEAR */

 00000007 PATTERN_COLOR_FORMAT */

 ffffffff PATTERN_MONO_COLOR */

 00000001 PATTERN_MONO_FORMAT */

 ffffffff PATTERN_MONO_BITMAP */

 00000003 PATTERN_SELECT */

 000000ff ROP */

 ffffffff BETA1 */

 ffffffff BETA4 */

 00000007 OPERATION */

 10x ffffff, ffffff, ffffff, ffffff, 3 PATTERN */

 00000001 GP_ENABLE */

 7f/ff[NVA0+] VP_REG_ALLOC_RESULT */

 00000001 GP_ENABLE */

 ffffffff tesla UNK1A30 */

 111/113[NVA0+] */

 ffffffff */

 ffffffff */

 fffffff VP_RESULT_MAP_1 up */

 f/1f[NVA3], fffffff/ffffffff[NVA0+] */

 7f/ff VP_REG_ALLOC_RESULT */

 7f/ff VP_RESULT_MAP_SIZE */

 ffffffff */

 fffffff VP_RESULT_MAP_0 */

 00000001 GP_ENABLE */

 ffffffff tesla UNK1A30 */

 111/113, 7f/ff */

 7f/ff VP_RESULT_MAP_SIZE */

 ffffffff tesla UNK1A30 */

 00000001 GP_ENABLE */

 000000ff GP_REG_ALLOC_RESULT */

 000000ff GP_RESULT_MAP_SIZE */

 0000ffff GP_VERTEX_OUTPUT_COUNT */

 00007fff tesla UNK141C */

 7f/ff VP_RESULT_MAP_SIZE */

 ffffffff tesla UNK1A30 */

 111/113 */

 ffffffff GP_RESULT_MAP_1 up */

 0000001f */

 ffffffff */

 00000001 GP_ENABLE */

 000000ff GP_REG_ALLOC_RESULT */

 0000ffff GP_VERTEX_OUTPUT_COUNT */

 000000ff GP_RESULT_MAP_SIZE */

 ffffffff GP_RESULT_MAP_0 */

 00000003 GP_OUTPUT_PRIMITIVE_TYPE */

 7fff tesla UNK141C */

 7f/ff VP_RESULT_MAP_SIZE */

 00000001 PROVOKING_VERTEX_LAST */

 ffffffff tesla UNK1A30 */

 111/113 */

 00000001 GP_ENABLE */

 000000ff GP_RESULT_MAP_SIZE */

 00000003 GP_OUTPUT_PRIMITIVE_TYPE */

 00000001 PROVOKING_VERTEX_LAST */

 ffffffff tesla UNK1A30 */

 00000003 tesla UNK13A0 */

 7f/ff VP_REG_ALLOC_RESULT */

 00000001 GP_ENABLE */

 ffffffff tesla UNK1A30 */

 111/113 */

 4 x (0x400 x 0xffffffff, ff, 0, 0, 0, 4 x ffffffff) */

 4 x (0x280 x 0xffffffff, ff, 0, 0, 0, 4 x ffffffff) */

 ffffffff */

 ffffffff */

 00000001 GP_ENABLE */

 000000ff GP_RESULT_MAP_SIZE */

 00000003 GP_OUTPUT_PRIMITIVE_TYPE */

 00000001 PROVOKING_VERTEX_LAST */

 ffffffff tesla UNK1A30 */

 00000007 ALPHA_TEST_FUNC */

 ffffffff ALPHA_TEST_REF */

 00000001 ALPHA_TEST_ENABLE */

 0000000f UNK16A0 */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 00000001 tesla UNK1534 */

 000000ff STENCIL_BACK_MASK */

 00000007 STENCIL_BACK_OP_FAIL, ZFAIL, ZPASS */

 ffffffff BLEND_COLOR */

 00000001 UNK19C0 */

 00000001 UNK0FDC */

 0000000f COLOR_MASK */

 0000000f COLOR_MASK */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 00000001 LOGIC_OP_ENABLE */

 ff[NV50]/3ff[NV84+] */

 00000007 FP_CONTROL */

 0000ffff MSAA_MASK */

 000000ff STENCIL_FRONT_MASK */

 00000007 STENCIL_FRONT_OP_FAIL, ZFAIL, ZPASS */

 00000001 STENCIL_FRONT_ENABLE */

 00000001 STENCIL_BACK_ENABLE */

 00007fff WINDOW_OFFSET_XY */

 00000001 tesla UNK19CC */

 7 */

 00000001 SAMPLECNT_ENABLE */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 ffffffff COLOR_KEY */

 00000001 COLOR_KEY_ENABLE */

 00000007 COLOR_KEY_FORMAT */

 ffffffff SIFC_BITMAP_COLOR */

 00000001 SIFC_BITMAP_WRITE_BIT0_ENABLE */

 00000007 ALPHA_TEST_FUNC */

 00000001 ALPHA_TEST_ENABLE */

 00000003 tesla UNK16B4 */

 00000003 */

 00000003 tesla UNK1298 */

 00000001 tesla UNK16B4 */

 00000003 */

 00000003 MULTISAMPLE_CTRL */

 00000001 tesla UNK1534 */

 00000001 BLEND_ENABLE */

 0000001f BLEND_FUNC_DST_ALPHA */

 00000007 BLEND_EQUATION_ALPHA */

 0000001f BLEND_FUNC_SRC_ALPHA */

 0000001f BLEND_FUNC_DST_RGB */

 00000007 BLEND_EQUATION_RGB */

 0000001f BLEND_FUNC_SRC_RGB */

 00000001 UNK12E4 */

 00000007 IBLEND_EQUATION_RGB */

 00000007 IBLEND_EQUATION_ALPHA */

 00000001 IBLEND_UNK00 */

 0000001f IBLEND_SRC_RGB */

 0000001f IBLEND_DST_RGB */

 0000001f IBLEND_SRC_ALPHA */

 0000001f IBLEND_DST_ALPHA */

 00000001 UNK1140 */

 00000001 UNK133C */

 ffff0ff3 */

 3f/7f RT_FORMAT */

 3f/7f RT_FORMAT */

 0fffffff RT_CONTROL */

 00000001 LOGIC_OP_ENABLE */

 ff/3ff */

 00000007 FP_CONTROL */

 00000003 UNK0F90 */

 00000001 FRAMEBUFFER_SRGB */

 7 */

 3f/7f DST_FORMAT */

 00000001 DST_LINEAR */

 00000007 OPERATION */

 000000ff SIFC_FORMAT */

 000000ff DRAW_COLOR_FORMAT */

 000000ff SRC_FORMAT */

 0000001f tesla UNK169C */

 ffffffff tesla UNK1A3C */

 7/f[NVA3] MULTISAMPLE_SAMPLES_LOG2 */

 00000001 BLEND_ENABLE */

 0000001f BLEND_FUNC_DST_ALPHA */

 00000007 BLEND_EQUATION_ALPHA */

 0000001f BLEND_FUNC_SRC_ALPHA */

 0000001f BLEND_FUNC_DST_RGB */

 00000007 BLEND_EQUATION_RGB */

 0000001f BLEND_FUNC_SRC_RGB */

 00000001 UNK133C */

 ffff0ff3 */

 00000001 UNK19E0 */

 3f/7f RT_FORMAT */

 3f/7f RT_FORMAT */

 0fffffff RT_CONTROL */

 0000000f COLOR_MASK */

 0000000f COLOR_MASK */

 001fffff tesla UNK0F78 */

 00000001 DEPTH_BOUNDS_EN */

 00000001 DEPTH_TEST_ENABLE */

 3f/7f DST_FORMAT */

 00000001 DST_LINEAR */

 0000001f tesla UNK169C */

 ff */

 1, 7, 3ff */

 00000007 FP_CONTROL */

 00000003 UNK0F90 */

 00000001 STENCIL_FRONT_ENABLE */

 00000007 */

 00000001 SAMPLECNT_ENABLE */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 ffffffff tesla UNK1A3C */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 00000001 tesla UNK1534 */

 ffff0ff3 */

 3f/7f RT_FORMAT */

 3f/7f RT_FORMAT */

 0fffffff RT_CONTROL */

 00000001 DEPTH_BOUNDS_EN */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 3f/7f DST_FORMAT */

 00000001 DST_LINEAR */

 000fffff BLIT_DU_DX_FRACT */

 0001ffff BLIT_DU_DX_INT */

 000fffff BLIT_DV_DY_FRACT */

 0001ffff BLIT_DV_DY_INT */

 ff/3ff */

 3ff/7ff tesla UNK0D68 */

 00000001 STENCIL_FRONT_ENABLE */

 00000001 tesla UNK15B4 */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 00000007 */

 ffffffff tesla UNK1A3C */

 0000001f tesla UNK169C */

 0000ffff DMA_COLOR */

 0000ffff DMA_GLOBAL */

 0000ffff DMA_LOCAL */

 0000ffff DMA_STACK */

 ff/3ff */

 0000ffff DMA_DST */

 7 */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 ffff0ff3 */

 000000ff RT_ADDRESS_HIGH */

 ffffffff RT_LAYER_STRIDE */

 ffffffff RT_ADDRESS_LOW */

 0000007f RT_TILE_MODE */

 3f/7f RT_FORMAT */

 3f/7f RT_FORMAT */

 0fffffff RT_CONTROL */

 0fffffff RT_HORIZ */

 0000ffff RT_VERT */

 00001fff RT_ARRAY_MODE */

 0000000f COLOR_MASK */

 0000000f COLOR_MASK */

 00000fff DST_TILE_MODE */

 3f/7f DST_FORMAT */

 0001ffff DST_HEIGHT */

 000007ff DST_LAYER */

 00000001 DST_LINEAR */

 ffffffff DST_ADDRESS_LOW */

 000000ff DST_ADDRESS_HIGH */

 0007ffff DST_PITCH */

 0001ffff DST_WIDTH */

 0000ffff */

 00000003 tesla UNK15AC */

 ff/3ff */

 0001ffff GP_BUILTIN_RESULT_EN */

 00000003 UNK0F90 */

 00000007 */

 0000001f tesla UNK169C */

 001fffff tesla UNK0F78 */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 00000001 tesla UNK1534 */

 ffff0ff3 */

 00000003 tesla UNK143C */

 0fffffff RT_CONTROL */

 0000ffff DMA_ZETA */

 00000001 DEPTH_BOUNDS_EN */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 ffff, ff/3ff */

 0001ffff GP_BUILTIN_RESULT_EN */

 00000001 STENCIL_FRONT_ENABLE */

 000000ff STENCIL_FRONT_MASK */

 00000001 tesla UNK15B4 */

 00000007 */

 ffffffff ZETA_LAYER_STRIDE */

 000000ff ZETA_ADDRESS_HIGH */

 ffffffff ZETA_ADDRESS_LOW */

 00000007 ZETA_TILE_MODE */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 0fffffff ZETA_HORIZ */

 0000ffff ZETA_VERT */

 00001fff ZETA_ARRAY_MODE */

 ffffffff tesla UNK1A3C */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 00000001 */

 ffff0ff3 */

 3f/7f RT_FORMAT */

 3f/7f RT_FORMAT */

 0fffffff RT_CONTROL */

 0000000f COLOR_MASK */

 0000000f COLOR_MASK */

 ff/3ff */

 00000001 BLEND_ENABLE */

 00000003 UNK0F90 */

 00000001 FRAMEBUFFER_SRGB */

 7 */

 00000001 LOGIC_OP_ENABLE */

 00000001 UNK1140 */

 0000001f tesla UNK169C */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 00000001 UNK1534 */

 ffff0ff3 */

 fffffff */

 001fffff tesla UNK0F78 */

 00000001 DEPTH_BOUNDS_EN */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE_ENABLE */

 3f/7f DST_FORMAT */

 00000001 tesla UNK0FB0 */

 ff/3ff */

 00000007 FP_CONTROL */

 00000001 STENCIL_FRONT_ENABLE */

 00000001 tesla UNK15B4 */

 00000001 tesla UNK19CC */

 00000007 */

 00000001 SAMPLECNT_ENABLE */

 0000000f ZETA_FORMAT */

 00000001 ZETA_ENABLE */

 0000001f tesla UNK169C */

 0000000f tesla UNK15C8 */

 ffffffff tesla UNK1A3C */

 7/f, 1, ffff0ff3 */

 fffffff */

 1, 1, 1, 3ff */

 7 */

 1 */

 1 */

 7, f */

 1 */

 7/f */

 1 */

 1 */

 ffff0ff3 */

 1 */

 7f */

 7f */

 fffffff */

 f */

 f */

 7f */

 1 */

 1, 7, 3ff, 3, 7 */

 00000001 UNK1140 */

 0000001f tesla UNK169C */

 1 LINKED_TSC. yes, 2. */

 3 */

 1ffff BLIT_DU_DX_INT */

 fffff BLIT_DU_DX_FRACT */

 1ffff BLIT_DV_DY_INT */

 fffff BLIT_DV_DY_FRACT */

 3 BLIT_CONTROL */

 3ff, 1 */

 ffffffff SRC_TIC_0 */

 ffffffff SRC_TIC_1 */

 ffffffff SRC_TIC_2 */

 ffffffff SRC_TIC_3 */

 ffffffff SRC_TIC_4 */

 ffffffff SRC_TIC_5 */

 ffffffff SRC_TIC_6 */

 ffffffff SRC_TIC_7 */

 00000001 turing UNK358 */

 ffffffff tesla UNK1A34? */

 00000003 turing UNK37C tesla UNK1690 */

 00000003 BLIT_CONTROL */

 00000001 turing UNK32C tesla UNK0F94 */

 ffffffff tesla UNK1A34? */

 00000003 */

 000003ff */

 00000003 */

 000003ff */

 00000003 tesla UNK1664 / turing UNK03E8 */

 00000003 */

 000003ff */

 ffffffff tesla UNK1A34 */

 0000ffff DMA_TEXTURE */

 0000ffff DMA_SRC */

 00000001 UNK1534 */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 7, ffff0ff3 */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE */

 ffffffff UNK0D64 */

 ffffffff UNK0DF4 */

 00000001 UNK15B4 */

 00000001 LINE_STIPPLE_ENABLE */

 00ffffff LINE_STIPPLE_PATTERN */

 00000001 tesla UNK0F98 */

 0000001f tesla UNK169C */

 00000003 tesla UNK1668 */

 00000001 LINE_STIPPLE_ENABLE */

 00ffffff LINE_STIPPLE_PATTERN */

 00000001 POLYGON_SMOOTH_ENABLE */

 00000001 UNK1534 */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 00000001 tesla UNK1658 */

 00000001 LINE_SMOOTH_ENABLE */

 ffff0ff3 */

 00000001 DEPTH_TEST_ENABLE */

 00000001 DEPTH_WRITE */

 00000001 UNK15B4 */

 00000001 POINT_SPRITE_ENABLE */

 00000001 tesla UNK165C */

 ffffffff tesla UNK1670 */

 ffffffff tesla UNK1670 */

 ffffffff tesla UNK1670 */

 ffffffff tesla UNK1670 */

 00000001 VERTEX_TWO_SIDE_ENABLE */

 0000001f POLYGON_MODE */

 ff */

 ffffffff tesla UNK1404 */

 ffffffff tesla UNK12B0 */

 ffffffff */

 00007fff tesla UNK152C */

 0000ffff tesla UNK0D60 */

 ff/3ff */

 ffffffff tesla UNK1A30 */

 7fff */

 7fff */

 000000ff VP_REG_ALLOC_TEMP */

 00000001 LINKED_TSC */

 00000001 GP_ENABLE */

 7fff tesla UNK141C */

 000000ff GP_REG_ALLOC_TEMP */

 00000001 GP_ENABLE */

 000000ff FP_REG_ALLOC_TEMP */

 00000003 REG_MODE */

 RO */

 RO */

 RO */

 1fffffff FP_INTERPOLANT_CTRL */

 ff/3ff */

 0003ffff tesla UNK0FAC */

 7fff, 0, 0 */

 00000001 tesla UNK1534 */

 7/f MULTISAMPLE_SAMPLES_LOG2 */

 0000ffff MSAA_MASK */

 00000001 LANES32 */

 00ffffff BLOCK_ALLOC */

 ffffffff BLOCKDIM_XY */

 0000ffff BLOCKDIM_Z */

 ffffffff SHARED_SIZE */

 1ffff/3ffff[NVA0+] tesla UNk0FAC */

 ffffffff tesla UNK1A34 */

 0000001f tesla UNK169C */

 ff/3ff */

 1 LINKED_TSC */

 ff FP_ADDRESS_HIGH */

 ffffffff FP_ADDRESS_LOW */

 1fffffff FP_INTERPOLANT_CTRL */

 00000007 FP_CONTROL */

 000000ff FRAG_COLOR_CLAMP_EN */

 00000003 REG_MODE */

 0000007f RT_FORMAT */

 0000007f RT_FORMAT */

 00000007 */

 0fffffff RT_CONTROL */

 00000003 MULTISAMPLE_CTRL */

 00000003 tesla UNK16B4 */

 00000001 ALPHA_TEST_ENABLE */

 00000007 ALPHA_TEST_FUNC */

 00000001 FRAMEBUFFER_SRGB */

 ffffffff tesla UNK1400 */

 00000001 BLEND_ENABLE */

 00000001 LOGIC_OP_ENABLE */

 0000001f BLEND_FUNC_SRC_RGB */

 0000001f BLEND_FUNC_DST_RGB */

 00000007 BLEND_EQUATION_RGB */

 0000001f BLEND_FUNC_SRC_ALPHA */

 0000001f BLEND_FUNC_DST_ALPHA */

 00000007 BLEND_EQUATION_ALPHA */

 00000001 UNK133C */

 00000001 UNK12E4 */

 0000001f IBLEND_FUNC_SRC_RGB */

 0000001f IBLEND_FUNC_DST_RGB */

 00000007 IBLEND_EQUATION_RGB */

 0000001f IBLEND_FUNC_SRC_ALPHA */

 0000001f IBLEND_FUNC_DST_ALPHA */

 00000007 IBLEND_EQUATION_ALPHA */

 00000001 IBLEND_UNK00 */

 00000003 tesla UNK1928 */

 00000001 UNK1140 */

 00000003 tesla UNK0F90 */

 000000ff FP_RESULT_COUNT */

 XXX: demagic this part some day */

 3f/7f DST_FORMAT */

 7 OPERATION */

 1 DST_LINEAR */

			/* that little bugger belongs to csched. No idea

 FP_INTERPOLANT_CTRL */

 Strand 0: TPs 0, 1 */

		/* that little bugger belongs to csched. No idea

 FP_INTERPOLANT_CTRL */

 Strand 1: TPs 2, 3 */

 Strand 2: TPs 4, 5, 6 */

 Strand 3: TPs 7, 8, 9 */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2007 Matthieu CASTET <castet.matthieu@free.fr>

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragr) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 pattern */

 gdi */

 swzsurf */

 blit */

 surf2d */

 beta4 */

 sifm */

 ifc */

 blit */

 surf3d */

 ttri */

 mtri */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

/*

 * Copyright (c) 2015, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 Bypass MMU check for non-secure boot */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

 zrop */

 crop */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*******************************************************************************

 * PGRAPH context implementation

 Pack tile map into register format. */

 GPC_BROADCAST.TP_BROADCAST */

 UNK78xx */

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

 Pack tile map into register format. */

 Magic. */

 GPC_BROADCAST */

 GPC_BROADCAST.TP_BROADCAST */

 UNK78xx */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2009 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/* NVIDIA context programs handle a number of other conditions which are

 * not implemented in our versions.  It's not clear why NVIDIA context

 * programs have this code, nor whether it's strictly necessary for

 * correct operation.  We'll implement additional handling if/when we

 * discover it's necessary.

 *

 * - On context save, NVIDIA set 0x400314 bit 0 to 1 if the "3D state"

 *   flag is set, this gets saved into the context.

 * - On context save, the context program for all cards load nsource

 *   into a flag register and check for ILLEGAL_MTHD.  If it's set,

 *   opcode 0x60000d is called before resuming normal operation.

 * - Some context programs check more conditions than the above.  NV44

 *   checks: ((nsource & 0x0857) || (0x400718 & 0x0100) || (intr & 0x0001))

 *   and calls 0x60000d before resuming normal operation.

 * - At the very beginning of NVIDIA's context programs, flag 9 is checked

 *   and if true 0x800001 is called with count=0, pos=0, the flag is cleared

 *   and then the ctxprog is aborted.  It looks like a complicated NOP,

 *   its purpose is unknown.

 * - In the section of code that loads the per-vs state, NVIDIA check

 *   flag 10.  If it's set, they only transfer the small 0x300 byte block

 *   of state + the state for a single vs as opposed to the state for

 *   all vs units.  It doesn't seem likely that it'll occur in normal

 *   operation, especially seeing as it appears NVIDIA may have screwed

 *   up the ctxprogs for some cards and have an invalid instruction

 *   rather than a cp_lsr(ctx, dwords_for_1_vs_unit) instruction.

 * - There's a number of places where context offset 0 (where we place

 *   the PRAMIN offset of the context) is loaded into either 0x408000,

 *   0x408004 or 0x408008.  Not sure what's up there either.

 * - The ctxprogs for some cards save 0x400a00 again during the cleanup

 *   path for auto-loadctx.

 unknown */

 per-vs state (0x4497) */

 per-vs state (0x4097) */

/* TODO:

 *  - get vs count from 0x1540

 fragment texture units */

 vertex texture units */

 belong at end!! */

 33a0 */

 1500 */

 2200 */

 0b00 */

 2200 */

 0b00 : 0a40 */

 decide whether we're loading/unloading the context */

 setup for context load */

 ?? */

 ?? */

 ?? */

 ?? */

 ?? */

 setup for context save */

 general PGRAPH state */

 3D state, block 1 */

 3D state, block 2 */

 Some other block of "random" state */

 Per-vertex shader state */

 pre-exit state updates */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH engine/subdev functions

 zrop */

 crop */

XXX: There's a different algorithm here I've not yet figured out. */

	/*XXX: Not sure what this is about.  The algorithm from NVGPU

	 *     seems to work for all boards I tried from earlier (and

	 *     later) GPUs except in these specific configurations.

	 *

	 *     Let's just hardcode them for now.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

 SPDX-License-Identifier: MIT

/*******************************************************************************

 * PGRAPH context

XXX: check!! */

/*******************************************************************************

 * PGRAPH engine/subdev functions

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 patt */

 gdi */

 surf2d */

 beta4 */

 sifm */

 ifc */

 celcius */

 swzsurf */

 imageblit */

 kelvin */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

XXX: educated guess */

XXX: guess */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 We don't suppose we will initialize more than 16 classes here... */

 Add terminator to the method list. */

 Clear SCC RAM */

 MMU debug buffer */

 Set the PE as stream master */

 Zcull init */

 Enable FIFO access */

 Enable interrupts */

 Enable FECS error interrupts */

 Enable hardware warning exceptions */

 Enable TPC exceptions per GPC */

 Reset and enable all exceptions */

/*

 * Copyright 2007 Matthieu CASTET <castet.matthieu@free.fr>

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragr) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 pattern */

 gdi */

 swzsurf */

 blit */

 surf2d */

 beta4 */

 sifm */

 ifc */

 blit */

 surf3d */

 ttri */

 mtri */

 celcius */

 SPDX-License-Identifier: MIT

/*******************************************************************************

 * PGRAPH context

/*******************************************************************************

 * PGRAPH engine/subdev functions

 suspiciously like PGRAPH_DEBUG_2 */

 begin RAM config */

 vramsz = pci_resource_len(gr->dev->pdev, 1) - 1; */

 beta1 */

 clip */

 null */

 m2mf */

 rop */

 patt */

 gdi */

 surf2d */

 beta4 */

 sifm */

 ifc */

 imageblit */

 surf2d (nv30) */

 sifm (nv30) */

 ifc (nv30) */

 swzsurf (nv30) */

 rankine */

 kelvin */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH context register lists

/*******************************************************************************

 * PGRAPH context implementation

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * PGRAPH register lists

/*******************************************************************************

 * PGRAPH engine/subdev functions

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 (2 * 4) + ((8 * 4) * 2)

#define imm32(reg,val) /*

*/	movw reg  ((val) & 0x0000ffff) /*

#define imm32(reg,val) /*

#define nv_mkio(rv,r,i) /*

#define nv_iord(rv,r,i) /*

*/	nv_mkio(rv,r,i) /*

#define nv_iowr(r,i,rv) /*

*/	nv_mkio($r0,r,i) /*

*/	iowr I[$r0] rv /*

#define nv_rd32(reg,addr) /*

*/	imm32($r14, addr) /*

*/	call(nv_rd32) /*

#define nv_wr32(addr,reg) /*

*/	mov b32 $r15 reg /*

*/	imm32($r14, addr) /*

#define trace_set(bit) /*

*/	clear b32 $r9 /*

*/	bset $r9 bit /*

#define trace_clr(bit) /*

*/	clear b32 $r9 /*

*/	bset $r9 bit /*

/* fuc microcode util functions for gf100 PGRAPH

 *

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 queue_put - add request to queue



 In : $r13 queue pointer

	$r14 command

	$r15 data



 make sure we have space..

 GET

 PUT

 store cmd/data on queue

 update PUT

 queue_get - fetch request from queue



 In : $r13 queue pointer



 Out:	$p1  clear on success (data available)

	$r14 command

 	$r15 data



 GET

 PUT

 fetch first cmd/data pair

 update GET

 nv_rd32 - read 32-bit value from nv register



 In : $r14 register

 Out: $r15 value



 MMIO_CTRL_PENDING

 DONE_MMIO_RD

 nv_wr32 - write 32-bit value to nv register



 In : $r14 register

      $r15 value



 MMIO_CTRL_PENDING

 MMIO_CTRL_WRITE

 wait_donez - wait on FUC_DONE bit to become clear



 In : $r10 bit to wait on



 wait_doneo - wait on FUC_DONE bit to become set



 In : $r10 bit to wait on



 mmctx_size - determine size of a mmio list transfer



 In : $r14 mmio list head

      $r15 mmio list tail

 Out: $r15 transfer size (in bytes)



 mmctx_xfer - execute a list of mmio transfers



 In : $r10 flags

		bit 0: direction (0 = save, 1 = load)

		bit 1: set if first transfer

		bit 2: set if last transfer

	$r11 base

	$r12 mmio list head

	$r13 mmio list tail

	$r14 multi_stride

	$r15 multi_mask



 BASE_EN

 MULTI_EN

 DIR

 QLIMIT = 0x10

 START_TRIGGER

 loop over the mmio list, and send requests to the hw

 wait for space in mmctx queue

 queue up an entry

 wait for queue to empty

 DONE_MMCTX

 DIR

 QLIMIT = 0x10

 STOP_TRIGGER

 wait for STOP_TRIGGER to clear

 Wait for DONE_STRAND



 unknown - call before issuing strand commands



 unknown - call after issuing strand commands



 Selects strand set?!



 In: $r14 id



 Initialise strand context data



 In : $r15 context base

 Out: $r15 context size (in bytes)



 Strandset(?) 3 hardcoded currently



 read the size of each strand, poke the context offset of

 each into STRAND_{SAVE,LOAD}_SWBASE now, no need to worry

 about it later then.

 STRAND_SAVE_SWBASE

 STRAND_LOAD_SWBASE

 STRAND_SIZE

/* fuc microcode for gf100 PGRAPH/HUB

 *

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 0x17e91c, 2

 reports an exception to the host



 In: $r15 error code (see os.h)



 HUB fuc initialisation, executed by triggering ucode start, will

 fall through to main loop after completion.



 Output:

   CC_SCRATCH[0]:

	     31:31: set to signal completion

   CC_SCRATCH[1]:

	      31:0: total PGRAPH context size



 setup stack

 enable fifo access

 setup i0 handler, and route all interrupts to it

 route HUB_CHSW_PULSE to fuc interrupt 8

 { HUB_CHSW_PULSE, ZERO } -> intr 8

 not sure what these are, route them because NVIDIA does, and

 the IRQ handler will signal the host if we ever get one.. we

 may find out if/why we need to handle these if so..



 { 0x04, ZERO } -> intr 9

 { HUB_FIRMWARE_MTHD, ZERO } -> intr 10

 { 0x0c, ZERO } -> intr 15

 enable all INTR_UP interrupts

 enable fifo, ctxsw, 9, fwmthd, 15 interrupts

 fifo level triggered, rest edge

 enable interrupts

 fetch enabled GPC/ROP counts

 set BAR_REQMASK to GPC mask

 context size calculation, reserve first 256 bytes for use by fuc



 calculate size of mmio context data

 set mmctx base addresses now so we don't have to do it later,

 they don't (currently) ever change

 wtf??

 strands, base offset needs to be aligned to 256 bytes

 initialise each GPC in sequence by passing in the offset of its

 context data in GPCn_CC_SCRATCH[1], and starting its FUC (which

 has previously been uploaded by the host) running.



 the GPC fuc init sequence will set GPCn_CC_SCRATCH[0] bit 31

 when it has completed, and return the size of its context data

 in GPCn_CC_SCRATCH[1]



 setup, and start GPC ucode running

 CC_SCRATCH[1] = ctx offset

 ENTRY

 CTRL_START_TRIGGER

 CTRL

 wait for it to complete, and adjust context size

 next!



 save context size, and tell host we're ready

 Main program loop, very simple, sleeps until woken up by the interrupt

 handler, pulls a command from the queue and executes its handler



 sleep until we have something to do

 context switch, requested by GPU?

 ack the context switch request

 request to set current channel? (*not* a context switch)

 request to store current channel context?

 interrupt handler

 incoming fifo command?

 queue incoming fifo command for later processing

 context switch request?

 enqueue a context switch for later processing

 firmware method?

 none we handle; report to host and ack

 anything we didn't handle, bring it to the host's attention

 FIFO | CHSW | FWMTHD

 ack, and wake up main()

 Not real sure, but, MEM_CMD 7 will hang forever if this isn't done

 Without clearing again at end of xfer, some things cause PGRAPH

 to hang with STATUS=0x00000007 until it's cleared.. fbcon can

 still function with it set however...

 Again, not real sure



 In: $r15 value to set 0x404170 to



 Waits for a ctx_4170s() call to complete



 Disables various things, waits a bit, and re-enables them..



 Not sure how exactly this helps, perhaps "ENABLE" is not such a

 good description for the bits we turn off?  Anyways, without this,

 funny things happen.



 Not a clue what this is for, except that unless the value is 0x10, the

 strand context is saved (and presumably restored) incorrectly..



 In: $r15 value to set to (0x00/0x10 are used)



 In: $r15 NV_PGRAPH_FECS_MEM_CMD_*

 ctx_load - load's a channel's ctxctl data, and selects its vm



 In: $r2 channel address



 switch to channel, somewhat magic in parts..

 DONE_UNK12

 load channel header, fetch PGRAPH context pointer

 chan + 0x0210

 16 bytes

 update current context

 set transfer base to start of context, and fetch context header

 256 bytes

 ctx_chan - handler for HUB_SET_CHAN command, will set a channel as

            the active channel for ctxctl, but not actually transfer

            any context data.  intended for use only during initial

            context construction.



 In: $r2 channel address



 DONE_UNK12

 MEM_CMD 5 ???

 Execute per-context state overrides list



 Only executed on the first load of a channel.  Might want to look into

 removing this and having the host directly modify the channel's context

 to change this state...  The nouveau DRM already builds this list as

 it's definitely needed for NVIDIA's, so we may as well use it for now



 Input: $r1 mmio list length



 set transfer base to be the mmio list

 fetch next 256 bytes of mmio list if necessary

 256 bytes

 execute a single list entry

 next!

 set transfer base back to the current context

 disable the mmio list now, we don't need/want to execute it again

 256 bytes

 Transfer HUB context data between GPU and storage area



 In: $r2 channel address

     $p1 clear on save, set on load

     $p2 set if opposite direction done/will be done, so:

		on save it means: "a load will follow this save"

		on load it means: "a save preceeded this load"



 according to mwk, some kind of wait for idle

 fetch context pointer, and initiate xfer on all GPCs

 GPC_BCAST_WRCMD_DATA = ctx pointer

 GPC_BCAST_WRCMD_CMD = GPC_XFER(type)

 strands

 SAVE/LOAD

 mmio context

 direction

 first, last

 base = 0

 not multi

 wait for GPCs to all complete

 DONE_BAR

 wait for strand xfer to complete

 post-op

 DONE_UNK12

 MEM_CMD 5 ???

/* fuc microcode for gf100 PGRAPH/GPC

 *

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/* TODO

 * - bracket certain functions with scratch writes, useful for debugging

 * - watchdog timer around ctx operations

#define gpc_addr(reg,addr)                                                    /*

*/	imm32(reg,addr)                                                       /*

#define gpc_wr32(addr,reg)                                                    /*

*/	gpc_addr($r14,addr)                                                   /*

*/	mov b32 $r15 reg                                                      /*

 reports an exception to the host



 In: $r15 error code (see os.h)



#define tpc_strand_enable()                                                   /*

*/	mov $r15 NV_PGRAPH_GPC0_TPCX_STRAND_CMD_ENABLE                        /*

*/	gpc_wr32(NV_PGRAPH_GPC0_TPCX_STRAND_CMD, $r15)                        /*

#define tpc_strand_disable()                                                  /*

*/	mov $r15 NV_PGRAPH_GPC0_TPCX_STRAND_CMD_DISABLE                       /*

*/	gpc_wr32(NV_PGRAPH_GPC0_TPCX_STRAND_CMD, $r15)                        /*

#define tpc_strand_seek(p)                                                    /*

*/	mov $r15 NV_PGRAPH_GPC0_TPCX_STRAND_INDEX_ALL                         /*

*/	gpc_wr32(NV_PGRAPH_GPC0_TPCX_STRAND_INDEX, $r15)                      /*

*/	mov $r15 p                                                            /*

*/	gpc_wr32(NV_PGRAPH_GPC0_TPCX_STRAND_SELECT, $r15)                     /*

*/	mov $r15 NV_PGRAPH_GPC0_TPCX_STRAND_CMD_SEEK                          /*

#define tpc_strand_info(m)                                                    /*

*/	gpc_wr32(NV_PGRAPH_GPC0_TPCX_STRAND_CMD, $r15)                        /*

*/	mov $r15 m                                                            /*

*/	gpc_wr32(NV_PGRAPH_GPC0_TPCX_STRAND_DATA, $r15)                       /*

*/	mov $r15 NV_PGRAPH_GPC0_TPCX_STRAND_CMD_GET_INFO                      /*

*/	gpc_wr32(NV_PGRAPH_GPC0_TPCX_STRAND_CMD, $r15)                        /*

 GPC fuc initialisation, executed by triggering ucode start, will

 fall through to main loop after completion.



 Input:

   CC_SCRATCH[1]: context base



 Output:

   CC_SCRATCH[0]:

	     31:31: set to signal completion

   CC_SCRATCH[1]:

	      31:0: GPC context size



 setup stack

 enable fifo access

 setup i0 handler, and route all interrupts to it

 enable fifo interrupt

 enable interrupts

 how many TPCs do we have?

 determine which GPC we are, setup (optional) mmio access offset

 figure out which, and how many, UNKs are actually present

 initialise context base, and size tracking

 track GPC context size here

 set mmctx base addresses now so we don't have to do it later,

 they don't currently ever change

 calculate GPC mmio context size

 calculate per-TPC mmio context size

 calculate per-UNK mmio context size

 round up base/size to 256 byte boundary (for strand SWBASE)

 wtf for?!

 calculate size of strand context data

 calculate size of tpc strand context data

 save context size, and tell HUB we're done

 Main program loop, very simple, sleeps until woken up by the interrupt

 handler, pulls a command from the queue and executes its handler



 0x0000-0x0003 are all context transfers

 fetch $flags and mask off $p1/$p2

 set $p1/$p2 according to transfer type

 transfer context data

 interrupt handler

 incoming fifo command?

 queue incoming fifo command for later processing

 ack, and wake up main()

 Set this GPC's bit in HUB_BAR, used to signal completion of various

 activities to the HUB fuc



 0x409418 - HUB_BAR_SET

 Disables various things, waits a bit, and re-enables them..



 Not sure how exactly this helps, perhaps "ENABLE" is not such a

 good description for the bits we turn off?  Anyways, without this,

 funny things happen.



 Transfer GPC context data between GPU and storage area



 In: $r15 context base address

     $p1 clear on save, set on load

     $p2 set if opposite direction done/will be done, so:

		on save it means: "a load will follow this save"

		on load it means: "a save preceeded this load"



 set context base address

 strands

 SAVE/LOAD

 SAVE/LOAD

 mmio context

 direction

 first

 base = NV_PGRAPH_GPCn

 not multi

 per-TPC mmio context

 direction

 last

 base = NV_PGRAPH_GPCn_TPC0

 stride = 0x800

 per-UNK mmio context

 direction

 last

 base = NV_PGRAPH_GPCn_UNK0

 stride = 0x200

 wait for strands to finish

 if load, or a save without a load following, do some

 unknown stuff that's done after finishing a block of

 strand commands

 mark completion in HUB's barrier

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

XXX*/

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Lookup IED table for the device. */

 Lookup IEDT runtime settings for the current configuration. */

 Execute the OnInt[23] script for the current frequency. */

 Determine which OR, if any, we're attaching to the head. */

 Execute OnInt3 IED script. */

 OR-specific handling. */

 symbols/hblank - algorithm taken from comments in tegra driver */

 symbols/vblank - algorithm taken from comments in tegra driver */

 watermark / activesym */

 calculate ratio of packed data rate to link symbol rate */

 calculate average number of valid symbols in each TU */

 find a hw representation for the fraction.. */

			/* no remainder, but the hw doesn't like the fractional

			 * part to be zero.  decrement the integer part and

			 * have the fraction add a whole symbol back

 XXX close to vbios numbers, but not right */

 Determine which OR, if any, we're attaching from the head. */

	/* For some reason, NVIDIA decided not to:

	 *

	 * A) Give dual-link LVDS a separate EVO protocol, like for TMDS.

	 *  and

	 * B) Use SetControlOutputResource.PixelDepth on LVDS.

	 *

	 * Override the values we usually read from HW with the same

	 * data we pass though an ioctl instead.

 Handle any link training, etc. */

 Execute OnInt2 IED script. */

 Program RG clock divider. */

 Mode-specific internal DP configuration. */

 OR-specific handling. */

 Determine which OR, if any, we're detaching from the head. */

 Execute OffInt2 IED script. */

	/* If we're shutting down the OR's only active head, execute

	 * the output path's disable function.

 Determine which OR, if any, we're detaching from the head. */

 Execute OffInt1 IED script. */

 disable all interrupts */

	/* The below segments of code copying values from one register to

	 * another appear to inform EVO of the display capabilities or

	 * something similar.  NFI what the 0x614004 caps are for..

 ... CRTC caps */

 ... DAC caps */

 ... SOR caps */

 ... PIOR caps */

 steal display away from vbios, or something like that */

 point at display engine memory area (hash table, objects) */

 enable supervisor interrupts, disable everything else */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 AR */

 INP0 */

 CR */

 MISC */

 SR */

 GR */

 CR44 selects head */

 AR */

 INP0 */

 CR */

 MISC */

 SR */

 GR */

 CR44 selects head */

/* CR44 takes values 0 (head A), 3 (head B) and 4 (heads tied)

 * it affects only the 8 bit vga io regs, which we access using mmio at

 * 0xc{0,2}3c*, 0x60{1,3}3*, and 0x68{1,3}3d*

 * in general, the set value of cr44 does not matter: reg access works as

 * expected and values can be set for the appropriate head by using a 0x2000

 * offset as required

 * however:

 * a) pre nv40, the head B range of PRMVIO regs at 0xc23c* was not exposed and

 *    cr44 must be set to 0 or 3 for accessing values on the correct head

 *    through the common 0xc03c* addresses

 * b) in tied mode (4) head B is programmed to the values set on head A, and

 *    access using the head B addresses can have strange results, ergo we leave

 *    tied mode in init once we know to what cr44 should be restored on exit

 *

 * the owner parameter is slightly abused:

 * 0 and 1 are treated as head values and so the set value is (owner * 3)

 * other values are treated as literal values to set

 workaround hw lockup bug */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* GF119 moves this information to per-head methods, which is

	 * a lot more convenient, and where our shared code expect it.

XXX*/

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 ??? */ |

 AVI InfoFrame */

 Audio InfoFrame */

 Vendor InfoFrame */

 Is there a second (or up to fourth?) set of subpack registers here? */

 nvkm_wr32(device, 0x616550 + hoff, vendor_infoframe->subpack1_low); */

 nvkm_wr32(device, 0x616554 + hoff, vendor_infoframe->subpack1_high); */

 SPARE, HW_CTS */

 ACR_CTRL, ?? */

 ACR_0441_ENABLE */

 ??? */

 RESETF */

 LOOKUP_EN */

 !RESETF */

 HDMI_CTRL */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 initialise channel for dma command submission */

 wait for it to go inactive */

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 not a bug */

 Failing that, a completely unused OR is the next best thing. */

	/* Last resort is to assign an OR that's already active on HW,

	 * but will be released during the next modeset.

 Lookup a compatible, and unused, OR to assign to the device. */

 Deal with panels requiring identity-mapped SOR assignment. */

	/* First preference is to reuse the OR that is currently armed

	 * on HW, if any, in order to prevent unnecessary switching.

			/*XXX: For various complicated reasons, we can't outright switch

			 *     the boot-time OR on the first modeset without some fairly

			 *     invasive changes.

			 *

			 *     The systems that were fixed by modifying the OR selection

			 *     code to account for HDA support shouldn't regress here as

			 *     the HDA-enabled ORs match the relevant output's pad macro

			 *     index, and the firmware seems to select an OR this way.

			 *

			 *     This warning is to make it obvious if that proves wrong.

	/* If we don't need HDA, first try to acquire an OR that doesn't

	 * support it to leave free the ones that do.

 Use a HDA-supporting SOR anyway. */

 We want HDA, try to acquire an OR that supports it. */

	/* There weren't any free ORs that support HDA, grab one that

	 * doesn't and at least allow display to work still.

 Find any OR from the class that is able to support this device. */

 Determine the specific OR, if any, this device is attached to. */

 Prior to DCB 4.1, this is hardwired like so. */

 Determine if the OR is already configured for this device. */

		/* The EFI GOP driver on Ampere can leave unused DP links routed,

		 * which we don't expect.  The DisableLT IED script *should* get

		 * us back to where we need to be.

 Cull output paths we can't map to an output resource. */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 deactivate channel */

 initialise channel for dma command submission */

 wait for it to go inactive */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/*TODO: Suspect 33->41 are for WRBK channel exceptions, but we

	 *      don't support those currently.

	 *

	 *      CORE+WIN CHIDs map directly to the FE_EXCEPT() slots.

	/*TODO: I would guess this is VBIOS_RELEASE, however, NFI how to

	 *      ACK it, nor does RM appear to bother.

 AWAKEN_OTHER_CORE. */

 AWAKEN_WIN_CH(n). */

 LAST_DATA, LOADV. */

 Claim ownership of display. */

 Lock pin capabilities. */

 SOR capabilities. */

 Head capabilities. */

 RG. */

 POSTCOMP. */

 Window capabilities. */

 IHUB capabilities. */

 Setup instance memory. */

 CTRL_DISP: AWAKEN, ERROR, SUPERVISOR[1-3]. */

 MSK. */

 EN. */

 EXC_OTHER: CURSn, CORE. */

 MSK. */

 EN. */

 EXC_WINIM. */

 MSK. */

 EN. */

 EXC_WIN. */

 MSK. */

 EN. */

 HEAD_TIMING(n): VBLANK. */

 MSK. */

 EN. */

 OR. */

 MSK. */

 EN. */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 activate channel */

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 AVI InfoFrame (AVI). */

 Vendor-specific InfoFrame (VSI). */

 General Control (GCP). */

 Audio Clock Regeneration (ACR). */

 NV_PDISP_SF_HDMI_CTRL. */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 ??? */ |

 AVI InfoFrame */

 Audio InfoFrame */

 Vendor InfoFrame */

 Is there a second (or up to fourth?) set of subpack registers here? */

 nvkm_wr32(device, 0x61c550 + soff, vendor_infoframe.subpack1_low); */

 nvkm_wr32(device, 0x61c554 + soff, vendor_infoframe.subpack1_high); */

 SPARE, HW_CTS */

 ACR_CTRL, ?? */

 ACR_0441_ENABLE */

 ??? */

 RESETF */

 LOOKUP_EN */

 !RESETF */

 HDMI_CTRL */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2020 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2020 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 SPDX-License-Identifier: MIT

		/*

		 * "When in doubt, use brute force."

		 *     -- Ken Thompson.

		/*

		 * We presume that no valid frame is longer than 17

		 * octets, including header...  And truncate to that

		 * if it's longer.

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* Set 'normal' (ie. when it's attached to a head) state for

	 * each output resource to 'fully enabled'.

 Create output path objects for each VBIOS display path. */

 No support for chipsets prior to NV50. */

 No support for WFD yet. */

 Create connector objects based on available output paths. */

 VBIOS data *should* give us the most useful information. */

 No bios connector data... */

			/* Heuristic: anything with the same ccb index is

			 * considered to be on the same connector, any

			 * output path without an associated ccb entry will

			 * be put on its own connector.

 Connector shared with another output path. */

 Check that we haven't already created this connector. */

 Apparently we need to create a new one! */

	/* Enforce identity-mapped SOR assignment for panels, which have

	 * certain bits (ie. backlight controls) wired to a specific SOR.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

XXX: "default" */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

		/* We don't support reading htotal/vtotal on pre-NV50 VGA,

		 * so we have to give up and trigger the timestamping

		 * fallback in the drm core.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/* IED scripts are no longer used by UEFI/RM from Ampere, but have been updated for

 * the x86 option ROM.  However, the relevant VBIOS table versions weren't modified,

 * so we're unable to detect this in a nice way.

 yes. */

 Intersect misc. capabilities of the OR and sink. */

 Execute BeforeLinkTraining script from DP Info table. */

 Set desired link configuration on the source. */

 Set desired link configuration on the sink. */

 Attempt to train the link in this configuration. */

 Execute AfterLinkTraining script from DP Info table. */

 Execute EnableSpread/DisableSpread script from DP Info table. */

 Execute BeforeLinkTraining script from DP Info table. */

	/* Find the lowest configuration of the OR that can support

	 * the required link rate.

	 *

	 * We will refuse to program the OR to lower rates, even if

	 * link training fails at higher rates (or even if the sink

	 * can't support the rate at all, though the DD is supposed

	 * to prevent such situations from happening).

	 *

	 * Attempting to do so can cause the entire display to hang,

	 * and it's better to have a failed modeset than that.

			/* Try to respect sink limits too when selecting

			 * lowest link configuration.

 Ensure sink is not in a low-power state. */

 Link training. */

 Skip configurations not supported by both OR and sink. */

 Program selected link configuration. */

 Execute DisableLT script from DP Info Table. */

 Prevent link from being retrained if sink sends an IRQ. */

 Check that link configuration meets current requirements. */

 Check that link is still trained. */

	/* eDP panels need powering on by us (if the VBIOS doesn't default it

	 * to on) before doing any AUX channel transactions.  LVDS panel power

	 * is handled by the SOR itself, and not required for LVDS DDC.

		/* We delay here unconditionally, even if already powered,

		 * because some laptop panels having a significant resume

		 * delay before the panel begins responding.

		 *

		 * This is likely a bit of a hack, but no better idea for

		 * handling this at the moment.

		/* If the eDP panel can't be detected, we need to restore

		 * the panel power GPIO to avoid breaking another output.

 bios data is not optional */

 hotplug detect, replaces gpio-based mechanism with aux events */

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 deactivate channel */

 initialise channel for dma command submission */

 wait for it to go inactive */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Claim ownership of display. */

 Lock pin capabilities. */

XXX*/

 SOR capabilities. */

 Head capabilities. */

 RG. */

 POSTCOMP. */

 Window capabilities. */

 IHUB capabilities. */

 Setup instance memory. */

 CTRL_DISP: AWAKEN, ERROR, SUPERVISOR[1-3]. */

 MSK. */

 EN. */

 EXC_OTHER: CURSn, CORE. */

 MSK. */

 EN. */

 EXC_WINIM. */

 MSK. */

 EN. */

 EXC_WIN. */

 MSK. */

 EN. */

 HEAD_TIMING(n): VBLANK. */

 MSK. */

 EN. */

 OR. */

 MSK. */

 EN. */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 deactivate channel */

 initialise channel for dma command submission */

 wait for it to go inactive */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 deactivate channel */

 attempt to unstick channel from some unknown state */

 initialise channel for dma command submission */

 wait for it to go inactive */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 AVI InfoFrame */

 GENERIC(?) / Vendor InfoFrame? */

 Is there a second (or further?) set of subpack registers here? */

 ??? InfoFrame? */

 ??? */

 HDMI_CTRL */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 initialise channel for dma command submission */

 wait for it to go inactive */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Ilia Mirkin

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ilia Mirkin

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 disable all interrupts */

	/* The below segments of code copying values from one register to

	 * another appear to inform EVO of the display capabilities or

	 * something similar.

 ... CRTC caps */

 ... DAC caps */

 ... SOR caps */

 steal display away from vbios, or something like that */

 point at display engine memory area (hash table, objects) */

 enable supervisor interrupts, disable everything else */

	/* disable underflow reporting, preventing an intermittent issue

	 * on some gk104 boards where the production vbios left this

	 * setting enabled by default.

	 *

	 * ftp://download.nvidia.com/open-gpu-doc/gk104-disable-underflow-reporting/1/gk104-disable-underflow-reporting.txt

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 " : "",

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 AVI InfoFrame */

 GENERIC(?) / Vendor InfoFrame? */

		/*

		 * These appear to be the audio infoframe registers,

		 * but no other set of infoframe registers has yet

		 * been found.

 Is there a second (or further?) set of subpack registers here? */

 ??? InfoFrame? */

 HDMI_CTRL */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2020 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 vline read locks hline. */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

XXX*/

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 vline read locks hline. */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Ilia Mirkin

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Ilia Mirkin

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

	/* Not sure if this is a WAR for a HW issue, or some additional

	 * programming sequence that's needed to properly complete the

	 * context switch we trigger above.

	 *

	 * Fixes unreliability of booting the SEC2 RTOS on Quadro P620,

	 * particularly when resuming from suspend.

	 *

	 * Also removes the need for an odd workaround where we needed

	 * to program SEC2's FALCON_CPUCTL_ALIAS_STARTCPU twice before

	 * the SEC2 RTOS would begin executing.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/* TOP info wasn't updated on Turing to reflect the PRI

	 * address change for some reason.  We override it here.

/*

 * Copyright 2012 Maarten Lankhorst

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Maarten Lankhorst

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Maarten Lankhorst, Ilia Mirkin

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Maarten Lankhorst, Ilia Mirkin

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

XXX: guess

XXX: guess

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/* fuc microcode for copy engine on gt215- chipsets

 *

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 mthd 0x0000, NAME

 mthd 0x0100, NOP

 mthd 0x0140, PM_TRIGGER

 mthd 0x0180-0x018c, DMA_

 mthd 0x0200-0x0218, SRC_TILE

 mthd 0x0220-0x0238, DST_TILE

 mthd 0x0300-0x0304, EXEC, WRCACHE_FLUSH

 mthd 0x030c-0x0340, various stuff

 setup i0 handler and route fifo and ctxswitch to it

 enable interrupts

 enable fifo access and context switching

 sleep forever, waking for interrupts

 i0 handler

 $p1 direction (0 = unload, 1 = load)

 $r3 channel

 target 7 hardcoded to ctx dma object

 read SCRATCH3 to decide if we are PCOPY0 or PCOPY1

 channel is in vram

 read 16-byte PCOPYn info, containing context pointer, from channel

 get a chunk of stack space, aligned to 256 byte boundary

 set context pointer, from within channel VM

 256-byte context, at start of data segment

 swap!

 read current channel

 if it's active, unload it and return

 read next channel

 is there a channel waiting to be loaded?

 load dma objects back into TARGET regs

 read incoming fifo command

 $r2 will be used to store exception data

 lookup method in the dispatch table, ILLEGAL_MTHD if not found

 ensure no bits set in reserved fields, INVALID_BITFIELD

 depending on dispatch flags: execute method, or save data as state

 store exception data in SCRATCH0/SCRATCH1, signal hostirq

 No-operation



 Inputs:

    $r1: irqh state

    $r2: hostirq state

    $r3: data

    $r4: dispatch table entry

 Outputs:

    $r1: irqh state

    $p1: set on error

       $r2: hostirq state

       $r3: data

 PM_TRIGGER



 Inputs:

    $r1: irqh state

    $r2: hostirq state

    $r3: data

    $r4: dispatch table entry

 Outputs:

    $r1: irqh state

    $p1: set on error

       $r2: hostirq state

       $r3: data

 SET_DMA_* method handler



 Inputs:

    $r1: irqh state

    $r2: hostirq state

    $r3: data

    $r4: dispatch table entry

 Outputs:

    $r1: irqh state

    $p1: set on error

       $r2: hostirq state

       $r3: data

 Calculates the hw swizzle mask and adjusts the surface's xcnt to match



 zero out a chunk of the stack to store the swizzle into

 extract cpp, src_ncomp and dst_ncomp from FORMAT

 convert FORMAT swizzle mask to hw swizzle mask

 SRC_XCNT = (xcnt * src_cpp), or 0 if no src ref in swz (hw will hang)

 Setup to handle a tiled surface



 Calculates a number of parameters the hardware requires in order

 to correctly handle tiling.



 Offset calculation is performed as follows (Tp/Th/Td from TILE_MODE):

    nTx = round_up(w * cpp, 1 << Tp) >> Tp

    nTy = round_up(h, 1 << Th) >> Th

    Txo = (x * cpp) & ((1 << Tp) - 1)

     Tx = (x * cpp) >> Tp

    Tyo = y & ((1 << Th) - 1)

     Ty = y >> Th

    Tzo = z & ((1 << Td) - 1)

     Tz = z >> Td



    off  = (Tzo << Tp << Th) + (Tyo << Tp) + Txo

    off += ((Tz * nTy * nTx)) + (Ty * nTx) + Tx) << Td << Th << Tp;



 Inputs:

    $r4: hw command (0x104800)

    $r5: ctx offset adjustment for src/dst selection

    $p2: set if dst surface



 translate TILE_MODE into Tp, Th, Td shift values

 Op = (x * cpp) & ((1 << Tp) - 1)

 Tx = (x * cpp) >> Tp

 Tyo = y & ((1 << Th) - 1)

 Ty  = y >> Th

 YTILE = ((1 << Th) << 12) | ((1 << Th) - Tyo)

 Op += Tyo << Tp

 nTx = ((w * cpp) + ((1 << Tp) - 1) >> Tp)

 nTy = (h + ((1 << Th) - 1)) >> Th

 Tys = Tp + Th

 CFG_YZ_TILE_SIZE = ((1 << Th) >> 2) << Td

 Tzo = z & ((1 << Td) - 1)

 Tz  = z >> Td

 Op += Tzo << Tys

 Ts  = Tys + Td

 Ot = ((Tz * nTy * nTx) + (Ty * nTx) + Tx) << Ts

 PITCH = (nTx - 1) << Ts

 SRC_ADDRESS_LOW   = (Ot + Op) & 0xffffffff

 CFG_ADDRESS_HIGH |= ((Ot + Op) >> 32) << 16

 Setup to handle a linear surface



 Nothing to see here.. Sets ADDRESS and PITCH, pretty non-exciting



 wait for regs to be available for use

 if QUERY_SHORT not set, write out { -, 0, TIME_LO, TIME_HI }

 write COUNTER

 Execute a copy operation



 Inputs:

    $r1: irqh state

    $r2: hostirq state

    $r3: data

       000002000 QUERY_SHORT

       000001000 QUERY

       000000100 DST_LINEAR

       000000010 SRC_LINEAR

       000000001 FORMAT

    $r4: dispatch table entry

 Outputs:

    $r1: irqh state

    $p1: set on error

       $r2: hostirq state

       $r3: data

 if format requested, call function to calculate it, otherwise

 fill in cpp/xcnt for both surfaces as if (cpp == 1)

 SRC_TARGET = 1, DST_TARGET = 2

 if requested, queue up a QUERY write after the copy has completed

 Flush write cache



 Inputs:

    $r1: irqh state

    $r2: hostirq state

    $r3: data

    $r4: dispatch table entry

 Outputs:

    $r1: irqh state

    $p1: set on error

       $r2: hostirq state

       $r3: data

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * software context

/*******************************************************************************

 * software engine/subdev functions

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * software context

 MP.PM_UNK000 */

 MP.TRAP_WARP_ERROR_EN */

 MP.PM_UNK0AC */

/*******************************************************************************

 * software engine/subdev functions

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * software context

/*******************************************************************************

 * software engine/subdev functions

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * software object classes

/*******************************************************************************

 * software context

/*******************************************************************************

 * software engine/subdev functions

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * PMPEG context

/*******************************************************************************

 * PMPEG engine/subdev functions

 happens on initial binding of the object */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * PMPEG context

/*******************************************************************************

 * PMPEG engine/subdev functions

 happens on initial binding of the object */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 only allow linear DMA objects */

 DMA_CMD */

 DMA_DATA */

 DMA_IMAGE, VRAM only */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*******************************************************************************

 * MPEG object classes

/*******************************************************************************

 * PMPEG context

/*******************************************************************************

 * PMPEG engine/subdev functions

 only allow linear DMA objects */

 DMA_CMD */

 DMA_DATA */

 DMA_IMAGE, VRAM only */

 happens on initial binding of the object */

 VPE init */

 nvidia: rd 0x01, wr 0x20 */

 nvidia: rd 0x01, wr 0x20 */

 PMPEG init */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Maarten Lankhorst

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Maarten Lankhorst

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Maarten Lankhorst, Ilia Mirkin

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Maarten Lankhorst, Ilia Mirkin

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Maarten Lankhorst, Ilia Mirkin

/*

 * Copyright 2012 Maarten Lankhorst

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Maarten Lankhorst

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Maarten Lankhorst, Ilia Mirkin

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs, Maarten Lankhorst, Ilia Mirkin

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/**

 * nvkm_firmware_get - load firmware from the official nvidia/chip/ directory

 * @subdev:	subdevice that will use that firmware

 * @fwname:	name of firmware file to load

 * @ver:	firmware version to load

 * @fw:		firmware structure to load to

 *

 * Use this function to load firmware files in the form nvidia/chip/fwname.bin.

 * Firmware files released by NVIDIA will always follow this format.

 Convert device name to lowercase */

/*

 * nvkm_firmware_put - release firmware loaded with nvkm_firmware_get

/*

 * Copyright (C) 2010 Nouveau Project

 *

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 just non-zero for <=g8x fifo ramht */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013-2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 fast-path, where backend is able to provide direct pointer to memory */

 accessor functions for gpuobjs allocated directly from instmem */

 accessor functions for gpuobjs sub-allocated from a parent gpuobj */

/* the below is basically only here to support sharing the paged dma object

 * for PCI(E)GART on <=nv4x chipsets, and should *not* be expected to work

 * anywhere else.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

		/* If comptags exist for the memory, but a different amount

		 * than requested, the buffer is being mapped with settings

		 * that are incompatible with existing mappings.

		/* Failure to allocate HW comptags is not an error, the

		 * caller should fall back to an uncompressed map.

		 *

		 * As memory can be mapped in multiple places, we still

		 * need to track the allocation failure and ensure that

		 * any additional mappings remain uncompressed.

		 *

		 * This is handled by returning an empty nvkm_tags.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (C) 2009 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 update? */

/*

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Apple iMac G4 NV18 */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 update? */

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres <martin.peres@labri.fr>

 *          Ben Skeggs

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres <martin.peres@labri.fr>

 *          Ben Skeggs

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres <martin.peres@labri.fr>

 *          Ben Skeggs

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres <martin.peres@labri.fr>

 *          Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 Heuristic: sync to head with biggest resolution */

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres <martin.peres@labri.fr>

 *          Ben Skeggs

 NV41- */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/* TODO: Figure out tag memory details and drop the over-cautious allocation.

 No VRAM, no tags for now. */

 tags for 1/4 of VRAM should be enough (8192/4 per GiB of VRAM) */

 we have 16/17 bits in PTE */

 round up to 64 */

 4 part 4 sub: 0x2000 bytes for 56 tags */

 3 part 4 sub: 0x6000 bytes for 168 tags */

	/*

	 * About 147 bytes per tag. Let's be safe and allocate x2, which makes

	 * 0x4980 bytes for 64 tags, and round up to 0x6000 bytes for 64 tags.

	 *

	 * For 4 GiB of memory we'll have 8192 tags which makes 3 MiB, < 0.1 %.

 INTR_EN &= ~0x10 */

/*

 * Copyright (c) 2019 NVIDIA Corporation.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Thierry Reding

 stream ID */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

XXX: tagram allocation - TBD */

XXX: PMU LS call to setup tagram address */

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 reserve 0 for disabled */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 racy if another part of nvkm start writing to this reg */

/*

 * Copyright 2014 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 racy if another part of nvkm start writing to these regs */

/*

 * Copyright 2014 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

/*

 * Copyright 2014 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 init ring */

 timeout configuration */

/*

 * Copyright 2015 Samuel Pitosiet

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Samuel Pitoiset

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright (c) 2014, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

	/*

	 * Bug: increase clock timeout to avoid operation failure at high

	 * gpcclk rate.

 Acknowledge interrupt */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

XXX*/

XXX*/

 SPDX-License-Identifier: MIT

 acquire data segment access */

 flush the cache... */

 release data segment access */

 call MEMX process to execute the script, and wait for reply */

 fuc can't handle multiple */

 fuc can't handle multiple */

 Heuristic: sync to head with biggest resolution */

 fuc can't handle multiple */

 read the packet */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* Internal PMU FW does not currently control fans in any way,

	 * allow SW control of fans instead.

	/* Default (board-loaded, or VBIOS PMU/PREOS) PMU FW on Fermi

	 * and newer automatically control the fan speed, which would

	 * interfere with SW control.

 Inhibit interrupts, and wait for idle. */

 Reset. */

 Wait for IMEM/DMEM scrubbing to be complete. */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 wait for a free slot in the fifo */

	/* we currently only support a single process at a time waiting

	 * on a synchronous reply, take the PMU mutex and tell the

	 * receive handler what we're waiting for

 acquire data segment access */

 write the packet */

 release data segment access */

 wait for reply, if requested */

 nothing to do if GET == PUT */

 acquire data segment access */

 read the packet */

 release data segment access */

 wake process if it's waiting on a synchronous reply */

	/* right now there's no other expected responses from the engine,

	 * so assume that any unexpected message is an error.

 upload data segment */

 upload code segment */

 start it running */

 wait for valid host->pmu ring configuration */

 wait for valid pmu->host ring configuration */

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2014, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 For GK20A, the performance level is directly mapped to pstate */

	/*

	 * The PMU is initialized before CLK and VOLT, so we have to make sure the

	 * CLK and VOLT are ready here.

 init pwr perf counter */

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 IO addresses

 fuck i hate envyas */ -1

 Inter-process message format

 send() target, recv() sender */

 Kernel message IDs

 Process message queue description

 log2(size of queue entry in bytes)

 log2(max number of entries in queue)

 max number of entries in queue

 Process table entry

#define process(id,init,recv) /*

*/	.b32 id /*

*/	.b32 init /*

*/	.b32 recv /*

*/	.b32 0 /*

*/	.b32 0 /*

*/	.b32 0 /*

#define imm32(reg,val) /*

*/	movw reg  ((val) & 0x0000ffff) /*

#define imm32(reg,val) /*

#define nv_iord(reg,ior) /*

*/	mov reg ior /*

*/ 	shl b32 reg 6 /*

#define nv_iord(reg,ior) /*

*/	mov reg ior /*

#define nv_iowr(ior,reg) /*

*/	mov $r0 ior /*

*/ 	shl b32 $r0 6 /*

*/ 	iowr I[$r0 + 0x000] reg /*

#define nv_iowr(ior,reg) /*

*/	mov $r0 ior /*

*/ 	iowr I[$r0 + 0x000] reg /*

#define nv_iowrs(ior,reg) /*

*/	mov $r0 ior /*

*/ 	shl b32 $r0 6 /*

*/ 	iowrs I[$r0 + 0x000] reg /*

#define nv_iowrs(ior,reg) /*

*/	mov $r0 ior /*

*/ 	iowrs I[$r0 + 0x000] reg /*

#define nv_rd32(reg,addr) /*

*/	mov b32 $r14 addr /*

*/	call(rd32) /*

#define nv_rd32(reg,addr) /*

*/ 	sethi $r0 0x14000000 /*

*/	or $r0 addr /*

*/	ld b32 reg D[$r0] /*

#define nv_wr32(addr,reg) /*

*/	push addr /*

*/	push reg /*

*/	pop $r13 /*

*/	pop $r14 /*

#define nv_wr32(addr,reg) /*

*/ 	sethi $r0 0x14000000 /*

*/	or $r0 addr /*

*/	st b32 D[$r0] reg /*

#define st(size, addr, reg) /*

*/	imm32($r0, addr) /*

*/	st size D[$r0] reg /*

#define ld(size, reg, addr) /*

*/	imm32($r0, addr)  /*

*/	ld size reg D[$r0] /*

 does a 64+64 -> 64 unsigned addition (C = A + B)

#define addu64(reg_a_c_hi, reg_a_c_lo, b_hi, b_lo) /*

*/    add b32 reg_a_c_lo b_lo /*

 does a 64+64 -> 64 substraction (C = A - B)

#define subu64(reg_a_c_hi, reg_a_c_lo, b_hi, b_lo) /*

*/    sub b32 reg_a_c_lo b_lo /*

/*

 * Copyright 2014 Martin Peres <martin.peres@free.fr>

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the folloing conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

/******************************************************************************

 * arith data segment

/******************************************************************************

 * arith code segment

 does a 32x32 -> 64 multiplication



 A * B = A_lo * B_lo

        + ( A_hi * B_lo ) << 16

        + ( A_lo * B_hi ) << 16

        + ( A_hi * B_hi ) << 32



 $r15 - current

 $r14 - A

 $r13 - B

 $r12 - mul_lo (return)

 $r11 - mul_hi (return)

 $r0  - zero

 A_hi

 B_hi

 tmp0

 tmp1

 A_lo * B_lo

 ( A_hi * B_lo ) << 16

 tmp0 = A_hi * B_lo

 tmp0 = tmp0_lo

 tmp1 = tmp0_hi

 ( A_lo * B_hi ) << 16

 tmp0 = A_lo * B_hi

 tmp0 = tmp0_lo

 tmp1 = tmp0_hi

 ( A_hi * B_hi ) << 32

 tmp0 = A_hi * B_hi

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * PERF data segment

/******************************************************************************

 * PERF code segment

 description



 $r15 - current (perf)

 $r14 - sender process name

 $r13 - message

 $r12 - data0

 $r11 - data1

 $r0  - zero

 description



 $r15 - current (perf)

 $r0  - zero

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * TEST data segment

/******************************************************************************

 * TEST code segment

 description



 $r15 - current (test)

 $r14 - sender process name

 $r13 - message

 $r12 - data0

 $r11 - data1

 $r0  - zero

 description



 $r15 - current (test)

 $r0  - zero

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * HOST data segment

 HOST (R)FIFO packet format

 HOST HOST->PWR queue description

 log2(size of queue entry in bytes)

 log2(max number of entries in queue)

 max number of entries in queue

 #fifo_qsize

 HOST PWR->HOST queue description

 log2(size of queue entry in bytes)

 log2(max number of entries in queue)

 max number of entries in queue

 #rfifo_qsize

/******************************************************************************

 * HOST code segment

 HOST->PWR comms - dequeue message(s) for process(es) from FIFO



 $r15 - current (host)

 $r0  - zero

 calculate address of message

 read message data, and pass to appropriate process

 increment GET

 PWR->HOST comms - enqueue message for HOST to RFIFO



 $r15 - current (host)

 $r14 - process

 $r13 - message

 $r12 - message data 0

 $r11 - message data 1

 $r0  - zero

 message from intr handler == HOST->PWR comms pending

 wait for space in RFIFO

 enqueue message

 notify host of pending message

 $r15 - current (host)

 $r0  - zero

 store each fifo's base/size in H2D/D2H scratch regs

 enable fifo subintr for first fifo

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * kernel data segment

/******************************************************************************

 * kernel code segment

 read nv register



 $r15 - current

 $r14 - addr

 $r13 - data (return)

 $r0  - zero

 write nv register



 $r15 - current

 $r14 - addr

 $r13 - data

 $r0  - zero

 busy-wait for a period of time



 $r15 - current

 $r14 - ns

 $r0  - zero

 busy-wait for a period of time



 $r15 - current

 $r14 - addr

 $r13 - mask

 $r12 - data

 $r11 - timeout (ns)

 $r0  - zero

 $r15 - current (kern)

 $r14 - process

 $r8  - NV_PPWR_INTR

 read process' timer status, skip if not enabled

 subtract last timer's value from process' timer,

 if it's <= 0 then the timer has expired

 otherwise, update the next timer's value if this

 process' timer is the soonest

 ... or if there's no next timer yet

 update process' timer status, and advance

 calculate the number of ticks in the specified nanoseconds delay



 $r15 - current

 $r14 - ns

 $r14 - ticks (return)

 $r0  - zero

 try not losing precision (multiply then divide) */

 use an immeditate, it's ok because HW_TICKS_PER_US < 16 bits */

 check if there wasn't any overflow */

 let's divide then multiply, too bad for the precision! */

 this cannot overflow as long as HW_TICKS_PER_US < 1000 */

 calculate the number of ticks in the specified microsecond delay



 $r15 - current

 $r14 - us

 $r14 - ticks (return)

 $r0  - zero

 simply multiply $us by HW_TICKS_PER_US */

 check if there wasn't any overflow */

 Overflow! */

 calculate the number of ticks in the specified microsecond delay



 $r15 - current

 $r14 - ticks

 $r14 - us (return)

 $r0  - zero

 simply divide $ticks by HW_TICKS_PER_US */

 request the current process be sent a message after a timeout expires



 $r15 - current

 $r14 - ticks (make sure it is < 2^31 to avoid any possible overflow)

 $r0  - zero

 interrupts off to prevent racing with timer isr

 if current process already has a timer set, bail

 halt watchdog timer temporarily

 find out how much time elapsed since the last update

 of the watchdog and add this time to the wanted ticks

 check for a pending interrupt.  if there's one already

 pending, we can just bail since the timer isr will

 queue the next soonest right after it's done

 update the watchdog if this timer should expire first,

 or if there's no timeout already set

 re-enable the watchdog timer

 interrupts back on

 send message to another process



 $r15 - current

 $r14 - process

 $r13 - message

 $r12 - message data 0

 $r11 - message data 1

 $r0  - zero

 check for space in queue

 enqueue message

 increment PUT

 lookup process structure by its name



 $r15 - current

 $r14 - process name

 $r0  - zero



 $r14 - process

 $p1  - success

 send message to another process



 $r15 - current

 $r14 - process id

 $r13 - message

 $r12 - message data 0

 $r11 - message data 1

 $r0  - zero

 process single message for a given process



 $r15 - current

 $r14 - process

 $r0  - zero

 dequeue message

 process it

 setup stack

 somehow allows the magic "access mmio via D[]" stuff that's

 used by the nv_rd32/nv_wr32 macros to work

 route all interrupts except user0/1 and pause to fuc

 enable watchdog and subintr intrs

 enable interrupts globally

 enable watchdog timer

 bootstrap processes, idle process will be last, and not return

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * I2C_ data segment

/******************************************************************************

 * I2C_ code segment

 $r3  - value

 $r2  - sda line

 $r1  - scl line

 $r0  - zero

#define i2c_drive_scl(v) /*

*/	mov $r3 (v) /*

#define i2c_drive_sda(v) /*

*/	mov $r3 (v) /*

#define i2c_sense_scl() /*

#define i2c_sense_sda() /*

#define i2c_delay(v) /*

*/	mov $r14 (v) /*

#define i2c_trace_init() /*

*/	imm32($r6, 0x10000000) /*

*/	sub b32 $r7 $r6 1 /*

#define i2c_trace_down() /*

*/	shr b32 $r6 4 /*

*/	push $r5 /*

*/	shl b32 $r5 $r6 4 /*

*/	sub b32 $r5 $r6 /*

*/	not b32 $r5 /*

*/	and $r7 $r5 /*

*/	pop $r5 /*

#define i2c_trace_exit() /*

*/	shl b32 $r6 4 /*

#define i2c_trace_next() /*

*/	add b32 $r7 $r6 /*

#define i2c_trace_call(func) /*

*/	i2c_trace_next() /*

*/	i2c_trace_down() /*

*/	call(func) /*

*/	i2c_trace_exit() /*

 $r3  - value

 $r2  - sda line

 $r1  - scl line

 $r0  - zero

 $r3  - value (out)

 $r2  - sda line

 $r1  - scl line

 $r0  - zero

 nack

 description



 $r15 - current (i2c)

 $r14 - sender process name

 $r13 - message

 $r12 - data0

 $r11 - data1

 $r0  - zero

 description



 $r15 - current (i2c)

 $r0  - zero

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * MEMX data segment

#define handler(cmd,hdr,len,func) /*

*/	.b16 MEMX_##cmd /*

*/	.b16 hdr /*

*/	.b16 len /*

*/      .b16 0 /*

/******************************************************************************

 * MEMX code segment

 description



 $r15 - current (memx)

 $r4  - packet length

 $r3  - opcode desciption

 $r0  - zero

 description



 $r15 - current (memx)

 $r4  - packet length

 $r3  - opcode desciption

 $r0  - zero

 description



 $r15 - current (memx)

 $r4  - packet length

	+00: head to wait for vblank on

 $r3  - opcode desciption

 $r0  - zero

 XXX: currently no-op



 $r15 - current (memx)

 $r4  - packet length

	+00: head to wait for vblank on

 $r3  - opcode desciption

 $r0  - zero

 description



 $r15 - current (memx)

 $r4  - packet length

	+00*n: addr

	+04*n: data

 $r3  - opcode desciption

 $r0  - zero

 description



 $r15 - current (memx)

 $r4  - packet length

	+00: addr

	+04: mask

	+08: data

	+0c: timeout (ns)

 $r3  - opcode desciption

 $r0  - zero

 description



 $r15 - current (memx)

 $r4  - packet length

	+00: time (ns)

 $r3  - opcode desciption

 $r0  - zero

 description



 $r15 - current (memx)

 $r4  - packet length

 $r3  - opcode desciption

 $r0  - zero

 $r5 - outer loop counter

 $r6 - inner loop counter

 $r7 - entry counter (#memx_train_head + $r7)

 Read random memory to wake up... things

 $r5 - inner inner loop counter

 $r9 - result

 description



 $r15 - current (memx)

 $r14 - sender process name

 $r13 - message (exec)

 $r12 - head of script

 $r11 - tail of script

 $r0  - zero

 fetch the packet header

 execute the opcode handler

 keep going, if we haven't reached the end

 send completion reply

 description



 $r15 - current (memx)

 $r14 - sender process name

 $r13 - message

 $r12 - data0

 $r11 - data1

 $r0  - zero

 description



 $r15 - current (memx)

 $r14 - sender process name

 $r13 - message

 $r12 - data0

 $r11 - data1

 $r0  - zero

 description



 $r15 - current (memx)

 $r0  - zero

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * IDLE data segment

/******************************************************************************

 * IDLE code segment

 description



 $r15 - current (idle)

 $r14 - message

 $r0  - zero

 description



 $r15 - current (idle)

 $r0  - zero

 set our "no interrupt has occurred during our execution" flag

 count IDLE invocations for debugging purposes

 keep looping while there's pending messages for any process

 process the process' messages until there's none left

 next process!

 sleep if no interrupts have occurred

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 BAR2 */

 BAR1 */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 NFI why it's twice. */

	/*

	 * Bootstrap page table lookup.

 BAR2 */

 BAR1 */

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* Denies access to BAR2 when it's not initialised, used by INSTMEM

	 * to know when object access needs to go through the BAR0 window.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright (c) 2014, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2010 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* 0x01: no bank swizzle

	 * 0x02: bank swizzled

	 * 0x7f: invalid

	 *

	 * 0x01/0x02 are values understood by the VRAM allocator,

	 * and are required to avoid mixing the two types within

	 * a certain range.

 0x00 */

 0x10 */

 0x20 */

 0x30 */

 0x40 */

 0x50 */

 0x60 */

 0x70 */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* calculate vram address of this PRAMIN block, object must be

	 * allocated on 512KiB alignment, and not exceed a total size

	 * of 512KiB for this to work correctly

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2010 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/* Map from compressed to corresponding uncompressed storage type.

 * The value 0xff represents an invalid storage type.

 0x00 */

 0x10 */

 0x20 */

 0x30 */

 0x40 */

 0x50 */

 0x60 */

 0x70 */

 0x80 */

 0x90 */

 0xa0 */

 0xb0 */

 0xc0 */

 0xd0 */

 0xe0 */

 0xf0 */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 VALID. */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 VOL */

 VOL */

	/* Looks like maybe a "free flush slots" counter, the

	 * faster you write to 0x100cbc to more it decreases.

 ALL_PDB. */) {

 Wait for flush to be queued? */

 PAGE_ALL */

 HUB_ONLY */

 VOL. */;

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2010 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* If there were no free slots in the parent allocation before,

	 * there will be now, so return PTP to the cache.

 If there's no more sub-allocations, destroy PTP. */

 Need to allocate a new parent to sub-allocate from. */

	/* Sub-allocate from parent object, removing PTP from cache

	 * if there's no more free slots left.

 Handle sub-allocated page tables. */

 Either cache or free the object. */

 Heuristic. */ && !force) {

 Sub-allocated page table (ie. GP100 LPT). */

 Lookup cache for this page table size. */

 If there's a free PT in the cache, reuse it. */

 No such luck, we need to allocate. */

 Non-mappable system memory. */

	/* Non-coherent, cached, system memory.

	 *

	 * Block-linear mappings of system memory must be done through

	 * BAR1, and cannot be supported on systems where we're unable

	 * to map BAR1 with write-combining.

	/* Coherent, cached, system memory.

	 *

	 * Unsupported on systems that aren't able to support snooped

	 * mappings, and also for block-linear mappings which must be

	 * done through BAR1.

 Uncached system memory. */

 Mixed-memory doesn't support compression or display. */

	/* Add non-mappable VRAM types first so that they're preferred

	 * over anything else.  Mixed-memory will be slower than other

	 * heaps, it's prioritised last.

	/* Add host memory types next, under the assumption that users

	 * wanting mappable memory want to use them as staging buffers

	 * or the like.

	/* Mappable VRAM types go last, as they're basically the worst

	 * possible type to ask for unless there's no other choice.

 Write-combined BAR1 access. */

 Uncached BAR1 access. */

 Determine available memory types. */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 PRESENT, RW. */

 PCI, RW, PT, !LN */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 * Copyright 2019 NVIDIA Corporation.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 0x00 */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Recurse up the tree, unreferencing/destroying unneeded PDs. */

 PD has other valid PDEs, so we need a proper update. */

 PDE no longer required. */

				/* Special handling for Tesla-class GPUs,

				 * where there's no central PD, but each

				 * instance has its own embedded PD.

			/* PDE was pointing at dual-PTs and we're removing

			 * one of them, leaving the other in place.

 GPU may have cached the PTs, flush before freeing. */

 PD has no valid PDEs left, so we can just destroy it. */

 Destroy PD/PT. */

	/* Determine how many SPTEs are being touched under each LPTE,

	 * and drop reference counts.

 We're done here if there's no corresponding LPT. */

 Skip over any LPTEs that still have valid SPTEs. */

		/* As there's no more non-UNMAPPED SPTEs left in the range

		 * covered by a number of LPTEs, the LPTEs once again take

		 * control over their address range.

		 *

		 * Determine how many LPTEs need to transition state.

			/* If the MMU supports it, restore the LPTE to the

			 * INVALID state to tell the MMU there is no point

			 * trying to fetch the corresponding SPTEs.

 Need to clear PTE valid bits before we dma_unmap_page(). */

 GPU may have cached the PT, flush before unmap. */

 Drop PTE references. */

 Dual-PTs need special handling, unless PDE becoming invalid. */

 PT no longer neeed?  Destroy it. */

 PTE writes for unmap() not necessary. */

	/* Determine how many SPTEs are being touched under each LPTE,

	 * and increase reference counts.

 We're done here if there's no corresponding LPT. */

 Skip over any LPTEs that already have valid SPTEs. */

		/* As there are now non-UNMAPPED SPTEs in the range covered

		 * by a number of LPTEs, we need to transfer control of the

		 * address range to the SPTEs.

		 *

		 * Determine how many LPTEs need to transition state.

			/* The entire LPTE is marked as sparse, we need

			 * to make sure that the SPTEs are too.

 Sparse LPTEs prevent SPTEs from being accessed. */

			/* MMU supports blocking SPTEs by marking an LPTE

			 * as INVALID.  We need to reverse that here.

 Take PTE references. */

 Dual-PTs need special handling. */

		/* SPT already exists covering the same range as this LPT,

		 * which means we need to be careful that any LPTEs which

		 * overlap valid SPTEs are unmapped as opposed to invalid

		 * or sparse, which would prevent the MMU from looking at

		 * the SPTEs on some GPUs.

 Deconstruct address into PTE indices for each mapping level. */

 Depth-first traversal of page tables. */

 Walk down the tree, finding page tables for each level. */

 Software PT. */

			/* Hardware PT.

			 *

			 * This is a separate step from above due to GF100 and

			 * newer having dual page tables at some levels, which

			 * are refcounted independently.

 Handle PTE updates. */

 Walk back up the tree to the next position. */

	/* Reconstruct the failure address so the caller is able to

	 * reverse any partially completed operations.

 Limit maximum page size based on remaining size. */

 Find largest page size suitable for alignment. */

 Determine number of PTEs at this page size. */

 Limited to alignment boundary of next page size. */

 Perform operation. */

	/* Locate the smallest page size supported by the backend, it will

	 * have the the deepest nesting of page tables.

	/* Locate the structure that describes the layout of the top-level

	 * page table, and determine the number of valid bits in a virtual

	 * address.

 Allocate top-level page table. */

	/* ... and the GPU storage for it, except on Tesla-class GPUs that

	 * have the PD embedded in the instance structure.

 Initialise address-space MM. */

		/* Address-space will be managed by the client for the most

		 * part, except for a specified area where NVKM allocations

		 * are allowed to be placed.

 Client-managed area before the NVKM-managed area. */

 NVKM-managed area. */

 Client-managed area after the NVKM-managed area. */

		/* Address-space fully managed by NVKM, requiring calls to

		 * nvkm_vmm_get()/nvkm_vmm_put() to allocate address-space.

/*TODO:

 * - Avoid PT readback (for dma_unmap etc), this might end up being dealt

 *   with inside HMM, which would be a lot nicer for us to deal with.

 * - Support for systems without a 4KiB page size.

	/* Only support mapping where the page size of the incoming page

	 * array matches a page size available for direct mapping.

		/* Narrow the operation window to cover a single action (page

		 * should be mapped or not) within a single VMA.

		/* Reject any operation to unmanaged regions, and areas that

		 * have nvkm_memory objects mapped in them already.

		/* In order to both properly refcount GPU page tables, and

		 * prevent "normal" mappings and these direct mappings from

		 * interfering with each other, we need to track contiguous

		 * ranges that have been mapped with this interface.

		 *

		 * Here we attempt to either split an existing VMA so we're

		 * able to flag the region as either unmapped/mapped, or to

		 * merge with adjacent VMAs that are already compatible.

		 *

		 * If the region is already compatible, nothing is required.

 Update HW page tables. */

 Iterate to next operation. */

			/* Failure is signalled by clearing the valid bit on

			 * any PFN that couldn't be modified as requested.

 Make sure we won't overrun the end of the memory object. */

 Check remaining arguments for validity. */

 Find the largest page size we can perform the mapping at. */

 Page size of the VMA is already pre-determined. */

 Deal with the 'offset' argument, and fetch the backend function. */

 Perform the map. */

 Merge regions that are in the same state. */

				/* Region(s) are mapped, merge the unmap

				 * and dereference into a single walk of

				 * the page tree.

 Drop allocation-time PTE references. */

	/* Merge any mapped regions that were split from the initial

	 * address-space allocation back into the allocated VMA, and

	 * release memory/compression resources.

		/* Sparse region that was allocated with a fixed page size,

		 * meaning all relevant PTEs were referenced once when the

		 * region was allocated, and remained that way, regardless

		 * of whether memory was mapped into it afterwards.

		 *

		 * The process of unmapping, unsparsing, and dereferencing

		 * PTEs can be done in a single page tree walk.

		/* Sparse region that wasn't allocated with a fixed page size,

		 * PTE references were taken both at allocation time (to make

		 * the GPU see the region as sparse), and when mapping memory

		 * into the region.

		 *

		 * The latter was handled above, and the remaining references

		 * are dealt with here.

 Remove VMA from the list of allocated nodes. */

 Merge VMA back into the free list. */

 Zero-sized, or lazily-allocated sparse VMAs, make no sense. */

	/* Tesla-class GPUs can only select page size per-PDE, which means

	 * we're required to know the mapping granularity up-front to find

	 * a suitable region of address-space.

	 *

	 * The same goes if we're requesting up-front allocation of PTES.

	/* If a specific page size was requested, determine its index and

	 * make sure the requested size is a multiple of the page size.

 Locate smallest block that can possibly satisfy the allocation. */

	/* Take into account alignment restrictions, trying larger blocks

	 * in turn until we find a suitable free block.

	/* If the VMA we found isn't already exactly the requested size,

	 * it needs to be split, and the remaining free blocks returned.

 Pre-allocate page tables and/or setup sparse mappings. */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 VALID_FALSE + PRIV tells the MMU to ignore corresponding SPTEs. */

 PRIV. */, ptes);

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 VALID_FALSE + VOL tells the MMU to treat the PTE as sparse. */

 VOL. */, ptes);

 VALID_FALSE + VOL_BIG tells the MMU to treat the PDE as sparse. */

 VOL_BIG. */, pdes);

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 unfortunate hw bug workaround... */

 Valid. */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 0x00 */

 0x10 */

 0x20 */

 0x30 */

 0x40 */

 0x50 */

 0x60 */

 0x70 */

 0x80 */

 0x90 */

 0xa0 */

 0xb0 */

 0xc0 */

 0xd0 */

 0xe0 */

 0xf0 */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 RO. */

 Atomic disable. */

 SYSTEM_COHERENT_MEMORY. */

 VOL. */

 VALID. */

 VALID. */

 VALID_FALSE + VOL tells the MMU to treat the PTE as sparse. */

 VOL. */, ptes);

 VALID_FALSE + PRIV tells the MMU to ignore corresponding SPTEs. */

 PRIV. */, ptes);

 VOL. */

 VALID_FALSE + VOL_BIG tells the MMU to treat the PDE as sparse. */

 VOL_BIG. */, 0ULL, pdes);

 RO. */

 Atomic disable. */

 SYSTEM_COHERENT_MEMORY. */

 VOL. */

 VALID. */

 VALID. */

	/* Translate MaxwellFaultBufferA instance pointer to the same

	 * format as the NV_GR_FECS_CURRENT_CTX register.

 CANCEL_TARGETED. */ |

 REPLAY_GLOBAL. */

 CACHE_LEVEL_UP_TO_PDE3 */ - depth) << 24;

 HUB_ONLY */

 PAGE_ALL */

 VER2 */ | BIT_ULL(11) 
 FAULT_REPLAY_TEX */

 FAULT_REPLAY_GCC */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Successful map will clear vma->busy. */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 CACHE_LEVEL_UP_TO_PDE3 */ - depth) << 24;

 PAGE_ALL */

 HUB_ONLY */

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 put nvdec in clean state - without reset it will remain in HS mode */

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 decode status bits into something more useful */

	/* Not a clue what this is exactly.  Without pointing it at a

	 * scratch page, VRAM->GART blits with M2MF (as in DDX DFS)

	 * cause IOMMU "read from address 0" errors (rh#561267)

	/* This is needed to get meaningful information from 100c90

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* Enable NISO poller for various clients and set their associated

	 * read address, only for MCP77/78 and MCP79/7A. (fd#27501)

 vga memory */

 vbios etc + poller mem */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 mode = vram */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Z24S8_SPLIT_GRAD */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Z16 */

 Z24S8 */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 MR0 - MR8, MR15 */

/*******************************************************************************

 * GDDR5

 (re)program refpll, if required */

 (re)program mempll, if required */

 MR1: turn termination on early, for some reason.. */

 REFRESH_AUTO = 0 */

 REFRESH */

 PRECHARGE */

	/*XXX: there does appear to be some kind of condition here, simply

	 *     modifying these bits in the vbios from the default pl0

	 *     entries shows no change.  however, the data does appear to

	 *     be correct and may be required for the transition back

XXX: Titan */)

XXX*/ {

 PFB timing */

	/*XXX: see note above about there probably being some condition

	 *     for the 10f824 stuff that uses ramcfg 3...

 PRECHARGE */

 REFRESH */

 REFRESH_AUTO = 1 */

XXX*/) {

XXX*/

 LP3 later */

 NOP? */

 XXX: not always? */

XXX*/

 LP3 */

/*******************************************************************************

 * DDR3

 PRECHARGE */

 REFRESH_AUTO = 0 */

 REFRESH */

 REFRESH */

	/*XXX: there does appear to be some kind of condition here, simply

	 *     modifying these bits in the vbios from the default pl0

	 *     entries shows no change.  however, the data does appear to

	 *     be correct and may be required for the transition back

 (re)program refpll, if required */

XXX*/ {

 PFB timing */

	/*XXX: see note above about there probably being some condition

	 *     for the 10f824 stuff that uses ramcfg 3...

 PRECHARGE */

 REFRESH */

 REFRESH_AUTO = 1 */

 NOP? */

/*******************************************************************************

 * main hooks

 M has to be 1, otherwise it gets unstable */

 can be 1 or 2, sticking with 1 for simplicity */

 we found a better combination */

 adjust fN to get closer to the target clock */

	/* XXX: this is *not* what nvidia do.  on fermi nvidia generally

	 * select, based on some unknown condition, one of the two possible

	 * reference frequencies listed in the vbios table for mempll and

	 * program refpll to that frequency.

	 *

	 * so far, i've seen very weird values being chosen by nvidia on

	 * kepler boards, no idea how/why they're chosen.

 calculate refpll coefficients */

 determine type of data for this index */

 training data index determined by ramcfg strap */

 training data format information */

 ... and the raw data */

		/* of course! why wouldn't we have a pointer to another entry

		 * in the same table, and use the first one as an array of

		 * remap indices...

	/* run a bunch of tables from rammap table.  there's actually

	 * individual pointers for each rammap entry too, but, nvidia

	 * seem to just run the last two entries' scripts early on in

	 * their init, and never again.. we'll just run 'em all once

	 * for now.

	 *

	 * i strongly suspect that each script is for a separate mode

	 * (likely selected by 0x10f65c's lower bits?), and the

	 * binary driver skips the one that's already been setup by

	 * the init tables.

 guess at count */

 guess u32... */

 memory config data for a range of target frequencies */

 ... and a portion specific to the attached memory */

 lookup memory timings, if bios says they're present */

	/* calculate a mask of differently configured memory partitions,

	 * because, of course reclocking wasn't complicated enough

	 * already without having to treat some of them differently to

	 * the others....

	/* parse bios data for all rammap table entries up-front, and

	 * build information on whether certain fields differ between

	 * any of the entries.

	 *

	 * the binary driver appears to completely ignore some fields

	 * when all entries contain the same value.  at first, it was

	 * hoped that these were mere optimisations and the bios init

	 * tables had configured as per the values here, but there is

	 * evidence now to suggest that this isn't the case and we do

	 * need to treat this condition as a "don't touch" indicator.

 parse bios data for both pll's */

 lookup memory voltage gpios */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 XXX: N=1 is not proper statistics */

 Timing 6 is already done above */

 XXX: P.version == 1 only has DDR2 and GDDR3? */

 Derive the bare minimum for the MR calculation to succeed */

 lookup closest matching performance table entry for frequency */

 locate specific data set for the attached memory */

 lookup memory timings, if bios says they're present */

 Determine ram-specific MR values */

 Always disable this bit during reclock */

 block fifo */

 disable fb */

 wait for fb disabled */

 precharge */

 refresh */

 refresh */

 disable auto-refresh */

 enable self-refresh */

 XXX: 750MHz seems rather arbitrary */

	/* XXX: Is rammap_00_16_40 the DLL bit we've seen in GT215? Why does

 XXX: GDDR3 only? */

XXX*/

XXX*/

 disable self-refresh */

 disable self-refresh */

 enable auto-refresh */

 force update */

 force update */

 force update */

 XXX: A lot of this could be "chipset"/"ram type" specific stuff */

	/* XXX: G94 does not even test these regs in trace. Harmless we do it,

 Reset DLL */

 enable fb */

 wait for fb enabled */

 un-block fifo */

 vga memory */

 vbios etc */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 for performance, select alternate bank offset for zeta */

 mode = vram */

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Z16 */

 Z24S8 */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 Disable address remapper. */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* Initialise compression tag allocator.

	 *

	 * LTC oneinit() will override this on Fermi and newer.

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Z16 */

 Z24S8 */

/*

 * Copyright 2014 Roy Spliet

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Roy Spliet <rspliet@eclipso.eu>

 *          Ben Skeggs

 The following are available in some, but not all DDR2 docs */

 The following are available in some, but not all DDR2 docs */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Z16 */

 Z24S8 */

 enable */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* This is what the DDX did for NV_ARCH_04, but a mmio-trace shows

	 * nvidia reading PFB_CFG_0, then writing back its original value.

	 * (which was 0x701114 in this case)

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 GM20B's FB is similar to GM200, but without the ability to allocate VRAM */

 per-instance. */,

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 * 	    Roy Spliet <rspliet@eclipso.eu>

 the below are mentioned in some, but not all, gddr3 docs */

 XXX: Per Samsung docs, are these used? They overlap with Qimonda */

	/* { 4, 4 }, { 5, 5 }, { 6, 6 }, { 12, 8 }, { 13, 9 }, { 14, 10 },

 the below are mentioned in some, but not all, gddr3 docs */

 XXX: Get these values from the VBIOS instead */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 *          Lyude Paul

/*

 *******************************************************************************

 * PGRAPH registers for clockgating

 *******************************************************************************

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* run a bunch of tables from rammap table.  there's actually

	 * individual pointers for each rammap entry too, but, nvidia

	 * seem to just run the last two entries' scripts early on in

	 * their init, and never again.. we'll just run 'em all once

	 * for now.

	 *

	 * i strongly suspect that each script is for a separate mode

	 * (likely selected by 0x9a065c's lower bits?), and the

	 * binary driver skips the one that's already been setup by

	 * the init tables.

 guess at count */

 guess u32... */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 * 	    Roy Spliet <rspliet@eclipso.eu>

 the below are mentioned in some, but not all, ddr3 docs */

 the below are mentioned in some, but not all, ddr3 docs */

 the below are mentioned in some, but not all, ddr3 docs */

 XXX: NV50: Get CWL from the timing register */

 XXX: Get these values from the VBIOS instead */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/* binary driver only executes this path if the condition (a) is true

 * for any configuration (combination of rammap+ramcfg+timing) that

 * can be reached on a given card.  for now, we will execute the branch

 * unconditionally in the hope that a "false everywhere" in the bios

 * tables doesn't actually mean "don't touch this".

 XXX */

	/* this seems wrong, alternate field used for the broadcast

	 * on nuts vs non-nuts configs..  meh, it matches for now.

 binary driver does this.. bug? */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 per-instance. */,

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 * 	    Roy Spliet <rspliet@eclipso.eu>

 Find the best value for 0x1111e0 */

/*

 * Link training for (at least) DDR3

 XXX: Multiple partitions? */

 Clock speeds for training and back */

 First: clock up/down */

 Do this *after* calc, eliminates write in script */

 XXX: Magic writes that improve train reliability? */

 Now the training script */

 Reset */

 Post-processing, avoids flicker */

	/* We support type "5"

 And upload the pattern */

/*

 * RAM reclocking

 lookup memory config data relevant to the target frequency */

 locate specific data set for the attached memory */

 lookup memory timings, if bios says they're present */

 Determine ram-specific MR values */

 XXX: 750MHz seems rather arbitrary */

 pll2pll requires to switch to a safe clock first */

 Pre, NVIDIA does this outside the script */

 Always disable this bit during reclock */

 If switching from non-pll to pll, lock before disabling FB */

 Start with disabling some CRTCs and PFIFO? */

 XXX: or longer? */

 If we're disabling the DLL, do it now */

 Brace RAM for impact */

	/* Alter FBVDD/Q, apparently must be done with PLL disabled, thus

 Fiddle with clocks */

	/* There's 4 scenario's

	 * pll->pll: first switch to a 324MHz clock, set up new PLL, switch

	 * clk->pll: Set up new PLL, switch

	 * pll->clk: Set up clock, switch

 Switch to regular clock - 324MHz */

 Final switch */

 Set RAM MR parameters and timings */

 Misc */

 XXX: A lot of "chipset"/"ram type" specific stuff...? */

 NVA8 seems to skip various bits related to ramcfg_10_02_04 */

 Reset DLL */

 Re-enable FB */

 Post fiddlings */

 Post-processing, avoids flicker */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 lookup memory config data relevant to the target frequency */

 locate specific data set for the attached memory */

 lookup memory timings, if bios says they're present */

 determine current mclk configuration */

XXX: ok? */

 determine target mclk configuration */

XXX*/) {

 0x00020034 
 calculate refpll */

 calculate mempll */

 0x00020039 
 0x0002003a 
 0x00030014  0x02b5f070

 0x00030014  0x02b5f070

 0x00020034 
 0x00030020  0x00000000

 0x00020039 
 0x00030020  0x00000000

 0x00020034 
 0x00020039 
 0x00030020  0x00000000

 0x00020034 
 0x00020016 
 prepare for ddr link training, and load training patterns */

 vga memory */

 vbios etc */

	/* Some GPUs are in what's known as a "mixed memory" configuration.

	 *

	 * This is either where some FBPs have more memory than the others,

	 * or where LTCs have been disabled on a FBP.

 The common memory amount is addressed normally. */

		/* And the rest is much higher in the physical address

		 * space, and may not be usable for certain operations.

 GPUs without mixed-memory are a lot nicer... */

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2014-2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 GK20A's FB is similar to GF100's, but without the ability to allocate VRAM */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 for performance, select alternate bank offset for zeta */

 z compression */

 enable */

 Z16 */

 Z24S8 */

 Init the memory timing regs at 0x10037c/0x1003ac */

 Related to ROP count */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 determine which CRTCs are active, fetch VGA_SR1 for each */

 wait for vblank start on active crtcs, disable memory access */

 prepare ram for reclocking */

 precharge */

 refresh */

 refresh */

 no auto refresh */

 enable self-refresh */

 change the PLL of each memory partition */

 re-enable normal operation of memory controller */

 execute memory reset script from vbios */

	/* make sure we're in vblank (hopefully the same one as before), and

	 * then re-enable crtc memory access

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Lyude Paul

/*

 *******************************************************************************

 * PGRAPH registers for clockgating

 *******************************************************************************

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Mappings that can be evicted when BAR2 space has been exhausted. */

/******************************************************************************

 * instmem object implementation

	/* Attempt to allocate BAR2 address-space and map the object

	 * into it.  The lock has to be dropped while doing this due

	 * to the possibility of recursion for page table allocation.

		/* Evict unused mappings, and keep retrying until we either

		 * succeed,or there's no more objects left on the LRU.

 We either failed, or another thread beat us. */

 Make the mapping visible to the host. */

		/* Add the now-unused mapping to the LRU instead of directly

		 * unmapping it here, in case we need to map it again later.

 Switch back to NULL accessors when last map is gone. */

 Already mapped? */

	/* Take the lock, and re-check that another thread hasn't

	 * already mapped the object in the meantime.

 Attempt to get a direct CPU mapping of the object. */

 Exclude object from eviction while it's being accessed. */

	/* Exclude bootstrapped objects (ie. the page tables for the

	 * instmem BAR itself) from eviction.

 Exclude from eviction. */

 Can be NULL during BAR destructor. */

/******************************************************************************

 * instmem subdev implementation

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * instmem object implementation

/******************************************************************************

 * instmem subdev implementation

	/* PRAMIN aperture maps over the end of vram, reserve enough space

	 * to fit graphics contexts for every channel, the magics come

	 * from engine/gr/nv40.c

 per-channel */

 pci(e)gart table */

 object storage */

 0x00000-0x10000: reserve for probable vbios image */

 0x10000-0x18000: reserve for RAMHT */

	/* 0x18000-0x18200: reserve for RAMRO

	 * 0x18200-0x20000: padding

	/* 0x20000-0x21000: reserve for RAMFC

	 * 0x21000-0x40000: padding and some unknown crap

 map bar */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * instmem object base implementation

/******************************************************************************

 * instmem subdev base implementation

	/* Separate bootstrapped objects from normal list, as we need

	 * to make sure they're accessed with the slowpath on suspend

	 * and resume.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * instmem object implementation

/******************************************************************************

 * instmem subdev implementation

 PRAMIN aperture maps over the end of VRAM, reserve it */

 0x00000-0x10000: reserve for probable vbios image */

 0x10000-0x18000: reserve for RAMHT */

 0x18000-0x18800: reserve for RAMFC (enough for 32 nv30 channels) */

 0x18800-0x18a00: reserve for RAMRO */

/*

 * Copyright (c) 2015, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * GK20A does not have dedicated video memory, and to accurately represent this

 * fact Nouveau will not create a RAM device for it. Therefore its instmem

 * implementation must be done directly on top of system memory, while

 * preserving coherency for read and write operations.

 *

 * Instmem can be allocated through two means:

 * 1) If an IOMMU unit has been probed, the IOMMU API is used to make memory

 *    pages contiguous to the GPU. This is the preferred way.

 * 2) If no IOMMU unit is probed, the DMA API is used to allocate physically

 *    contiguous memory.

 *

 * In both cases CPU read and writes are performed by creating a write-combined

 * mapping. The GPU L2 cache must thus be flushed/invalidated when required. To

 * be conservative we do this every time we acquire or release an instobj, but

 * ideally L2 management should be handled at a higher level.

 *

 * To improve performance, CPU mappings are not removed upon instobj release.

 * Instead they are placed into a LRU list to be recycled when the mapped space

 * goes beyond a certain threshold. At the moment this limit is 1MB.

 CPU mapping */

/*

 * Used for objects allocated using the DMA API

/*

 * Used for objects flattened using the IOMMU API

 to link into gk20a_instmem::vaddr_lru */

 how many clients are using vaddr? */

 will point to the higher half of pages */

 array of base.mem->size pages (+ dma_addr_ts) */

 protects vaddr_* and gk20a_instobj::vaddr* */

 CPU mappings LRU */

 Only used if IOMMU if present */

 Only used by DMA API */

/*

 * Recycle the vaddr of obj. Must be called with gk20a_instmem::lock held.

 there should not be any user left... */

/*

 * Must be called while holding gk20a_instmem::lock

 no candidate that can be unmapped, abort... */

 remove from LRU list since mapping in use again */

 try to free some address space if we reached the limit */

 map the pages */

 in case we got a write-combined mapping */

 we should at least have one user to release... */

 add unused objs to the LRU list to recycle their mapping */

 vaddr has already been recycled */

 clear IOMMU bit to unmap pages */

 Unmap pages from GPU address space and free them */

 Release area from GPU address space */

 alignment check */

 present memory for being mapped using small pages */

	/*

	 * despite their variable size, instmem allocations are small enough

	 * (< 1 page) to be handled by kzalloc

 Allocate backing memory */

 Reserve area from GPU address space */

 Map into GPU address space */

 IOMMU bit tells that an address is to be resolved through the IOMMU */

 Round size and align to page bounds */

 perform some sanity checks... */

 do not allow more than 1MB of CPU-mapped instmem */

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 everything on */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 everything enabled */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 everything on */

 everything out of ELPG */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 likely fallen off the bus */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 everything enabled */

 disable rom access */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/* Turing and above route the MMU fault interrupts via a different

	 * interrupt tree with different control registers. For the moment remap

	 * them back to the old PMC vector.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2016 Karol Herbst

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Karol Herbst

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* check we have gpio function info for each vid bit.  on some

	 * boards (ie. nvs295) the vid mask has more bits than there

	 * are valid gpio functions... from traces, nvidia appear to

	 * just touch the existing ones, so let's mask off the invalid

	 * bits and continue with life

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 0x0 handled above! */

 Assuming the non-bios device should build the voltage table later */

/*

 * Copyright 2019 Ilia Mirkin

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ilia Mirkin

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 KHz,             c0,      c1,   c2 */

  76800 */ { 1786666,  -85625, 1632 },

 153600 */ { 1846729,  -87525, 1632 },

 230400 */ { 1910480,  -89425, 1632 },

 307200 */ { 1977920,  -91325, 1632 },

 384000 */ { 2049049,  -93215, 1632 },

 460800 */ { 2122872,  -95095, 1632 },

 537600 */ { 2201331,  -96985, 1632 },

 614400 */ { 2283479,  -98885, 1632 },

 691200 */ { 2369315, -100785, 1632 },

 768000 */ { 2458841, -102685, 1632 },

 844800 */ { 2550821, -104555, 1632 },

 921600 */ { 2647676, -106455, 1632 },

 KHz,         c0,     c1,   c2,    c3,     c4,   c5 */

  76800 */ {  814294, 8144, -940, 808, -21583, 226 },

 153600 */ {  856185, 8144, -940, 808, -21583, 226 },

 230400 */ {  898077, 8144, -940, 808, -21583, 226 },

 307200 */ {  939968, 8144, -940, 808, -21583, 226 },

 384000 */ {  981860, 8144, -940, 808, -21583, 226 },

 460800 */ { 1023751, 8144, -940, 808, -21583, 226 },

 537600 */ { 1065642, 8144, -940, 808, -21583, 226 },

 614400 */ { 1107534, 8144, -940, 808, -21583, 226 },

 691200 */ { 1149425, 8144, -940, 808, -21583, 226 },

 768000 */ { 1191317, 8144, -940, 808, -21583, 226 },

 844800 */ { 1233208, 8144, -940, 808, -21583, 226 },

 921600 */ { 1275100, 8144, -940, 808, -21583, 226 },

 998400 */ { 1316991, 8144, -940, 808, -21583, 226 },

   0,      1,      2,      3,      4, */

/*

 * Copyright 2015 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 the blob uses this crystal frequency, let's use it too. */

	/* now that we have a subdev, we can show an error if we found through

	 * the voltage table that we were supposed to use the PWN mode but we

	 * did not find the right GPIO for it.

/*

 * Copyright (c) 2014-2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 MHz,        c0,     c1,   c2,    c3,     c4,   c5 */

  72 */ { 1209886, -36468,  515,   417, -13123,  203},

 108 */ { 1130804, -27659,  296,   298, -10834,  221},

 180 */ { 1162871, -27110,  247,   238, -10681,  268},

 252 */ { 1220458, -28654,  247,   179, -10376,  298},

 324 */ { 1280953, -30204,  247,   119,  -9766,  304},

 396 */ { 1344547, -31777,  247,   119,  -8545,  292},

 468 */ { 1420168, -34227,  269,    60,  -7172,  256},

 540 */ { 1490757, -35955,  274,    60,  -5188,  197},

 612 */ { 1599112, -42583,  398,     0,  -1831,  119},

 648 */ { 1366986, -16459, -274,     0,  -3204,   72},

 684 */ { 1391884, -17078, -274,   -60,  -1526,   30},

 708 */ { 1415522, -17497, -274,   -60,   -458,    0},

 756 */ { 1464061, -18331, -274,  -119,   1831,  -72},

 804 */ { 1524225, -20064, -254,  -119,   4272, -155},

 852 */ { 1608418, -21643, -269,     0,    763,  -48},

/**

 * cvb_mv = ((c2 * speedo / s_scale + c1) * speedo / s_scale + c0)

/**

 * cvb_t_mv =

 * ((c2 * speedo / s_scale + c1) * speedo / s_scale + c0) +

 * ((c3 * speedo / s_scale + c4 + c5 * T / t_scale) * T / t_scale)

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/*TODO: Figure out how to expose non-replayable fault buffer, which,

	 *      for some reason, is where recoverable CE faults appear...

	 *

	 * 	It's a bit tricky, as both NVKM and SVM will need access to

	 * 	the non-replayable fault buffer.

/*

 * Copyright (c) 2019 NVIDIA Corporation.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Pin fault buffer in BAR2. */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/*XXX: Earlier versions of RM touched the old regs on Turing,

	 *     which don't appear to actually work anymore, but newer

	 *     versions of RM don't appear to touch anything at all..

 Disable the fault interrupts */

 Enable the fault interrupts */

 Clear the associated interrupt flag */

 Replayable MMU fault */

 Clear the associated interrupt flag */

XXX: disable priv faults */

XXX: enable priv faults */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Fill per-LSF structures. */

 Write WPR header. */

 Write LSB header. */

 Write ucode image. */

 Write bootloader data. */

 Finalise WPR. */

 MAX_LSF */ * sizeof(struct wpr_header_v1);

 Shared sub-WPR headers. */

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/* Earlier FW releases by NVIDIA for Nouveau's use aren't in NVIDIA's

	 * standard format, and don't have the indirection seen in the 0x10de

	 * case.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/* If there's no LS FW managing bootstrapping of other LS falcons,

	 * we depend on the HS firmware being able to do it instead.

 Which isn't possible everywhere... */

	/* Determine layout/size of WPR image up-front, as we need to know

	 * it to allocate memory before we begin constructing it.

 Cull unknown falcons that are present in WPR image. */

 Ensure we've fetched falcon configuration. */

 Ensure the falcon that'll provide ACR functions is booted first. */

	/* Cull falcons that can't be bootstrapped, or the HSFW can fail to

	 * boot and leave the GPU in a weird state.

	/* Allocate/Locate WPR + fill ucode blob pointer.

	 *

	 *  dGPU: allocate WPR + shadow blob

	 * Tegra: locate WPR with regs, ensure size is sufficient,

	 *        allocate ucode blob.

 Write WPR to ucode blob. */

 Allocate instance block for ACR-related stuff. */

 Load HS firmware blobs into ACR VMM. */

 Kill temporary data. */

	/* Pre-add LSFs in the order they appear in the FW WPR image so that

	 * we're able to do a binary comparison with our own generator.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

XXX: shared sub-WPR headers, fill terminator for now. */

 Fill per-LSF structures. */

 Write WPR header. */

 Write LSB header. */

 Write ucode image. */

 Write bootloader data. */

 Finalise WPR. */

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Fill per-LSF structures. */

 Write WPR header. */

 Write LSB header. */

 Write ucode image. */

 Write bootloader data. */

 Finalise WPR. */

 MAX_LSF */ * sizeof(struct wpr_header);

 Reset falcon. */

 Load bootloader into IMEM. */

 Load bootloader data into DMEM. */

 Boot the falcon. */

 Check for successful completion. */

	/* Patch the appropriate signature (production/debug) into the FW

	 * image, as determined by the mode the falcon is in.

 Make the FW image accessible to the HS bootloader. */

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 * 	    Martin Peres

 determine the PWM source clock */

			/* Use the HOST clock (100 MHz)

 Where does this constant(20) comes from? */

 wait for the temperature to stabilize */

 if the slope or the offset is unset, do no use the sensor */

 reserve negative temperatures for errors */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 * 	    Martin Peres

 enable ADC readout and disable the ALARM threshold */

 wait for the temperature to stabilize */

 wait for the temperature to stabilize */

 if the slope or the offset is unset, do no use the sensor */

 reserve negative temperatures for errors */

 traitement */

 ack all IRQs */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Lyude Paul

/*

 * TODO: Fermi clockgating isn't understood fully yet, so we don't specify any

 * clockgate functions to use

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 * 	    Martin Peres

 enable temperature reading for cards with insane defaults */

 wait for the temperature to stabilize */

 enable RISING and FALLING IRQs for shutdown, THRS 0, 1, 2 and 4 */

 shutdown: The computer should be shutdown when reached */

 THRS_1 : fan boost*/

 THRS_2 : critical */

 THRS_4 : down clock */

 must be called with alarm_program_lock taken ! */

 program the next threshold */

 fix the state (in case someone reprogrammed the alarms) */

 find the direction */

 advertise a change in direction */

 THRS_4: downclock */

 shutdown */

 THRS_1 : fan boost */

 THRS_2 : critical */

 ACK everything */

 PBUS */

 Disable PTherm IRQs */

 ACK all PTherm IRQs */

 PBUS */

 init the thresholds */

/*

 * Copyright 2017 Rhys Kidd

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Rhys Kidd

 device SHADOWed */

 device valid */

/*

 * Copyright 2012 The Nouveau community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 10Hz */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 * 	    Martin Peres

 update target fan speed, restricting to allowed range */

 check that we're not already at the target duty cycle */

 smooth out the fanspeed increase/decrease */

		/* the constant "3" is a rough approximation taken from

		 * nvidia's behaviour.

		 * it is meant to bump the fan speed more incrementally

	/* fan speed updated, drop the fan lock before grabbing the

	 * alarm-scheduling lock and risking a deadlock

 schedule next fan update, if not at target speed already */

	/* Time a complete rotation and extrapolate to RPM:

	 * When the fan spins, it changes the value of GPIO FAN_SENSE.

	 * We get 4 changes (0 -> 1 -> 0 -> 1) per complete rotation.

 supports 0 < rpm < 7500 */

 attempt to locate a drivable fan, and determine control method */

 FIXME: is this really the place to perform such checks ? */

 no controllable fan found, create a dummy fan module */

 read the current speed, it is useful when resuming */

 attempt to detect a tachometer connection */

 initialise fan bump/slow update handling */

 other random init... */

/*

 * Copyright 2012 The Nouveau community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 look for the trip point corresponding to the current temperature */

 account for the hysteresis cycle */

 handle the non-linear part first */

 we are in the linear zone */

 The default PPWR ucode on fermi interferes with fan management */

	/* do not allow automatic fan management if the thermal sensor is

 restore the pwm value only when on manual or auto mode */

 undefined */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 enable fan tach, count revolutions per-second */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Lyude Paul

 Program ENG_MANT, ENG_FILTER */

 magic */

 Enable clockgating (ENG_CLK = RUN->AUTO) */

 ENG_CLK = AUTO->RUN, ENG_PWR = RUN->AUTO */

/*

 * Copyright 2012 The Nouveau community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

not that it matters */

 enforce a minimum hysteresis on thresholds */

 must be called with alarm_program_lock taken ! */

 must be called with alarm_program_lock taken ! */

 must be called with alarm_program_lock taken ! */

 nothing to do */

 schedule the next poll in one second */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 normal mode, possibly pwm forced off by us */

 nvio special */

 nothing to do for indx == 2, it seems hardwired to PTHERM */

 keep the high bits */

 enable fan tach, count revolutions per-second */

/*

 * Copyright 2017 Karol Herbst

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Karol Herbst

/*

 * Copyright 2014 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 nothing to do, it seems hardwired */

 keep the high bits */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 * 	    Martin Peres

/*

 * Copyright 2012 Nouveau community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

	/* The vbios doesn't provide the address of an exisiting monitoring

	   device. Let's try our static list.

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial busions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*******************************************************************************

 * i2c-algo-bit

/*******************************************************************************

 * !i2c-algo-bit (off-chip i2c bus / hw i2c / internal bit-banging algo)

/*******************************************************************************

 * nvkm_i2c_bus base

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial busions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 nack */

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial busions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 nfi which to use, or if it matters.. */

 wait up to 1ms for any previous transaction to be done... */

 set some magic, and wait up to 1ms for it to appear */

 (maybe) retry transaction a number of times on failure... */

 reset, and delay a while if this is a retry */

 transaction request, wait up to 2ms for it to complete */

 read status, and check if transaction completed ok */

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial busions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/*

	 * We init our i2c busses as early as possible, since they may be

	 * needed by the vbios init scripts on some cards

 internal outputs handled by native i2c busses (above) */

 we need an i2c bus to talk to the external encoder */

 ... and a driver for it */

 find/create an instance of the driver */

 create any i2c bus / aux channel required by the output */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial busions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 nfi which to use, or if it matters.. */

 wait up to 1ms for any previous transaction to be done... */

 set some magic, and wait up to 1ms for it to appear */

 (maybe) retry transaction a number of times on failure... */

 reset, and delay a while if this is a retry */

 transaction request, wait up to 2ms for it to complete */

 read status, and check if transaction completed ok */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2009 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 MOT */

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial busions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial busions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2017 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 it exists, but only has bit 31, not the dividers.. */

 wtf, appears to only disable post-divider on gt200 */

 PCIE reference clock */

 !0x50 */

 wtf?? */

 prepare a hwsq script from which we'll perform the reclock */

 block fifo */

 disable fb */

 wait for fb disabled */

	/* vdec: avoid modifying xpll until we know exactly how the other

	 * clock domains work, i suspect at least some of them can also be

	 * tied to xpll...

 see how close we can get using nvclk as a source */

 see how close we can get using xpll/hclk as a source */

 select whichever gets us closest */

	/* dom6: nfi what this is, but we're limited to various combinations

	 * of the host clock frequency

	/* vdec/dom6: switch to "safe" clocks temporarily, update dividers

	 * and then switch to target clocks

	/* core/shader: disconnect nvclk/sclk from their PLLs (nvclk to dom6,

	 * sclk to hclk) before reprogramming

 core: for the moment at least, always use nvpll */

	/* shader: tie to nvclk if possible, otherwise use spll.  have to be

	 * very careful that the shader clock is at least twice the core, or

	 * some chipsets will be very unhappy.  i expect most or all of these

	 * cases will be handled by tying to nvclk, but it's possible there's

	 * corners

 restore normal operation */

 enable fb */

 wait for fb enabled */

 un-block fifo */

/*

 * Copyright 2010 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

XXX: PCIE/AGP differ*/

 core/geometric clock */

 use the second pll for shader/rop clock, if it differs from core */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Memclk has doff of 0 despite its alt. location */

 use one of the fixed frequencies if possible */

 otherwise, calculate the closest divider */

 invalid clock domain */

 first possible path, using only dividers */

 see if we can get any closer using PLLs */

 select the method which gets closest to target freq */

 Test PLL lock */

 Enable sync mode */

 div programming */

 select div mode */

 (maybe) program pll */

 (maybe) select pll mode */

 final divider */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 PCIE reference clock */

 cclk: find suitable source, disable PLL if we can */

 Calculate clock * 2, so shader clock can use it too */

		/* NVCTRL is actually used _after_ NVPOST, and after what we

		 * call NVPLL. To make matters worse, NVPOST is an integer

 sclk: nvpll + divisor, href or spll */

 vclk */

 Print strategy! */

 First switch to safe clocks: href */

 mast |= 0x00000000; */

 Disable some PLLs and dividers when unused */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * misc

/******************************************************************************

 * C-States

/******************************************************************************

 * P-States

/******************************************************************************

 * Adjustment triggers

/******************************************************************************

 * subdev base class implementation

 reasonable default value */

 Early return if the pstates have been provided statically */

 If no pstates are provided, try and fetch them from the BIOS */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 *          Roy Spliet

 refclk for the 0xe8xx plls is a fixed frequency */

 no joke.. seriously.. sigh.. */

 out_alt */

 vco_out */

 vco_enable */

			/* no post-divider on these..

			 * XXX: it looks more like two post-"dividers" that

		/* When imprecise, play it safe and aim for a clock lower than

		/* divider can go as low as 2, limited here because NVIDIA

		 * and the VBIOS on my NVA8 seem to prefer using the PLL

		 * for 810MHz - is there a good reason?

	/* If we can get a within [-2, 3) MHz of a divider, we'll disable the

 Try with PLL */

 halt and idle execution engines */

 Wait until the interrupt handler is finished */

 Always start from a non-PLL clock */

 This seems to be a clock gating factor on idle, always set to 64 */

	/* XXX: Should be reading the highest bit in the VBIOS clock to decide

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 -2^6 ... 2^6-1 */

 -2^12 ... 2^12-1 */

/*

 * base.n is now the *integer* part of the N factor.

 * sdm_din contains n's decimal part.

 currently applied parameters */

 new parameters to apply */

 fused parameters */

 safe frequency we can use at minimum voltage */

/*

 * Determine DFS_COEFF for the requested voltage. Always select external

 * calibration override equal to the voltage, and set maximum detection

 * limit "0" (to make sure that PLL output remains under F/V curve when

 * voltage increases).

 Work with mv as uv would likely trigger an overflow */

 coeff = slope * voltage + offset */

 should never happen */

/*

 * Solve equation for integer and fractional part of the effective NDIV:

 *

 * n_eff = n_int + 1/2 + (SDM_DIN / 2^(SDM_DIN_RANGE + 1)) +

 *         (DVFS_COEFF * DVFS_DET_DELTA) / 2^DFS_DET_RANGE

 *

 * The SDM_DIN LSB is finally shifted out, since it is not accessible by sw.

 calculate current ext_cal and subtract previous one */

 integer part of n */

 should never happen! */

 fractional part of n */

 subtract 2^SDM_DIN_RANGE to account for the 1/2 of the equation */

 lose 8 LSB and clip - sdm_din only keeps the most significant byte */

 calculate the new n_int/sdm_din for this n/uv */

 get old coefficients */

 do nothing if NDIV is the same */

 pll slowdown mode */

 new ndiv ready for ramp */

 in DVFS mode SDM is updated via "new" field */

 dynamic ramp to new ndiv */

 wait for ramping to complete */

 in DVFS mode complete SDM update */

 exit slowdown mode */

 In DVFS mode lock cannot be used - so just delay */

 set SYNC_MODE for glitchless switch out of bypass */

 switch to VCO mode */

 put PLL in bypass before disabling it */

 clear SYNC_MODE before disabling PLL */

 if we only change pdiv, we can do a glitchless transition */

 need full sequence if clock not enabled yet */

 split VCO-to-bypass jump in half by setting out divider 1:2 */

 Intentional 2nd write to assure linear divider operation */

		/*

		 * we can do a glitchless transition only if the old and new PL

		 * parameters share at least one bit set to 1. If this is not

		 * the case, calculate and program an interim PL that will allow

		 * us to respect that rule.

 disable before programming if more than pdiv changes */

 restore out divider 1:1 */

 Intentional 2nd write to assure linear divider operation */

 just do NDIV slide if there is no change to M and PL */

 slide down to current NDIV_LO */

 program MNP with the new clock parameters and new NDIV_LO */

 slide up to new NDIV */

/*

 * Compute PLL parameters that are always safe for the current voltage

 remove a safe margin of 10% */

 gpc2clk */

 strobe to read external DFS coefficient */

 Use external value to overwrite calibration value */

 strobe to read external DFS coefficient */

 No change in DVFS settings? */

	/*

	 * Interim step for changing DVFS detection settings: low enough

	 * frequency to be safe at at DVFS coeff = 0.

	 *

	 * 1. If voltage is increasing:

	 * - safe frequency target matches the lowest - old - frequency

	 * - DVFS settings are still old

	 * - Voltage already increased to new level by volt, but maximum

	 *   detection limit assures PLL output remains under F/V curve

	 *

	 * 2. If voltage is decreasing:

	 * - safe frequency target matches the lowest - new - frequency

	 * - DVFS settings are still old

	 * - Voltage is also old, it will be lowered by volt afterwards

	 *

	 * Interim step can be skipped if old frequency is below safe minimum,

	 * i.e., it is low enough to be safe at any voltage in operating range

	 * with zero DVFS coefficient.

 voltage will raise: safe frequency is current one */

 voltage will drop: safe frequency is new one */

	/*

	 * DVFS detection settings transition:

	 * - Set DVFS coefficient zero

	 * - Set calibration level to new voltage

	 * - Set DVFS coefficient to match new voltage

 slide to VCO min */

 set IDDQ */

 default ADC detection slope */

 Enable NA DVFS */

 Set VCO_CTRL */

 Start internal calibration, but ignore results */

 got uvdev parameters from fuse, skip calibration */

	/*

	 * If calibration parameters are not fused, start internal calibration,

	 * wait for completion, and use results along with default slope to

	 * calculate ADC offset during boot.

 Wait for internal calibration done (spec < 2us). */

 Compute and apply initial DVFS parameters */

 Forward declaration to detect speedo >=1 in gm20b_clk_init() */

 get out from IDDQ */

 Set the global bypass control to VCO */

 If not fused, set RAM SVOP PDP data 0x2, and enable fuse override */

 Disable idle slow down  */

 speedo >= 1? */

 Get current voltage */

 Initialize DVFS */

 Start with lowest frequency */

 Speedo 0 only supports 12 voltages */

 FUSE register */

 No fused parameters, we will calibrate later */

 Integer part in mV + fractional part in uV */

 Integer part in mV + fractional part in 100uV */

 find lowest voltage we can use */

 find max frequency at this voltage */

 we are safe at 90% of the max frequency */

 Speedo 0 GPUs cannot use noise-aware PLL */

 Speedo >= 1, use NAPLL */

 duplicate the clock parameters since we will patch them below */

	/*

	 * NAPLL can only work with max_u, clamp the m range so

	 * gk20a_pllg_calc_mnp always uses it

	/*

	 * we will calibrate during init - should never happen on

	 * prod parts

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 use one of the fixed frequencies if possible */

 otherwise, calculate the closest divider */

 invalid clock domain */

 first possible path, using only dividers */

 see if we can get any closer using PLLs */

 select the method which gets closest to target freq */

 Test PLL lock */

 Enable sync mode */

 div programming */

 select div mode */

 (maybe) program pll */

 final divider */

 (maybe) select pll mode */

/*

 * Copyright 1993-2003 NVIDIA, Corporation

 * Copyright 2007-2009 Stuart Bennett

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,

 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF

 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

 * SOFTWARE.

	/* Find M, N and P for a single stage PLL

	 *

	 * Note that some bioses (NV3x) have lookup tables of precomputed MNP

	 * values, but we're too lazy to use those atm

	 *

	 * "clk" parameter in kHz

	 * returns calculated clock

 this division verified for nv20, nv18, nv28 (Haiku), and nv34 */

 possibly correlated with introduction of 27MHz crystal */

 +0.5% */

 NV34 goes maxlog2P->0, NV20 goes 0->maxlog2P */

 add crystal/2 to round better */

 more rounding additions */

			/* we do an exhaustive search rather than terminating

			 * on an optimality condition...

 except this one */

	/* Find M, N and P for a two stage PLL

	 *

	 * Note that some bioses (NV30+) have lookup tables of precomputed MNP

	 * values, but we're too lazy to use those atm

	 *

	 * "clk" parameter in kHz

	 * returns calculated clock

 +0.5% */

 add calcclk1/2 to round better */

				/* we do an exhaustive search rather than terminating

				 * on an optimality condition...

 except this one */

/*

 * Copyright (c) 2014-2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Shamelessly ripped off from ChromeOS's gk20a/clk_pllg.c

 *

 PL:   0, 1, 2, 3, 4, 5, 6,  7,  8,  9, 10, 11, 12, 13, 14 */

 p: */ 1, 2, 3, 4, 5, 6, 8, 10, 12, 16, 12, 16, 20, 24, 32,

 min_pl <= high_pl <= max_pl */

 min_pl <= low_pl <= max_pl */

 Select lowest possible VCO */

 get old coefficients */

 do nothing if NDIV is the same */

 pll slowdown mode */

 new ndiv ready for ramp */

 dynamic ramp to new ndiv */

 wait for ramping to complete */

 exit slowdown mode */

 enable lock detection */

 wait for lock */

 switch to VCO mode */

 put PLL in bypass before disabling it */

 split VCO-to-bypass jump in half by setting out divider 1:2 */

 Intentional 2nd write to assure linear divider operation */

 restore out divider 1:1 */

 Intentional 2nd write to assure linear divider operation */

 just do NDIV slide if there is no change to M and PL */

 slide down to current NDIV_LO */

 program MNP with the new clock parameters and new NDIV_LO */

 slide up to new NDIV */

 slide to VCO min */

 set IDDQ */

 get out from IDDQ */

 Start with lowest frequency */

 Finish initializing the pstates */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

XXX: figure this out */

 aim for 31.25MHz, which gives us nanosecond timestamps */

 reduce ratio to acceptable values */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Process pending alarms. */

 Have we hit the earliest alarm that hasn't gone off? */

 Schedule it.  If we didn't race, we're done. */

		/* Move to completed list.  We'll drop the lock before

		 * executing the callback so it can reschedule itself.

 Shut down interrupt if no more pending alarms. */

 Execute completed callbacks. */

	/* Remove alarm from pending list.

	 *

	 * This both protects against the corruption of the list,

	 * and implements alarm rescheduling/cancellation.

 Insert into pending list, ordered earliest to latest. */

 Update HW if this is now the earliest alarm. */

			/* This shouldn't happen if callers aren't stupid.

			 *

			 * Worst case scenario is that it'll take roughly

			 * 4 seconds for the next alarm to trigger.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

XXX: nvclk */

 aim for 31.25MHz, which gives us nanosecond timestamps */

 reduce ratio to acceptable values */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 aim for 31.25MHz, which gives us nanosecond timestamps */

 reduce ratio to acceptable values */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 PRAMIN always potentially available prior to nv50 */

 we can't get the bios image pointer without PDISP */

XXX: find the fuse reg for this */

	/* check that the window is enabled and in vram, particularly

	 * important as we don't want to be touching vram on an

	 * uninitialised board

 some alternate method inherited from xf86-video-nv... */

 modify bar0 PRAMIN window to cover the bios image */

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 XXX: find the flag byte */

 offset 4 seems to be a flag byte */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 handle user-specified bios source */

 try to match one of the built-in methods */

 otherwise, attempt to load as firmware */

 scan all potential bios sources, looking for best image */

 cleanup the ones we didn't use */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 use gpio version for xpio entry parsing */

 DCB 2.2, fixed TVDAC GPIO data */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

/* This version of the shadow function disobeys the ACPI spec and tries

 * to fetch in units of more than 4KiB at a time.  This is a LOT faster

 * on some systems, such as Lenovo W530.

/* Other systems, such as the one in fdo#55948, will report a success

 * but only return 4KiB of data.  The common bios fetching logic will

 * detect an invalid image, and fall back to this version of the read

 * function.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/* These map MXM v2.x digital connection values to the appropriate SOR/link,

 * hopefully they're correct for all boards within the same chipset...

 *

 * MXM v3.x VBIOS are nicer and provide pointers to these tables.

 v2.x: directly write port as dcb i2cidx */

/*

 * Copyright 2014 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 TODO: Understand the difference between the two! */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* Some tables have weird pointers that need adjustment before

	 * they're dereferenced.  I'm not entirely sure why...

 detect type of vbios we're dealing with */

 determine the vbios version number */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/* Pretend a performance mode is also a rammap entry, helps coalesce entries

/*

 * Copyright 2016 Karol Herbst

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Karol Herbst

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 NV */

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 maybe? */

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 NPDE */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * init parser control flow helpers

/******************************************************************************

 * init parser wrappers for normal register/i2c/whatever accessors

	/* C51 (at least) sometimes has the lower bits set which the VBIOS

	 * interprets to mean that access needs to go through certain IO

	 * ports instead.  The NVIDIA binary driver has been seen to access

	 * these through the NV register address, so lets assume we can

	 * do the same

	/* GF8+ display scripts need register addresses mangled a bit to

	 * select a specific CRTC/OR

 force head 0 for updates to cr44, it only exists on first head */

 select head 1 if cr44 write selected it */

/******************************************************************************

 * parsing of bios structures that are required to execute init tables

	/* This appears to be the behaviour of the VBIOS parser, and *is*

	 * important to cache the NV_PEXTDEV_BOOT0 on later chipsets to

	 * avoid fucking up the memory controller (somehow) by reading it

	 * on every INIT_RAM_RESTRICT_ZM_GROUP opcode.

	 *

	 * Preserving the non-caching behaviour on earlier chipsets just

	 * in case *not* re-reading the strap causes similar breakage.

/******************************************************************************

 * utility functions used by various init opcode handlers

	/* For mlv < 0x80, it is an index into a table of TMDS base addresses.

	 * For mlv == 0x80 use the "or" value of the dcb_entry indexed by

	 * CR58 for CR57 = 0 to index a table of offsets to the basic

	 * 0x6808b0 address.

	 * For mlv == 0x81 use the "or" value of the dcb_entry indexed by

	 * CR58 for CR57 = 0 to index a table of offsets to the basic

	 * 0x6808b0 address, and then flip the offset by 8.

/******************************************************************************

 * init opcode handlers

/**

 * init_reserved - stub for various unknown/unused single-byte opcodes

 *

/**

 * INIT_DONE - opcode 0x71

 *

/**

 * INIT_IO_RESTRICT_PROG - opcode 0x32

 *

/**

 * INIT_REPEAT - opcode 0x33

 *

/**

 * INIT_IO_RESTRICT_PLL - opcode 0x34

 *

/**

 * INIT_END_REPEAT - opcode 0x36

 *

/**

 * INIT_COPY - opcode 0x37

 *

/**

 * INIT_NOT - opcode 0x38

 *

/**

 * INIT_IO_FLAG_CONDITION - opcode 0x39

 *

/**

 * INIT_GENERIC_CONDITION - opcode 0x3a

 *

 CONDITION_ID_INT_DP. */

 CONDITION_ID_USE_SPPLL0. */

 CONDITION_ID_USE_SPPLL1. */

 CONDITION_ID_ASSR_SUPPORT. */

 CONDITION_ID_NO_PANEL_SEQ_DELAYS. */

/**

 * INIT_IO_MASK_OR - opcode 0x3b

 *

/**

 * INIT_IO_OR - opcode 0x3c

 *

/**

 * INIT_ANDN_REG - opcode 0x47

 *

/**

 * INIT_OR_REG - opcode 0x48

 *

/**

 * INIT_INDEX_ADDRESS_LATCHED - opcode 0x49

 *

/**

 * INIT_IO_RESTRICT_PLL2 - opcode 0x4a

 *

/**

 * INIT_PLL2 - opcode 0x4b

 *

/**

 * INIT_I2C_BYTE - opcode 0x4c

 *

/**

 * INIT_ZM_I2C_BYTE - opcode 0x4d

 *

/**

 * INIT_ZM_I2C - opcode 0x4e

 *

/**

 * INIT_TMDS - opcode 0x4f

 *

/**

 * INIT_ZM_TMDS_GROUP - opcode 0x50

 *

/**

 * INIT_CR_INDEX_ADDRESS_LATCHED - opcode 0x51

 *

/**

 * INIT_CR - opcode 0x52

 *

/**

 * INIT_ZM_CR - opcode 0x53

 *

/**

 * INIT_ZM_CR_GROUP - opcode 0x54

 *

/**

 * INIT_CONDITION_TIME - opcode 0x56

 *

/**

 * INIT_LTIME - opcode 0x57

 *

/**

 * INIT_ZM_REG_SEQUENCE - opcode 0x58

 *

/**

 * INIT_PLL_INDIRECT - opcode 0x59

 *

/**

 * INIT_ZM_REG_INDIRECT - opcode 0x5a

 *

/**

 * INIT_SUB_DIRECT - opcode 0x5b

 *

/**

 * INIT_JUMP - opcode 0x5c

 *

/**

 * INIT_I2C_IF - opcode 0x5e

 *

/**

 * INIT_COPY_NV_REG - opcode 0x5f

 *

/**

 * INIT_ZM_INDEX_IO - opcode 0x62

 *

/**

 * INIT_COMPUTE_MEM - opcode 0x63

 *

/**

 * INIT_RESET - opcode 0x65

 *

/**

 * INIT_CONFIGURE_MEM - opcode 0x66

 *

 skip to data */

 CKE_NORMAL */

 CMD_REFRESH */

 CMD_PRECHARGE */

/**

 * INIT_CONFIGURE_CLK - opcode 0x67

 *

 NVPLL */

 MPLL */

/**

 * INIT_CONFIGURE_PREINIT - opcode 0x68

 *

/**

 * INIT_IO - opcode 0x69

 *

	/* ummm.. yes.. should really figure out wtf this is and why it's

	 * needed some day..  it's almost certainly wrong, but, it also

	 * somehow makes things work...

/**

 * INIT_SUB - opcode 0x6b

 *

/**

 * INIT_RAM_CONDITION - opcode 0x6d

 *

/**

 * INIT_NV_REG - opcode 0x6e

 *

/**

 * INIT_MACRO - opcode 0x6f

 *

/**

 * INIT_RESUME - opcode 0x72

 *

/**

 * INIT_STRAP_CONDITION - opcode 0x73

 *

/**

 * INIT_TIME - opcode 0x74

 *

/**

 * INIT_CONDITION - opcode 0x75

 *

/**

 * INIT_IO_CONDITION - opcode 0x76

 *

/**

 * INIT_ZM_REG16 - opcode 0x77

 *

/**

 * INIT_INDEX_IO - opcode 0x78

 *

/**

 * INIT_PLL - opcode 0x79

 *

/**

 * INIT_ZM_REG - opcode 0x7a

 *

/**

 * INIT_RAM_RESTRICT_PLL - opcde 0x87

 *

/**

 * INIT_RESET_BEGUN - opcode 0x8c

 *

/**

 * INIT_RESET_END - opcode 0x8d

 *

/**

 * INIT_GPIO - opcode 0x8e

 *

/**

 * INIT_RAM_RESTRICT_ZM_GROUP - opcode 0x8f

 *

/**

 * INIT_COPY_ZM_REG - opcode 0x90

 *

/**

 * INIT_ZM_REG_GROUP - opcode 0x91

 *

/**

 * INIT_XLAT - opcode 0x96

 *

/**

 * INIT_ZM_MASK_ADD - opcode 0x97

 *

/**

 * INIT_AUXCH - opcode 0x98

 *

/**

 * INIT_AUXCH - opcode 0x99

 *

/**

 * INIT_I2C_LONG_IF - opcode 0x9a

 *

/**

 * INIT_GPIO_NE - opcode 0xa9

 *

	/* the vbios parser will run this right after the normal init

	 * tables, whereas the binary driver appears to run it later.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

		/*

		 * v1.4 (some NV15/16, NV11+) seems the same as v1.5, but

		 * always has the same single (crt) entry, even when tv-out

		 * present, so the conclusion is this version cannot really

		 * be used.

		 *

		 * v1.2 tables (some NV6/10, and NV15+) normally have the

		 * same 5 entries, which are not specific to the card and so

		 * no use.

		 *

		 * v1.2 does have an I2C table that read_dcb_i2c_table can

		 * handle, but cards exist (nv11 in #14821) with a bad i2c

		 * table pointer, so use the indices parsed in

		 * parse_bmp_structure.

		 *

		 * v1.1 (NV5+, maybe some NV4) is entirely unhelpful

 1.62 */

 2.7 */

 5.4 */

 8.1 */

XXX*/

 seen on an NV11 with DCB v1.5 */

 seen on an NV17 with DCB v2.0 */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

			/*XXX: is M ever shorter than this?

			 *     if not - what is xlat used for now?

			 *     also - sigh..

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 match any link */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

/*

 * Copyright 2016 Karol Herbst

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Karol Herbst

/*

 * Copyright 2005-2006 Erik Waling

 * Copyright 2006 Stephane Marchesin

 * Copyright 2007-2009 Stuart Bennett

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,

 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF

 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

 * SOFTWARE.

 these values taken from nv30/31/36 */

		/*

		 * On nv30, 31, 36 (i.e. all cards with two stage PLLs with this

		 * table version (apart from nv35)), N2 is compared to

		 * maxN2 (0x46) and 10 * maxM2 (0x4), so set maxN2 to 0x28 and

		 * save a comparison

 info->refclk_alt = nvbios_rd16(bios, data + 3) * 1000; */

	/*

	 * By now any valid limit table ought to have set a max frequency for

	 * vco1, so if it's zero it's either a pre limit table bios, or one

	 * with an empty limit table (seen on nv18)

 nv05 does this, nv11 doesn't, nv10 unknown */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2015 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

/*

 * Copyright 2014 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 PCIR */

 RGIS */

 NPDS */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 match any link */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 use DCB version */

 value 0x1f means unused according to DCB 4.x spec */

		/* BMP (from v4.0 has i2c info in the structure, it's in a

		 * fixed location on earlier VBIOS

/*

 * Copyright 2012 Nouveau Community

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

 exit now if we haven't found the thermal table */

 we only support the core domain for now */

 Read the entries from the table */

 we do not try to support ambient */

 starting from fermi, fan management is always linear */

/*

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 match dcb encoder type to mxm-ods device type */

	/* digital output, have some extra stuff to match here, there's a

	 * table in the vbios that provides a mapping from the mxm digital

	 * connection enum values to SOR/link

 check against sor index */

 check dcb entry has a compatible link field */

	/* mark this descriptor accounted for by setting invalid device type,

	 * except of course some manufactures don't follow specs properly and

	 * we need to avoid killing off the TMDS function on DP connectors

	 * if MXM-SIS is missing an entry for it.

 modify descriptor to match TMDS now */

	/* look for an output device structure that matches this dcb entry.

	 * if one isn't found, disable it.

	/* modify the output's ddc/aux port, there's a pointer to a table

	 * with the mapping from mxm ddc/aux port to dcb i2c_index in the

	 * vbios mxm table

 override dcb sorconf.link, based on what mxm data says */

 Analog CRT */

 Analog TV/HDTV */

	/* we may need to fixup various other vbios tables based on what

	 * the descriptor says the connector type should be.

	 *

	 * in a lot of cases, the vbios tables will claim DVI-I is possible,

	 * and the mxm data says the connector is really HDMI.  another

	 * common example is DP->eDP.

 LVDS */

 use_power_scripts */

 XXX: modify default link width in LVDS table */

 HDMI */

 DVI-D */

 eDP, falls through to DPint */

 DP internal, wtf is this?? HP8670w */

 use_power_scripts? */

/*

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 LVDS_DDC */) & 0x0f;

	/*

	 * spec says this can be zero to mean "highest revision", but

	 * of course there's at least one bios out there which fails

	 * unless you pass in exactly the version it supports..

 MXMI */, version, 0 };

 MXMS */, version, 0 };

		/* we should, perhaps, fall back to some kind of limited

		 * mode here if the x86 vbios hasn't already done the

		 * work for us (so we prevent loading with completely

		 * whacked vbios tables).

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 Output Device Structure */

 System Cooling Capability Structure */

 Thermal Structure */

 Input Power Structure */

 GPIO Device Structure */

 Vendor Specific Structure */

 Backlight Control Structure */

 Fan Control Structure */

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* our heuristics can't detect whether the board has had its

	 * devinit scripts executed or not if the display engine is

	 * missing, assume it's a secondary gpu which requires post

	/* magic to detect whether or not x86 vbios code has executed

	 * the devinit scripts to initialise the board

	/* if we ran the init tables, we have to execute the first script

	 * pointer of each dcb entry's display encoder table in order

	 * to properly initialise each encoder.

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/*

	 * This bit is set by devinit, and flips back to 0 on suspend. We

	 * can use it as a reliable way to know whether we should run devinit.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Map the framebuffer aperture */

 Probe memory bus width */

 Probe amount of installed memory */

 IC missing - disable the upper half memory space. */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

 force full reinit on resume */

 Override the post flag during the first call if NvForcePost is set */

 unlock the extended vga crtc regs */

 lock crtc regs */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Map the framebuffer aperture */

 Allow full addressing */

 IC missing - disable the upper half memory space. */

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Map the framebuffer aperture */

 Sequencer and refresh off */

 Refresh on, sequencer on */

	/*

	 * the shift for vpll regs is only used for nv3x chips with a single

	 * stage pll

 already set */

 upclock -- write new post divider first */

 downclock -- write new NM first */

 wait a bit on older chips */

 then write the other half as well */

 single stage pll mode */

 nv41+ only */

 model specific additions to generic pll1 and pll2 set up above */

 !nv40 */

 force mismatch */

 magic value used by nvidia in single stage mode */

 magic bits set by the blob (but not the bios) on g71-73 */

 already set */

	/* When setting PLLs, there is a merry game of disabling and enabling

	 * various bits of hardware during the process. This function is a

	 * synthesis of six nv4x traces, nearly each card doing a subtly

	 * different thing. With luck all the necessary bits for each card are

	 * combined herein. Without luck it deviates from each card's formula

	 * so as to not work on any :)

 some cards have different maskc040s */

 make i2c busses accessible */

 unslave crtcs */

 restore vga owner saved at first init */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* the init tables on some boards have INIT_RAM_RESTRICT_ZM_REG_GROUP

	 * instructions which touch registers that may not even exist on

	 * some configurations (Quadro 400), which causes the register

	 * interface to screw up for some amount of time after attempting to

	 * write to one of these, and results in all sorts of things going

	 * horribly wrong.

	 *

	 * the binary driver avoids touching these registers at all, however,

	 * the video bios doesn't care and does what the scripts say.  it's

	 * presumed that the io-port access to init registers isn't effected

	 * by the screw-up bug mentioned above.

	 *

	 * really, a new opcode should've been invented to handle these

	 * requirements, but whatever, it's too late for that now.

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

XXX*/

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

	/* Optional: Execute PRE_OS application on PMU, which should at

	 * least take care of fans until a full PMU has been loaded.

 Upload DEVINIT application from VBIOS onto PMU. */

 Upload tables required by opcodes in boot scripts. */

 Upload boot scripts. */

 Execute DEVINIT. */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Map the framebuffer aperture */

 Sequencer off */

 If present load the hardcoded scrambling table */

 Set memory type/width/length defaults depending on the straps */

 Probe memory bus width */

 Probe memory length */

 Sequencer on */

/*

 * Copyright 2013 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Translate engine type to NVKM engine identifier. */

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2016 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 NOT_VALID */

 DATA */

 ENUM */

 ENGINE_TYPE */

 Translate engine type to NVKM engine identifier. */

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/* MSI re-arm through the PRI appears to be broken on NV46/NV50/G84/G86/G92,

 * so we access it via alternate PCI config space mechanisms.

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

 g84 and g86 report wrong information about what they support */

 The following only concerns PCIe cards. */

	/* Tag field is 8-bit long, regardless of EXT_TAG.

	 * However, if EXT_TAG is disabled, only the lower 5 bits of the tag

	 * field should be used, limiting the number of request to 32.

	 *

	 * Apparently, 0x041c stores some limit on the number of requests

	 * possible, so if EXT_TAG is disabled, limit that requests number to

	 * 32

	 *

	 * Fixes fdo#86537

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

	/* Ensure MSI interrupts are armed, for the case where there are

	 * already interrupts pending (for whatever reason) at load time.

		/* freq_irq() will call the handler, we use pci->irq == -1

		 * to signal that it's been torn down and should be a noop.

 BR02? NFI how these would be handled yet exactly */

 reported broken, nv also disable it */

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Karol Herbst <nouveau@karolherbst.de>

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Karol Herbst <nouveau@karolherbst.de>

/*

 * Copyright 2015 Karol Herbst <nouveau@karolherbst.de>

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Karol Herbst <nouveau@karolherbst.de>

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Nouveau Project

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 VIA Apollo PRO133x / GeForce FX 5600 Ultra - fdo#20341 */

 SiS 761 does not support AGP cards, use PCI mode */

/* Ensure AGP controller is in a consistent state in case we need to

 * execute the VBIOS DEVINIT scripts.

	/* First of all, disable fast writes, otherwise if it's already

	 * enabled in the AGP bridge and we disable the card's AGP

	 * controller we might be locking ourselves out of it.

 clear busmaster bit, and disable AGP */

 reset PGRAPH, PFIFO and PTIMER */

 and restore busmaster bit (gives effect of resetting AGP) */

	/* Disable AGP by default on all PowerPC machines for now -- At

	 * least some UniNorth-2 AGP bridges are known to be broken:

	 * DMA from the host to the card works just fine, but writeback

	 * from the card to the host goes straight to memory

	 * untranslated bypassing that GATT somehow, making them quite

	 * painful to deal with...

 acquire bridge temporarily, so that we can copy its info */

 determine if bridge + chipset combination needs a workaround */

 apply quirk / user-specified mode */

 AGPv3 */

	/* fast writes appear to be broken on nv18, they make the card

	 * lock up randomly.

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs <bskeggs@redhat.com>

/*

 * Copyright 2015 Karol Herbst <nouveau@karolherbst.de>

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Karol Herbst <git@karolherbst.de>

 XXX 0x16 is 8_0, assume 0x17 will be 16_0 for now */

 raise pcie version first */

/*

 * Copyright 2015 Karol Herbst

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Karol Herbst

/*

 * Copyright 2015 Martin Peres

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Martin Peres

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 already disabled, return or wait_idle will timeout */

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 specifies that we want to know the command status in the answer message */

 specifies that we want an interrupt when the answer message is queued */

/*

 * Copyright (c) 2016, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 write new tag every 256B */

	/*

	 * If size is not a multiple of 4, mask the last work to ensure garbage

	 * does not get written

 write new tag every 256B */

 code must be padded to 0x40 words */

	/*

	 * If size is not a multiple of 4, mask the last word to ensure garbage

	 * does not get written

	/*

	 * If size is not a multiple of 4, mask the last word to ensure garbage

	 * does not get written

	/*

	 * If size is not a multiple of 4, mask the last word to ensure garbage

	 * does not get read

	/*

	 * If size is not a multiple of 4, mask the last word to ensure garbage

	 * does not get read

 disable instance block binding */

 setup apertures - virtual */

 setup apertures - physical */

 Set context */

 Enable context */

 clear interrupt(s) */

 wait until interrupts are cleared */

 enable IRQs */

 disable IRQs and wait for any previous code to complete */

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 no need to acquire seq.mutex since clear_bit is atomic */

/*

 * Copyright (c) 2017, NVIDIA CORPORATION. All rights reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 has the buffer looped? */

	/*

	 * We are invoked from a worker thread, so normally we have plenty of

	 * stack space to work with.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2019 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/* I8 format without an input LUT makes no sense, and the

	 * HW error-checks for this.

	 *

	 * In order to handle legacy gamma, when there's no input

	 * LUT we need to steal the output LUT and use it instead.

		/* This should be an error, but there's legacy clients

		 * that do a modeset before providing a gamma table.

		 *

		 * We keep the window disabled to avoid angering HW.

 Recalculate LUT state. */

 Handle setting base SET_OUTPUT_LUT_LO_ENABLE_USE_CORE_LUT. */

 Can't do an immediate flip while changing the LUT. */

	/* Fetch the assembly state for the head the window will belong to,

	 * and determine whether the window will be visible.

 Fetch assembly state for the head the window used to belong to. */

 LUT configuration can potentially cause the window to be disabled. */

 Calculate new window state. */

	/* Aside from the obvious case where the window is actively being

	 * disabled, we might also need to temporarily disable the window

	 * when performing certain modeset operations.

/* This function assumes the format has already been validated against the plane

 * and the modifier was validated against the device-wides modifier list at FB

 * creation time.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/* EVO will complain with INVALID_STATE if we have an

	 * active cursor and (re)specify HeadSetContextDmaIso

	 * without also updating HeadSetOffsetCursor.

		/*XXX: We need to either find some way of having the

		 *     primary base layer appear black, while still

		 *     being able to display the other layers, or we

		 *     need to allocate a dummy black surface here.

	/* INTERPOLATE modes require a "next" entry to interpolate with,

	 * so we replicate the last entry to deal with this for now.

 SPDX-License-Identifier: MIT

 reserved */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 SPDX-License-Identifier: MIT

 reserved */

 reserved */

 reserved */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 VSS header. */

	/* INTERPOLATE modes require a "next" entry to interpolate with,

	 * so we replicate the last entry to deal with this for now.

 VSS header. */ + size + 1 
/****************************************************************

 *            Log2(block height) ----------------------------+  *

 *            Page Kind ----------------------------------+  |  *

 *            Gob Height/Page Kind Generation ------+     |  |  *

 *                          Sector layout -------+  |     |  |  *

         |  |  |     |  |  */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 base takes a 19-bit 2's complement value in S3.16 format */

			/* DRM does not support constant offset, while

 SPDX-License-Identifier: MIT

	/*

	 * We don't want to accidentally wait for longer then the vblank, so

	 * try again for the next vblank if we don't grab the lock

		/*

		 * While Nvidia's documentation says CRCs are written on each

		 * subsequent vblank after being enabled, in practice they

		 * aren't written immediately.

	/*

	 * We don't lose events if we aren't able to report CRCs until the

	 * next vblank, so only report CRCs if the locks we need aren't

	 * contended to prevent missing an actual vblank event

		/*

		 * Unfortunately when notifier contexts are changed during CRC

		 * capture, we will inevitably lose the CRC entry for the

		 * frame where the hardware actually latched onto the first

		 * UPDATE. According to Nvidia's hardware engineers, there's

		 * no workaround for this.

		 *

		 * Now, we could try to be smart here and calculate the number

		 * of missed CRCs based on audit timestamps, but those were

		 * removed starting with volta. Since we always flush our

		 * updates back-to-back without waiting, we'll just be

		 * optimistic and assume we always miss exactly one frame.

		/* CRC generation is still enabled in hw, we'll just report

		 * any remaining CRC entries ourselves after it gets disabled

		 * in hardware

	/* While we don't care about entry tags, Volta+ hw always needs the

	 * controlling wndw channel programmed to a wndw that's owned by our

	 * head

			/* TODO: once we support flexible channel ownership,

			 * we should write some code here to handle attempting

			 * to "steal" a plane: e.g. take a plane that is

			 * currently not-visible and owned by another head,

			 * and reassign it to this head. If we fail to do so,

			 * we shuld reject the mode outright as CRC capture

			 * then becomes impossible.

		/*

		 * Re-programming ORs can't be done in the same flush as

		 * disabling CRCs

/* We handle mapping the memory for CRC notifiers ourselves, since each

 * notifier needs it's own handle

	/*

	 * Since we don't want the user to accidentally interrupt us as we're

	 * disabling CRCs

		/*

		 * If the user specified a custom flip threshold through

		 * debugfs, reset it

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/* Some newer formats, esp FP16 ones, don't have a

	 * "depth". There's nothing that really makes sense there

	 * either, so just set it to the implicit bit count.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

XXX*/

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 Non-EDID LVDS/eDP mode. */

	/* For the user-specified mode, we must ignore doublescan and

	 * the like, but honor frame packing.

 For the output mode, we can just use the stock helper. */

	/* Add overscan compensation if necessary, will keep the aspect

	 * ratio the same as the backend mode unless overridden by the

	 * user setting both hborder and vborder properties.

	/* Handle CENTER/ASPECT scaling, taking into account the areas

	 * removed already for overscan compensation.

		/* NOTE: This will cause scaling when the input is

		 * larger than the output.

		/* Determine whether the scaling should be on width or on

		 * height. This is done by comparing the aspect ratios of the

		 * sizes. If the output AR is larger than input AR, that means

		 * we want to change the width (letterboxed on the

		 * left/right), otherwise on the height (letterboxed on the

		 * top/bottom).

		 *

		 * E.g. 4:3 (1.333) AR image displayed on a 16:10 (1.6) AR

		 * screen will have letterboxes on the left/right. However a

		 * 16:9 (1.777) AR image on that same screen will have

		 * letterboxes on the top/bottom.

		 *

		 * inputAR = iW / iH; outputAR = oW / oH

		 * outputAR > inputAR is equivalent to oW * iH > iW * oH

 Recompute output width, i.e. left/right letterbox */

 Recompute output height, i.e. top/bottom letterbox */

 Determine whether core output LUT should be enabled. */

		/* Check if any window(s) have stolen the core output LUT

		 * to as an input LUT for legacy gamma + I8 colour format.

			/* If any window has stolen the core output LUT,

			 * all of them must.

	/*

	 * DRM modes are defined in terms of a repeating interval

	 * starting with the active display area.  The hardware modes

	 * are defined in terms of a repeating interval starting one

	 * unit (pixel or line) into the sync pulse.  So, add bias.

XXX: Safe underestimate, even "0" works */

 Keep the legacy gamma size at 256 to avoid compatibility issues */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

XXX*/

XXX*/

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2021 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/* INTERPOLATE modes require a "next" entry to interpolate with,

	 * so we replicate the last entry to deal with this for now.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/*XXX: This is a dirty hack until OR depth handling is

	 *     improved later for deep colour etc.

TODO:

 VSS header. */

	/* INTERPOLATE modes require a "next" entry to interpolate with,

	 * so we replicate the last entry to deal with this for now.

 VSS header. */

	/* INTERPOLATE modes require a "next" entry to interpolate with,

	 * so we replicate the last entry to deal with this for now.

 VSS header. */ + 1024 + 1 
XXX:

XXX: HEAD_USAGE_BOUNDS, doesn't belong here. */

 TODO: flexible window mappings */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2011 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Ben Skeggs

/******************************************************************************

 * EVO channel

/******************************************************************************

 * DMA EVO channel

		/* Push buffer fetches are not coherent with BAR1, we need to ensure

		 * writes have been flushed right through to VRAM before writing PUT.

 NVIDIA stay 5 away from GET, do the same. */

	/* Wait for GET to depart from the beginning of the push buffer to

	 * prevent writing PUT == GET, which would be ignored by HW.

 Corner-case, HW idle, but non-committed work pending. */

	/* Pascal added support for 47-bit physical addresses, but some

	 * parts of EVO still only accept 40-bit PAs.

	 *

	 * To avoid issues on systems with large amounts of RAM, and on

	 * systems where an IOMMU maps pages at a high address, we need

	 * to allocate push buffers in VRAM instead.

	 *

	 * This appears to match NVIDIA's behaviour on Pascal.

	/* EVO channels are affected by a HW bug where the last 12 DWORDs

	 * of the push buffer aren't able to be used safely.

/******************************************************************************

 * Output path helpers

			/* Don't force scaler for EDID modes with

			 * same size as the native one (e.g. different

			 * refresh rate)

/******************************************************************************

 * DAC

/*

 * audio component binding for ELD notification

 TODO */

/******************************************************************************

 * Audio

/******************************************************************************

 * HDMI

 two frames, up to 17 bytes each */

 binary driver, and tegra, constant */

 We have an AVI InfoFrame, populate it to the display */

 We have a Vendor InfoFrame, populate it to the display */

 constant from tegra */

	/* If SCDC is supported by the downstream monitor, update

	 * divider / scrambling settings to what we programmed above.

/******************************************************************************

 * MST

 head is statically assigned on msto creation */

	/*

	 * When restoring duplicated states, we need to make sure that the bw

	 * remains the same and avoid recalculating it, as the connector's bpc

	 * may have changed after the state was duplicated

XXX: MST audio.*/);

	/* TODO: calculate the PBN from the dotclock and validate against the

	 * MSTB's max possible PBN

	/*

	 * XXX: Since we don't use HDR in userspace quite yet, limit the bpc

	 * to 8 to save bandwidth on the topology. In the future, we'll want

	 * to properly fix this by dynamically selecting the highest possible

	 * bpc that would fit in the topology

	/* We only want to free VCPI if this state disables the CRTC on this

	 * connector

	/* Clear any leftover MST state we didn't set ourselves by first

	 * disabling MST if it was already enabled

 And start enabling */

	/* Don't change the MST state of this connector until we've finished

	 * resuming, since we can't safely grab hpd_irq_lock in our resume

	 * path to protect mstm->is_mst without potentially deadlocking

/******************************************************************************

 * SOR

/* TODO: Should we extend this to PWM-only backlights?

 * As well, should we add a DRM helper for waiting for the backlight to acknowledge

 * the panel backlight has been shut off? Intel doesn't seem to do this, and uses a

 * fixed time delay from the vbios…

			/* Only enable dual-link if:

			 *  - Need to (i.e. rate > 165MHz)

			 *  - DCB says we can

			 *  - Not an HDMI monitor, since there's no dual-link

			 *    on HDMI.

				/* HW has no support for address-only

				 * transactions, so we're required to

				 * use custom I2C-over-AUX code.

/******************************************************************************

 * PIOR

/******************************************************************************

 * Atomic

 Disable head(s). */

 Disable plane(s). */

 Disable output path(s). */

 Flush disable. */

 Update output path(s). */

 Update head(s). */

	/* Update window->head assignment.

	 *

	 * This has to happen in an update that's not interlocked with

	 * any window channels to avoid hitting HW error checks.

	 *

	 *TODO: Proper handling of window ownership (Turing apparently

	 *      supports non-fixed mappings).

	/* Finish updating head(s)...

	 *

	 * NVD is rather picky about both where window assignments can change,

	 * *and* about certain core and window channel states matching.

	 *

	 * The EFI GOP driver on newer GPUs configures window channels with a

	 * different output format to what we do, and the core channel update

	 * in the assign_windows case above would result in a state mismatch.

	 *

	 * Delay some of the head update until after that point to workaround

	 * the issue.  This only affects the initial modeset.

	 *

	 * TODO: handle this better when adding flexible window mapping

 Update plane(s). */

 Flush update. */

 Wait for HW to signal completion. */

 Get correct count/ts if racing with vblank irq */

 Drop the RPM ref we got from nv50_disp_atomic_commit() */

	/*

	 * Grab another RPM ref for the commit tail, which will release the

	 * ref when it's finished

 We need to handle colour management on a per-plane basis. */

/******************************************************************************

 * Init

 small shared memory area we use for notifiers and semaphores */

 allocate master evo channel */

 Assign the correct format modifiers */

	/* FIXME: 256x256 cursors are supported on Kepler, however unlike Maxwell and later

	 * generations Kepler requires that we use small pages (4K) for cursor scanout surfaces. The

	 * proper fix for this is to teach nouveau to migrate fbs being used for the cursor plane to

	 * small page allocations in prepare_fb(). When this is implemented, we should also force

	 * large pages (128K) for ovly fbs in order to fix Kepler ovlys.

	 * But until then, just limit cursors to 128x128 - which is small enough to avoid ever using

	 * large pages.

 create crtc objects to represent the hw heads */

			/*

			 * FIXME: This is a hack to workaround the following

			 * issues:

			 *

			 * https://gitlab.gnome.org/GNOME/mutter/issues/759

			 * https://gitlab.freedesktop.org/xorg/xserver/merge_requests/277

			 *

			 * Once these issues are closed, this should be

			 * removed

 create encoder/connector objects based on VBIOS DCB table */

 cull any connectors we created that don't have an encoder */

 Disable vblank irqs aggressively for power-saving, safe on nv50+ */

/******************************************************************************

 * Format modifiers

/****************************************************************

 *            Log2(block height) ----------------------------+  *

 *            Page Kind ----------------------------------+  |  *

 *            Gob Height/Page Kind Generation ------+     |  |  *

 *                          Sector layout -------+  |     |  |  *

         |  |  |     |  |  */

/****************************************************************

 *            Log2(block height) ----------------------------+  *

 *            Page Kind ----------------------------------+  |  *

 *            Gob Height/Page Kind Generation ------+     |  |  *

 *                          Sector layout -------+  |     |  |  *

         |  |  |     |  |  */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

	/*XXX: This is a dirty hack until OR depth handling is

	 *     improved later for deep colour etc.

XXX:

XXX: HEAD_USAGE_BOUNDS, doesn't belong here. */

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright 2018 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * Copyright (C) 2009 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Inhibit hsync */

	/* These delay the TV signals with respect to the VGA port,

	 * they might be useful if we ever allow a CRTC to drive

	 * multiple outputs.

 Ensure that we can talk to this encoder */

 Allocate the necessary memory */

 Initialize the common members */

 Run the slave-specific initialization */

 Attach it to the specified connector. */

/*

 * Copyright 2006 Dave Airlie

 * Copyright 2007 Maarten Maathuis

 * Copyright 2007-2009 Stuart Bennett

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,

 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF

 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

 * SOFTWARE.

/*

 * misc hw access wrappers/control functions

/* CR44 takes values 0 (head A), 3 (head B) and 4 (heads tied)

 * it affects only the 8 bit vga io regs, which we access using mmio at

 * 0xc{0,2}3c*, 0x60{1,3}3*, and 0x68{1,3}3d*

 * in general, the set value of cr44 does not matter: reg access works as

 * expected and values can be set for the appropriate head by using a 0x2000

 * offset as required

 * however:

 * a) pre nv40, the head B range of PRMVIO regs at 0xc23c* was not exposed and

 *    cr44 must be set to 0 or 3 for accessing values on the correct head

 *    through the common 0xc03c* addresses

 * b) in tied mode (4) head B is programmed to the values set on head A, and

 *    access using the head B addresses can have strange results, ergo we leave

 *    tied mode in init once we know to what cr44 should be restored on exit

 *

 * the owner parameter is slightly abused:

 * 0 and 1 are treated as head values and so the set value is (owner * 3)

 * other values are treated as literal values to set

		/* This might seem stupid, but the blob does it and

		 * omitting it often locks the system up.

 CR44 is always changed on CRTC0 */

 set me harder */

/*

 * PLL getting

 to force parsing as single stage (i.e. nv40 vplls) pass pll2 as 0 */

 log2P is & 0x7 as never more than 7, and nv30/35 only uses 3 bits */

 single stage NVPLL and VPLLs use 1 << 8, MPLL uses 1 << 12 */

 only 4 bits */

 check whether vpll has been forced into single stage mode */

 Avoid divide by zero if called at an inappropriate time */

	/* the vpll on an unused head can come up with a random value, way

	 * beyond the pll limits.  for some reason this causes the chip to

	 * lock up when reading the dac palette regs, so set a valid pll here

	 * when such a condition detected.  only seen on nv11 to date

 set lowest clock within static limits */

/*

 * vga font save/restore

 graphics mode => framebuffer => no need to save */

 map first 64KiB of VRAM, holds VGA fonts etc */

 save control regs */

 store font in planes 0..3 */

 restore control regs */

/*

 * mode state save/load

		/* early chips don't allow access to PRAMDAC_TMDS_* without

 NV11 and NV20 don't have this, they stop at 0x52. */

			/* setting ENGINE_CTRL (EC) *must* come before

			 * CIO_CRE_LCD, as writing CRE_LCD sets bits 16 & 17 in

			 * EC that should not be overwritten by writing stale EC

 NV11 and NV20 stop at 0x52. */

			/* Not waiting for vertical retrace before modifying

 NB: no attempt is made to restore the bad pll later on */

/*

 * Copyright 2003 NVIDIA, Corporation

 * Copyright 2006 Dave Airlie

 * Copyright 2007 Maarten Maathuis

 * Copyright 2007-2009 Stuart Bennett

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

	/* special case of nv_read_tmds to find crtc associated with an output.

	 * this does not give a correct answer for off-chip dvi, but there's no

	 * use for such an answer anyway

	/* The BIOS scripts don't do this for us, sadly

	 * Luckily we do know the values ;-)

	 *

	 * head < 0 indicates we wish to force a setting with the overrideval

	 * (for VT restore etc.)

 dual link */

		/* digital remnants must be cleaned before new crtc

		 * values programmed.  delay is time for the vga stuff

		 * to realise it's in control again

 don't inadvertently turn it on when state written later */

			/* using saved value is ok, as (is_digital && dpms_on &&

			 * fp_control==OFF) is (at present) *only* true when

			 * fpc's most recent change was by below "off" code

 cut the FP output */

	/* Some BIOSes (e.g. the one in a Quadro FX1000) report several

	 * TMDS transmitters at the same I2C address, in the same I2C

	 * bus. This can still work because in that case one of them is

	 * always hard-wired to a reasonable configuration using straps,

	 * and the other one needs to be programmed.

	 *

	 * I don't think there's a way to know which is which, even the

	 * blob programs the one exposed via I2C for *both* heads, so

	 * let's do the same.

	/* SEL_CLK is only used on the primary ramdac

	 * It toggles spread spectrum PLL output and sets the bindings of PLLs

	 * to heads on digital outputs

	/* nv30:

	 *	bit 0		NVClk spread spectrum on/off

	 *	bit 2		MemClk spread spectrum on/off

	 * 	bit 4		PixClk1 spread spectrum on/off toggle

	 * 	bit 6		PixClk2 spread spectrum on/off toggle

	 *

	 * nv40 (observations from bios behaviour and mmio traces):

	 * 	bits 4&6	as for nv30

	 * 	bits 5&7	head dependent as for bits 4&6, but do not appear with 4&6;

	 * 			maybe a different spread mode

	 * 	bits 8&10	seen on dual-link dvi outputs, purpose unknown (set by POST scripts)

	 * 	The logic behind turning spread spectrum on/off in the first place,

	 * 	and which bit-pair to use, is unclear on nv40 (for earlier cards, the fp table

	 * 	entry has the necessary info)

 avoid being connected to both crtcs */

 Initialize the FP registers in this CRTC. */

 bit26: a bit seen on some g7x, no as yet discernable purpose */

 Deal with vsync/hsync polarity */

 LVDS screens do set this, but modes with +ve syncs are very rare */

 panel scaling first, as native would get set otherwise */

 panel handles it */

 native mode */

 gpu needs to scale */

 We want automatic scaling */

 This can override HTOTAL and VTOTAL */

 Use 20.12 fixed point format to avoid floats */

	/* if ratios are equal, SCALE_ASPECT will automatically (and correctly)

			/* vertical needs to expand to glass size (automatic)

			 * horizontal needs to be scaled at vertical scale factor

 restrict area of screen used, horizontally */

			/* horizontal needs to expand to glass size (automatic)

			 * vertical needs to be scaled at horizontal scale factor

 restrict area of screen used, vertically */

 Output property. */

 reset them */

	/* update fp_control state for any changes made by scripts,

 This could use refinement for flatpanels, but it should work this way */

 Init external transmitters */

	/* BIOS scripts usually take care of the backlight, thanks

	 * Apple for your consistency.

		/* when removing an output, crtc may not be set, but PANEL_OFF

		 * must still be run

			/* pxclk of 0 is fine for PANEL_OFF, and for a

			 * disconnected LVDS encoder there is no native_mode

/*

 * Copyright 1993-2003 NVIDIA, Corporation

 * Copyright 2006 Dave Airlie

 * Copyright 2007 Maarten Maathuis

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 blur is in hw range 0x3f -> 0x20 */

/* NV4x 0x40.. pll notes:

 * gpu pll: 0x4000 + 0x4004

 * ?gpu? pll: 0x4008 + 0x400c

 * vpll1: 0x4010 + 0x4014

 * vpll2: 0x4018 + 0x401c

 * mpll: 0x4020 + 0x4024

 * mpll: 0x4038 + 0x403c

 *

 * the first register of each pair has some unknown details:

 * bits 0-7: redirected values from elsewhere? (similar to PLL_SETUP_CONTROL?)

 * bits 20-23: (mpll) something to do with post divider?

 * bits 28-31: related to single stage mode? (bit 8/12)

 NM2 == 0 is used to determine single stage mode on two stage plls */

	/* for newer nv4x the blob uses only the first stage of the vpll below a

	 * certain clock.  for a certain nv4b this is 150MHz.  since the max

	 * output frequency of the first stage for this card is 300MHz, it is

	 * assumed the threshold is given by vco1 maxfreq/2

	/* for early nv4x, specifically nv40 and *some* nv43 (devids 0 and 6,

	 * not 8, others unknown), the blob always uses both plls.  no problem

	 * has yet been observed in allowing the use a single stage pll on all

	 * nv43 however.  the behaviour of single stage use is untested on nv40

 The blob uses this always, so let's do the same */

 again nv40 and some nv43 act more like nv3x as described above */

 Don't do unnecessary mode changes. */

 nv4ref indicates these two RPC1 bits inhibit h/v sync */

 Screen: Off; HSync: Off, VSync: On -- Not Supported */

 Screen: Off; HSync: On, VSync: Off -- Not Supported */

 Screen: Off; HSync: Off, VSync: Off */

 Screen: On; HSync: On, VSync: On */

 Each head has it's own sequencer, so we can turn it off when we want */

 Calculate our timings */

 This reportedly works around some video overlay bandwidth problems */

	/*

	* compute correct Hsync & Vsync polarity

 +hsync -vsync */

 -hsync +vsync */

 -hsync -vsync */

 +hsync +vsync */

	/*

	 * Time Sequencer

 0x20 disables the sequencer */

	/*

	 * CRTC

 framebuffer can be larger than crtc scanout area. */

	/*

	 * Some extended CRTC registers (they are not saved with the rest of the vga regs).

 framebuffer can be larger than crtc scanout area. */

 interlace off */

	/*

	* Graphics Display Controller

 256 color mode */

 map 64k mem + graphic mode */

 standard colormap translation */

 Enable graphic mode */

 Non-vga */

 enable all color planes */

/**

 * Sets up registers for the given mode/adjusted_mode pair.

 *

 * The clocks, CRTCs and outputs attached to this CRTC must be off.

 *

 * This shouldn't enable any clocks, CRTCs, or outputs, but they should

 * be easily turned on/off after this.

 Registers not directly related to the (s)vga mode */

 What is the meaning of this register? */

 A few popular values are 0x18, 0x1c, 0x38, 0x3c */

 Except for rare conditions I2C is enabled on the primary crtc */

 Set overlay to desired crtc. */

 ADDRESS_SPACE_PNVM is the same as setting HCUR_ASI */

 Unblock some timings */

 0x00 is disabled, 0x11 is lvds, 0x22 crt and 0x88 tmds */

 These values seem to vary */

 This register seems to be used by the bios to make certain decisions on some G70 cards? */

	/* probably a scratch reg, but kept for cargo-cult purposes:

	 * bit0: crtc0?, head A

	 * bit6: lvds, head A

	 * bit7: (only in X), head A

	/* The blob seems to take the current value from crtc 0, add 4 to that

	/* the blob sometimes sets |= 0x10 (which is the same as setting |=

 This is what the blob does */

 Some misc regs */

 Enable slaved mode (called MODE_TV in nv4ref.h) */

 Generic PRAMDAC regs */

 Only bit that bios and blob set. */

 turn off green mode (tv test pattern?) */

 Some values the blob sets */

/**

 * Sets up registers for the given mode/adjusted_mode pair.

 *

 * The clocks, CRTCs and outputs attached to this CRTC must be off.

 *

 * This shouldn't enable any clocks, CRTCs, or outputs, but they should

 * be easily turned on/off after this.

 unlock must come after turning off FP_TG_CONTROL in output_prepare */

 calculated in nv04_dfp_prepare, nv40 needs it written before calculating PLLs */

 init some state to saved value */

 Some more preparation. */

 turn on LFB swapping */

	/* We need to know the depth before we upload, but it's possible to

	 * get called before a framebuffer is bound.  If this is the case,

	 * mark the lut values as dirty by setting depth==0, and it'll be

	 * uploaded on the first mode_set_base()

 no fb bound */

	/* If atomic, we want to switch to the fb we were passed, so

	 * now we update pointers to do that.

 Update the framebuffer format. */

 Update the framebuffer location. */

 Update the arbitration parameters. */

	/* nv11+ supports premultiplied (PM), or non-premultiplied (NPM) alpha

	 * cursors (though NPM in combination with fp dithering may not work on

	 * nv11, from "nv" driver history)

	 * NPM mode needs NV_PCRTC_CURSOR_CONFIG_ALPHA_BLEND set and is what the

	 * blob uses, however we get given PM cursors so we use PM mode

		/* hw gets unhappy if alpha <= rgb values.  for a PM image "less

		 * than" shouldn't happen; fix "equal to" case by adding one to

		 * alpha channel (slightly inaccurate, but so is attempting to

		 * get back to NPM images, due to limits of integer precision)

 Give up ownership of vblank for page-flipped crtc */

 Queue it to the pending list */

 Synchronize with the old framebuffer */

 Emit the pageflip */

 synchronise rendering channel with the kernel's channel */

 Initialize a page flip struct */

 Keep vblanks on during flip, for the target crtc of this flip */

 Emit a page flip */

 Update the crtc struct and cleanup */

 possible_crtc's will be filled in later by crtc_init */

 SPDX-License-Identifier: MIT

/*

 * Copyright 1993-2003 NVIDIA, Corporation

 * Copyright 2007-2009 Stuart Bennett

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,

 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF

 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

 * SOFTWARE.

/****************************************************************************\

*                                                                            *

* The video arbitration routines calculate some "magic" numbers.  Fixes      *

* the snow seen when accessing the framebuffer without it.                   *

* It just works (I hope).                                                    *

*                                                                            *

	const int burst_lat = 80; /* Maximum allowable latency due

 kB/s */

 kB/s */

 B */

 Fixed FIFO refill latency. */

 lwm detect. */

 lwm -> sync. */

 fbi bus cycles (1 req + 1 busy) */

		+ 1	/* 2 edge sync.  may be very close to edge so

 fbi_d_rdv_n */

 Fbi_d_rdata */

 crtfifo load */

	mclks = 1	/* 2 edge sync.  may be very close to edge so

 arb_hp_req */

 tiling pipeline */

 latency fifo */

 memory request to fbio block */

 data returned from fbio block */

 Need to accumulate 256 bits for read */

 minimum mclk latency */

 nvclk latency */

 pclk latency */

 Conditional FIFO refill latency. */

	xclks = 2 * arb->mem_page_miss + mclks /* Extra latency due to

 Extra pagemiss latency. */

 Margin of error. */

 Account for another CRTC. */

 FIFO burst */

 Max burst not leading to overflows. */

 Max burst value with an acceptable latency. */

 FIFO low watermark */

 Empirical. */

CHIPSET_NFORCE*/ ||

CHIPSET_NFORCE2*/) {

CHIPSET_C51*/ ||

CHIPSET_C512*/) {

/*

 * Copyright 2003 NVIDIA, Corporation

 * Copyright 2006 Dave Airlie

 * Copyright 2007 Maarten Maathuis

 * Copyright 2007-2009 Stuart Bennett

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

/*

 * arbitrary limit to number of sense oscillations tolerated in one sample

 * period (observed to be at least 13 in "nvidia")

/*

 * arbitrary limit to number of conflicting sample pairs to tolerate at a

 * voltage step (observed to be at least 5 in "nvidia")

		/*

		 * wait for bit 0 clear -- out of hblank -- (say reg value 0x4),

		 * then wait for transition 0x4->0x5->0x4: enter hblank, leave

		 * hblank again

		 * use a 10ms timeout (guards against crtc being inactive, in

		 * which case blank state would never change)

 when level triggers, sense is _LO_ */

 take another reading until it agrees with sense_a... */

					/* ... unless two consecutive subsequent

 force mis-match so we loop */

 with so much oscillation, default to sense:LO */

	/*

	 * for this detection to work, there needs to be a mode set up on the

	 * CRTC.  this is presumed to be the case

 only implemented for head A for now */

 start of test range */

 testing blue won't find monochrome monitors.  I don't care */

 take sample pairs until both samples in the pair agree */

 too much oscillation defaults to LO */

	/*

	 * if sense goes LO before blue ramps to 0x18, monitor is not connected.

	 * ergo, if blue gets to 0x18, monitor must be connected

 0x94050140 */

 if there's a spare crtc, using it will minimise flicker */

 nv driver and nv31 use 0xfffffeee, nv34 and 6600 use 0xfffffece */

 do it again just in case it's a residual current */

 bios does something more complex for restoring, but I think this is good enough */

		/* bit 16-19 are bits that are set on some G70 cards,

 force any other vga encoders to bind to the other crtc */

 This could use refinement for flatpanels, but it should work this way */

/* Check if the DAC corresponding to 'encoder' is being used by

/*

 * Copyright 2013 Ilia Mirkin

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,

 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF

 * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

 * SOFTWARE.

 *

 * Implementation based on the pre-KMS implementation in xf86-video-nouveau,

 * written by Arthur Huillet.

/* Sine can be approximated with

 * http://en.wikipedia.org/wiki/Bhaskara_I's_sine_approximation_formula

 * sin(x degrees) ~= 4 x (180 - x) / (40500 - x (180 - x) )

 * Note that this only works for the range [0, 180].

 * Also note that sin(x) == -sin(x - 180)

 cos(x) = sin(x + 90) */

 Source parameters given in 16.16 fixed point, ignore fractional. */

 TODO: wait for vblank? */

 both crtc's */,

 Set up the plane properties */

 Source parameters given in 16.16 fixed point, ignore fractional. */

 It should be possible to convert hue/contrast to this */

 (BLUR_ON, LINE_HALF) */

 (WEIGHT_HEAVY, SHARPENING_ON, SMOOTHING_ON) */

 single crtc */,

 Set up the plane properties */

/*

 * Copyright (C) 2009 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 TV standard specific parameters */

/*

 * The following is some guesswork on how the TV encoder flicker

 * filter/rescaler works:

 *

 * It seems to use some sort of resampling filter, it is controlled

 * through the registers at NV_PTV_HFILTER and NV_PTV_VFILTER, they

 * control the horizontal and vertical stage respectively, there is

 * also NV_PTV_HFILTER2 the blob fills identically to NV_PTV_HFILTER,

 * but they seem to do nothing. A rough guess might be that they could

 * be used to independently control the filtering of each interlaced

 * field, but I don't know how they are enabled. The whole filtering

 * process seems to be disabled with bits 26:27 of PTV_200, but we

 * aren't doing that.

 *

 * The layout of both register sets is the same:

 *

 * A: [BASE+0x18]...[BASE+0x0] [BASE+0x58]..[BASE+0x40]

 * B: [BASE+0x34]...[BASE+0x1c] [BASE+0x74]..[BASE+0x5c]

 *

 * Each coefficient is stored in bits [31],[15:9] in two's complement

 * format. They seem to be some kind of weights used in a low-pass

 * filter. Both A and B coefficients are applied to the 14 nearest

 * samples on each side (Listed from nearest to furthermost.  They

 * roughly cover 2 framebuffer pixels on each side).  They are

 * probably multiplied with some more hardwired weights before being

 * used: B-coefficients are applied the same on both sides,

 * A-coefficients are inverted before being applied to the opposite

 * side.

 *

 * After all the hassle, I got the following formula by empirical

 * means...

 Horizontal filter parameters */

 Vertical filter parameters */

 Hardware state saving/restoring */

 This is required for some settings to kick in. */

 Timings similar to the ones the blob sets */

 The composite connector may be found on either pin. */

 The rescaler doesn't do the right thing for interlaced modes. */

/*

 * Copyright 2009 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Author: Ben Skeggs

 Disable flip completion events. */

 Disable vblank interrupts. */

 Un-pin FB and cursors so they'll be evicted to system memory. */

	/* meh.. modeset apparently doesn't setup all the regs and depends

	 * on pre-existing state, for now load the state of the card *before*

	 * nouveau was loaded, and then do a modeset.

	 *

	 * best thing to do probably is to make save/restore routines not

	 * save/restore "pre-load" state, but more general so we can save

	 * on suspend too.

 Enable flip completion events. */

 Re-pin FB/cursors. */

 Force CLUT to get re-loaded during modeset. */

	/* This should ensure we don't hit a locking problem when someone

	 * wakes us up via a connector.  We should never go into suspend

	 * while the display is on anyways.

 Restore mode. */

 Restore state */

 Pre-nv50 doesn't support atomic, so don't expose the ioctls */

 Request page flip completion event. */

 Save previous state */

/*

 * Copyright (C) 2009 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 Save the previous state. */

 Prepare the DAC for load detection.  */

 Sample pin 0x4 (usually S-video luma). */

 Sample the remaining pins. */

 Restore the previous state. */

 CVT modes are sometimes unsuitable... */

 The encoder takes care of the actual interlacing */

	/* Unbind any FP encoders from this head if we need the FP

 Set the DACCLK register */

 FP_HTIMING */

 FP_VTIMING */

 turn off green mode (tv test pattern?) */

		/* The registers in PRAMDAC+0xc00 control some timings and CSC

		 * parameters for the CTV encoder (It's only used for "HD" TV

		 * modes, I don't think I have enough working to guess what

		 * they exactly mean...), it's probably connected at the

		 * output of the FP encoder, but it also needs the analog

		 * encoder in its OR enabled and routed to the head it's

		 * using. It's enabled with the DACCLK register, bits [5:4].

 This could use refinement for flatpanels, but it should work */

		/* Disable the crtc to ensure a full modeset is

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2018 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

 call with wait_lock and dispc runtime held */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2016-2018 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Jyri Sarha <jsarha@ti.com>

	/*

	 * XXX According TRM the RGB input buffer width up to 2560 should

	 *     work on 3 taps, but in practice it only works up to 1280.

		/*

		 * The max supported pixel inc value is 255. The value

		 * of pixel inc is calculated like this: 1+(xinc-1)*bpp.

		 * The maximum bpp of all formats supported by the HW

		 * is 8. So the maximum supported xinc value is 32,

		 * because 1+(32-1)*8 < 255 < 1+(33-1)*4.

		/*

		 * The max supported pixel inc value is 255. The value

		 * of pixel inc is calculated like this: 1+(xinc-1)*bpp.

		 * The maximum bpp of all formats supported by the HW

		 * is 8. So the maximum supported xinc value is 32,

		 * because 1+(32-1)*8 < 255 < 1+(33-1)*4.

 note: vid is plane_id 0 and vidl1 is plane_id 1 */

		/*

		 * The max supported pixel inc value is 255. The value

		 * of pixel inc is calculated like this: 1+(xinc-1)*bpp.

		 * The maximum bpp of all formats supported by the HW

		 * is 8. So the maximum supported xinc value is 32,

		 * because 1+(32-1)*8 < 255 < 1+(33-1)*4.

 Currently hard coded VP routing (see dispc_initial_config()) */

/*

 * TRM gives bitfields as start:end, where start is the higher bit

 * number. For example 7:0

 always clear the top level irqstatus */

 clear the irqstatus for newly enabled irqs */

 flush posted write */

 Flush posted writes */

 clear the irqstatus for newly enabled irqs */

 VP IRQ */

 VP IRQ */

 VID IRQ */

 VID IRQ */

 Flush posted writes */

	/*

	 * For the moment DUALMODESYNC, MASTERSLAVE, MODE, and SRC

	 * bits of DISPC_VP_DSS_OLDI_CFG are set statically to 0.

 MSB */

 DEPOL */

 SOFTRST */

 ENABLE */

 always use the 'rf' setting */

 always use aligned syncs */

 always use DE_HIGH for OLDI */

 Copy c8 4 MSB to 4 LSB for full scale c12 */

 TODO: add interlace support */

	/*

	 * Enforce the output width is divisible by 2. Actually this

	 * is only needed in following cases:

	 * - YUV output selected (BT656, BT1120)

	 * - Dithering enabled

	 * - TDM with TDMCycleFormat == 3

	 * But for simplicity we enforce that always.

/*

 * Calculate the percentage difference between the requested pixel clock rate

 * and the effective rate resulting from calculating the clock divider value.

 OVR */

 On k2g there is only one plane and no need for ovr */

 CSC */

 K2G has no post offset support */

 YUV -> RGB, ITU-R BT.601, full range */

 ry, rcb, rcr |1.000  0.000  1.402|*/

 gy, gcb, gcr |1.000 -0.344 -0.714|*/

 by, bcb, bcr |1.000  1.772  0.000|*/

 full range */

 YUV -> RGB, ITU-R BT.601, limited range */

 ry, rcb, rcr |1.164  0.000  1.596|*/

 gy, gcb, gcr |1.164 -0.392 -0.813|*/

 by, bcb, bcr |1.164  2.017  0.000|*/

 limited range */

 YUV -> RGB, ITU-R BT.709, full range */

 ry, rcb, rcr |1.000	0.000  1.570|*/

 gy, gcb, gcr |1.000 -0.187 -0.467|*/

 by, bcb, bcr |1.000	1.856  0.000|*/

 full range */

 YUV -> RGB, ITU-R BT.709, limited range */

 ry, rcb, rcr |1.164  0.000  1.793|*/

 gy, gcb, gcr |1.164 -0.213 -0.533|*/

 by, bcb, bcr |1.164  2.112  0.000|*/

 limited range */

 SCALER */

 Skip the rest if no scaling is used */

		/*

		 * We need even line length for YUV formats. Decimation

		 * can lead to odd length, so we need to make it even

		 * again.

 HORIZONTAL RESIZE ENABLE */

 VERTICAL RESIZE ENABLE */

 Skip the rest if no scaling is used */

 VERTICAL 5-TAPS  */

 OTHER */

 For YUV422 format we use the macropixel size for pixel inc */

 enable YUV->RGB color conversion */

 MFLAG_CTRL = ENABLED */

 MFLAG_START = MFLAGNORMALSTARTMODE */

		/*

		 * Prefetch up to fifo high-threshold value to minimize the

		 * possibility of underflows. Note that this means the PRELOAD

		 * register is ignored.

 MFLAG_CTRL = ENABLED */

 MFLAG_START = MFLAGNORMALSTARTMODE */

 Prefech up to PRELOAD value */

 Enable the gamma Shadow bit-field for all VPs*/

 Note: Hardcoded DPI routing on J721E for now */

 VP1 to DPI0 */

 VP3 to DPI1 */

 K2G CPR is packed to three registers. */

 sentinel */ }

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2018 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

 Power management */

 CONFIG_PM */

 DRM device Information */

 If we don't have PM, we need to call resume manually */

 If we don't have PM, we need to call suspend manually */

 devm allocated dispc goes away with the dev so mark it NULL */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2018 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

	/*

	 * Add all active planes on a CRTC to the atomic state, if

	 * x/y/z position or activity of any plane on that CRTC

	 * changes. This is needed for updating the plane positions in

	 * tidss_crtc_position_planes() which is called from

	 * crtc_atomic_enable() and crtc_atomic_flush(). We have an

	 * extra flag to to mark x,y-position changes and together

	 * with zpos_changed the condition recognizes all the above

	 * cases.

 first find all the connected panels & bridges */

 all planes can be on any crtc */

 then create a plane, a crtc and an encoder for each panel/bridge */

 create overlay planes of the leftover planes */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2018 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Jyri Sarha <jsarha@ti.com>

/*

 * These are interpolated with a custom python script from DSS5

 * (drivers/gpu/drm/omapdrm/dss/dispc_coef.c) coefficients.

		/*

		 * When upscaling more than two times, blockiness and outlines

		 * around the image are observed when M8 tables are used. M11,

		 * M16 and M19 tables are used to prevent this.

	/*

	 * inc is result of 0x200000 * in_size / out_size. This dividing

	 * by 0x40000 scales it down to 8 * in_size / out_size. After

	 * division the actual scaling factor is 8/inc.

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2018 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

 Page flip and frame done IRQs */

	/*

	 * New settings are taken into use at VFP, and GO bit is cleared at

	 * the same time. This happens before the vertical blank interrupt.

	 * So there is a small change that the driver sets GO bit after VFP, but

	 * before vblank, and we have to check for that case here.

 drm_crtc_helper_funcs */

/*

 * This needs all affected planes to be present in the atomic

 * state. The untouched planes are added to the state in

 * tidss_atomic_check().

 There is nothing to do if CRTC is not going to be enabled. */

	/*

	 * Flush CRTC changes with go bit only if new modeset is not

	 * coming, so CRTC is enabled trough out the commit.

 If the GO bit is stuck we better quit here. */

 We should have event if CRTC is enabled through out this commit. */

 Write vp properties to HW if needed. */

 Update plane positions if needed. */

 Turn vertical blanking interrupt reporting on. */

 drm_crtc_funcs */

	/*

	 * The dispc gamma functions adapt to what ever size we ask

	 * from it no matter what HW supports. X-server assumes 256

	 * element gamma tables so lets use that.

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2018 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

 drm_plane_helper_funcs */

		/*

		 * The visible field is not reset by the DRM core but only

		 * updated by drm_plane_helper_check_state(), set it manually.

	/*

	 * The HW is only able to start drawing at subpixel boundary

	 * (the two first checks bellow). At the end of a row the HW

	 * can only jump integer number of subpixels forward to the

	 * beginning of the next row. So we can only show picture with

	 * integer subpixel width (the third check). However, after

	 * reaching the end of the drawn picture the drawing starts

	 * again at the absolute memory address where top left corner

	 * position of the drawn picture is (so there is no need to

	 * check for odd height).

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2018 Texas Instruments Incorporated - https://www.ti.com/

 * Author: Tomi Valkeinen <tomi.valkeinen@ti.com>

	/*

	 * Take the bus_flags from the first bridge that defines

	 * bridge timings, or from the connector's display_info if no

	 * bridge defines the timings.

 XXX any cleaner way to set bus format and flags?

 SPDX-License-Identifier: MIT

/*

 * Copyright 2020 Noralf Trønnes

 Supported properties */

 Initial gadget tv state if applicable, applied on state reset */

	/*

	 * Initial gadget backlight brightness if applicable, applied on state reset.

	 * The value -ENODEV is used to signal no backlight.

/*

 * Use a worker to avoid taking kms locks inside the backlight lock.

 * Other display drivers use backlight within their kms locks.

 * This avoids inconsistent locking rules, which would upset lockdep.

 Reuse tv.brightness to avoid having to subclass */

 The USB timeout is 5 seconds so use system_long_wq for worst case scenario */

 Set margins from command line */

/*

 * The tv.mode property is shared among the connectors and its enum names are

 * driver specific. This means that if more than one connector uses tv.mode,

 * the enum names has to be the same.

 This is a no-op if already added. */

 New ones might show up in future devices, skip those we don't know. */

 not a DRM property */

 future types */

 The first connector is attached to the existing simple pipe encoder */

 SPDX-License-Identifier: MIT

/*

 * Copyright 2020 Noralf Trønnes

 Only used internally */

/*

 * @buf cannot be allocated on the stack.

 * Returns number of bytes received or negative error code on failure.

/*

 * @buf can be allocated on the stack or NULL.

 * Returns zero on success or negative error code on failure.

/*

 * @val can be allocated on the stack.

 * Returns zero on success or negative error code on failure.

 Returns zero on success or negative error code on failure. */

			/*

			 * DRM UAPI matches the protocol so use the value directly,

			 * but mask out any additions on future devices.

 New ones might show up in future devices, skip those we don't know. */

/*

 * FIXME: Dma-buf sharing requires DMA support by the importing device.

 *        This function is a workaround to make USB devices work as well.

 *        See todo.rst for how to fix the issue in the dma-buf framework.

 Add room for emulated XRGB8888 */

 Internal not for userspace */

 Prefer speed over color depth */

 Prevent a misbehaving device from allocating loads of RAM. 4096x4096@XRGB8888 = 64 MB */

 SPDX-License-Identifier: MIT

/*

 * Copyright 2020 Noralf Trønnes

/*

 * Some userspace rendering loops runs all displays in the same loop.

 * This means that a fast display will have to wait for a slow one.

 * For this reason gud does flushing asynchronous by default.

 * The down side is that in e.g. a single display setup userspace thinks

 * the display is insanely fast since the driver reports back immediately

 * that the flush/pageflip is done. This wastes CPU and power.

 * Such users might want to set this module parameter to false.

/*

 * FIXME: The driver is probably broken on Big Endian machines.

 * See discussion:

 * https://lore.kernel.org/dri-devel/CAKb7UvihLX0hgBOP3VBG7O+atwZcUVCPVuBdfmDMpg0NjXe-cQ@mail.gmail.com/

 Assign to silence compiler warning */

 Start on a byte boundary */

 within byte from the left */

 Assign to silence compiler warning */

 Start on a byte boundary */

 within byte from the left */

	/*

	 * Imported buffers are assumed to be write-combined and thus uncached

	 * with slow reads (at least on ARM).

 can compress directly from the framebuffer */

 Did it wrap around? */

	/*

	 * pipe_update waits for the worker when the display mode is going to change.

	 * This ensures that the width and height is still the same making it safe to

	 * add back the damage.

 Retry only once to avoid a possible storm in case of continues errors. */

 Split update if it's too big */

 Only one connector is supported */

	/*

	 * DRM_IOCTL_MODE_OBJ_SETPROPERTY on the rotation property will not have

	 * the connector included in the state.

 DRM UAPI matches the protocol so use value directly */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2015 Etnaviv Project

/*

 * Cmdstream submission:

 make sure these don't conflict w/ ETNAVIV_SUBMIT_BO_x */

		/* normally use drm_gem_object_lookup(), but for bulk lookup

		 * all under single table_lock just hit object_idr directly:

		/*

		 * Take a refcount on the object. The file table lock

		 * prevents the object_idr's refcount on this being dropped.

 we lost out in a seqno race, lock and retry.. */

 process the reloc's and patch up the cmdstream as needed: */

 Submits using softpin don't blend with relocs */

 offset in dwords: */

 at offset 0 a sequence number gets stored used for userspace sync */

 unpin all objects */

 if the GPU submit failed, objects might still be locked */

 first remove from IDR, so fence can not be found anymore */

	/*

	 * Copy the command submission and bo array to kernel space in

	 * one go, and do this outside of any locks.

		/*

		 * This can be improved: ideally we want to allocate the sync

		 * file before kicking off the GPU job and just attach the

		 * fence to the sync file here, eliminating the ENOMEM

		 * possibility at this stage.

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2015-2018 Etnaviv Project

/*

 * Driver functions:

 This overrides the value from older register if non-zero */

 Fill in the stream count if not specified */

 Convert the register max value */

 Convert thread count */

 Convert virtex buffer size */

	/*

	 * For some cores, two varyings are consumed for position, so the

	 * maximum varying count needs to be reduced by one.

 Special case for older graphic cores. */

		/*

		 * Reading these two registers on GC600 rev 0x19 result in a

		 * unhandled fault: external abort on non-linefetch

		/*

		 * !!!! HACK ALERT !!!!

		 * Because people change device IDs without letting software

		 * know about it - here is the hack to make it all look the

		 * same.  Only for GC400 family.

 Another special case */

				/*

				 * This IP has an ECO; put the correct

				 * revision in it.

		/*

		 * NXP likes to call the GPU on the i.MX6QP GC2000+, but in

		 * reality it's just a re-branded GC3000. We can identify this

		 * core by the upper half of the revision register being all 1.

		 * Fix model/rev here, so all other places can refer to this

		 * core by its real identity.

	/*

	 * If there is a match in the HWDB, we aren't interested in the

	 * remaining register values, as they might be wrong.

 Disable fast clear on GC700. */

		/*

		 * GC500 rev 1.x and GC300 rev < 2.0 doesn't have these

		 * registers.

 GC600 idle register reports zero bits where modules aren't present */

 We hope that the GPU resets in under one second */

 enable clock */

 isolate the GPU. */

 set soft reset. */

 wait for reset. */

 reset soft reset bit. */

 reset GPU isolation. */

 read idle register. */

 try resetting again if FE is not idle */

 read reset register. */

 is the GPU idle? */

 disable debug registers, as they are not normally needed */

 We rely on the GPU running, so program the clock */

 enable clock gating */

 Disable stall module clock gating for 4.3.0.1 and 4.3.0.2 revs */

 Disable PA clock gating for GC400+ without bugfix except for GC420 */

	/*

	 * Disable PE clock gating on revs < 5.0.0.0 when HZ is

	 * present without a bug fix.

 Unknown bit */

 Disable TX clock gating on affected core revisions. */

 Disable SE, RA and TX clock gating on affected core revisions. */

 setup the MMU */

 Start command processor */

	/*

	 * Base value for VIVS_PM_PULSE_EATER register on models where it

	 * cannot be read, extracted from vivante kernel driver.

 Performance fix: disable internal DFS */

 enable module-level clock gating */

	/*

	 * Update GPU AXI cache atttribute to "cacheable, no allocate".

	 * This is necessary to prevent the iMX6 SoC locking up.

 GC2000 rev 5108 needs a special bus config */

 setup the pulse eater */

 Exclude VG cores with FE2.0 */

	/*

	 * On cores with security features supported, we claim control over the

	 * security states.

	/*

	 * If the GPU is part of a system with DMA addressing limitations,

	 * request pages for our SHM backend buffers from the DMA32 zone to

	 * hopefully avoid performance killing SWIOTLB bounce buffering.

 Create buffer: */

	/*

	 * Set the GPU linear window to cover the cmdbuf region, as the GPU

	 * won't be able to start execution otherwise. The alignment to 128M is

	 * chosen arbitrarily but helps in debugging, as the MMU offset

	 * calculations are much more straight forward this way.

	 *

	 * On MC1.0 cores the linear window offset is ignored by the TS engine,

	 * leading to inconsistent memory views. Avoid using the offset on those

	 * cores if possible, otherwise disable the TS feature.

 Setup event management */

 Now program the hardware */

 complete all events, the GPU won't do it after the reset */

 fence object management */

	/*

	 * GPU lock must already be held, otherwise fence completion order might

	 * not match the seqno order assigned here.

 returns true if fence a comes after fence b */

/*

 * event management:

/*

 * Cmdstream submission/retirement:

	/*

	 * Look up the fence and take a reference. We might still find a fence

	 * whose refcount has already dropped to zero. dma_fence_get_rcu

	 * pretends we didn't find a fence in that case.

 No timeout was requested: just test for completion */

/*

 * Wait for an object to become inactive.  This, on it's own, is not race

 * free: the object is moved by the scheduler off the active list, and

 * then the iova is put.  Moreover, the object could be re-submitted just

 * after we notice that it's become inactive.

 *

 * Although the retirement happens under the gpu lock, we don't want to hold

 * that lock in this function while waiting.

 disable clock gating */

 enable debug register */

 disable debug register */

 enable clock gating */

 add bo's to gpu's ring, and kick gpu: */

	/*

	 * if there are performance monitor requests we need to have

	 * - a sync point to re-configure gpu and process ETNA_PM_PROCESS_PRE

	 *   requests.

	 * - a sync point to re-configure gpu, process ETNA_PM_PROCESS_POST requests

	 *   and update the sequence number for userspace.

 restart FE last to avoid GPU and IRQ racing against this worker */

			/*

			 * Events can be processed out of order.  Eg,

			 * - allocate and queue event 0

			 * - allocate event 1

			 * - event 0 completes, we process it

			 * - allocate and queue event 0

			 * - event 1 and event 0 complete

			 * we can end up processing event 0 first, then 1.

 Replace the last WAIT with END */

		/*

		 * We know that only the FE is busy here, this should

		 * happen quickly (as the WAIT is only 200 cycles).  If

		 * we fail, just warn and continue.

 sentinel */ }

 Map registers: */

 Get Interrupt: */

 Get Clocks: */

 TODO: figure out max mapped size */

	/*

	 * We treat the device as initially suspended.  The runtime PM

	 * autosuspend delay is rather arbitary: no measurements have

	 * yet been performed to determine an appropriate value.

 If there are any jobs in the HW queue, we're not idle */

 Check whether the hardware (except FE and MC) is idle */

 Re-initialise the basic hardware state */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2015-2018 Etnaviv Project

/*

 * DRM operations:

/*

 * DRM debugfs:

	/*

	 * Lock the GPU to avoid a MMU context switch just now and elevate

	 * the refcount of the current context to avoid it disappearing from

	 * under our feet.

/*

 * DRM ioctls:

/*

 * Platform driver:

	/*

	 * If the DT contains at least one available GPU device, instantiate

	 * the DRM platform device.

		/*

		 * Apply the same DMA configuration to the virtual etnaviv

		 * device as the GPU we found. This assumes that all Vivante

		 * GPUs in the system share the same DMA constraints.

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2015-2018 Etnaviv Project

	/*

	 * For non-cached buffers, ensure the new pages are clean

	 * because display controller, GPU, etc. are not coherent.

	/*

	 * For non-cached buffers, ensure the new pages are clean

	 * because display controller, GPU, etc. are not coherent:

	 *

	 * WARNING: The DMA API does not support concurrent CPU

	 * and device access to the memory area.  With BIDIRECTIONAL,

	 * we will clean the cache lines which overlap the region,

	 * and invalidate all cache lines (partially) contained in

	 * the region.

	 *

	 * If you have dirty data in the overlapping cache lines,

	 * that will corrupt the GPU-written data.  If you have

	 * written into the remainder of the region, this can

	 * discard those writes.

 called with etnaviv_obj->lock held */

 when we start tracking the pin count, then do something here */

		/*

		 * Shunt off cached objs to shmem file so they have their own

		 * address_space (so unmap_mapping_range does what we want,

		 * in particular in the case of mmap'd dmabufs)

	/*

	 * Make sure we don't parallel update on a fault, nor move or remove

	 * something from beneath our feet.  Note that vmf_insert_page() is

	 * specifically coded to take care of this, so we don't have to.

 make sure we have pages attached now */

 We don't use vmf->pgoff since that has the fake offset: */

 Make it mmapable */

		/*

		 * Holding the object lock prevents the use count changing

		 * beneath us.  If the use count is zero, the MMU might be

		 * reaping this object, so take the lock and re-check that

		 * the MMU owns this mapping to close this race.

	/*

	 * See if we have a reaped vram mapping we can re-use before

	 * allocating a fresh mapping.

 Take a reference on the object */

	/*

	 * Need to check again, as we might have raced with another thread

	 * while waiting for the mutex.

 fini without a prep is almost certainly a userspace error */

 object should not be active */

 validate flags */

 convenience method to construct a GEM buffer object, and userspace handle */

	/*

	 * Our buffers are kept pinned, so allocating them from the MOVABLE

	 * zone is a really bad idea, and conflicts with CMA. See comments

	 * above new_inode() why this is required _and_ expected if you're

	 * going to pin these pages.

 drop reference from allocate - handle holds it now */

 drop reference from allocate - handle holds it now */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2015-2018 Etnaviv Project

 unroll mapping in case something went wrong */

 Try to retire some entries */

 If this vram node has not been used, skip this. */

			/*

			 * If the iova is pinned, then it's in-use,

			 * so we must keep its mapping.

 Nothing found, clean up and fail */

		/*

		 * drm_mm does not allow any other operations while

		 * scanning, so we have to remove all blocks first.

		 * If drm_mm_scan_remove_block() returns false, we

		 * can leave the block pinned.

		/*

		 * Unmap the blocks which need to be reaped from the MMU.

		 * Clear the mmu pointer to prevent the mapping_get finding

		 * this mapping.

		/*

		 * We removed enough mappings so that the new allocation will

		 * succeed, retry the allocation one more time.

 v1 MMU can optimize single entry (contiguous) scatterlists */

 If the vram node is on the mm, unmap and remove the node */

	/*

	 * For MMUv1 we don't add the suballoc region to the pagetables, as

	 * those GPUs can only work with cmdbufs accessed through the linear

	 * window. Instead we manufacture a mapping to make it look uniform

	 * to the upper layers.

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2017 Etnaviv Project

 block scheduler */

	/*

	 * If the GPU managed to complete this jobs fence, the timout is

	 * spurious. Bail out.

	/*

	 * If the GPU is still making forward progress on the front-end (which

	 * should never loop) we shift out the timeout to give it a chance to

	 * finish the job.

 get the GPU back into the init state */

 restart scheduler after GPU is usable again */

	/*

	 * Hold the fence lock across the whole operation to avoid jobs being

	 * pushed out of order with regard to their sched fence seqnos as

	 * allocated in drm_sched_job_init.

 the scheduler holds on to the job now */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2015-2018 Etnaviv Project

 2D */

 3D */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2018 Etnaviv Project

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2017-2018 Etnaviv Project

 suballocated dma buffer properties */

 allocation management */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2017 Etnaviv Project

 * Copyright (C) 2017 Zodiac Inflight Innovations

 profile register */

 switch back to pixel pipe 0 to prevent GPU hang */

 switch back to pixel pipe 0 to prevent GPU hang */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2014-2018 Etnaviv Project

 should have already pinned! */

	/* Don't drop the pages for imported dmabuf, as they are not

	 * ours, just free the array we allocated:

 .get_pages should never be called */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2016-2018 Etnaviv Project

 M(aster) TLB aka first level pagetable */

 S(lave) TLB aka second level pagetable */

 If the MMU is already enabled the state is still there. */

 If the MMU is already enabled the state is still there. */

 trigger a PTA load through the FE */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2014-2018 Etnaviv Project

/*

 * Command Buffer helper:

 write a register via cmd stream */

	/*

	 * This assumes that if we're switching to 2D, we're switching

	 * away from 3D, and vice versa.  Hence, if we're switching to

	 * the 2D core, we need to flush the 3D depth and color caches,

	 * otherwise we need to flush the 2D pixel engine cache.

/*

 * Safely replace the WAIT of a waitlink with a new command and argument.

 * The GPU may be executing this WAIT while we're modifying it, so we have

 * to write it in a specific order to avoid the GPU branching to somewhere

 * else.  'wl_offset' is the offset to the first byte of the WAIT command.

/*

 * Ensure that there is space in the command buffer to contiguously write

 * 'cmd_dwords' 64-bit words into the buffer, wrapping if necessary.

 initialize buffer */

 Replace the last link-wait with an "END" command */

 Append a 'sync point' to the ring buffer. */

	/*

	 * We need at most 3 dwords in the return target:

	 * 1 event + 1 end + 1 wait + 1 link.

 Signal sync point event */

 Stop the FE to 'pause' the GPU */

 Append waitlink */

	/*

	 * Kick off the 'sync point' command by replacing the previous

	 * WAIT with a link to the address in the ring buffer.

 Append a command buffer to the ring buffer. */

	/*

	 * If we need maintenance prior to submitting this buffer, we will

	 * need to append a mmu flush load state, followed by a new

	 * link to this buffer - a total of four additional words.

 link command */

 flush command */

 pipe switch commands */

 PTA load command */

		/*

		 * Switch MMU context if necessary. Must be done after the

		 * link target has been calculated, as the jump forward in the

		 * kernel ring still uses the last active MMU context before

		 * the switch.

 Add the MMU flush */

 And the link to the submitted buffer */

 Update the link target to point to above instructions */

	/*

	 * Append a LINK to the submitted command buffer to return to

	 * the ring buffer.  return_target is the ring target address.

	 * We need at most 7 dwords in the return target: 2 cache flush +

	 * 2 semaphore stall + 1 event + 1 wait + 1 link.

	/*

	 * When the BLT engine is present we need 6 more dwords in the return

	 * target: 3 enable/flush/disable + 4 enable/semaphore stall/disable,

	 * but we don't need the normal TS flush state.

	/*

	 * Append a cache flush, stall, event, wait and link pointing back to

	 * the wait command to the ring buffer.

	/*

	 * Kick off the submitted command by replacing the previous

	 * WAIT with a link to the address in the ring buffer.

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2014-2018 Etnaviv Project

 set base addresses */

 set page table address in MC */

	/*

	 * MMUv1 does not support switching between different contexts without

	 * a stop the world operation, so we only support a single shared

	 * context with this version.

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) 2015-2018 Etnaviv Project

 Only catch the first event, or when manually re-armed */

 We always dump registers, mmu, ring, hanging cmdbuf and end marker */

 Add in the active buffer objects */

 If we have any buffer objects, add a bomap object */

 Add the size of the headers */

 Allocate the file in vmalloc memory, it's likely to be big */

 Point the data member after the headers */

 Reserve space for the bomap */

 Silence warning */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Traphandler

 * Copyright (C) 2014 Free Electrons

 * Copyright (C) 2014 Atmel

 *

 * Author: Jean-Jacques Hiblot <jjhiblot@traphandler.com>

 * Author: Boris BREZILLON <boris.brezillon@free-electrons.com>

	/*

	 * Always scan the first few endpoints even if we get -ENODEV,

	 * but keep going after that as long as we keep getting hits.

 At least one device was successfully attached.*/

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Traphandler

 * Copyright (C) 2014 Free Electrons

 * Copyright (C) 2014 Atmel

 *

 * Author: Jean-Jacques Hiblot <jjhiblot@traphandler.com>

 * Author: Boris BREZILLON <boris.brezillon@free-electrons.com>

 sentinel */ },

 Enable interrupts on activated layers */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Free Electrons

 * Copyright (C) 2014 Atmel

 *

 * Author: Boris BREZILLON <boris.brezillon@free-electrons.com>

/**

 * struct atmel_hlcdc_plane_state - Atmel HLCDC Plane state structure.

 *

 * @base: DRM plane state

 * @crtc_x: x position of the plane relative to the CRTC

 * @crtc_y: y position of the plane relative to the CRTC

 * @crtc_w: visible width of the plane

 * @crtc_h: visible height of the plane

 * @src_x: x buffer position

 * @src_y: y buffer position

 * @src_w: buffer width

 * @src_h: buffer height

 * @disc_x: x discard position

 * @disc_y: y discard position

 * @disc_w: discard width

 * @disc_h: discard height

 * @ahb_id: AHB identification number

 * @bpp: bytes per pixel deduced from pixel_format

 * @offsets: offsets to apply to the GEM buffers

 * @xstride: value to add to the pixel pointer between each line

 * @pstride: value to add to the pixel pointer between each pixel

 * @nplanes: number of planes (deduced from pixel_format)

 * @dscrs: DMA descriptors

 These fields are private and should not be touched */

 DMA descriptors. */

	/*

	 * Rotation optimization is not working on RGB888 (rotation is still

	 * working but without any optimization).

 TODO: implement a smarter hidden area detection */

	/*

	 * Swap width and size in case of 90 or 270 degrees rotation

 Disable interrupts */

 Disable the layer */

 Clear all pending interrupts */

 Enable the overrun interrupts. */

 Apply the new config at the next SOF event. */

		/*

		 * TODO: decare a "yuv-to-rgb-conv-factors" property to let

		 * userspace modify these factors (using a BLOB property ?).

	/*

	 * There's not much we can do in case of overrun except informing

	 * the user. However, we are in interrupt context here, hence the

	 * use of dev_dbg().

 Set default property values*/

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Traphandler

 * Copyright (C) 2014 Free Electrons

 *

 * Author: Jean-Jacques Hiblot <jjhiblot@traphandler.com>

 * Author: Boris BREZILLON <boris.brezillon@free-electrons.com>

/**

 * struct atmel_hlcdc_crtc_state - Atmel HLCDC CRTC state structure

 *

 * @base: base CRTC state

 * @output_mode: RGBXXX output mode

/**

 * struct atmel_hlcdc_crtc - Atmel HLCDC CRTC structure

 *

 * @base: base DRM CRTC structure

 * @dc: pointer to the atmel_hlcdc structure provided by the MFD device

 * @event: pointer to the current page flip event

 * @id: CRTC id (returned by drm_crtc_index)

 The divider ended up too big, try a lower base rate. */

			/*

			 * At least 10 times better when using a higher

			 * frequency than requested, instead of a lower.

			 * So, go with that.

 Enable SOF (Start Of Frame) interrupt for vblank counting */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (C) 2016 Marek Vasut <marex@denx.de>

 *

 * This code is based on drivers/video/fbdev/mxsfb.c :

 * Copyright (C) 2010 Juergen Beisert, Pengutronix

 * Copyright (C) 2008-2009 Freescale Semiconductor, Inc. All Rights Reserved.

 * Copyright (C) 2008 Embedded Alley Solutions, Inc All Rights Reserved.

	/*

	 * Starting at i.MX6 the hardware version register is gone, use the

	 * i.MX family number as the version.

	/*

	 * Get hold of the connector. This is a bit of a hack, until the bridge

	 * API gives us bus flags and formats.

 Disable and clear VBLANK IRQ */

 Modeset init */

 Start with vertical blanking interrupt reporting disabled. */

 sentinel */ }

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (C) 2016 Marek Vasut <marex@denx.de>

 *

 * This code is based on drivers/video/fbdev/mxsfb.c :

 * Copyright (C) 2010 Juergen Beisert, Pengutronix

 * Copyright (C) 2008-2009 Freescale Semiconductor, Inc. All Rights Reserved.

 * Copyright (C) 2008 Embedded Alley Solutions, Inc All Rights Reserved.

 1 second delay should be plenty of time for block reset */

/* -----------------------------------------------------------------------------

 * CRTC

/*

 * Setup the MXSFB registers for decoding the pixels out of the framebuffer and

 * outputting them on the bus.

 CTRL1 contains IRQ config and status bits, preserve those. */

 Do not use packed pixels = one pixel per word instead. */

 Increase number of outstanding requests on all supported IPs */

 If it was disabled, re-enable the mode again */

 Enable the SYNC signals first, then the DMA engine */

	/*

	 * Enable recovery on underflow.

	 *

	 * There is some sort of corner case behavior of the controller,

	 * which could rarely be triggered at least on i.MX6SX connected

	 * to 800x480 DPI panel and i.MX8MM connected to DPI->DSI->LVDS

	 * bridged 1920x1080 panel (and likely on other setups too), where

	 * the image on the panel shifts to the right and wraps around.

	 * This happens either when the controller is enabled on boot or

	 * even later during run time. The condition does not correct

	 * itself automatically, i.e. the display image remains shifted.

	 *

	 * It seems this problem is known and is due to sporadic underflows

	 * of the LCDIF FIFO. While the LCDIF IP does have underflow/overflow

	 * IRQs, neither of the IRQs trigger and neither IRQ status bit is

	 * asserted when this condition occurs.

	 *

	 * All known revisions of the LCDIF IP have CTRL1 RECOVER_ON_UNDERFLOW

	 * bit, which is described in the reference manual since i.MX23 as

	 * "

	 *   Set this bit to enable the LCDIF block to recover in the next

	 *   field/frame if there was an underflow in the current field/frame.

	 * "

	 * Enable this bit to mitigate the sporadic underflows.

	/*

	 * Even if we disable the controller here, it will still continue

	 * until its FIFOs are running out of data

/*

 * Clear the bit and poll it cleared.  This is usually called with

 * a reset address and mask being either SFTRST(bit 31) or CLKGATE

 * (bit 30).

	/*

	 * It seems, you can't re-program the controller if it is still

	 * running. This may lead to shifted pictures (FIFO issue?), so

	 * first stop the controller and drain its FIFOs.

 Mandatory eLCDIF reset as per the Reference Manual */

 Clear the FIFOs */

 Always in DOTCLOCK mode */

 Make sure Data Enable is high active by default */

	/*

	 * DRM_BUS_FLAG_PIXDATA_DRIVE_ defines are controller centric,

	 * controllers VDCTRL0_DOTCLK is display centric.

	 * Drive on positive edge       -> display samples on falling edge

	 * DRM_BUS_FLAG_PIXDATA_DRIVE_POSEDGE -> VDCTRL0_DOTCLK_ACT_FALLING

 Frame length in lines. */

 Line length in units of clocks or pixels. */

 The primary plane has to be enabled when the CRTC is active. */

 TODO: Is this needed ? */

 If there is a bridge attached to the LCDIF, use its bus format */

 If there is no bridge, use bus format from connector */

 If all else fails, default to RGB888_1X24 */

 Write cur_buf as well to avoid an initial corrupt frame */

 Clear and enable VBLANK IRQ */

 Disable and clear VBLANK IRQ */

/* -----------------------------------------------------------------------------

 * Encoder

/* -----------------------------------------------------------------------------

 * Planes

	/*

	 * HACK: The hardware seems to output 64 bytes of data of unknown

	 * origin, and then to proceed with the framebuffer. Until the reason

	 * is understood, live with the 16 initial invalid pixels on the first

	 * line and start 64 bytes within the framebuffer.

	/*

	 * If the plane was previously disabled, write LCDC_AS_BUF as well to

	 * provide the first buffer.

/* -----------------------------------------------------------------------------

 * Initialization

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 *  Xen para-virtual DRM device

 *

 * Copyright (C) 2016-2018 EPAM Systems Inc.

 *

 * Author: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>

 ensure we see queued responses up to rp */

 ensure we see ring contents up to prod */

 ensure ring contents */

 release all who still waits for response if any */

 end access and free the page */

 write control channel ring reference */

 write event channel ring reference */

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 *  Xen para-virtual DRM device

 *

 * Copyright (C) 2016-2018 EPAM Systems Inc.

 *

 * Author: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>

 set for buffers allocated by the backend */

 this is for imported PRIME buffer */

		/*

		 * backend will allocate space for this buffer, so

		 * only allocate array of pointers to pages

		/*

		 * allocate ballooned pages which will be used to map

		 * grant references provided by the backend

	/*

	 * need to allocate backing pages now, so we can share those

	 * with the backend

	/*

	 * clear the VM_PFNMAP flag that was set by drm_gem_mmap(), and set the

	 * vm_pgoff (used as a fake buffer offset by DRM) to 0 as we want to map

	 * the whole buffer.

	/*

	 * According to Xen on ARM ABI (xen/include/public/arch-arm.h):

	 * all memory which is shared with other entities in the system

	 * (including the hypervisor and other guests) must reside in memory

	 * which is mapped as Normal Inner Write-Back Outer Write-Back

	 * Inner-Shareable.

	/*

	 * vm_operations_struct.fault handler will be called if CPU access

	 * to VM is here. For GPUs this isn't the case, because CPU

	 * doesn't touch the memory. Insert pages now, so both CPU and GPU are

	 * happy.

	 * FIXME: as we insert all the pages now then no .fault handler must

	 * be called, so don't provide one

 Please see comment in gem_mmap_obj on mapping and attributes. */

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 *  Xen para-virtual DRM device

 *

 * Copyright (C) 2016-2018 EPAM Systems Inc.

 *

 * Author: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>

/*

 * Timeout in ms to wait for frame done event from the backend:

 * must be a bit more than IO time-out

 Make sure we can restart with enabled connector next time */

 release stalled event if any */

	/*

	 * This runs in interrupt context, e.g. under

	 * drm_info->front_info->io_lock, so we cannot call _sync version

	 * to cancel the work

	/*

	 * If old_plane_state->fb is NULL and plane_state->fb is not,

	 * then this is an atomic commit which will enable display.

	 * If old_plane_state->fb is not NULL and plane_state->fb is,

	 * then this is an atomic commit which will disable display.

	 * Ignore these and do not send page flip as this framebuffer will be

	 * sent to the backend as a part of display_set_config call.

			/*

			 * Report the flip not handled, so pending event is

			 * sent, unblocking user-space.

		/*

		 * Signal that page flip was handled, pending event will be sent

		 * on frame done event from the backend.

	/*

	 * Xen doesn't initialize vblanking via drm_vblank_init(), so

	 * DRM helpers assume that it doesn't handle vblanking and start

	 * sending out fake VBLANK events automatically.

	 *

	 * As xen contains it's own logic for sending out VBLANK events

	 * in send_pending_event(), disable no_vblank (i.e., the xen

	 * driver has vblanking support).

	/*

	 * Send page flip request to the backend *after* we have event cached

	 * above, so on page flip done event from the backend we can

	 * deliver it and there is no race condition between this code and

	 * event from the backend.

	 * If this is not a page flip, e.g. no flip done event from the backend

	 * is expected, then send now.

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 *  Xen para-virtual DRM device

 *

 * Copyright (C) 2016-2018 EPAM Systems Inc.

 *

 * Author: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>

	/*

	 * For the backend allocated buffer release references now, so backend

	 * can free the buffer.

	/*

	 * Do this regardless of communication status with the backend:

	 * if we cannot remove remote resources remove what we can locally.

	/*

	 * Dumb creation is a two stage process: first we create a fully

	 * constructed GEM object which is communicated to the backend, and

	 * only after that we can create GEM's handle. This is done so,

	 * because of the possible races: once you create a handle it becomes

	 * immediately visible to user-space, so the latter can try accessing

	 * object without pages etc.

	 * For details also see drm_gem_handle_create

 This is the tail of GEM object creation */

 Drop reference from allocate - handle holds it now */

 drop reference from allocate */

 Nothing to do if device is already unplugged */

	/*

	 * If we are not using backend allocated buffers, then tell the

	 * backend we are ready to (re)initialize. Otherwise, wait for

	 * drm_driver.release.

 Create event channels for all connectors and publish */

 Tell the backend to wait until we release the DRM driver. */

 recovering after backend unexpected closure */

 recovering after backend unexpected closure */

		/*

		 * in this state backend starts freeing resources,

		 * so let it go into closed state, so we can also

		 * remove ours

	/*

	 * On driver removal it is disconnected from XenBus,

	 * so no backend state change events come via .otherend_changed

	 * callback. This prevents us from exiting gracefully, e.g.

	 * signaling the backend to free event channels, waiting for its

	 * state to change to XenbusStateClosed and cleaning at our end.

	 * Normally when front driver removed backend will finally go into

	 * XenbusStateInitWait state.

	 *

	 * Workaround: read backend's state manually and wait with time-out.

 At the moment we only support case with XEN_PAGE_SIZE == PAGE_SIZE */

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 *  Xen para-virtual DRM device

 *

 * Copyright (C) 2016-2018 EPAM Systems Inc.

 *

 * Author: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 *  Xen para-virtual DRM device

 *

 * Copyright (C) 2016-2018 EPAM Systems Inc.

 *

 * Author: Oleksandr Andrushchenko <oleksandr_andrushchenko@epam.com>

 either no entry configured or wrong resolution set */

 SPDX-License-Identifier: GPL-2.0

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 *    Zheng Yang <zhengyang@rock-chips.com>

 The CEA Video ID (VIC) of the current drm display mode. */

 For i2c operation. */

 Clear the EDID interrupt flag and mute the interrupt. */

	/*

	 * When the IP controller isn't configured with accurate video timing,

	 * DDC_CLK should be equal to the PLLA frequency, which is 30MHz,

	 * so we need to init the TMDS rate to the PCLK rate and reconfigure

	 * the DDC clock.

 Set the details for the external polarity and interlace mode. */

 Set the details for the external video timing. */

 TMDS uses the same frequency as dclk. */

	/*

	 * The semi-public documentation does not describe the hdmi registers

	 * used by the function rk3066_hdmi_phy_write(), so we keep using

	 * these magic values for now.

 Mute video and audio output. */

 Set power state to mode B. */

 Input video mode is RGB 24 bit. Use external data enable signal. */

	/*

	 * When the IP controller is configured with accurate video

	 * timing, the TMDS clock source should be switched to

	 * DCLK_LCDC, so we need to init the TMDS rate to the pixel mode

	 * clock rate and reconfigure the DDC clock.

 Unmute video output. */

 Store the display mode for plugin/DPMS poweron events. */

	/*

	 * If we failed to find the CRTC(s) which this encoder is

	 * supposed to be connected to, it's because the CRTC has

	 * not been registered yet.  Defer probing, and hope that

	 * the required CRTC is added later.

	/*

	 * The DDC module only supports read EDID message, so

	 * we assume that each word write to this i2c adapter

	 * should be the offset of the EDID word address.

 Set edid fifo first address. */

 Set edid word address 0x00/0x80. */

 Set edid segment pointer. */

 Unmute HDMI EDID interrupt. */

 Mute HDMI EDID interrupt. */

 internal hclk = hdmi_hclk / 25 */

 sentinel */ },

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 *    Zheng Yang <zhengyang@rock-chips.com>

 *    Yakir Yang <ykk@rock-chips.com>

	/*

	 * YUV2RGB:601 SD mode(Y[16:235], UV[16:240], RGB[0:255]):

	 *   R = 1.164*Y + 1.596*V - 204

	 *   G = 1.164*Y - 0.391*U - 0.813*V + 154

	 *   B = 1.164*Y + 2.018*U - 258

	/*

	 * YUV2RGB:601 SD mode(YUV[0:255],RGB[0:255]):

	 *   R = Y + 1.402*V - 248

	 *   G = Y - 0.344*U - 0.714*V + 135

	 *   B = Y + 1.772*U - 227

	/*

	 * YUV2RGB:709 HD mode(Y[16:235],UV[16:240],RGB[0:255]):

	 *   R = 1.164*Y + 1.793*V - 248

	 *   G = 1.164*Y - 0.213*U - 0.534*V + 77

	 *   B = 1.164*Y + 2.115*U - 289

	/*

	 * RGB2YUV:601 SD mode:

	 *   Cb = -0.291G - 0.148R + 0.439B + 128

	 *   Y  = 0.504G  + 0.257R + 0.098B + 16

	 *   Cr = -0.368G + 0.439R - 0.071B + 128

	/*

	 * RGB2YUV:709 HD mode:

	 *   Cb = - 0.338G - 0.101R + 0.439B + 128

	 *   Y  = 0.614G   + 0.183R + 0.062B + 16

	 *   Cr = - 0.399G + 0.439R - 0.040B + 128

	/*

	 * RGB[0:255]2RGB[16:235]:

	 *   R' = R x (235-16)/255 + 16;

	 *   G' = G x (235-16)/255 + 16;

	 *   B' = B x (235-16)/255 + 16;

 Clear the EDID interrupt flag and mute the interrupt */

 Input video mode is SDR RGB24bit, data enable signal from external */

 Input color hardcode to RGB, and output color hardcode to RGB888 */

 Set detail external video timing polarity and interlace mode */

 Set detail external video timing */

 Mute video and audio output */

 Set HDMI Mode */

	/*

	 * When IP controller have configured to an accurate video

	 * timing, then the TMDS clock source would be switched to

	 * DCLK_LCDC, so we need to init the TMDS rate to mode pixel

	 * clock rate, and reconfigure the DDC clock.

 Unmute video and audio output */

 Store the display mode for plugin/DPMS poweron events */

	/*

	 * If we failed to find the CRTC(s) which this encoder is

	 * supposed to be connected to, it's because the CRTC has

	 * not been registered yet.  Defer probing, and hope that

	 * the required CRTC is added later.

 Clear HDMI EDID interrupt flag */

	/*

	 * The DDC module only support read EDID message, so

	 * we assume that each word write to this i2c adapter

	 * should be the offset of EDID word address.

 Set edid fifo first addr */

 Set edid word address 0x00/0x80 */

 Set edid segment pointer */

 Clear the EDID interrupt flag and unmute the interrupt */

 Mute HDMI EDID interrupt */

	/*

	 * When IP controller haven't configured to an accurate video

	 * timing, then the TMDS clock source would be switched to

	 * PCLK_HDMI, so we need to init the TMDS rate to PCLK rate,

	 * and reconfigure the DDC clock.

 Unmute hotplug interrupt */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:Mark Yao <mark.yao@rock-chips.com>

	/*

	 * hs_start interrupt fires at frame-start, so serves

	 * the same purpose as dsp_hold in the driver.

 no act_info on window1 */

	/*

	 * hs_start interrupt fires at frame-start, so serves

	 * the same purpose as dsp_hold in the driver.

/*

 * Note: rk3288 has a dedicated 'cursor' window, however, that window requires

 * special support to get alpha blending working.  For now, just use overlay

 * window 3 for the drm cursor.

 *

/*

 * rk3399 vop big windows register layout is same as rk3288, but we

 * have a separate rk3399 win data array here so that we can advertise

 * AFBC on the primary plane.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:

 *      Mark Yao <mark.yao@rock-chips.com>

 *      Sandy Huang <hjc@rock-chips.com>

/**

 * struct rockchip_lvds_soc_data - rockchip lvds Soc private data

 * @probe: LVDS platform probe function

 * @helper_funcs: LVDS connector helper functions

 rgb lvds or dual lvds output */

 vesa or jeida format */

 iomux to LCD data/sync mode */

 Enable LVDS mode */

 Set format */

 MSB */

 PHY */

 default set it as output rgb */

 default set it as format vesa 18 */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:Mark Yao <mark.yao@rock-chips.com>

 *

 * based on exynos_drm_drv.c

/*

 * Attach a (component) device to the shared drm dma mapping from master drm

 * device.  This is used by the VOPs to map GEM buffers to a common DMA

 * mapping.

 Remove existing drivers that may own the framebuffer memory. */

 Try to bind all sub drivers. */

 init kms poll for handling hpd */

/*

 * Check if a vop endpoint is leading to a rockchip subdriver or bridge.

 * Should be called from the component bind stage of the drivers

 * to ensure that all subdrivers are probed.

 *

 * @ep: endpoint of a rockchip vop

 *

 * returns true if subdriver, false if external bridge and -ENODEV

 * if remote port does not contain a device.

 status disabled will prevent creation of platform-devices */

 enabled non-platform-devices can immediately return here */

	/*

	 * All rockchip subdrivers have probed at this point, so

	 * any device not having a driver now is an external bridge.

			/*

			 * if there is a crtc not support iommu, force set all

			 * crtc use non-iommu buffer.

 sentinel */ },

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Rockchip SoC DP (Display Port) interface driver.

 *

 * Copyright (C) Fuzhou Rockchip Electronics Co., Ltd.

 * Author: Andy Yan <andy.yan@rock-chips.com>

 *         Yakir Yang <ykk@rock-chips.com>

 *         Jeff Chen <jeff.chen@rock-chips.com>

/**

 * struct rockchip_dp_chip_data - splite the grf setting of kind of chips

 * @lcdsel_grf_reg: grf register offset of lcdc select

 * @lcdsel_big: reg value of selecting vop big for eDP

 * @lcdsel_lit: reg value of selecting vop little for eDP

 * @chip_type: specific chip type

 VOP couldn't output YUV video format for eDP rightly */

 do nothing */

 do nothing */

 Coming back from self refresh, nothing to do */

 No crtc means we're doing a full shutdown */

 If we're not entering self-refresh, no need to wait for vact */

	/*

	 * The hardware IC designed that VOP must output the RGB10 video

	 * format to eDP controller, and if eDP panel only support RGB8,

	 * then eDP controller should cut down the video data, not via VOP

	 * controller, that's why we need to hardcode the VOP output mode

	 * to RGA10 here.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:Mark Yao <mark.yao@rock-chips.com>

/*

 * The coefficients of the following matrix are all fixed points.

 * The format is S2.10 for the 3x3 part of the matrix, and S9.12 for the offsets.

 * They are all represented in two's complement.

 protected by dev->event_lock */

 physical map length of vop register */

 one time only one process allowed to config the register */

 lock vop irq reg */

 protects crtc enable/disable */

 vop AHP clk */

 vop dclk */

 vop share memory frequency */

 vop dclk reset */

 optional internal rgb encoder */

 either of the below should not be reachable */

/*

 * (1) each frame starts at the start of the Vsync pulse which is signaled by

 *     the "FRAME_SYNC" interrupt.

 * (2) the active data region of each frame ends at dsp_vact_end

 * (3) we should program this same number (dsp_vact_end) into dsp_line_frag_num,

 *      to get "LINE_FLAG" interrupt at the end of the active on screen data.

 *

 * VOP_INTR_CTRL0.dsp_line_frag_num = VOP_DSP_VACT_ST_END.dsp_vact_end

 * Interrupts

 * LINE_FLAG -------------------------------+

 * FRAME_SYNC ----+                         |

 *                |                         |

 *                v                         v

 *                | Vsync | Vbp |  Vactive  | Vfp |

 *                        ^     ^           ^     ^

 *                        |     |           |     |

 *                        |     |           |     |

 * dsp_vs_end ------------+     |           |     |   VOP_DSP_VTOTAL_VS_END

 * dsp_vact_start --------------+           |     |   VOP_DSP_VACT_ST_END

 * dsp_vact_end ----------------------------+     |   VOP_DSP_VACT_ST_END

 * dsp_total -------------------------------------+   VOP_DSP_VTOTAL_VS_END

	/*

	 * Slave iommu shares power, irq and clock with vop.  It was associated

	 * automatically with this master device via common driver code.

	 * Now that we have enabled the clock we attach it to the shared drm

	 * mapping.

	/*

	 * We need to make sure that all windows are disabled before we

	 * enable the crtc. Otherwise we might try to scan from a destroyed

	 * buffer later.

	 *

	 * In the case of enable-after-PSR, we don't need to worry about this

	 * case since the buffer is guaranteed to be valid and disabling the

	 * window will result in screen glitches on PSR exit.

		/*

		 * Disable AFBC and forget there was a vop window with AFBC

	/*

	 * At here, vop clock & iommu is enable, R/W vop regs would be safe.

	/*

	 * Vop standby will take effect at end of current frame,

	 * if dsp hold valid irq happen, it means standby complete.

	 *

	 * we must wait standby complete when we want to disable aclk,

	 * if not, memory bus maybe dead.

	/*

	 * vop standby complete, so iommu detach is safe.

	/*

	 * Src.x1 can be odd when do clip, but yuv plane start point

	 * need align with 2 pixel.

	/*

	 * can't update plane when vop is disabled.

	/*

	 * For y-mirroring we need to move address

	 * to the beginning of the last line.

	/*

	 * Blending win0 with the background color doesn't seem to work

	 * correctly. We only get the background color, no matter the contents

	 * of the win0 framebuffer.  However, blending pre-multiplied color

	 * with the default opaque black default background color is a no-op,

	 * so we can just disable blending to get the correct result.

 Special case for asynchronous cursor updates. */

		/*

		 * A scanout can still be occurring, so we can't drop the

		 * reference to the old framebuffer. To solve this we get a

		 * reference to old_fb and set a worker to release it later.

		 * FIXME: if we perform 500 async_update calls before the

		 * vblank, then we can have 500 different framebuffers waiting

		 * to be released.

	/*

	 * Clock craziness.

	 *

	 * Key points:

	 *

	 * - DRM works in in kHz.

	 * - Clock framework works in Hz.

	 * - Rockchip's clock driver picks the clock rate that is the

	 *   same _OR LOWER_ than the one requested.

	 *

	 * Action plan:

	 *

	 * 1. Try to set the exact rate first, and confirm the clock framework

	 *    can provide it.

	 *

	 * 2. If the clock framework cannot provide the exact rate, we should

	 *    add 999 Hz to the requested rate.  That way if the clock we need

	 *    is 60000001 Hz (~60 MHz) and DRM tells us to make 60000 kHz then

	 *    the clock framework will actually give us the right clock.

	 *

	 * 3. Get the clock framework to round the rate for us to tell us

	 *    what it will actually make.

	 *

	 * 4. Store the rounded up rate so that we don't need to worry about

	 *    this in the actual clk_set_rate().

	/*

	 * To disable gamma (gamma_lut is null) or to write

	 * an update to the LUT, clear dsp_lut_en.

	/*

	 * In order to write the LUT to the internal memory,

	 * we need to first make sure the dsp_lut_en bit is cleared.

	/*

	 * Only update GAMMA if the 'active' flag is not changed,

	 * otherwise it's updated by .atomic_enable.

	/*

	 * If we have a GAMMA LUT in the state, then let's make sure

	 * it's updated. We might be coming out of suspend,

	 * which means the LUT internal memory needs to be re-written.

	/*

	 * if vop is not support RGB10 output, need force RGB10 to RGB888.

	/*

	 * Spin until frame start interrupt status bit goes low, which means

	 * that interrupt handler was invoked and cleared it. The timeout of

	 * 10 msecs is really too long, but it is just a safety measure if

	 * something goes really wrong. The wait will only happen in the very

	 * unlikely case of a vblank happening exactly at the same time and

	 * shouldn't exceed microseconds range.

 Enable AFBC if there is some AFBC window, disable otherwise. */

	/*

	 * There is a (rather unlikely) possiblity that a vblank interrupt

	 * fired before we set the cfg_done bit. To avoid spuriously

	 * signalling flip completion we need to wait for it to finish.

	/*

	 * The irq is shared with the iommu. If the runtime-pm state of the

	 * vop-device is disabled the irq has to be targeted at the iommu.

	/*

	 * interrupt register has interrupt status, enable and clear bits, we

	 * must hold irq_lock to avoid a race with enable/disable_vblank().

 Clear all active interrupt sources */

 This is expected for vop iommu irqs, since the irq is shared */

 Unhandled irqs are spurious. */

	/*

	 * Create drm_plane for primary and cursor planes first, since we need

	 * to pass them to drm_crtc_init_with_planes, which sets the

	 * "possible_crtcs" to the newly initialized crtc.

	/*

	 * Create drm_planes for overlay windows with possible_crtcs restricted

	 * to the newly created crtc.

	/*

	 * We need to cleanup the planes now.  Why?

	 *

	 * The planes are "&vop->win[i].base".  That means the memory is

	 * all part of the big "struct vop" chunk of memory.  That memory

	 * was devm allocated and associated with this component.  We need to

	 * free it ourselves before vop_unbind() finishes.

	/*

	 * Destroy CRTC after vop_plane_destroy() since vop_disable_plane()

	 * references the CRTC.

 Enable both the hclk and aclk to setup the vop */

	/*

	 * do hclk_reset, reset all vop registers.

	/*

	 * do dclk_reset, let all config take affect.

/*

 * Initialize the vop->win array elements.

/**

 * rockchip_drm_wait_vact_end

 * @crtc: CRTC to enable line flag

 * @mstimeout: millisecond for timeout

 *

 * Wait for vact_end line flag irq or timeout.

 *

 * Returns:

 * Zero on success, negative errno on failure.

 Allocate vop struct and its vop_win array */

 SPDX-License-Identifier: GPL-2.0+

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:

 *      Chris Zhong <zyw@rock-chips.com>

 *      Nickey Yang <nickey.yang@rock-chips.com>

 dual-channel */

 optional external dphy */

 being a phy for other mipi hosts */

 per lane */

 The table is based on 27MHz DPHY pll reference clock. */

	/*

	 * With the falling edge on TESTCLK, the TESTDIN[7:0] signal content

	 * is latched internally as the current test code. Test data is

	 * programmed internally by rising edge on TESTCLK.

/*

 * ns2bc - Nanoseconds to byte clock cycles

/*

 * ns2ui - Nanoseconds to UI time periods

	/*

	 * Get vco from frequency(lane_mbps)

	 * vco	frequency table

	 * 000 - between   80 and  200 MHz

	 * 001 - between  200 and  300 MHz

	 * 010 - between  300 and  500 MHz

	 * 011 - between  500 and  700 MHz

	 * 100 - between  700 and  900 MHz

	 * 101 - between  900 and 1100 MHz

	 * 110 - between 1100 and 1300 MHz

	 * 111 - between 1300 and 1500 MHz

	/*

	 * We need set PLL_INPUT_AND_LOOP_DIVIDER_RATIOS_CONTROL immediately

	 * to make the configured LSB effective according to IP simulation

	 * and lab test results.

	 * Only in this way can we get correct mipi phy pll frequency.

 take 1 / 0.8, since mbps must big than bandwidth of RGB */

 for external phy only a the mipi_dphy_config is necessary */

 constraint: 5Mhz <= Fref / N <= 40MHz */

 constraint: 80MHz <= Fvco <= 1500Mhz */

 Fvco = Fref * M / N */

		/*

		 * Due to the use of a "by 2 pre-scaler," the range of the

		 * feedback multiplication value M is limited to even division

		 * numbers, and m must be greater than 6, not bigger than 512.

 Table A-3 High-Speed Transition Times */

	/*

	 * For the RK3399, the clk of grf must be enabled before writing grf

	 * register. And for RK3288 or other soc, this grf_clk must be NULL,

	 * the clk_prepare_enable return true directly.

 found ourself */

 same display device in port1-ep0 for both */

			/*

			 * we have found the second, so will either return it

			 * or return with an error. In any case won't need the

			 * nodes anymore nor continue the loop.

 we are the slave in dual-DSI */

	/*

	 * With the GRF clock running, write lane and dual-mode configurations

	 * that won't change immediately. If we waited until enable() to do

	 * this, things like panel preparation would not be able to send

	 * commands over DSI.

	/*

	 * Nothing to do when used as a dphy.

	 * Just make the rest of Rockchip-DRM happy

	 * by being here.

 Nothing to do when used as a dphy. */

 do soc-variant specific init */

	/*

	 * Configure hsfreqrange according to frequency values

	 * Set clock lane and hsfreqrange by lane0(test code 0x44)

 Normal operation */

 try to get a possible external dphy */

			/*

			 * if external phy is present, pll will be

			 * generated there.

 sentinel */ }

 sentinel */ }

	/*

	 * Set TX1RX1 source to isp1.

	 * Assume ISP0 is supplied by the RX0 dphy.

 tester reset pulse */

 Disable lane turn around, which is ignored in receive mode */

 Enable dphy lanes */

 sentinel */ }

 sentinel */ }

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:

 *      Sandy Huang <hjc@rock-chips.com>

 if subdriver (> 0) or error case (< 0), ignore entry */

 if the rgb output is not connected to anything, just return */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:Mark Yao <mark.yao@rock-chips.com>

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author: Chris Zhong <zyw@rock-chips.com>

	/*

	 * Attempt to read sink count, retry in case the sink may not be ready.

	 *

	 * Sinks are *supposed* to come up within 1ms from an off state, but

	 * some docks need more time to power up.

 If DP is disconnected, every mode is invalid */

 efficiency is about 0.8 */

 only enable the port that connected with downstream device */

 if link training is requested we should perform it always */

	/*

	 * In the following 2 cases, we need to run the event_work to re-enable

	 * the DP:

	 * 1. If there is not just one port device is connected, and remove one

	 *    device from a port, the DP will be disabled here, at this case,

	 *    run the event_work to re-open DP for the other port.

	 * 2. If re-training or re-config failed, the DP will be disabled here.

	 *    run the event_work to re-connect it.

 Drop the lock before getting the firmware to avoid blocking boot */

 Not connected, notify userspace to disable the block */

 Connected but not enabled, enable the block */

 Enabled and connected to a dongle without a sink, notify userspace */

 Enabled and connected with a sink, re-train if requested */

 If training result is changed, update the video config */

	/*

	 * It would be nice to be able to just do the work inline right here.

	 * However, we need to make a bunch of calls that might sleep in order

	 * to turn on the block/phy, so use a worker instead.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:Mark Yao <mark.yao@rock-chips.com>

	/*

	 * Fake up the SG table so that dma_sync_sg_for_device() can be used

	 * to flush the pages associated with it.

	 *

	 * TODO: Replace this by drm_clflush_sg() once it can be implemented

	 * without relying on symbols that are not exported.

	/*

	 * We allocated a struct page table for rk_obj, so clear

	 * VM_PFNMAP flag that was set by drm_gem_mmap_obj()/drm_gem_mmap().

 drm driver mmap file operations */

	/*

	 * Set vm_pgoff (used as a fake buffer offset by DRM) to 0 and map the

	 * whole buffer from the start.

/*

 * rockchip_gem_free_object - (struct drm_gem_object_funcs)->free

 * callback function

/*

 * rockchip_gem_create_with_handle - allocate an object with the given

 * size and create a gem handle on it

 *

 * returns a struct rockchip_gem_object* on success or ERR_PTR values

 * on failure.

	/*

	 * allocate a id of idr table where the obj is registered

	 * and handle has the id what user can see.

 drop reference from allocate - handle holds it now. */

/*

 * rockchip_gem_dumb_create - (struct drm_driver)->dumb_create callback

 * function

 *

 * This aligns the pitch and size arguments to the minimum required. wrap

 * this into your own function if you need bigger alignment.

	/*

	 * align to 64 bytes since Mali requires it.

/*

 * Allocate a sg_table for this GEM object.

 * Note: Both the table's contents, and the sg_table itself must be freed by

 *       the caller.

 * Returns a pointer to the newly allocated sg_table, or an ERR_PTR() error.

 Nothing to do if allocated by DMA mapping API. */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author: Chris Zhong <zyw@rock-chips.com>

 enable Mailbox and PIF interrupt */

 read the header of the message */

		/*

		 * If the message in mailbox is not what we want, we need to

		 * clear the mailbox by reading its contents.

 reset ucpu before load firmware*/

 un-reset ucpu */

 check the keep alive register to make sure fw working */

 read the firmware state */

 start training */

 set YUV default color space conversion to BT601 */

	/*

	 * get a best tu_size and valid symbol:

	 * 1. chose Lclk freq(162Mhz, 270Mhz, 540Mhz), set TU to 32

	 * 2. calculate VS(valid symbol) = TU * Pclk * Bpp / (Lclk * Lanes)

	 * 3. if VS > *.85 or VS < *.1 or VS < 2 or TU < VS + 4, then set

	 *    TU += 2 and repeat 2nd step.

 set the FIFO Buffer size */

 clearn the audio config and reset */

 reset smpl2pckt component  */

 reset FIFO */

 reset the spdif clk before config */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) Fuzhou Rockchip Electronics Co.Ltd

 * Author:Mark Yao <mark.yao@rock-chips.com>

	/*

	 * set max width and height as default value(4096x4096).

	 * this value would be used to check framebuffer size limitation

	 * at drm_mode_addfb().

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (c) 2014, Fuzhou Rockchip Electronics Co., Ltd

 need to be unset if hdmi or i2c should control voltage */

/**

 * struct rockchip_hdmi_chip_data - splite the grf setting of kind of chips

 * @lcdsel_grf_reg: grf register offset of lcdc select

 * @lcdsel_big: reg value of selecting vop big for HDMI

 * @lcdsel_lit: reg value of selecting vop little for HDMI

      pixelclk    bpp8    bpp10   bpp12 */

pixelclk   symbol   term   vlev*/

 Enable and map pins to 3V grf-controlled io-voltage */

	/*

	 * If we failed to find the CRTC(s) which this encoder is

	 * supposed to be connected to, it's because the CRTC has

	 * not been registered yet.  Defer probing, and hope that

	 * the required CRTC is added later.

	/*

	 * If dw_hdmi_bind() fails we'll never call dw_hdmi_unbind(),

	 * which would have called the encoder cleanup.  Do it manually.

 SPDX-License-Identifier: GPL-2.0-only

/*

 *  TDA9950 Consumer Electronics Control driver

 *

 * The NXP TDA9950 implements the HDMI Consumer Electronics Control

 * interface.  The host interface is similar to a mailbox: the data

 * registers starting at REG_CDR0 are written to send a command to the

 * internal CPU, and replies are read from these registers.

 *

 * As the data registers represent a mailbox, they must be accessed

 * as a single I2C transaction.  See the TDA9950 data sheet for details.

	/*

	 * This should never happen: the data sheet says that there will

	 * always be a valid message if the interrupt line is asserted.

 transmit result */

 some other error, refer to TDA9950 docs */

 TDA9950 executes all retries for us */

 unknown */

 TDA9950 doesn't want address 15 set */

/*

 * When operating as part of the TDA998x, we need additional handling

 * to initialise and shut down the TDA9950 part of the device.  These

 * two hooks are provided to allow the TDA998x code to perform those

 * activities.

 Reset the TDA9950, and wait 250ms for it to recover */

 Start the command processor */

 Stop the command processor */

 Wait up to .5s for it to signal non-busy */

 Warn the user that their IRQ may die if it's shared. */

/*

 * When operating as part of the TDA998x, we need to claim additional

 * resources.  These two hooks permit the management of those resources.

	/*

	 * We must have I2C functionality: our multi-byte accesses

	 * must be performed as a single contiguous transaction.

 We must have an interrupt to be functional. */

	/*

	 * If we're part of a TDA998x, we want the class devices to be

	 * associated with the HDMI Tx so we have a tight relationship

	 * between the HDMI interface and the CEC interface.

	/*

	 * CEC documentation says we must not call cec_delete_adapter

	 * after a successful call to cec_register_adapter().

/*

 * Copyright (C) 2010 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 HW register definitions */

 HW access functions */

 DRM encoder functions */

 I2C driver functions */

 Module initialization */

/*

 * Copyright (C) 2009 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 DRM encoder functions */

	/* The ch7006 is painfully picky with the input timings so no

 I2C driver functions */

	/* I don't know what this is for, but otherwise I get no

	 * signal.

 Module initialization */

/*

 * Copyright (C) 2009 Francisco Jerez.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining

 * a copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sublicense, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial

 * portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,

 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF

 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.

 * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE

 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION

 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION

 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

	/* The following modes seem to work right but they're

 Some common HW state calculation code */

	/* Set DAC_GAIN if the voltage drop between white and black is

 Correct it with the specified brightness. */

 HW access functions */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Texas Instruments

 * Author: Rob Clark <robdclark@gmail.com>

/* The TDA9988 series of devices use a paged register scheme.. to simplify

 * things we encode the page # in upper bits of the register #.  To read/

 * write a given register, we need to make sure CURPAGE register is set

 * appropriately.  Which implies reads/writes are not atomic.  Fun!

 write */

 Page 00h: General Control */

 read */

 read/write */

 read */

 write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 write */

 write */

 write */

 write */

 write */

 write */

 read/write */

 read/write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 write */

 read/write */

 write */

 Page 02h: PLL settings */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 Page 09h: EDID Control */

 read */

 next 127 successive registers are the EDID block */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 Page 10h: information frames and packets */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 Page 11h: audio settings and content info packets */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 read/write */

 Page 12h: HDCP and OTP */

 read/write */

 read/write */

 read/write */

 Page 13h: Gamut related metadata packets */

/* CEC registers: (not paged)

 read */

 read/write */

 read/write */

 read */

 read */

 read/write */

 Device versions: */

 Enable automatic calibration mode */

 Enable free running oscillator */

/*

 * Calibration for the internal oscillator: we need to set calibration mode,

 * and then pulse the IRQ line low for a 10ms ± 1% period.

 This is the maximum size of the buffer passed in */

 reset audio and i2c master: */

 reset transmitter: */

 PLL registers common configuration */

 Write the default value MUX register */

/*

 * The TDA998x has a problem when trying to read the EDID close to a

 * HPD assertion: it needs a delay of 100ms to avoid timing out while

 * trying to read EDID data.

 *

 * However, tda998x_connector_get_modes() may be called at any moment

 * after tda998x_connector_detect() indicates that we are connected, so

 * we need to delay probing modes in tda998x_connector_get_modes() after

 * we have seen a HPD inactive->active transition.  This code implements

 * that delay.

/*

 * We need to run the KMS hotplug event helper outside of our threaded

 * interrupt routine as this can call back into our get_modes method,

 * which will want to make use of interrupts.

/*

 * only 2 interrupts may occur: screen plug/unplug and EDID read

 Audio support */

 Configure the TDA998x audio data and clock routing. */

/*

 * The audio clock divisor register controls a divider producing Audio_Clk_Out

 * from SERclk by dividing it by 2^n where 0 <= n <= 5.  We don't know what

 * Audio_Clk_Out or SERclk are. We guess SERclk is the same as TMDS clock.

 *

 * It seems that Audio_Clk_Out must be the smallest value that is greater

 * than 128*fs, otherwise audio does not function. There is some suggestion

 * that 126*fs is a better value.

/*

 * In auto-CTS mode, the TDA998x uses a "measured time stamp" counter to

 * generate the CTS value.  It appears that the "measured time stamp" is

 * the number of TDMS clock cycles within a number of audio input clock

 * cycles defined by the k and N parameters defined below, in a similar

 * way to that which is set out in the CTS generation in the HDMI spec.

 *

 *  tmdsclk ----> mts -> /m ---> CTS

 *                 ^

 *  sclk -> /k -> /N

 *

 * CTS = mts / m, where m is 2^M.

 * /k is a divider based on the K value below, K+1 for K < 4, or 8 for K >= 4

 * /N is a divider based on the HDMI specified N value.

 *

 * This produces the following equation:

 *  CTS = tmds_clock * k * N / (sclk * m)

 *

 * When combined with the sink-side equation, and realising that sclk is

 * bclk_ratio * fs, we end up with:

 *  k = m * bclk_ratio / 128.

 *

 * Note: S/PDIF always uses a bclk_ratio of 64.

 If audio is not configured, there is nothing to do. */

 Enable audio ports */

 auto CTS */

	/*

	 * This is the approximate value of N, which happens to be

	 * the recommended values for non-coherent clocks.

 Write the CTS and N values */

 Reset CTS generator */

	/* Write the channel status

	 * The REG_CH_STAT_B-registers skip IEC958 AES2 byte, because

	 * there is a separate register for each I2S wire.

 DRM connector functions */

 enable reading EDID: */

 flag must be cleared by sw: */

 wait for block read to complete: */

	/*

	 * If we get killed while waiting for the HPD timeout, return

	 * no modes found: we are not in a restartable path, so we

	 * can't handle signals gracefully.

 DRM bridge functions */

 TDA19988 dotclock can go up to 165MHz */

 enable video ports, audio will be enabled later */

 set muxing after enabling ports: */

 disable video ports */

	/*

	 * Since we are "computer" like, our source invariably produces

	 * full-range RGB.  If the monitor supports full-range, then use

	 * it, otherwise reduce to limited-range.

	/*

	 * Internally TDA998x is using ITU-R BT.656 style sync but

	 * we get VESA style sync. TDA998x is using a reference pixel

	 * relative to ITU to sync to the input frame and for output

	 * sync generation. Currently, we are using reference detection

	 * from HS/VS, i.e. REFPIX/REFLINE denote frame start sync point

	 * which is position of rising VS with coincident rising HS.

	 *

	 * Now there is some issues to take care of:

	 * - HDMI data islands require sync-before-active

	 * - TDA998x register values must be > 0 to be enabled

	 * - REFLINE needs an additional offset of +1

	 * - REFPIX needs an addtional offset of +1 for UYUV and +3 for RGB

	 *

	 * So we add +1 to all horizontal and vertical register values,

	 * plus an additional +3 for REFPIX as we are using RGB input only.

	/*

	 * Attached LCD controllers may generate broken sync. Allow

	 * those to adjust the position of the rising VS edge by adding

	 * HSKEW to ref_pix.

	/*

	 * Select pixel repeat depending on the double-clock flag

	 * (which means we have to repeat each pixel once.)

 the TMDS clock is scaled up by the pixel repeat */

	/*

	 * The divisor is power-of-2. The TDA9983B datasheet gives

	 * this as ranges of Msample/s, which is 10x the TMDS clock:

	 *   0 - 800 to 1500 Msample/s

	 *   1 - 400 to 800 Msample/s

	 *   2 - 200 to 400 Msample/s

	 *   3 - as 2 above

 mute the audio FIFO: */

 set HDMI HDCP mode off: */

 no pre-filter or interpolator: */

 set color matrix according to output rgb quant range */

 set BIAS tmds value: */

	/*

	 * Sync on rising HSYNC/VSYNC

	/*

	 * TDA19988 requires high-active sync at input stage,

	 * so invert low-active sync provided by master encoder here

 let incoming pixels fill the active space (if any) */

	/*

	 * Always generate sync polarity relative to input sync and

	 * revert input stage toggled sync at output stage

 must be last register set: */

	/* CEA-861B section 6 says that:

	 * CEA version 1 (CEA-861) has no support for infoframes.

	 * CEA version 2 (CEA-861A) supports version 1 AVI infoframes,

	 * and optional basic audio.

	 * CEA version 3 (CEA-861B) supports version 1 and 2 AVI infoframes,

	 * and optional digital audio, with audio infoframes.

	 *

	 * Since we only support generation of version 2 AVI infoframes,

	 * ignore CEA version 2 and below (iow, behave as if we're a

	 * CEA-861 source.)

 We need to turn HDMI HDCP stuff on to get audio through */

 I2C driver functions */

 disable all IRQs and free the IRQ handler */

 protect the page access */

 protect access from audio thread */

 CEC I2C address bound to TDA998x I2C addr by configuration pins */

 wake up the device: */

 read version: */

 mask off feature bits: */

 not-hdcp and not-scalar bit */

 after reset, enable DDC: */

 set clock on DDC channel: */

 if necessary, disable multi-master: */

 ensure interrupts are disabled */

 clear pending interrupts */

 initialize the optional IRQ */

 init read EDID waitqueue and HDP work */

 enable HPD irq */

	/*

	 * Some TDA998x are actually two I2C devices merged onto one piece

	 * of silicon: TDA9989 and TDA19989 combine the HDMI transmitter

	 * with a slightly modified TDA9950 CEC device.  The CEC device

	 * is at the TDA9950 address, with the address pins strapped across

	 * to the TDA998x address pins.  Hence, it always has the same

	 * offset.

 enable EDID read irq: */

 get the device tree parameters */

 DRM encoder functions */

 If no CRTCs were found, fall back to our old behaviour */

 SPDX-License-Identifier: GPL-2.0 OR MIT

/*

 * Copyright 2009 VMware, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Michel Dänzer

 Test BO GTT->VRAM and VRAM->GTT GPU copies across the whole GTT aperture */

	/* Number of tests =

	 * (Total GTT - IB pool - writeback page - ring buffers) / test size

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König <christian.koenig@amd.com>

/**

 * uvd_v4_2_resume - memory controller programming

 *

 * @rdev: radeon_device pointer

 *

 * Let the UVD memory controller know it's offsets

 program the VCPU memory controller bits 0-27 */

 skip over the header of the new firmware format */

 bits 28-31 */

 bits 32-39 */

/*

 * Copyright 2011 Christian König.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors:

 *    Christian König <deathsimple@vodafone.de>

 for debugging lockup only, used by sysfs debug files */

 for debugging lockup only, used by sysfs debug files */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 100 Mhz ref clk */

 27 Mhz ref clk */

 evergreen only */

 find the first active crtc */

 we never hit the non-gddr5 limit so disable it */

/*

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *    Dave Airlie

 *    Jerome Glisse <glisse@freedesktop.org>

 Intel E7505 Memory Controller Hub / RV350 AR [Radeon 9600XT] Needs AGPMode 4 (deb #515326) */

 Intel 82865G/PE/P DRAM Controller/Host-Hub / Mobility 9800 Needs AGPMode 4 (deb #462590) */

 Intel 82865G/PE/P DRAM Controller/Host-Hub / RV280 [Radeon 9200 SE] Needs AGPMode 4 (lp #300304) */

 Intel 82855PM Processor to I/O Controller / Mobility M6 LY Needs AGPMode 1 (deb #467235) */

 Intel 82855PM host bridge / Mobility 9600 M10 RV350 Needs AGPMode 1 (lp #195051) */

 Intel 82855PM host bridge / RV250/M9 GL [Mobility FireGL 9000/Radeon 9000] needs AGPMode 1 (Thinkpad T40p) */

 Intel 82855PM host bridge / Mobility M7 needs AGPMode 1 */

 Intel 82855PM host bridge / FireGL Mobility T2 RV350 Needs AGPMode 2 (fdo #20647) */

 Intel 82855PM host bridge / Mobility M9+ / VaioPCG-V505DX Needs AGPMode 2 (fdo #17928) */

 Intel 82855PM Processor to I/O Controller / Mobility M9+ Needs AGPMode 8 (phoronix forum) */

 Intel 82830 830 Chipset Host Bridge / Mobility M6 LY Needs AGPMode 2 (fdo #17360)*/

 Intel 82852/82855 host bridge / Mobility FireGL 9000 RV250 Needs AGPMode 1 (lp #296617) */

 Intel 82855PM host bridge / Mobility FireGL 9000 RV250 Needs AGPMode 1 for suspend/resume */

 Intel 82852/82855 host bridge / Mobility 9600 M10 RV350 Needs AGPMode 1 (deb #467460) */

 Intel 82852/82855 host bridge / Mobility 9600 M10 RV350 Needs AGPMode 1 (lp #203007) */

 Intel 82852/82855 host bridge / Mobility 9600 M10 RV350 Needs AGPMode 1 (lp #141551) */

 Intel 82852/82855 host bridge / Mobility 9600/9700 Needs AGPMode 1 (deb #510208) */

 ASRock K7VT4A+ AGP 8x / ATI Radeon 9250 AGP Needs AGPMode 4 (lp #133192) */

 VIA K8M800 Host Bridge / RV280 [Radeon 9200 PRO] Needs AGPMode 4 (fdo #12544) */

 VIA KT880 Host Bridge / RV350 [Radeon 9550] Needs AGPMode 4 (fdo #19981) */

 VIA VT8363 Host Bridge / R200 QL [Radeon 8500] Needs AGPMode 2 (lp #141551) */

 VIA VT82C693A Host Bridge / RV280 [Radeon 9200 PRO] Needs AGPMode 2 (deb #515512) */

 VIA VT82C693A Host Bridge / RV280 [Radeon 9200 PRO] Needs AGPMode 2 */

 VIA VT8377 Host Bridge / R200 QM [Radeon 9100] Needs AGPMode 4 (deb #461144) */

 VIA VT8377 Host Bridge / RV280 [Radeon 9200 PRO] Needs AGPMode 4 (lp #312693) */

 VIA VT8377 Host Bridge / RV280 Needs AGPMode 4 (ati ML) */

 ATI Host Bridge / RV280 [M9+] Needs AGPMode 1 (phoronix forum) */

 Acquire AGP. */

	/* chips with the agp to pcie bridge don't have the AGP_STATUS register

	 * Just use the whatever mode the host sets up.

 Apply AGPMode Quirks */

 disable fw */

 workaround some hw issues */

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 on hw with routers, select right port */

 Couldn't find an accessible DDC on this connector */

	/* Probe also for valid EDID header

	 * EDID header starts with:

	 * 0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00.

	 * Only the first 6 bytes must be valid as

		/* Couldn't find an accessible EDID on this

 bit banging i2c */

	/* RV410 appears to have a bug where the hw i2c in reset

	 * holds the i2c port in a bad state - switch hw i2c away before

	 * doing DDC - do this for all r200s/r300s/r400s for safety sake

 switch the pads to ddc mode */

 clear the output pin values */

 set the pins to input */

 mask the gpio pins for software use */

 unmask the gpio pins for software use */

 read the value off the pin */

 read the value off the pin */

 set pin direction */

 set pin direction */

 hw i2c */

 todo */

 todo */

 todo */

 todo */

/* hw i2c engine for r1xx-4xx hardware

 * hw can buffer up to 15 bytes

 take the pm lock since we need a constant sclk */

 no gpio select bit */

 only bit 4 on r200 */

 bits 3 and 4 */

 only bit 4 on r300/r350 */

 bits 3 and 4 */

 check for bus probe */

/* hw i2c engine for r5xx hardware

 * hw can buffer up to 15 bytes

 take the pm lock since we need a constant sclk */

 clear gpio mask bits */

 clear pin values */

 set the pins to input */

 */

 check for bus probe */

 XXX fill in hw i2c implementation */

 XXX fill in hw i2c implementation */

 XXX fill in hw i2c implementation */

 XXX fill in hw i2c implementation */

 don't add the mm_i2c bus unless hw_i2c is enabled */

 set the radeon hw i2c adapter */

 hw i2c using atom */

 set the radeon bit adapter */

 from VESA */

 Add the default buses */

 remove all the buses */

 Add additional buses */

 looks up bus based on id */

 ddc router switching */

 clock/data router switching */

/*

 * Copyright 2011 Red Hat Inc.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors:

 *    Jerome Glisse <glisse@freedesktop.org>

/* Algorithm:

 *

 * We store the last allocated bo in "hole", we always try to allocate

 * after the last allocated bo. Principle is that in a linear GPU ring

 * progression was is after last is the oldest bo we allocated and thus

 * the first one that should no longer be in use by the GPU.

 *

 * If it's not the case we skip over the bo after last to the closest

 * done bo if such one exist. If none exist and we are not asked to

 * block we report failure to allocate.

 *

 * If we are asked to block we wait on all the oldest fence of all

 * rings. We just wait for any of those fence to complete.

 map the buffer */

/**

 * radeon_sa_event - Check if we can stop waiting

 *

 * @sa_manager: pointer to the sa_manager

 * @size: number of bytes we want to allocate

 * @align: alignment we need to match

 *

 * Check if either there is a fence we can wait for or

 * enough free memory to satisfy the allocation directly

 if hole points to the end of the buffer */

 try again with its beginning */

 to handle wrap around we add sa_manager->size */

	/* go over all fence list and try to find the closest sa_bo

	 * of the current last

 limit the number of tries each ring gets */

 wrap around, pretend it's after */

 this sa bo is the closest one */

		/* we knew that this one is signaled,

 see if we can skip over some allocations */

 if we have nothing to wait for block */

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 r4xx mask is technically not used by the hw, so patch in the legacy mask bits */

 some evergreen boards have bad data for this entry */

 some DCE3 boards have bad data for this entry */

 Asus M2A-VM HDMI board lists the DVI port as HDMI */

 Asrock RS600 board lists the DVI port as HDMI */

 MSI K9A2GM V2/V3 board has no HDMI or DVI */

 a-bit f-i90hd - ciaranm on #radeonhd - this board has no DVI */

 Falcon NW laptop lists vga ddc line for LVDS */

 HIS X1300 is DVI+VGA, not DVI+DVI */

 Gigabyte X1300 is DVI+VGA, not DVI+DVI */

 Funky macbooks */

 mac rv630, rv730, others */

 ASUS HD 3600 XT board lists the DVI port as HDMI */

 ASUS HD 3600 board lists the DVI port as HDMI */

 ASUS HD 3450 board lists the DVI port as HDMI */

	/* some BIOSes seem to report DAC on HDMI - usually this is a board with

	 * HDMI + VGA reporting as HDMI

	/* Acer laptop (Acer TravelMate 5730/5730G) has an HDMI port

	 * on the laptop and a DVI port on the docking station and

	 * both share the same encoder, hpd pin, and ddc line.

	 * So while the bios table is technically correct,

	 * we drop the DVI port here since xrandr has no concept of

	 * encoders and will try and drive both connectors

	 * with different crtcs which isn't possible on the hardware

	 * side and leaves no crtcs for LVDS or VGA.

 actually it's a DVI-D port not DVI-I */

	/* XFX Pine Group device rv730 reports no VGA DDC lines

	 * even though they are wired up to record 0x93

 Fujitsu D3003-S2 board lists DVI-I as DVI-D and VGA */

 not all boards support DL */

 not all boards support DL */

 technically DVI-A */

 TODO CV support */

 IGP chips */

 look up gpio for ddc, hpd */

 needed for aux chan transactions */

 give tv unique connector ids */

		/* Always set the connector type to VGA for CRT1/CRT2. if they are

		 * shared with a DVI port, we'll pick up the DVI connector when we

		 * merge the outputs.  Some bioses incorrectly list VGA ports as DVI.

 combine shared connectors */

 make sure not to combine LVDS */

 combine analog and digital for DVI-I */

 add the connectors */

 pixel clocks */

 system clock */

 ??? */

 memory clock */

 ??? */

 600 Mhz */

 540 Mhz */

 600 Mhz */

 set a reasonable default for DP */

 not technically a clock, but... */

 3.6 GHz */

 sideport is AMD only */

 get any igp specific overrides */

 set crtc values */

 parse the lcd record table */

 absolute */

 relative */

 PAL timings appear to have wrong values for totals */

 lm64 */

 lm64 */

 order matters! */

 add the i2c bus for thermal/fan chip */

 last mode is usually default, array is low to high */

 avoid memory leaks from invalid modes or unknown frev. */

 skip invalid modes */

 skip invalid modes */

 skip invalid modes */

 free any unused clock_info allocation. */

 last mode is usually default */

 add the i2c bus for thermal/fan chip */

 NI chips post without MC ucode, so default clocks are strobe mode only */

 patch the table values with the default sclk/mclk from firmware info */

 patch up vddc if necessary */

 skip invalid modes */

 skip invalid modes */

 first mode is usually default, followed by low to high */

 if multiple clock modes, mark the lowest as no display */

 first mode is usually default */

 if multiple clock modes, mark the lowest as no display */

 first mode is usually default */

 add the default mode */

 r4xx, r5xx */

 10 khz */

 r6xx, r7xx, evergreen, ni, si */

 10 khz */

 for SI we use ComputeMemoryClockParam for memory plls */

 fusion */

 10 khz */

 CI */

 COMPUTE_GPUCLK_INPUT_FLAG_DEFAULT_GPUCLK, COMPUTE_GPUCLK_INPUT_FLAG_SCLK */

 10 khz */

 SI */

 10 khz */

 10 khz */

 10 khz */

 10 khz */

 10 khz */

 0xff01 is a flag rather then an actual voltage */

 r6xx */

 r7xx, evergreen */

 ni */

 r7xx, evergreen */

 let the bios control the backlight */

 tell the bios not to handle mode switching */

 clear the vbios dpms state */

 at some point we may want to break this out into individual functions */

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

/* This bit selects who handles display phy powergating.

 * Clear the bit to let atom handle it.

 * Set it to let the driver handle it.

 * For now we just let atom handle it.

 ??? */

 ??? */

 XXX check against disp reqs */

 ??? */

	/* Some PALM chips don't seem to properly ungate gfx when UVD is in use;

	 * for now just disable gfx PG.

 ??? */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 SMC address space is BE */

 RMW for the final bytes */

 SMC address space is BE */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 powerdown unused blocks for now */

 powerup blocks */

 turn the clocks on when encoding */

 turn the clocks off when not encoding */

 XXX */

 XXX do we need a vce_v1_0_stop() ?  */

XXX use sumo_dpm_display_configuration_changed

 ??? */

 ??? */

 fill in the vce power states */

 Enabling nb dpm on an asrock system prevents dpm from working */

 only enable bapm on KB, ML by default */

 true? */

 XXX true */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 At least align on page size */

	/* Maximum bo size is the unpinned gtt size since we use the gtt to

	 * handle vram to system pool migrations.

 FIXME: reeimplement */

 work out where to validate the buffer to */

 Do nothings */

 Asking for cpu access wait for object idle */

 A BO that is associated with a dma-buf cannot be sensibly migrated to VRAM */

/*

 * Call from drm_gem_handle_create which appear in both new and open ioctl

 * case.

/*

 * GEM ioctls.

 TODO: implement */

 TODO: implement */

 create a gem object to contain this object in */

 drop reference from allocate - handle holds it now */

 reject unknown flag values */

 readonly pages not tested on older hardware */

		/* if we want to write to it we must require anonymous

 create a gem object to contain this object in */

 drop reference from allocate - handle holds it now */

	/* transition the BO to a domain -

	/* for now if someone requests domain CPU -

 just do a BO wait for now */

 Flush HDP cache via MMIO if necessary */

/**

 * radeon_gem_va_update_vm -update the bo_va in its VM

 *

 * @rdev: radeon_device pointer

 * @bo_va: bo_va to update

 *

 * Update the bo_va directly after setting it's address. Errors are not

 * vital here, so they are not reported back to userspace.

		/* if anything is swapped out don't swap it in here,

	/* !! DONT REMOVE !!

	 * We don't support vm_id yet, to be sure we don't have have broken

	 * userspace, reject anyone trying to use non 0 value thus moving

	 * forward we can use those fields without breaking existant userspace

	/* don't remove, we need to enforce userspace to set the snooped flag

	 * otherwise we will endup with broken userspace and we won't be able

	 * to enable this feature without adding new interface

 drop reference from allocate - handle holds it now */

/*

 * Copyright 2010 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *     Alex Deucher <alexander.deucher@amd.com>

/*

 * evergreen cards need to use the 3D engine to blit data which requires

 * quite a bit of hw state setup.  Rather than pull the whole 3D driver

 * (which normally generates the 3D state) into the DRM, we opt to use

 * statically generated state tables.  The register state and shaders

 * were hand generated to support blitting functionality.  See the 3D

 * driver or documentation for descriptions of the registers and

 * shader instructions.

 DB_RENDER_CONTROL */

 DB_COUNT_CONTROL */

 DB_DEPTH_VIEW */

 DB_RENDER_OVERRIDE */

 DB_RENDER_OVERRIDE2 */

 DB_HTILE_DATA_BASE */

 DB_STENCIL_CLEAR */

 DB_DEPTH_CLEAR */

 DB_DEPTH_INFO */

 DB_Z_INFO */

 DB_STENCIL_INFO */

 PA_SC_WINDOW_OFFSET */

 PA_SC_CLIPRECT_RULE */

 PA_SC_CLIPRECT_0_TL */

 PA_SC_CLIPRECT_0_BR */

 PA_SC_EDGERULE */

 PA_SU_HARDWARE_SCREEN_OFFSET */

 CB_TARGET_MASK */

 CB_SHADER_MASK */

 PA_SC_VPORT_SCISSOR_0_TL */

 PA_SC_VPORT_SCISSOR_0_BR */

 PA_SC_VPORT_ZMIN_0 */

 PA_SC_VPORT_ZMAX_0 */

 SX_MISC */

 CP_RINGID */

 CP_VMID */

 VGT_MAX_VTX_INDX */

 VGT_MIN_VTX_INDX */

 VGT_INDX_OFFSET */

 VGT_MULTI_PRIM_IB_RESET_INDX */

 SX_ALPHA_TEST_CONTROL */

 CB_BLEND_RED */

 CB_BLEND_GREEN */

 CB_BLEND_BLUE */

 CB_BLEND_ALPHA */

 SPI_VS_OUT_ID_0 */

 SPI_PS_INPUT_CNTL_0 */

 SPI_PS_INPUT_CNTL_1 */

 SPI_VS_OUT_CONFIG */

 SPI_PS_IN_CONTROL_0 */

 SPI_PS_IN_CONTROL_1 */

 SPI_INTERP_CONTROL_0 */

 SPI_INPUT_Z */

 SPI_FOG_CNTL */

 SPI_BARYC_CNTL */

 SPI_PS_IN_CONTROL_2 */

 SPI_COMPUTE_INPUT_CNTL */

 SPI_COMPUTE_NUM_THREAD_X */

 SPI_COMPUTE_NUM_THREAD_Y */

 SPI_COMPUTE_NUM_THREAD_Z */

 SPI_GPR_MGMT */

 SPI_LDS_MGMT */

 SPI_STACK_MGMT */

 SPI_WAVE_MGMT_1 */

 SPI_WAVE_MGMT_2 */

 CB_BLEND0_CONTROL */

 DB_DEPTH_CONTROL */

 DB_EQAA */

 CB_COLOR_CONTROL */

 DB_SHADER_CONTROL */

 PA_CL_CLIP_CNTL */

 PA_SU_SC_MODE_CNTL */

 PA_CL_VTE_CNTL */

 PA_CL_VS_OUT_CNTL */

 PA_CL_NANINF_CNTL */

 PA_SU_LINE_STIPPLE_CNTL */

 PA_SU_LINE_STIPPLE_SCALE */

 PA_SU_PRIM_FILTER_CNTL */

  */

  */

 SQ_PGM_START_FS */

 SQ_LDS_ALLOC_PS */

 SQ_ESGS_RING_ITEMSIZE */

 SQ_GS_VERT_ITEMSIZE */

 PA_SU_POINT_SIZE */

 PA_SU_POINT_MINMAX */

 PA_SU_LINE_CNTL */

 PA_SC_LINE_STIPPLE */

 VGT_OUTPUT_PATH_CNTL */

 VGT_HOS_CNTL */

 VGT_GS_MODE */

 PA_SC_MODE_CNTL_0 */

 PA_SC_MODE_CNTL_1 */

 VGT_PRIMITIVEID_EN */

 VGT_MULTI_PRIM_IB_RESET_EN */

 VGT_INSTANCE_STEP_RATE_0 */

 VGT_REUSE_OFF */

 VGT_SHADER_STAGES_EN */

 DB_ALPHA_TO_MASK */

 PA_SU_POLY_OFFSET_DB_FMT_CNTL */

 VGT_STRMOUT_CONFIG */

 PA_SC_CENTROID_PRIORITY_0 */

 PA_SC_CENTROID_PRIORITY_1 */

 PA_SC_LINE_CNTL */

 PA_SC_AA_CONFIG */

 PA_SU_VTX_CNTL */

 PA_CL_GB_VERT_CLIP_ADJ */

 PA_CL_GB_VERT_DISC_ADJ */

 PA_CL_GB_HORZ_CLIP_ADJ */

 PA_CL_GB_HORZ_DISC_ADJ */

 PA_SC_AA_SAMPLE_LOCS_PIXEL_X0Y0_0 */

 PA_SC_AA_MASK_X0Y0_X1Y0 */

 VGT_VERTEX_REUSE_BLOCK_CNTL */

  */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

/* This files gather functions specifics to: r300,r350,rv350,rv370,rv380

 *

 * GPU Errata:

 * - HOST_PATH_CNTL: r300 family seems to dislike write to HOST_PATH_CNTL

 *   using MMIO to flush host path read cache, this lead to HARDLOCKUP.

 *   However, scheduling such write to the ring seems harmless, i suspect

 *   the CP read collide with the flush somehow, or maybe the MC, hard to

 *   tell. (Jerome Glisse)

/*

 * Indirect registers accessor

/*

 * rv370,rv380 PCIE GART

 Workaround HW bug do flush 2 times */

	/* on x86 we want this to be CPU endian, on powerpc

	 * on powerpc without HW swappers, it'll get swapped on way

 Initialize common gart structure */

 discard memory request outside of configured range */

 FIXME: setup default page */

 Clear error */

	/* Who ever call radeon_fence_emit should call ring_lock and ask

 Write SC register so SC & US assert idle */

 Flush 3D cache */

 Wait until IDLE & CLEAN */

 Emit fence sequence & fire IRQ */

 Sub pixel 1/12 so we can have 4K rendering according to doc */

 read MC_STATUS */

 r300,r350 */

 rv350,rv370,rv380,r300 AD, r350 AH */

 stop CP */

 save PCI state */

 disable bus mastering */

	/* resetting the CP seems to be problematic sometimes it end up

	 * hard locking the computer, but it's necessary for successful

	 * reset more test & playing is needed on R3XX/R4XX to find a

	 * reliable (if any solution)

 restore PCI & busmastering */

 Check if GPU is idle */

/*

 * r300,r350,rv350,rv380 VRAM info

 DDR for all card after R300 & IGP */

 FIXME wait for idle */

 wait for lane set to complete */

 FIXME wait for idle */

 keep the 1st 5 bits */

 Tracked registers */

 VAP_VF_CNTL */

 VAP_VTX_SIZE */

 VAP_VF_MAX_VTX_INDX */

 VAP_ALT_NUM_VERTICES - only valid on r500 */

 SC_SCISSOR1 */

 RB3D_CCTL */

 CMASK_ENABLE */

 RB3D_COLORPITCH0 */

 RB3D_COLORPITCH1 */

 RB3D_COLORPITCH2 */

 RB3D_COLORPITCH3 */

 ZB_CNTL */

 ZB_FORMAT */

 ZB_DEPTHPITCH */

 TX_ENABLE */

 TX_FORMAT1_[0-15] */

 The same rules apply as for DXT3/5. */

 TX_FILTER0_[0-15] */

 TX_FORMAT2_[0-15] */

 ATI1N */

 The same rules apply as for DXT1. */

 TX_FORMAT0_[0-15] */

 RB3D_COLOR_CHANNEL_MASK */

 SC_HYPERZ_EN */

		/* r300c emits this register - we need to disable hyperz for it

 ZB_BW_CNTL */

 RB3D_BLENDCNTL */

 ZB_MASK_OFFSET */

 ZB_ZMASK_PITCH */

 ZB_HIZ_OFFSET */

 ZB_HIZ_PITCH */

 GB_Z_PEQ_CONFIG */

 valid register only on RV530 */

 fallthrough do not move */

 Draw packet */

		/* Number of dwords is vtx_size * (num_vertices - 1)

		 * PRIM_WALK must be equal to 3 vertex data in embedded

		/* Number of dwords is vtx_size * (num_vertices - 1)

		 * PRIM_WALK must be equal to 3 vertex data in embedded

 Stops all mc clients */

 Wait for mc idle */

 Program MC, should be a 32bits limited address space */

 We need to force on some of the block */

 set common regs */

 program mc */

 Resume clock */

 Initialize GPU configuration (# pipes, ...) */

	/* Initialize GART (initialize after TTM so we can allocate

 allocate wb buffer */

 Enable IRQ */

 1M ring buffer */

 Make sur GART are not working */

 Resume clock before doing reset */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 post */

 Resume clock after posting */

 Initialize surface registers */

 Disable VGA */

 Initialize scratch registers */

 Initialize surface registers */

 TODO: disable VGA need to use VGA request */

 restore some register to sane defaults */

 BIOS*/

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Set asic errata */

 Initialize clocks */

 initialize AGP */

 initialize memory controller */

 Fence driver */

 Memory manager */

 Initialize power management */

 Something went wrong with the accel init, so stop accel */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 This files gather functions specifics to: rv515 */

 read MC_STATUS */

 disable VGA render */

 blank the display controllers */

 wait for the next frame */

 XXX this is a hack to avoid strange behavior with EFI on certain systems */

 ***** */

 Block CPU access */

 blackout the MC */

 wait for the MC to settle */

 lock double buffered regs */

 update crtc base addresses */

 unlock regs and wait for update */

 unblackout the MC */

 allow CPU access */

 wait for the next frame */

 Unlock vga access */

 Stops all mc clients */

 Wait for mc idle */

 Write VRAM size in case we are limiting it */

 Program MC, should be a 32bits limited address space */

 We need to force on some of the block */

 Resume clock */

 Initialize GPU configuration (# pipes, ...) */

	/* Initialize GART (initialize after TTM so we can allocate

 allocate wb buffer */

 Enable IRQ */

 1M ring buffer */

 Make sur GART are not working */

 Resume clock before doing reset */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 post */

 Resume clock after posting */

 Initialize surface registers */

 Initialize scratch registers */

 Initialize surface registers */

 TODO: disable VGA need to use VGA request */

 restore some register to sane defaults */

 BIOS*/

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Initialize clocks */

 initialize AGP */

 initialize memory controller */

 Fence driver */

 Memory manager */

 Initialize power management */

 Somethings want wront with the accel init stop accel */

 FIXME: wouldn't it better to set priority mark to maximum */

 rv6xx, rv7xx */

 sclk in Mhz */

	/* Determine consumption rate

	 *  pclk = pixel clock period(ns) = 1000 / (mode.clock / 1000)

	 *  vtaps = number of vertical taps,

	 *  vsc = vertical scaling ratio, defined as source/destination

	 *  hsc = horizontal scaling ration, defined as source/destination

	/* Determine line time

	 *  LineTime = total time for one line of displayhtotal

	 *  LineTime = total number of horizontal pixels

	 *  pclk = pixel clock period(ns)

	/* Determine active time

	 *  ActiveTime = time of active region of display within one line,

	 *  hactive = total number of horizontal active pixels

	 *  htotal = total number of horizontal pixels

	/* Determine chunk time

	 * ChunkTime = the time it takes the DCP to send one chunk of data

	 * to the LB which consists of pipeline delay and inter chunk gap

	 * sclk = system clock(Mhz)

	/* Determine the worst case latency

	 * NumLinePair = Number of line pairs to request(1=2 lines, 2=4 lines)

	 * WorstCaseLatency = worst case time from urgent to when the MC starts

	 *                    to return data

	 * READ_DELAY_IDLE_MAX = constant of 1us

	 * ChunkTime = time it takes the DCP to send one chunk of data to the LB

	 *             which consists of pipeline delay and inter chunk gap

	/* Determine the tolerable latency

	 * TolerableLatency = Any given request has only 1 line time

	 *                    for the data to be returned

	 * LBRequestFifoDepth = Number of chunk requests the LB can

	 *                      put into the request FIFO for a display

	 *  LineTime = total time for one line of display

	 *  ChunkTime = the time it takes the DCP to send one chunk

	 *              of data to the LB which consists of

	 *  pipeline delay and inter chunk gap

 We assume worst case 32bits (4 bytes) */

	/* Determine the maximum priority mark

	 *  width = viewport width in pixels

 Determine estimated width */

	/*

	 * Set display0/1 priority up in the memory controller for

	 * modes if the user specifies HIGH for displaypriority

	 * option.

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Christian König.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König

 *          Rafał Miłecki

 enable the audio stream */

 allow hw to sent ACR packets when required */

 select SW CTS value */

 allow hw to sent ACR packets when required */

 program the speaker allocation */

 set HDMI mode */

 stereo */

 program the speaker allocation */

 set DP mode */

 stereo */

/*

 * build a AVI Info Frame

 anything other than 0 */

 Two dtos; generally use dto0 for HDMI */

	/* Express [24MHz / target pixel clock] as an exact rational

	 * number (coefficient of two integer numbers.  DCCG_AUDIO_DTOx_PHASE

	 * is the numerator, DCCG_AUDIO_DTOx_MODULE is the denominator

 Two dtos; generally use dto1 for DP */

	/* Express [24MHz / target pixel clock] as an exact rational

	 * number (coefficient of two integer numbers.  DCCG_AUDIO_DTOx_PHASE

	 * is the numerator, DCCG_AUDIO_DTOx_MODULE is the denominator

 send null packets when required */

 send general control packets */

 send general control packets every frame */

 required for audio info values to be updated */

 set the default audio delay */

 should be suffient for all audio modes and small enough for all hblanks */

 allow 60958 channel status and send audio packets fields to be updated */

 enable AVI info frames */

 required for audio info values to be updated */

 enable audio info frames (frames won't be set until audio is enabled) */

 required for audio info values to be updated */

 enable AVI info frames */

 required for audio info values to be updated */

 Audio packet transmission */

 Audio timestamp packet transmission */

 Audio infoframe packet transmission */

 Master enable for secondary stream engine */

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 10 khz */

 10 khz */

/*

 * Read XTAL (ref clock), SCLK and MCLK from Open Firmware device

 * tree. Hopefully, ATI OF driver is kind enough to fill these

 These aren't in the device-tree */

 not sure what the max should be in all cases */

 CONFIG_OF */

 TODO FALLBACK */

 may need to be per card */

 pixel clocks */

 dcpll is DCE4 only */

 system clock */

 memory clock */

 10 khz */

 10 khz */

 XXX: wait for idle */

 XXX: verify on different asics */

				/* Some releases of vbios have set DISABLE_MC_MCLKA

				   and DISABLE_MC_MCLKB bits in the vbios table.  Setting these

				   bits will cause H/W hang when reading video memory with dynamic clocking

 If both bits are set, then check the active channels */

			/* When DRI is enabled, setting DYN_STOP_LAT to zero can cause some R200

			   to lockup randomly, leave them as set by BIOS.

tmp &= RADEON_SCLK_SRC_SEL_MASK; */

RAGE_6::A11 A12 A12N1 A13, RV250::A11 A12, R300 */

 RV200::A11 A12 RV250::A11 A12 */

 RV200::A11 A12, RV250::A11 A12 */

enable dynamic mode for display clocks (PIXCLK and PIX2CLK) */

 Turn everything OFF (ForceON to everything) */

 for RV350/M10, no delays are required. */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

/*

 * GPUVM

 * GPUVM is similar to the legacy gart on older asics, however

 * rather than there being a single global gart table

 * for the entire GPU, there are multiple VM page tables active

 * at any given time.  The VM page tables can contain a mix

 * vram pages and system memory pages and system memory pages

 * can be mapped as snooped (cached system pages) or unsnooped

 * (uncached system pages).

 * Each VM has an ID associated with it and there is a page table

 * associated with each VMID.  When execting a command buffer,

 * the kernel tells the ring what VMID to use for that command

 * buffer.  VMIDs are allocated dynamically as commands are submitted.

 * The userspace drivers maintain their own address space and the kernel

 * sets up their pages tables accordingly when they submit their

 * command buffers and a VMID is assigned.

 * Cayman/Trinity support up to 8 active VMs at any given time;

 * SI supports 16.

/**

 * radeon_vm_num_pdes - return the number of page directory entries

 *

 * @rdev: radeon_device pointer

 *

 * Calculate the number of page directory entries (cayman+).

/**

 * radeon_vm_directory_size - returns the size of the page directory in bytes

 *

 * @rdev: radeon_device pointer

 *

 * Calculate the size of the page directory in bytes (cayman+).

/**

 * radeon_vm_manager_init - init the vm manager

 *

 * @rdev: radeon_device pointer

 *

 * Init the vm manager (cayman+).

 * Returns 0 for success, error for failure.

/**

 * radeon_vm_manager_fini - tear down the vm manager

 *

 * @rdev: radeon_device pointer

 *

 * Tear down the VM manager (cayman+).

/**

 * radeon_vm_get_bos - add the vm BOs to a validation list

 *

 * @rdev: radeon_device pointer

 * @vm: vm providing the BOs

 * @head: head of validation list

 *

 * Add the page directory to the list of BOs to

 * validate for command submission (cayman+).

 add the vm page table to the list */

/**

 * radeon_vm_grab_id - allocate the next free VMID

 *

 * @rdev: radeon_device pointer

 * @vm: vm to allocate id for

 * @ring: ring we want to submit job to

 *

 * Allocate an id for the vm (cayman+).

 * Returns the fence we need to sync to (if any).

 *

 * Global and local mutex must be locked!

 check if the id is still valid */

 we definitely need to flush */

 skip over VMID 0, since it is the system VM */

 found a free one */

 should never happen */

/**

 * radeon_vm_flush - hardware flush the vm

 *

 * @rdev: radeon_device pointer

 * @vm: vm we want to flush

 * @ring: ring to use for flush

 * @updates: last vm update that is waited for

 *

 * Flush the vm (cayman+).

 *

 * Global and local mutex must be locked!

/**

 * radeon_vm_fence - remember fence for vm

 *

 * @rdev: radeon_device pointer

 * @vm: vm we want to fence

 * @fence: fence to remember

 *

 * Fence the vm (cayman+).

 * Set the fence used to protect page table and id.

 *

 * Global and local mutex must be locked!

/**

 * radeon_vm_bo_find - find the bo_va for a specific vm & bo

 *

 * @vm: requested vm

 * @bo: requested buffer object

 *

 * Find @bo inside the requested vm (cayman+).

 * Search inside the @bos vm list for the requested vm

 * Returns the found bo_va or NULL if none is found

 *

 * Object has to be reserved!

/**

 * radeon_vm_bo_add - add a bo to a specific vm

 *

 * @rdev: radeon_device pointer

 * @vm: requested vm

 * @bo: radeon buffer object

 *

 * Add @bo into the requested vm (cayman+).

 * Add @bo to the list of bos associated with the vm

 * Returns newly added bo_va or NULL for failure

 *

 * Object has to be reserved!

/**

 * radeon_vm_set_pages - helper to call the right asic function

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @addr: dst addr to write into pe

 * @count: number of page entries to update

 * @incr: increase next addr by incr bytes

 * @flags: hw access flags

 *

 * Traces the parameters and calls the right asic functions

 * to setup the page table using the DMA.

/**

 * radeon_vm_clear_bo - initially clear the page dir/table

 *

 * @rdev: radeon_device pointer

 * @bo: bo to clear

/**

 * radeon_vm_bo_set_addr - set bos virtual address inside a vm

 *

 * @rdev: radeon_device pointer

 * @bo_va: bo_va to store the address

 * @soffset: requested offset of the buffer in the VM address space

 * @flags: attributes of pages (read/write/valid/etc.)

 *

 * Set offset of @bo_va (cayman+).

 * Validate and set the offset requested within the vm address space.

 * Returns 0 for success, error for failure.

 *

 * Object has to be reserved and gets unreserved by this function!

 make sure object fit at this offset */

 bo and tmp overlap, invalid offset */

 add a clone of the bo_va to clear the old address */

 walk over the address space and allocate the page tables */

 drop mutex to allocate and clear page table */

 aquire mutex again */

 someone else allocated the pt in the meantime */

/**

 * radeon_vm_map_gart - get the physical address of a gart page

 *

 * @rdev: radeon_device pointer

 * @addr: the unmapped addr

 *

 * Look up the physical address of the page that the pte resolves

 * to (cayman+).

 * Returns the physical address of the page.

 page table offset */

/**

 * radeon_vm_page_flags - translate page flags to what the hw uses

 *

 * @flags: flags comming from userspace

 *

 * Translate the flags the userspace ABI uses to hw flags.

/**

 * radeon_vm_update_page_directory - make sure that page directory is valid

 *

 * @rdev: radeon_device pointer

 * @vm: requested vm

 *

 * Allocates new page tables if necessary

 * and updates the page directory (cayman+).

 * Returns 0 for success, error for failure.

 *

 * Global and local mutex must be locked!

 padding, etc. */

 assume the worst case */

 update too big for an IB */

 walk over the address space and update the page directory */

/**

 * radeon_vm_frag_ptes - add fragment information to PTEs

 *

 * @rdev: radeon_device pointer

 * @ib: IB for the update

 * @pe_start: first PTE to handle

 * @pe_end: last PTE to handle

 * @addr: addr those PTEs should point to

 * @flags: hw mapping flags

 *

 * Global and local mutex must be locked!

	/**

	 * The MC L1 TLB supports variable sized pages, based on a fragment

	 * field in the PTE. When this field is set to a non-zero value, page

	 * granularity is increased from 4KB to (1 << (12 + frag)). The PTE

	 * flags are considered valid for all PTEs within the fragment range

	 * and corresponding mappings are assumed to be physically contiguous.

	 *

	 * The L1 TLB can store a single PTE for the whole fragment,

	 * significantly increasing the space available for translation

	 * caching. This leads to large improvements in throughput when the

	 * TLB is under pressure.

	 *

	 * The L2 TLB distributes small and large fragments into two

	 * asymmetric partitions. The large fragment cache is significantly

	 * larger. Thus, we try to use large fragments wherever possible.

	 * Userspace can support this by aligning virtual base address and

	 * allocation size to the fragment size.

 NI is optimized for 256KB fragments, SI and newer for 64KB */

 system pages are non continuously */

 handle the 4K area at the beginning */

 handle the area in the middle */

 handle the 4K area at the end */

/**

 * radeon_vm_update_ptes - make sure that page tables are valid

 *

 * @rdev: radeon_device pointer

 * @vm: requested vm

 * @ib: indirect buffer to use for the update

 * @start: start of GPU address range

 * @end: end of GPU address range

 * @dst: destination address to map to

 * @flags: mapping flags

 *

 * Update the page tables in the range @start - @end (cayman+).

 *

 * Global and local mutex must be locked!

 walk over the address space and update the page tables */

/**

 * radeon_vm_fence_pts - fence page tables after an update

 *

 * @vm: requested vm

 * @start: start of GPU address range

 * @end: end of GPU address range

 * @fence: fence to use

 *

 * Fence the page tables in the range @start - @end (cayman+).

 *

 * Global and local mutex must be locked!

/**

 * radeon_vm_bo_update - map a bo into the vm page table

 *

 * @rdev: radeon_device pointer

 * @bo_va: radeon buffer virtual address object

 * @mem: ttm mem

 *

 * Fill in the page table entries for @bo (cayman+).

 * Returns 0 for success, -EINVAL for failure.

 *

 * Object have to be reserved and mutex must be locked!

	/* reserve space for one command every (1 << BLOCK_SIZE) entries

 padding, etc. */

 only copy commands needed */

 header for write data commands */

 body of write data command */

 set page commands needed */

 two extra commands for begin/end of fragment */

 update too big for an IB */

/**

 * radeon_vm_clear_freed - clear freed BOs in the PT

 *

 * @rdev: radeon_device pointer

 * @vm: requested vm

 *

 * Make sure all freed BOs are cleared in the PT.

 * Returns 0 for success.

 *

 * PTs have to be reserved and mutex must be locked!

/**

 * radeon_vm_clear_invalids - clear invalidated BOs in the PT

 *

 * @rdev: radeon_device pointer

 * @vm: requested vm

 *

 * Make sure all invalidated BOs are cleared in the PT.

 * Returns 0 for success.

 *

 * PTs have to be reserved and mutex must be locked!

/**

 * radeon_vm_bo_rmv - remove a bo to a specific vm

 *

 * @rdev: radeon_device pointer

 * @bo_va: requested bo_va

 *

 * Remove @bo_va->bo from the requested vm (cayman+).

 *

 * Object have to be reserved!

/**

 * radeon_vm_bo_invalidate - mark the bo as invalid

 *

 * @rdev: radeon_device pointer

 * @bo: radeon buffer object

 *

 * Mark @bo as invalid (cayman+).

/**

 * radeon_vm_init - initialize a vm instance

 *

 * @rdev: radeon_device pointer

 * @vm: requested vm

 *

 * Init @vm fields (cayman+).

 allocate page table array */

/**

 * radeon_vm_fini - tear down a vm instance

 *

 * @rdev: radeon_device pointer

 * @vm: requested vm

 *

 * Tear down @vm (cayman+).

 * Unbind the VM and remove all bos from the vm bo list

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors:

 *    Christian König <deathsimple@vodafone.de>

 1 second timeout */

 Firmware Names */

 Let's try to load the newer firmware first */

			/*

			 * Limit the number of UVD handles depending on

			 * microcode major and minor versions.

	/*

	 * In case there is only legacy firmware, or we encounter an error

	 * while loading the new firmware, we fall back to loading the legacy

	 * firmware now.

 If it must be in VRAM it must be in the first segment as well */

 abort if we already have more than one placement */

 add another 256MB segment */

 H264 */

 reference picture buffer */

 macroblock context buffer */

 IT surface buffer */

 VC1 */

 reference picture buffer */

 CONTEXT_BUFFER */

 IT surface buffer */

 DB surface buffer */

 BP */

 MPEG2 */

 reference picture buffer */

 MPEG4 */

 reference picture buffer */

 CM */

 IT surface buffer */

 H264 */

 VC1 */

 always supported */

 MPEG2 */

 MPEG4 */

 only since UVD 3 */

 it's a create msg, calc image size (width * height) */

 try to alloc a new handle */

 it's a decode msg, validate codec and calc buffer sizes */

 validate the handle */

 it's a destroy msg, free the handle */

 TODO: is this still necessary on NI+ ? */

 does the IB has a msg command */

 minimum buffer sizes */

/*

 * multiple fence commands without any stream commands in between can

 * crash the vcpu so just try to emmit a dummy create/destroy msg to

 * avoid this

 we use the last page of the vcpu bo for the UVD message */

 stitch together an UVD create msg */

 we use the last page of the vcpu bo for the UVD message */

 stitch together an UVD destroy msg */

/**

 * radeon_uvd_count_handles - count number of open streams

 *

 * @rdev: radeon_device pointer

 * @sd: number of SD streams

 * @hd: number of HD streams

 *

 * Count the number of open SD/HD streams as a hint for power mangement

 disable this for now */

streams_changed = true;*/

 adjust to post divider minimum value */

 we alway need a frequency less than or equal the target */

 post dividers above a certain value must be even */

/**

 * radeon_uvd_calc_upll_dividers - calc UPLL clock dividers

 *

 * @rdev: radeon_device pointer

 * @vclk: wanted VCLK

 * @dclk: wanted DCLK

 * @vco_min: minimum VCO frequency

 * @vco_max: maximum VCO frequency

 * @fb_factor: factor to multiply vco freq with

 * @fb_mask: limit and bitmask for feedback divider

 * @pd_min: post divider minimum

 * @pd_max: post divider maximum

 * @pd_even: post divider must be even above this value

 * @optimal_fb_div: resulting feedback divider

 * @optimal_vclk_div: resulting vclk post divider

 * @optimal_dclk_div: resulting dclk post divider

 *

 * Calculate dividers for UVDs UPLL (R6xx-SI, except APUs).

 * Returns zero on success -EINVAL on error.

 start off with something large */

 loop through vco from low to high */

 fb div out of range ? */

 it can oly get worse */

 calc vclk divider with current vco freq */

 vco is too big, it has to stop */

 calc dclk divider with current vco freq */

 vco is too big, it has to stop */

 calc score with current vco freq */

 determine if this vco setting is better than current optimal settings */

 it can't get better than this */

 did we found a valid setup ? */

 make sure UPLL_CTLREQ is deasserted */

 assert UPLL_CTLREQ */

 wait for CTLACK and CTLACK2 to get asserted */

 deassert UPLL_CTLREQ */

/*

 * Copyright 2010 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *     Alex Deucher <alexander.deucher@amd.com>

/*

 * evergreen cards need to use the 3D engine to blit data which requires

 * quite a bit of hw state setup.  Rather than pull the whole 3D driver

 * (which normally generates the 3D state) into the DRM, we opt to use

 * statically generated state tables.  The register state and shaders

 * were hand generated to support blitting functionality.  See the 3D

 * driver or documentation for descriptions of the registers and

 * shader instructions.

 SQ_LDS_ALLOC_PS */

 SQ_ESGS_RING_ITEMSIZE */

 SQ_GS_VERT_ITEMSIZE */

 DB_Z_INFO */

 DB_STENCIL_INFO */

 DB_DEPTH_CONTROL */

 DB_RENDER_CONTROL */

 DB_COUNT_CONTROL */

 DB_DEPTH_VIEW */

 DB_RENDER_OVERRIDE */

 DB_RENDER_OVERRIDE2 */

 DB_HTILE_DATA_BASE */

 DB_STENCIL_CLEAR */

 DB_DEPTH_CLEAR */

 DB_ALPHA_TO_MASK */

 PA_SC_WINDOW_OFFSET */

 PA_SC_CLIPRECT_RULE */

 PA_SC_CLIPRECT_0_TL */

 PA_SC_CLIPRECT_0_BR */

 PA_SC_EDGERULE */

 PA_SU_HARDWARE_SCREEN_OFFSET */

 CB_TARGET_MASK */

 CB_SHADER_MASK */

 PA_SC_VPORT_SCISSOR_0_TL */

 PA_SC_VPORT_SCISSOR_0_BR */

 PA_SC_VPORT_ZMIN_0 */

 PA_SC_VPORT_ZMAX_0 */

 SX_MISC */

 PA_SC_MODE_CNTL_0 */

 PA_SC_MODE_CNTL_1 */

 PA_SC_LINE_CNTL */

 PA_SC_AA_CONFIG */

 PA_SU_VTX_CNTL */

 PA_CL_GB_VERT_CLIP_ADJ */

 PA_CL_GB_VERT_DISC_ADJ */

 PA_CL_GB_HORZ_CLIP_ADJ */

 PA_CL_GB_HORZ_DISC_ADJ */

 PA_SC_AA_SAMPLE_LOCS_0 */

  */

  */

  */

  */

  */

  */

 PA_SC_AA_SAMPLE_LOCS_7 */

 PA_SC_AA_MASK */

 CB_COLOR_CONTROL */

 DB_SHADER_CONTROL */

 PA_CL_CLIP_CNTL */

 PA_SU_SC_MODE_CNTL */

 PA_CL_VTE_CNTL */

 PA_CL_VS_OUT_CNTL */

 PA_CL_NANINF_CNTL */

 PA_SU_LINE_STIPPLE_CNTL */

 PA_SU_LINE_STIPPLE_SCALE */

 PA_SU_PRIM_FILTER_CNTL */

  */

  */

 SQ_DYN_GPR_RESOURCE_LIMIT_1 */

 PA_SU_POLY_OFFSET_DB_FMT_CNTL */

  */

  */

  */

  */

  */

 SQ_PGM_START_FS */

 SQ_PGM_RESOURCES_FS */

 VGT_MAX_VTX_INDX */

  */

  */

  */

 SX_ALPHA_TEST_CONTROL */

 CB_BLEND_RED */

 CB_BLEND_GREEN */

 CB_BLEND_BLUE */

 CB_BLEND_ALPHA */

 VGT_INSTANCE_STEP_RATE_0 */

  */

 VGT_REUSE_OFF */

  */

 PA_SU_POINT_SIZE */

 PA_SU_POINT_MINMAX */

 PA_SU_LINE_CNTL */

 PA_SC_LINE_STIPPLE */

 VGT_OUTPUT_PATH_CNTL */

 VGT_HOS_CNTL */

  */

  */

  */

  */

  */

  */

  */

  */

  */

  */

 VGT_GS_MODE */

 VGT_PRIMITIVEID_EN */

 VGT_MULTI_PRIM_IB_RESET_EN */

 VGT_SHADER_STAGES_EN */

 VGT_STRMOUT_CONFIG */

  */

 CB_BLEND0_CONTROL */

 SPI_VS_OUT_CONFIG */

 SPI_VS_OUT_ID_0 */

 SPI_PS_INPUT_CNTL_0 */

 SPI_PS_IN_CONTROL_0 */

 SPI_PS_IN_CONTROL_1 */

 SPI_INTERP_CONTROL_0 */

 SPI_INPUT_Z */

 SPI_FOG_CNTL */

 SPI_BARYC_CNTL */

 SPI_PS_IN_CONTROL_2 */

  */

  */

  */

  */

 VGT_VERTEX_REUSE_BLOCK_CNTL */

  */

/*

 * \file radeon_drv.c

 * ATI Radeon driver

 *

 * \author Gareth Hughes <gareth@valinux.com>

/*

 * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

/*

 * KMS wrapper.

 * - 2.0.0 - initial interface

 * - 2.1.0 - add square tiling interface

 * - 2.2.0 - add r6xx/r7xx const buffer support

 * - 2.3.0 - add MSPOS + 3D texture + r500 VAP regs

 * - 2.4.0 - add crtc id query

 * - 2.5.0 - add get accel 2 to work around ddx breakage for evergreen

 * - 2.6.0 - add tiling config query (r6xx+), add initial HiZ support (r300->r500)

 *   2.7.0 - fixups for r600 2D tiling support. (no external ABI change), add eg dyn gpr regs

 *   2.8.0 - pageflip support, r500 US_FORMAT regs. r500 ARGB2101010 colorbuf, r300->r500 CMASK, clock crystal query

 *   2.9.0 - r600 tiling (s3tc,rgtc) working, SET_PREDICATION packet 3 on r600 + eg, backend query

 *   2.10.0 - fusion 2D tiling

 *   2.11.0 - backend map, initial compute support for the CS checker

 *   2.12.0 - RADEON_CS_KEEP_TILING_FLAGS

 *   2.13.0 - virtual memory support, streamout

 *   2.14.0 - add evergreen tiling informations

 *   2.15.0 - add max_pipes query

 *   2.16.0 - fix evergreen 2D tiled surface calculation

 *   2.17.0 - add STRMOUT_BASE_UPDATE for r7xx

 *   2.18.0 - r600-eg: allow "invalid" DB formats

 *   2.19.0 - r600-eg: MSAA textures

 *   2.20.0 - r600-si: RADEON_INFO_TIMESTAMP query

 *   2.21.0 - r600-r700: FMASK and CMASK

 *   2.22.0 - r600 only: RESOLVE_BOX allowed

 *   2.23.0 - allow STRMOUT_BASE_UPDATE on RS780 and RS880

 *   2.24.0 - eg only: allow MIP_ADDRESS=0 for MSAA textures

 *   2.25.0 - eg+: new info request for num SE and num SH

 *   2.26.0 - r600-eg: fix htile size computation

 *   2.27.0 - r600-SI: Add CS ioctl support for async DMA

 *   2.28.0 - r600-eg: Add MEM_WRITE packet support

 *   2.29.0 - R500 FP16 color clear registers

 *   2.30.0 - fix for FMASK texturing

 *   2.31.0 - Add fastfb support for rs690

 *   2.32.0 - new info request for rings working

 *   2.33.0 - Add SI tiling mode array query

 *   2.34.0 - Add CIK tiling mode array query

 *   2.35.0 - Add CIK macrotile mode array query

 *   2.36.0 - Fix CIK DCE tiling setup

 *   2.37.0 - allow GS ring setup on r6xx/r7xx

 *   2.38.0 - RADEON_GEM_OP (GET_INITIAL_DOMAIN, SET_INITIAL_DOMAIN),

 *            CIK: 1D and linear tiling modes contain valid PIPE_CONFIG

 *   2.39.0 - Add INFO query for number of active CUs

 *   2.40.0 - Add RADEON_GEM_GTT_WC/UC, flush HDP cache before submitting

 *            CS to GPU on >= r600

 *   2.41.0 - evergreen/cayman: Add SET_BASE/DRAW_INDIRECT command parsing support

 *   2.42.0 - Add VCE/VUI (Video Usability Information) support

 *   2.43.0 - RADEON_INFO_GPU_RESET_COUNTER

 *   2.44.0 - SET_APPEND_CNT packet3 support

 *   2.45.0 - Allow setting shader registers using DMA/COPY packet3 on SI

 *   2.46.0 - Add PFP_SYNC_ME support on evergreen

 *   2.47.0 - Add UVD_NO_OP register support

 *   2.48.0 - TA_CS_BC_BASE_ADDR allowed on SI

 *   2.49.0 - DRM_RADEON_GEM_INFO ioctl returns correct vram_size/visible values

 *   2.50.0 - Allows unaligned shader loads on CIK. (needed by OpenGL)

 atpx handler */

 auto */

 Avoid NULL-ptr deref in drm_get_pci_dev */

 Get rid of things like offb */

	/* if we are running in a VM, make sure the device

	 * torn down properly on reboot/shutdown

	/*

	 * Some adapters need to be suspended before a

	 * shutdown occurs in order to prevent an error

	 * during kexec, shutdown or reboot.

	 * Make this power and Loongson specific because

	 * it breaks some other boards.

 GPU comes up enabled by the bios on resume */

 we don't want the main rpm_idle to call suspend - we want to autosuspend */

 KMS */

 SPDX-License-Identifier: MIT

/* Copyright Red Hat Inc 2010.

 * Author : Dave Airlie <airlied@redhat.com>

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * Authors: Christian König <christian.koenig@amd.com>

/*

 * Local variable sw_cg is used for debugging purposes, in case we

 * ran into problems with dynamic clock gating. Don't remove it.

/*

 * Copyright 2014 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Slava Grigorev <slava.grigorev@amd.com>

 KB: 2 streams, 3 endpoints */

 KV: 4 streams, 7 endpoints */

 BN/HW: 6 streams, 7 endpoints */

 OL: 2 streams, 2 endpoints */

 TN: 4 streams, 6 endpoints */

 SI: 6 streams, 6 endpoints */

 disable audio.  it will be set up later */

/*

 * calculate CTS and N values if they are not found in the table

 Safe, but overly large values */

 Smallest valid fraction */

	/*

	 * The optimal N is 128*freq/1000. Calculate the closest larger

	 * value that doesn't truncate any bits.

 Check that we are in spec (not always possible) */

       32kHz    44.1kHz   48kHz    */

 Clock      N     CTS      N     CTS      N     CTS */

  25,20/1.001 MHz */

  25.20       MHz */

  27.00       MHz */

  27.00*1.001 MHz */

  54.00       MHz */

  54.00*1.001 MHz */

  74.25/1.001 MHz */

  74.25       MHz */

 148.50/1.001 MHz */

 148.50       MHz */

 Precalculated values for common clocks */

 And odd clocks get manually calculated */

/*

 * update the N and CTS parameters for a given pixel clock rate

/*

 * update the info frames with the data from the current display mode

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *     Alex Deucher <alexander.deucher@amd.com>

 DB_RENDER_CONTROL */

 DB_COUNT_CONTROL */

 DB_DEPTH_VIEW */

 DB_RENDER_OVERRIDE */

 DB_RENDER_OVERRIDE2 */

 DB_HTILE_DATA_BASE */

 DB_DEPTH_BOUNDS_MIN */

 DB_DEPTH_BOUNDS_MAX */

 DB_STENCIL_CLEAR */

 DB_DEPTH_CLEAR */

 DB_DEPTH_INFO */

 DB_Z_INFO */

 DB_STENCIL_INFO */

 PA_SC_WINDOW_OFFSET */

 PA_SC_CLIPRECT_RULE */

 PA_SC_CLIPRECT_0_TL */

 PA_SC_CLIPRECT_0_BR */

 PA_SC_EDGERULE */

 PA_SU_HARDWARE_SCREEN_OFFSET */

 CB_TARGET_MASK */

 CB_SHADER_MASK */

 PA_SC_VPORT_SCISSOR_0_TL */

 PA_SC_VPORT_SCISSOR_0_BR */

 PA_SC_VPORT_ZMIN_0 */

 PA_SC_VPORT_ZMAX_0 */

 VGT_MAX_VTX_INDX */

 VGT_MIN_VTX_INDX */

 VGT_INDX_OFFSET */

 VGT_MULTI_PRIM_IB_RESET_INDX */

 CB_BLEND_RED */

 CB_BLEND_GREEN */

 CB_BLEND_BLUE */

 CB_BLEND_ALPHA */

 CB_BLEND0_CONTROL */

 DB_DEPTH_CONTROL */

 DB_EQAA */

 CB_COLOR_CONTROL */

 DB_SHADER_CONTROL */

 PA_CL_CLIP_CNTL */

 PA_SU_SC_MODE_CNTL */

 PA_CL_VTE_CNTL */

 PA_CL_VS_OUT_CNTL */

 PA_CL_NANINF_CNTL */

 PA_SU_LINE_STIPPLE_CNTL */

 PA_SU_LINE_STIPPLE_SCALE */

 PA_SU_PRIM_FILTER_CNTL */

 PA_SU_POINT_SIZE */

 PA_SU_POINT_MINMAX */

 PA_SU_LINE_CNTL */

 PA_SC_LINE_STIPPLE */

 VGT_OUTPUT_PATH_CNTL */

 VGT_HOS_CNTL */

 VGT_GS_MODE */

 PA_SC_MODE_CNTL_0 */

 PA_SC_MODE_CNTL_1 */

 VGT_PRIMITIVEID_EN */

 VGT_MULTI_PRIM_IB_RESET_EN */

 VGT_INSTANCE_STEP_RATE_0 */

 VGT_REUSE_OFF */

 VGT_SHADER_STAGES_EN */

 DB_ALPHA_TO_MASK */

 PA_SU_POLY_OFFSET_DB_FMT_CNTL */

 VGT_STRMOUT_CONFIG */

 PA_SC_CENTROID_PRIORITY_0 */

 PA_SC_CENTROID_PRIORITY_1 */

 PA_SC_LINE_CNTL */

 PA_SC_AA_CONFIG */

 PA_SU_VTX_CNTL */

 PA_CL_GB_VERT_CLIP_ADJ */

 PA_CL_GB_VERT_DISC_ADJ */

 PA_CL_GB_HORZ_CLIP_ADJ */

 PA_CL_GB_HORZ_DISC_ADJ */

 PA_SC_AA_SAMPLE_LOCS_PIXEL_X0Y0_0 */

 PA_SC_AA_MASK_X0Y0_X1Y0 */

 VGT_VERTEX_REUSE_BLOCK_CNTL */

  */

/*

 * Copyright 2008 Jerome Glisse.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *    Jerome Glisse <glisse@freedesktop.org>

/* This is based on the bucket sort with O(n) time complexity.

 * An item with priority "i" is added to bucket[i]. The lists are then

 * concatenated in descending order.

	/* Since buffers which appear sooner in the relocation list are

	 * likely to be used more often than buffers which appear later

	 * in the list, the sort mustn't change the ordering of buffers

	 * with the same priority, i.e. it must be stable.

 Connect the sorted buckets in the output list. */

 FIXME: we assume that each relocs use 4 dwords */

		/* The userspace buffer priorities are from 0 to 15. A higher

		 * number means the buffer is more important.

		 * Also, the buffers used for write have a higher priority than

		 * the buffers used for read only, which doubles the range

		 * to 0 to 31. 32 is reserved for the kernel driver.

		/* The first reloc of an UVD job is the msg and that must be in

		 * VRAM, the second reloc is the DPB and for WMV that must be in

		 * VRAM as well. Also put everything into VRAM on AGP cards and older

		 * IGP chips to avoid image corruptions

 TODO: is this still needed for NI+ ? */

 prioritize this over any other relocation */

 Objects shared as dma-bufs cannot be moved to VRAM */

 TODO: only use the low priority ring for now */

 XXX: note that this is called from the legacy UMS CS ioctl as well */

 get chunks */

 zero length IB isn't useful */

 zero length CONST IB isn't useful */

 zero length flags aren't useful */

 these are KMS only */

 we only support VM on some SI+ rings */

 Sort A before B if A is smaller. */

/**

 * radeon_cs_parser_fini() - clean parser states

 * @parser:	parser structure holding parsing context.

 * @error:	error number

 * @backoff:	indicator to backoff the reservation

 *

 * If error is set than unvalidate buffer, otherwise just free memory

 * used by parsing context.

		/* Sort the buffer list from the smallest to largest buffer,

		 * which affects the order of buffers in the LRU list.

		 * This assures that the smallest buffers are added first

		 * to the LRU list, so they are likely to be later evicted

		 * first, instead of large buffers whose eviction is more

		 * expensive.

		 *

		 * This slightly lowers the number of bytes moved by TTM

		 * per frame under memory pressure.

 initialize parser */

/**

 * radeon_cs_packet_parse() - parse cp packet and point ib index to next packet

 * @p:		parser structure holding parsing context.

 * @pkt:	where to store packet information

 * @idx:	packet index

 *

 * Assume that chunk_ib_index is properly set. Will return -EINVAL

 * if packet is bigger than remaining ib size. or if packets is unknown.

/**

 * radeon_cs_packet_next_is_pkt3_nop() - test if the next packet is P3 NOP

 * @p:		structure holding the parser context.

 *

 * Check if the next packet is NOP relocation packet3.

/**

 * radeon_cs_dump_packet() - dump raw packet context

 * @p:		structure holding the parser context.

 * @pkt:	structure holding the packet.

 *

 * Used mostly for debugging and error reporting.

/**

 * radeon_cs_packet_next_reloc() - parse next (should be reloc) packet

 * @p:			parser structure holding parsing context.

 * @cs_reloc:		reloc informations

 * @nomm:		no memory management for debugging

 *

 * Check if next packet is relocation packet3, do bo validation and compute

 * GPU offset using the provided start.

 FIXME: we assume reloc size is 4 dwords */

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

	/* bail if the connector does not have hpd pin, e.g.,

	 * VGA, TV, etc.

 if the connector is already off, don't turn it back on */

 FIXME: This access isn't protected by any locks. */

 just deal with DP (not eDP) here. */

 if existing sink type was not DP no need to retrain */

 first get sink type as it may be reset after (un)plug */

		/* don't do anything if sink is not display port, i.e.,

		 * passive dp->(dvi|hdmi) adaptor

 Don't start link training before we have the DPCD */

			/* Turn the connector off and back on immediately, which

			 * will trigger link training

 hdmi deep color only implemented on DCE4+ */

		/*

		 * Pre DCE-8 hw can't handle > 12 bpc, and more than 12 bpc doesn't make

		 * much sense without support for > 12 bpc framebuffers. RGB 4:4:4 at

		 * 12 bpc is always supported on hdmi deep color sinks, as this is

		 * required by the HDMI-1.3 spec. Clamp to a safe 12 bpc maximum.

 Any defined maximum tmds clock limit we must not exceed? */

 mode_clock is clock in kHz for mode to be modeset on this connector */

 Maximum allowable input clock in kHz */

 Check if bpc is within clock limit. Try to degrade gracefully otherwise */

 max_tmds_clock missing, but hdmi spec mandates it for deep color. */

 on hw with routers, select right port */

		/* don't fetch the edid from the vbios if ddc fails and runpm is

		 * enabled so we report disconnected.

 some laptops provide a hardcoded edid in rom for LCDs */

 some servers provide a hardcoded edid in rom for KVMs */

 pick the first one */

/*

 * radeon_connector_analog_encoder_conflict_solve

 * - search for other connectors sharing this encoder

 *   if priority is true, then set them disconnected if this is connected

 *   if priority is false, set us disconnected if they are connected

 if the IDs match */

 mac laptops without an edid */

		/* Note that this is not necessarily the exact panel mode,

		 * but an approximation based on the cvt formula.  For these

		 * systems we should ideally read the mode info out of the

		 * registers or add a mode table, but this works and is much

		 * simpler.

 need to find digital encoder on connector */

 need to find digital encoder on connector */

 need to find digital encoder on connector */

 need to find digital encoder on connector */

 need to find digital encoder on connector */

 need to find digital encoder on connector */

 need to find digital encoder on connector */

			/*

			 * Our .gamma_set assumes the .gamma_store has been

			 * prefilled and don't care about its arguments.

 If the EDID preferred mode doesn't match the native mode, use it */

 Try to get native mode details from EDID if necessary */

 add scaled modes */

 we have no EDID modes */

 add the width/height from vbios tables if available */

 add scaled modes */

		/* AVIVO hardware supports downscaling modes larger than the panel

		 * to the panel size, but I'm not sure this is desirable.

 if scaling is disabled, block non-native modes */

 check if panel is valid */

		/* don't fetch the edid from the vbios if ddc fails and runpm is

		 * enabled so we report disconnected.

 check for edid as well */

 check acpi lid status ??? */

 XXX check mode bandwidth */

			/* some oems have boards with separate digital and analog connectors

			 * with a shared ddc line (often vga + hdmi)

 if we aren't forcing don't do destructive polling */

			/* only return the previous status if we last

			 * detected a monitor via load.

	/* RN50 and some RV100 asics in servers often have a hardcoded EDID in the

	 * vbios to deal with KVMs. If we have one and are not able to detect a monitor

	 * by other means, assume the CRT is connected and use that EDID.

 avivo chips can scale any mode */

 add scaled modes */

 only 800x600 is supported right now on pre-avivo chips */

 We only trust HPD on R600 and newer ASICS. */

/*

 * DVI is complicated

 * Do a DDC probe, if DDC probe passes, get the full EDID so

 * we can do analog/digital monitor detection at this point.

 * If the monitor is an analog monitor or we got no DDC,

 * we need to find the DAC encoder object for this connector.

 * If we got no DDC, we do load detection on the DAC encoder object.

 * If we got analog DDC or load detection passes on the DAC encoder

 * we have to check if this analog encoder is shared with anyone else (TV)

 * if its shared we have to set the other connector to disconnected.

		/* Sometimes the pins required for the DDC probe on DVI

		 * connectors don't make contact at the same time that the ones

		 * for HPD do. If the DDC probe fails even though we had an HPD

			/* rs690 seems to have a problem with connectors not existing and always

 defer use_digital to later */

			/* some oems have boards with separate digital and analog connectors

			 * with a shared ddc line (often vga + hdmi)

			/* This gets complicated.  We have boards with VGA + HDMI with a

			 * shared DDC line and we have boards with DVI-D + HDMI with a shared

			 * DDC line.  The latter is more complex because with DVI<->HDMI adapters

			 * you don't really know what's connected to which port as both are digital.

 cases where both connectors are digital */

 hpd is our only option in this case */

 DVI-D and HDMI-A are digital only */

 if we aren't forcing don't do destructive polling */

		/* only return the previous status if we last

		 * detected a monitor via load.

 find analog encoder */

 deal with analog monitors without DDC */

 assume digital unless load detected otherwise */

	/* RN50 and some RV100 asics in servers often have a hardcoded EDID in the

	 * vbios to deal with KVMs. If we have one and are not able to detect a monitor

	 * by other means, assume the DFP is connected and use that EDID.  In most

	 * cases the DVI port is actually a virtual KVM port connected to the service

	 * processor.

 updated in get modes as well since we need to know if it's analog or digital */

 okay need to be smart in here about which encoder to pick */

 see if we have a default encoder  TODO */

 then check use digitial */

 pick the first one */

 XXX check mode bandwidth */

 clocks over 135 MHz have heat issues with DVI on RV100 */

 HDMI 1.3+ supports max clock of 340 Mhz */

 check against the max pixel clock */

 need to setup ddc on the bridge */

 add scaled modes */

 we have no EDID modes */

 add the width/height from vbios tables if available */

 add scaled modes */

 need to setup ddc on the bridge */

 check if panel is valid */

			/* don't fetch the edid from the vbios if ddc fails and runpm is

			 * enabled so we report disconnected.

 eDP is always DP */

 DP bridges are always DP */

 get the DPCD from the bridge */

 setup ddc on the bridge */

 bridge chips are always aux */

 try DDC */

 try load detection */

 try non-aux ddc (DP to DVI/HDMI/etc. adapter) */

 XXX check mode bandwidth */

			/* AVIVO hardware supports downscaling modes larger than the panel

			 * to the panel size, but I'm not sure this is desirable.

 if scaling is disabled, block non-native modes */

 HDMI 1.3+ supports max clock of 340 Mhz */

 if the user selected tv=0 don't try and add the connector */

 see if we already added it */

 check if it's a dp bridge */

 no HPD on analog connectors */

 no HPD on analog connectors */

 in theory with a DP to VGA converter... */

 no HPD on analog connectors */

 if the user selected tv=0 don't try and add the connector */

 see if we already added it */

 no HPD on analog connectors */

 no HPD on analog connectors */

		/* RS400,RC410,RS480 chipset seems to report a lot

		 * of false positive on load detect, we haven't yet

		 * found a way to make load detect reliable on those

		 * chipset, thus just disable it for TV.

 no HPD on analog connectors */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

********* BARTS ********************** BARTS **************//

 Register,   Value,     Mask bits */

 0x0000c124, 0x84180000, 0x00180000, */

********* CAICOS ********************** CAICOS **************//

 0x0000c124, 0x84180000, 0x00180000, */

********* TURKS ********************** TURKS **************//

 0x0000c124, 0x84180000, 0x00180000, */

 These are the sequences for turks_mgcg_shls

********* BARTS ********************** BARTS **************//

 Register,   Value,     Mask bits */

********* CAICOS ********************** CAICOS **************//

********* TURKS ********************** TURKS **************//

 XXX check minclocks, etc. */

 Set ARB[0] to reflect the DRAM timing needed for ULV.

 Program additional LP registers that are no longer programmed by VBIOS */

 XXX validate the min clocks required for display */

 adjusted low state */

 adjusted medium, high states */

 make sure dc limits are valid */

 current_index == 2 */

 current_index == 2 */

 current_index == 2 */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Author: Stanislaw Skowronek

 translate destination alignment field to the source alignment encoding */

		/* get_unaligned_le32 avoids unaligned accesses from atombios

 functionally, a nop */

 jiffies wrap around we will just wait a little longer */

 nothing */

 op needs to full dst value */

 op needs to full dst value */

 reset data block */

 reset reg block */

 reset fb window */

 reset io mode */

 reset divmul */

 name string isn't always 0 terminated */

 allocate some scratch memory */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König <christian.koenig@amd.com>

/**

 * uvd_v2_2_fence_emit - emit an fence & trap command

 *

 * @rdev: radeon_device pointer

 * @fence: fence to emit

 *

 * Write a fence and a trap command to the ring.

/**

 * uvd_v2_2_semaphore_emit - emit semaphore command

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 * @semaphore: semaphore to emit commands for

 * @emit_wait: true if we should emit a wait command

 *

 * Emit a semaphore command (either wait or signal) to the UVD ring.

/**

 * uvd_v2_2_resume - memory controller programming

 *

 * @rdev: radeon_device pointer

 *

 * Let the UVD memory controller know it's offsets

 RV770 uses V1.0 MC */

 program the VCPU memory controller bits 0-27 */

 bits 28-31 */

 bits 32-39 */

 tell firmware which hardware it is running on */

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 structure size in bytes (includes size field) */

 version */

 supported notifications mask */

 supported functions bit vector */

 structure size in bytes (includes size field) */

 valid flags mask */

 flags */

 notify command code */

 structure size in bytes (includes size field) */

 pending sbios requests */

 panel expansion mode */

 thermal state: target gfx controller */

 thermal state: state id (0: exit state, non-0: state) */

 forced power state: target gfx controller */

 forced power state: state id */

 system power source */

 panel backlight level (0-255) */

 structure size in bytes (includes size field) */

 version */

 supported functions bit vector */

 structure size in bytes (includes size field) */

 client id (bit 2-0: func num, 7-3: dev num, 15-8: bus num) */

 valid flags mask */

 flags */

 request type */

 performance request */

 structure size in bytes (includes size field) */

 return value */

/* Call the ATIF method

/**

 * radeon_atif_call - call an ATIF method

 *

 * @handle: acpi handle

 * @function: the ATIF function to execute

 * @params: ATIF function params

 *

 * Executes the requested ATIF function (all asics).

 * Returns a pointer to the acpi output buffer.

 We need a second fake parameter */

 Fail only if calling the method fails and ATIF is supported */

/**

 * radeon_atif_parse_notification - parse supported notifications

 *

 * @n: supported notifications struct

 * @mask: supported notifications mask from ATIF

 *

 * Use the supported notifications mask from ATIF function

 * ATIF_FUNCTION_VERIFY_INTERFACE to determine what notifications

 * are supported (all asics).

/**

 * radeon_atif_parse_functions - parse supported functions

 *

 * @f: supported functions struct

 * @mask: supported functions mask from ATIF

 *

 * Use the supported functions mask from ATIF function

 * ATIF_FUNCTION_VERIFY_INTERFACE to determine what functions

 * are supported (all asics).

/**

 * radeon_atif_verify_interface - verify ATIF

 *

 * @handle: acpi handle

 * @atif: radeon atif struct

 *

 * Execute the ATIF_FUNCTION_VERIFY_INTERFACE ATIF function

 * to initialize ATIF and determine what features are supported

 * (all asics).

 * returns 0 on success, error on failure.

 TODO: check version? */

/**

 * radeon_atif_get_notification_params - determine notify configuration

 *

 * @handle: acpi handle

 * @n: atif notification configuration struct

 *

 * Execute the ATIF_FUNCTION_GET_SYSTEM_PARAMETERS ATIF function

 * to determine if a notifier is used and if so which one

 * (all asics).  This is either Notify(VGA, 0x81) or Notify(VGA, n)

 * where n is specified in the result if a notifier is used.

 * Returns 0 on success, error on failure.

/**

 * radeon_atif_get_sbios_requests - get requested sbios event

 *

 * @handle: acpi handle

 * @req: atif sbios request struct

 *

 * Execute the ATIF_FUNCTION_GET_SYSTEM_BIOS_REQUESTS ATIF function

 * to determine what requests the sbios is making to the driver

 * (all asics).

 * Returns 0 on success, error on failure.

/**

 * radeon_atif_handler - handle ATIF notify requests

 *

 * @rdev: radeon_device pointer

 * @event: atif sbios request struct

 *

 * Checks the acpi event and if it matches an atif event,

 * handles it.

 * Returns NOTIFY code

 Not our event */

 Check pending SBIOS requests */

 Just fire off a uevent and let userspace tell us what to do */

 TODO: check other events */

	/* We've handled the event, stop the notifier chain. The ACPI interface

	 * overloads ACPI_VIDEO_NOTIFY_PROBE, we don't want to send that to

	 * userspace if the event was generated only to signal a SBIOS

	 * request.

/* Call the ATCS method

/**

 * radeon_atcs_call - call an ATCS method

 *

 * @handle: acpi handle

 * @function: the ATCS function to execute

 * @params: ATCS function params

 *

 * Executes the requested ATCS function (all asics).

 * Returns a pointer to the acpi output buffer.

 We need a second fake parameter */

 Fail only if calling the method fails and ATIF is supported */

/**

 * radeon_atcs_parse_functions - parse supported functions

 *

 * @f: supported functions struct

 * @mask: supported functions mask from ATCS

 *

 * Use the supported functions mask from ATCS function

 * ATCS_FUNCTION_VERIFY_INTERFACE to determine what functions

 * are supported (all asics).

/**

 * radeon_atcs_verify_interface - verify ATCS

 *

 * @handle: acpi handle

 * @atcs: radeon atcs struct

 *

 * Execute the ATCS_FUNCTION_VERIFY_INTERFACE ATCS function

 * to initialize ATCS and determine what features are supported

 * (all asics).

 * returns 0 on success, error on failure.

 TODO: check version? */

/**

 * radeon_acpi_is_pcie_performance_request_supported

 *

 * @rdev: radeon_device pointer

 *

 * Check if the ATCS pcie_perf_req and pcie_dev_rdy methods

 * are supported (all asics).

 * returns true if supported, false if not.

/**

 * radeon_acpi_pcie_notify_device_ready

 *

 * @rdev: radeon_device pointer

 *

 * Executes the PCIE_DEVICE_READY_NOTIFICATION method

 * (all asics).

 * returns 0 on success, error on failure.

 Get the device handle */

/**

 * radeon_acpi_pcie_performance_request

 *

 * @rdev: radeon_device pointer

 * @perf_req: requested perf level (pcie gen speed)

 * @advertise: set advertise caps flag if set

 *

 * Executes the PCIE_PERFORMANCE_REQUEST method to

 * change the pcie gen speed (all asics).

 * returns 0 on success, error on failure.

 Get the device handle */

 client id (bit 2-0: func num, 7-3: dev num, 15-8: bus num) */

/**

 * radeon_acpi_event - handle notify events

 *

 * @nb: notifier block

 * @val: val

 * @data: acpi event

 *

 * Calls relevant radeon functions in response to various

 * acpi events.

 * Returns NOTIFY code

 Check for pending SBIOS requests */

 Call all ACPI methods here */

/**

 * radeon_acpi_init - init driver acpi support

 *

 * @rdev: radeon_device pointer

 *

 * Verifies the AMD ACPI interfaces and registers with the acpi

 * notifier chain (all asics).

 * Returns 0 on success, error on failure.

 Get the device handle */

 No need to proceed if we're sure that ATIF is not supported */

 Call the ATCS method */

 Call the ATIF method */

 Find the encoder controlling the brightness */

		/* XXX check this workraround, if sbios request function is

		 * present we have to see how it's configured in the system

		 * params

 Disable notification */

/**

 * radeon_acpi_fini - tear down driver acpi support

 *

 * @rdev: radeon_device pointer

 *

 * Unregisters with the acpi notifier chain (all asics).

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 sdma */

/*

 * sDMA - System DMA

 * Starting with CIK, the GPU has new asynchronous

 * DMA engines.  These engines are used for compute

 * and gfx.  There are two DMA engines (SDMA0, SDMA1)

 * and each one supports 1 ring buffer used for gfx

 * and 2 queues used for compute.

 *

 * The programming model is very similar to the CP

 * (ring buffer, IBs, etc.), but sDMA has it's own

 * packet format that is different from the PM4 format

 * used by the CP. sDMA supports copying data, writing

 * embedded data, solid fills, and a number of other

 * things.  It also has support for tiling/detiling of

 * buffers.

/**

 * cik_sdma_get_rptr - get the current read pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Get the current rptr from the hardware (CIK+).

/**

 * cik_sdma_get_wptr - get the current write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Get the current wptr from the hardware (CIK+).

/**

 * cik_sdma_set_wptr - commit the write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Write the wptr back to the hardware (CIK+).

/**

 * cik_sdma_ring_ib_execute - Schedule an IB on the DMA engine

 *

 * @rdev: radeon_device pointer

 * @ib: IB object to schedule

 *

 * Schedule an IB in the DMA ring (CIK).

 number of DWs to follow */

 IB packet must end on a 8 DW boundary */

 base must be 32 byte aligned */

/**

 * cik_sdma_hdp_flush_ring_emit - emit an hdp flush on the DMA ring

 *

 * @rdev: radeon_device pointer

 * @ridx: radeon ring index

 *

 * Emit an hdp flush packet on the requested DMA ring.

 == */

 reference */

 mask */

 retry count, poll interval */

/**

 * cik_sdma_fence_ring_emit - emit a fence on the DMA ring

 *

 * @rdev: radeon_device pointer

 * @fence: radeon fence object

 *

 * Add a DMA fence packet to the ring to write

 * the fence seq number and DMA trap packet to generate

 * an interrupt if needed (CIK).

 write the fence */

 generate an interrupt */

 flush HDP */

/**

 * cik_sdma_semaphore_ring_emit - emit a semaphore on the dma ring

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 * @semaphore: radeon semaphore object

 * @emit_wait: wait or signal semaphore

 *

 * Add a DMA semaphore packet to the ring wait on or signal

 * other rings (CIK).

/**

 * cik_sdma_gfx_stop - stop the gfx async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Stop the gfx async dma ring buffers (CIK).

	/* FIXME use something else than big hammer but after few days can not

	 * seem to find good combination so reset SDMA blocks as it seems we

	 * do not shut them down properly. This fix hibernation and does not

	 * affect suspend to ram.

/**

 * cik_sdma_rlc_stop - stop the compute async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Stop the compute async dma queues (CIK).

 XXX todo */

/**

 * cik_sdma_ctx_switch_enable - enable/disable sdma engine preemption

 *

 * @rdev: radeon_device pointer

 * @enable: enable/disable preemption.

 *

 * Halt or unhalt the async dma engines (CIK).

/**

 * cik_sdma_enable - stop the async dma engines

 *

 * @rdev: radeon_device pointer

 * @enable: enable/disable the DMA MEs.

 *

 * Halt or unhalt the async dma engines (CIK).

/**

 * cik_sdma_gfx_resume - setup and start the async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Set up the gfx DMA ring buffers and enable them (CIK).

 * Returns 0 for success, error for failure.

 Set ring buffer size in dwords */

 Initialize the ring buffer's read and write pointers */

 set the wb address whether it's enabled or not */

 enable DMA RB */

 enable DMA IBs */

/**

 * cik_sdma_rlc_resume - setup and start the async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Set up the compute DMA queues and enable them (CIK).

 * Returns 0 for success, error for failure.

 XXX todo */

/**

 * cik_sdma_load_microcode - load the sDMA ME ucode

 *

 * @rdev: radeon_device pointer

 *

 * Loads the sDMA0/1 ucode.

 * Returns 0 for success, -EINVAL if the ucode is not available.

 halt the MEs */

 sdma0 */

 sdma1 */

 sdma0 */

 sdma1 */

/**

 * cik_sdma_resume - setup and start the async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Set up the DMA engines and enable them (CIK).

 * Returns 0 for success, error for failure.

 unhalt the MEs */

 start the gfx rings and rlc compute queues */

/**

 * cik_sdma_fini - tear down the async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Stop the async dma engines and free the rings (CIK).

 halt the MEs */

 XXX - compute dma queue tear down */

/**

 * cik_copy_dma - copy pages using the DMA engine

 *

 * @rdev: radeon_device pointer

 * @src_offset: src GPU address

 * @dst_offset: dst GPU address

 * @num_gpu_pages: number of GPU pages to xfer

 * @resv: reservation object to sync to

 *

 * Copy GPU paging using the DMA engine (CIK).

 * Used by the radeon ttm implementation to move pages if

 * registered as the asic copy callback.

 src/dst endian swap */

/**

 * cik_sdma_ring_test - simple async dma engine test

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Test the DMA engine by writing using it to write an

 * value to memory. (CIK).

 * Returns 0 for success, error for failure.

 number of DWs to follow */

/**

 * cik_sdma_ib_test - test an IB on the DMA engine

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Test a simple IB in the DMA ring (CIK).

 * Returns 0 on success, error on failure.

/**

 * cik_sdma_is_lockup - Check if the DMA engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the async DMA engine is locked up (CIK).

 * Returns true if the engine appears to be locked up, false if not.

/**

 * cik_sdma_vm_copy_pages - update PTEs by copying them from the GART

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @src: src addr to copy from

 * @count: number of page entries to update

 *

 * Update PTEs by copying them from the GART using sDMA (CIK).

 src/dst endian swap */

/**

 * cik_sdma_vm_write_pages - update PTEs by writing them manually

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @addr: dst addr to write into pe

 * @count: number of page entries to update

 * @incr: increase next addr by incr bytes

 * @flags: access flags

 *

 * Update PTEs by writing them manually using sDMA (CIK).

 for non-physically contiguous pages (system) */

/**

 * cik_sdma_vm_set_pages - update the page tables using sDMA

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @addr: dst addr to write into pe

 * @count: number of page entries to update

 * @incr: increase next addr by incr bytes

 * @flags: access flags

 *

 * Update the page tables using sDMA (CIK).

 for physically contiguous pages (vram) */

 dst addr */

 mask */

 value */

 increment size */

 number of entries */

/**

 * cik_sdma_vm_pad_ib - pad the IB to the required number of dw

 *

 * @ib: indirect buffer to fill with padding

 *

/*

 * cik_dma_vm_flush - cik vm flush using sDMA

 *

 * Update the page table base and flush the VM TLB

 * using sDMA (CIK).

 always */

 update SH_MEM_* regs */

 flush HDP */

 flush TLB */

 reference */

 mask */

 retry count, poll interval */

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 move these to drm_dp_helper.c/h */

**** radeon AUX functions *****/

/* Atom needs data in little endian format so swap as appropriate when copying

 * data to or from atom. Note that atom operates on dw units.

 *

 * Use to_le=true when sending data to atom and provide at least

 * ALIGN(num_bytes,4) bytes in the dst buffer.

 *

 * Use to_le=false when receiving data from atom and provide ALIGN(num_bytes,4)

 * byes in the src buffer.

 timeout */

 flags not zero */

 error */

		/* The atom implementation only supports writes with a max payload of

		 * 12 bytes since it uses 4 bits for the total count (header + payload)

		 * in the parameter space.  The atom interface supports 16 byte

		 * payloads for reads. The hw itself supports up to 16 bytes of payload.

		/* tx_size needs to be 4 even for bare address packets since the atom

		 * table needs the info in tx_buf[3].

 Return payload size. */

		/* tx_size needs to be 4 even for bare address packets since the atom

		 * table needs the info in tx_buf[3].

**** general DP utility functions *****/

 convert bits per color to bits per pixel */

 get bpc from the EDID */

**** radeon specific DP functions *****/

 DP bridge chips */

 eDP */

 power up/down the sink */

 set the initial vs/emph on the source */

 sets all lanes at once */

 set the vs/emph on the sink */

 set training pattern on the source */

 enable training pattern on the sink */

 power up the sink */

 possibly enable downspread on the sink */

 set the lane count on the sink */

 set the link rate on the sink */

 start training on the source */

 disable the training pattern on the sink */

 disable the training pattern on the sink */

 disable the training pattern on the source */

 clock recovery loop */

 Compute new train_set as requested by sink */

 channel equalization loop */

 Try 5 times */

 Compute new train_set as requested by sink */

	/* DPEncoderService newer than 1.1 can't program properly the

	 * training pattern. When facing such version use the

	 * DIGXEncoderControl (X== 1 | 2)

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * based on nouveau_prime.c

 *

 * Authors: Alex Deucher

 pin buffer into GTT */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 ??? */

	/* disable mclk switching if the refresh is >120Hz, even if the

        * blanking period would allow it

 XXX validate the min clocks required for display */

 XXX: need to figure out how to handle this properly */

 stop auto-manage */

 restart auto-manage */

		/* XXX The current code always reprogrammed the sclk levels,

		 * but we don't currently handle disp sclk requirements

		 * so just skip it.

 ??? */

 turn the clocks on when encoding */

 turn the clocks off when not encoding */

 not actually supported */

 patch up boot state */

 fill in the vce power states */

 mclk dpm is unstable on some R7 260X cards with the old mc ucode */

 make sure dc limits are valid */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 ??? */

 if no match return the highest voltage */

 limit clocks to max supported clocks based on voltage dependency tables */

 XXX validate the min clocks required for display */

 adjusted low state */

 XXX: 0x10 on tahiti A0 */

 find the first active crtc */

	/* Setting this to false forces the performance state to low if the crtcs are disabled.

	 * This can be a problem on PowerXpress systems or if you want to use the card

	 * for offscreen rendering or compute if there are no crtcs enabled.

 ??? */

 XXX validate against display requirements! */

 ??? */

 turn the clocks on when encoding, off otherwise */

 stop auto-manage */

 restart auto-manage */

 patch up vddc if necessary */

 XXX disable for A0 tahiti */

 patch up boot state */

 fill in the vce power states */

 make sure dc limits are valid */

/*

 * Copyright 2007-11 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 Convert brightness to hardware level */

	/* Mac laptops with multiple GPUs use the gmux driver for backlight

	 * so don't register a backlight device

	/* Set a reasonable default here if the level is 0 otherwise

	 * fbdev will attempt to turn the backlight on after console

	 * unblanking and it will try and restore 0 which turns the backlight

	 * off again.

 !CONFIG_BACKLIGHT_CLASS_DEVICE */

 set the active encoder to connector routing */

 hw bug */

 vertical FP must be at least 1 */

 get the native mode for scaling */

 ??? */

 some R4xx chips have the wrong frev */

 R4xx, R5xx */

 RS600/690/740 */

 DFP1, CRT1, TV1 depending on the type of port */

 R6xx */

 XXX */

 DCE8 */

 XXX */

if (pScrn->rgbBits == 8) */

 dp bridges are always DP */

 DVO is always DVO */

	/* if we don't have an active device yet, just use one of

	 * the connectors tied to the encoder.

 HDMI-B is basically DL-DVI; analog works fine */

 fix me */

return ATOM_ENCODER_MODE_CV;*/

/*

 * DIG Encoder/Transmitter Setup

 *

 * DCE 3.0/3.1

 * - 2 DIG transmitter blocks. UNIPHY (links A and B) and LVTMA.

 * Supports up to 3 digital outputs

 * - 2 DIG encoder blocks.

 * DIG1 can drive UNIPHY link A or link B

 * DIG2 can drive UNIPHY link B or LVTMA

 *

 * DCE 3.2

 * - 3 DIG transmitter blocks. UNIPHY0/1/2 (links A and B).

 * Supports up to 5 digital outputs

 * - 2 DIG encoder blocks.

 * DIG1/2 can drive UNIPHY0/1/2 link A or link B

 *

 * DCE 4.0/5.0/6.0

 * - 3 DIG transmitter blocks UNIPHY0/1/2 (links A and B).

 * Supports up to 6 digital outputs

 * - 6 DIG encoder blocks.

 * - DIG to PHY mapping is hardcoded

 * DIG1 drives UNIPHY0 link A, A+B

 * DIG2 drives UNIPHY0 link B

 * DIG3 drives UNIPHY1 link A, A+B

 * DIG4 drives UNIPHY1 link B

 * DIG5 drives UNIPHY2 link A, A+B

 * DIG6 drives UNIPHY2 link B

 *

 * DCE 4.1

 * - 3 DIG transmitter blocks UNIPHY0/1/2 (links A and B).

 * Supports up to 6 digital outputs

 * - 2 DIG encoder blocks.

 * llano

 * DIG1/2 can drive UNIPHY0/1/2 link A or link B

 * ontario

 * DIG1 drives UNIPHY0/1/2 link A

 * DIG2 drives UNIPHY0/1/2 link B

 *

 * Routing

 * crtc -> dig encoder -> UNIPHY/LVTMA (1 or 2 links)

 * Examples:

 * crtc0 -> dig2 -> LVTMA   links A+B -> TMDS/HDMI

 * crtc1 -> dig1 -> UNIPHY0 link  B   -> DP

 * crtc0 -> dig1 -> UNIPHY2 link  A   -> LVDS

 * crtc1 -> dig2 -> UNIPHY1 link  B+A -> TMDS/HDMI

 no dig encoder assigned */

		/* just needed to avoid bailing in the encoder check.  the encoder

		 * isn't used for init

 no dig encoder assigned */

			/* Select the PLL for the PHY

			 * DP PHY should be clocked from external src if there is

			 * one.

 On DCE4, if there is an external clock, it generates the DP ref clock */

 external src */

 DP requires coherent */

			/* Select the PLL for the PHY

			 * DP PHY should be clocked from external src if there is

			 * one.

 On DCE5 DCPLL usually generates the DP ref clock */

 DP requires coherent */

 DP requires coherent */

 wait for the panel to power up */

 no params on frev 1 */

 XXX: fix up scratch reg handling */

 workaround for DVOOutputControl on some RS690 systems */

 setup and enable the encoder */

 setup and enable the encoder */

 setup and enable the encoder and transmitter */

 enable the transmitter */

 DP_SET_POWER_D0 is set in radeon_dp_link_train */

 don't power off encoders with active MST links */

 disable the transmitter */

 disable the encoder and transmitter */

 update scratch regs with new routing */

 Funky macbooks */

 set scaler clears this on some chips */

 DCE6 */

 DCE4/5 */

 ontario follows DCE4 */

 llano follows DCE3.2 */

	/*

	 * On DCE32 any encoder can drive any block so usually just use crtc id,

	 * but Apple thinks different at least on iMac10,1, so there use linkb,

	 * otherwise the internal eDP panel will stay dark.

 on DCE3 - LVTMA can only be driven by DIGB */

 This only needs to be called once at startup */

 need to call this here rather than in prepare() since we need some crtc info */

 handled in dpms */

 CTV */

 STV */

 load detect on the dp bridge */

 CTV */

 STV */

 ddc_setup on the dp bridge */

 RS600/690/740 have only 1 afmt block */

 select the clock/data port if it uses a router */

 turn eDP panel on for mode set */

 this is needed for the pll/ss setup to work correctly in some cases */

 set up the FMT blocks */

 need to call this here as we need the crtc set up */

	/* check for pre-DCE3 cards with shared encoders;

	 * can't really use the links individually, so don't disable

	 * the encoder if it's in use by another connector

 handled in dpms */

 these are handled by the primary encoders */

 no detect for TMDS/LVDS yet */

 coherent mode by default */

 see if we already added it */

 add a new one */

 these are handled by the primary encoders */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 NOTE, this is a PCIE indirect reg, not PCIE PORT */

 XXX look up hw revision */

 patch up vddc if necessary */

 patch up boot state */

 current_index == 2 */

 current_index == 2 */

 current_index == 2 */

 300 */

 RV770 */

 mclk switching doesn't seem to work reliably on desktop RV770s */

 disable mclk switching */

/*

 * Copyright 2010 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/*

 * Indirect registers accessor

/**

 * evergreen_get_allowed_info_register - fetch the register for the info ioctl

 *

 * @rdev: radeon_device pointer

 * @reg: register offset in bytes

 * @val: register value

 *

 * Returns 0 for success or -EINVAL for an invalid register

 *

 Mhz */

 Mhz */

 start off with something large */

 bypass vclk and dclk with bclk */

 put PLL in bypass mode */

 keep the Bypass mode, put PLL to sleep */

 set VCO_MODE to 1 */

 toggle UPLL_SLEEP to 1 then back to 0 */

 deassert UPLL_RESET */

 assert UPLL_RESET again */

 disable spread spectrum. */

 set feedback divider */

 set ref divider to 0 */

 set PDIV_A and PDIV_B */

 give the PLL some time to settle */

 deassert PLL_RESET */

 switch from bypass mode to normal mode */

 switch VCLK and DCLK selection */

	/* if bios or OS sets MAX_READ_REQUEST_SIZE to an invalid value, fix it

	 * to avoid hangs or perfomance issues

 LVDS/eDP FMT is set up by atom */

 not needed for analog */

 XXX sort out optimal dither settings */

 XXX sort out optimal dither settings */

 not needed */

/**

 * dce4_wait_for_vblank - vblank wait asic callback.

 *

 * @rdev: radeon_device pointer

 * @crtc: crtc to wait for vblank on

 *

 * Wait for vblank on the requested crtc (evergreen+).

	/* depending on when we hit vblank, we may be close to active; if so,

	 * wait for another frame.

/**

 * evergreen_page_flip - pageflip callback.

 *

 * @rdev: radeon_device pointer

 * @crtc_id: crtc to cleanup pageflip on

 * @crtc_base: new address of the crtc (GPU MC address)

 * @async: asynchronous flip

 *

 * Triggers the actual pageflip by updating the primary

 * surface base address (evergreen+).

 flip at hsync for async, default is vsync */

 update pitch */

 update the scanout addresses */

 post the write */

/**

 * evergreen_page_flip_pending - check if page flip is still pending

 *

 * @rdev: radeon_device pointer

 * @crtc_id: crtc to check

 *

 * Returns the current update pending status.

 Return current update_pending status: */

 get temperature in millidegrees */

/**

 * sumo_pm_init_profile - Initialize power profiles callback.

 *

 * @rdev: radeon_device pointer

 *

 * Initialize the power states used in profile mode

 * (sumo, trinity, SI).

 * Used for profile mode only.

 default */

 low,mid sh/mh */

 high sh/mh */

/**

 * btc_pm_init_profile - Initialize power profiles callback.

 *

 * @rdev: radeon_device pointer

 *

 * Initialize the power states used in profile mode

 * (BTC, cayman).

 * Used for profile mode only.

 default */

	/* starting with BTC, there is one state that is used for both

	 * MH and SH.  Difference is that we always use the high clock index for

	 * mclk.

 low sh */

 mid sh */

 high sh */

 low mh */

 mid mh */

 high mh */

/**

 * evergreen_pm_misc - set additional pm hw parameters callback.

 *

 * @rdev: radeon_device pointer

 *

 * Set non-clock parameters associated with a power state

 * (voltage, etc.) (evergreen+).

 0xff0x are flags rather then an actual voltage */

		/* starting with BTC, there is one state that is used for both

		 * MH and SH.  Difference is that we always use the high clock index for

		 * mclk and vddci.

 0xff0x are flags rather then an actual voltage */

/**

 * evergreen_pm_prepare - pre-power state change callback.

 *

 * @rdev: radeon_device pointer

 *

 * Prepare for a power state change (evergreen+).

 disable any active CRTCs */

/**

 * evergreen_pm_finish - post-power state change callback.

 *

 * @rdev: radeon_device pointer

 *

 * Clean up after a power state change (evergreen+).

 enable any active CRTCs */

/**

 * evergreen_hpd_sense - hpd sense callback.

 *

 * @rdev: radeon_device pointer

 * @hpd: hpd (hotplug detect) pin

 *

 * Checks if a digital monitor is connected (evergreen+).

 * Returns true if connected, false if not connected.

/**

 * evergreen_hpd_set_polarity - hpd set polarity callback.

 *

 * @rdev: radeon_device pointer

 * @hpd: hpd (hotplug detect) pin

 *

 * Set the polarity of the hpd pin (evergreen+).

/**

 * evergreen_hpd_init - hpd setup callback.

 *

 * @rdev: radeon_device pointer

 *

 * Setup the hpd pins used by the card (evergreen+).

 * Enable the pin, set the polarity, and enable the hpd interrupts.

			/* don't try to enable hpd on eDP or LVDS avoid breaking the

			 * aux dp channel on imac and help (but not completely fix)

			 * https://bugzilla.redhat.com/show_bug.cgi?id=726143

			 * also avoid interrupt storms during dpms.

/**

 * evergreen_hpd_fini - hpd tear down callback.

 *

 * @rdev: radeon_device pointer

 *

 * Tear down the hpd pins used by the card (evergreen+).

 * Disable the hpd interrupts.

 watermark setup */

	/*

	 * Line Buffer Setup

	 * There are 3 line buffers, each one shared by 2 display controllers.

	 * DC_LB_MEMORY_SPLIT controls how that line buffer is shared between

	 * the display controllers.  The paritioning is done via one of four

	 * preset allocations specified in bits 2:0:

	 * first display controller

	 *  0 - first half of lb (3840 * 2)

	 *  1 - first 3/4 of lb (5760 * 2)

	 *  2 - whole lb (7680 * 2), other crtc must be disabled

	 *  3 - first 1/4 of lb (1920 * 2)

	 * second display controller

	 *  4 - second half of lb (3840 * 2)

	 *  5 - second 3/4 of lb (5760 * 2)

	 *  6 - whole lb (7680 * 2), other crtc must be disabled

	 *  7 - last 1/4 of lb (1920 * 2)

	/* this can get tricky if we have two large displays on a paired group

	 * of crtcs.  Ideally for multiple large displays we'd assign them to

	 * non-linked crtcs for maximum line buffer allocation.

 1/2 */

 whole */

 second controller of the pair uses second half of the lb */

 controller not enabled, so no lb used */

 number of dram channels */

 bandwidth per dram data pin in kHz */

 engine clock in kHz */

 display clock in kHz */

 viewport width */

 active display time in ns */

 blank time in ns */

 mode is interlaced */

 vertical scale ratio */

 number of active crtcs */

 bytes per pixel display + overlay */

 line buffer allocated to pipe */

 vertical scaler taps */

 Calculate DRAM Bandwidth and the part allocated to display. */

 0.7 */

 Calculate DRAM Bandwidth and the part allocated to display. */

 0.3 to 0.7 */

 XXX worse case value 0.3 */

 Calculate the display Data return Bandwidth */

 0.8 */

 Calculate the DMIF Request Bandwidth */

 0.8 */

 Calculate the Available bandwidth. Display can use this temporarily but not in average. */

	/* Calculate the display mode Average Bandwidth

	 * DisplayMode should contain the source and destination dimensions,

	 * timing, etc.

 First calcualte the latency in ns */

 2000 ns. */

 dc pipe latency */

 watermark for high clocks */

 XXX: get this from fb config */

 watermark for low clocks */

 XXX: get this from fb config */

 set for high clocks */

 set for low clocks */

 possibly force display priority to high */

 should really do this at mode validation time... */

 Save number of lines the linebuffer leads before the scanout */

 select wm A */

 select wm B */

 restore original selection */

 write the priority marks */

 save values for DPM */

/**

 * evergreen_bandwidth_update - update display watermarks callback.

 *

 * @rdev: radeon_device pointer

 *

 * Update the display watermarks based on the requested mode(s)

 * (evergreen+).

/**

 * evergreen_mc_wait_for_idle - wait for MC idle callback.

 *

 * @rdev: radeon_device pointer

 *

 * Wait for the MC (memory controller) to be idle.

 * (evergreen+).

 * Returns 0 if the MC is idle, -1 if not.

 read MC_STATUS */

/*

 * GART

 read MC_STATUS */

 Setup L2 cache */

 Setup TLB control */

 Disable all tables */

 Setup L2 cache */

 Setup TLB control */

 Setup L2 cache */

 Setup TLB control */

/*

 * Assumption is that EVERGREEN_CRTC_MASTER_EN enable for requested crtc

 * We go from crtc to connector and it is not relible  since it

 * should be an opposite direction .If crtc is enable then

 * find the dig_fe which selects this crtc and insure that it enable.

 * if such dig_fe is found then find dig_be which selects found dig_be and

 * insure that it enable and in DP_SST mode.

 * if UNIPHY_PLL_CONTROL1.enable then we should disconnect timing

 * from dp symbols clocks .

 loop through all running dig_fe to find selected crtc */

 found running pipe */

 loop through all running dig_be to find selected dig_fe */

 if dig_fe_selected by dig_be? */

 if dig_be in sst mode? */

 dig_be enable and tx is running */

/*

 * Blank dig when in dp sst mode

 * Dig ignores crtc timing

 disable VGA render */

 blank the display controllers */

 wait for the next frame */

we should disable dig if it drives dp sst*/

but we are in radeon_device_init and the topology is unknown*/

and it is available after radeon_modeset_init*/

the following method radeon_atom_encoder_dpms_dig*/

does the job if we initialize it properly*/

for now we do it this manually*/

*/

we could remove 6 lines below*/

 XXX this is a hack to avoid strange behavior with EFI on certain systems */

 ***** */

 Block CPU access */

 blackout the MC */

 wait for the MC to settle */

 lock double buffered regs */

 update crtc base addresses */

 unlock regs and wait for update */

 unblackout the MC */

 allow CPU access */

 wait for the next frame */

 Unlock vga access */

 Initialize HDP */

 Lockout access through VGA aperture*/

 Update configuration */

 VRAM before AGP */

 VRAM after AGP */

 llano/ontario only */

	/* we need to own VRAM, so turn off the VGA renderer here

/*

 * CP.

 set to DX10/11 mode */

 setup clear context state */

 set clear context state */

 SQ_VTX_BASE_VTX_LOC */

 Clear consts */

 VGT_VERTEX_REUSE_BLOCK_CNTL */

  */

 Reset cp; if cp is reset, then PA, SH, VGT also need to be reset */

 Set ring buffer size */

 Set the write pointer delay */

 Initialize the ring buffer's read and write pointers */

 set the wb address whether it's enabled or not */

/*

 * Core functions

 Initialize HDP */

	/* setup tiling info dword.  gb_addr_config is not adequate since it does

	 * not have bank info, so create a custom tiling dword.

	 * bits 3:0   num_pipes

	 * bits 7:4   num_banks

	 * bits 11:8  group_size

	 * bits 15:12 row_size

 num banks is 8 on all fusion asics. 0 = 4, 1 = 8, 2 = 16 */

 four banks */

 eight banks */

 sixteen banks */

 enabled rb are just the one not disabled :) */

 if all the backends are disabled, fix it up here */

 RB0 disabled, RB1 enabled */

 RB1 disabled, RB0 enabled */

 set HW defaults for 3D engine */

 no vertex cache */

 clear render buffer base addresses */

 set the shader const cache sizes to 0 */

 Get VRAM informations */

 Could aper size report 0 ? */

 Setup GPU memory space */

 size in bytes on fusion */

 size in MB on evergreen/cayman/tn */

 GRBM_STATUS */

 DMA_STATUS_REG */

 SRBM_STATUS2 */

 SRBM_STATUS */

 VM_L2_STATUS */

 Skip MC reset as it's mostly likely not hung, just busy */

 Disable CP parsing/prefetching */

 Disable DMA */

 Wait a little for things to settle down */

 disable dpm? */

 Disable CP parsing/prefetching */

 Disable DMA */

 XXX other engines? */

 halt the rlc */

 set mclk/sclk to bypass */

 disable BM */

 disable mem access */

 reset */

 wait for asic to come out of reset */

 try soft reset */

 try pci config reset */

/**

 * evergreen_gfx_is_lockup - Check if the GFX engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the GFX engine is locked up.

 * Returns true if the engine appears to be locked up, false if not.

/*

 * RLC

 save restore block */

 clear state block */

 clear state block */

 save restore block */

 write the sr buffer */

 SI */

 ON/LN/TN */

			/* format:

			 * dw0: (reg2 << 16) | reg1

			 * dw1: reg1 save space

			 * dw2: reg2 save space

 clear state block */

 set up the cs buffer */

 find out the number of active simds */

 Interrupts */

 only one DAC on DCE5 */

 Note that the order we write back regs here is important */

 don't enable anything if the ih is disabled */

 force the active interrupt state to all disabled */

 enable CP interrupts on all rings */

 posting read */

 Note that the order we write back regs here is important */

 We write back each interrupt register in pairs of two */

 Wait and acknowledge irq */

		/* When a ring buffer overflow happen start parsing interrupt

		 * from the last not overwritten vector (wptr + 16). Hopefully

		 * this should allow us to catchup.

 is somebody else already processing irqs? */

 Order reading of wptr vs. reading of IH ring data */

 display interrupts */

 wptr/rptr are in bytes! */

 D1 vblank/vline */

 D2 vblank/vline */

 D3 vblank/vline */

 D4 vblank/vline */

 D5 vblank/vline */

 D6 vblank/vline */

 vblank */

 vline */

 D1 page flip */

 D2 page flip */

 D3 page flip */

 D4 page flip */

 D5 page flip */

 D6 page flip */

 HPD hotplug */

 hdmi */

 UVD */

 reset addr and status */

 CP_INT in ring buffer */

 CP_INT in IB1 */

 CP_INT in IB2 */

 CP EOP event */

 DMA trap event */

 thermal low to high */

 thermal high to low */

 GUI IDLE */

 DMA trap event */

 wptr/rptr are in bytes! */

 make sure wptr hasn't changed while processing */

		/*

		 * At this point rdev->uvd.vcpu_bo is NULL which trickles down

		 * to early fails uvd_v2_2_resume() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable uvd here.

 enable pcie gen2 link */

 enable aspm */

 scratch needs to be initialized before MC */

 allocate rlc buffers */

 allocate wb buffer */

 Enable IRQ */

	/* reset the asic, the gfx blocks are often in a bad state

	 * after the driver is unloaded or after a resume

	/* Do not reset GPU before posting, on rv770 hw unlike on r500 hw,

	 * posting will perform necessary task to bring back GPU into good

	 * shape.

 post card */

 init golden registers */

/* Plan is to move initialization in that function and use

 * helper function so that radeon_device_init pretty much

 * do nothing more than calling asic specific function. This

 * should also allow to remove a bunch of callback function

 * like vram_info.

 Read BIOS */

 Must be an ATOMBIOS */

	/* reset the asic, the gfx blocks are often in a bad state

	 * after the driver is unloaded or after a resume

 Post card if necessary */

 init golden registers */

 Initialize scratch registers */

 Initialize surface registers */

 Initialize clocks */

 Fence driver */

 initialize AGP */

 initialize memory controller */

 Memory manager */

 Initialize power management */

	/* Don't start up if the MC ucode is missing on BTC parts.

	 * The default clocks and voltages before the MC ucode

	 * is loaded are not suffient for advanced operations.

 x2 cards have a special sequence */

 XXX: only disable it if gen1 bridge vendor == 0x111d or 0x1106 */

	/* fusion_platform = true

	 * if the system is a fusion system

	 * (APU or DGPU in a fusion system).

	 * todo: check if the system is a fusion platform.

 XXX also dGPUs in a fusion system */

 evergreen parts only */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 This files gather functions specifics to: r520,rv530,rv560,rv570,r580 */

 read MC_STATUS */

	/*

	 * DST_PIPE_CONFIG		0x170C

	 * GB_TILE_CONFIG		0x4018

	 * GB_FIFO_SIZE			0x4024

	 * GB_PIPE_SELECT		0x402C

	 * GB_PIPE_SELECT2              0x4124

	 *	Z_PIPE_SHIFT			0

	 *	Z_PIPE_MASK			0x000000003

	 * GB_FIFO_SIZE2                0x4128

	 *	SC_SFIFO_SIZE_SHIFT		0

	 *	SC_SFIFO_SIZE_MASK		0x000000003

	 *	SC_MFIFO_SIZE_SHIFT		2

	 *	SC_MFIFO_SIZE_MASK		0x00000000C

	 *	FG_SFIFO_SIZE_SHIFT		4

	 *	FG_SFIFO_SIZE_MASK		0x000000030

	 *	ZB_MFIFO_SIZE_SHIFT		6

	 *	ZB_MFIFO_SIZE_MASK		0x0000000C0

	 * GA_ENHANCE			0x4274

	 * SU_REG_DEST			0x42C8

 workaround for RV530 */

 Stops all mc clients */

 Wait for mc idle */

 Write VRAM size in case we are limiting it */

 Program MC, should be a 32bits limited address space */

 Resume clock */

 Initialize GPU configuration (# pipes, ...) */

	/* Initialize GART (initialize after TTM so we can allocate

 allocate wb buffer */

 Enable IRQ */

 1M ring buffer */

 Make sur GART are not working */

 Resume clock before doing reset */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 post */

 Resume clock after posting */

 Initialize surface registers */

 Initialize scratch registers */

 Initialize surface registers */

 restore some register to sane defaults */

 TODO: disable VGA need to use VGA request */

 BIOS*/

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Initialize clocks */

 initialize AGP */

 initialize memory controller */

 Fence driver */

 Memory manager */

 Initialize power management */

 Somethings want wront with the accel init stop accel */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König <christian.koenig@amd.com>

/**

 * uvd_v1_0_get_rptr - get read pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 *

 * Returns the current hardware read pointer

/**

 * uvd_v1_0_get_wptr - get write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 *

 * Returns the current hardware write pointer

/**

 * uvd_v1_0_set_wptr - set write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 *

 * Commits the write pointer to the hardware

/**

 * uvd_v1_0_fence_emit - emit an fence & trap command

 *

 * @rdev: radeon_device pointer

 * @fence: fence to emit

 *

 * Write a fence and a trap command to the ring.

/**

 * uvd_v1_0_resume - memory controller programming

 *

 * @rdev: radeon_device pointer

 *

 * Let the UVD memory controller know it's offsets

 program the VCPU memory controller bits 0-27 */

 bits 28-31 */

 bits 32-39 */

/**

 * uvd_v1_0_init - start and test UVD block

 *

 * @rdev: radeon_device pointer

 *

 * Initialize the hardware, boot up the VCPU and do some testing

 raise clocks while booting up the VCPU */

 Clear timeout status bits */

 lower clocks again */

 64byte granularity workaround */

 write clean workaround */

 TODO: Do we need more? */

/**

 * uvd_v1_0_fini - stop the hardware block

 *

 * @rdev: radeon_device pointer

 *

 * Stop the UVD block, mark ring as not ready any more

/**

 * uvd_v1_0_start - start UVD block

 *

 * @rdev: radeon_device pointer

 *

 * Setup and start the UVD block

 disable byte swapping */

 disable clock gating */

 disable interupt */

 Stall UMC and register bus before resetting VCPU */

 put LMI, VCPU, RBC etc... into reset */

 take UVD block out of reset */

 initialize UVD memory controller */

 swap (8 in 32) RB and IB */

 take all subblocks out of reset, except VCPU */

 enable VCPU clock */

 enable UMC */

 boot up the VCPU */

 enable interupt */

 force RBC into idle state */

 Set the write pointer delay */

 program the 4GB memory segment for rptr and ring buffer */

 Initialize the ring buffer's read and write pointers */

 set the ring address */

 Set ring buffer size */

/**

 * uvd_v1_0_stop - stop UVD block

 *

 * @rdev: radeon_device pointer

 *

 * stop the UVD block

 force RBC into idle state */

 Stall UMC and register bus before resetting VCPU */

 put VCPU into reset */

 disable VCPU clock */

 Unstall UMC and register bus */

/**

 * uvd_v1_0_ring_test - register write test

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 *

 * Test if we can successfully write to the context register

/**

 * uvd_v1_0_semaphore_emit - emit semaphore command

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 * @semaphore: semaphore to emit commands for

 * @emit_wait: true if we should emit a wait command

 *

 * Emit a semaphore command (either wait or signal) to the UVD ring.

 disable semaphores for UVD V1 hardware */

/**

 * uvd_v1_0_ib_execute - execute indirect buffer

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to execute

 *

 * Write ring commands to execute the indirect buffer

/**

 * uvd_v1_0_ib_test - test ib execution

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 *

 * Test if we can successfully execute an IB

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/**

 * si_get_allowed_info_register - fetch the register for the info ioctl

 *

 * @rdev: radeon_device pointer

 * @reg: register offset in bytes

 * @val: register value

 *

 * Returns 0 for success or -EINVAL for an invalid register

 *

/**

 * si_get_xclk - get the xclk

 *

 * @rdev: radeon_device pointer

 *

 * Returns the reference clock used by the gfx engine

 * (SI).

 get temperature in millidegrees */

 ucode loading */

 reset the engine and set to writable */

 load mc io regs */

 load the MC ucode */

 put the engine back into the active state */

 wait for training to complete */

 this memory configuration requires special firmware */

 watermark setup */

	/*

	 * Line Buffer Setup

	 * There are 3 line buffers, each one shared by 2 display controllers.

	 * DC_LB_MEMORY_SPLIT controls how that line buffer is shared between

	 * the display controllers.  The paritioning is done via one of four

	 * preset allocations specified in bits 21:20:

	 *  0 - half lb

	 *  2 - whole lb, other crtc must be disabled

	/* this can get tricky if we have two large displays on a paired group

	 * of crtcs.  Ideally for multiple large displays we'd assign them to

	 * non-linked crtcs for maximum line buffer allocation.

 1/2 */

 whole */

 controller not enabled, so no lb used */

 number of dram channels */

 bandwidth per dram data pin in kHz */

 engine clock in kHz */

 display clock in kHz */

 viewport width */

 active display time in ns */

 blank time in ns */

 mode is interlaced */

 vertical scale ratio */

 number of active crtcs */

 bytes per pixel display + overlay */

 line buffer allocated to pipe */

 vertical scaler taps */

 Calculate raw DRAM Bandwidth */

 0.7 */

 Calculate DRAM Bandwidth and the part allocated to display. */

 0.3 to 0.7 */

 XXX worse case value 0.3 */

 Calculate the display Data return Bandwidth */

 0.8 */

 Calculate the DMIF Request Bandwidth */

 0.8 */

 Calculate the Available bandwidth. Display can use this temporarily but not in average. */

	/* Calculate the display mode Average Bandwidth

	 * DisplayMode should contain the source and destination dimensions,

	 * timing, etc.

 First calcualte the latency in ns */

 2000 ns. */

 dc pipe latency */

 watermark for high clocks */

 XXX: get this from fb config */

 watermark for low clocks */

 XXX: get this from fb config */

 set for high clocks */

 set for low clocks */

 possibly force display priority to high */

 should really do this at mode validation time... */

 Save number of lines the linebuffer leads before the scanout */

 select wm A */

 select wm B */

 restore original selection */

 write the priority marks */

 save values for DPM */

/*

 * Core functions

 non-AA compressed depth or any compressed stencil */

 2xAA/4xAA compressed depth only */

 8xAA compressed depth only */

 2xAA/4xAA compressed depth with stencil (for depth buffer) */

 Maps w/ a dimension less than the 2D macro-tile dimensions (for mipmapped depth textures) */

 Uncompressed 16bpp depth - and stencil buffer allocated with it */

 Uncompressed 32bpp depth - and stencil buffer allocated with it */

 Uncompressed 8bpp stencil without depth (drivers typically do not use) */

 1D and 1D Array Surfaces */

 Displayable maps. */

 Display 8bpp. */

 Display 16bpp. */

 Display 32bpp. */

 Thin. */

 Thin 8 bpp. */

 Thin 16 bpp. */

 Thin 32 bpp. */

 Thin 64 bpp. */

 8 bpp PRT. */

 16 bpp PRT */

 32 bpp PRT */

 64 bpp PRT */

 128 bpp PRT */

 non-AA compressed depth or any compressed stencil */

 2xAA/4xAA compressed depth only */

 8xAA compressed depth only */

 2xAA/4xAA compressed depth with stencil (for depth buffer) */

 Maps w/ a dimension less than the 2D macro-tile dimensions (for mipmapped depth textures) */

 Uncompressed 16bpp depth - and stencil buffer allocated with it */

 Uncompressed 32bpp depth - and stencil buffer allocated with it */

 Uncompressed 8bpp stencil without depth (drivers typically do not use) */

 1D and 1D Array Surfaces */

 Displayable maps. */

 Display 8bpp. */

 Display 16bpp. */

 Display 32bpp. */

 Thin. */

 Thin 8 bpp. */

 Thin 16 bpp. */

 Thin 32 bpp. */

 Thin 64 bpp. */

 8 bpp PRT. */

 16 bpp PRT */

 32 bpp PRT */

 64 bpp PRT */

 128 bpp PRT */

 Initialize HDP */

 XXX use MC settings? */

 fix up row size */

	/* setup tiling info dword.  gb_addr_config is not adequate since it does

	 * not have bank info, so create a custom tiling dword.

	 * bits 3:0   num_pipes

	 * bits 7:4   num_banks

	 * bits 11:8  group_size

	 * bits 15:12 row_size

 XXX what about 12? */

 four banks */

 eight banks */

 sixteen banks */

 set HW defaults for 3D engine */

/*

 * GPU scratch registers helpers function.

 flush read cache over gart */

 poll interval */

 EVENT_WRITE_EOP - flush caches, send int */

/*

 * IB stuff

 set switch buffer packet before const IB */

 flush read cache over gart for this vmid */

 poll interval */

/*

 * CP.

 PFP */

 CE */

 ME */

 PFP */

 CE */

 ME */

 init the CP */

 init the CE partitions */

 setup clear context state */

 set clear context state */

 VGT_VERTEX_REUSE_BLOCK_CNTL */

 VGT_OUT_DEALLOC_CNTL */

 clear the compute context state */

 Set the write pointer delay */

 ring 0 - compute and gfx */

 Set ring buffer size */

 Initialize the ring buffer's read and write pointers */

 set the wb address whether it's enabled or not */

 ring1  - compute only */

 Set ring buffer size */

 Initialize the ring buffer's read and write pointers */

 set the wb address whether it's enabled or not */

 ring2 - compute only */

 Set ring buffer size */

 Initialize the ring buffer's read and write pointers */

 set the wb address whether it's enabled or not */

 start the rings */

 GRBM_STATUS */

 GRBM_STATUS2 */

 DMA_STATUS_REG 0 */

 DMA_STATUS_REG 1 */

 SRBM_STATUS2 */

 SRBM_STATUS */

 VM_L2_STATUS */

 Skip MC reset as it's mostly likely not hung, just busy */

 disable PG/CG */

 stop the rlc */

 Disable CP parsing/prefetching */

 dma0 */

 dma1 */

 Wait a little for things to settle down */

 disable dpm? */

 disable cg/pg */

 Disable CP parsing/prefetching */

 dma0 */

 dma1 */

 XXX other engines? */

 halt the rlc, disable cp internal ints */

 disable mem access */

 set mclk/sclk to bypass */

 powerdown spll */

 disable BM */

 reset */

 wait for asic to come out of reset */

 try soft reset */

 try pci config reset */

/**

 * si_gfx_is_lockup - Check if the GFX engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the GFX engine is locked up.

 * Returns true if the engine appears to be locked up, false if not.

 MC */

 Initialize HDP */

 Lockout access through VGA aperture*/

 Update configuration */

 XXX double check these! */

		/* we need to own VRAM, so turn off the VGA renderer here

 leave room for at least 1024M GTT */

 Get VRAM informations */

 Could aper size report 0 ? */

 size in MB on si */

 some boards may have garbage in the upper 16 bits */

/*

 * GART

 flush hdp cache */

 bits 0-15 are the VM contexts0-15 */

 Setup TLB control */

 Setup L2 cache */

 setup context0 */

 empty context1-15 */

 set vm size, must be a multiple of 4 */

	/* Assign the pt base to something valid for now; the pts used for

	 * the VMs are determined by the application and setup and assigned

	 * on the fly in the vm part of radeon_gart.c

 enable context1-15 */

 Disable all tables */

 Setup TLB control */

 Setup L2 cache */

 vm parser */

 context regs are fine */

 shader regs are also fine */

 check config regs */

 src address space is register */

 dst address space is register */

/*

 * vm

 number of VMs */

 base offset of vram pages */

/**

 * si_vm_decode_fault - print human readable fault info

 *

 * @rdev: radeon_device pointer

 * @status: VM_CONTEXT1_PROTECTION_FAULT_STATUS register value

 * @addr: VM_CONTEXT1_PROTECTION_FAULT_ADDR register value

 *

 * Print human readable fault information (SI).

 write new base address */

 flush hdp cache */

 bits 0-15 are the VM contexts0-15 */

 wait for the invalidate to complete */

 always */

 me */

 ref */

 mask */

 poll interval */

 sync PFP to ME, otherwise we might get invalid PFP reads */

/*

 *  Power and clock gating

 read a gfx register */

 order matters! */

 begin clear state */

 context control state */

 pa_sc_raster_config */

 end clear state */

 clear state */

/*

 * RLC

 Enable LBPW only for DDR3 */

 set rptr, wptr to 0 */

 allocate ring */

 disable irqs */

 init rlc */

 setup interrupt control */

 set dummy read address to dummy page address */

	/* IH_DUMMY_RD_OVERRIDE=0 - dummy read disabled with msi, enabled without msi

	 * IH_DUMMY_RD_OVERRIDE=1 - dummy read controlled by IH_DUMMY_RD_EN

 IH_REQ_NONSNOOP_EN=1 if ring is in non-cacheable memory, e.g., vram */

 set the writeback address whether it's enabled or not */

 set rptr, wptr to 0 */

 Default settings for IH_CNTL (disabled at first) */

 RPTR_REARM only works if msi's are enabled */

 force the active interrupt state to all disabled */

 enable irqs */

 The order we write back each register here is important */

 don't enable anything if the ih is disabled */

 force the active interrupt state to all disabled */

 enable CP interrupts on all rings */

 posting read */

 The order we write back each register here is important */

 We write back each interrupt register in pairs of two */

 Wait and acknowledge irq */

		/* When a ring buffer overflow happen start parsing interrupt

		 * from the last not overwritten vector (wptr + 16). Hopefully

		 * this should allow us to catchup.

/*        SI IV Ring

 * Each IV ring entry is 128 bits:

 * [7:0]    - interrupt source id

 * [31:8]   - reserved

 * [59:32]  - interrupt source data

 * [63:60]  - reserved

 * [71:64]  - RINGID

 * [79:72]  - VMID

 * [127:80] - reserved

 is somebody else already processing irqs? */

 Order reading of wptr vs. reading of IH ring data */

 display interrupts */

 wptr/rptr are in bytes! */

 D1 vblank/vline */

 D2 vblank/vline */

 D3 vblank/vline */

 D4 vblank/vline */

 D5 vblank/vline */

 D6 vblank/vline */

 vblank */

 vline */

 D1 page flip */

 D2 page flip */

 D3 page flip */

 D4 page flip */

 D5 page flip */

 D6 page flip */

 HPD hotplug */

 UVD */

 reset addr and status */

 RINGID0 CP_INT */

 RINGID1 CP_INT */

 RINGID2 CP_INT */

 CP EOP event */

 DMA trap event */

 thermal low to high */

 thermal high to low */

 GUI IDLE */

 DMA trap event */

 wptr/rptr are in bytes! */

 make sure wptr hasn't changed while processing */

/*

 * startup/shutdown callbacks

		/*

		 * At this point rdev->uvd.vcpu_bo is NULL which trickles down

		 * to early fails uvd_v2_2_resume() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable uvd here.

		/*

		 * At this point rdev->vce.vcpu_bo is NULL which trickles down

		 * to early fails si_vce_start() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable vce here.

 enable pcie gen2/3 link */

 enable aspm */

 scratch needs to be initialized before MC */

 allocate rlc buffers */

 allocate wb buffer */

 Enable IRQ */

	/* Do not reset GPU before posting, on rv770 hw unlike on r500 hw,

	 * posting will perform necessary task to bring back GPU into good

	 * shape.

 post card */

 init golden registers */

/* Plan is to move initialization in that function and use

 * helper function so that radeon_device_init pretty much

 * do nothing more than calling asic specific function. This

 * should also allow to remove a bunch of callback function

 * like vram_info.

 Read BIOS */

 Must be an ATOMBIOS */

 Post card if necessary */

 init golden registers */

 Initialize scratch registers */

 Initialize surface registers */

 Initialize clocks */

 Fence driver */

 initialize memory controller */

 Memory manager */

 Initialize power management */

	/* Don't start up if the MC ucode is missing.

	 * The default clocks and voltages before the MC ucode

	 * is loaded are not suffient for advanced operations.

/**

 * si_get_gpu_clock_counter - return GPU clock counter snapshot

 *

 * @rdev: radeon_device pointer

 *

 * Fetches a GPU clock counter snapshot (SI).

 * Returns the 64 bit clock counter snapshot.

 bypass vclk and dclk with bclk */

 put PLL in bypass mode */

 keep the Bypass mode */

 set RESET_ANTI_MUX to 0 */

 set VCO_MODE to 1 */

 disable sleep mode */

 deassert UPLL_RESET */

 assert UPLL_RESET again */

 disable spread spectrum. */

 set feedback divider */

 set ref divider to 0 */

 set PDIV_A and PDIV_B */

 give the PLL some time to settle */

 deassert PLL_RESET */

 switch from bypass mode to normal mode */

 switch VCLK and DCLK selection */

 re-try equalization if gen3 is not already enabled */

 check status */

 linkctl */

 linkctl2 */

 set the link speed */

 gen3 */

 gen2 */

 gen1 */

 make sure VCEPLL_CTLREQ is deasserted */

 assert UPLL_CTLREQ */

 wait for CTLACK and CTLACK2 to get asserted */

 deassert UPLL_CTLREQ */

 bypass evclk and ecclk with bclk */

 put PLL in bypass mode */

 keep the Bypass mode, put PLL to sleep */

 set RESET_ANTI_MUX to 0 */

 set VCO_MODE to 1 */

 toggle VCEPLL_SLEEP to 1 then back to 0 */

 deassert VCEPLL_RESET */

 assert VCEPLL_RESET again */

 disable spread spectrum. */

 set feedback divider */

 set ref divider to 0 */

 set PDIV_A and PDIV_B */

 give the PLL some time to settle */

 deassert PLL_RESET */

 switch from bypass mode to normal mode */

 switch VCLK and DCLK selection */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 SMC address space is BE */

 RMW for final bytes */

 SMC address space is BE */

 SMC address space is BE */

 load the ucode */

 set up the int vectors */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

/*

 * BIOS.

/* If you boot an IGP board with a discrete card as the primary,

 * the IGP rom is not accessible via the rom bar as the IGP rom is

 * part of the system bios.  On boot, the system bios puts a

 * copy of the igp rom at the start of vram if a discrete card is

 * present.

 ??? */

 XXX: some cards may return 0 for rom size? ddx has a workaround */

/* ATRM is used to get the BIOS on the discrete cards in

 * dual-gpu systems.

 retrieve the ROM in 4k blocks */

/**

 * radeon_atrm_call - fetch a chunk of the vbios

 *

 * @atrm_handle: acpi ATRM handle

 * @bios: vbios image pointer

 * @offset: offset of vbios image data to fetch

 * @len: length of vbios image data to fetch

 *

 * Executes ATRM to fetch a chunk of the discrete

 * vbios image on PX systems (all asics).

 * Returns the length of the buffer fetched.

 ATRM is for the discrete card only */

 enable the rom */

 Disable VGA mode */

 restore regs */

 disable VIP */

 enable the rom */

 Disable VGA mode */

 enable bypass mode */

 wait for SPLL_CHG_STATUS to change to 1 */

 restore regs */

 wait for SPLL_CHG_STATUS to change to 1 */

 disable VIP */

 enable the rom */

 Disable VGA mode */

 restore regs */

 disable VIP */

 enable the rom */

 Disable VGA mode */

 restore regs */

 disable VIP */

 enable the rom */

 Turn off mem requests and CRTC for both controllers */

 Turn off CRTC */

 restore regs */

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 Only change bit 0 of LUT_SEL, other bits are set elsewhere */

 XXX match this to the depth of the crtc fmt block, move to modeset? */

		/* XXX this only needs to be programmed once per crtc at startup,

		 * not sure where the best place for it is

/**

 * radeon_unpin_work_func - unpin old buffer object

 *

 * @__work: kernel work item

 *

 * Unpin the old frame buffer object outside of the interrupt handler

 unpin of the old buffer */

 can happen during initialization */

	/* Skip the pageflip completion check below (based on polling) on

	 * asics which reliably support hw pageflip completion irqs. pflip

	 * irqs are a reliable and race-free method of handling pageflip

	 * completion detection. A use_pflipirq module parameter < 2 allows

	 * to override this in case of asics with faulty pflip irqs.

	 * A module parameter of 0 would only use this polling based path,

	 * a parameter of 1 would use pflip irq only as a backup to this

	 * path, as in Linux 3.16.

	/* Has the pageflip already completed in crtc, or is it certain

	 * to complete in this vblank? GET_DISTANCE_TO_VBLANKSTART provides

	 * distance to start of "fudged earlier" vblank in vpos, distance to

	 * start of real vblank in hpos. vpos >= 0 && hpos < 0 means we are in

	 * the last few scanlines before start of real vblank, where the vblank

	 * irq can fire, so we have sampled update_pending a bit too early and

	 * know the flip will complete at leading edge of the upcoming real

	 * vblank. On pre-AVIVO hardware, flips also complete inside the real

	 * vblank, not only at leading edge, so if update_pending for hpos >= 0

	 *  == inside real vblank, the flip will complete almost immediately.

	 * Note that this method of completion handling is still not 100% race

	 * free, as we could execute before the radeon_flip_work_func managed

	 * to run and set the RADEON_FLIP_SUBMITTED status, thereby we no-op,

	 * but the flip still gets programmed into hw and completed during

	 * vblank, leading to a delayed emission of the flip completion event.

	 * This applies at least to pre-AVIVO hardware, where flips are always

	 * completing inside vblank, not only at leading edge of vblank.

		/* crtc didn't flip in this target vblank interval,

		 * but flip is pending in crtc. Based on the current

		 * scanout position we know that the current frame is

		 * (nearly) complete and the flip will (likely)

		 * complete before the start of the next frame.

/**

 * radeon_crtc_handle_flip - page flip completed

 *

 * @rdev: radeon device pointer

 * @crtc_id: crtc number this event is for

 *

 * Called when we are sure that a page flip for this crtc is completed.

 this can happen at init */

 Pageflip completed. Clean up. */

 wakeup userspace */

/**

 * radeon_flip_work_func - page flip framebuffer

 *

 * @__work: kernel work item

 *

 * Wait for the buffer object to become idle and do the actual page flip

		/* We continue with the page flip even if we failed to wait on

		 * the fence, otherwise the DRM core and userspace will be

		 * confused about which BO the CRTC is scanning out

	/* Wait until we're out of the vertical blank period before the one

	 * targeted by the flip. Always wait on pre DCE4 to avoid races with

	 * flip completion handling from vblank irq, as these old asics don't

	 * have reliable pageflip completion interrupts.

 We borrow the event spin lock for protecting flip_status */

 set the proper interrupt */

 do the flip (mmio) */

 schedule unpin of the old buffer */

 take a reference to the old object */

 pin the new buffer */

 Only 27 bit offset for legacy CRTC */

 crtc offset is from display base addr not FB location */

 We borrow the event spin lock for protecting flip_work */

 update crtc fb */

	/* if we have active crtcs and we don't have a power ref,

	/* if we have no active crtcs, then drop the power ref

 drop the power reference we got coming in here */

 avivo */

/**

 * avivo_reduce_ratio - fractional number reduction

 *

 * @nom: nominator

 * @den: denominator

 * @nom_min: minimum value for nominator

 * @den_min: minimum value for denominator

 *

 * Find the greatest common divisor and apply it on both nominator and

 * denominator, but make nominator and denominator are at least as large

 * as their minimum values.

 reduce the numbers to a simpler ratio */

 make sure nominator is large enough */

 make sure the denominator is large enough */

/**

 * avivo_get_fb_ref_div - feedback and ref divider calculation

 *

 * @nom: nominator

 * @den: denominator

 * @post_div: post divider

 * @fb_div_max: feedback divider maximum

 * @ref_div_max: reference divider maximum

 * @fb_div: resulting feedback divider

 * @ref_div: resulting reference divider

 *

 * Calculate feedback and reference divider for a given post divider. Makes

 * sure we stay within the limits.

 limit reference * post divider to a maximum */

 get matching reference and feedback divider */

 limit fb divider to its maximum */

/**

 * radeon_compute_pll_avivo - compute PLL paramaters

 *

 * @pll: information about the PLL

 * @freq: target frequency

 * @dot_clock_p: resulting pixel clock

 * @fb_div_p: resulting feedback divider

 * @frac_fb_div_p: fractional part of the feedback divider

 * @ref_div_p: resulting reference divider

 * @post_div_p: resulting reference divider

 *

 * Try to calculate the PLL parameters to generate the given frequency:

 * dot_clock = (ref_freq * feedback_div) / (ref_div * post_div)

 determine allowed feedback divider range */

 determine allowed ref divider range */

 fix for problems on RS880 */

 determine allowed post divider range */

 represent the searched ratio as fractional number */

 reduce the numbers to a simpler ratio */

 now search for a post divider */

 get the feedback and reference divider for the optimal value */

 reduce the numbers to a simpler ratio once more */

 this also makes sure that the reference divider is large enough */

 avoid high jitter with small fractional dividers */

 and finally save the result */

 pre-avivo */

 legacy radeons only have a few post_divs */

 Handle is imported dma-buf, so cannot be migrated to VRAM for scanout */

 XXX support different dither options? spatial, temporal, both, etc. */

 adjustment options for the display watermarks */

		/* set display priority to high for r3xx, rv515 chips

		 * this avoids flickering due to underflow to the

		 * display controllers during heavy acceleration.

		 * Don't force high on rs4xx igp chips as it seems to

		 * affect the sound card.  See kernel bug 15982.

/*

 * Allocate hdmi structs and determine register offsets

 nothing to do */

 DCE8 has 7 audio blocks tied to DIG encoders */

 DCE6 has 6 audio blocks tied to DIG encoders */

 DCE4/5 has 6 audio blocks tied to DIG encoders */

 DCE4.1 has 2 audio blocks tied to DIG encoders */

 DCE4 */

 DCE3.x has 2 audio blocks tied to DIG encoders */

 DCE2 has at least 1 routable audio block */

 r6xx has 2 routable audio blocks */

 init i2c buses */

 check combios for a valid hardcoded EDID - Sun servers */

 check for hardcoded EDID in BIOS */

 allocate crtcs */

 okay we should have all the bios connectors */

 init dig PHYs, disp eng pll */

 initialize hpd */

 setup afmt */

 do pm late init */

 free i2c buses */

 try and guess if this is a tv or a monitor */

 480p */

 576p */

 720p */

 1080p */

 set scaling */

 copy native mode */

 fix up for overscan on hdmi */

				/* WARNING: Right now this can't happen but

				 * in the future we need to check that scaling

				 * are consistent across different encoder

				 * (ie all encoder can work with the same

				 *  scaling).

/*

 * Retrieve current video scanout position of crtc on a given gpu, and

 * an optional accurate timestamp of when query happened.

 *

 * \param dev Device to query.

 * \param crtc Crtc to query.

 * \param flags Flags from caller (DRM_CALLED_FROM_VBLIRQ or 0).

 *              For driver internal use only also supports these flags:

 *

 *              USE_REAL_VBLANKSTART to use the real start of vblank instead

 *              of a fudged earlier start of vblank.

 *

 *              GET_DISTANCE_TO_VBLANKSTART to return distance to the

 *              fudged earlier start of vblank in *vpos and the distance

 *              to true start of vblank in *hpos.

 *

 * \param *vpos Location where vertical scanout position should be stored.

 * \param *hpos Location where horizontal scanout position should go.

 * \param *stime Target location for timestamp taken immediately before

 *               scanout position query. Can be NULL to skip timestamp.

 * \param *etime Target location for timestamp taken immediately after

 *               scanout position query. Can be NULL to skip timestamp.

 *

 * Returns vpos as a positive number while in active scanout area.

 * Returns vpos as a negative number inside vblank, counting the number

 * of scanlines to go until end of vblank, e.g., -1 means "one scanline

 * until start of active scanout / end of vblank."

 *

 * \return Flags, or'ed together as follows:

 *

 * DRM_SCANOUTPOS_VALID = Query successful.

 * DRM_SCANOUTPOS_INVBL = Inside vblank.

 * DRM_SCANOUTPOS_ACCURATE = Returned position is accurate. A lack of

 * this flag means that returned position may be offset by a constant but

 * unknown small number of scanlines wrt. real scanout position.

 *

 preempt_disable_rt() should go right here in PREEMPT_RT patchset. */

 Get optional system timestamp before query. */

 Pre-AVIVO: Different encoding of scanout pos and vblank interval. */

			/* Assume vbl_end == 0, get vbl_start from

			 * upper 16 bits.

 Only retrieve vpos from upper 16 bits, set hpos == 0. */

 Get optional system timestamp after query. */

 preempt_enable_rt() should go right here in PREEMPT_RT patchset. */

 Decode into vertical and horizontal scanout position. */

 Valid vblank area boundaries from gpu retrieved? */

 Yes: Decode. */

 No: Fake something reasonable which gives at least ok results. */

 Called from driver internal vblank counter query code? */

 Caller wants distance from real vbl_start in *hpos */

	/* Fudge vblank to start a few scanlines earlier to handle the

	 * problem that vblank irqs fire a few scanlines before start

	 * of vblank. Some driver internal callers need the true vblank

	 * start to be used and signal this via the USE_REAL_VBLANKSTART flag.

	 *

	 * The cause of the "early" vblank irq is that the irq is triggered

	 * by the line buffer logic when the line buffer read position enters

	 * the vblank, whereas our crtc scanout position naturally lags the

	 * line buffer read position.

 Test scanout position against vblank region. */

 In vblank? */

 Called from driver internal vblank counter query code? */

 Caller wants distance from fudged earlier vbl_start */

	/* Check if inside vblank area and apply corrective offsets:

	 * vpos will then be >=0 in video scanout area, but negative

	 * within vblank area, counting down the number of lines until

	 * start of scanout.

 Inside "upper part" of vblank area? Apply corrective offset if so: */

 Correct for shifted end of vbl at vbl_end. */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 *          Christian König

/*

 * Rings

 * Most engines on the GPU are fed via ring buffers.  Ring

 * buffers are areas of GPU accessible memory that the host

 * writes commands into and the GPU reads commands out of.

 * There is a rptr (read pointer) that determines where the

 * GPU is currently reading, and a wptr (write pointer)

 * which determines where the host has written.  When the

 * pointers are equal, the ring is idle.  When the host

 * writes commands to the ring buffer, it increments the

 * wptr.  The GPU then starts fetching commands and executes

 * them until the pointers are equal again.

/**

 * radeon_ring_supports_scratch_reg - check if the ring supports

 * writing to scratch registers

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if a specific ring supports writing to scratch registers (all asics).

 * Returns true if the ring supports writing to scratch regs, false if not.

/**

 * radeon_ring_free_size - update the free size

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Update the free dw slots in the ring buffer (all asics).

 This works because ring_size is a power of 2 */

 this is an empty ring */

  update lockup info to avoid false positive */

/**

 * radeon_ring_alloc - allocate space on the ring buffer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 * @ndw: number of dwords to allocate in the ring buffer

 *

 * Allocate @ndw dwords in the ring buffer (all asics).

 * Returns 0 on success, error on failure.

 make sure we aren't trying to allocate more space than there is on the ring */

	/* Align requested size with padding so unlock_commit can

/**

 * radeon_ring_lock - lock the ring and allocate space on it

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 * @ndw: number of dwords to allocate in the ring buffer

 *

 * Lock the ring and allocate @ndw dwords in the ring buffer

 * (all asics).

 * Returns 0 on success, error on failure.

/**

 * radeon_ring_commit - tell the GPU to execute the new

 * commands on the ring buffer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 * @hdp_flush: Whether or not to perform an HDP cache flush

 *

 * Update the wptr (write pointer) to tell the GPU to

 * execute new commands on the ring buffer (all asics).

	/* If we are emitting the HDP flush via the ring buffer, we need to

	 * do it before padding.

 We pad to match fetch size */

	/* If we are emitting the HDP flush via MMIO, we need to do it after

	 * all CPU writes to VRAM finished.

/**

 * radeon_ring_unlock_commit - tell the GPU to execute the new

 * commands on the ring buffer and unlock it

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 * @hdp_flush: Whether or not to perform an HDP cache flush

 *

 * Call radeon_ring_commit() then unlock the ring (all asics).

/**

 * radeon_ring_undo - reset the wptr

 *

 * @ring: radeon_ring structure holding ring information

 *

 * Reset the driver's copy of the wptr (all asics).

/**

 * radeon_ring_unlock_undo - reset the wptr and unlock the ring

 *

 * @rdev:       radeon device structure

 * @ring: radeon_ring structure holding ring information

 *

 * Call radeon_ring_undo() then unlock the ring (all asics).

/**

 * radeon_ring_lockup_update - update lockup variables

 *

 * @rdev:       radeon device structure

 * @ring: radeon_ring structure holding ring information

 *

 * Update the last rptr value and timestamp (all asics).

/**

 * radeon_ring_test_lockup() - check if ring is lockedup by recording information

 * @rdev:       radeon device structure

 * @ring:       radeon_ring structure holding ring information

 *

 ring is still working, no lockup */

 give a chance to the GPU ... */

/**

 * radeon_ring_backup - Back up the content of a ring

 *

 * @rdev: radeon_device pointer

 * @ring: the ring we want to back up

 * @data: placeholder for returned commit data

 *

 * Saves all unprocessed commits from a ring, returns the number of dwords saved.

 just in case lock the ring */

 it doesn't make sense to save anything if all fences are signaled */

 calculate the number of dw on the ring */

 no way to read back the next rptr */

 and then save the content of the ring */

/**

 * radeon_ring_restore - append saved commands to the ring again

 *

 * @rdev: radeon_device pointer

 * @ring: ring to append commands to

 * @size: number of dwords we want to write

 * @data: saved commands

 *

 * Allocates space on the ring and restore the previously saved commands.

 restore the saved ring content */

/**

 * radeon_ring_init - init driver ring struct.

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 * @ring_size: size of the ring

 * @rptr_offs: offset of the rptr writeback location in the WB buffer

 * @nop: nop packet for this ring

 *

 * Initialize the driver information for the selected ring (all asics).

 * Returns 0 on success, error on failure.

 Allocate ring buffer */

/**

 * radeon_ring_fini - tear down the driver ring struct.

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Tear down the driver information for the selected ring (all asics).

/*

 * Debugfs info

	/* print 8 dw before current rptr as often it's the last executed

	 * packet that is the root issue

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 offset is from DISP(2)_BASE_ADDRESS */

 avivo cursor are offset into the total surface */

 fixed on DCE6 and newer */

		/*

		 * avivo cursor image can't end on 128 pixel boundary or

		 * go past the end of the frame if both crtcs are enabled

		 *

		 * NOTE: It is safe to access crtc->enabled of other crtcs

		 * without holding either the mode_config lock or the other

		 * crtc's lock as long as write access to this flag _always_

		 * grabs all locks.

 offset is from DISP(2)_BASE_ADDRESS */

 turn off cursor */

 Only 27 bit offset for legacy cursor */

/**

 * radeon_cursor_reset - Re-set the current cursor, if any.

 *

 * @crtc: drm crtc

 *

 * If the CRTC passed in currently has a cursor assigned, this function

 * makes sure it's visible.

/*

 * Copyright 2010 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/**

 * evergreen_dma_fence_ring_emit - emit a fence on the DMA ring

 *

 * @rdev: radeon_device pointer

 * @fence: radeon fence object

 *

 * Add a DMA fence packet to the ring to write

 * the fence seq number and DMA trap packet to generate

 * an interrupt if needed (evergreen-SI).

 write the fence */

 generate an interrupt */

 flush HDP */

/**

 * evergreen_dma_ring_ib_execute - schedule an IB on the DMA engine

 *

 * @rdev: radeon_device pointer

 * @ib: IB object to schedule

 *

 * Schedule an IB in the DMA ring (evergreen).

	/* The indirect buffer packet must end on an 8 DW boundary in the DMA ring.

	 * Pad as necessary with NOPs.

/**

 * evergreen_copy_dma - copy pages using the DMA engine

 *

 * @rdev: radeon_device pointer

 * @src_offset: src GPU address

 * @dst_offset: dst GPU address

 * @num_gpu_pages: number of GPU pages to xfer

 * @resv: reservation object with embedded fence

 *

 * Copy GPU paging using the DMA engine (evergreen-cayman).

 * Used by the radeon ttm implementation to move pages if

 * registered as the asic copy callback.

/**

 * evergreen_dma_is_lockup - Check if the DMA engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the async DMA engine is locked up.

 * Returns true if the engine appears to be locked up, false if not.

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 DIG routing gets problematic */

 LVDS/TV are too wacky */

 DVO requires 2x ppll clocks depending on tmds chip */

 dac a */

 dac b */

				/*if (rdev->family == CHIP_R200)

				  ret = ENCODER_INTERNAL_DVO1_ENUM_ID1;

 external dac */

 Quirks */

 Amilo Xi 2550 only works with acpi bl */

 Older PPC macs use on-GPU backlight controller */

 disable native backlight control on older asics */

 walk the list and link encoders to connectors */

	/* if we don't have an active device yet, just use one of

	 * the connectors tied to the encoder.

 HDMI 1.3 supports up to 340 Mhz over single link */

 HDMI 1.3 supports up to 340 Mhz over single link */

/*

 * Copyright 2010 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/*

 * Indirect registers accessor

 Firmware Names */

 reset the engine and set to writable */

 load mc io regs */

 load the MC ucode */

 put the engine back into the active state */

 wait for training to complete */

 pfp/me same size as CAYMAN */

 no MC ucode on TN */

/**

 * cayman_get_allowed_info_register - fetch the register for the info ioctl

 *

 * @rdev: radeon_device pointer

 * @reg: register offset in bytes

 * @val: register value

 *

 * Returns 0 for success or -EINVAL for an invalid register

 *

/*

 * Core functions

 Initialize HDP */

 XXX use MC settings? */

	/* setup tiling info dword.  gb_addr_config is not adequate since it does

	 * not have bank info, so create a custom tiling dword.

	 * bits 3:0   num_pipes

	 * bits 7:4   num_banks

	 * bits 11:8  group_size

	 * bits 15:12 row_size

 num banks is 8 on all fusion asics. 0 = 4, 1 = 8, 2 = 16 */

 four banks */

 eight banks */

 sixteen banks */

 enabled rb are just the one not disabled :) */

 if all the backends are disabled, fix it up here */

 RB1 disabled, RB0 enabled */

 RB0 disabled, RB1 enabled */

 reprogram the shader complex */

 set HW defaults for 3D engine */

 need to be explicitly zero-ed */

 set clockgating golden values on TN */

/*

 * GART

 flush hdp cache */

 bits 0-7 are the VM contexts0-7 */

 Setup TLB control */

 Setup L2 cache */

 setup context0 */

 empty context1-7 */

	/* Assign the pt base to something valid for now; the pts used for

	 * the VMs are determined by the application and setup and assigned

	 * on the fly in the vm part of radeon_gart.c

 enable context1-7 */

 Disable all tables */

 Setup TLB control */

 Setup L2 cache */

/*

 * CP.

 flush read cache over gart for this vmid */

 poll interval */

 EVENT_WRITE_EOP - flush caches, send int */

 set to DX10/11 mode */

 flush read cache over gart for this vmid */

 poll interval */

 setup clear context state */

 set clear context state */

 SQ_VTX_BASE_VTX_LOC */

 Clear consts */

 VGT_VERTEX_REUSE_BLOCK_CNTL */

  */

 XXX init other rings */

 Reset cp; if cp is reset, then PA, SH, VGT also need to be reset */

 Set the write pointer delay */

 set the wb address whether it's enabled or not */

 Set ring buffer size */

 set the wb address whether it's enabled or not */

 set the rb base addr, this causes an internal reset of ALL rings */

 Initialize the ring buffer's read and write pointers */

 start the rings */

 this only test cp0 */

 GRBM_STATUS */

 DMA_STATUS_REG 0 */

 DMA_STATUS_REG 1 */

 SRBM_STATUS2 */

 SRBM_STATUS */

 VM_L2_STATUS */

 Skip MC reset as it's mostly likely not hung, just busy */

 Disable CP parsing/prefetching */

 dma0 */

 dma1 */

 Wait a little for things to settle down */

/**

 * cayman_gfx_is_lockup - Check if the GFX engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the GFX engine is locked up.

 * Returns true if the engine appears to be locked up, false if not.

		/*

		 * At this point rdev->uvd.vcpu_bo is NULL which trickles down

		 * to early fails uvd_v2_2_resume() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable uvd here.

 Only set for CHIP_ARUBA */

		/*

		 * At this point rdev->vce.vcpu_bo is NULL which trickles down

		 * to early fails cayman_vce_start() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable vce here.

 enable pcie gen2 link */

 enable aspm */

 scratch needs to be initialized before MC */

 allocate rlc buffers */

 allocate wb buffer */

 Enable IRQ */

	/* Do not reset GPU before posting, on rv770 hw unlike on r500 hw,

	 * posting will perform necessary task to bring back GPU into good

	 * shape.

 post card */

 init golden registers */

/* Plan is to move initialization in that function and use

 * helper function so that radeon_device_init pretty much

 * do nothing more than calling asic specific function. This

 * should also allow to remove a bunch of callback function

 * like vram_info.

 Read BIOS */

 Must be an ATOMBIOS */

 Post card if necessary */

 init golden registers */

 Initialize scratch registers */

 Initialize surface registers */

 Initialize clocks */

 Fence driver */

 initialize memory controller */

 Memory manager */

 Initialize power management */

	/* Don't start up if the MC ucode is missing.

	 * The default clocks and voltages before the MC ucode

	 * is loaded are not suffient for advanced operations.

	 *

	 * We can skip this check for TN, because there is no MC

	 * ucode.

/*

 * vm

 number of VMs */

 base offset of vram pages */

/**

 * cayman_vm_decode_fault - print human readable fault info

 *

 * @rdev: radeon_device pointer

 * @status: VM_CONTEXT1_PROTECTION_FAULT_STATUS register value

 * @addr: VM_CONTEXT1_PROTECTION_FAULT_ADDR register value

 *

 * Print human readable fault information (cayman/TN).

/*

 * cayman_vm_flush - vm flush using the CP

 *

 * Update the page table base and flush the VM TLB

 * using the CP (cayman-si).

 flush hdp cache */

 bits 0-7 are the VM contexts0-7 */

 wait for the invalidate to complete */

 always */

 me */

 ref */

 mask */

 poll interval */

 sync PFP to ME, otherwise we might get invalid PFP reads */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 Firmware Names */

 r600,rv610,rv630,rv620,rv635,rv670 */

/*

 * Indirect registers accessor

/**

 * r600_get_allowed_info_register - fetch the register for the info ioctl

 *

 * @rdev: radeon_device pointer

 * @reg: register offset in bytes

 * @val: register value

 *

 * Returns 0 for success or -EINVAL for an invalid register

 *

/**

 * r600_get_xclk - get the xclk

 *

 * @rdev: radeon_device pointer

 *

 * Returns the reference clock used by the gfx engine

 * (r6xx, IGPs, APUs).

 bypass vclk and dclk with bclk */

 assert BYPASS_EN, deassert UPLL_RESET, UPLL_SLEEP and UPLL_CTLREQ */

 keep the Bypass mode, put PLL to sleep */

 assert PLL_RESET */

 For RS780 we have to choose ref clk */

 set the required fb, ref and post divder values */

 give the PLL some time to settle */

 deassert PLL_RESET */

 deassert BYPASS EN */

 switch VCLK and DCLK selection */

 LVDS FMT is set up by atom */

 not needed for analog */

 XXX sort out optimal dither settings */

 XXX sort out optimal dither settings */

 not needed */

 get temperature in millidegrees */

 power state array is low to high, default is first */

 don't use the power state if crtcs are active and no display flag is set */

 XXX select a power state based on AC/DC, single/dualhead, etc. */

 for now just select the first power state and switch between clock modes */

 power state array is low to high, default is first (0) */

 start at 1 as we don't want the default mode */

 if nothing selected, grab the default state. */

 don't use the power state if crtcs are active and no display flag is set */

 default */

 low sh */

 mid sh */

 high sh */

 low mh */

 mid mh */

 high mh */

 default */

 low sh */

 mid sh */

 high sh */

 low mh */

 mid mh */

 high mh */

 default */

 low sh */

 mid sh */

 high sh */

 low mh */

 mid mh */

 high mh */

 XXX */

 default */

 low sh */

 mid sh */

 high sh */

 low mh */

 mid mh */

 high mh */

 default */

 low sh */

 mid sh */

 high sh */

 low mh */

 low mh */

 high mh */

 default */

 low sh */

 mid sh */

 high sh */

 low mh */

 mid mh */

 high mh */

 0xff01 is a flag rather then an actual voltage */

 hpd for digital panel detect/disconnect */

 DCE 3.2 */

 DCE 3.2 */

			/* don't try to enable hpd on eDP or LVDS avoid breaking the

			 * aux dp channel on imac and help (but not completely fix)

			 * https://bugzilla.redhat.com/show_bug.cgi?id=726143

 DCE 3.2 */

 DCE 3.2 */

/*

 * R600 PCIE GART

 flush hdp cache so updates hit vram */

		/* r7xx hw bug.  write to HDP_DEBUG1 followed by fb read

		 * rather than write to HDP_REG_COHERENCY_FLUSH_CNTL

		 * This seems to cause problems on some AGP cards. Just use the old

		 * method for them.

 read MC_STATUS */

 Initialize common gart structure */

 Setup L2 cache */

 Setup TLB control */

 Disable all tables */

 Disable L2 cache */

 Setup L1 TLB control */

 Setup L2 cache */

 Setup TLB control */

 read MC_STATUS */

 Initialize HDP */

 Lockout access through VGA aperture (doesn't exist before R600) */

 Update configuration */

 VRAM before AGP */

 VRAM after AGP */

	/* we need to own VRAM, so turn off the VGA renderer here

/**

 * r600_vram_gtt_location - try to find VRAM & GTT location

 * @rdev: radeon device structure holding all necessary informations

 * @mc: memory controller structure holding memory informations

 *

 * Function will place try to place VRAM at same place as in CPU (PCI)

 * address space as some GPU seems to have issue when we reprogram at

 * different address space.

 *

 * If there is not enough space to fit the unvisible VRAM after the

 * aperture then we limit the VRAM size to the aperture.

 *

 * If we are using AGP then place VRAM adjacent to AGP aperture are we need

 * them to be in one from GPU point of view so that we can program GPU to

 * catch access outside them (weird GPU policy see ??).

 *

 * This function will never fails, worst case are limiting VRAM or GTT.

 *

 * Note: GTT start, end, size should be initialized before calling this

 * function on AGP platform.

 leave room for at least 512M GTT */

 Get VRAM informations */

 Could aper size report 0 ? */

 Setup GPU memory space */

 Use K8 direct mapping for fast fb access. */

				/* FastFB shall be used with UMA memory. Here it is simply disabled when sideport

		 		* memory is present.

 GRBM_STATUS */

 DMA_STATUS_REG */

 SRBM_STATUS */

 Skip MC reset as it's mostly likely not hung, just busy */

 Disable CP parsing/prefetching */

 disable the RLC */

 Disable DMA */

 Wait a little for things to settle down */

 disable dpm? */

 Disable CP parsing/prefetching */

 disable the RLC */

 Disable DMA */

 set mclk/sclk to bypass */

 disable BM */

 disable mem access */

 BIF reset workaround.  Not sure if this is needed on 6xx */

 reset */

 BIF reset workaround.  Not sure if this is needed on 6xx */

 wait for asic to come out of reset */

 try soft reset */

 try pci config reset */

/**

 * r600_gfx_is_lockup - Check if the GFX engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the GFX engine is locked up.

 * Returns true if the engine appears to be locked up, false if not.

 mask out the RBs that don't exist on that asic */

 make sure at least one RB is available */

 r6xx/r7xx */

 eg+ */

 Initialize HDP */

 Setup tiling */

 if all the backends are disabled, fix it up here */

 Setup some CP states */

 Setup various GPU states */

	/* SQ_CONFIG, SQ_GPR_RESOURCE_MGMT, SQ_THREAD_RESOURCE_MGMT, SQ_STACK_RESOURCE_MGMT

	 * should be adjusted as needed by the 2D/3D drivers.  This just sets default values

 no vertex cache */

 More default values. 2D/3D driver should adjust as needed */

 more default values. 2D/3D driver should adjust as needed */

 Clear render buffer base addresses */

/*

 * Indirect registers accessor

/*

 * CP & Ring

 Reset cp */

 Reset cp */

 Set ring buffer size */

 Set the write pointer delay */

 Initialize the ring buffer's read and write pointers */

 set the wb address whether it's enabled or not */

 Align ring size */

/*

 * GPU scratch registers helpers function.

/*

 * CP fences/semaphores

 flush read cache over gart */

 poll interval */

 EVENT_WRITE_EOP - flush caches, send int */

 flush read cache over gart */

 poll interval */

 wait for 3D idle clean */

 Emit fence sequence & fire IRQ */

 CP_INTERRUPT packet 3 no longer exists, use packet 0 */

/**

 * r600_semaphore_ring_emit - emit a semaphore on the CP ring

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring buffer object

 * @semaphore: radeon semaphore object

 * @emit_wait: Is this a sempahore wait?

 *

 * Emits a semaphore signal/wait packet to the CP ring and prevents the PFP

 * from running ahead of semaphore waits.

 PFP_SYNC_ME packet only exists on 7xx+, only enable it on eg+ */

 Prevent the PFP from running ahead of the semaphore wait */

/**

 * r600_copy_cpdma - copy pages using the CP DMA engine

 *

 * @rdev: radeon_device pointer

 * @src_offset: src GPU address

 * @dst_offset: dst GPU address

 * @num_gpu_pages: number of GPU pages to xfer

 * @resv: DMA reservation object to manage fences

 *

 * Copy GPU paging using the CP DMA engine (r6xx+).

 * Used by the radeon ttm implementation to move pages if

 * registered as the asic copy callback.

 FIXME: implement */

 FIXME: implement */

		/*

		 * At this point rdev->uvd.vcpu_bo is NULL which trickles down

		 * to early fails uvd_v1_0_resume() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable uvd here.

 enable pcie gen2 link */

 scratch needs to be initialized before MC */

 allocate wb buffer */

 Enable IRQ */

	/* Do not reset GPU before posting, on r600 hw unlike on r500 hw,

	 * posting will perform necessary task to bring back GPU into good

	 * shape.

 post card */

/* Plan is to move initialization in that function and use

 * helper function so that radeon_device_init pretty much

 * do nothing more than calling asic specific function. This

 * should also allow to remove a bunch of callback function

 * like vram_info.

 Read BIOS */

 Must be an ATOMBIOS */

 Post card if necessary */

 Initialize scratch registers */

 Initialize surface registers */

 Initialize clocks */

 Fence driver */

 Memory manager */

 Initialize power management */

/*

 * CS stuff

/*

 * Interrupts

 *

 * Interrupts use a ring buffer on r6xx/r7xx hardware.  It works pretty

 * the same as the CP ring buffer, but in reverse.  Rather than the CPU

 * writing to the ring and the GPU consuming, the GPU writes to the ring

 * and host consumes.  As the host irq handler processes interrupts, it

 * increments the rptr.  When the rptr catches up with the wptr, all the

 * current interrupts have been processed.

 Align ring size */

 Allocate ring buffer */

 r7xx asics need to soft reset RLC before halting */

 set rptr, wptr to 0 */

 allocate ring */

 disable irqs */

 init rlc */

 setup interrupt control */

 set dummy read address to dummy page address */

	/* IH_DUMMY_RD_OVERRIDE=0 - dummy read disabled with msi, enabled without msi

	 * IH_DUMMY_RD_OVERRIDE=1 - dummy read controlled by IH_DUMMY_RD_EN

 IH_REQ_NONSNOOP_EN=1 if ring is in non-cacheable memory, e.g., vram */

 set the writeback address whether it's enabled or not */

 set rptr, wptr to 0 */

 Default settings for IH_CNTL (disabled at first) */

 RPTR_REARM only works if msi's are enabled */

 force the active interrupt state to all disabled */

 at this point everything should be setup correctly to enable master */

 enable irqs */

 don't enable anything if the ih is disabled */

 force the active interrupt state to all disabled */

 posting read */

 Wait and acknowledge irq */

		/* When a ring buffer overflow happen start parsing interrupt

		 * from the last not overwritten vector (wptr + 16). Hopefully

		 * this should allow us to catchup.

/*        r600 IV Ring

 * Each IV ring entry is 128 bits:

 * [7:0]    - interrupt source id

 * [31:8]   - reserved

 * [59:32]  - interrupt source data

 * [127:60]  - reserved

 *

 * The basic interrupt vector entries

 * are decoded as follows:

 * src_id  src_data  description

 *      1         0  D1 Vblank

 *      1         1  D1 Vline

 *      5         0  D2 Vblank

 *      5         1  D2 Vline

 *     19         0  FP Hot plug detection A

 *     19         1  FP Hot plug detection B

 *     19         2  DAC A auto-detection

 *     19         3  DAC B auto-detection

 *     21         4  HDMI block A

 *     21         5  HDMI block B

 *    176         -  CP_INT RB

 *    177         -  CP_INT IB1

 *    178         -  CP_INT IB2

 *    181         -  EOP Interrupt

 *    233         -  GUI Idle

 *

 * Note, these are based on r600 and may need to be

 * adjusted or added to on newer asics

 No MSIs, need a dummy read to flush PCI DMAs */

 is somebody else already processing irqs? */

 Order reading of wptr vs. reading of IH ring data */

 display interrupts */

 wptr/rptr are in bytes! */

 D1 vblank/vline */

 D1 vblank */

 D1 vline */

 D2 vblank/vline */

 D2 vblank */

 D1 vline */

 D1 pflip */

 D2 pflip */

 HPD/DAC hotplug */

 hdmi */

 UVD */

 CP_INT in ring buffer */

 CP_INT in IB1 */

 CP_INT in IB2 */

 CP EOP event */

 DMA trap event */

 thermal low to high */

 thermal high to low */

 GUI IDLE */

 wptr/rptr are in bytes! */

 make sure wptr hasn't changed while processing */

/*

 * Debugfs info

/**

 * r600_mmio_hdp_flush - flush Host Data Path cache via MMIO

 * @rdev: radeon device structure

 *

 * Some R6XX/R7XX don't seem to take into account HDP flushes performed

 * through the ring buffer. This leads to corruption in rendering, see

 * http://bugzilla.kernel.org/show_bug.cgi?id=15186 . To avoid this, we

 * directly perform the HDP flush by writing the register through MMIO.

	/* r7xx hw bug.  write to HDP_DEBUG1 followed by fb read

	 * rather than write to HDP_REG_COHERENCY_FLUSH_CNTL.

	 * This seems to cause problems on some AGP cards. Just use the old

	 * method for them.

 x2 cards have a special sequence */

 not actually supported */

 x2 cards have a special sequence */

 not actually supported */

 x2 cards have a special sequence */

 only RV6xx+ chips are supported */

 55 nm r6xx asics */

 advertise upconfig capability */

 55 nm r6xx asics */

 not supported yet */

 XXX: only disable it if gen1 bridge vendor == 0x111d or 0x1106 */

/**

 * r600_get_gpu_clock_counter - return GPU clock counter snapshot

 *

 * @rdev: radeon_device pointer

 *

 * Fetches a GPU clock counter snapshot (R6xx-cayman).

 * Returns the 64 bit clock counter snapshot.

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 Firmware Names */

/* This files gather functions specifics to:

 * r100,rv100,rs100,rv200,rs200,r200,rv250,rs300,rv280

 * and others in some cases.

/**

 * r100_wait_for_vblank - vblank wait asic callback.

 *

 * @rdev: radeon_device pointer

 * @crtc: crtc to wait for vblank on

 *

 * Wait for vblank on the requested crtc (r1xx-r4xx).

	/* depending on when we hit vblank, we may be close to active; if so,

	 * wait for another frame.

/**

 * r100_page_flip - pageflip callback.

 *

 * @rdev: radeon_device pointer

 * @crtc_id: crtc to cleanup pageflip on

 * @crtc_base: new address of the crtc (GPU MC address)

 * @async: asynchronous flip

 *

 * Does the actual pageflip (r1xx-r4xx).

 * During vblank we take the crtc lock and wait for the update_pending

 * bit to go high, when it does, we release the lock, and allow the

 * double buffered update to take place.

 Lock the graphics update lock */

 update the scanout addresses */

 update pitch */

 Wait for update_pending to go high. */

 Unlock the lock, so double-buffering can take place inside vblank */

/**

 * r100_page_flip_pending - check if page flip is still pending

 *

 * @rdev: radeon_device pointer

 * @crtc_id: crtc to check

 *

 * Check if the last pagefilp is still pending (r1xx-r4xx).

 * Returns the current update pending status.

 Return current update_pending status: */

/**

 * r100_pm_get_dynpm_state - look up dynpm power state callback.

 *

 * @rdev: radeon_device pointer

 *

 * Look up the optimal power state based on the

 * current state of the GPU (r1xx-r5xx).

 * Used for dynpm only.

 don't use the power state if crtcs are active and no display flag is set */

 only one clock mode per power state */

/**

 * r100_pm_init_profile - Initialize power profiles callback.

 *

 * @rdev: radeon_device pointer

 *

 * Initialize the power states used in profile mode

 * (r1xx-r3xx).

 * Used for profile mode only.

 default */

 low sh */

 mid sh */

 high sh */

 low mh */

 mid mh */

 high mh */

/**

 * r100_pm_misc - set additional pm hw parameters callback.

 *

 * @rdev: radeon_device pointer

 *

 * Set non-clock parameters associated with a power state

 * (voltage, pcie lanes, etc.) (r1xx-r4xx).

 set pcie lanes */

/**

 * r100_pm_prepare - pre-power state change callback.

 *

 * @rdev: radeon_device pointer

 *

 * Prepare for a power state change (r1xx-r4xx).

 disable any active CRTCs */

/**

 * r100_pm_finish - post-power state change callback.

 *

 * @rdev: radeon_device pointer

 *

 * Clean up after a power state change (r1xx-r4xx).

 enable any active CRTCs */

/**

 * r100_gui_idle - gui idle callback.

 *

 * @rdev: radeon_device pointer

 *

 * Check of the GUI (2D/3D engines) are idle (r1xx-r5xx).

 * Returns true if idle, false if not.

 hpd for digital panel detect/disconnect */

/**

 * r100_hpd_sense - hpd sense callback.

 *

 * @rdev: radeon_device pointer

 * @hpd: hpd (hotplug detect) pin

 *

 * Checks if a digital monitor is connected (r1xx-r4xx).

 * Returns true if connected, false if not connected.

/**

 * r100_hpd_set_polarity - hpd set polarity callback.

 *

 * @rdev: radeon_device pointer

 * @hpd: hpd (hotplug detect) pin

 *

 * Set the polarity of the hpd pin (r1xx-r4xx).

/**

 * r100_hpd_init - hpd setup callback.

 *

 * @rdev: radeon_device pointer

 *

 * Setup the hpd pins used by the card (r1xx-r4xx).

 * Set the polarity, and enable the hpd interrupts.

/**

 * r100_hpd_fini - hpd tear down callback.

 *

 * @rdev: radeon_device pointer

 *

 * Tear down the hpd pins used by the card (r1xx-r4xx).

 * Disable the hpd interrupts.

/*

 * PCI GART

 TODO: can we do somethings here ? */

	/* It seems hw only cache one entry so we should discard this

	 * entry otherwise if first GPU GART read hit this entry it

 Initialize common gart structure */

 discard memory request outside of configured range */

 set address range for PCI address translate */

 set PCI GART page-table base address */

 discard memory request outside of configured range */

 read back to post the write */

 Wait and acknowledge irq */

 SW interrupt */

 Vertical blank interrupts */

/**

 * r100_ring_hdp_flush - flush Host Data Path via the ring buffer

 * @rdev: radeon device structure

 * @ring: ring buffer struct for emitting packets

/* Who ever call radeon_fence_emit should call ring_lock and ask

	/* We have to make sure that caches are flushed before

 Wait until IDLE & CLEAN */

 Emit fence sequence & fire IRQ */

 Unused on older asics, since we don't have semaphores or multiple rings */

 radeon limited to 16k stride */

 radeon pitch is /64 */

 Ask for enough room for blit + flush + fence */

		/* pages are in Y direction - height

 Load the microcode for the CP */

 Align ring size */

	/* Each time the cp read 1024 bytes (16 dword/quadword) update

 cp will read 128bytes at a time (4 dwords) */

 Write to CP_RB_WPTR will be delayed for pre_write_timer clocks */

	/* Force CP_RB_WPTR write if written more than one time before the

	 * delay expire

	/* Setup the cp cache like this (cache size is 96 dwords) :

	 *	RING		0  to 15

	 *	INDIRECT1	16 to 79

	 *	INDIRECT2	80 to 95

	 * So ring cache size is 16dwords (> (2 * max_fetch = 2 * 4dwords))

	 *    indirect1 cache size is 64dwords (> (2 * max_fetch = 2 * 4dwords))

	 *    indirect2 cache size is 16dwords (> (2 * max_fetch = 2 * 4dwords))

	 * Idea being that most of the gpu cmd will be through indirect1 buffer

	 * so it gets the bigger cache.

 cp setup */

 Set ring address */

 Force read & write ptr to 0 */

 set the wb address whether it's enabled or not */

 Set cp mode to bus mastering & enable cp*/

 at this point everything should be setup correctly to enable master */

 not resuming from suspend */

 Disable ring */

 Disable ring */

/*

 * CS functions

	/* Check that register fall into register range

	 * determined by the number of entry (n) in the

	 * safe register bitmap.

/**

 * r100_cs_packet_parse_vline() - parse userspace VLINE packet

 * @p:		parser structure holding parsing context.

 *

 * Userspace sends a special sequence for VLINE waits.

 * PACKET0 - VLINE_START_END + value

 * PACKET0 - WAIT_UNTIL +_value

 * RELOC (P3) - crtc_id in reloc.

 *

 * This function parses this and relocates the VLINE START END

 * and WAIT UNTIL packets to the correct crtc.

 * It also detects a switched off crtc and nulls out the

 * wait in that case.

 parse the wait until */

 check its a wait until and only 1 count */

 jump over the NOP */

 if the CRTC isn't enabled - we need to nop out the wait until */

 ordered according to bits in spec */

 blend weight */

		/* FIXME: only allow PACKET3 blit? easier to check for out of

 3D_RNDR_GEN_INDX_PRIM on r100/r200 */

 triggers drawing using in-packet vertex data */

 triggers drawing using in-packet vertex data */

 triggers drawing of vertex buffers setup elsewhere */

 triggers drawing using indices to vertex buffer */

 triggers drawing of vertex buffers setup elsewhere */

 triggers drawing using indices to vertex buffer */

 compressed textures are block based */

 I believe the format comes from colorbuffer0. */

 CS IB emission code makes sure texture unit are disabled */

/*

 * Global GPU functions

 read MC_STATUS */

 required on r1xx, r2xx, r300, r(v)350, r420/r481, rs400/rs480 */

 Enable bus mastering */

 disable bus mastering */

 stop CP */

 save PCI state */

 disable bus mastering */

 reset CP */

 restore PCI & busmastering */

 Check if GPU is idle */

 set these so they don't interfere with anything */

	/* always set up dac2 on rn50 and some rv100 as lots

	 * of servers seem to wire it up to a VGA port but

	 * don't report it in the bios connector

	 * table.

 RN50 */

 RV100*/

 DELL triple head servers */

 DELL */) &&

		/* For CRT on DAC2, don't turn it on if BIOS didn't

		   enable it, even it's detected.

 force it to crtc0 */

 set up the TV DAC */

 switch PM block to ACPI mode */

/*

 * VRAM info

 newer IGPs */

	/* Set HDP_APER_CNTL only on cards that are known not to be broken,

	 * that is has the 2nd generation multifunction PCI interface

	/* Older cards have all sorts of funny issues to deal with. First

	 * check if it's a multifunction card by reading the PCI config

	 * header type... Limit those to one aperture size

	/* Single function older card. We read HDP_APER_CNTL to see how the BIOS

	 * have set it up. We don't write this as it's broken on some ASICs but

	 * we expect the BIOS to have done the right thing (might be too optimistic...)

 work out accessible VRAM */

 FIXME we don't use the second aperture yet when we could use it */

 read NB_TOM to get the amount of ram stolen for the GPU */

		/* Some production boards of m6 will report 0

		 * if it's 8 MB

		/* Fix for RN50, M6, M7 with 8/16/32(??) MBs of VRAM -

		 * Novell bug 204882 + along with lots of ubuntu ones

/*

 * Indirect registers accessor

	/* This workarounds is necessary on RV100, RS100 and RS200 chips

	 * or the chip could hang on a subsequent access

	/* This function is required to workaround a hardware bug in some (all?)

	 * revisions of the R300.  This workaround should be called after every

	 * CLOCK_CNTL_INDEX register access.  If not, register reads afterward

	 * may not be correct.

/*

 * Debugfs info

	/* FIXME: 0, 128, 640 depends on fifo setup see cp_init_kms

 setting pitch to 0 disables tiling */

 r100/r200 divide by 16 */

 in octawords */

 	uint32_t read_return_rate, time_disp1_drop_priority; */

 Guess line buffer size to be 8192 pixels */

 get modes */

 check crtc enables */

	/*

	 * determine is there is enough bw for current mode

 convert to fixed point */

 convert to fixed point */

  Get values from the EXT_MEM_CNTL register...converting its contents. */

 RV100, M6, IGPs */

 r300, r350 */

 rv3x0 */

 r4xx */

 RV200, R200 */

 convert to FF */

 Get values from the MEM_SDRAM_MODE_REG register...converting its */

 don't think rs400 */

 extra cas latency stored in bits 23-25 0-4 clocks */

		/* on the R300, Tcas is included in Trbs.

 TODO PCIE lanes may affect this - agpmode == 16?? */

	/*

	  HW cursor time assuming worst case of full size colour cursor.

	/*

	  Find the total latency for the display data.

 setup Max GRPH_STOP_REQ default value */

		/*  CRTC1

		    Set GRPH_BUFFER_CNTL register using h/w defined optimal values.

		    GRPH_STOP_REQ <= MIN[ 0x7C, (CRTC_H_DISP + 1) * (bit depth) / 0x10 ]

		/*

		  Find the drain rate of the display buffer.

		/*

		  Find the critical point of the display buffer.

		/*

		  The critical point should never be above max_stop_req-4.  Setting

		  GRPH_CRITICAL_CNTL = 0 will thus force high priority all the time.

 some R300 cards have problem with this set to 0, when CRTC2 is enabled.*/

		/*

		  Write the result into the register.

 attempt to program RS400 disp regs correctly ??? */

 	  (unsigned int)info->SavedReg->grph_buffer_cntl, */

		/*

		  Find the drain rate of the display buffer.

 some R300 cards have problem with this set to 0 */

 attempt to program RS400 disp2 regs correctly ??? */

 Save number of lines the linebuffer leads before the scanout */

	/* Shutdown CP we shouldn't need to do that but better be safe than

	 * sorry

 Save few CRTC registers */

 Disable VGA aperture access */

 Disable cursor, overlay, crtc */

 Update base address for crtc */

 Restore CRTC registers */

 Stops all mc clients */

 Wait for mc idle */

 Program MC, should be a 32bits limited address space */

 We need to force on some of the block */

 set common regs */

 program mc */

 Resume clock */

	/* Initialize GART (initialize after TTM so we can allocate

 allocate wb buffer */

 Enable IRQ */

 1M ring buffer */

 Make sur GART are not working */

 Resume clock before doing reset */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 post */

 Resume clock after posting */

 Initialize surface registers */

/*

 * Due to how kexec works, it can leave the hw fully initialised when it

 * boots the new kernel. However doing our init sequence with the CP and

 * WB stuff setup causes GPU hangs on the RN50 at least. So at startup

 * do some quick sanity checks and restore sane values to avoid this

 * problem.

 Register debugfs file specific to this group of asics */

 Disable VGA */

 Initialize scratch registers */

 Initialize surface registers */

 sanity check some register to avoid hangs like after kexec */

 TODO: disable VGA need to use VGA request */

 BIOS*/

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Set asic errata */

 Initialize clocks */

 initialize AGP */

 initialize VRAM */

 Fence driver */

 Memory manager */

 Initialize power management */

 Somethings want wront with the accel init stop accel */

/*

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Jerome Glisse

 simple test, VRAM to GTT and GTT to VRAM */

 simple test, VRAM to VRAM */

 GTT to VRAM, buffer size sweep, powers of 2 */

 VRAM to GTT, buffer size sweep, powers of 2 */

 VRAM to VRAM, buffer size sweep, powers of 2 */

 GTT to VRAM, buffer size sweep, common modes */

 VRAM to GTT, buffer size sweep, common modes */

 VRAM to VRAM, buffer size sweep, common modes */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 *          Christian König

/*

 * IB

 * IBs (Indirect Buffers) and areas of GPU accessible memory where

 * commands are stored.  You can put a pointer to the IB in the

 * command ring and the hw will fetch the commands from the IB

 * and execute them.  Generally userspace acceleration drivers

 * produce command buffers which are send to the kernel and

 * put in IBs for execution by the requested ring.

/**

 * radeon_ib_get - request an IB (Indirect Buffer)

 *

 * @rdev: radeon_device pointer

 * @ring: ring index the IB is associated with

 * @vm: requested vm

 * @ib: IB object returned

 * @size: requested IB size

 *

 * Request an IB (all asics).  IBs are allocated using the

 * suballocator.

 * Returns 0 on success, error on failure.

		/* ib pool is bound at RADEON_VA_IB_OFFSET in virtual address

		 * space and soffset is the offset inside the pool bo

/**

 * radeon_ib_free - free an IB (Indirect Buffer)

 *

 * @rdev: radeon_device pointer

 * @ib: IB object to free

 *

 * Free an IB (all asics).

/**

 * radeon_ib_schedule - schedule an IB (Indirect Buffer) on the ring

 *

 * @rdev: radeon_device pointer

 * @ib: IB object to schedule

 * @const_ib: Const IB to schedule (SI only)

 * @hdp_flush: Whether or not to perform an HDP cache flush

 *

 * Schedule an IB on the associated ring (all asics).

 * Returns 0 on success, error on failure.

 *

 * On SI, there are two parallel engines fed from the primary ring,

 * the CE (Constant Engine) and the DE (Drawing Engine).  Since

 * resource descriptors have moved to memory, the CE allows you to

 * prime the caches while the DE is updating register state so that

 * the resource descriptors will be already in cache when the draw is

 * processed.  To accomplish this, the userspace driver submits two

 * IBs, one for the CE and one for the DE.  If there is a CE IB (called

 * a CONST_IB), it will be put on the ring prior to the DE IB.  Prior

 * to SI there was just a DE IB.

 TODO: Nothings in the ib we should report. */

 64 dwords should be enough for fence too */

 grab a vm id if necessary */

 sync with other rings */

/**

 * radeon_ib_pool_init - Init the IB (Indirect Buffer) pool

 *

 * @rdev: radeon_device pointer

 *

 * Initialize the suballocator to manage a pool of memory

 * for use as IBs (all asics).

 * Returns 0 on success, error on failure.

		/* Before CIK, it's better to stick to cacheable GTT due

		 * to the command stream checking

/**

 * radeon_ib_pool_fini - Free the IB (Indirect Buffer) pool

 *

 * @rdev: radeon_device pointer

 *

 * Tear down the suballocator managing the pool of memory

 * for use as IBs (all asics).

/**

 * radeon_ib_ring_tests - test IBs on the rings

 *

 * @rdev: radeon_device pointer

 *

 * Test an IB (Indirect Buffer) on each ring.

 * If the test fails, disable the ring.

 * Returns 0 on success, error if the primary GFX ring

 * IB test fails.

 oh, oh, that's really bad */

 still not good, but we can live with it */

/*

 * Debugfs info

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

/**

 * radeon_driver_unload_kms - Main unload function for KMS.

 *

 * @dev: drm dev pointer

 *

 * This is the main unload function for KMS (all asics).

 * It calls radeon_modeset_fini() to tear down the

 * displays, and radeon_device_fini() to tear down

 * the rest of the device (CP, writeback, etc.).

 * Returns 0 on success.

/**

 * radeon_driver_load_kms - Main load function for KMS.

 *

 * @dev: drm dev pointer

 * @flags: device flags

 *

 * This is the main load function for KMS (all asics).

 * It calls radeon_device_init() to set up the non-display

 * parts of the chip (asic init, CP, writeback, etc.), and

 * radeon_modeset_init() to set up the display parts

 * (crtcs, encoders, hotplug detect, etc.).

 * Returns 0 on success, error on failure.

 update BUS flag */

	/* radeon_device_init should report only fatal error

	 * like memory allocation failure or iomapping failure,

	 * or memory manager initialization failure, it must

	 * properly initialize the GPU MC controller and permit

	 * VRAM allocation

	/* Again modeset_init should fail only on fatal error

	 * otherwise it should provide enough functionalities

	 * for shadowfb to run

	/* Call ACPI methods: require modeset init

	 * but failure is not fatal

/**

 * radeon_set_filp_rights - Set filp right.

 *

 * @dev: drm dev pointer

 * @owner: drm file

 * @applier: drm file

 * @value: value

 *

 * Sets the filp rights for the device (all asics).

 wants rights */

 revokes rights */

/*

 * Userspace get information ioctl

/**

 * radeon_info_ioctl - answer a device specific request.

 *

 * @dev: drm device pointer

 * @data: request object

 * @filp: drm filp

 *

 * This function is used to pass device specific parameters to the userspace

 * drivers.  Examples include: pci device id, pipeline parms, tiling params,

 * etc. (all asics).

 * Returns 0 on success, -EINVAL on failure.

 xf86-video-ati 6.13.0 relies on this being false for evergreen */

		/* The "value" here is both an input and output parameter.

		 * If the input value is 1, filp requests hyper-z access.

		 * If the input value is 0, filp revokes its hyper-z access.

		 *

		 * When returning, the value is 1 if filp owns hyper-z access,

 The same logic as Hyper-Z. */

 return clock value in KHz */

 this is where we report if vm is supported or not */

 this is where we report if vm is supported or not */

 get temperature in millidegrees C */

 get sclk in Mhz */

 get mclk in Mhz */

/*

 * Outdated mess for old drm with Xorg being in charge (void function now).

/**

 * radeon_driver_lastclose_kms - drm callback for last close

 *

 * @dev: drm dev pointer

 *

 * Switch vga_switcheroo state after last close (all asics).

/**

 * radeon_driver_open_kms - drm callback for open

 *

 * @dev: drm dev pointer

 * @file_priv: drm file

 *

 * On device open, init vm on cayman+ (all asics).

 * Returns 0 on success, error on failure.

 new gpu have virtual address space support */

			/* map the ib pool buffer read only into

/**

 * radeon_driver_postclose_kms - drm callback for post close

 *

 * @dev: drm dev pointer

 * @file_priv: drm file

 *

 * On device close, tear down hyperz and cmask filps on r1xx-r5xx

 * (all asics).  And tear down vm on cayman+ (all asics).

 new gpu have virtual address space support */

/*

 * VBlank related functions.

/**

 * radeon_get_vblank_counter_kms - get frame count

 *

 * @crtc: crtc to get the frame count from

 *

 * Gets the frame count on the requested crtc (all asics).

 * Returns frame count on success, -EINVAL on failure.

	/* The hw increments its frame counter at start of vsync, not at start

	 * of vblank, as is required by DRM core vblank counter handling.

	 * Cook the hw count here to make it appear to the caller as if it

	 * incremented at start of vblank. We measure distance to start of

	 * vblank in vpos. vpos therefore will be >= 0 between start of vblank

	 * and start of vsync, so vpos >= 0 means to bump the hw frame counter

	 * result by 1 to give the proper appearance to caller.

		/* Repeat readout if needed to provide stable result if

		 * we cross start of vsync during the queries.

			/* Ask radeon_get_crtc_scanoutpos to return vpos as

			 * distance to start of vblank, instead of regular

			 * vertical scanout pos.

			/* Bump counter if we are at >= leading edge of vblank,

			 * but before vsync where vpos would turn negative and

			 * the hw counter really increments.

 Fallback to use value as is. */

/**

 * radeon_enable_vblank_kms - enable vblank interrupt

 *

 * @crtc: crtc to enable vblank interrupt for

 *

 * Enable the interrupt on the requested crtc (all asics).

 * Returns 0 on success, -EINVAL on failure.

/**

 * radeon_disable_vblank_kms - disable vblank interrupt

 *

 * @crtc: crtc to disable vblank interrupt for

 *

 * Disable the interrupt on the requested crtc (all asics).

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

/*

 * radeon_driver_irq_handler_kms - irq handler for KMS

 *

 * This is the irq handler for the radeon KMS driver (all asics).

 * radeon_irq_process is a macro that points to the per-asic

 * irq handler callback.

/*

 * Handle hotplug events outside the interrupt handler proper.

/**

 * radeon_hotplug_work_func - display hotplug work handler

 *

 * @work: work struct

 *

 * This is the hot plug event work handler (all asics).

 * The work gets scheduled from the irq handler if there

 * was a hot plug interrupt.  It walks the connector table

 * and calls the hotplug handler for each one, then sends

 * a drm hotplug event to alert userspace.

	/* we can race here at startup, some boards seem to trigger

 Just fire off a uevent and let userspace tell us what to do */

 this should take a mutex */

/**

 * radeon_driver_irq_preinstall_kms - drm irq preinstall callback

 *

 * @dev: drm dev pointer

 *

 * Gets the hw ready to enable irqs (all asics).

 * This function disables all interrupt sources on the GPU.

 Disable *all* interrupts */

 Clear bits */

/**

 * radeon_driver_irq_postinstall_kms - drm irq preinstall callback

 *

 * @dev: drm dev pointer

 *

 * Handles stuff to be done after enabling irqs (all asics).

 * Returns 0 on success.

/**

 * radeon_driver_irq_uninstall_kms - drm irq uninstall callback

 *

 * @dev: drm dev pointer

 *

 * This function disables all interrupt sources on the GPU (all asics).

 Disable *all* interrupts */

 PCI devices require shared interrupts. */

/**

 * radeon_msi_ok - asic specific msi checks

 *

 * @rdev: radeon device pointer

 *

 * Handles asic specific MSI checks to determine if

 * MSIs should be enabled on a particular chip (all asics).

 * Returns true if MSIs should be enabled, false if MSIs

 * should not be enabled.

 RV370/RV380 was first asic with MSI support */

 MSIs don't work on AGP */

	/*

	 * Older chips have a HW limitation, they can only generate 40 bits

	 * of address for "64-bit" MSIs which breaks on some platforms, notably

	 * IBM POWER servers, so we limit them

 force MSI on */

 Quirks */

 HP RS690 only seems to work with MSIs. */

 Dell RS690 only seems to work with MSIs. */

 Dell RS690 only seems to work with MSIs. */

 Gateway RS690 only seems to work with MSIs. */

 try and enable MSIs by default on all RS690s */

	/* RV515 seems to have MSI issues where it loses

	 * MSI rearms occasionally. This leads to lockups and freezes.

	 * disable it by default.

 APUs work fine with MSIs */

 lots of IGPs have problems with MSIs */

/**

 * radeon_irq_kms_init - init driver interrupt info

 *

 * @rdev: radeon device pointer

 *

 * Sets up the work irq handlers, vblank init, MSIs, etc. (all asics).

 * Returns 0 for success, error for failure.

 Disable vblank irqs aggressively for power-saving */

 enable msi */

/**

 * radeon_irq_kms_fini - tear down driver interrupt info

 *

 * @rdev: radeon device pointer

 *

 * Tears down the work irq handlers, vblank handlers, MSIs, etc. (all asics).

/**

 * radeon_irq_kms_sw_irq_get - enable software interrupt

 *

 * @rdev: radeon device pointer

 * @ring: ring whose interrupt you want to enable

 *

 * Enables the software interrupt for a specific ring (all asics).

 * The software interrupt is generally used to signal a fence on

 * a particular ring.

/**

 * radeon_irq_kms_sw_irq_get_delayed - enable software interrupt

 *

 * @rdev: radeon device pointer

 * @ring: ring whose interrupt you want to enable

 *

 * Enables the software interrupt for a specific ring (all asics).

 * The software interrupt is generally used to signal a fence on

 * a particular ring.

/**

 * radeon_irq_kms_sw_irq_put - disable software interrupt

 *

 * @rdev: radeon device pointer

 * @ring: ring whose interrupt you want to disable

 *

 * Disables the software interrupt for a specific ring (all asics).

 * The software interrupt is generally used to signal a fence on

 * a particular ring.

/**

 * radeon_irq_kms_pflip_irq_get - enable pageflip interrupt

 *

 * @rdev: radeon device pointer

 * @crtc: crtc whose interrupt you want to enable

 *

 * Enables the pageflip interrupt for a specific crtc (all asics).

 * For pageflips we use the vblank interrupt source.

/**

 * radeon_irq_kms_pflip_irq_put - disable pageflip interrupt

 *

 * @rdev: radeon device pointer

 * @crtc: crtc whose interrupt you want to disable

 *

 * Disables the pageflip interrupt for a specific crtc (all asics).

 * For pageflips we use the vblank interrupt source.

/**

 * radeon_irq_kms_enable_afmt - enable audio format change interrupt

 *

 * @rdev: radeon device pointer

 * @block: afmt block whose interrupt you want to enable

 *

 * Enables the afmt change interrupt for a specific afmt block (all asics).

/**

 * radeon_irq_kms_disable_afmt - disable audio format change interrupt

 *

 * @rdev: radeon device pointer

 * @block: afmt block whose interrupt you want to disable

 *

 * Disables the afmt change interrupt for a specific afmt block (all asics).

/**

 * radeon_irq_kms_enable_hpd - enable hotplug detect interrupt

 *

 * @rdev: radeon device pointer

 * @hpd_mask: mask of hpd pins you want to enable.

 *

 * Enables the hotplug detect interrupt for a specific hpd pin (all asics).

/**

 * radeon_irq_kms_disable_hpd - disable hotplug detect interrupt

 *

 * @rdev: radeon device pointer

 * @hpd_mask: mask of hpd pins you want to disable.

 *

 * Disables the hotplug detect interrupt for a specific hpd pin (all asics).

/**

 * radeon_irq_kms_set_irq_n_enabled - helper for updating interrupt enable registers

 *

 * @rdev: radeon device pointer

 * @reg: the register to write to enable/disable interrupts

 * @mask: the mask that enables the interrupts

 * @enable: whether to enable or disable the interrupt register

 * @name: the name of the interrupt register to print to the kernel log

 * @n: the number of the interrupt register to print to the kernel log

 *

 * Helper for updating the enable state of interrupt registers. Checks whether

 * or not the interrupt matches the enable state we want. If it doesn't, then

 * we update it and print a debugging message to the kernel log indicating the

 * new state of the interrupt register.

 *

 * Used for updating sequences of interrupts registers like HPD1, HPD2, etc.

 Interrupt state didn't change */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 program the speaker allocation */

 set HDMI mode */

 stereo */

 program the speaker allocation */

 set DP mode */

 stereo */

 Two dtos; generally use dto0 for HDMI */

	/* Express [24MHz / target pixel clock] as an exact rational

	 * number (coefficient of two integer numbers.  DCCG_AUDIO_DTOx_PHASE

	 * is the numerator, DCCG_AUDIO_DTOx_MODULE is the denominator

 Two dtos; generally use dto1 for DP */

	/* Express [24MHz / target pixel clock] as an exact rational

	 * number (coefficient of two integer numbers.  DCCG_AUDIO_DTOx_PHASE

	 * is the numerator, DCCG_AUDIO_DTOx_MODULE is the denominator

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 RV740 uses evergreen uvd clk programming */

 bypass vclk and dclk with bclk */

 keep the Bypass mode, put PLL to sleep */

 set UPLL_FB_DIV to 0x50000 */

 deassert UPLL_RESET and UPLL_SLEEP */

 assert BYPASS EN and FB_DIV[0] <- ??? why? */

 assert PLL_RESET */

 set the required FB_DIV, REF_DIV, Post divder values */

 give the PLL some time to settle */

 deassert PLL_RESET */

 deassert BYPASS EN and FB_DIV[0] <- ??? why? */

 switch VCLK and DCLK selection */

/**

 * rv770_get_xclk - get the xclk

 *

 * @rdev: radeon_device pointer

 *

 * Returns the reference clock used by the gfx engine

 * (r7xx-cayman).

 Lock the graphics update lock */

 flip at hsync for async, default is vsync */

 update pitch */

 update the scanout addresses */

 Wait for update_pending to go high. */

 Unlock the lock, so double-buffering can take place inside vblank */

 Return current update_pending status: */

 get temperature in millidegrees */

 0xff01 is a flag rather then an actual voltage */

/*

 * GART

 Setup L2 cache */

 Setup TLB control */

 Disable all tables */

 Setup L2 cache */

 Setup TLB control */

 Setup L2 cache */

 Setup TLB control */

 Initialize HDP */

	/* r7xx hw bug.  Read from HDP_DEBUG1 rather

	 * than writing to HDP_REG_COHERENCY_FLUSH_CNTL

 Lockout access through VGA aperture*/

 Update configuration */

 VRAM before AGP */

 VRAM after AGP */

	/* we need to own VRAM, so turn off the VGA renderer here

/*

 * CP.

 Reset cp */

/*

 * Core functions

 setup chip specs */

 Initialize HDP */

 setup tiling, simd, pipe config */

 if all the backends are disabled, fix it up here */

 set HW defaults for 3D engine */

	/* SQ_CONFIG, SQ_GPR_RESOURCE_MGMT, SQ_THREAD_RESOURCE_MGMT, SQ_STACK_RESOURCE_MGMT

	 * should be adjusted as needed by the 2D/3D drivers.  This just sets default values

 no vertex cache */

 Max value for this is 256 */

 more default values. 2D/3D driver should adjust as needed */

 clear render buffer base addresses */

 leave room for at least 512M GTT */

 Get VRAM informations */

 Could aper size report 0 ? */

 Setup GPU memory space */

		/*

		 * At this point rdev->uvd.vcpu_bo is NULL which trickles down

		 * to early fails uvd_v2_2_resume() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable uvd here.

 enable pcie gen2 link */

 scratch needs to be initialized before MC */

 allocate wb buffer */

 Enable IRQ */

	/* Do not reset GPU before posting, on rv770 hw unlike on r500 hw,

	 * posting will perform necessary task to bring back GPU into good

	 * shape.

 post card */

 init golden registers */

/* Plan is to move initialization in that function and use

 * helper function so that radeon_device_init pretty much

 * do nothing more than calling asic specific function. This

 * should also allow to remove a bunch of callback function

 * like vram_info.

 Read BIOS */

 Must be an ATOMBIOS */

 Post card if necessary */

 init golden registers */

 Initialize scratch registers */

 Initialize surface registers */

 Initialize clocks */

 Fence driver */

 initialize AGP */

 Memory manager */

 Initialize power management */

 x2 cards have a special sequence */

 advertise upconfig capability */

 XXX: only disable it if gen1 bridge vendor == 0x111d or 0x1106 */

/*

 * Copyright 2009 Jerome Glisse.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors:

 *    Jerome Glisse <glisse@freedesktop.org>

 *    Thomas Hellstrom <thomas-at-tungstengraphics-dot-com>

 *    Dave Airlie

/*

 * To exclude mutual BO access we rely on bo_reserve exclusion, as all

 * function are calling it.

		/* Try placing BOs which don't need CPU access outside of the

		 * CPU accessible part of VRAM

 PCI GART is always snooped */

	/* Write-combined CPU mappings of GTT cause GPU hangs with RV6xx

	 * See https://bugs.freedesktop.org/show_bug.cgi?id=91268

	/* XXX: Write-combined CPU mappings of GTT seem broken on 32-bit

	 * See https://bugs.freedesktop.org/show_bug.cgi?id=84627

	/* Don't try to enable write-combining when it can't work, or things

	 * may be slow

	 * See https://bugs.freedesktop.org/show_bug.cgi?id=88758

	/* For architectures that don't support WC memory,

	 * mask out the WC flag from the BO

 Kernel allocation are uninterruptible */

 A BO shared as a dma-buf cannot be sensibly migrated to VRAM */

 force to pin into visible video ram */

 late 2.6.33 fix IGP hibernate - we need pm ops to do this correct */

 Useless to evict on IGP chips */

 this should unref the ttm bo */

 reserve PAT memory space to WC for VRAM */

 Add an MTRR for the VRAM */

/* Returns how many bytes TTM can move per IB.

	/* This function is based on the current VRAM usage.

	 *

	 * - If all of VRAM is free, allow relocating the number of bytes that

	 *   is equal to 1/4 of the size of VRAM for this IB.



	 * - If more than one half of VRAM is occupied, only allow relocating

	 *   1 MB of data for this IB.

	 *

	 * - From 0 to one half of used VRAM, the threshold decreases

	 *   linearly.

	 *         __________________

	 * 1/4 of -|\               |

	 * VRAM    | \              |

	 *         |  \             |

	 *         |   \            |

	 *         |    \           |

	 *         |     \          |

	 *         |      \         |

	 *         |       \________|1 MB

	 *         |----------------|

	 *    VRAM 0 %             100 %

	 *         used            used

	 *

	 * Note: It's a threshold, not a limit. The threshold must be crossed

	 * for buffer relocations to stop, so any buffer of an arbitrary size

	 * can be moved as long as the threshold isn't crossed before

	 * the relocation takes place. We don't want to disable buffer

	 * relocations completely.

	 *

	 * The idea is that buffers should be placed in VRAM at creation time

	 * and TTM should only do a minimum number of relocations during

	 * command submission. In practice, you need to submit at least

	 * a dozen IBs to move all buffers to VRAM if they are in GTT.

	 *

	 * Also, things can get pretty crazy under memory pressure and actual

	 * VRAM usage can change a lot, so playing safe even at 50% does

	 * consistently increase performance.

			/* Check if this buffer will be moved and don't move it

			 * if we have moved too many buffers for this IB already.

			 *

			 * Note that this allows moving at least one buffer of

			 * any size, because it doesn't take the current "bo"

			 * into account. We don't want to disallow buffer moves

			 * completely.

 will be moved */

 don't move it */

 if we are all out */

 find someone with a surface reg and nuke their BO */

 blow away the mapping */

 Can't move a pinned BO to visible VRAM */

 hurrah the memory is not visible ! */

 Force into visible VRAM */

 this should never happen */

/**

 * radeon_bo_fence - add fence to buffer object

 *

 * @bo: buffer object in question

 * @fence: fence to add

 * @shared: true if fence should be added shared

 *

/*

 * Copyright 2015 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 work out two sizes required */

 switch the pad to aux mode */

 setup AUX control register with correct HPD pin */

 atombios appears to write this twice lets copy it */

 write the data header into the registers */

 request, address, msg size */

 if we are writing - write the msg buffer */

 clear the ACK */

 write the size and GO bits */

 poll the status registers - TODO irq support */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Christian König.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König

/*

 * HDMI color format

/*

 * IEC60958 status bits

 number of channels */

 bits per sample */

 current sampling rate in HZ */

 iec 60958 status bits */

 iec 60958 category code */

/*

 * update all hdmi interfaces with current audio parameters

 enable the audio stream */

 only one pin on 6xx-NI */

 DCE 3.0 uses register that's normally for CRC_CONTROL */

 select SW CTS value */

 allow hw to sent ACR packets when required */

/*

 * build a HDMI Video Info Frame

 anything other than 0 */

 enable AVI info frames */

 send AVI info frames every frame/field */

/*

 * build a Audio Info Frame

/*

 * test if audio buffer is filled enough to start playing

/*

 * have buffer status changed since last call?

/*

 * write the audio workaround status to the hardware

 FIXME */

 disable workaround */

 enable workaround */

 select DTO0 */

 select DTO1 */

 send null packets when required */

 send general control packets */

 send general control packets every frame */

 send audio packets */

 default audio delay */

 should be suffient for all audio modes and small enough for all hblanks */

 allow 60958 channel status fields to be updated */

 enable audio info frames (frames won't be set until audio is enabled) */

 required for audio info values to be updated */

 anything other than 0 */

/**

 * r600_hdmi_update_audio_settings - Update audio infoframe

 *

 * @encoder: drm encoder

 *

 * Gets info about current audio stream and updates audio infoframe.

/*

 * enable the HDMI engine

 Older chipsets require setting HDMI and routing manually */

 if irq is available use it */

 XXX: shouldn't need this on any asics.  Double check DCE2/3 */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 This files gather functions specifics to : rs400,rs480 */

 Check gart size */

 Check gart size */

 Initialize common gart structure */

 Check gart size */

 It should be fine to program it to max value */

 Table should be in 32bits address space so ignore bits above. */

 TODO: more tweaking here */

 Disable snooping */

 Disable AGP mode */

	/* FIXME: according to doc we should set HIDE_MMCFG_BAR=0,

 Enable gart */

 read MC_STATUS */

 FIXME: is this correct ? */

 DDR for all card after R300 & IGP */

 Stops all mc clients */

 Wait for mc idle */

 Resume clock */

 Initialize GPU configuration (# pipes, ...) */

	/* Initialize GART (initialize after TTM so we can allocate

 allocate wb buffer */

 Enable IRQ */

 1M ring buffer */

 Make sur GART are not working */

 Resume clock before doing reset */

 setup MC before calling post tables */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 post */

 Resume clock after posting */

 Initialize surface registers */

 Disable VGA */

 Initialize scratch registers */

 Initialize surface registers */

 TODO: disable VGA need to use VGA request */

 restore some register to sane defaults */

 BIOS*/

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Initialize clocks */

 initialize memory controller */

 Fence driver */

 Memory manager */

 Initialize power management */

 Somethings want wront with the accel init stop accel */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

/* RS600 / Radeon X1250/X1270 integrated GPU

 *

 * This file gather function specific to RS600 which is the IGP of

 * the X1250/X1270 family supporting intel CPU (while RS690/RS740

 * is the X1250/X1270 supporting AMD CPU). The display engine are

 * the avivo one, bios is an atombios, 3D block are the one of the

 * R4XX family. The GART is different from the RS400 one and is very

 * close to the one of the R600 family (R600 likely being an evolution

 * of the RS600 GART block).

/**

 * avivo_wait_for_vblank - vblank wait asic callback.

 *

 * @rdev: radeon_device pointer

 * @crtc: crtc to wait for vblank on

 *

 * Wait for vblank on the requested crtc (r5xx-r7xx).

	/* depending on when we hit vblank, we may be close to active; if so,

	 * wait for another frame.

 Lock the graphics update lock */

 flip at hsync for async, default is vsync */

 update pitch */

 update the scanout addresses */

 Wait for update_pending to go high. */

 Unlock the lock, so double-buffering can take place inside vblank */

 Return current update_pending status: */

 LVDS FMT is set up by atom */

 XXX sort out optimal dither settings */

 XXX sort out optimal dither settings */

 not needed */

mc_host_dyn_cntl,*/ dyn_backbias_cntl;

 mc_host_dyn seems to cause hangs from time to time */

 set pcie lanes */

 disable any active CRTCs */

 enable any active CRTCs */

 hpd for digital panel detect/disconnect */

 Stops all mc clients */

 stop CP */

 disable bus mastering */

 reset GA+VAP */

 reset CP */

 reset MC */

 restore PCI & busmastering */

 Check if GPU is idle */

/*

 * GART.

 Initialize common gart structure */

 Enable bus master */

 FIXME: setup default page */

 enable first context */

 disable all other contexts */

 setup the page table */

 System context maps to VRAM space */

 enable page tables */

 FIXME: disable out of gart access */

 posting read */

 Wait and acknowledge irq */

 SW interrupt */

 Vertical blank interrupts */

 Wait for mc idle */

 FIXME: implement full support */

 Stops all mc clients */

 Wait for mc idle */

 FIXME: What does AGP means for such chipset ? */

 Program MC */

 Resume clock */

 Initialize GPU configuration (# pipes, ...) */

	/* Initialize GART (initialize after TTM so we can allocate

 allocate wb buffer */

 Enable IRQ */

 1M ring buffer */

 Make sur GART are not working */

 Resume clock before doing reset */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 post */

 Resume clock after posting */

 Initialize surface registers */

 Disable VGA */

 Initialize scratch registers */

 Initialize surface registers */

 restore some register to sane defaults */

 BIOS */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Initialize clocks */

 initialize memory controller */

 Fence driver */

 Memory manager */

 Initialize power management */

 Somethings want wront with the accel init stop accel */

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 fixme - fill in enc_priv for atom dac */

 ??? */

 adjust pm to dpms */

		/* Don't mess with SS if percentage is 0 or external ss.

		 * SS is already disabled previously, and disabling it

		 * again can cause display problems if the pll is already

		 * programmed.

				/* one other crtc is using this pll don't turn

				 * off spread spectrum as it might turn off

				 * display on active crtc

 reset the pll flags */

RADEON_PLL_USE_FRAC_FB_DIV |*/

 range limits??? */

 use frac fb div on APUs */

 use frac fb div on RS780/RS880 */

 range limits??? */

 use recommended ref_div for ss */

 DVO wants 2x pixel clock if the DVO chip is in 12 bit mode */

 adjust pll for deep color modes */

	/* DCE3+ has an AdjustDisplayPll that will adjust the pixel clock

	 * accordingly based on the encoder/transmitter to work around

	 * special hw requirements.

 16200 or 27000 */

/* on DCE5, make sure the voltage is high enough to support the

 * required disp clk.

			/* if the default dcpll clock is specified,

			 * SetPixelClock provides the dividers

			/* if the default dcpll clock is specified,

			 * SetPixelClock provides the dividers

 HDMI depth, etc. */

 yes this is correct, the atom define is wrong */

 yes this is correct, the atom define is wrong */

 HDMI depth, etc. */

 Assign mode clock for hdmi deep color max clock limit check */

 DP/eDP */

 disable spread spectrum on DCE3 DP */

 adjust pixel clock as needed */

 pass the actual clock to atombios_crtc_program_pll for DCE5,6 for HDMI */

 update pll params */

 TV seems to prefer the legacy algo on some boards */

 calculate ss amount and step size */

 no fb bound */

	/* If atomic, assume fb object is pinned & idle & fenced and

	 * just update base pointers

 Greater 8 bpc fb needs to bypass hw-lut to retain precision */

 Greater 8 bpc fb needs to bypass hw-lut to retain precision */

 Set NUM_BANKS. */

 Calculate the macrotile mode index. */

 NI and older. */

 4 banks */

 8 banks */

 16 banks */

 XXX need to know more about the surface tiling mode */

		/* Read the pipe config from the 2D TILED SCANOUT mode.

		 * It should be the same for the other modes too, but not all

 for completeness.  HAINAN has no display hw */

	/* Make sure surface address is updated at vertical blank rather than

	 * horizontal blank

	/*

	 * The LUT only has 256 slots for indexing by a 8 bpc fb. Bypass the LUT

	 * for > 8 bpc scanout to avoid truncation of fb indices to 8 msb's, to

	 * retain the full precision throughout the pipeline.

 set pageflip to happen anywhere in vblank interval */

 Bytes per pixel may have changed */

 no fb bound */

	/* If atomic, assume fb object is pinned & idle & fenced and

	 * just update base pointers

 Greater 8 bpc fb needs to bypass hw-lut to retain precision */

 DCE1 (R5xx) */

	/* Make sure surface address is update at vertical blank rather than

	 * horizontal blank

 LUT only has 256 slots for 8 bpc fb. Bypass for > 8 bpc scanout for precision */

 set pageflip to happen only at start of vblank interval (front porch) */

 Bytes per pixel may have changed */

 properly set additional regs when using atombios */

/**

 * radeon_get_pll_use_mask - look up a mask of which pplls are in use

 *

 * @crtc: drm crtc

 *

 * Returns the mask of which PPLLs (Pixel PLLs) are in use.

/**

 * radeon_get_shared_dp_ppll - return the PPLL used by another crtc for DP

 *

 * @crtc: drm crtc

 *

 * Returns the PPLL (Pixel PLL) used by another crtc/encoder which is

 * also in DP mode.  For DP, a single PPLL can be used for all DP

 * crtcs/encoders.

 PPLL2 is exclusive to UNIPHYA on DCE61 */

 for DP use the same PLL for all */

/**

 * radeon_get_shared_nondp_ppll - return the PPLL used by another non-DP crtc

 *

 * @crtc: drm crtc

 *

 * Returns the PPLL (Pixel PLL) used by another non-DP crtc/encoder which can

 * be shared (i.e., same clock).

 PPLL2 is exclusive to UNIPHYA on DCE61 */

 check if we are already driving this connector with another crtc */

 if we are, return that pll */

 for non-DP check the clock */

/**

 * radeon_atom_pick_pll - Allocate a PPLL for use by the crtc.

 *

 * @crtc: drm crtc

 *

 * Returns the PPLL (Pixel PLL) to be used by the crtc.  For DP monitors

 * a single PPLL can be used for all DP crtcs/encoders.  For non-DP

 * monitors a dedicated PPLL must be used.  If a particular board has

 * an external DP PLL, return ATOM_PPLL_INVALID to skip PLL programming

 * as there is no need to program the PLL itself.  If we are not able to

 * allocate a PLL, return ATOM_PPLL_INVALID to skip PLL programming to

 * avoid messing up an existing monitor.

 *

 * Asic specific PLL information

 *

 * DCE 8.x

 * KB/KV

 * - PPLL1, PPLL2 are available for all UNIPHY (both DP and non-DP)

 * CI

 * - PPLL0, PPLL1, PPLL2 are available for all UNIPHY (both DP and non-DP) and DAC

 *

 * DCE 6.1

 * - PPLL2 is only available to UNIPHYA (both DP and non-DP)

 * - PPLL0, PPLL1 are available for UNIPHYB/C/D/E/F (both DP and non-DP)

 *

 * DCE 6.0

 * - PPLL0 is available to all UNIPHY (DP only)

 * - PPLL1, PPLL2 are available for all UNIPHY (both DP and non-DP) and DAC

 *

 * DCE 5.0

 * - DCPLL is available to all UNIPHY (DP only)

 * - PPLL1, PPLL2 are available for all UNIPHY (both DP and non-DP) and DAC

 *

 * DCE 3.0/4.0/4.1

 * - PPLL1, PPLL2 are available for all UNIPHY (both DP and non-DP) and DAC

 *

 skip PPLL programming if using ext clock */

 use the same PPLL for all DP monitors */

 use the same PPLL for all monitors with the same clock */

 otherwise, pick one of the plls */

 KB/ML has PPLL1 and PPLL2 */

 CI/KV has PPLL0, PPLL1, and PPLL2 */

 UNIPHY A uses PPLL2 */

 UNIPHY B/C/D/E/F */

 skip PPLL programming if using ext clock */

 use the same PPLL for all DP monitors */

 use the same PPLL for all monitors with the same clock */

 UNIPHY B/C/D/E/F */

 Don't share PLLs on DCE4.1 chips */

 skip PPLL programming if using ext clock */

		/* in DP mode, the DP ref clock can come from PPLL, DCPLL, or ext clock,

		 * depending on the asic:

		 * DCE4: PPLL or ext clock

		 * DCE5: PPLL, DCPLL, or ext clock

		 * DCE6: PPLL, PPLL0, or ext clock

		 *

		 * Setting ATOM_PPLL_INVALID will cause SetPixelClock to skip

		 * PPLL/DCPLL programming and only program the DP DTO for the

		 * crtc virtual pixel clock.

 skip PPLL programming if using ext clock */

 use PPLL0 for all DP */

 use DCPLL for all DP */

 use the same PPLL for all DP monitors */

 use the same PPLL for all monitors with the same clock */

 all other cases */

 on pre-R5xx asics, the crtc to pll mapping is hardcoded */

		/* some atombios (observed in some DCE2/DCE3) code have a bug,

		 * the matching btw pll and crtc is done through

		 * PCLK_CRTC[1|2]_CNTL (0x480/0x484) but atombios code use the

		 * pll (1 or 2) to select which register to write. ie if using

		 * pll1 it will use PCLK_CRTC1_CNTL (0x480) and if using pll2

		 * it will use PCLK_CRTC2_CNTL (0x484), it then use crtc id to

		 * choose which value to write. Which is reverse order from

		 * register logic. So only case that works is when pllid is

		 * same as crtcid or when both pll and crtc are enabled and

		 * both use same clock.

		 *

		 * So just return crtc id as if crtc and pll were hard linked

		 * together even if they aren't

 always set DCPLL */

 XXX: DCE5, make sure voltage, dispclk is high enough */

 update the hw version fpr dpm */

 assign the encoder to the radeon crtc to avoid repeated lookups later */

 pick pll */

 if we can't get a PPLL for a non-DP encoder, fail */

 disable crtc pair power gating before programming */

 disable the GRPH */

			/* one other crtc is using this pll don't turn

			 * off the pll

 disable the ppll */

 disable the ppll */

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/**

 * cik_get_allowed_info_register - fetch the register for the info ioctl

 *

 * @rdev: radeon_device pointer

 * @reg: register offset in bytes

 * @val: register value

 *

 * Returns 0 for success or -EINVAL for an invalid register

 *

 TODO VCE */

/*

 * Indirect registers accessor

 get temperature in millidegrees */

 get temperature in millidegrees */

/*

 * Indirect registers accessor

/**

 * cik_get_xclk - get the xclk

 *

 * @rdev: radeon_device pointer

 *

 * Returns the reference clock used by the gfx engine

 * (CIK).

/**

 * cik_mm_rdoorbell - read a doorbell dword

 *

 * @rdev: radeon_device pointer

 * @index: doorbell index

 *

 * Returns the value in the doorbell aperture at the

 * requested doorbell index (CIK).

/**

 * cik_mm_wdoorbell - write a doorbell dword

 *

 * @rdev: radeon_device pointer

 * @index: doorbell index

 * @v: value to write

 *

 * Writes @v to the doorbell aperture at the

 * requested doorbell index (CIK).

/**

 * cik_srbm_select - select specific register instances

 *

 * @rdev: radeon_device pointer

 * @me: selected ME (micro engine)

 * @pipe: pipe

 * @queue: queue

 * @vmid: VMID

 *

 * Switches the currently active registers instances.  Some

 * registers are instanced per VMID, others are instanced per

 * me/pipe/queue combination.

 ucode loading */

/**

 * ci_mc_load_microcode - load MC ucode into the hw

 *

 * @rdev: radeon_device pointer

 *

 * Load the GDDR MC ucode into the hw (CIK).

 * Returns 0 on success, error on failure.

 reset the engine and set to writable */

 load mc io regs */

 load the MC ucode */

 put the engine back into the active state */

 wait for training to complete */

/**

 * cik_init_microcode - load ucode images from disk

 *

 * @rdev: radeon_device pointer

 *

 * Use the firmware interface to load the ucode images into

 * the driver (not loaded into hw).

 * Returns 0 on success, error on failure.

 No SMC, MC ucode on APUs */

/*

 * Core functions

/**

 * cik_tiling_mode_table_init - init the hw tiling table

 *

 * @rdev: radeon_device pointer

 *

 * Starting with SI, the tiling setup is done globally in a

 * set of 32 tiling modes.  Rather than selecting each set of

 * parameters per surface as on older asics, we just select

 * which index in the tiling table we want to use, and the

 * surface uses those parameters (CIK).

/**

 * cik_select_se_sh - select which SE, SH to address

 *

 * @rdev: radeon_device pointer

 * @se_num: shader engine to address

 * @sh_num: sh block to address

 *

 * Select which SE, SH combinations to address. Certain

 * registers are instanced per SE or SH.  0xffffffff means

 * broadcast to all SEs or SHs (CIK).

/**

 * cik_create_bitmask - create a bitmask

 *

 * @bit_width: length of the mask

 *

 * create a variable length bit mask (CIK).

 * Returns the bitmask.

/**

 * cik_get_rb_disabled - computes the mask of disabled RBs

 *

 * @rdev: radeon_device pointer

 * @max_rb_num_per_se: max RBs (render backends) per SE (shader engine) for the asic

 * @sh_per_se: number of SH blocks per SE for the asic

 *

 * Calculates the bitmask of disabled RBs (CIK).

 * Returns the disabled RB bitmask.

/**

 * cik_setup_rb - setup the RBs on the asic

 *

 * @rdev: radeon_device pointer

 * @se_num: number of SEs (shader engines) for the asic

 * @sh_per_se: number of SH blocks per SE for the asic

 * @max_rb_num_per_se: max RBs (render backends) per SE for the asic

 *

 * Configures per-SE/SH RB registers (CIK).

/**

 * cik_gpu_init - setup the 3D engine

 *

 * @rdev: radeon_device pointer

 *

 * Configures the 3D engine and tiling configuration

 * registers so that the 3D engine is usable.

 Initialize HDP */

 XXX use MC settings? */

 fix up row size */

	/* setup tiling info dword.  gb_addr_config is not adequate since it does

	 * not have bank info, so create a custom tiling dword.

	 * bits 3:0   num_pipes

	 * bits 7:4   num_banks

	 * bits 11:8  group_size

	 * bits 15:12 row_size

 XXX what about 12? */

 set HW defaults for 3D engine */

/*

 * GPU scratch registers helpers function.

/**

 * cik_scratch_init - setup driver info for CP scratch regs

 *

 * @rdev: radeon_device pointer

 *

 * Set up the number and offset of the CP scratch registers.

 * NOTE: use of CP scratch registers is a legacy inferface and

 * is not used by default on newer asics (r6xx+).  On newer asics,

 * memory buffers are used for fences rather than scratch regs.

/**

 * cik_ring_test - basic gfx ring test

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Allocate a scratch register and write to it using the gfx ring (CIK).

 * Provides a basic gfx ring test to verify that the ring is working.

 * Used by cik_cp_gfx_resume();

 * Returns 0 on success, error on failure.

/**

 * cik_hdp_flush_cp_ring_emit - emit an hdp flush on the cp

 *

 * @rdev: radeon_device pointer

 * @ridx: radeon ring index

 *

 * Emits an hdp flush on the cp.

 write, wait, write */

 == */

 pfp */

 poll interval */

/**

 * cik_fence_gfx_ring_emit - emit a fence on the gfx ring

 *

 * @rdev: radeon_device pointer

 * @fence: radeon fence object

 *

 * Emits a fence sequnce number on the gfx ring and flushes

 * GPU caches.

	/* Workaround for cache flush problems. First send a dummy EOP

	 * event down the pipe with seq one below.

 Then send the real EOP event down the pipe. */

/**

 * cik_fence_compute_ring_emit - emit a fence on the compute ring

 *

 * @rdev: radeon_device pointer

 * @fence: radeon fence object

 *

 * Emits a fence sequnce number on the compute ring and flushes

 * GPU caches.

 RELEASE_MEM - flush caches, send int */

/**

 * cik_semaphore_ring_emit - emit a semaphore on the CP ring

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring buffer object

 * @semaphore: radeon semaphore object

 * @emit_wait: Is this a sempahore wait?

 *

 * Emits a semaphore signal/wait packet to the CP ring and prevents the PFP

 * from running ahead of semaphore waits.

 Prevent the PFP from running ahead of the semaphore wait */

/**

 * cik_copy_cpdma - copy pages using the CP DMA engine

 *

 * @rdev: radeon_device pointer

 * @src_offset: src GPU address

 * @dst_offset: dst GPU address

 * @num_gpu_pages: number of GPU pages to xfer

 * @resv: reservation object to sync to

 *

 * Copy GPU paging using the CP DMA engine (CIK+).

 * Used by the radeon ttm implementation to move pages if

 * registered as the asic copy callback.

/*

 * IB stuff

/**

 * cik_ring_ib_execute - emit an IB (Indirect Buffer) on the gfx ring

 *

 * @rdev: radeon_device pointer

 * @ib: radeon indirect buffer object

 *

 * Emits a DE (drawing engine) or CE (constant engine) IB

 * on the gfx ring.  IBs are usually generated by userspace

 * acceleration drivers and submitted to the kernel for

 * scheduling on the ring.  This function schedules the IB

 * on the gfx ring for execution by the GPU.

 set switch buffer packet before const IB */

/**

 * cik_ib_test - basic gfx ring IB test

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Allocate an IB and execute it on the gfx ring (CIK).

 * Provides a basic gfx ring test to verify that IBs are working.

 * Returns 0 on success, error on failure.

/*

 * CP.

 * On CIK, gfx and compute now have independant command processors.

 *

 * GFX

 * Gfx consists of a single ring and can process both gfx jobs and

 * compute jobs.  The gfx CP consists of three microengines (ME):

 * PFP - Pre-Fetch Parser

 * ME - Micro Engine

 * CE - Constant Engine

 * The PFP and ME make up what is considered the Drawing Engine (DE).

 * The CE is an asynchronous engine used for updating buffer desciptors

 * used by the DE so that they can be loaded into cache in parallel

 * while the DE is processing state update packets.

 *

 * Compute

 * The compute CP consists of two microengines (ME):

 * MEC1 - Compute MicroEngine 1

 * MEC2 - Compute MicroEngine 2

 * Each MEC supports 4 compute pipes and each pipe supports 8 queues.

 * The queues are exposed to userspace and are programmed directly

 * by the compute runtime.

/**

 * cik_cp_gfx_enable - enable/disable the gfx CP MEs

 *

 * @rdev: radeon_device pointer

 * @enable: enable or disable the MEs

 *

 * Halts or unhalts the gfx MEs.

/**

 * cik_cp_gfx_load_microcode - load the gfx CP ME ucode

 *

 * @rdev: radeon_device pointer

 *

 * Loads the gfx PFP, ME, and CE ucode.

 * Returns 0 for success, -EINVAL if the ucode is not available.

 PFP */

 CE */

 ME */

 PFP */

 CE */

 ME */

/**

 * cik_cp_gfx_start - start the gfx ring

 *

 * @rdev: radeon_device pointer

 *

 * Enables the ring and loads the clear state context and other

 * packets required to init the ring.

 * Returns 0 for success, error for failure.

 init the CP */

 init the CE partitions.  CE only used for gfx on CIK */

 setup clear context state */

 set clear context state */

 VGT_VERTEX_REUSE_BLOCK_CNTL */

 VGT_OUT_DEALLOC_CNTL */

/**

 * cik_cp_gfx_fini - stop the gfx ring

 *

 * @rdev: radeon_device pointer

 *

 * Stop the gfx ring and tear down the driver ring

 * info.

/**

 * cik_cp_gfx_resume - setup the gfx ring buffer registers

 *

 * @rdev: radeon_device pointer

 *

 * Program the location and size of the gfx ring buffer

 * and test it to make sure it's working.

 * Returns 0 for success, error for failure.

 Set the write pointer delay */

 set the RB to use vmid 0 */

 ring 0 - compute and gfx */

 Set ring buffer size */

 Initialize the ring buffer's read and write pointers */

 set the wb address wether it's enabled or not */

 scratch register shadowing is no longer supported */

 start the ring */

 XXX check if swapping is necessary on BE */

 XXX check if swapping is necessary on BE */

 Disable wptr polling. */

 Disable HQD. */

/**

 * cik_cp_compute_enable - enable/disable the compute CP MEs

 *

 * @rdev: radeon_device pointer

 * @enable: enable or disable the MEs

 *

 * Halts or unhalts the compute MEs.

		/*

		 * To make hibernation reliable we need to clear compute ring

		 * configuration before halting the compute ring.

/**

 * cik_cp_compute_load_microcode - load the compute CP ME ucode

 *

 * @rdev: radeon_device pointer

 *

 * Loads the compute MEC1&2 ucode.

 * Returns 0 for success, -EINVAL if the ucode is not available.

 MEC1 */

 MEC2 */

 MEC1 */

 MEC2 */

/**

 * cik_cp_compute_start - start the compute queues

 *

 * @rdev: radeon_device pointer

 *

 * Enable the compute queues.

 * Returns 0 for success, error for failure.

/**

 * cik_cp_compute_fini - stop the compute queues

 *

 * @rdev: radeon_device pointer

 *

 * Stop the compute queues and tear down the driver queue

 * info.

	/*

	 * KV:    2 MEC, 4 Pipes/MEC, 8 Queues/Pipe - 64 Queues total

	 * CI/KB: 1 MEC, 4 Pipes/MEC, 8 Queues/Pipe - 32 Queues total

 clear memory.  Not sure if this is required or not */

/**

 * cik_cp_compute_resume - setup the compute queue registers

 *

 * @rdev: radeon_device pointer

 *

 * Program the compute queues and test them to make sure they

 * are working.

 * Returns 0 for success, error for failure.

 fix up chicken bits */

 init the pipes */

 write the EOP addr */

 set the VMID assigned */

 set the EOP size, register value is 2^(EOP_SIZE+1) dwords */

 init the queues.  Just two for now. */

 init the mqd struct */

 disable wptr polling */

 enable doorbell? */

 disable the queue if it's active */

 set the pointer to the MQD */

 set MQD vmid to 0 */

 set the pointer to the HQD, this is similar CP_RB0_BASE/_HI */

 set up the HQD, this is similar to CP_RB0_CNTL */

 assuming kernel queue control */

 only used if CP_PQ_WPTR_POLL_CNTL.WPTR_POLL_EN=1 */

 set the wb address wether it's enabled or not */

 enable the doorbell if requested */

 read and write pointers, similar to CP_RB0_WPTR/_RPTR */

 set the vmid for the queue */

 activate the queue */

/**

 * cik_gpu_check_soft_reset - check which blocks are busy

 *

 * @rdev: radeon_device pointer

 *

 * Check which blocks are busy and return the relevant reset

 * mask to be used by cik_gpu_soft_reset().

 * Returns a mask of the blocks to be reset.

 GRBM_STATUS */

 GRBM_STATUS2 */

 SDMA0_STATUS_REG */

 SDMA1_STATUS_REG */

 SRBM_STATUS2 */

 SRBM_STATUS */

 Skip MC reset as it's mostly likely not hung, just busy */

/**

 * cik_gpu_soft_reset - soft reset GPU

 *

 * @rdev: radeon_device pointer

 * @reset_mask: mask of which blocks to reset

 *

 * Soft reset the blocks specified in @reset_mask.

 disable CG/PG */

 stop the rlc */

 Disable GFX parsing/prefetching */

 Disable MEC parsing/prefetching */

 sdma0 */

 sdma1 */

 Wait a little for things to settle down */

 disable dpm? */

 disable cg/pg */

 Disable GFX parsing/prefetching */

 Disable MEC parsing/prefetching */

 sdma0 */

 sdma1 */

 XXX other engines? */

 halt the rlc, disable cp internal ints */

 disable mem access */

 disable BM */

 reset */

 wait for asic to come out of reset */

 does asic init need to be run first??? */

/**

 * cik_asic_reset - soft reset GPU

 *

 * @rdev: radeon_device pointer

 * @hard: force hard reset

 *

 * Look up which blocks are hung and attempt

 * to reset them.

 * Returns 0 for success.

 try soft reset */

 try pci config reset */

/**

 * cik_gfx_is_lockup - check if the 3D engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the 3D engine is locked up (CIK).

 * Returns true if the engine is locked, false if not.

 MC */

/**

 * cik_mc_program - program the GPU memory controller

 *

 * @rdev: radeon_device pointer

 *

 * Set the location of vram, gart, and AGP in the GPU's

 * physical address space (CIK).

 Initialize HDP */

 Lockout access through VGA aperture*/

 Update configuration */

 XXX double check these! */

	/* we need to own VRAM, so turn off the VGA renderer here

/**

 * cik_mc_init - initialize the memory controller driver params

 *

 * @rdev: radeon_device pointer

 *

 * Look up the amount of vram, vram width, and decide how to place

 * vram and gart within the GPU's physical address space (CIK).

 * Returns 0 for success.

 Get VRAM informations */

 Could aper size report 0 ? */

 size in MB on si */

/*

 * GART

 * VMID 0 is the physical GPU addresses as used by the kernel.

 * VMIDs 1-15 are used for userspace clients and are handled

 * by the radeon vm/hsa code.

/**

 * cik_pcie_gart_tlb_flush - gart tlb flush callback

 *

 * @rdev: radeon_device pointer

 *

 * Flush the TLB for the VMID 0 page table (CIK).

 flush hdp cache */

 bits 0-15 are the VM contexts0-15 */

/**

 * cik_pcie_gart_enable - gart enable

 *

 * @rdev: radeon_device pointer

 *

 * This sets up the TLBs, programs the page tables for VMID0,

 * sets up the hw for VMIDs 1-15 which are allocated on

 * demand, and sets up the global locations for the LDS, GDS,

 * and GPUVM for FSA64 clients (CIK).

 * Returns 0 for success, errors for failure.

 Setup TLB control */

 Setup L2 cache */

 setup context0 */

 restore context1-15 */

 set vm size, must be a multiple of 4 */

 enable context1-15 */

 XXX SH_MEM regs */

 where to put LDS, scratch, GPUVM in FSA64 space */

 CP and shaders */

 SDMA GFX */

 XXX SDMA RLC - todo */

/**

 * cik_pcie_gart_disable - gart disable

 *

 * @rdev: radeon_device pointer

 *

 * This disables all VM page table (CIK).

 Disable all tables */

 Setup TLB control */

 Setup L2 cache */

/**

 * cik_pcie_gart_fini - vm fini callback

 *

 * @rdev: radeon_device pointer

 *

 * Tears down the driver GART/VM setup (CIK).

 vm parser */

/**

 * cik_ib_parse - vm ib_parse callback

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer pointer

 *

 * CIK uses hw IB checking so this is a nop (CIK).

/*

 * vm

 * VMID 0 is the physical GPU addresses as used by the kernel.

 * VMIDs 1-15 are used for userspace clients and are handled

 * by the radeon vm/hsa code.

/**

 * cik_vm_init - cik vm init callback

 *

 * @rdev: radeon_device pointer

 *

 * Inits cik specific vm parameters (number of VMs, base of vram for

 * VMIDs 1-15) (CIK).

 * Returns 0 for success.

	/*

	 * number of VMs

	 * VMID 0 is reserved for System

	 * radeon graphics/compute will use VMIDs 1-15

 base offset of vram pages */

/**

 * cik_vm_fini - cik vm fini callback

 *

 * @rdev: radeon_device pointer

 *

 * Tear down any asic specific VM setup (CIK).

/**

 * cik_vm_decode_fault - print human readable fault info

 *

 * @rdev: radeon_device pointer

 * @status: VM_CONTEXT1_PROTECTION_FAULT_STATUS register value

 * @addr: VM_CONTEXT1_PROTECTION_FAULT_ADDR register value

 * @mc_client: VM_CONTEXT1_PROTECTION_FAULT_MCCLIENT register value

 *

 * Print human readable fault information (CIK).

/*

 * cik_vm_flush - cik vm flush using the CP

 *

 * Update the page table base and flush the VM TLB

 * using the CP (CIK).

 update SH_MEM_* regs */

 SH_MEM_BASES */

 SH_MEM_CONFIG */

 SH_MEM_APE1_BASE */

 SH_MEM_APE1_LIMIT */

 HDP flush */

 bits 0-15 are the VM contexts0-15 */

 wait for the invalidate to complete */

 wait */

 always */

 me */

 ref */

 mask */

 poll interval */

 compute doesn't have PFP */

 sync PFP to ME, otherwise we might get invalid PFP reads */

/*

 * RLC

 * The RLC is a multi-purpose microengine that handles a

 * variety of functions, the most important of which is

 * the interrupt controller.

/**

 * cik_rlc_stop - stop the RLC ME

 *

 * @rdev: radeon_device pointer

 *

 * Halt the RLC ME (MicroEngine) (CIK).

/**

 * cik_rlc_start - start the RLC ME

 *

 * @rdev: radeon_device pointer

 *

 * Unhalt the RLC ME (MicroEngine) (CIK).

/**

 * cik_rlc_resume - setup the RLC hw

 *

 * @rdev: radeon_device pointer

 *

 * Initialize the RLC registers, load the ucode,

 * and start the RLC (CIK).

 * Returns 0 for success, -EINVAL if the ucode is not available.

 disable CG */

 XXX - find out what chips support lbpw */

 order matters! */

 write the cp table buffer */

 begin clear state */

 context control state */

 pa_sc_raster_config/pa_sc_raster_config1 */

 end clear state */

 clear state */

 XXX */

 XXX */

/*

 * Interrupts

 * Starting with r6xx, interrupts are handled via a ring buffer.

 * Ring buffers are areas of GPU accessible memory that the GPU

 * writes interrupt vectors into and the host reads vectors out of.

 * There is a rptr (read pointer) that determines where the

 * host is currently reading, and a wptr (write pointer)

 * which determines where the GPU has written.  When the

 * pointers are equal, the ring is idle.  When the GPU

 * writes vectors to the ring buffer, it increments the

 * wptr.  When there is an interrupt, the host then starts

 * fetching commands and processing them until the pointers are

 * equal again at which point it updates the rptr.

/**

 * cik_enable_interrupts - Enable the interrupt ring buffer

 *

 * @rdev: radeon_device pointer

 *

 * Enable the interrupt ring buffer (CIK).

/**

 * cik_disable_interrupts - Disable the interrupt ring buffer

 *

 * @rdev: radeon_device pointer

 *

 * Disable the interrupt ring buffer (CIK).

 set rptr, wptr to 0 */

/**

 * cik_disable_interrupt_state - Disable all interrupt sources

 *

 * @rdev: radeon_device pointer

 *

 * Clear all interrupt enable bits used by the driver (CIK).

 gfx ring */

 sdma */

 compute queues */

 grbm */

 SRBM */

 vline/vblank, etc. */

 pflip */

 dac hotplug */

 digital hotplug */

/**

 * cik_irq_init - init and enable the interrupt ring

 *

 * @rdev: radeon_device pointer

 *

 * Allocate a ring buffer for the interrupt controller,

 * enable the RLC, disable interrupts, enable the IH

 * ring buffer and enable it (CIK).

 * Called at device load and reume.

 * Returns 0 for success, errors for failure.

 allocate ring */

 disable irqs */

 init rlc */

 setup interrupt control */

 set dummy read address to dummy page address */

	/* IH_DUMMY_RD_OVERRIDE=0 - dummy read disabled with msi, enabled without msi

	 * IH_DUMMY_RD_OVERRIDE=1 - dummy read controlled by IH_DUMMY_RD_EN

 IH_REQ_NONSNOOP_EN=1 if ring is in non-cacheable memory, e.g., vram */

 set the writeback address whether it's enabled or not */

 set rptr, wptr to 0 */

 Default settings for IH_CNTL (disabled at first) */

 RPTR_REARM only works if msi's are enabled */

 force the active interrupt state to all disabled */

 enable irqs */

/**

 * cik_irq_set - enable/disable interrupt sources

 *

 * @rdev: radeon_device pointer

 *

 * Enable interrupt sources on the GPU (vblanks, hpd,

 * etc.) (CIK).

 * Returns 0 for success, errors for failure.

 don't enable anything if the ih is disabled */

 force the active interrupt state to all disabled */

 enable CP interrupts on all rings */

 posting read */

/**

 * cik_irq_ack - ack interrupt sources

 *

 * @rdev: radeon_device pointer

 *

 * Ack interrupt sources on the GPU (vblanks, hpd,

 * etc.) (CIK).  Certain interrupts sources are sw

 * generated and do not require an explicit ack.

/**

 * cik_irq_disable - disable interrupts

 *

 * @rdev: radeon_device pointer

 *

 * Disable interrupts on the hw (CIK).

 Wait and acknowledge irq */

/**

 * cik_irq_suspend - disable interrupts for suspend

 *

 * @rdev: radeon_device pointer

 *

 * Disable interrupts and stop the RLC (CIK).

 * Used for suspend.

/**

 * cik_irq_fini - tear down interrupt support

 *

 * @rdev: radeon_device pointer

 *

 * Disable interrupts on the hw and free the IH ring

 * buffer (CIK).

 * Used for driver unload.

/**

 * cik_get_ih_wptr - get the IH ring buffer wptr

 *

 * @rdev: radeon_device pointer

 *

 * Get the IH ring buffer wptr from either the register

 * or the writeback memory buffer (CIK).  Also check for

 * ring buffer overflow and deal with it.

 * Used by cik_irq_process().

 * Returns the value of the wptr.

		/* When a ring buffer overflow happen start parsing interrupt

		 * from the last not overwritten vector (wptr + 16). Hopefully

		 * this should allow us to catchup.

/*        CIK IV Ring

 * Each IV ring entry is 128 bits:

 * [7:0]    - interrupt source id

 * [31:8]   - reserved

 * [59:32]  - interrupt source data

 * [63:60]  - reserved

 * [71:64]  - RINGID

 *            CP:

 *            ME_ID [1:0], PIPE_ID[1:0], QUEUE_ID[2:0]

 *            QUEUE_ID - for compute, which of the 8 queues owned by the dispatcher

 *                     - for gfx, hw shader state (0=PS...5=LS, 6=CS)

 *            ME_ID - 0 = gfx, 1 = first 4 CS pipes, 2 = second 4 CS pipes

 *            PIPE_ID - ME0 0=3D

 *                    - ME1&2 compute dispatcher (4 pipes each)

 *            SDMA:

 *            INSTANCE_ID [1:0], QUEUE_ID[1:0]

 *            INSTANCE_ID - 0 = sdma0, 1 = sdma1

 *            QUEUE_ID - 0 = gfx, 1 = rlc0, 2 = rlc1

 * [79:72]  - VMID

 * [95:80]  - PASID

 * [127:96] - reserved

/**

 * cik_irq_process - interrupt handler

 *

 * @rdev: radeon_device pointer

 *

 * Interrupt hander (CIK).  Walk the IH ring,

 * ack interrupts and schedule work to handle

 * interrupt events.

 * Returns irq process return code.

 is somebody else already processing irqs? */

 Order reading of wptr vs. reading of IH ring data */

 display interrupts */

 wptr/rptr are in bytes! */

 D1 vblank/vline */

 D1 vblank */

 D1 vline */

 D2 vblank/vline */

 D2 vblank */

 D2 vline */

 D3 vblank/vline */

 D3 vblank */

 D3 vline */

 D4 vblank/vline */

 D4 vblank */

 D4 vline */

 D5 vblank/vline */

 D5 vblank */

 D5 vline */

 D6 vblank/vline */

 D6 vblank */

 D6 vline */

 D1 page flip */

 D2 page flip */

 D3 page flip */

 D4 page flip */

 D5 page flip */

 D6 page flip */

 HPD hotplug */

 UVD */

 reset addr and status */

 VCE */

 GFX RB CP_INT */

 GFX IB CP_INT */

 CP EOP event */

 XXX check the bitfield order! */

 CP Privileged reg access */

 XXX check the bitfield order! */

				/* This results in a full GPU reset, but all we need to do is soft

				 * reset the CP for gfx

 XXX compute */

 XXX compute */

 CP Privileged inst */

 XXX check the bitfield order! */

				/* This results in a full GPU reset, but all we need to do is soft

				 * reset the CP for gfx

 XXX compute */

 XXX compute */

 SDMA trap event */

 XXX check the bitfield order! */

 XXX compute */

 XXX compute */

 XXX compute */

 XXX compute */

 thermal low to high */

 thermal high to low */

 GUI IDLE */

 SDMA Privileged inst */

 SDMA Privileged inst */

 XXX check the bitfield order! */

 XXX compute */

 XXX compute */

 XXX compute */

 XXX compute */

 wptr/rptr are in bytes! */

 make sure wptr hasn't changed while processing */

/*

 * startup/shutdown callbacks

		/*

		 * At this point rdev->uvd.vcpu_bo is NULL which trickles down

		 * to early fails cik_uvd_start() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable uvd here.

		/*

		 * At this point rdev->vce.vcpu_bo is NULL which trickles down

		 * to early fails cik_vce_start() and thus nothing happens

		 * there. So it is pointless to try to go through that code

		 * hence why we disable vce here.

/**

 * cik_startup - program the asic to a functional state

 *

 * @rdev: radeon_device pointer

 *

 * Programs the asic to a functional state (CIK).

 * Called by cik_init() and cik_resume().

 * Returns 0 for success, error for failure.

 enable pcie gen2/3 link */

 enable aspm */

 scratch needs to be initialized before MC */

 allocate rlc buffers */

 CP JT */

 GDS */

 allocate wb buffer */

 allocate mec buffers */

 Enable IRQ */

 set up the compute queues */

 type-2 packets are deprecated on MEC, use type-3 instead */

 first MEC */

 first pipe */

 first queue */

 type-2 packets are deprecated on MEC, use type-3 instead */

 dGPU only have 1 MEC */

 first MEC */

 first pipe */

 second queue */

/**

 * cik_resume - resume the asic to a functional state

 *

 * @rdev: radeon_device pointer

 *

 * Programs the asic to a functional state (CIK).

 * Called at resume.

 * Returns 0 for success, error for failure.

 post card */

 init golden registers */

/**

 * cik_suspend - suspend the asic

 *

 * @rdev: radeon_device pointer

 *

 * Bring the chip into a state suitable for suspend (CIK).

 * Called at suspend.

 * Returns 0 for success.

/* Plan is to move initialization in that function and use

 * helper function so that radeon_device_init pretty much

 * do nothing more than calling asic specific function. This

 * should also allow to remove a bunch of callback function

 * like vram_info.

/**

 * cik_init - asic specific driver and hw init

 *

 * @rdev: radeon_device pointer

 *

 * Setup asic specific driver variables and program the hw

 * to a functional state (CIK).

 * Called at driver startup.

 * Returns 0 for success, errors for failure.

 Read BIOS */

 Must be an ATOMBIOS */

 Post card if necessary */

 init golden registers */

 Initialize scratch registers */

 Initialize surface registers */

 Initialize clocks */

 Fence driver */

 initialize memory controller */

 Memory manager */

 Initialize power management */

	/* Don't start up if the MC ucode is missing.

	 * The default clocks and voltages before the MC ucode

	 * is loaded are not suffient for advanced operations.

/**

 * cik_fini - asic specific driver and hw fini

 *

 * @rdev: radeon_device pointer

 *

 * Tear down the asic specific driver variables and program the hw

 * to an idle state (CIK).

 * Called at driver unload.

 LVDS/eDP FMT is set up by atom */

 not needed for analog */

 XXX sort out optimal dither settings */

 XXX sort out optimal dither settings */

 XXX sort out optimal dither settings */

 not needed */

 display watermark setup */

/**

 * dce8_line_buffer_adjust - Set up the line buffer

 *

 * @rdev: radeon_device pointer

 * @radeon_crtc: the selected display controller

 * @mode: the current display mode on the selected display

 * controller

 *

 * Setup up the line buffer allocation for

 * the selected display controller (CIK).

 * Returns the line buffer size in pixels.

	/*

	 * Line Buffer Setup

	 * There are 6 line buffers, one for each display controllers.

	 * There are 3 partitions per LB. Select the number of partitions

	 * to enable based on the display width.  For display widths larger

	 * than 4096, you need use to use 2 display controllers and combine

	 * them using the stereo blender.

 controller not enabled, so no lb used */

/**

 * cik_get_number_of_dram_channels - get the number of dram channels

 *

 * @rdev: radeon_device pointer

 *

 * Look up the number of video ram channels (CIK).

 * Used for display watermark bandwidth calculations

 * Returns the number of dram channels

 number of dram channels */

 bandwidth per dram data pin in kHz */

 engine clock in kHz */

 display clock in kHz */

 viewport width */

 active display time in ns */

 blank time in ns */

 mode is interlaced */

 vertical scale ratio */

 number of active crtcs */

 bytes per pixel display + overlay */

 line buffer allocated to pipe */

 vertical scaler taps */

/**

 * dce8_dram_bandwidth - get the dram bandwidth

 *

 * @wm: watermark calculation data

 *

 * Calculate the raw dram bandwidth (CIK).

 * Used for display watermark bandwidth calculations

 * Returns the dram bandwidth in MBytes/s

 Calculate raw DRAM Bandwidth */

 0.7 */

/**

 * dce8_dram_bandwidth_for_display - get the dram bandwidth for display

 *

 * @wm: watermark calculation data

 *

 * Calculate the dram bandwidth used for display (CIK).

 * Used for display watermark bandwidth calculations

 * Returns the dram bandwidth for display in MBytes/s

 Calculate DRAM Bandwidth and the part allocated to display. */

 0.3 to 0.7 */

 XXX worse case value 0.3 */

/**

 * dce8_data_return_bandwidth - get the data return bandwidth

 *

 * @wm: watermark calculation data

 *

 * Calculate the data return bandwidth used for display (CIK).

 * Used for display watermark bandwidth calculations

 * Returns the data return bandwidth in MBytes/s

 Calculate the display Data return Bandwidth */

 0.8 */

/**

 * dce8_dmif_request_bandwidth - get the dmif bandwidth

 *

 * @wm: watermark calculation data

 *

 * Calculate the dmif bandwidth used for display (CIK).

 * Used for display watermark bandwidth calculations

 * Returns the dmif bandwidth in MBytes/s

 Calculate the DMIF Request Bandwidth */

 0.8 */

/**

 * dce8_available_bandwidth - get the min available bandwidth

 *

 * @wm: watermark calculation data

 *

 * Calculate the min available bandwidth used for display (CIK).

 * Used for display watermark bandwidth calculations

 * Returns the min available bandwidth in MBytes/s

 Calculate the Available bandwidth. Display can use this temporarily but not in average. */

/**

 * dce8_average_bandwidth - get the average available bandwidth

 *

 * @wm: watermark calculation data

 *

 * Calculate the average available bandwidth used for display (CIK).

 * Used for display watermark bandwidth calculations

 * Returns the average available bandwidth in MBytes/s

	/* Calculate the display mode Average Bandwidth

	 * DisplayMode should contain the source and destination dimensions,

	 * timing, etc.

/**

 * dce8_latency_watermark - get the latency watermark

 *

 * @wm: watermark calculation data

 *

 * Calculate the latency watermark (CIK).

 * Used for display watermark bandwidth calculations

 * Returns the latency watermark in ns

 First calculate the latency in ns */

 2000 ns. */

 dc pipe latency */

/**

 * dce8_average_bandwidth_vs_dram_bandwidth_for_display - check

 * average and available dram bandwidth

 *

 * @wm: watermark calculation data

 *

 * Check if the display average bandwidth fits in the display

 * dram bandwidth (CIK).

 * Used for display watermark bandwidth calculations

 * Returns true if the display fits, false if not.

/**

 * dce8_average_bandwidth_vs_available_bandwidth - check

 * average and available bandwidth

 *

 * @wm: watermark calculation data

 *

 * Check if the display average bandwidth fits in the display

 * available bandwidth (CIK).

 * Used for display watermark bandwidth calculations

 * Returns true if the display fits, false if not.

/**

 * dce8_check_latency_hiding - check latency hiding

 *

 * @wm: watermark calculation data

 *

 * Check latency hiding (CIK).

 * Used for display watermark bandwidth calculations

 * Returns true if the display fits, false if not.

/**

 * dce8_program_watermarks - program display watermarks

 *

 * @rdev: radeon_device pointer

 * @radeon_crtc: the selected display controller

 * @lb_size: line buffer size

 * @num_heads: number of display controllers in use

 *

 * Calculate and program the display watermarks for the

 * selected display controller (CIK).

 watermark for high clocks */

 XXX: get this from fb config */

 set for high clocks */

 possibly force display priority to high */

 should really do this at mode validation time... */

 watermark for low clocks */

 XXX: get this from fb config */

 set for low clocks */

 possibly force display priority to high */

 should really do this at mode validation time... */

 Save number of lines the linebuffer leads before the scanout */

 select wm A */

 select wm B */

 restore original selection */

 save values for DPM */

/**

 * dce8_bandwidth_update - program display watermarks

 *

 * @rdev: radeon_device pointer

 *

 * Calculate and program the display watermarks and line

 * buffer allocation (CIK).

/**

 * cik_get_gpu_clock_counter - return GPU clock counter snapshot

 *

 * @rdev: radeon_device pointer

 *

 * Fetches a GPU clock counter snapshot (SI).

 * Returns the 64 bit clock counter snapshot.

 re-try equalization if gen3 is not already enabled */

 check status */

 linkctl */

 linkctl2 */

 set the link speed */

 gen3 */

 gen2 */

 gen1 */

 XXX double check IGPs */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 RMW for the initial bytes */

 SMC address space is BE */

 RMW for the final bytes */

 SMC address space is BE */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/*

 * DMA

 * Starting with R600, the GPU has an asynchronous

 * DMA engine.  The programming model is very similar

 * to the 3D engine (ring buffer, IBs, etc.), but the

 * DMA controller has it's own packet format that is

 * different form the PM4 format used by the 3D engine.

 * It supports copying data, writing embedded data,

 * solid fills, and a number of other things.  It also

 * has support for tiling/detiling of buffers.

/**

 * r600_dma_get_rptr - get the current read pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Get the current rptr from the hardware (r6xx+).

/**

 * r600_dma_get_wptr - get the current write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Get the current wptr from the hardware (r6xx+).

/**

 * r600_dma_set_wptr - commit the write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Write the wptr back to the hardware (r6xx+).

/**

 * r600_dma_stop - stop the async dma engine

 *

 * @rdev: radeon_device pointer

 *

 * Stop the async dma engine (r6xx-evergreen).

/**

 * r600_dma_resume - setup and start the async dma engine

 *

 * @rdev: radeon_device pointer

 *

 * Set up the DMA ring buffer and enable it. (r6xx-evergreen).

 * Returns 0 for success, error for failure.

 Set ring buffer size in dwords */

 Initialize the ring buffer's read and write pointers */

 set the wb address whether it's enabled or not */

 enable DMA IBs */

/**

 * r600_dma_fini - tear down the async dma engine

 *

 * @rdev: radeon_device pointer

 *

 * Stop the async dma engine and free the ring (r6xx-evergreen).

/**

 * r600_dma_is_lockup - Check if the DMA engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the async DMA engine is locked up.

 * Returns true if the engine appears to be locked up, false if not.

/**

 * r600_dma_ring_test - simple async dma engine test

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Test the DMA engine by writing using it to write an

 * value to memory. (r6xx-SI).

 * Returns 0 for success, error for failure.

/**

 * r600_dma_fence_ring_emit - emit a fence on the DMA ring

 *

 * @rdev: radeon_device pointer

 * @fence: radeon fence object

 *

 * Add a DMA fence packet to the ring to write

 * the fence seq number and DMA trap packet to generate

 * an interrupt if needed (r6xx-r7xx).

 write the fence */

 generate an interrupt */

/**

 * r600_dma_semaphore_ring_emit - emit a semaphore on the dma ring

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 * @semaphore: radeon semaphore object

 * @emit_wait: wait or signal semaphore

 *

 * Add a DMA semaphore packet to the ring wait on or signal

 * other rings (r6xx-SI).

/**

 * r600_dma_ib_test - test an IB on the DMA engine

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Test a simple IB in the DMA ring (r6xx-SI).

 * Returns 0 on success, error on failure.

/**

 * r600_dma_ring_ib_execute - Schedule an IB on the DMA engine

 *

 * @rdev: radeon_device pointer

 * @ib: IB object to schedule

 *

 * Schedule an IB in the DMA ring (r6xx-r7xx).

	/* The indirect buffer packet must end on an 8 DW boundary in the DMA ring.

	 * Pad as necessary with NOPs.

/**

 * r600_copy_dma - copy pages using the DMA engine

 *

 * @rdev: radeon_device pointer

 * @src_offset: src GPU address

 * @dst_offset: dst GPU address

 * @num_gpu_pages: number of GPU pages to xfer

 * @resv: reservation object to sync to

 *

 * Copy GPU paging using the DMA engine (r6xx).

 * Used by the radeon ttm implementation to move pages if

 * registered as the asic copy callback.

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 default */

 low sh */

 mid sh */

 high sh */

 low mh */

 mid mh */

 high mh */

 GA_ENHANCE workaround TCL deadlock issue */

 add idle wait as per freedesktop.org bug 24041 */

 get max number of pipes */

 SE chips have 1 pipe */

 force to 1 pipe */

 Sub pixel 1/12 so we can have 4K rendering according to doc */

	/* RV410 and R420 can lock up if CP DMA to host memory happens

	 * while the 2D engine is busy.

	 *

	 * The proper workaround is to queue a RESYNC at the beginning

	 * of the CP init, apparently.

	/* Catch the RESYNC we dispatched all the way back,

	 * at the very beginning of the CP init.

 set common regs */

 program mc */

 Resume clock */

	/* Initialize GART (initialize after TTM so we can allocate

 allocate wb buffer */

 Enable IRQ */

 1M ring buffer */

 Make sur GART are not working */

 Resume clock before doing reset */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Resume clock after posting */

 Initialize surface registers */

 Initialize scratch registers */

 Initialize surface registers */

 TODO: disable VGA need to use VGA request */

 restore some register to sane defaults */

 BIOS*/

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Initialize clocks */

 initialize AGP */

 initialize memory controller */

 Fence driver */

 Memory manager */

 Initialize power management */

 Somethings want wront with the accel init stop accel */

/*

 * Debugfs info

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

/*

 * GART

 * The GART (Graphics Aperture Remapping Table) is an aperture

 * in the GPU's address space.  System pages can be mapped into

 * the aperture and look like contiguous pages from the GPU's

 * perspective.  A page table maps the pages in the aperture

 * to the actual backing pages in system memory.

 *

 * Radeon GPUs support both an internal GART, as described above,

 * and AGP.  AGP works similarly, but the GART table is configured

 * and maintained by the northbridge rather than the driver.

 * Radeon hw has a separate AGP aperture that is programmed to

 * point to the AGP aperture provided by the northbridge and the

 * requests are passed through to the northbridge aperture.

 * Both AGP and internal GART can be used at the same time, however

 * that is not currently supported by the driver.

 *

 * This file handles the common internal GART management.

/*

 * Common GART table functions.

/**

 * radeon_gart_table_ram_alloc - allocate system ram for gart page table

 *

 * @rdev: radeon_device pointer

 *

 * Allocate system memory for GART page table

 * (r1xx-r3xx, non-pcie r4xx, rs400).  These asics require the

 * gart table to be in system memory.

 * Returns 0 for success, -ENOMEM for failure.

/**

 * radeon_gart_table_ram_free - free system ram for gart page table

 *

 * @rdev: radeon_device pointer

 *

 * Free system memory for GART page table

 * (r1xx-r3xx, non-pcie r4xx, rs400).  These asics require the

 * gart table to be in system memory.

/**

 * radeon_gart_table_vram_alloc - allocate vram for gart page table

 *

 * @rdev: radeon_device pointer

 *

 * Allocate video memory for GART page table

 * (pcie r4xx, r5xx+).  These asics require the

 * gart table to be in video memory.

 * Returns 0 for success, error for failure.

/**

 * radeon_gart_table_vram_pin - pin gart page table in vram

 *

 * @rdev: radeon_device pointer

 *

 * Pin the GART page table in vram so it will not be moved

 * by the memory manager (pcie r4xx, r5xx+).  These asics require the

 * gart table to be in video memory.

 * Returns 0 for success, error for failure.

		/* We might have dropped some GART table updates while it wasn't

		 * mapped, restore all entries

/**

 * radeon_gart_table_vram_unpin - unpin gart page table in vram

 *

 * @rdev: radeon_device pointer

 *

 * Unpin the GART page table in vram (pcie r4xx, r5xx+).

 * These asics require the gart table to be in video memory.

/**

 * radeon_gart_table_vram_free - free gart page table vram

 *

 * @rdev: radeon_device pointer

 *

 * Free the video memory used for the GART page table

 * (pcie r4xx, r5xx+).  These asics require the gart table to

 * be in video memory.

/*

 * Common gart functions.

/**

 * radeon_gart_unbind - unbind pages from the gart page table

 *

 * @rdev: radeon_device pointer

 * @offset: offset into the GPU's gart aperture

 * @pages: number of pages to unbind

 *

 * Unbinds the requested pages from the gart page table and

 * replaces them with the dummy page (all asics).

/**

 * radeon_gart_bind - bind pages into the gart page table

 *

 * @rdev: radeon_device pointer

 * @offset: offset into the GPU's gart aperture

 * @pages: number of pages to bind

 * @pagelist: pages to bind

 * @dma_addr: DMA addresses of pages

 * @flags: RADEON_GART_PAGE_* flags

 *

 * Binds the requested pages to the gart page table

 * (all asics).

 * Returns 0 for success, -EINVAL for failure.

/**

 * radeon_gart_init - init the driver info for managing the gart

 *

 * @rdev: radeon_device pointer

 *

 * Allocate the dummy page and init the gart driver info (all asics).

 * Returns 0 for success, error for failure.

 We need PAGE_SIZE >= RADEON_GPU_PAGE_SIZE */

 Compute table size */

 Allocate pages table */

 set GART entry to point to the dummy page by default */

/**

 * radeon_gart_fini - tear down the driver info for managing the gart

 *

 * @rdev: radeon_device pointer

 *

 * Tear down the gart driver info and free the dummy page (all asics).

 unbind pages */

/*

 * Copyright 2010 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/*

 * DMA

 * Starting with R600, the GPU has an asynchronous

 * DMA engine.  The programming model is very similar

 * to the 3D engine (ring buffer, IBs, etc.), but the

 * DMA controller has it's own packet format that is

 * different form the PM4 format used by the 3D engine.

 * It supports copying data, writing embedded data,

 * solid fills, and a number of other things.  It also

 * has support for tiling/detiling of buffers.

 * Cayman and newer support two asynchronous DMA engines.

/**

 * cayman_dma_get_rptr - get the current read pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Get the current rptr from the hardware (cayman+).

/**

 * cayman_dma_get_wptr - get the current write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Get the current wptr from the hardware (cayman+).

/**

 * cayman_dma_set_wptr - commit the write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon ring pointer

 *

 * Write the wptr back to the hardware (cayman+).

/**

 * cayman_dma_ring_ib_execute - Schedule an IB on the DMA engine

 *

 * @rdev: radeon_device pointer

 * @ib: IB object to schedule

 *

 * Schedule an IB in the DMA ring (cayman-SI).

	/* The indirect buffer packet must end on an 8 DW boundary in the DMA ring.

	 * Pad as necessary with NOPs.

/**

 * cayman_dma_stop - stop the async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Stop the async dma engines (cayman-SI).

 dma0 */

 dma1 */

/**

 * cayman_dma_resume - setup and start the async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Set up the DMA ring buffers and enable them. (cayman-SI).

 * Returns 0 for success, error for failure.

 Set ring buffer size in dwords */

 Initialize the ring buffer's read and write pointers */

 set the wb address whether it's enabled or not */

 enable DMA IBs */

/**

 * cayman_dma_fini - tear down the async dma engines

 *

 * @rdev: radeon_device pointer

 *

 * Stop the async dma engines and free the rings (cayman-SI).

/**

 * cayman_dma_is_lockup - Check if the DMA engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the async DMA engine is locked up.

 * Returns true if the engine appears to be locked up, false if not.

/**

 * cayman_dma_vm_copy_pages - update PTEs by copying them from the GART

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @src: src addr where to copy from

 * @count: number of page entries to update

 *

 * Update PTEs by copying them from the GART using the DMA (cayman/TN).

/**

 * cayman_dma_vm_write_pages - update PTEs by writing them manually

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @addr: dst addr to write into pe

 * @count: number of page entries to update

 * @incr: increase next addr by incr bytes

 * @flags: hw access flags

 *

 * Update PTEs by writing them manually using the DMA (cayman/TN).

 for non-physically contiguous pages (system) */

/**

 * cayman_dma_vm_set_pages - update the page tables using the DMA

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @addr: dst addr to write into pe

 * @count: number of page entries to update

 * @incr: increase next addr by incr bytes

 * @flags: hw access flags

 *

 * Update the page tables using the DMA (cayman/TN).

 for physically contiguous pages (vram) */

 dst addr */

 mask */

 value */

 increment size */

/**

 * cayman_dma_vm_pad_ib - pad the IB to the required number of dw

 *

 * @ib: indirect buffer to fill with padding

 *

 flush hdp cache */

 bits 0-7 are the VM contexts0-7 */

 wait for invalidate to complete */

 mask */

 value */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *     Alex Deucher <alexander.deucher@amd.com>

 DB_RENDER_CONTROL */

 DB_COUNT_CONTROL */

 DB_DEPTH_VIEW */

 DB_RENDER_OVERRIDE */

 DB_RENDER_OVERRIDE2 */

 DB_HTILE_DATA_BASE */

 DB_DEPTH_BOUNDS_MIN */

 DB_DEPTH_BOUNDS_MAX */

 DB_STENCIL_CLEAR */

 DB_DEPTH_CLEAR */

 DB_DEPTH_INFO */

 DB_Z_INFO */

 DB_STENCIL_INFO */

 PA_SC_WINDOW_OFFSET */

 PA_SC_CLIPRECT_RULE */

 PA_SC_CLIPRECT_0_TL */

 PA_SC_CLIPRECT_0_BR */

 PA_SC_EDGERULE */

 PA_SU_HARDWARE_SCREEN_OFFSET */

 CB_TARGET_MASK */

 CB_SHADER_MASK */

 PA_SC_VPORT_SCISSOR_0_TL */

 PA_SC_VPORT_SCISSOR_0_BR */

 PA_SC_VPORT_ZMIN_0 */

 PA_SC_VPORT_ZMAX_0 */

 CP_RINGID */

 CP_VMID */

 VGT_MAX_VTX_INDX */

 VGT_MIN_VTX_INDX */

 VGT_INDX_OFFSET */

 VGT_MULTI_PRIM_IB_RESET_INDX */

 CB_BLEND_RED */

 CB_BLEND_GREEN */

 CB_BLEND_BLUE */

 CB_BLEND_ALPHA */

 CB_BLEND0_CONTROL */

 DB_DEPTH_CONTROL */

 DB_EQAA */

 CB_COLOR_CONTROL */

 DB_SHADER_CONTROL */

 PA_CL_CLIP_CNTL */

 PA_SU_SC_MODE_CNTL */

 PA_CL_VTE_CNTL */

 PA_CL_VS_OUT_CNTL */

 PA_CL_NANINF_CNTL */

 PA_SU_LINE_STIPPLE_CNTL */

 PA_SU_LINE_STIPPLE_SCALE */

 PA_SU_PRIM_FILTER_CNTL */

  */

  */

 PA_SU_POINT_SIZE */

 PA_SU_POINT_MINMAX */

 PA_SU_LINE_CNTL */

 PA_SC_LINE_STIPPLE */

 VGT_OUTPUT_PATH_CNTL */

 VGT_HOS_CNTL */

 VGT_GS_MODE */

 PA_SC_MODE_CNTL_0 */

 PA_SC_MODE_CNTL_1 */

 VGT_PRIMITIVEID_EN */

 VGT_MULTI_PRIM_IB_RESET_EN */

 VGT_INSTANCE_STEP_RATE_0 */

 VGT_REUSE_OFF */

 VGT_SHADER_STAGES_EN */

 DB_ALPHA_TO_MASK */

 PA_SU_POLY_OFFSET_DB_FMT_CNTL */

 VGT_STRMOUT_CONFIG */

 PA_SC_CENTROID_PRIORITY_0 */

 PA_SC_CENTROID_PRIORITY_1 */

 PA_SC_LINE_CNTL */

 PA_SC_AA_CONFIG */

 PA_SU_VTX_CNTL */

 PA_CL_GB_VERT_CLIP_ADJ */

 PA_CL_GB_VERT_DISC_ADJ */

 PA_CL_GB_HORZ_CLIP_ADJ */

 PA_CL_GB_HORZ_DISC_ADJ */

 PA_SC_AA_SAMPLE_LOCS_PIXEL_X0Y0_0 */

 PA_SC_AA_MASK_X0Y0_X1Y0 */

 VGT_VERTEX_REUSE_BLOCK_CNTL */

  */

 SPDX-License-Identifier: MIT

/*

 * Integrated TV out support based on the GATOS code by

 * Federico Ulivi <fulivi@lycos.com>

/*

 * Limits of h/v positions (hPos & vPos)

 Range: [-5..5], negative is on the left, 0 is default, positive is on the right */

 Range: [-5..5], negative is up, 0 is default, positive is down */

/*

 * Unit for hPos (in TV clock periods)

/*

 * Indexes in h. code timing table for horizontal line position adjustment

/*

 * Limits of hor. size (hSize)

 Range: [-5..5], negative is smaller, positive is larger */

 tv standard constants */

 tv pll setting for 27 mhz ref clk */

 tv pll setting for 14 mhz ref clk */

 H_TABLE_POS1 */

 H_TABLE_POS2 */

 H_TABLE_POS1 */

 H_TABLE_POS2 */

/**********************************************************************

 *

 * availableModes

 *

 * Table of all allowed modes for tv output

 *

 NTSC timing for 27 Mhz ref clk */

 horResolution */

 verResolution */

 standard */

 horTotal */

 verTotal */

 horStart */

 horSyncStart */

 verSyncStart */

 defRestart */

 crtcPLL_N */

 crtcPLL_M */

 crtcPLL_postDiv */

 pixToTV */

 PAL timing for 27 Mhz ref clk */

 horResolution */

 verResolution */

 standard */

 horTotal */

 verTotal */

 horStart */

 horSyncStart */

 verSyncStart */

 defRestart */

 crtcPLL_N */

 crtcPLL_M */

 crtcPLL_postDiv */

 pixToTV */

 NTSC timing for 14 Mhz ref clk */

 horResolution */

 verResolution */

 standard */

 horTotal */

 verTotal */

 horStart */

 horSyncStart */

 verSyncStart */

 defRestart */

 crtcPLL_N */

 crtcPLL_M */

 crtcPLL_postDiv */

 pixToTV */

 PAL timing for 14 Mhz ref clk */

 horResolution */

 verResolution */

 standard */

 horTotal */

 verTotal */

 horStart */

 horSyncStart */

 verSyncStart */

 defRestart */

 crtcPLL_N */

 crtcPLL_M */

 crtcPLL_postDiv */

 pixToTV */

 included for completeness */

 adjust positions 1&2 in hor. cod timing table */

 Convert hOffset from n. of TV clock periods to n. of CRTC clock periods (CRTC pixels) */

 adjust restart */

	/*

	 * convert v_pos TV lines to n. of CRTC pixels

 compute h_inc from hsize */

 scale up for int divide */

 play with DAC_CNTL */

 play with GPIOPAD_A */

 DISP_OUTPUT_CNTL */

 use reference freq */

 program the TV registers */

 TV PLL */

 TV HV */

 TV restarts */

 tv timings */

 tv std */

/*

 * Copyright 2009 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *     Alex Deucher <alexander.deucher@amd.com>

/*

 * R6xx+ cards need to use the 3D engine to blit data which requires

 * quite a bit of hw state setup.  Rather than pull the whole 3D driver

 * (which normally generates the 3D state) into the DRM, we opt to use

 * statically generated state tables.  The register state and shaders

 * were hand generated to support blitting functionality.  See the 3D

 * driver or documentation for descriptions of the registers and

 * shader instructions.

 START_3D_CMDBUF */

 CONTEXT_CONTROL */

 WAIT_UNTIL */

 TA_CNTL_AUX */

 VC_ENHANCE */

 SQ_DYN_GPR_CNTL_PS_FLUSH_REQ */

 DB_DEBUG */

 DB_WATERMARKS */

 SQ_VTX_BASE_VTX_LOC */

 SQ_VTX_START_INST_LOC */

 SQ_ESGS_RING_ITEMSIZE */

 DB_DEPTH_INFO */

 DB_STENCIL_CLEAR */

 DB_DEPTH_CLEAR */

 DB_DEPTH_CONTROL */

 DB_RENDER_CONTROL */

 DB_RENDER_OVERRIDE */

 DB_ALPHA_TO_MASK */

 VGT_MAX_VTX_INDX */

 VGT_MIN_VTX_INDX */

 VGT_INDX_OFFSET */

 VGT_MULTI_PRIM_IB_RESET_INDX */

 SX_ALPHA_TEST_CONTROL */

 CB_BLEND_RED */

 CB_FOG_RED */

 DB_STENCILREFMASK */

 DB_STENCILREFMASK_BF */

 SX_ALPHA_REF */

 CB_CLRCMP_CNTL */

 CB_CLEAR_RED */

 PA_SC_WINDOW_OFFSET */

 PA_SC_CLIP_RECT_RULE */

 PA_SC_CLIPRECT_0_TL */

 PA_SC_EDGERULE */

 PA_SC_VPORT_SCISSOR_0_TL */

 PA_SC_VPORT_SCISSOR_0_BR */

 PA_SC_VPORT_SCISSOR_1_TL */

 PA_SC_VPORT_ZMIN_0 */

 PA_SC_MPASS_PS_CNTL */

 PA_SC_MODE_CNTL */

 PA_SC_LINE_CNTL */

 PA_SC_AA_CONFIG */

 PA_SU_VTX_CNTL */

 PA_CL_GB_VERT_CLIP_ADJ */

 PA_SC_SAMPLE_LOCS_MCTX */

 PA_SC_AA_MASK */

 PA_SU_POLY_OFFSET_DB_FMT_CNTL */

 PA_SU_POLY_OFFSET_CLAMP */

 PA_SU_POLY_OFFSET_FRONT_SCALE */

 PA_SU_POLY_OFFSET_FRONT_OFFSET */

 PA_SU_POLY_OFFSET_BACK_SCALE */

 PA_SU_POLY_OFFSET_BACK_OFFSET */

 SPI_INPUT_Z */

 SPI_FOG_CNTL */

 SPI_FOG_FUNC_SCALE */

 SPI_FOG_FUNC_BIAS */

 SQ_PGM_START_FS */

 SQ_PGM_RESOURCES_FS */

 SQ_PGM_CF_OFFSET_FS */

 VGT_INSTANCE_STEP_RATE_0 */

 VGT_INSTANCE_STEP_RATE_1 */

 PA_SU_POINT_SIZE */

 PA_SU_POINT_MINMAX */

 PA_SU_LINE_CNTL */

 PA_SC_LINE_STIPPLE */

 VGT_OUTPUT_PATH_CNTL */

 VGT_HOS_CNTL */

 VGT_HOS_MAX_TESS_LEVEL */

 VGT_HOS_MIN_TESS_LEVEL */

 VGT_HOS_REUSE_DEPTH */

 VGT_GROUP_PRIM_TYPE */

 VGT_GROUP_FIRST_DECR */

 VGT_GROUP_DECR */

 VGT_GROUP_VECT_0_CNTL */

 VGT_GROUP_VECT_1_CNTL */

 VGT_GROUP_VECT_0_FMT_CNTL */

 VGT_GROUP_VECT_1_FMT_CNTL */

 VGT_GS_MODE */

 VGT_PRIMITIVEID_EN */

 VGT_MULTI_PRIM_ID_RESET_EN */

 VGT_STRMOUT_EN */

 VGT_REUSE_OFF */

 VGT_VTX_CNT_EN */

 SX_MISC */

 VGT_STRMOUT_BUFFER_EN */

 CB_COLOR_CONTROL */

 DB_SHADER_CNTL */

 PA_CL_CLIP_CNTL */

 PA_SU_SC_MODE_CNTL */

 PA_CL_VTE_CNTL */

 PA_CL_VS_OUT_CNTL */

 PA_CL_NANINF_CNTL */

 CB_TARGET_MASK */

 CB_SHADER_MASK */

 CB_SHADER_CONTROL */

 SPI_VS_OUT_ID_0 */

 SPI_PS_INPUT_CNTL_0 */

 SPI_VS_OUT_CONFIG */

 SPI_THREAD_GROUPING */

 SPI_PS_IN_CONTROL_0 */

 SPI_PS_IN_CONTROL_1 */

 SPI_INTERP_CONTROL_0 */

 SET_SAMPLER */

 CONTEXT_CONTROL */

 WAIT_UNTIL */

 TA_CNTL_AUX */

 VC_ENHANCE */

 SQ_DYN_GPR_CNTL_PS_FLUSH_REQ */

 DB_DEBUG */

 DB_WATERMARKS */

 SQ_VTX_BASE_VTX_LOC */

 SQ_VTX_START_INST_LOC */

 SQ_ESGS_RING_ITEMSIZE */

 DB_DEPTH_INFO */

 DB_STENCIL_CLEAR */

 DB_DEPTH_CLEAR */

 DB_DEPTH_CONTROL */

 DB_RENDER_CONTROL */

 DB_RENDER_OVERRIDE */

 DB_ALPHA_TO_MASK */

 VGT_MAX_VTX_INDX */

 VGT_MIN_VTX_INDX */

 VGT_INDX_OFFSET */

 VGT_MULTI_PRIM_IB_RESET_INDX */

 SX_ALPHA_TEST_CONTROL */

 CB_BLEND_RED */

 DB_STENCILREFMASK */

 DB_STENCILREFMASK_BF */

 SX_ALPHA_REF */

 CB_CLRCMP_CNTL */

 PA_SC_WINDOW_OFFSET */

 PA_SC_CLIP_RECT_RULE */

 PA_SC_CLIPRECT_0_TL */

 PA_SC_EDGERULE */

 PA_SC_VPORT_SCISSOR_0_TL */

 PA_SC_VPORT_SCISSOR_0_BR */

 PA_SC_VPORT_SCISSOR_1_TL */

 PA_SC_VPORT_ZMIN_0 */

 PA_SC_MPASS_PS_CNTL */

 PA_SC_MODE_CNTL */

 PA_SC_LINE_CNTL */

 PA_SC_AA_CONFIG */

 PA_SU_VTX_CNTL */

 PA_CL_GB_VERT_CLIP_ADJ */

 PA_SC_SAMPLE_LOCS_MCTX */

 PA_SC_AA_MASK */

 PA_SU_POLY_OFFSET_DB_FMT_CNTL */

 PA_SU_POLY_OFFSET_CLAMP */

 PA_SU_POLY_OFFSET_FRONT_SCALE */

 PA_SU_POLY_OFFSET_FRONT_OFFSET */

 PA_SU_POLY_OFFSET_BACK_SCALE */

 PA_SU_POLY_OFFSET_BACK_OFFSET */

 SPI_INPUT_Z */

 SPI_FOG_CNTL */

 SPI_FOG_FUNC_SCALE */

 SPI_FOG_FUNC_BIAS */

 SQ_PGM_START_FS */

 SQ_PGM_RESOURCES_FS */

 SQ_PGM_CF_OFFSET_FS */

 VGT_INSTANCE_STEP_RATE_0 */

 VGT_INSTANCE_STEP_RATE_1 */

 PA_SU_POINT_SIZE */

 PA_SU_POINT_MINMAX */

 PA_SU_LINE_CNTL */

 PA_SC_LINE_STIPPLE */

 VGT_OUTPUT_PATH_CNTL */

 VGT_HOS_CNTL */

 VGT_HOS_MAX_TESS_LEVEL */

 VGT_HOS_MIN_TESS_LEVEL */

 VGT_HOS_REUSE_DEPTH */

 VGT_GROUP_PRIM_TYPE */

 VGT_GROUP_FIRST_DECR */

 VGT_GROUP_DECR */

 VGT_GROUP_VECT_0_CNTL */

 VGT_GROUP_VECT_1_CNTL */

 VGT_GROUP_VECT_0_FMT_CNTL */

 VGT_GROUP_VECT_1_FMT_CNTL */

 VGT_GS_MODE */

 VGT_PRIMITIVEID_EN */

 VGT_MULTI_PRIM_ID_RESET_EN */

 VGT_STRMOUT_EN */

 VGT_REUSE_OFF */

 VGT_VTX_CNT_EN */

 SX_MISC */

 VGT_STRMOUT_BUFFER_EN */

 CB_COLOR_CONTROL */

 DB_SHADER_CNTL */

 PA_CL_CLIP_CNTL */

 PA_SU_SC_MODE_CNTL */

 PA_CL_VTE_CNTL */

 PA_CL_VS_OUT_CNTL */

 PA_CL_NANINF_CNTL */

 CB_TARGET_MASK */

 CB_SHADER_MASK */

 CB_SHADER_CONTROL */

 SPI_VS_OUT_ID_0 */

 SPI_PS_INPUT_CNTL_0 */

 SPI_VS_OUT_CONFIG */

 SPI_THREAD_GROUPING */

 SPI_PS_IN_CONTROL_0 */

 SPI_PS_IN_CONTROL_1 */

 SPI_INTERP_CONTROL_0 */

 SET_SAMPLER */

 same for r6xx/r7xx */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 if the displays are off, vblank time is max */

 need special handling */

 sizeof(ATOM_PPLIB_EXTENDEDHEADER) */

 fan table */

 clock dependancy tables, shedding tables */

 cac data */

 ext tables */

 SPDX-License-Identifier: MIT

 set MST mode */

 MTP 16 ? */

 TODO - validate mode against available PBN for link */

 and this can also fail */

 drop link */

 send a hotplug event */

/*

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Rafał Miłecki <zajec5@gmail.com>

 *          Alex Deucher <alexdeucher@gmail.com>

 return default if no match */

		/* starting with BTC, there is one state that is used for both

		 * MH and SH.  Difference is that we always use the high clock index for

		 * mclk and vddci.

 upvolt before raising clocks, downvolt after lowering clocks */

 voltage, pcie lanes, etc.*/

 set engine clock */

 set memory clock */

 voltage, pcie lanes, etc.*/

 no need to take locks, etc. if nothing's going to change */

 wait for the rings to drain */

 needs a GPU reset dont reset here */

 This can fail if a modeset is in progress */

 update display watermarks based on new power state */

 Can't set profile when the card is off */

 Can't set method when the card is off */

 we don't support the legacy modes with dpm */

 disable dynpm */

 Can't set dpm state when the card is off */

 Can't force performance level when the card is off */

 never 0 (full-speed), fuse or smc-controlled always */

 manual, percent-based */

 disable */

 Can't get temperature when the card is off */

 Can't get clock frequency when the card is off */

	/* Value returned by dpm is in 10 KHz units, need to convert it into Hz 

 Can't get vddc when the card is off */

 Skip attributes if DPM is not enabled */

 Skip vddc attribute if get_current_vddc is not implemented */

 Skip fan attributes if fan is not present */

 mask fan attributes if we have no bindings for this asic to expose */

 can't query fan */

 can't query state */

 can't manage fan */

 can't manage state */

 hide max/min values if we can't both query and manage the fan */

 switch to the thermal state */

 switch back the user state */

 switch back the user state */

 check if the vblank period is too short to adjust the mclk */

	/* 120hz tends to be problematic even if they are under the

	 * vblank limit.

	/* certain older asics have a separare 3D performance state,

	 * so try that first if the user selected performance

 balanced states don't exist at the moment */

 Pick the best power state based on current conditions */

 user states */

 internal states */

 use a fallback state if we didn't match */

 if dpm init failed */

 add other state override checks here */

 no need to reprogram if nothing changed unless we are on BTC+ */

 vce just modifies an existing state so force a change */

 user has made a display change (such as timing) */

			/* for pre-BTC and APUs if the num crtcs changed but state is the same,

			 * all we need to do is update the display configuration.

 update display watermarks based on new power state */

 update displays */

			/* for BTC+ if the num crtcs hasn't changed and state is the same,

			 * nothing to do, if the num crtcs is > 1 and state is the same,

			 * update display configuration.

 update display watermarks based on new power state */

 update displays */

 update whether vce is active */

 update display watermarks based on new power state */

 update displays */

 wait for the rings to drain */

 program the new power state */

 update current power state */

 force low perf level for thermal */

 save the user's level */

 otherwise, user selected level */

		/* don't powergate anything if we

 enable/disable UVD */

 disable this for now */

 XXX select vce level based on ring/task */

 disable dpm */

 reset the power state */

 set up the default clocks if the MC ucode is loaded */

 asic init will reset the default power state */

 asic init will reset to the boot state */

 set up the default clocks if the MC ucode is loaded */

 set up the internal thermal sensor if applicable */

 default to balanced state */

 set up the internal thermal sensor if applicable */

 cards with dpm stability problems */

bugs.launchpad.net/ubuntu/+source/linux/+bug/1386534 */

bugzilla.kernel.org/show_bug.cgi?id=83731 */

 Apply dpm quirks */

 enable dpm on rv6xx+ */

 DPM requires the RLC, RV770+ dGPU requires SMC */

 DPM requires the RLC, RV770+ dGPU requires SMC */

 default to profile method */

 XXX: these are noops for dpm but are here for backwards compat */

				/* set the dpm state for PX since there won't be

				 * a modeset to call this.

 where's the best place to put these? */

 reset default clocks */

 XXX backwards compat */

 TODO: Increase clocks if needed for current mode */

 count == 0 */

 update active crtc counts */

 update battery/ac status */

	/* Iterate over all active crtc's. All crtc's must be in vblank,

	 * otherwise return in_vbl == false.

 should upclock */

 should downclock */

		/* Note, radeon_pm_set_clocks is called with static_switch set

		 * to false since we want to wait for vbl to avoid flicker.

/*

 * Debugfs info

 radeon_get_engine_clock is not reliable on APUs so just print the current clock */

/*

 * Copyright 2009 Jerome Glisse.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors:

 *    Jerome Glisse <glisse@freedesktop.org>

 *    Thomas Hellstrom <thomas-at-tungstengraphics-dot-com>

 *    Dave Airlie

			/* Try evicting to the CPU inaccessible part of VRAM

			 * first, but only set GTT as busy placement, so this

			 * BO will be evicted to GTT rather than causing other

			 * BOs to be evicted from VRAM

 Can't move a pinned BO */

 Save old type for statistics update */

 update statistics */

 system memory */

 RADEON_IS_AGP is set only if AGP is active */

 check if it's visible */

		/*

		 * Alpha: use bus.addr to hold the ioremap() return,

		 * so we can modify bus.base below.

		/*

		 * Alpha: Use just the bus offset plus

		 * the hose/domain memory base for bus.base.

		 * It then can be used to build PTEs for VRAM

		 * access, as done in ttm_bo_vm_fault().

/*

 * TTM backend functions.

 prepare the sg table with the user pages */

		/* check that we only pin down anonymous memory

 double check that we don't free the table twice */

 free the sg table and pages again */

 No others user of address space so set it to 0 */

 Change the size here instead of the init above so only lpfn is affected */

/* this should only be called at bootup or when userspace

 this just adjusts TTM size idea, which sets lpfn to the correct value */

/*

 * Copyright 2010 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 value we track */

 unused */

 unused */

 unused */

 unused */

 unused */

 unused */

 value gathered from cs */

 output value */

 macro tile width & height */

 some common value computed here */

		/* old ddx are broken they allocate bo with w*h*bpp but

		 * program slice with ALIGN(h, 8), catch this and patch

		 * command stream.

 find the height the ddx wants */

 check if this one works */

 pitch must be 16 htiles aligned == 16 * 8 pixel aligned */

 height is npipes htiles aligned == npipes * 8 pixel aligned */

 always assume 8x8 htile */

		/* align is htile align * 8, htile align vary according to

		 * number of pipe and tile width and nby

 HTILE_WIDTH = 8 & HTILE_HEIGHT = 8*/

 HTILE_WIDTH = 8 & HTILE_HEIGHT = 8*/

 HTILE_WIDTH = 8 & HTILE_HEIGHT = 8*/

 HTILE_WIDTH = 8 & HTILE_HEIGHT = 8*/

 compute number of htile */

 size must be aligned on npipes * 2K boundary */

 replace by color format so we can use same code */

		/* old userspace doesn't compute proper depth/stencil alignment

		 * check that alignment against a bigger byte per elements and

		 * only report if that alignment is wrong too.

 hyperz */

 hyperz */

 align height */

 check texture size */

 everything's ok */

 check mipmap size */

 recompute alignment */

 check streamout */

	/* check that we have a cb for each enabled target

 at least one component is enabled */

 check cb */

 Check stencil buffer */

 Check depth buffer */

/**

 * evergreen_cs_packet_parse_vline() - parse userspace VLINE packet

 * @p:		parser structure holding parsing context.

 *

 * This is an Evergreen(+)-specific function for parsing VLINE packets.

 * Real work is done by r600_cs_common_vline_parse function.

 * Here we just set up ASIC-specific register table and call

 * the common implementation function.

/**

 * evergreen_cs_handle_reg() - process registers that need special handling.

 * @p: parser structure holding parsing context

 * @reg: register we are testing

 * @idx: index into the cs buffer

	/* force following reg to 0 in an attempt to disable out buffer

	 * which will need us to better understand how it works to perform

	 * security check on it (Jerome)

 get value to populate the IB don't remove */

		/*tmp =radeon_get_ib_value(p, idx);

 size in register is DWs, convert to bytes */

 8x8 only */

 force 8x8 htile width and height */

/**

 * evergreen_is_safe_reg() - check if register is authorized or not

 * @p: parser structure holding parsing context

 * @reg: register we are testing

 *

 * This function will test against reg_safe_bm and return true

 * if register is safe or false otherwise.

 for the clear predicate operation */

		/*

		DW 1 HEADER Header of the packet. Shader_Type in bit 1 of the Header will correspond to the shader type of the Load, see Type-3 Packet.

		   2 BASE_INDEX Bits [3:0] BASE_INDEX - Base Index specifies which base address is specified in the last two DWs.

		     0001: DX11 Draw_Index_Indirect Patch Table Base: Base address for Draw_Index_Indirect data.

		   3 ADDRESS_LO Bits [31:3] - Lower bits of QWORD-Aligned Address. Bits [2:0] - Reserved

		   4 ADDRESS_HI Bits [31:8] - Reserved. Bits [7:0] - Upper bits of Address [47:32]

 currently only supporting setting indirect draw buffer base address */

		/*

		DW 1 HEADER

		   2 DATA_OFFSET Bits [31:0] + byte aligned offset where the required data structure starts. Bits 1:0 are zero

		   3 DRAW_INITIATOR Draw Initiator Register. Written to the VGT_DRAW_INITIATOR register for the assigned context

 bit 4 is reg (0) or mem (1) */

 src = GDS or DATA */

 dst = GDS */

 dst = register */

 src = register */

 non mem to mem copies requires dw aligned count */

 src address space is register */

 GDS is ok */

 src address space is memory */

 dst address space is register */

 GDS is ok */

 dst address space is memory */

 0xffffffff/0x0 is flush all cache flag */

 tex base */

 tex mip base */

					/* MIP_ADDRESS should point to FMASK for an MSAA texture.

 vtx base */

 force size to size of the buffer */

 XXX fix me ALU const buffers only */

 Updating memory at DST_ADDRESS. */

 Reading data from SRC_ADDRESS. */

 SRC is memory. */

 SRC is a reg. */

 DST is memory. */

 DST is a reg. */

 initialize tracker, we are in kms */

/**

 * evergreen_dma_cs_parse() - parse the DMA IB

 * @p:		parser structure holding parsing context.

 *

 * Parses the DMA IB from the CS ioctl and updates

 * the GPU addresses based on the reloc information and

 * checks for errors. (Evergreen-Cayman)

 * Returns 0 for success and an error on failure.

 tiled */

 linear */

 Copy L2L, DW aligned */

 L2L, dw */

 Copy L2T/T2L */

 detile bit */

 tiled src, linear dst */

 linear src, tiled dst */

 Copy L2L, byte aligned */

 L2L, byte */

 Copy L2L, partial */

 L2L, partial */

 Copy L2L, DW aligned, broadcast */

 L2L, dw, broadcast */

 Copy L2T Frame to Field */

 Copy L2T/T2L, partial */

 L2T, T2L partial */

 detile bit */

 tiled src, linear dst */

 linear src, tiled dst */

 Copy L2T broadcast */

 L2T, broadcast */

 Copy L2T/T2L (tile units) */

 L2T, T2L */

 detile bit */

 tiled src, linear dst */

 linear src, tiled dst */

 Copy T2T, partial (tile units) */

 T2T partial */

 Copy L2T broadcast (tile units) */

 L2T, broadcast */

 vm parser */

 context regs are fine */

 check config regs */

 src = GDS or DATA */

 dst = GDS */

 dst = register */

 src = register */

 non mem to mem copies requires dw aligned count */

 src address space is register */

 dst address space is register */

/**

 * evergreen_dma_ib_parse() - parse the DMA IB for VM

 * @rdev: radeon_device pointer

 * @ib:	radeon_ib pointer

 *

 * Parses the DMA IB from the VM CS ioctl

 * checks for errors. (Cayman-SI)

 * Returns 0 for success and an error on failure.

 tiled */

 linear */

 Copy L2L, DW aligned */

 Copy L2T/T2L */

 Copy L2L, byte aligned */

 Copy L2L, partial */

 Copy L2L, DW aligned, broadcast */

 Copy L2T Frame to Field */

 Copy L2T/T2L, partial */

 Copy L2T broadcast */

 Copy L2T/T2L (tile units) */

 Copy T2T, partial (tile units) */

 Copy L2T broadcast (tile units) */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 defaults */

 Get various system informations from bios */

 guess based on the current sclk */

 get the current sclk in 10 khz units */

 get the current mclk in 10 khz units */

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 Register,   Value,     Mask bits */

 Register,   Value,     Mask bits */

 Register,   Value,     Mask bits */

 we never hit the non-gddr5 limit so disable it */

 XXX validate the min clocks required for display */

 adjust low state */

 adjust remaining states */

 ??? */

 ??? */

 update tdp */

 patch up vddc if necessary */

 patch up boot state */

 make sure dc limits are valid */

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 Register, Value, Mask */

 Register, Value, Mask */

 Register, Value, Mask */

 Register, Value */

 XXX double check hw_rev */

 turn the clocks on when encoding, off otherwise */

 not supported by the hw */

 ??? */

 if no match return the highest voltage */

 ??? */

 XXX check against disp reqs */

 ??? */

 patch in vce limits */

 sclk */

 vddc */

 fill in the vce power states */

		/* There are stability issues reported on with

		 * bapm enabled when switching between AC and battery

		 * power.  At the same time, some MSI boards hang

		 * if it's not enabled and dpm is enabled.  Just enable

		 * it for MSI boards right now.

 need to restructure dpm/modeset interaction */

 ??? */

 ??? */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * Authors: Christian König <christian.koenig@amd.com>

/**

 * vce_v1_0_get_rptr - get read pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 *

 * Returns the current hardware read pointer

/**

 * vce_v1_0_get_wptr - get write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 *

 * Returns the current hardware write pointer

/**

 * vce_v1_0_set_wptr - set write pointer

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 *

 * Commits the write pointer to the hardware

/**

 * vce_v1_0_start - start VCE block

 *

 * @rdev: radeon_device pointer

 *

 * Setup and start the VCE block

 set BUSY flag */

 clear BUSY flag */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 NOTE, this is a PCIE indirect reg, not PCIE PORT */

 patch up vddc if necessary */

 fix up pcie gen2 */

 patch up boot state */

 Disable sclk ss, causes hangs on a lot of systems */

 current_index == 2 */

 get the current sclk in 10 khz units */

 current_index == 2 */

 get the current mclk in 10 khz units */

 current_index == 2 */

/*

 * Copyright 2012 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 * Copyright 2014 Rafał Miłecki

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 program the speaker allocation */

 set HDMI mode */

 stereo */

 program the speaker allocation */

 set DP mode */

 stereo */

	/* Express [24MHz / target pixel clock] as an exact rational

	 * number (coefficient of two integer numbers.  DCCG_AUDIO_DTOx_PHASE

	 * is the numerator, DCCG_AUDIO_DTOx_MODULE is the denominator

 select DTO0 */

 select DTO1 */

 select SW CTS value */

 allow hw to sent ACR packets when required */

 default audio delay */

 should be suffient for all audio modes and small enough for all hblanks */

 send audio packets */

 allow 60958 channel status fields to be updated */

 enable audio info frames (frames won't be set until audio is enabled) */

 send audio info frames every frame/field */

 anything other than 0 */

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

		/* This is to workaround the asic bug for RMX, some versions

	/* FIXME: Certain revisions of R300 can't recover here.  Not sure of

	   the cause yet, but this workaround will mask the problem for now.

	   Other chips usually will pass at the very first test, so the

	/* FIXME: Certain revisions of R300 can't recover here.  Not sure of

	   the cause yet, but this workaround will mask the problem for now.

	   Other chips usually will pass at the very first test, so the

	/*

	 * This is horribly crude: the VCO frequency range is divided into

	 * 3 parts, each part having a fixed PLL gain value.

		/*

		 * [300..max] MHz : 7

		/*

		 * [180..300) MHz : 4

		/*

		 * [0..180) MHz : 1

	/*

	 * On all dual CRTC GPUs this bit controls the CRTC of the primary DAC.

	 * Therefore it is set in the DAC DMPS function.

	 * This is different for GPU's with a single CRTC but a primary and a

	 * TV DAC: here it controls the single CRTC no matter where it is

	 * routed. Therefore we set it here.

 adjust pm to dpms changes BEFORE enabling crtcs */

 adjust pm to dpms changes AFTER disabling crtcs */

 no fb bound */

  555 */

  565 */

  RGB */

 xRGB */

 Pin framebuffer & get tilling informations */

 Only 27 bit offset for legacy CRTC */

		/* On old GPU like RN50 with little vram pining can fails because

		 * current fb is taking all space needed. So instead of unpining

		 * the old buffer after pining the new one, first unpin old one

		 * and then retry pining new one.

		 *

		 * As only master can set mode only master can pin and it is

		 * unlikely the master client will race with itself especialy

		 * on those old gpu with single crtc.

		 *

		 * We don't shutdown the display controller because new buffer

		 * will end up in same spot.

 if scanout was in GTT this really wouldn't work */

 crtc offset is from display base addr not FB location */

 Bytes per pixel may have changed */

  555 */

  565 */

  RGB */

 xRGB */

 This works for double scan mode. */

 if TV DAC is enabled for another crtc and keep it enabled */

 rs4xx chips seem to like to have the crtc enabled when the timing is set */

 rs4xx chips seem to like to have the crtc enabled when the timing is set */

 PLL registers */

		/* From RAGE 128 VR/RAGE 128 GL Register

		 * Reference Manual (Technical Reference

		 * Manual P/N RRG-G04100-C Rev. 0.04), page

		 * 3-17 (PLL_DIV_[3:0]).

 VCLK_SRC                 */

 VCLK_SRC/2               */

 VCLK_SRC/4               */

 VCLK_SRC/8               */

 VCLK_SRC/3               */

 VCLK_SRC/16              */

 VCLK_SRC/6               */

 VCLK_SRC/12              */

 range limits??? */

 TODO */

 apparently programming this otherwise causes a hang??? */

 Let the clock to lock */

			/* A temporal workaround for the occasional blanking on certain laptop panels.

			   This appears to related to the PLL divider registers (fail to lock?).

			   It occurs even when all dividers are the same with their old settings.

			   In this case we really don't need to fiddle with PLL registers.

			   By doing this we can avoid the blanking problem with some panels.

				/* When restoring console mode, use saved PPLL_REF_DIV

				 * setting.

 R300 uses ref_div_acc field as real ref divider */

 Let the clock to lock */

 TODO TV */

			/* FIXME: only first crtc has rmx what should we

			 * do ?

	/*

	* The hardware wedges sometimes if you reconfigure one CRTC

	* whilst another is running (see fdo bug #24611).

	/*

	* Reenable the CRTCs that should be running.

/*

 * Copyright 2014 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 SMC address space is BE */

 RMW for the final bytes */

 SMC address space is BE */

 SMC address space is BE */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 read MC_STATUS */

 FIXME: is this correct ? */

 Get various system informations from bios */

 We assume the slower possible clock ie worst case */

 We assume the slower possible clock ie worst case */

 Compute various bandwidth */

 k8_bandwidth = (memory_clk / 2) * 2 * 8 * 0.5 = memory_clk * 4  */

	/* ht_bandwidth = ht_clk * 2 * ht_width / 8 * 0.8

	 *              = ht_clk * ht_width / 5

 HT link is a limiting factor */

	/* sideport_bandwidth = (sideport_clk / 2) * 2 * 2 * 0.7

	 *                    = (sideport_clk * 14) / 10

	/* Some boards seem to be configured for 128MB of sideport memory,

	 * but really only have 64MB.  Just skip the sideport and use

	 * UMA memory.

 Use K8 direct mapping for fast fb access. */ 

		/* FastFB shall be used with UMA memory. Here it is simply disabled when sideport 

		 * memory is present.

 Guess line buffer size to be 8192 pixels */

	/*

	 * Line Buffer Setup

	 * There is a single line buffer shared by both display controllers.

	 * R_006520_DC_LB_MEMORY_SPLIT controls how that line buffer is shared between

	 * the display controllers.  The paritioning can either be done

	 * manually or via one of four preset allocations specified in bits 1:0:

	 *  0 - line buffer is divided in half and shared between crtc

	 *  1 - D1 gets 3/4 of the line buffer, D2 gets 1/4

	 *  2 - D1 gets the whole buffer

	 *  3 - D1 gets 1/4 of the line buffer, D2 gets 3/4

	 * Setting bit 2 of R_006520_DC_LB_MEMORY_SPLIT controls switches to manual

	 * allocation mode. In manual allocation mode, D1 always starts at 0,

	 * D1 end/2 is specified in bits 14:4; D2 allocation follows D1.

 auto */

 Save number of lines the linebuffer leads before the scanout */

 FIXME: wouldn't it better to set priority mark to maximum */

 sclk in Mhz */

 core_bandwidth = sclk(Mhz) * 16 */

	/* Determine consumption rate

	 *  pclk = pixel clock period(ns) = 1000 / (mode.clock / 1000)

	 *  vtaps = number of vertical taps,

	 *  vsc = vertical scaling ratio, defined as source/destination

	 *  hsc = horizontal scaling ration, defined as source/destination

	/* Determine line time

	 *  LineTime = total time for one line of displayhtotal

	 *  LineTime = total number of horizontal pixels

	 *  pclk = pixel clock period(ns)

	/* Determine active time

	 *  ActiveTime = time of active region of display within one line,

	 *  hactive = total number of horizontal active pixels

	 *  htotal = total number of horizontal pixels

 Maximun bandwidth is the minimun bandwidth of all component */

 sclk = system clocks(ns) = 1000 / max_bandwidth / 16 */

	/* Determine chunk time

	 * ChunkTime = the time it takes the DCP to send one chunk of data

	 * to the LB which consists of pipeline delay and inter chunk gap

	 * sclk = system clock(ns)

	/* Determine the worst case latency

	 * NumLinePair = Number of line pairs to request(1=2 lines, 2=4 lines)

	 * WorstCaseLatency = worst case time from urgent to when the MC starts

	 *                    to return data

	 * READ_DELAY_IDLE_MAX = constant of 1us

	 * ChunkTime = time it takes the DCP to send one chunk of data to the LB

	 *             which consists of pipeline delay and inter chunk gap

	/* Determine the tolerable latency

	 * TolerableLatency = Any given request has only 1 line time

	 *                    for the data to be returned

	 * LBRequestFifoDepth = Number of chunk requests the LB can

	 *                      put into the request FIFO for a display

	 *  LineTime = total time for one line of display

	 *  ChunkTime = the time it takes the DCP to send one chunk

	 *              of data to the LB which consists of

	 *  pipeline delay and inter chunk gap

 We assume worst case 32bits (4 bytes) */

	/* Determine the maximum priority mark

	 *  width = viewport width in pixels

 Determine estimated width */

	/*

	 * Set display0/1 priority up in the memory controller for

	 * modes if the user specifies HIGH for displaypriority

	 * option.

 Stops all mc clients */

 Wait for mc idle */

 Program MC, should be a 32bits limited address space */

 Resume clock */

 Initialize GPU configuration (# pipes, ...) */

	/* Initialize GART (initialize after TTM so we can allocate

 allocate wb buffer */

 Enable IRQ */

 1M ring buffer */

 Make sur GART are not working */

 Resume clock before doing reset */

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 post */

 Resume clock after posting */

 Initialize surface registers */

 Disable VGA */

 Initialize scratch registers */

 Initialize surface registers */

 restore some register to sane defaults */

 TODO: disable VGA need to use VGA request */

 BIOS*/

 Reset gpu before posting otherwise ATOM will enter infinite loop */

 check if cards are posted or not */

 Initialize clocks */

 initialize memory controller */

 Fence driver */

 Memory manager */

 Initialize power management */

 Somethings want wront with the accel init stop accel */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

 * Authors: Christian König <christian.koenig@amd.com>

 1 second timeout */

 Firmware Names */

/**

 * radeon_vce_init - allocate memory, load vce firmware

 *

 * @rdev: radeon_device pointer

 *

 * First step to get VCE online, allocate memory and load the firmware

 search for firmware version */

 search for feedback version */

 we can only work with this fw version for now */

 allocate firmware, stack and heap BO */

/**

 * radeon_vce_fini - free memory

 *

 * @rdev: radeon_device pointer

 *

 * Last step on VCE teardown, free firmware memory

/**

 * radeon_vce_suspend - unpin VCE fw memory

 *

 * @rdev: radeon_device pointer

 *

 TODO: suspending running encoding sessions isn't supported */

/**

 * radeon_vce_resume - pin VCE fw memory

 *

 * @rdev: radeon_device pointer

 *

/**

 * radeon_vce_idle_work_handler - power off VCE

 *

 * @work: pointer to work structure

 *

 * power of VCE when it's not used any more

/**

 * radeon_vce_note_usage - power up VCE

 *

 * @rdev: radeon_device pointer

 *

 * Make sure VCE is powerd up when we want to use it

 XXX figure out if the streams changed */

/**

 * radeon_vce_free_handles - free still open VCE handles

 *

 * @rdev: radeon_device pointer

 * @filp: drm file pointer

 *

 * Close all VCE handles still open by this file pointer

/**

 * radeon_vce_get_create_msg - generate a VCE create msg

 *

 * @rdev: radeon_device pointer

 * @ring: ring we should submit the msg to

 * @handle: VCE session handle to use

 * @fence: optional fence to return

 *

 * Open up a stream for HW test

 stitch together an VCE create msg */

 len */

 session cmd */

 len */

 create cmd */

 len */

 feedback buffer */

/**

 * radeon_vce_get_destroy_msg - generate a VCE destroy msg

 *

 * @rdev: radeon_device pointer

 * @ring: ring we should submit the msg to

 * @handle: VCE session handle to use

 * @fence: optional fence to return

 *

 * Close up a stream for HW test or if userspace failed to do so

 stitch together an VCE destroy msg */

 len */

 session cmd */

 len */

 feedback buffer */

 len */

 destroy cmd */

/**

 * radeon_vce_cs_reloc - command submission relocation

 *

 * @p: parser context

 * @lo: address of lower dword

 * @hi: address of higher dword

 * @size: size of checker for relocation buffer

 *

 * Patch relocation inside command stream with real buffer address

/**

 * radeon_vce_validate_handle - validate stream handle

 *

 * @p: parser context

 * @handle: handle to validate

 * @allocated: allocated a new handle?

 *

 * Validates the handle and return the found session index or -EINVAL

 * we we don't have another free session index.

 validate the handle */

 handle not found try to alloc a new one */

/**

 * radeon_vce_cs_parse - parse and validate the command stream

 *

 * @p: parser context

 *

 session

 task info

 create

 config extension

 pic control

 rate control

 motion estimation

 rdo

 vui

 encode

 destroy

 context buffer

 video bitstream buffer

 feedback buffer

		/*

		 * IB contains a destroy msg or we have allocated an

		 * handle and got an error, anyway free the handle

/**

 * radeon_vce_semaphore_emit - emit a semaphore command

 *

 * @rdev: radeon_device pointer

 * @ring: engine to use

 * @semaphore: address of semaphore

 * @emit_wait: true=emit wait, false=emit signal

 *

/**

 * radeon_vce_ib_execute - execute indirect buffer

 *

 * @rdev: radeon_device pointer

 * @ib: the IB to execute

 *

/**

 * radeon_vce_fence_emit - add a fence command to the ring

 *

 * @rdev: radeon_device pointer

 * @fence: the fence

 *

/**

 * radeon_vce_ring_test - test if VCE ring is working

 *

 * @rdev: radeon_device pointer

 * @ring: the engine to test on

 *

/**

 * radeon_vce_ib_test - test if VCE IBs are working

 *

 * @rdev: radeon_device pointer

 * @ring: the engine to test on

 *

/*

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

	/* macs (and possibly some x86 oem systems?) wire up LVDS strangely

	 * Taken from radeonfb.

		/* LVDS_GEN_CNTL parameters are computed in LVDSEncoderControl

		 * need to call that on resume to set up the reg properly.

 set the active encoder to connector routing */

 get the native mode for LVDS */

 Convert brightness to hardware level */

	/* First, try to detect backlight level sense based on the assumption

	 * that firmware set it up at full brightness

		/* XXX hack... maybe some day we can figure out in what direction

		 * backlight should work on a given panel?

 !CONFIG_BACKLIGHT_CLASS_DEVICE */

 handled in radeon_crtc_dpms() */

 TODO 6-bits */

	/* just don't bother on RN50 those chip are often connected to remoting

	 * console hw and often we get failure to load detect those. So to make

	 * everyone happy report the encoder as always connected.

 save the regs we need */

 restore the regs we used */

 bit 22 of TMDS_PLL_CNTL is read-back inverted */

 RV chips got this bit reversed */

  FIXME rgbBits == 8 */

 24 bit format */

 18 bit format */

  FIXME rgbBits == 8 */

 24 bit format, */

 18 bit format, */

 XXX: these are oem specific */

 Dell Inspiron 8600 */

			/*if (mode->clock > 165000)

 don't destroy the i2c bus record here, this will be done in radeon_i2c_fini */

 handled in radeon_crtc_dpms() */

 save regs needed */

 save the regs we need */

 restore the regs we used */

 find out if crtc2 is in use or if this encoder is using it */

 don't probe if the encoder is being used for something else not CRT related */

 R200 uses an external DAC for secondary DAC */

 save the regs we need */

 restore regs we used */

 see if we already added it */

 add a new one */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/**

 * rv770_copy_dma - copy pages using the DMA engine

 *

 * @rdev: radeon_device pointer

 * @src_offset: src GPU address

 * @dst_offset: dst GPU address

 * @num_gpu_pages: number of GPU pages to xfer

 * @resv: reservation object to sync to

 *

 * Copy GPU paging using the DMA engine (r7xx).

 * Used by the radeon ttm implementation to move pages if

 * registered as the asic copy callback.

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 set up registers */

 setup the registers */

 save the boot dram timings */

 restore the boot dram timings */

/*

 * Copyright 2004 ATI Technologies Inc., Markham, Ontario

 * Copyright 2007-8 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 not sure which of these are needed */

 CONFIG_PPC_PMAC */

 old legacy ATI BIOS routines */

 COMBIOS table offsets */

 absolute offset tables */

 relative offset tables */

 offset from misc info */

 offset from misc info */

 offset from misc info */

 offset from misc info */

 offset from mem config */

 offset from mobile info */

 offset from mobile info */

 offset from mobile info */

 offset from mobile info */

 offset from tmds power */

 offset from tmds power */

 absolute offset tables */

 relative offset tables */

 offset from misc info */

 offset from misc info */

 offset from misc info */

 offset from misc info */

 offset from mem config */

 offset from mobile info */

 offset from mobile info */

 offset from mobile info */

 offset from mobile info */

 offset from tmds power */

 offset from tmds power */

 check absolute offset tables */

 this is used for atom LCDs as well */

	/* ddc id            = mask reg

	 * DDC_NONE_DETECTED = none

	 * DDC_DVI           = RADEON_GPIO_DVI_DDC

	 * DDC_VGA           = RADEON_GPIO_VGA_DDC

	 * DDC_LCD           = RADEON_GPIOPAD_MASK

	 * DDC_GPIO          = RADEON_MDGPIO_MASK

	 * r1xx

	 * DDC_MONID         = RADEON_GPIO_MONID

	 * DDC_CRT2          = RADEON_GPIO_CRT2_DDC

	 * r200

	 * DDC_MONID         = RADEON_GPIO_MONID

	 * DDC_CRT2          = RADEON_GPIO_DVI_DDC

	 * r300/r350

	 * DDC_MONID         = RADEON_GPIO_DVI_DDC

	 * DDC_CRT2          = RADEON_GPIO_DVI_DDC

	 * rv2xx/rv3xx

	 * DDC_MONID         = RADEON_GPIO_MONID

	 * DDC_CRT2          = RADEON_GPIO_MONID

	 * rs3xx/rs4xx

	 * DDC_MONID         = RADEON_GPIOPAD_MASK

	 * DDC_CRT2          = RADEON_GPIO_MONID

 system specific masks */

 default gpiopad masks */

 default masks for ddc pads */

			/* hw i2c on RADEON_GPIO_MONID doesn't seem to work

			 * reliably on some pre-r4xx hardware; not sure why.

 gpiopad */

	/* actual hw pads

	 * r1xx/rs2xx/rs3xx

	 * 0x60, 0x64, 0x68, 0x6c, gpiopads, mm

	 * r200

	 * 0x60, 0x64, 0x68, mm

	 * r300/r350

	 * 0x60, 0x64, mm

	 * rv2xx/rv3xx/rs4xx

	 * 0x60, 0x64, 0x68, gpiopads, mm

 0x60 */

 0x64 */

 mm i2c */

 only 2 sw i2c pads */

 0x68 */

 gpiopad */

 0x68 */

 0x68 */

 0x6c */

 pixel clocks */

 system clock */

 ??? */

 memory clock */

 ??? */

 default sclk/mclk */

 might need something asic specific */

 sideport is AMD only */

 r100  */

 rv100 */

 rs100 */

 rv200 */

 rs200 */

 r200  */

 rv250 */

 rs300 */

 rv280 */

 r300  */

 r350  */

 rv350 */

 rv380 */

 r420  */

 r423  */

 rv410 */

 rs400 */

 rs480 */

 check CRT table */

 if the values are zeros, use the table */

 quirks */

 Radeon 7000 (RV100) */

 Radeon 9100 (R200) */

 vbios value is bad, use the default */

 fallback to defaults */

 r100  */

 rv100 */

 rs100 */

 rv200 */

 rs200 */

 r200  */

 rv250 */

 rs300 */

 rv280 */

 r300  */

 r350  */

 rv350 */

 rv380 */

 r420  */

 r423  */

 rv410 */

 rs400 */

 rs480 */

 first check TV table */

 if the values are all zeros, use the table */

 if the values are all zeros, use the table */

 then check CRT table */

 if the values are all zeros, use the table */

 if the values are all zeros, use the table */

 fallback to defaults */

 These should be fail-safe defaults, fingers crossed */

 set crtc values */

 CHIP_R100  */

 CHIP_RV100 */

 CHIP_RS100 */

 CHIP_RV200 */

 CHIP_RS200 */

 CHIP_R200  */

 CHIP_RV250 */

 CHIP_RS300 */

 CHIP_RV280 */

 CHIP_R300  */

 CHIP_R350  */

 CHIP_RV350 */

 CHIP_RV380 */

 CHIP_R420  */

 CHIP_R423  */

 CHIP_RV410 */

 CHIP_RS400 */

 CHIP_RS480 */

 default for macs */

 XXX some macs have duallink chips */

 7 bit addressing */

 7 bit addressing */

 7 bit addressing */

 MM i2c */

 powerbook with VGA */

 powerbook with internal tmds */

 powerbook with external single link tmds (sil164) */

 powerbook with external dual or single link tmds */

 PowerBook6,2 ? */

 powerbook with external dual link tmds (sil1178?) */

 ibook */

 PowerMac G4 Silver radeon 7500 */

 emac */

 mini with internal tmds */

 mini with external tmds */

 PowerMac8,1 ? */

 imac g5 isight */

 Mac X800 */

 Mac G5 tower 9600 */

 SAM440ep RV250 embedded board */

 CONFIG_PPC_PMAC */

 these are the most common settings */

 VGA - primary dac */

 LVDS */

 VGA - primary dac */

 DVI-I - tv dac, int tmds */

 VGA - primary dac */

 TV - tv dac */

 LVDS */

 VGA - TV DAC */

 TV - TV DAC */

 LVDS */

 DVI-I - primary dac, ext tmds */

 ??? */

 XXX some are SL */

 TV - TV DAC */

 LVDS */

 DVI-I - primary dac, int tmds */

 ??? */

 TV - TV DAC */

 LVDS */

 VGA - primary dac */

 TV - TV DAC */

 DVI-I - tv dac, ext tmds */

 ??? */

 XXX are any DL? */

 TV - TV DAC */

 DVI-I - tv dac, int tmds */

 ??? */

 TV - TV DAC */

 DVI-D - int tmds */

 ??? */

 VGA - tv dac */

 TV - TV DAC */

 VGA - primary dac */

 VGA - tv dac */

 TV - TV DAC */

 VGA - primary dac */

 DVI - primary dac, internal tmds */

 ??? */

 DVI - tv dac, dvo */

 ??? */

 DVI - tv dac, dvo */

 ??? */

 ADC - primary dac, internal tmds */

 ??? */

 TV - TV DAC */

 LVDS */

 DVI-I - secondary dac, int tmds */

 ??? */

 VGA - primary dac */

 TV - TV DAC */

 DVI-I - tv dac, int tmds */

 ??? */

 VGA - primary dac */

 TV - TV DAC */

	/* Certain IBM chipset RN50s have a BIOS reporting two VGAs,

 X300 card with extra non-existent DVI port */

 Acer 5102 has non-existent TV port */

 HP dc5750 has non-existent TV port */

 MSI S270 has non-existent TV port */

				/* RV100 board with external TDMS bit mis-set.

				 * Actually uses internal TMDS, clear the bit.

 check TV table */

 allocate 2 power states */

 allocate 1 clock mode per state */

 check for a thermal chip */

 MM i2c */

 boards with a thermal chip, but no overdrive table */

 Asus 9600xt has an f75375 on the monid bus */

 power mode 0 tends to be the only valid one */

 XXX figure out some good default low power mode for mobility cards w/out power tables */

 XXX figure out some good default low power mode for desktop cards */

 add the default mode */

 sil 164 */

 sil 1178 - untested */

		/*

		 * 0x0f, 0x44

		 * 0x0f, 0x4c

		 * 0x0e, 0x01

		 * 0x0a, 0x80

		 * 0x09, 0x30

		 * 0x0c, 0xc9

		 * 0x0d, 0x70

		 * 0x08, 0x32

		 * 0x08, 0x33

 7 bit addressing */

* ??? */
 ??? */

 sdram reset ? */

 something like this????  */

 write to each page */

 read back and verify */

 should do something smarter here I guess... */

 first check detected mem table */

 convert to MB */

 convert to bytes */

 port hardcoded mac stuff from radeonfb */

 ASIC INIT 1 */

 PLL INIT */

 ASIC INIT 2 */

 ASIC INIT 4 */

 RAM RESET */

 ASIC INIT 3 */

 write CONFIG_MEMSIZE */

	/* quirk for rs4xx HP nx6125 laptop to make it resume

	 * - it hangs on resume inside the dynclk 1 table.

	/* quirk for rs4xx HP dv5000 laptop to make it resume

	 * - it hangs on resume inside the dynclk 1 table.

	/* quirk for rs4xx Compaq Presario V5245EU laptop to make it resume

	 * - it hangs on resume inside the dynclk 1 table.

	/* quirk for rs4xx HP Compaq dc5750 Small Form Factor to make it resume

	 * - it hangs on resume inside the dynclk 1 table.

	/* quirk for rs4xx Toshiba Sattellite L20-183 latop to make it resume

	 * - it hangs on resume inside the dynclk 1 table.

 DYN CLK 1 */

 let the bios control the backlight */

 tell the bios not to handle mode switching */

 tell the bios a driver is loaded */

 fix me */

save->bios_4_scratch |= RADEON_TV1_ATTACHED_COMP; */

/*

 * Copyright 2011 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

 *

 these are a limitation of ProcessI2cChannelTransaction not the hw */

 error */

 check for bus probe */

 max_bytes are a limitation of ProcessI2cChannelTransaction not the hw */

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Alex Deucher

/**

 * si_dma_is_lockup - Check if the DMA engine is locked up

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring structure holding ring information

 *

 * Check if the async DMA engine is locked up.

 * Returns true if the engine appears to be locked up, false if not.

/**

 * si_dma_vm_copy_pages - update PTEs by copying them from the GART

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @src: src addr where to copy from

 * @count: number of page entries to update

 *

 * Update PTEs by copying them from the GART using the DMA (SI).

/**

 * si_dma_vm_write_pages - update PTEs by writing them manually

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @addr: dst addr to write into pe

 * @count: number of page entries to update

 * @incr: increase next addr by incr bytes

 * @flags: access flags

 *

 * Update PTEs by writing them manually using the DMA (SI).

 for non-physically contiguous pages (system) */

/**

 * si_dma_vm_set_pages - update the page tables using the DMA

 *

 * @rdev: radeon_device pointer

 * @ib: indirect buffer to fill with commands

 * @pe: addr of the page entry

 * @addr: dst addr to write into pe

 * @count: number of page entries to update

 * @incr: increase next addr by incr bytes

 * @flags: access flags

 *

 * Update the page tables using the DMA (SI).

 for physically contiguous pages (vram) */

 dst addr */

 mask */

 value */

 increment size */

 flush hdp cache */

 bits 0-7 are the VM contexts0-7 */

 wait for invalidate to complete */

 retry */

 mask */

 value */

 func(always) | poll interval */

/**

 * si_copy_dma - copy pages using the DMA engine

 *

 * @rdev: radeon_device pointer

 * @src_offset: src GPU address

 * @dst_offset: dst GPU address

 * @num_gpu_pages: number of GPU pages to xfer

 * @resv: reservation object to sync to

 *

 * Copy GPU paging using the DMA engine (SI).

 * Used by the radeon ttm implementation to move pages if

 * registered as the asic copy callback.

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 configuration we mirror so that we use same code btw kms/ums */

 value we track */

 unused */

 unused */

 unused */

 8 bit */

 16-bit */

 24-bit */

 32-bit */

 48-bit */

 64-bit */

 128-bit */

 block compressed formats */

 Evergreen-only */

 Evergreen-only */

 The other Evergreen formats */

 returns alignment in pixels for pitch/height/depth and bytes for base */

 technically tile_width/_height for pitch/height */

 tile_width */

 tile_height */

 assume DX9 mode */

 assume the biggest format and that htile is enabled */

 When resolve is used, the second colorbuffer has always 1 sample. */

 pitch in pixels */

 avoid breaking userspace */

 check offset */

 the initial DDX does bad things with the CB size occasionally */

 it rounds up height too far for slice tile max but the BO is smaller */

			/* r600c,g also seem to flush at bad times in some apps resulting in

			 * bogus values here. So for linear just allow anything to avoid breaking

			 * broken userspace.

 limit max tile */

 FMASK/CMASK */

			/* the tile size is 8x8, but the size is in units of bits.

		/* One block = 128x128 pixels, one 8x8 tile has 4 bits..

 pitch in pixels */

 don't break userspace */

 hyperz */

 nbx must be 16 htiles aligned == 16 * 8 pixel aligned */

 nby is npipes htiles aligned == npipes * 8 pixel aligned */

 always assume 8x8 htile */

			/* align is htile align * 8, htile align vary according to

			 * number of pipe and tile width and nby

 HTILE_WIDTH = 8 & HTILE_HEIGHT = 8*/

 HTILE_WIDTH = 8 & HTILE_HEIGHT = 8*/

 HTILE_WIDTH = 8 & HTILE_HEIGHT = 8*/

 HTILE_WIDTH = 8 & HTILE_HEIGHT = 8*/

 compute number of htile */

 size must be aligned on npipes * 2K boundary */

 on legacy kernel we don't perform advanced check */

 check streamout */

	/* check that we have a cb for each enabled target, we don't check

	 * shader_mask because it seems mesa isn't always setting it :(

 We must check both colorbuffers for RESOLVE. */

 at least one component is enabled */

 perform rewrite of CB_COLOR[0-7]_SIZE */

 Check depth buffer */

/**

 * r600_cs_packet_parse_vline() - parse userspace VLINE packet

 * @p:		parser structure holding parsing context.

 *

 * This is an R600-specific function for parsing VLINE packets.

 * Real work is done by r600_cs_common_vline_parse function.

 * Here we just set up ASIC-specific register table and call

 * the common implementation function.

/**

 * r600_cs_common_vline_parse() - common vline parser

 * @p:			parser structure holding parsing context.

 * @vline_start_end:    table of vline_start_end registers

 * @vline_status:       table of vline_status registers

 *

 * Userspace sends a special sequence for VLINE waits.

 * PACKET0 - VLINE_START_END + value

 * PACKET3 - WAIT_REG_MEM poll vline status reg

 * RELOC (P3) - crtc_id in reloc.

 *

 * This function parses this and relocates the VLINE START END

 * and WAIT_REG_MEM packets to the correct crtc.

 * It also detects a switched off crtc and nulls out the

 * wait in that case. This function is common for all ASICs that

 * are R600 and newer. The parsing algorithm is the same, and only

 * differs in which registers are used.

 *

 * Caller is the ASIC-specific function which passes the parser

 * context and ASIC-specific register table

 parse the WAIT_REG_MEM */

 check its a WAIT_REG_MEM */

 bit 4 is reg (0) or mem (1) */

 bit 8 is me (0) or pfp (1) */

 waiting for value to be equal */

 jump over the NOP */

 CRTC isn't enabled - we need to nop out the WAIT_REG_MEM */

/**

 * r600_cs_check_reg() - check if register is authorized or not

 * @p: parser structure holding parsing context

 * @reg: register we are testing

 * @idx: index into the cs buffer

 *

 * This function will test against r600_reg_safe_bm and return 0

 * if register is safe. If register is not flag as safe this function

 * will test it against a list of register needing special handling.

	/* force following reg to 0 in an attempt to disable out buffer

	 * which will need us to better understand how it works to perform

	 * security check on it (Jerome)

 get value to populate the IB don't remove */

		/*tmp =radeon_get_ib_value(p, idx);

 size in register is DWs, convert to bytes */

		/* This register were added late, there is userspace

		 * which does provide relocation for those but set

		 * 0 offset. In order to avoid breaking old userspace

		 * we detect this and set address to point to last

		 * CB_COLOR0_BASE, note that if userspace doesn't set

		 * CB_COLOR0_BASE before this register we will report

		 * error. Old userspace always set CB_COLOR0_BASE

		 * before any of this.

 force 8x8 htile width and height */

/**

 * r600_check_texture_resource() - check if register is authorized or not

 * @p: parser structure holding parsing context

 * @idx: index into the cs buffer

 * @texture: texture's bo structure

 * @mipmap: mipmap's bo structure

 * @base_offset: base offset (used for error checking)

 * @mip_offset: mip offset (used for error checking)

 * @tiling_flags: tiling flags

 *

 * This function will check that the resource has valid field and that

 * the texture and mipmap bo object are big enough to cover this resource.

 on legacy kernel we don't perform advanced check */

 convert to bytes */

 pitch in texels */

 XXX check height as well... */

 using get ib will give us the offset into the texture bo */

 using get ib will give us the offset into the mipmap bo */

		/*dev_warn(p->dev, "mipmap bo too small (%d %d %d %d %d %d -> %d have %ld)\n",

 for the clear predicate operation */

 bit 4 is reg (0) or mem (1) */

 src address space is register */

 src address space is memory */

 dst address space is register */

 dst address space is memory */

 0xffffffff/0x0 is flush all cache flag */

 tex base */

 tex mip base */

 vtx base */

 force size to size of the buffer */

 RS780 and RS880 also need this */

 Updating memory at DST_ADDRESS. */

 Reading data from SRC_ADDRESS. */

 SRC is memory. */

 SRC is a reg. */

 DST is memory. */

 DST is a reg. */

 initialize tracker, we are in kms */

/*

 *  DMA

/**

 * r600_dma_cs_next_reloc() - parse next reloc

 * @p:		parser structure holding parsing context.

 * @cs_reloc:		reloc information

 *

 * Return the next reloc, do bo validation and compute

 * GPU offset using the provided start.

/**

 * r600_dma_cs_parse() - parse the DMA IB

 * @p:		parser structure holding parsing context.

 *

 * Parses the DMA IB from the CS ioctl and updates

 * the GPU addresses based on the reloc information and

 * checks for errors. (R6xx-R7xx)

 * Returns 0 for success and an error on failure.

 detile bit */

 tiled src, linear dst */

 linear src, tiled dst */

/*

 * Copyright 2009 Jerome Glisse.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors:

 *    Jerome Glisse <glisse@freedesktop.org>

 *    Dave Airlie

/*

 * Fences

 * Fences mark an event in the GPUs pipeline and are used

 * for GPU/CPU synchronization.  When the fence is written,

 * it is expected that all buffers associated with that fence

 * are no longer in use by the associated ring on the GPU and

 * that the relevant GPU caches have been flushed.  Whether

 * we use a scratch register or memory location depends on the asic

 * and whether writeback is enabled.

/**

 * radeon_fence_write - write a fence value

 *

 * @rdev: radeon_device pointer

 * @seq: sequence number to write

 * @ring: ring index the fence is associated with

 *

 * Writes a fence value to memory or a scratch register (all asics).

/**

 * radeon_fence_read - read a fence value

 *

 * @rdev: radeon_device pointer

 * @ring: ring index the fence is associated with

 *

 * Reads a fence value from memory or a scratch register (all asics).

 * Returns the value of the fence read from memory or register.

/**

 * radeon_fence_schedule_check - schedule lockup check

 *

 * @rdev: radeon_device pointer

 * @ring: ring index we should work with

 *

 * Queues a delayed work item to check for lockups.

	/*

	 * Do not reset the timer here with mod_delayed_work,

	 * this can livelock in an interaction with TTM delayed destroy.

/**

 * radeon_fence_emit - emit a fence on the requested ring

 *

 * @rdev: radeon_device pointer

 * @fence: radeon fence object

 * @ring: ring index the fence is associated with

 *

 * Emits a fence command on the requested ring (all asics).

 * Returns 0 on success, -ENOMEM on failure.

 we are protected by the ring emission mutex */

/*

 * radeon_fence_check_signaled - callback from fence_queue

 *

 * this function is called with fence_queue lock held, which is also used

 * for the fence locking itself, so unlocked variants are used for

 * fence_signal, and remove_wait_queue.

	/*

	 * We cannot use radeon_fence_process here because we're already

	 * in the waitqueue, in a call from wake_up_all.

/**

 * radeon_fence_activity - check for fence activity

 *

 * @rdev: radeon_device pointer

 * @ring: ring index the fence is associated with

 *

 * Checks the current fence value and calculates the last

 * signalled fence value. Returns true if activity occured

 * on the ring, and the fence_queue should be waken up.

	/* Note there is a scenario here for an infinite loop but it's

	 * very unlikely to happen. For it to happen, the current polling

	 * process need to be interrupted by another process and another

	 * process needs to update the last_seq btw the atomic read and

	 * xchg of the current process.

	 *

	 * More over for this to go in infinite loop there need to be

	 * continuously new fence signaled ie radeon_fence_read needs

	 * to return a different value each time for both the currently

	 * polling process and the other process that xchg the last_seq

	 * btw atomic read and xchg of the current process. And the

	 * value the other process set as last seq must be higher than

	 * the seq value we just read. Which means that current process

	 * need to be interrupted after radeon_fence_read and before

	 * atomic xchg.

	 *

	 * To be even more safe we count the number of time we loop and

	 * we bail after 10 loop just accepting the fact that we might

	 * have temporarly set the last_seq not to the true real last

	 * seq but to an older one.

		/* If we loop over we don't want to return without

		 * checking if a fence is signaled as it means that the

		 * seq we just read is different from the previous on.

			/* We looped over too many time leave with the

			 * fact that we might have set an older fence

			 * seq then the current real last seq as signaled

			 * by the hw.

/**

 * radeon_fence_check_lockup - check for hardware lockup

 *

 * @work: delayed work item

 *

 * Checks for fence activity and if there is none probe

 * the hardware if a lockup occured.

 just reschedule the check if a reset is going on */

 good news we believe it's a lockup */

 remember that we need an reset */

/**

 * radeon_fence_process - process a fence

 *

 * @rdev: radeon_device pointer

 * @ring: ring index the fence is associated with

 *

 * Checks the current fence value and wakes the fence queue

 * if the sequence number has increased (all asics).

/**

 * radeon_fence_seq_signaled - check if a fence sequence number has signaled

 *

 * @rdev: radeon device pointer

 * @seq: sequence number

 * @ring: ring index the fence is associated with

 *

 * Check if the last signaled fence sequnce number is >= the requested

 * sequence number (all asics).

 * Returns true if the fence has signaled (current fence value

 * is >= requested value) or false if it has not (current fence

 * value is < the requested value.  Helper function for

 * radeon_fence_signaled().

 poll new last sequence at least once */

/**

 * radeon_fence_enable_signaling - enable signalling on fence

 * @f: fence

 *

 * This function is called with fence_queue lock held, and adds a callback

 * to fence_queue that checks if this fence is signaled, and if so it

 * signals the fence and removes itself.

 did fence get signaled after we enabled the sw irq? */

 we're probably in a lockup, lets not fiddle too much */

/**

 * radeon_fence_signaled - check if a fence has signaled

 *

 * @fence: radeon fence object

 *

 * Check if the requested fence has signaled (all asics).

 * Returns true if the fence has signaled or false if it has not.

/**

 * radeon_fence_any_seq_signaled - check if any sequence number is signaled

 *

 * @rdev: radeon device pointer

 * @seq: sequence numbers

 *

 * Check if the last signaled fence sequnce number is >= the requested

 * sequence number (all asics).

 * Returns true if any has signaled (current value is >= requested value)

 * or false if it has not. Helper function for radeon_fence_wait_seq.

/**

 * radeon_fence_wait_seq_timeout - wait for a specific sequence numbers

 *

 * @rdev: radeon device pointer

 * @target_seq: sequence number(s) we want to wait for

 * @intr: use interruptable sleep

 * @timeout: maximum time to wait, or MAX_SCHEDULE_TIMEOUT for infinite wait

 *

 * Wait for the requested sequence number(s) to be written by any ring

 * (all asics).  Sequnce number array is indexed by ring id.

 * @intr selects whether to use interruptable (true) or non-interruptable

 * (false) sleep when waiting for the sequence number.  Helper function

 * for radeon_fence_wait_*().

 * Returns remaining time if the sequence number has passed, 0 when

 * the wait timeout, or an error for all other cases.

 * -EDEADLK is returned when a GPU lockup has been detected.

 enable IRQs and tracing */

/**

 * radeon_fence_wait_timeout - wait for a fence to signal with timeout

 *

 * @fence: radeon fence object

 * @intr: use interruptible sleep

 *

 * Wait for the requested fence to signal (all asics).

 * @intr selects whether to use interruptable (true) or non-interruptable

 * (false) sleep when waiting for the fence.

 * @timeout: maximum time to wait, or MAX_SCHEDULE_TIMEOUT for infinite wait

 * Returns remaining time if the sequence number has passed, 0 when

 * the wait timeout, or an error for all other cases.

	/*

	 * This function should not be called on !radeon fences.

	 * If this is the case, it would mean this function can

	 * also be called on radeon fences belonging to another card.

	 * exclusive_lock is not held in that case.

/**

 * radeon_fence_wait - wait for a fence to signal

 *

 * @fence: radeon fence object

 * @intr: use interruptible sleep

 *

 * Wait for the requested fence to signal (all asics).

 * @intr selects whether to use interruptable (true) or non-interruptable

 * (false) sleep when waiting for the fence.

 * Returns 0 if the fence has passed, error for all other cases.

/**

 * radeon_fence_wait_any - wait for a fence to signal on any ring

 *

 * @rdev: radeon device pointer

 * @fences: radeon fence object(s)

 * @intr: use interruptable sleep

 *

 * Wait for any requested fence to signal (all asics).  Fence

 * array is indexed by ring id.  @intr selects whether to use

 * interruptable (true) or non-interruptable (false) sleep when

 * waiting for the fences. Used by the suballocator.

 * Returns 0 if any fence has passed, error for all other cases.

 nothing to wait for ? */

/**

 * radeon_fence_wait_next - wait for the next fence to signal

 *

 * @rdev: radeon device pointer

 * @ring: ring index the fence is associated with

 *

 * Wait for the next fence on the requested ring to signal (all asics).

 * Returns 0 if the next fence has passed, error for all other cases.

 * Caller must hold ring lock.

		/* nothing to wait for, last_seq is

/**

 * radeon_fence_wait_empty - wait for all fences to signal

 *

 * @rdev: radeon device pointer

 * @ring: ring index the fence is associated with

 *

 * Wait for all fences on the requested ring to signal (all asics).

 * Returns 0 if the fences have passed, error for all other cases.

 * Caller must hold ring lock.

/**

 * radeon_fence_ref - take a ref on a fence

 *

 * @fence: radeon fence object

 *

 * Take a reference on a fence (all asics).

 * Returns the fence.

/**

 * radeon_fence_unref - remove a ref on a fence

 *

 * @fence: radeon fence object

 *

 * Remove a reference on a fence (all asics).

/**

 * radeon_fence_count_emitted - get the count of emitted fences

 *

 * @rdev: radeon device pointer

 * @ring: ring index the fence is associated with

 *

 * Get the number of fences emitted on the requested ring (all asics).

 * Returns the number of emitted fences on the ring.  Used by the

 * dynpm code to ring track activity.

	/* We are not protected by ring lock when reading the last sequence

	 * but it's ok to report slightly wrong fence count here.

 to avoid 32bits warp around */

/**

 * radeon_fence_need_sync - do we need a semaphore

 *

 * @fence: radeon fence object

 * @dst_ring: which ring to check against

 *

 * Check if the fence needs to be synced against another ring

 * (all asics).  If so, we need to emit a semaphore.

 * Returns true if we need to sync with another ring, false if

 * not.

 we are protected by the ring mutex */

/**

 * radeon_fence_note_sync - record the sync point

 *

 * @fence: radeon fence object

 * @dst_ring: which ring to check against

 *

 * Note the sequence number at which point the fence will

 * be synced with the requested ring (all asics).

 we are protected by the ring mutex */

/**

 * radeon_fence_driver_start_ring - make the fence driver

 * ready for use on the requested ring.

 *

 * @rdev: radeon device pointer

 * @ring: ring index to start the fence driver on

 *

 * Make the fence driver ready for processing (all asics).

 * Not all asics have all rings, so each asic will only

 * start the fence driver on the rings it has.

 * Returns 0 for success, errors for failure.

 put fence directly behind firmware */

/**

 * radeon_fence_driver_init_ring - init the fence driver

 * for the requested ring.

 *

 * @rdev: radeon device pointer

 * @ring: ring index to start the fence driver on

 *

 * Init the fence driver for the requested ring (all asics).

 * Helper function for radeon_fence_driver_init().

/**

 * radeon_fence_driver_init - init the fence driver

 * for all possible rings.

 *

 * @rdev: radeon device pointer

 *

 * Init the fence driver for all possible rings (all asics).

 * Not all asics have all rings, so each asic will only

 * start the fence driver on the rings it has using

 * radeon_fence_driver_start_ring().

/**

 * radeon_fence_driver_fini - tear down the fence driver

 * for all possible rings.

 *

 * @rdev: radeon device pointer

 *

 * Tear down the fence driver for all possible rings (all asics).

 no need to trigger GPU reset as we are unloading */

/**

 * radeon_fence_driver_force_completion - force all fence waiter to complete

 *

 * @rdev: radeon device pointer

 * @ring: the ring to complete

 *

 * In case of GPU reset failure make sure no process keep waiting on fence

 * that will never complete.

/*

 * Fence debugfs

/*

 * radeon_debugfs_gpu_reset - manually trigger a gpu reset

 *

 * Manually trigger a gpu reset at the next fence wait.

		/*

		 * radeon_test_signaled must be called after

		 * set_current_state to prevent a race with wake_up_process

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2010 Red Hat Inc.

 * Author : Dave Airlie <airlied@redhat.com>

 *

 * ATPX support for both Intel/ATI

 handle for device - and atpx */

 structure size in bytes (includes size field) */

 version */

 supported functions bit vector */

 structure size in bytes (includes size field) */

 which flags are valid */

 flags */

/**

 * radeon_atpx_call - call an ATPX method

 *

 * @handle: acpi handle

 * @function: the ATPX function to execute

 * @params: ATPX function params

 *

 * Executes the requested ATPX function (all asics).

 * Returns a pointer to the acpi output buffer.

 We need a second fake parameter */

 Fail only if calling the method fails and ATPX is supported */

/**

 * radeon_atpx_parse_functions - parse supported functions

 *

 * @f: supported functions struct

 * @mask: supported functions mask from ATPX

 *

 * Use the supported functions mask from ATPX function

 * ATPX_FUNCTION_VERIFY_INTERFACE to determine what functions

 * are supported (all asics).

/**

 * radeon_atpx_validate_functions - validate ATPX functions

 *

 * @atpx: radeon atpx struct

 *

 * Validate that required functions are enabled (all asics).

 * returns 0 on success, error on failure.

 if separate mux flag is set, mux controls are required */

 if any outputs are muxed, mux controls are required */

 some bioses set these bits rather than flagging power_cntl as supported */

		/*

		 * Disable legacy PM methods only when pcie port PM is usable,

		 * otherwise the device might fail to power off or power on.

/**

 * radeon_atpx_verify_interface - verify ATPX

 *

 * @atpx: radeon atpx struct

 *

 * Execute the ATPX_FUNCTION_VERIFY_INTERFACE ATPX function

 * to initialize ATPX and determine what features are supported

 * (all asics).

 * returns 0 on success, error on failure.

 TODO: check version? */

/**

 * radeon_atpx_set_discrete_state - power up/down discrete GPU

 *

 * @atpx: atpx info struct

 * @state: discrete GPU state (0 = power down, 1 = power up)

 *

 * Execute the ATPX_FUNCTION_POWER_CONTROL ATPX function to

 * power down/up the discrete GPU (all asics).

 * Returns 0 on success, error on failure.

 200ms delay is required after off */

/**

 * radeon_atpx_switch_disp_mux - switch display mux

 *

 * @atpx: atpx info struct

 * @mux_id: mux state (0 = integrated GPU, 1 = discrete GPU)

 *

 * Execute the ATPX_FUNCTION_DISPLAY_MUX_CONTROL ATPX function to

 * switch the display mux between the discrete GPU and integrated GPU

 * (all asics).

 * Returns 0 on success, error on failure.

/**

 * radeon_atpx_switch_i2c_mux - switch i2c/hpd mux

 *

 * @atpx: atpx info struct

 * @mux_id: mux state (0 = integrated GPU, 1 = discrete GPU)

 *

 * Execute the ATPX_FUNCTION_I2C_MUX_CONTROL ATPX function to

 * switch the i2c/hpd mux between the discrete GPU and integrated GPU

 * (all asics).

 * Returns 0 on success, error on failure.

/**

 * radeon_atpx_switch_start - notify the sbios of a GPU switch

 *

 * @atpx: atpx info struct

 * @mux_id: mux state (0 = integrated GPU, 1 = discrete GPU)

 *

 * Execute the ATPX_FUNCTION_GRAPHICS_DEVICE_SWITCH_START_NOTIFICATION ATPX

 * function to notify the sbios that a switch between the discrete GPU and

 * integrated GPU has begun (all asics).

 * Returns 0 on success, error on failure.

/**

 * radeon_atpx_switch_end - notify the sbios of a GPU switch

 *

 * @atpx: atpx info struct

 * @mux_id: mux state (0 = integrated GPU, 1 = discrete GPU)

 *

 * Execute the ATPX_FUNCTION_GRAPHICS_DEVICE_SWITCH_END_NOTIFICATION ATPX

 * function to notify the sbios that a switch between the discrete GPU and

 * integrated GPU has ended (all asics).

 * Returns 0 on success, error on failure.

/**

 * radeon_atpx_switchto - switch to the requested GPU

 *

 * @id: GPU to switch to

 *

 * Execute the necessary ATPX functions to switch between the discrete GPU and

 * integrated GPU (all asics).

 * Returns 0 on success, error on failure.

/**

 * radeon_atpx_power_state - power down/up the requested GPU

 *

 * @id: GPU to power down/up

 * @state: requested power state (0 = off, 1 = on)

 *

 * Execute the necessary ATPX function to power down/up the discrete GPU

 * (all asics).

 * Returns 0 on success, error on failure.

 on w500 ACPI can't change intel gpu state */

/**

 * radeon_atpx_pci_probe_handle - look up the ATPX handle

 *

 * @pdev: pci device

 *

 * Look up the ATPX handles (all asics).

 * Returns true if the handles are found, false if not.

/**

 * radeon_atpx_init - verify the ATPX interface

 *

 * Verify the ATPX interface (all asics).

 * Returns 0 on success, error on failure.

 set up the ATPX handle */

 validate the atpx setup */

/**

 * radeon_atpx_get_client_id - get the client id

 *

 * @pdev: pci device

 *

 * look up whether we are the integrated or discrete GPU (all asics).

 * Returns the client id.

/**

 * radeon_atpx_detect - detect whether we have PX

 *

 * Check if we have a PX system (all asics).

 * Returns true if we have a PX system, false if not.

 some newer PX laptops mark the dGPU as a non-VGA display device */

/**

 * radeon_register_atpx_handler - register with vga_switcheroo

 *

 * Register the PX callbacks with vga_switcheroo (all asics).

 detect if we have any ATPX + 2 VGA in the system */

/**

 * radeon_unregister_atpx_handler - unregister with vga_switcheroo

 *

 * Unregister the PX callbacks with vga_switcheroo (all asics).

 SPDX-License-Identifier: MIT

/* utility to create the register check tables

 * this includes inlined list.h safe for userspace.

 *

 * Copyright 2009 Jerome Glisse

 * Copyright 2009 Red Hat Inc.

 *

 * Authors:

 * 	Jerome Glisse

 * 	Dave Airlie

/**

 * container_of - cast a member of a structure out to the containing structure

 * @ptr:    the pointer to the member.

 * @type:   the type of the container struct this is embedded in.

 * @member: the name of the member within the struct.

 *

/*

 * Simple doubly linked list implementation.

 *

 * Some of the internal functions ("__xxx") are useful when

 * manipulating whole lists rather than single entries, as

 * sometimes we already know the next/prev entries and we can

 * generate better code by using them directly rather than

 * using the generic single-entry routines.

/*

 * Insert a new entry between two known consecutive entries.

 *

 * This is only for internal list manipulation where we know

 * the prev/next entries already!

/**

 * list_add_tail - add a new entry

 * @new: new entry to be added

 * @head: list head to add it before

 *

 * Insert a new entry before the specified head.

 * This is useful for implementing queues.

/**

 * list_entry - get the struct for this entry

 * @ptr:	the &struct list_head pointer.

 * @type:	the type of the struct this is embedded in.

 * @member:	the name of the list_head within the struct.

/**

 * list_for_each_entry	-	iterate over list of given type

 * @pos:	the type * to use as a loop cursor.

 * @head:	the head for your list.

 * @member:	the name of the list_head within the struct.

 get header */

	/* first line will contain the last register

/*

 * Copyright 2013 Advanced Micro Devices, Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Christian König <christian.koenig@amd.com>

/**

 * uvd_v3_1_semaphore_emit - emit semaphore command

 *

 * @rdev: radeon_device pointer

 * @ring: radeon_ring pointer

 * @semaphore: semaphore to emit commands for

 * @emit_wait: true if we should emit a wait command

 *

 * Emit a semaphore command (either wait or signal) to the UVD ring.

/*

 * Copyright © 2007 David Airlie

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice (including the next

 * paragraph) shall be included in all copies or substantial portions of the

 * Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER

 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING

 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER

 * DEALINGS IN THE SOFTWARE.

 *

 * Authors:

 *     David Airlie

/* object hierarchy -

 * this contains a helper + a radeon fb

 * the helper contains a pointer to radeon framebuffer baseclass.

 must be first */

 useful for testing */

 need to align pitch with crtc limits */

 Only 27 bit offset for legacy CRTC */

 avivo can't scanout real 24bpp */

 okay we have an object now allocate the framebuffer */

 radeon resume is fragile and needs a vt switch to help it along */

 setup helper */

 setup aperture base/size for vesafb takeover */

 Use default scratch pixmap (info->pixmap.flags = FB_PIXMAP_SYSTEM) */

 don't enable fbdev if no connectors */

 select 8 bpp console on 8MB cards, or 16 bpp on RN50 or 32MB */

 disable all the possible outputs/crtcs before entering KMS mode */

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

 blend weight */

 radeon pitch is /64 */

 Must wait for 2D idle & clean before DMA or hangs might happen */

		/* FIXME: only allow PACKET3 blit? easier to check for out of

 VAP_VF_MAX_VTX_INDX */

 2D, 3D, CUBE */

 1D/2D */

 CUBE */

 3D */

/*

 * Copyright 2014 Advanced Micro Devices, Inc.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors:

 *    Christian König <christian.koenig@amd.com>

/**

 * radeon_sync_create - zero init sync object

 *

 * @sync: sync object to initialize

 *

 * Just clear the sync object for now.

/**

 * radeon_sync_fence - use the semaphore to sync to a fence

 *

 * @sync: sync object to add fence to

 * @fence: fence to sync to

 *

 * Sync to the fence using the semaphore objects

/**

 * radeon_sync_resv - use the semaphores to sync to a reservation object

 *

 * @rdev: radeon_device pointer

 * @sync: sync object to add fences from reservation object to

 * @resv: reservation object with embedded fence

 * @shared: true if we should only sync to the exclusive fence

 *

 * Sync to the fence using the semaphore objects

 always sync to the exclusive fence */

/**

 * radeon_sync_rings - sync ring to all registered fences

 *

 * @rdev: radeon_device pointer

 * @sync: sync object to use

 * @ring: ring that needs sync

 *

 * Ensure that all registered fences are signaled before letting

 * the ring continue. The caller must hold the ring lock.

 check if we really need to sync */

 prevent GPU deadlocks */

 not enough room, wait manually */

 allocate enough space for sync command */

 emit the signal semaphore */

 signaling wasn't successful wait manually */

 we assume caller has already allocated space on waiters ring */

 waiting wasn't successful wait manually */

/**

 * radeon_sync_free - free the sync object

 *

 * @rdev: radeon_device pointer

 * @sync: sync object to use

 * @fence: fence to use for the free

 *

 * Free the sync object by freeing all semaphores in it.

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

	/* Acer aspire 5560g (CPU: AMD A4-3305M; GPU: AMD Radeon HD 6480g + 7470m)

	 * https://bugzilla.kernel.org/show_bug.cgi?id=74551

	/* Asus K73TA laptop with AMD A6-3400M APU and Radeon 6550 GPU

	 * https://bugzilla.kernel.org/show_bug.cgi?id=51381

	/* Asus K53TK laptop with AMD A6-3420M APU and Radeon 7670m GPU

	 * https://bugzilla.kernel.org/show_bug.cgi?id=51381

	/* Asus K53TK laptop with AMD A6-3420M APU and Radeon 7670m GPU

	 * https://bugs.freedesktop.org/show_bug.cgi?id=101491

	/* Asus K73TK laptop with AMD A6-3420M APU and Radeon 7670m GPU

	 * https://bugzilla.kernel.org/show_bug.cgi?id=51381#c52

 Apply PX quirks */

 disable PX is the system doesn't support dGPU power control or hybrid gfx */

/**

 * radeon_program_register_sequence - program an array of registers.

 *

 * @rdev: radeon_device pointer

 * @registers: pointer to the register array

 * @array_size: size of the register array

 *

 * Programs an array or registers with and and or masks.

 * This is a helper for setting golden registers.

/**

 * radeon_surface_init - Clear GPU surface registers.

 *

 * @rdev: radeon_device pointer

 *

 * Clear GPU surface registers (r1xx-r5xx).

 FIXME: check this out */

 enable surfaces */

/*

 * GPU scratch registers helpers function.

/**

 * radeon_scratch_init - Init scratch register driver information.

 *

 * @rdev: radeon_device pointer

 *

 * Init CP scratch register driver information (r1xx-r5xx)

 FIXME: check this out */

/**

 * radeon_scratch_get - Allocate a scratch register

 *

 * @rdev: radeon_device pointer

 * @reg: scratch register mmio offset

 *

 * Allocate a CP scratch register for use by the driver (all asics).

 * Returns 0 on success or -EINVAL on failure.

/**

 * radeon_scratch_free - Free a scratch register

 *

 * @rdev: radeon_device pointer

 * @reg: scratch register mmio offset

 *

 * Free a CP scratch register allocated for use by the driver (all asics)

/*

 * GPU doorbell aperture helpers function.

/**

 * radeon_doorbell_init - Init doorbell driver information.

 *

 * @rdev: radeon_device pointer

 *

 * Init doorbell driver information (CIK)

 * Returns 0 on success, error on failure.

 doorbell bar mapping */

/**

 * radeon_doorbell_fini - Tear down doorbell driver information.

 *

 * @rdev: radeon_device pointer

 *

 * Tear down doorbell driver information (CIK)

/**

 * radeon_doorbell_get - Allocate a doorbell entry

 *

 * @rdev: radeon_device pointer

 * @doorbell: doorbell index

 *

 * Allocate a doorbell for use by the driver (all asics).

 * Returns 0 on success or -EINVAL on failure.

/**

 * radeon_doorbell_free - Free a doorbell entry

 *

 * @rdev: radeon_device pointer

 * @doorbell: doorbell index

 *

 * Free a doorbell allocated for use by the driver (all asics)

/*

 * radeon_wb_*()

 * Writeback is the method by which the GPU updates special pages

 * in memory with the status of certain GPU events (fences, ring pointers,

 * etc.).

/**

 * radeon_wb_disable - Disable Writeback

 *

 * @rdev: radeon_device pointer

 *

 * Disables Writeback (all asics).  Used for suspend.

/**

 * radeon_wb_fini - Disable Writeback and free memory

 *

 * @rdev: radeon_device pointer

 *

 * Disables Writeback and frees the Writeback memory (all asics).

 * Used at driver shutdown.

/**

 * radeon_wb_init- Init Writeback driver info and allocate memory

 *

 * @rdev: radeon_device pointer

 *

 * Disables Writeback and frees the Writeback memory (all asics).

 * Used at driver startup.

 * Returns 0 on success or an -error on failure.

 clear wb memory */

 disable event_write fences */

 disabled via module param */

 often unreliable on AGP */

 often unreliable on pre-r300 */

 event_write fences are only available on r600+ */

 always use writeback/events on NI, APUs */

/**

 * radeon_vram_location - try to find VRAM location

 * @rdev: radeon device structure holding all necessary informations

 * @mc: memory controller structure holding memory informations

 * @base: base address at which to put VRAM

 *

 * Function will place try to place VRAM at base address provided

 * as parameter (which is so far either PCI aperture address or

 * for IGP TOM base address).

 *

 * If there is not enough space to fit the unvisible VRAM in the 32bits

 * address space then we limit the VRAM size to the aperture.

 *

 * If we are using AGP and if the AGP aperture doesn't allow us to have

 * room for all the VRAM than we restrict the VRAM to the PCI aperture

 * size and print a warning.

 *

 * This function will never fails, worst case are limiting VRAM.

 *

 * Note: GTT start, end, size should be initialized before calling this

 * function on AGP platform.

 *

 * Note 1: We don't explicitly enforce VRAM start to be aligned on VRAM size,

 * this shouldn't be a problem as we are using the PCI aperture as a reference.

 * Otherwise this would be needed for rv280, all r3xx, and all r4xx, but

 * not IGP.

 *

 * Note 2: we use mc_vram_size as on some board we need to program the mc to

 * cover the whole aperture even if VRAM size is inferior to aperture size

 * Novell bug 204882 + along with lots of ubuntu ones

 *

 * Note 3: when limiting vram it's safe to overwritte real_vram_size because

 * we are not in case where real_vram_size is inferior to mc_vram_size (ie

 * note afected by bogus hw of Novell bug 204882 + along with lots of ubuntu

 * ones)

 *

 * Note 4: IGP TOM addr should be the same as the aperture addr, we don't

 * explicitly check for that thought.

 *

 * FIXME: when reducing VRAM size align new size on power of 2.

/**

 * radeon_gtt_location - try to find GTT location

 * @rdev: radeon device structure holding all necessary informations

 * @mc: memory controller structure holding memory informations

 *

 * Function will place try to place GTT before or after VRAM.

 *

 * If GTT size is bigger than space left then we ajust GTT size.

 * Thus function will never fails.

 *

 * FIXME: when reducing GTT size align new size on power of 2.

/*

 * GPU helpers function.

/*

 * radeon_device_is_virtual - check if we are running is a virtual environment

 *

 * Check if the asic has been passed through to a VM (all asics).

 * Used at driver startup.

 * Returns true if virtual or false if not.

/**

 * radeon_card_posted - check if the hw has already been initialized

 *

 * @rdev: radeon_device pointer

 *

 * Check if the asic has been initialized (all asics).

 * Used at driver startup.

 * Returns true if initialized or false if not.

 for pass through, always force asic_init for CI */

 required for EFI mode on macbook2,1 which uses an r5xx asic */

 first check CRTCs */

 then check MEM_SIZE, in case the crtcs are off */

/**

 * radeon_update_bandwidth_info - update display bandwidth params

 *

 * @rdev: radeon_device pointer

 *

 * Used when sclk/mclk are switched or display modes are set.

 * params are used to calculate display watermarks (all asics)

 sclk/mclk in Mhz */

 core_bandwidth = sclk(Mhz) * 16 */

/**

 * radeon_boot_test_post_card - check and possibly initialize the hw

 *

 * @rdev: radeon_device pointer

 *

 * Check if the asic is initialized and if not, attempt to initialize

 * it (all asics).

 * Returns true if initialized or false if not.

/**

 * radeon_dummy_page_init - init dummy page used by the driver

 *

 * @rdev: radeon_device pointer

 *

 * Allocate the dummy page used by the driver (all asics).

 * This dummy page is used by the driver as a filler for gart entries

 * when pages are taken out of the GART

 * Returns 0 on sucess, -ENOMEM on failure.

/**

 * radeon_dummy_page_fini - free dummy page used by the driver

 *

 * @rdev: radeon_device pointer

 *

 * Frees the dummy page used by the driver (all asics).

 ATOM accessor methods */

/*

 * ATOM is an interpreted byte code stored in tables in the vbios.  The

 * driver registers callbacks to access registers and the interpreter

 * in the driver parses the tables and executes then to program specific

 * actions (set display modes, asic init, etc.).  See radeon_atombios.c,

 * atombios.h, and atom.c

/**

 * cail_pll_read - read PLL register

 *

 * @info: atom card_info pointer

 * @reg: PLL register offset

 *

 * Provides a PLL register accessor for the atom interpreter (r4xx+).

 * Returns the value of the PLL register.

/**

 * cail_pll_write - write PLL register

 *

 * @info: atom card_info pointer

 * @reg: PLL register offset

 * @val: value to write to the pll register

 *

 * Provides a PLL register accessor for the atom interpreter (r4xx+).

/**

 * cail_mc_read - read MC (Memory Controller) register

 *

 * @info: atom card_info pointer

 * @reg: MC register offset

 *

 * Provides an MC register accessor for the atom interpreter (r4xx+).

 * Returns the value of the MC register.

/**

 * cail_mc_write - write MC (Memory Controller) register

 *

 * @info: atom card_info pointer

 * @reg: MC register offset

 * @val: value to write to the pll register

 *

 * Provides a MC register accessor for the atom interpreter (r4xx+).

/**

 * cail_reg_write - write MMIO register

 *

 * @info: atom card_info pointer

 * @reg: MMIO register offset

 * @val: value to write to the pll register

 *

 * Provides a MMIO register accessor for the atom interpreter (r4xx+).

/**

 * cail_reg_read - read MMIO register

 *

 * @info: atom card_info pointer

 * @reg: MMIO register offset

 *

 * Provides an MMIO register accessor for the atom interpreter (r4xx+).

 * Returns the value of the MMIO register.

/**

 * cail_ioreg_write - write IO register

 *

 * @info: atom card_info pointer

 * @reg: IO register offset

 * @val: value to write to the pll register

 *

 * Provides a IO register accessor for the atom interpreter (r4xx+).

/**

 * cail_ioreg_read - read IO register

 *

 * @info: atom card_info pointer

 * @reg: IO register offset

 *

 * Provides an IO register accessor for the atom interpreter (r4xx+).

 * Returns the value of the IO register.

/**

 * radeon_atombios_init - init the driver info and callbacks for atombios

 *

 * @rdev: radeon_device pointer

 *

 * Initializes the driver info and register access callbacks for the

 * ATOM interpreter (r4xx+).

 * Returns 0 on sucess, -ENOMEM on failure.

 * Called at driver startup.

 needed for iio ops */

/**

 * radeon_atombios_fini - free the driver info and callbacks for atombios

 *

 * @rdev: radeon_device pointer

 *

 * Frees the driver info and register access callbacks for the ATOM

 * interpreter (r4xx+).

 * Called at driver shutdown.

 COMBIOS */

/*

 * COMBIOS is the bios format prior to ATOM. It provides

 * command tables similar to ATOM, but doesn't have a unified

 * parser.  See radeon_combios.c

/**

 * radeon_combios_init - init the driver info for combios

 *

 * @rdev: radeon_device pointer

 *

 * Initializes the driver info for combios (r1xx-r3xx).

 * Returns 0 on sucess.

 * Called at driver startup.

/**

 * radeon_combios_fini - free the driver info for combios

 *

 * @rdev: radeon_device pointer

 *

 * Frees the driver info for combios (r1xx-r3xx).

 * Called at driver shutdown.

 if we get transitioned to only one device, take VGA back */

/**

 * radeon_vga_set_decode - enable/disable vga decode

 *

 * @pdev: PCI device

 * @state: enable/disable vga decode

 *

 * Enable/disable vga decode (all asics).

 * Returns VGA resource flags.

/**

 * radeon_check_pot_argument - check that argument is a power of two

 *

 * @arg: value to check

 *

 * Validates that a certain argument is a power of two (all asics).

 * Returns true if argument is valid.

/**

 * radeon_gart_size_auto - Determine a sensible default GART size

 *                         according to ASIC family.

 *

 * @family: ASIC family name

 default to a larger gart size on newer asics */

/**

 * radeon_check_arguments - validate module params

 *

 * @rdev: radeon_device pointer

 *

 * Validates certain module parameters and updates

 * the associated values used by the driver (all asics).

 vramlimit must be a power of two */

 gtt size must be power of two and greater or equal to 32M */

 AGP mode can only be -1, 1, 2, 4, 8 */

	/*

	 * Max GPUVM size for Cayman, SI and CI are 40 bits.

	/* defines number of bits in page table versus page directory,

	 * a page is 4KB so we have 12 bits offset, minimum 9 bits in the

 Total bits covered by PD + PTs */

		/* Make sure the PD is 4K in size up to 8GB address space.

/**

 * radeon_switcheroo_set_state - set switcheroo state

 *

 * @pdev: pci dev pointer

 * @state: vga_switcheroo state

 *

 * Callback for the switcheroo driver.  Suspends or resumes the

 * the asics before or after it is powered up using ACPI methods.

 don't suspend or resume card normally */

/**

 * radeon_switcheroo_can_switch - see if switcheroo state can change

 *

 * @pdev: pci dev pointer

 *

 * Callback for the switcheroo driver.  Check of the switcheroo

 * state can be changed.

 * Returns true if the state can be changed, false if not.

	/*

	 * FIXME: open_count is protected by drm_global_mutex but that would lead to

	 * locking inversion with the driver load path. And the access here is

	 * completely racy anyway. So don't bother with locking for now.

/**

 * radeon_device_init - initialize the driver

 *

 * @rdev: radeon_device pointer

 * @ddev: drm dev pointer

 * @pdev: pci dev pointer

 * @flags: driver flags

 *

 * Initializes the driver info and hw (all asics).

 * Returns 0 for success or an error on failure.

 * Called at driver startup.

 set up ring ids */

	/* mutex initialization are all done here so we

	/* Adjust VM size here.

	 * Max GPUVM size for cayman+ is 40 bits.

 Set asic functions */

	/* all of the newer IGP chips have an internal gart

	 * However some rs4xx report as AGP, so remove that here.

	/* Set the internal MC address mask

	 * This is the max address of the GPU's

	 * internal address space.

 40 bit MC */

 36 bit MC */

 32 bit MC */

	/* set DMA mask.

	 * PCIE - can handle 40-bits.

	 * IGP - can handle 40-bits

	 * AGP - generally dma32 is safest

	 * PCI - dma32 for legacy pci gart, 40 bits on newer asics

 Registers mapping */

 TODO: block userspace mapping of io register */

 doorbell bar mapping */

 io port mapping */

 if we have > 1 VGA cards, then disable the radeon VGA resources */

	/* this will fail for cards that aren't VGA class devices, just

		/* Acceleration not working on AGP card try again

		 * with fallback to PCI or PCIE GART

	/*

	 * Turks/Thames GPU will freeze whole laptop if DPM is not restarted

	 * after the CP ring have chew one packet at least. Hence here we stop

	 * and restart DPM after the radeon_ib_ring_tests().

 balance pm_runtime_get_sync() in radeon_driver_unload_kms() */

/**

 * radeon_device_fini - tear down the driver

 *

 * @rdev: radeon_device pointer

 *

 * Tear down the driver info (all asics).

 * Called at driver shutdown.

 evict vram memory */

/*

 * Suspend & resume.

/*

 * radeon_suspend_kms - initiate device suspend

 *

 * Puts the hw in the suspend state (all asics).

 * Returns 0 for success or an error on failure.

 * Called at driver suspend.

 turn off display hw */

 unpin the front buffers and cursors */

 don't unpin kernel fb objects */

 evict vram memory */

 wait for gpu to finish processing current batch */

 delay GPU reset to resume */

	/* evict remaining vram memory

	 * This second call to evict vram is to evict the gart page table

	 * using the CPU.

 Shut down the device */

/*

 * radeon_resume_kms - initiate device resume

 *

 * Bring the hw back to operating state (all asics).

 * Returns 0 for success or an error on failure.

 * Called at driver resume.

 resume AGP if in use */

 do dpm late init */

 resume old pm late */

 pin cursors */

 Only 27 bit offset for legacy cursor */

 init dig PHYs, disp eng pll */

 turn on the BL */

 reset hpd state */

 blat the mode back in */

 turn on display hw */

 set the power state here in case we are a PX system or headless */

/**

 * radeon_gpu_reset - reset the asic

 *

 * @rdev: radeon device pointer

 *

 * Attempt the reset the GPU if it has hung (all asics).

 * Returns 0 for success or an error on failure.

 block TTM */

 do dpm late init */

 resume old pm late */

 init dig PHYs, disp eng pll */

 turn on the BL */

 reset hpd state */

 set the power state here in case we are a PX system or headless */

 bad news, how to tell it to userspace ? */

/*

 * Copyright 2014 Advanced Micro Devices, Inc.

 * All Rights Reserved.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors:

 *    Christian König <christian.koenig@amd.com>

/**

 * radeon_mn_invalidate - callback to notify about mm change

 *

 * @mn: our notifier

 * @range: the VMA under invalidation

 * @cur_seq: Value to pass to mmu_interval_set_seq()

 *

 * We block for all BOs between start and end to be idle and

 * unmap them by move them into system domain again.

/**

 * radeon_mn_register - register a BO for notifier updates

 *

 * @bo: radeon buffer object

 * @addr: userptr addr we should monitor

 *

 * Registers an MMU notifier for the given BO at the specified address.

 * Returns 0 on success, -ERRNO if anything goes wrong.

	/*

	 * FIXME: radeon appears to allow get_user_pages to run during

	 * invalidate_range_start/end, which is not a safe way to read the

	 * PTEs. It should use the mmu_interval_read_begin() scheme around the

	 * get_user_pages to ensure that the PTEs are read properly

/**

 * radeon_mn_unregister - unregister a BO for notifier updates

 *

 * @bo: radeon buffer object

 *

 * Remove any registration of MMU notifier updates from the buffer object.

/*

 * Copyright 2008 Advanced Micro Devices, Inc.

 * Copyright 2008 Red Hat Inc.

 * Copyright 2009 Jerome Glisse.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL

 * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR

 * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,

 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR

 * OTHER DEALINGS IN THE SOFTWARE.

 *

 * Authors: Dave Airlie

 *          Alex Deucher

 *          Jerome Glisse

/*

 * Registers accessors functions.

/**

 * radeon_invalid_rreg - dummy reg read function

 *

 * @rdev: radeon device pointer

 * @reg: offset of register

 *

 * Dummy register read function.  Used for register blocks

 * that certain asics don't have (all asics).

 * Returns the value in the register.

/**

 * radeon_invalid_wreg - dummy reg write function

 *

 * @rdev: radeon device pointer

 * @reg: offset of register

 * @v: value to write to the register

 *

 * Dummy register read function.  Used for register blocks

 * that certain asics don't have (all asics).

/**

 * radeon_register_accessor_init - sets up the register accessor callbacks

 *

 * @rdev: radeon device pointer

 *

 * Sets up the register accessor callbacks for various register

 * apertures.  Not all asics have all apertures (all asics).

 Don't change order as we are overridding accessor. */

 FIXME: not sure here */

 helper to disable agp */

/**

 * radeon_agp_disable - AGP disable helper function

 *

 * @rdev: radeon device pointer

 *

 * Removes AGP flags and changes the gart callbacks on AGP

 * cards when using the internal gart rather than AGP (all asics).

/*

 * ASIC

/**

 * radeon_asic_init - register asic specific callbacks

 *

 * @rdev: radeon device pointer

 *

 * Registers the appropriate asic specific callbacks for each

 * chip family.  Also sets other asics specific info like the number

 * of crtcs and the register aperture accessors (all asics).

 * Returns 0 for success.

 set the number of crtcs */

 handle macs */

 760G/780V/880V don't have UVD */

 set num crtcs */

 set num crtcs */

 set num crtcs */

 set num crtcs */

 set num crtcs */

RADEON_CG_SUPPORT_GFX_CGCG |*/

RADEON_CG_SUPPORT_GFX_CGCG |*/

RADEON_CG_SUPPORT_GFX_CGCG |*/

RADEON_PG_SUPPORT_GFX_PG | */

RADEON_CG_SUPPORT_GFX_CGCG |*/

RADEON_CG_SUPPORT_GFX_CGCG |*/

RADEON_CG_SUPPORT_GFX_CGCG |*/

RADEON_CG_SUPPORT_GFX_CGCG |*/

 set num crtcs */

RADEON_CG_SUPPORT_GFX_CGCG |*/

				/*RADEON_PG_SUPPORT_GFX_PG |

				RADEON_PG_SUPPORT_GFX_SMG |

				RADEON_PG_SUPPORT_GFX_DMG |

				RADEON_PG_SUPPORT_UVD |

				RADEON_PG_SUPPORT_VCE |

				RADEON_PG_SUPPORT_CP |

				RADEON_PG_SUPPORT_GDS |

				RADEON_PG_SUPPORT_RLC_SMU_HS |

				RADEON_PG_SUPPORT_ACP |

RADEON_CG_SUPPORT_GFX_CGCG |*/

				/*RADEON_PG_SUPPORT_GFX_PG |

				RADEON_PG_SUPPORT_GFX_SMG |

				RADEON_PG_SUPPORT_UVD |

				RADEON_PG_SUPPORT_VCE |

				RADEON_PG_SUPPORT_CP |

				RADEON_PG_SUPPORT_GDS |

				RADEON_PG_SUPPORT_RLC_SMU_HS |

 FIXME: not supported yet */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

 *  Rewritten from the dovefb driver, and Armada510 manuals.

 Docs say 15:0, but it seems to actually be 31:16 on Armada 510 */

	/*

	 * The CFG_CSC_RGB_* settings control the output of the colour space

	 * converter, setting the range of output values it produces.  Since

	 * we will be blending with the full-range graphics, we need to

	 * produce full-range RGB output from the conversion.

 === Plane support === */

 FIXME: overlay on an interlaced display */

		/*

		 * Shifting a YUV packed format image by one pixel causes the

		 * U/V planes to swap.  Compensate for it by also toggling

		 * the UV swap.

 Disable plane and power down the YUV FIFOs */

 Do best-efforts here for this property */

 If min != max, or min != val, error out */

 SPDX-License-Identifier: GPL-2.0

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

 *  Rewritten from the dovefb driver, and Armada510 manuals.

 Disable plane and power down most RAMs and FIFOs */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

 *  Rewritten from the dovefb driver, and Armada510 manuals.

/*

 * A note about interlacing.  Let's consider HDMI 1920x1080i.

 * The timing parameters we have from X are:

 *  Hact HsyA HsyI Htot  Vact VsyA VsyI Vtot

 *  1920 2448 2492 2640  1080 1084 1094 1125

 * Which get translated to:

 *  Hact HsyA HsyI Htot  Vact VsyA VsyI Vtot

 *  1920 2448 2492 2640   540  542  547  562

 *

 * This is how it is defined by CEA-861-D - line and pixel numbers are

 * referenced to the rising edge of VSYNC and HSYNC.  Total clocks per

 * line: 2640.  The odd frame, the first active line is at line 21, and

 * the even frame, the first active line is 584.

 *

 * LN:    560     561     562     563             567     568    569

 * DE:    ~~~|____________________________//__________________________

 * HSYNC: ____|~|_____|~|_____|~|_____|~|_//__|~|_____|~|_____|~|_____

 * VSYNC: _________________________|~~~~~~//~~~~~~~~~~~~~~~|__________

 *  22 blanking lines.  VSYNC at 1320 (referenced to the HSYNC rising edge).

 *

 * LN:    1123   1124    1125      1               5       6      7

 * DE:    ~~~|____________________________//__________________________

 * HSYNC: ____|~|_____|~|_____|~|_____|~|_//__|~|_____|~|_____|~|_____

 * VSYNC: ____________________|~~~~~~~~~~~//~~~~~~~~~~|_______________

 *  23 blanking lines

 *

 * The Armada LCD Controller line and pixel numbers are, like X timings,

 * referenced to the top left of the active frame.

 *

 * So, translating these to our LCD controller:

 *  Odd frame, 563 total lines, VSYNC at line 543-548, pixel 1128.

 *  Even frame, 562 total lines, VSYNC at line 542-547, pixel 2448.

 * Note: Vsync front porch remains constant!

 *

 * if (odd_frame) {

 *   vtotal = mode->crtc_vtotal + 1;

 *   vbackporch = mode->crtc_vsync_start - mode->crtc_vdisplay + 1;

 *   vhorizpos = mode->crtc_hsync_start - mode->crtc_htotal / 2

 * } else {

 *   vtotal = mode->crtc_vtotal;

 *   vbackporch = mode->crtc_vsync_start - mode->crtc_vdisplay;

 *   vhorizpos = mode->crtc_hsync_start;

 * }

 * vfrontporch = mode->crtc_vtotal - mode->crtc_vsync_end;

 *

 * So, we need to reprogram these registers on each vsync event:

 *  LCD_SPU_V_PORCH, LCD_SPU_ADV_REG, LCD_SPUT_V_H_TOTAL

 *

 * Note: we do not use the frame done interrupts because these appear

 * to happen too early, and lead to jitter on the display (presumably

 * they occur at the end of the last active line, before the vsync back

 * porch, which we're reprogramming.)

	/*

	 * When the dumb interface isn't in DUMB24_RGB888_0 mode, it might

	 * be using SPI or GPIO.  If we set this to DUMB_BLANK, we will

	 * force LCD_D[23:0] to output blank color, overriding the GPIO or

	 * SPI usage.  So leave it as-is unless in DUMB24_RGB888_0 mode.

 If we have an event, we need vblank events enabled */

 We can't do interlaced modes if we don't have the SPU_ADV_REG */

 The mode_config.mutex will be held for this call */

	/*

	 * Set CRTC modesetting parameters for the adjusted mode.  This is

	 * applied after the connectors, bridges, and encoders have fixed up

	 * this mode, as described above drm_atomic_helper_check_modeset().

	/*

	 * Validate the adjusted mode in case an encoder/bridge has set

	 * something we don't support.

 Check whether the display mode is possible */

 These are locked by dev->vbl_lock */

	/*

	 * Reading the ISR appears to clear bits provided CLEAN_SPU_IRQ_ISR

	 * is set.  Writing has some other effect to acknowledge the IRQ -

	 * without this, we only get a single IRQ.

 Mask out those interrupts we haven't enabled */

 The mode_config.mutex will be held for this call */

 Now compute the divider for real */

 Even interlaced/progressive frame */

 Odd interlaced frame */

	/*

	 * The documentation doesn't indicate what the normal state of

	 * the sync signals are.  Sebastian Hesselbart kindly probed

	 * these signals on his board to determine their state.

	 *

	 * The non-inverted state of the sync signals is active high.

	 * Setting these bits makes the appropriate signal active low.

	/*

	 * If we aren't doing a full modeset, then we need to queue

	 * the event here.

		/*

		 * This modeset will be leaving the CRTC disabled, so

		 * call the backend to disable upstream clocks etc.

		/*

		 * We will not receive any further vblank events.

		 * Send the flip_done event manually.

		/*

		 * This modeset is enabling the CRTC after it having

		 * been disabled.  Reverse the call to ->disable in

		 * the atomic_disable().

			/*

			 * In "ARGB888" (HWC32) mode, writing to the SRAM

			 * requires these bits to contain:

			 * 31:24 = alpha 23:16 = blue 15:8 = green 7:0 = red

			 * So, it's actually ABGR8888.  This is independent

			 * of the SWAPRB bits in DMA control register 0.

 write the default value */

	/*

	 * Calculate the visible width and height of the cursor,

	 * screen position, and the position in the cursor bitmap.

 On interlaced modes, the vertical cursor size must be halved */

	/*

	 * Initialize the transparency if the SRAM was powered down.

	 * We must also reload the cursor data as well.

 Set the top-left corner of the cursor image */

 Reload the cursor position, size and enable in the IRQ handler */

 If no cursor support, replicate drm's return value */

 maximum size is 64x32 or 32x64 */

 Must be a kernel-mapped object */

 If no cursor support, replicate drm's return value */

 These are called under the vbl_lock. */

 requested clk input

 actual clk input

 actual pixel clk

 If the clock can do exactly the desired rate, we're done */

 Calculate the divider - if invalid, we can't do this rate */

 Calculate the actual rate - HDMI requires -0.6%..+0.5% */

 Avoid repeated division */

 Initialize some registers which we don't otherwise set */

 Ensure AXI pipeline is enabled */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

 *  Written from the i915 driver.

	/*

	 * A reference is now held by the framebuffer object if

	 * successful, otherwise this drops the ref for the error path.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

 *  Rewritten from the dovefb driver, and Armada510 manuals.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

	/*

	 * Take a reference on our object as we're successful - the

	 * caller already holds a reference, which keeps us safe for

	 * the above call, but the caller will drop their reference

	 * to it.  Hence we need to take our own reference.

 We can only handle a single plane at the moment */

 Framebuffer objects must have a valid device address for scanout */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

 page backed memory */

 linear backed memory */

 We only ever display imported data */

	/*

	 * If it is a small allocation (typically cursor, which will

	 * be 32x64 or 64x32 ARGB pixels) try to get it from the system.

	 * Framebuffers will never be this small (our minimum size for

	 * framebuffers is larger than this anyway.)  Such objects are

	 * only accessed by the CPU so we don't need any special handing

	 * here.

	/*

	 * We could grab something from CMA if it's enabled, but that

	 * involves building in a problem:

	 *

	 * CMA's interface uses dma_alloc_coherent(), which provides us

	 * with an CPU virtual address and a device address.

	 *

	 * The CPU virtual address may be either an address in the kernel

	 * direct mapped region (for example, as it would be on x86) or

	 * it may be remapped into another part of kernel memory space

	 * (eg, as it would be on ARM.)  This means virt_to_phys() on the

	 * returned virtual address is invalid depending on the architecture

	 * implementation.

	 *

	 * The device address may also not be a physical address; it may

	 * be that there is some kind of remapping between the device and

	 * system RAM, which makes the use of the device address also

	 * unsafe to re-use as a physical address.

	 *

	 * This makes DRM usage of dma_alloc_coherent() in a generic way

	 * at best very questionable and unsafe.

 Otherwise, grab it from our linear allocation */

 Ensure that the memory we're returning is cleared. */

 only linear objects need to be ioremap'd */

 Dumb alloc support */

 drop reference from allocate - handle holds it now */

 Private driver gem ioctls */

 drop reference from allocate - handle holds it now */

 Map a shmem-backed object into process memory space */

 Must be a kernel-mapped object */

 Prime support */

 Single contiguous page */

 Single contiguous physical region - no struct page */

			/*

			 * Importing our own dmabuf(s) increases the

			 * refcount on the gem object itself.

	/*

	 * Don't call dma_buf_map_attachment() here - it maps the

	 * scatterlist immediately for DMA, and this is not always

	 * an appropriate thing to do.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

 Resources above 64K are graphics memory */

 Remove early framebuffers */

 Mode setting support */

	/*

	 * With vscale enabled, the maximum width is 1920 due to the

	 * 1920 by 3 lines RAM

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Russell King

 *

 * Armada 510 (aka Dove) variant support

	/*

	 * Lower the watermark so to eliminate jitter at higher bandwidths.

	 * Disable SRAM read wait state to avoid system hang with external

	 * clock.

 Initialise SPU register */

 HDMI requires -0.6%..+0.5% */

/*

 * Armada510 specific SCLK register selection.

 * This gets called with sclk = NULL to test whether the mode is

 * supportable, and again with sclk != NULL to set the clocks up for

 * that.  The former can return an error, but the latter is expected

 * not to.

 We are now using this clock */

 SPDX-License-Identifier: MIT

 Copyright (C) 2006-2017 Oracle Corporation */

/**

 * hgsmi_report_flags_location - Inform the host of the location of

 *                               the host flags in VRAM via an HGSMI cmd.

 * Return: 0 or negative errno value.

 * @ctx:        The context of the guest heap to use.

 * @location:   The offset chosen for the flags within guest VRAM.

/**

 * hgsmi_send_caps_info - Notify the host of HGSMI-related guest capabilities

 *                        via an HGSMI command.

 * Return: 0 or negative errno value.

 * @ctx:        The context of the guest heap to use.

 * @caps:       The capabilities to report, see vbva_caps.

/**

 * hgsmi_query_conf - Query the host for an HGSMI configuration

 *                    parameter via an HGSMI command.

 * Return: 0 or negative errno value.

 * @ctx:        The context containing the heap used.

 * @index:      The index of the parameter to query.

 * @value_ret:  Where to store the value of the parameter on success.

/**

 * hgsmi_update_pointer_shape - Pass the host a new mouse pointer shape

 *                              via an HGSMI command.

 * Return: 0 or negative errno value.

 * @ctx:        The context containing the heap to be used.

 * @flags:      Cursor flags.

 * @hot_x:      Horizontal position of the hot spot.

 * @hot_y:      Vertical position of the hot spot.

 * @width:      Width in pixels of the cursor.

 * @height:     Height in pixels of the cursor.

 * @pixels:     Pixel data, @see VMMDevReqMousePointer for the format.

 * @len:        Size in bytes of the pixel data.

		/*

		 * Size of the pointer data:

		 * sizeof (AND mask) + sizeof (XOR_MASK)

		/*

		 * If shape is supplied, then always create the pointer visible.

		 * See comments in 'vboxUpdatePointerShape'

/**

 * hgsmi_cursor_position - Report the guest cursor position.  The host may

 *                         wish to use this information to re-position its

 *                         own cursor (though this is currently unlikely).

 *                         The current host cursor position is returned.

 * Return: 0 or negative errno value.

 * @ctx:              The context containing the heap used.

 * @report_position:  Are we reporting a position?

 * @x:                Guest cursor X position.

 * @y:                Guest cursor Y position.

 * @x_host:           Host cursor X position is stored here.  Optional.

 * @y_host:           Host cursor Y position is stored here.  Optional.

 SPDX-License-Identifier: MIT

/*

 * Copyright (C) 2017 Oracle Corporation

 * Authors: Hans de Goede <hdegoede@redhat.com>

www.burtleburtle.net/bob/hash/doobs.html */

 Not really a checksum but that is the naming used in all vbox code */

 4 -> Do not checksum the checksum itself */

 Make the compiler aware that the host has changed memory. */

 SPDX-License-Identifier: MIT

 Copyright (C) 2006-2017 Oracle Corporation */

/**

 * hgsmi_process_display_info - Set a video mode via an HGSMI request.

 *                              The views must have been initialised first

 *                              using @a VBoxHGSMISendViewInfo and if the mode

 *                              is being set on the first display then it must

 *                              be set first using registers.

 * @ctx:           The context containing the heap to use.

 * @display:       The screen number.

 * @origin_x:      The horizontal displacement relative to the first scrn.

 * @origin_y:      The vertical displacement relative to the first screen.

 * @start_offset:  The offset of the visible area of the framebuffer

 *                 relative to the framebuffer start.

 * @pitch:         The offset in bytes between the starts of two adjecent

 *                 scan lines in video RAM.

 * @width:         The mode width.

 * @height:        The mode height.

 * @bpp:           The colour depth of the mode.

 * @flags:         Flags.

/**

 * hgsmi_update_input_mapping - Report the rectangle relative to which absolute

 *                              pointer events should be expressed.  This

 *                              information remains valid until the next VBVA

 *                              resize event for any screen, at which time it is

 *                              reset to the bounding rectangle of all virtual

 *                              screens.

 * Return: 0 or negative errno value.

 * @ctx:       The context containing the heap to use.

 * @origin_x:  Upper left X co-ordinate relative to the first screen.

 * @origin_y:  Upper left Y co-ordinate relative to the first screen.

 * @width:     Rectangle width.

 * @height:    Rectangle height.

/**

 * hgsmi_get_mode_hints - Get most recent video mode hints.

 * Return: 0 or negative errno value.

 * @ctx:      The context containing the heap to use.

 * @screens:  The number of screens to query hints for, starting at 0.

 * @hints:    Array of vbva_modehint structures for receiving the hints.

 SPDX-License-Identifier: MIT

/*

 * Copyright (C) 2016-2017 Oracle Corporation

 * This file is based on qxl_irq.c

 * Copyright 2013 Red Hat Inc.

 * Authors: Dave Airlie

 *          Alon Levy

 *          Michael Thayer <michael.thayer@oracle.com,

 *          Hans de Goede <hdegoede@redhat.com>

	/*

	 * Due to a bug in the initial host implementation of hot-plug irqs,

	 * the hot-plug and cursor capability flags were never cleared.

	 * Fortunately we can tell when they would have been set by checking

	 * that the VSYNC flag is not set.

/*

 * Check that the position hints provided by the host are suitable for GNOME

 * shell (i.e. all screens disjoint and hints for all enabled screens) and if

 * not replace them with default ones.  Providing valid hints improves the

 * chances that we will get a known screen layout for pointer mapping.

 Query the host for the most recent video mode hints. */

 PCI devices require shared interrupts. */

 SPDX-License-Identifier: MIT

/*

 * Copyright (C) 2013-2017 Oracle Corporation

 * This file is based on ast_drv.c

 * Copyright 2012 Red Hat Inc.

 * Authors: Dave Airlie <airlied@redhat.com>

 *          Michael Thayer <michael.thayer@oracle.com,

 *          Hans de Goede <hdegoede@redhat.com>

 SPDX-License-Identifier: MIT

/*

 * Copyright (C) 2013-2017 Oracle Corporation

 * This file is based on ast_mode.c

 * Copyright 2012 Red Hat Inc.

 * Parts based on xf86-video-ast

 * Copyright (c) 2005 ASPEED Technology Inc.

 * Authors: Dave Airlie <airlied@redhat.com>

 *          Michael Thayer <michael.thayer@oracle.com,

 *          Hans de Goede <hdegoede@redhat.com>

/*

 * Set a graphics mode.  Poke any required values into registers, do an HGSMI

 * mode set and tell the host we support advanced graphics functions.

	/*

	 * This is the old way of setting graphics modes.  It assumed one screen

	 * and a frame-buffer at the start of video RAM.  On older versions of

	 * VirtualBox, certain parts of the code still assume that the first

	 * screen is programmed this way, so try to fake it.

	/*

	 * Tell the host about the view.  This design originally targeted the

	 * Windows XP driver architecture and assumed that each screen would

	 * have a dedicated frame buffer with the command buffer following it,

	 * the whole being a "view".  The host works out which screen a command

	 * buffer belongs to by checking whether it is in the first view, then

	 * whether it is in the second and so on.  The first match wins.  We

	 * cheat around this by making the first view be the managed memory

	 * plus the first command buffer, the second the same plus the second

	 * buffer and so on.

/*

 * Try to map the layout of virtual screens to the range of the input device.

 * Return true if we need to re-set the crtc modes due to screen offset

 * changes.

	/*

	 * Are we using an X.Org-style single large frame-buffer for all crtcs?

	 * If so then screen layout can be deduced from the crtc offsets.

	 * Same fall-back if this is the fbdev frame-buffer.

 Otherwise calculate the total span of all screens. */

 vbox_do_modeset() checks vbox->single_framebuffer so update it now */

 .gamma_set = vbox_crtc_gamma_set, */

 Send information about dirty rectangles to VBVA. */

 vbox_do_modeset checks plane->state->fb and will disable if NULL */

/*

 * Copy the ARGB image and generate the mask, which is needed in case the host

 * does not support ARGB cursors.  The mask is a 1BPP bitmap with the bit set

 * if the corresponding alpha value in the ARGB image is greater than 0xF0.

 TODO: Use mapping abstraction properly */

	/*

	 * VirtualBox uses the host windowing system to draw the cursor so

	 * moves are a no-op, we only need to upload new cursor sprites.

	/*

	 * The mask must be calculated based on the alpha

	 * channel, one bit per ARGB word, and must be 32-bit

	 * padded.

/*

 * Generate EDID data with a mode-unique serial number for the virtual

 * monitor to try to persuade Unity that different modes correspond to

 * different monitors and it should not try to force the same resolution on

 * them.

 header */

 manufacturer (VBX) */

 product code */

 serial number goes here */

 week of manufacture */

 year of manufacture */

 EDID version */

 capabilities - digital */

 horiz. res in cm, zero for projectors */

 vert. res in cm */

 display gamma (120 == 2.2). */

 features (standby, suspend, off, RGB, std */

 colour space, preferred timing mode) */

 chromaticity for standard colour space. */

 no default timings */

 no standard timings */

 descriptor block 1 goes below */

 descriptor block 2, monitor ranges */

 0-200Hz vertical, 0-200KHz horizontal, 1000MHz pixel clock */

 descriptor block 3, monitor name */

 descriptor block 4: dummy data */

 number of extensions */

 checksum goes here */

 SPDX-License-Identifier: MIT

/*

 * Copyright (C) 2013-2017 Oracle Corporation

 * This file is based on ast_main.c

 * Copyright 2012 Red Hat Inc.

 * Authors: Dave Airlie <airlied@redhat.com>,

 *          Michael Thayer <michael.thayer@oracle.com,

 *          Hans de Goede <hdegoede@redhat.com>

 The host only accepts VIDEO_MODE_HINTS if it is send separately. */

 Take a command buffer for each screen from the end of usable VRAM. */

 very old host or driver error. */

 Do we support the 4.3 plus mode hint reporting interface? */

 Map guest-heap at end of vram */

 Create guest-heap mem-pool use 2^4 = 16 byte chunks */

 Reduce available VRAM size to reflect the guest heap. */

 Linux drm represents monitors as a 32-bit array. */

 SPDX-License-Identifier: MIT

 Copyright (C) 2006-2017 Oracle Corporation */

/*

 * There is a hardware ring buffer in the graphics device video RAM, formerly

 * in the VBox VMMDev PCI memory space.

 * All graphics commands go there serialized by vbva_buffer_begin_update.

 * and vbva_buffer_end_update.

 *

 * free_offset is writing position. data_offset is reading position.

 * free_offset == data_offset means buffer is empty.

 * There must be always gap between data_offset and free_offset when data

 * are in the buffer.

 * Guest only changes free_offset, host changes data_offset.

 Chunk will not cross buffer boundary. */

 Chunk crosses buffer boundary. */

 Flush if all slots in the records queue are used */

 If even after flush there is no place then fail the request */

 Remember which record we are using. */

 Mark the record completed. */

 SPDX-License-Identifier: MIT

/*

 * Copyright (C) 2013-2017 Oracle Corporation

 * This file is based on ast_ttm.c

 * Copyright 2012 Red Hat Inc.

 * Authors: Dave Airlie <airlied@redhat.com>

 *          Michael Thayer <michael.thayer@oracle.com>

 Don't fail on errors, but performance might be reduced. */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) STMicroelectronics SA 2017

 *

 * Authors: Philippe Cornu <philippe.cornu@st.com>

 *          Yannick Fertre <yannick.fertre@st.com>

 *          Fabien Dessenne <fabien.dessenne@st.com>

 *          Mickael Reulier <mickael.reulier@st.com>

/*

 * The address of some registers depends on the HW version: such registers have

 * an extra offset specified with reg_ofs.

 Insertion of "Layer Conf. 2" reg */

 Register Offset between 2 layers */

 Global register offsets */

 IDentification */

 Layer Count */

 Synchronization Size Configuration */

 Back Porch Configuration */

 Active Width Configuration */

 Total Width Configuration */

 Global Control */

 Global Configuration 1 */

 Global Configuration 2 */

 Shadow Reload Configuration */

 GAmma Correction */

 Background Color Configuration */

 Interrupt Enable */

 Interrupt Status */

 Interrupt Clear */

 Line Interrupt Position Conf. */

 Current Position Status */

 Current Display Status */

 Layer register offsets */

 L1 Layer Configuration 1 */

 L1 Layer Configuration 2 */

 L1 Control */

 L1 Window Hor Position Config */

 L1 Window Vert Position Config */

 L1 Color Keying Configuration */

 L1 Pixel Format Configuration */

 L1 Constant Alpha Config */

 L1 Default Color Configuration */

 L1 Blend Factors Configuration */

 L1 FrameBuffer Bus Control */

 L1 AuxFB Control */

 L1 Color FrameBuffer Address */

 L1 Color FrameBuffer Length */

 L1 Color FrameBuffer Line Nb */

 L1 AuxFB Address */

 L1 AuxFB Length */

 L1 AuxFB Line Number */

 L1 CLUT Write */

 L1 YCbCr Scale 1 */

 L1 YCbCr Scale 2 */

 Bit definitions */

 Vertical Synchronization Height */

 Horizontal Synchronization Width */

 Accumulated Vertical Back Porch */

 Accumulated Horizontal Back Porch */

 Accumulated Active Height */

 Accumulated Active Width */

 TOTAL Height */

 TOTAL Width */

 LTDC ENable */

 Dither ENable */

 Pixel Clock POLarity-Inverted */

 Data Enable POLarity-High */

 Vertical Synchro POLarity-High */

 Horizontal Synchro POLarity-High */

 Width of Blue CHannel output */

 Width of Green Channel output */

 Width of Red Channel output */

 Precise Blending ENable */

 Dithering Technique */

 Gamma Correction Technique */

 SHadow Registers ENabled */

 Background Colour Programmable */

 Background Blending ENabled */

 Line Number IRQ Position */

 Timing Programmable */

 IRQ Polarity Programmable */

 Sync Polarity Programmable */

 Dither Width Programmable */

 STatus Registers ENabled */

 Blind Mode ENabled */

 External Display Control Ability  */

 Slave Timing Sync Ability ENabled */

 Dual-View Ability ENabled */

 Dual-Port Ability ENabled */

 Bus Width (log2 of nb of bytes) */

 External Display Control ENabled */

 IMmediate Reload */

 Vertical Blanking Reload */

 Background Color BLACK */

 Background Color BLUE */

 Background Color GREEN */

 Background Color RED */

 Background Color WHITE */

 Line Interrupt Enable */

 Fifo Underrun Interrupt Enable */

 Transfer ERRor Interrupt Enable */

 Register Reload Interrupt enable */

 Current Y position */

 Line Interrupt Flag */

 Fifo Underrun Interrupt Flag */

 Transfer ERRor Interrupt Flag */

 Register Reload Interrupt Flag */

 Layer ENable */

 Color Keying Enable */

 Color Look-Up Table ENable */

 Window Horizontal StarT POSition */

 Window Horizontal StoP POSition */

 Window Vertical StarT POSition */

 Window Vertical StoP POSition */

 Pixel Format */

 CONSTant Alpha */

 Blending Factor 2 */

 Blending Factor 1 */

 Color Frame Buffer Line Length */

 Color Frame Buffer Pitch in bytes */

 Color Frame Buffer Line Number */

 CONSTant Alpha MAX= 1.0 */

 Pixel Alpha x Constant Alpha */

 Constant Alpha */

 1 - (Pixel Alpha x Constant Alpha) */

 1 - Constant Alpha */

 Max nb of HW pixel format */

 RGB formats */

 ARGB [32 bits] */

 RGBA [32 bits] */

 RGB [24 bits] */

 RGB [16 bits] */

 ARGB A:1 bit RGB:15 bits [16 bits] */

 ARGB A:4 bits R/G/B: 4 bits each [16 bits] */

 Indexed formats */

 Indexed 8 bits [8 bits] */

 Alpha:4 bits + indexed 4 bits [8 bits] */

 Alpha:8 bits + indexed 8 bits [16 bits] */

 The index gives the encoding of the pixel format for an HW version */

 0x00 */

 0x01 */

 0x02 */

 0x03 */

 0x04 */

 0x05 */

 0x06 */

 0x07 */

 0x00 */

 0x01 */

 0x02 */

 0x03 */

 0x04 */

 0x05 */

 0x06 */

 0x07 */

 Note: There are no DRM_FORMAT for AL44 and AL88 */

 No DRM support */

 No DRM support */

 Line IRQ : trigger the vblank event */

 Save FIFO Underrun & Transfer Error status */

 Read & Clear the interrupt status */

/*

 * DRM_CRTC

 Sets the background color value */

 Enable IRQ */

 Commit shadow registers = update planes at next vblank */

 disable IRQ */

 immediately commit disable of layers before switching off LTDC */

 Filter modes according to the max frequency supported by the pads */

	/*

	 * Accept all "preferred" modes:

	 * - this is important for panels because panel clock tolerances are

	 *   bigger than hdmi ones and there is no reason to not accept them

	 *   (the fps may vary a little but it is not a problem).

	 * - the hdmi preferred mode will be accepted too, but userland will

	 *   be able to use others hdmi "valid" modes if necessary.

	/*

	 * Filter modes according to the clock value, particularly useful for

	 * hdmi modes that require precise pixel clocks.

 get encoder from crtc */

 get bridge from encoder */

 Get the connector from encoder */

 Convert video timings to ltdc timings */

 Configures the HS, VS, DE and PC polarities. Default Active Low */

 Set Synchronization size */

 Set Accumulated Back porch */

 Set Accumulated Active Width */

 Set total width & height */

 Commit shadow registers = update planes at next vblank */

	/* The active area starts after vsync + front porch and ends

	 * at vsync + front porc + display size.

	 * The total height also include back porch.

	 * We have 3 possible cases to handle:

	 * - line < vactive_start: vpos = line - vactive_start and will be

	 * negative

	 * - vactive_start < line < vactive_end: vpos = line - vactive_start

	 * and will be positive

	 * - line > vactive_end: vpos = line - vtotal - vactive_start

	 * and will negative

	 *

	 * Computation for the two first cases are identical so we can

	 * simplify the code and only test if line > vactive_end

/*

 * DRM_PLANE

 convert src_ from 16:16 format */

 Reject scaling */

 convert src_ from 16:16 format */

 Configures the horizontal start and stop position */

 Configures the vertical start and stop position */

 Specifies the pixel format */

 set by default ARGB 32 bits */

 Configures the color frame buffer pitch in bytes & line length */

 Specifies the constant alpha value */

 Specifies the blending factors */

 Manage hw-specific capabilities */

 Configures the frame buffer line number */

 Sets the FB address */

 Enable layer and CLUT if needed */

 disable layer */

 Get supported pixel formats */

 Add the no-alpha related format if any & supported */

 Manage hw-specific capabilities */

 Add planes. Note : the first layer is used by primary plane */

 Disable LTDC */

 Set to sleep state the pinctrl whatever type of encoder */

 Enable LTDC */

	/*

	 * Set to default state the pinctrl only with DPI type.

	 * Others types like DSI, don't need pinctrl due to

	 * internal bridge (the signals do not come out of the chipset).

 No cloning support */

	/*

	 * at least 1 layer must be managed & the number of layers

	 * must not exceed LTDC_MAX_LAYER

 set data bus width */

		/*

		 * Hw older versions support non-alpha color formats derived

		 * from native alpha color formats only on the primary layer.

		 * For instance, RG16 native format without alpha works fine

		 * on 2nd layer but XR24 (derived color format from AR24)

		 * does not work on 2nd layer.

 Get number of endpoints */

 Get endpoints if any */

		/*

		 * If at least one endpoint is -ENODEV, continue probing,

		 * else if at least one endpoint returned an error

		 * (ie -EPROBE_DEFER) then stop probing.

 Disable interrupts */

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) STMicroelectronics SA 2017

 *

 * Authors: Philippe Cornu <philippe.cornu@st.com>

 *          Yannick Fertre <yannick.fertre@st.com>

 *          Fabien Dessenne <fabien.dessenne@st.com>

 *          Mickael Reulier <mickael.reulier@st.com>

 same as width to handle orientation */

	/*

	 * in order to optimize data transfer, pitch is aligned on

	 * 128 bytes, height is aligned on 4 bytes

	/*

	 * set max width and height as default value.

	 * this value would be used to check framebuffer size limitation

	 * at drm_mode_addfb().

 end node */ },

 SPDX-License-Identifier: GPL-2.0

/*

 * Copyright (C) STMicroelectronics SA 2017

 *

 * Authors: Philippe Cornu <philippe.cornu@st.com>

 *          Yannick Fertre <yannick.fertre@st.com>

 IP version 1.30 */

 IP version 1.31 */

 DSI digital registers & bit definitions */

 DSI wrapper registers & bit definitions */

 Note: registers are named as in the Reference Manual */

 Wrapper ConFiGuration Reg */

 DSI Mode */

 COLor MUltipleXing */

 Wrapper Control Reg */

 DSI ENable */

 Wrapper Interrupt and Status Reg */

 PLL Lock Status */

 Regulator Ready Status */

 Wrapper Phy Conf Reg 0 */

 Unit Interval X 4 */

 Turn Disable Data Lanes */

 Wrapper Regulator & Pll Ctrl Reg */

 PLL ENable */

 pll loop DIVision Factor */

 pll Input Division Factor */

 pll Output Division Factor */

 REGulator ENable */

 BandGap Reference ENable */

 dsi color format coding according to the datasheet */

 Sleep & timeout for regulator on/off, pll lock/unlock & fifo empty */

 prevent from division by 0 */

 all in khz */

 Early checks preventing division by 0 & odd results */

 big started value (1000000khz) */

 Compute ndiv range according to Fvco */

 No need to continue idf loop if we reach ndiv max */

 Clamp ndiv to valid values */

 Check ndiv according to vco range */

 Check if new delta is better & saves parameters */

 fast return in case of "perfect result" */

 Enable the regulator */

 Enable the DSI PLL & wait for its lock */

 Enable the DSI wrapper */

 Disable the DSI wrapper */

 Update lane capabilities according to hw version */

 Compute requested pll out */

 Add 20% to pll out to be higher than pixel bw (burst mode only) */

 Compute best pll parameters */

 Get the adjusted pll out value */

 Set the PLL division factors */

 Compute uix4 & set the bit period in high-speed mode */

 Select video mode by resetting DSIM bit */

 Select the color coding */

	/*

	 * From STM32MP157 datasheet, valid for STM32F469, STM32F7x9, STM32H747

	 * phy_clkhs2lp_time = (272+136*UI)/(8*UI)

	 * phy_clklp2hs_time = (512+40*UI)/(8*UI)

	 * phy_hs2lp_time = (192+64*UI)/(8*UI)

	 * phy_lp2hs_time = (256+32*UI)/(8*UI)

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Samsung Electronics Co.Ltd

 * Authors:

 *	YoungJun Cho <yj44.cho@samsung.com>

 *	Eunchul Kim <chulspro.kim@samsung.com>

/*

 * Rotator supports image crop/rotator and input/output DMA operations.

 * input DMA reads image data from the memory.

 * output DMA writes image data to memory.

/*

 * A structure of rotator context.

 * @ippdrv: prepare initialization using ippdrv.

 * @regs: memory mapped io registers.

 * @clock: rotator gate clock.

 * @limit_tbl: limitation of rotator.

 * @irq: irq number.

 Get execution result */

 clear status */

 Set buffer size configuration */

 Set crop image position configuration */

 Set buffer DMA address */

 Set transform configuration */

 Set buffer size configuration */

 Set crop image position configuration */

 Set buffer DMA address */

 Set interrupt enable */

 SPDX-License-Identifier: GPL-2.0-or-later

/* exynos_drm_fb.c

 *

 * Copyright (c) 2011 Samsung Electronics Co., Ltd.

 * Authors:

 *	Inki Dae <inki.dae@samsung.com>

 *	Joonyoung Shim <jy0922.shim@samsung.com>

 *	Seung-Woo Kim <sw0312.kim@samsung.com>

	/*

	 * if exynos drm driver supports iommu then framebuffer can use

	 * all the buffer types.

	/*

	 * Physically non-contiguous memory type for framebuffer is not

	 * supported without IOMMU.

	/*

	 * set max width and height as default value(4096x4096).

	 * this value would be used to check framebuffer size limitation

	 * at drm_mode_addfb().

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (C) 2012 Samsung Electronics Co.Ltd

 * Authors:

 *	Eunchul Kim <chulspro.kim@samsung.com>

 *	Jinyoung Jeon <jy0.jeon@samsung.com>

 *	Sangmin Lee <lsmin.lee@samsung.com>

/*

 * GSC stands for General SCaler and

 * supports image scaler/rotator and input/output DMA operations.

 * input DMA reads image data from the memory.

 * output DMA writes image data to memory.

 * GSC supports image rotation and image effect functions.

/*

 * A structure of scaler.

 *

 * @range: narrow, wide.

 * @pre_shfactor: pre sclaer shift factor.

 * @pre_hratio: horizontal ratio of the prescaler.

 * @pre_vratio: vertical ratio of the prescaler.

 * @main_hratio: the main scaler's horizontal ratio.

 * @main_vratio: the main scaler's vertical ratio.

/*

 * A structure of gsc context.

 *

 * @regs: memory mapped io registers.

 * @gsc_clk: gsc gate clock.

 * @sc: scaler infomations.

 * @id: gsc id.

 * @irq: irq number.

 * @rotation: supports rotation of src.

/**

 * struct gsc_driverdata - per device type driver data for init time.

 *

 * @limits: picture size limits array

 * @num_limits: number of items in the aforementioned array

 * @clk_names: names of clocks needed by this variant

 * @num_clocks: the number of clocks needed by this variant

 8-tap Filter Coefficient */

 Ratio <= 65536 (~8:8) */

 65536 < Ratio <= 74898 (~8:7) */

 74898 < Ratio <= 87381 (~8:6) */

 87381 < Ratio <= 104857 (~8:5) */

 104857 < Ratio <= 131072 (~8:4) */

 131072 < Ratio <= 174762 (~8:3) */

 174762 < Ratio <= 262144 (~8:2) */

 4-tap Filter Coefficient */

 Ratio <= 65536 (~8:8) */

 65536 < Ratio <= 74898 (~8:7) */

 74898 < Ratio <= 87381 (~8:6) */

 87381 < Ratio <= 104857 (~8:5) */

 104857 < Ratio <= 131072 (~8:4) */

 131072 < Ratio <= 174762 (~8:3) */

 174762 < Ratio <= 262144 (~8:2) */

 s/w reset */

 wait s/w reset complete */

 reset sequence */

 pixel offset */

 cropped size */

 original size */

 mask register set */

 sequence id */

 address register set */

 pixel offset */

 scaled size */

 original size */

 mask register set */

 sequence id */

 interrupt enable */

 interrupt disable */

 address register set */

 reset h/w block */

 scaler setting */

 enable one shot */

 src dma memory */

 dst dma memory */

 construct formats/limits array */

 linear formats */

 tiled formats */

 clock control */

 resource irq */

 context initailization */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (C) 2011 Samsung Electronics Co.Ltd

 * Authors:

 * Seung-Woo Kim <sw0312.kim@samsung.com>

 *	Inki Dae <inki.dae@samsung.com>

 *	Joonyoung Shim <jy0922.shim@samsung.com>

 *

 * Based on drivers/media/video/s5p-tv/hdmi_drv.c

	/*

	 * Array of triplets (p_off, p_on, clock), where p_off and p_on are

	 * required parents of clock when HDMI-PHY is respectively off or on.

 mutex protecting subsequent fields below */

	/*

	 * Find the most suitable mode and copy it to adjusted_mode.

 Configuration I2S input ports. Configure I2S_PIN_SEL_0~4 */

 I2S_CON_1 & 2 */

 Configuration of the audio channel status registers */

 disable HPD interrupts from HDMI IP block, use GPIO instead */

 choose HDMI mode */

 apply video pre-amble and guard band in HDMI mode only */

 disable bluescreen */

 choose bluescreen (fecal) color */

 enable AVI packet every vsync, fixes purple line problem */

 force RGB, look to CEA-861-D, table 7 for more detail */

 enable AVI packet every vsync, fixes purple line problem */

	/*

	 * Quirk requirement for exynos HDMI IP design,

	 * 2 pixels less than the actual calculation for hsync_start

	 * and end.

 Following values & calculations differ for different type of modes */

	/*

	 * In case video mode coming from CRTC differs from requested one HDMI

	 * sometimes is able to almost properly perform conversion - only

	 * first line is distorted.

	/*

	 * Quirk requirement for exynos 5 HDMI IP design,

	 * 2 pixels less than the actual calculation for hsync_start

	 * and end.

 Following values & calculations differ for different type of modes */

 Should be called with hdata->mutex mutex held */

 Should be called with hdata->mutex mutex held. */

 Should be called with hdata->mutex mutex held. */

		/*

		 * The SFRs of VP and Mixer are updated by Vertical Sync of

		 * Timing generator which is a part of HDMI so the sequence

		 * to disable TV Subsystem should be as following,

		 *	VP -> Mixer -> HDMI

		 *

		 * To achieve such sequence HDMI is disabled together with

		 * HDMI PHY, via pipe clock callback.

 end node */

 SPDX-License-Identifier: GPL-2.0-or-later

/* exynos_drm_fbdev.c

 *

 * Copyright (c) 2011 Samsung Electronics Co., Ltd.

 * Authors:

 *	Inki Dae <inki.dae@samsung.com>

 *	Joonyoung Shim <jy0922.shim@samsung.com>

 *	Seung-Woo Kim <sw0312.kim@samsung.com>

	/*

	 * if failed, all resources allocated above would be released by

	 * drm_mode_config_cleanup() when drm_load() had been called prior

	 * to any specific driver such as fimd or hdmi driver.

 release drm framebuffer and real buffer */

 SPDX-License-Identifier: GPL-2.0-or-later

/* exynos_drm_gem.c

 *

 * Copyright (c) 2011 Samsung Electronics Co., Ltd.

 * Author: Inki Dae <inki.dae@samsung.com>

	/*

	 * if EXYNOS_BO_CONTIG, fully physically contiguous memory

	 * region will be allocated else physically contiguous

	 * as possible.

	/*

	 * if EXYNOS_BO_WC or EXYNOS_BO_NONCACHABLE, writecombine mapping

	 * else cachable mapping.

 FBDev emulation requires kernel mapping */

	/*

	 * allocate a id of idr table where the obj is registered

	 * and handle has the id what user can see.

 drop reference from allocate - handle holds it now. */

	/*

	 * do not release memory region from exporter.

	 *

	 * the region will be released by exporter

	 * once dmabuf's refcount becomes 0.

 release file pointer to gem object. */

		/*

		 * when no IOMMU is available, all allocated buffers are

		 * contiguous anyway, so drop EXYNOS_BO_NONCONTIG flag

 set memory type and cache attribute from user side. */

 check if user-requested size is valid. */

	/*

	 * allocate memory to be used for framebuffer.

	 * - this callback would be called by user application

	 *	with DRM_IOCTL_MODE_CREATE_DUMB command.

 non-cachable as default. */

 set vm_area_struct. */

 low-level interface prime helpers */

 check if the entries in the sg_table are contiguous */

	/*

	 * Buffer has been mapped as contiguous into DMA address space,

	 * but if there is IOMMU, it can be either CONTIG or NONCONTIG.

	 * We assume a simplified logic below:

/*

 * Copyright (C) 2017 Samsung Electronics Co.Ltd

 * Authors:

 *	Marek Szyprowski <m.szyprowski@samsung.com>

 *

 * Exynos DRM Image Post Processing (IPP) related functions

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the "Software"),

 * to deal in the Software without restriction, including without limitation

 * the rights to use, copy, modify, merge, publish, distribute, sublicense,

 * and/or sell copies of the Software, and to permit persons to whom the

 * Software is furnished to do so, subject to the following conditions:

 *

 * The above copyright notice and this permission notice shall be included in

 * all copies or substantial portions of the Software.

/**

 * exynos_drm_ipp_register - Register a new picture processor hardware module

 * @dev: DRM device

 * @ipp: ipp module to init

 * @funcs: callbacks for the new ipp object

 * @caps: bitmask of ipp capabilities (%DRM_EXYNOS_IPP_CAP_*)

 * @formats: array of supported formats

 * @num_formats: size of the supported formats array

 * @name: name (for debugging purposes)

 *

 * Initializes a ipp module.

 *

 * Returns:

 * Zero on success, error code on failure.

 ipp_list modification is serialized by component framework */

/**

 * exynos_drm_ipp_unregister - Unregister the picture processor module

 * @dev: DRM device

 * @ipp: ipp module

/**

 * exynos_drm_ipp_get_res_ioctl - enumerate all ipp modules

 * @dev: DRM device

 * @data: ioctl data

 * @file_priv: DRM file info

 *

 * Construct a list of ipp ids.

 *

 * Called by the user via ioctl.

 *

 * Returns:

 * Zero on success, negative errno on failure.

	/*

	 * This ioctl is called twice, once to determine how much space is

	 * needed, and the 2nd time to fill it.

/**

 * exynos_drm_ipp_get_caps_ioctl - get ipp module capabilities and formats

 * @dev: DRM device

 * @data: ioctl data

 * @file_priv: DRM file info

 *

 * Construct a structure describing ipp module capabilities.

 *

 * Called by the user via ioctl.

 *

 * Returns:

 * Zero on success, negative errno on failure.

	/*

	 * This ioctl is called twice, once to determine how much space is

	 * needed, and the 2nd time to fill it.

/**

 * exynos_drm_ipp_get_limits_ioctl - get ipp module limits

 * @dev: DRM device

 * @data: ioctl data

 * @file_priv: DRM file info

 *

 * Construct a structure describing ipp module limitations for provided

 * picture format.

 *

 * Called by the user via ioctl.

 *

 * Returns:

 * Zero on success, negative errno on failure.

	/*

	 * This ioctl is called twice, once to determine how much space is

	 * needed, and the 2nd time to fill it.

 some defaults */

 get GEM buffers and check their size */

 basic checks */

 pitch for additional planes must match */

 check driver limits */

 ensure event won't be canceled on task free */

/**

 * exynos_drm_ipp_task_done - finish given task and set return code

 * @task: ipp task to finish

 * @ret: error code or 0 if operation has been performed successfully

 already completed task */

 task has not been scheduled for execution yet */

		/*

		 * currently processed task, call abort() and perform

		 * cleanup with async worker

/**

 * exynos_drm_ipp_commit_ioctl - perform image processing operation

 * @dev: DRM device

 * @data: ioctl data

 * @file_priv: DRM file info

 *

 * Construct a ipp task from the set of properties provided from the user

 * and try to schedule it to framebuffer processor hardware.

 *

 * Called by the user via ioctl.

 *

 * Returns:

 * Zero on success, negative errno on failure.

 can't test and expect an event at the same time */

	/*

	 * Queue task for processing on the hardware. task object will be

	 * then freed after exynos_drm_ipp_task_done()

 SPDX-License-Identifier: GPL-2.0-only

/* drivers/gpu/drm/exynos5433_drm_decon.c

 *

 * Copyright (C) 2015 Samsung Electronics Co.Ltd

 * Authors:

 *	Joonyoung Shim <jy0922.shim@samsung.com>

 *	Hyungwon Hwang <human.hwang@samsung.com>

 return number of starts/ends of frame transmissions since reset */

	/* To get consistent result repeat read until frame id is stable.

	 * Usually the loop will be executed once, in rare cases when the loop

	 * is executed at frame change time 2nd pass will be needed.

	/* CRFMID is incremented on BPORCH in case of I80 and on VSYNC in case

	 * of RGB, it should be taken into account.

 lcd on and use command if */

 enable output and display signal */

	/*

	 * In case of exynos, setting dma-burst to 16Word causes permanent

	 * tearing for very small buffers, e.g. cursor buffer. Burst Mode

	 * switching which is based on plane size is not recommended as

	 * plane size varies a lot towards the end of the screen and rapid

	 * movement causes unstable DMA which results into iommu crash/tear.

 window enable */

	/*

	 * We need to make sure that all windows are disabled before we

	 * suspend that connector. Otherwise we might try to scan from

	 * a destroyed buffer later.

 TODO: wait for possible vsync */

 detach this sub driver from iommu mapping if supported. */

 handle only if incremented, take care of wrap-around */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (C) 2011 Samsung Electronics Co.Ltd

 * Authors:

 * Seung-Woo Kim <sw0312.kim@samsung.com>

 *	Inki Dae <inki.dae@samsung.com>

 *	Joonyoung Shim <jy0922.shim@samsung.com>

 *

 * Based on drivers/media/video/s5p-tv/mixer_reg.c

/*

 * Mixer color space conversion coefficient triplet.

 * Used for CSC from RGB to YCbCr.

 * Each coefficient is a 10-bit fixed point number with

 * sign and no integer part, i.e.

 * [0:8] = fractional part (representing a value y = x / 2^9)

 * [9] = sign

 * Negative values are encoded with two's complement.

 YCbCr value, used for mixer background color configuration. */

 The pixelformats that are natively supported by the mixer. */

 assure 4-byte align */

 no blank key */

 choosing between interlace and progressive mode */

 Configure the BT.709 CSC matrix for full range RGB. */

 interlace or progressive scan mode */

 setup format */

 setting size of input image */

 chroma plane for NV12/NV21 is half the height of the luma plane */

 set buffer address to vp */

 ratio is already checked by common plane code */

 translate dma address base s.t. the source image offset is zero */

 setup format */

 setup geometry */

 setup offsets in display image */

 set buffer address to mixer */

 waiting until VP_SRESET_PROCESSING is 0 */

 set output in RGB888 mode */

 16 beat burst in DMA */

 reset default layer priority */

 set all background colors to RGB (0,0,0) */

 configuration of Video Processor Registers */

 disable all layers */

 set all source image offsets to zero */

 read interrupt status for handling and clearing flags for VSYNC */

 handling VSYNC */

 vsync interrupt use different bit for read and clear */

 interlace scan need to check shadow register */

 clear interrupts */

 acquire resources: regs, irqs, clocks */

 acquire vp resources: regs, irqs, clocks */

 enable vsync interrupt */

 disable vsync interrupt */

 end node */

 SPDX-License-Identifier: GPL-2.0-or-later

/* exynos_drm_crtc.c

 *

 * Copyright (c) 2011 Samsung Electronics Co., Ltd.

 * Authors:

 *	Inki Dae <inki.dae@samsung.com>

 *	Joonyoung Shim <jy0922.shim@samsung.com>

 *	Seung-Woo Kim <sw0312.kim@samsung.com>

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Samsung SoC MIPI DSI Master driver.

 *

 * Copyright (c) 2014 Samsung Electronics Co., Ltd

 *

 * Contacts: Tomasz Figa <t.figa@samsung.com>

 returns true iff both arguments logically differs */

 DSIM_STATUS */

 DSIM_SWRST */

 DSIM_TIMEOUT */

 DSIM_CLKCTRL */

 DSIM_CONFIG */

 This flag is valid only for exynos3250/3472/5260/5430 */

 DSIM_ESCMODE */

 DSIM_MDRESOL */

 DSIM_MVPORCH */

 DSIM_MHPORCH */

 DSIM_MSYNC */

 DSIM_SDRESOL */

 DSIM_INTSRC */

 DSIM_FIFOCTRL */

 DSIM_PHYACCHR */

 DSIM_PLLCTRL */

 DSIM_PHYCTRL */

 DSIM_PHYTIMING */

 DSIM_PHYTIMING1 */

 DSIM_PHYTIMING2 */

 protects transfer_list */

 Status register */

 Software reset register */

 Clock control register */

 Time out register */

 Configuration register */

 Escape mode register */

 Main display Vporch register */

 Main display Hporch register */

 Main display sync area register */

 Interrupt source register */

 Interrupt mask register */

 Packet Header FIFO register */

 Payload FIFO register */

 Read FIFO register */

 FIFO status and control register */

 PLL control register */

 B D-PHY: D-PHY Master & Slave Analog Block control */

	/*

	 * T LPX: Transmitted length of any Low-Power state period

	 * T HS-EXIT: Time that the transmitter drives LP-11 following a HS

	 *	burst

	/*

	 * T CLK-PREPARE: Time that the transmitter drives the Clock Lane LP-00

	 *	Line state immediately before the HS-0 Line state starting the

	 *	HS transmission

	 * T CLK-ZERO: Time that the transmitter drives the HS-0 state prior to

	 *	transmitting the Clock.

	 * T CLK_POST: Time that the transmitter continues to send HS clock

	 *	after the last associated Data Lane has transitioned to LP Mode

	 *	Interval is defined as the period from the end of T HS-TRAIL to

	 *	the beginning of T CLK-TRAIL

	 * T CLK-TRAIL: Time that the transmitter drives the HS-0 state after

	 *	the last payload clock bit of a HS transmission burst

	/*

	 * T HS-PREPARE: Time that the transmitter drives the Data Lane LP-00

	 *	Line state immediately before the HS-0 Line state starting the

	 *	HS transmission

	 * T HS-ZERO: Time that the transmitter drives the HS-0 state prior to

	 *	transmitting the Sync sequence.

	 * T HS-TRAIL: Time that the transmitter drives the flipped differential

	 *	state after last payload data bit of a HS transmission burst

 Initialize FIFO pointers */

 DSI configuration */

	/*

	 * The first bit of mode_flags specifies display configuration.

	 * If this bit is set[= MIPI_DSI_MODE_VIDEO], dsi will support video

	 * mode, otherwise it will support command mode.

		/*

		 * The user manual describes that following bits are ignored in

		 * command mode.

	/*

	 * Use non-continuous clock mode if the periparal wants and

	 * host controller supports

	 *

	 * In non-continous clock mode, host controller will turn off

	 * the HS clock between high-speed transmissions to reduce

	 * power consumption.

 Check clock and data lane state are stop state */

 Send payload */

 Send packet header */

 Receive payload */

 waiting for RX */

 Also covers hardware timeout condition */

	/*

	 * This is a temporary solution and should be made by more generic way.

	 *

	 * If attached panel device is for command mode one, dsi should register

	 * TE interrupt handler.

 To be checked as invalid one */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2015 Samsung Electronics Co.Ltd

 * Authors:

 *	Hyungwon Hwang <human.hwang@samsung.com>

 Sysreg registers for MIC */

 MIC registers */

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (c) 2011 Samsung Electronics Co., Ltd.

 * Authors:

 *	Inki Dae <inki.dae@samsung.com>

 *	Joonyoung Shim <jy0922.shim@samsung.com>

 *	Seung-Woo Kim <sw0312.kim@samsung.com>

/*

 * Interface history:

 *

 * 1.0 - Original version

 * 1.1 - Upgrade IPP driver to version 2.0

 forward declaration */

 supports component framework */

 create virtual platform device */

 devices shared with V4L2 subsystem */

/*

 * Connector drivers should not be placed before associated crtc drivers,

 * because connector requires pipe number of its crtc during initialization.

 setup possible_clones. */

 Try to bind all sub drivers. */

 init kms poll for handling hpd */

 register the DRM device */

 SPDX-License-Identifier: GPL-2.0



 Copyright (c) 2012 Samsung Electronics Co., Ltd.

 Author: Inki Dae <inki.dae@samsung.com>

 Author: Andrzej Hajda <a.hajda@samsung.com>

/*

 * drm_iommu_attach_device- attach device to iommu mapping

 *

 * @drm_dev: DRM device

 * @subdrv_dev: device to be attach

 *

 * This function should be called by sub drivers to attach it to iommu

 * mapping.

		/*

		 * Keep the original DMA mapping of the sub-device and

		 * restore it on Exynos DRM detach, otherwise the DMA

		 * framework considers it as IOMMU-less during the next

		 * probe (in case of deferred probe or modular build)

/*

 * drm_iommu_detach_device -detach device address space mapping from device

 *

 * @drm_dev: DRM device

 * @subdrv_dev: device to be detached

 *

 * This function should be called by sub drivers to detach it from iommu

 * mapping

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (C) 2012 Samsung Electronics Co.Ltd

 * Authors:

 *	Eunchul Kim <chulspro.kim@samsung.com>

 *	Jinyoung Jeon <jy0.jeon@samsung.com>

 *	Sangmin Lee <lsmin.lee@samsung.com>

/*

 * FIMC stands for Fully Interactive Mobile Camera and

 * supports image scaler/rotator and input/output DMA operations.

 * input DMA reads image data from the memory.

 * output DMA writes image data to memory.

 * FIMC supports image rotation and image effect functions.

/*

 * A structure of scaler.

 *

 * @range: narrow, wide.

 * @bypass: unused scaler path.

 * @up_h: horizontal scale up.

 * @up_v: vertical scale up.

 * @hratio: horizontal ratio.

 * @vratio: vertical ratio.

/*

 * A structure of fimc context.

 *

 * @regs: memory mapped io registers.

 * @lock: locking of operations.

 * @clocks: fimc clocks.

 * @sc: scaler infomations.

 * @pol: porarity of writeback.

 * @id: fimc id.

 * @irq: irq number.

 stop dma operation */

 disable image capture */

 s/w reset */

 s/w reset complete */

 reset sequence */

 RGB */

 bypass */

 YUV */

 cropped image */

	/*

	 * set window offset 1, 2 size

	 * check figure 43-21 in user manual

 original size */

 set input DMA image size */

	/*

	 * set input FIFO image size

	 * for now, we support only ITU601 8 bit mode

 offset Y(RGB), Cb, Cr */

 RGB */

 bypass */

 YUV */

 fimc_ippdrv_check_property assures that dividers are not null */

 original size */

 CSC ITU */

 target image size */

 target area */

 offset Y(RGB), Cb, Cr */

 reset h/w block */

 reset scaler capability */

 If set true, we can save jpeg about screen */

 setup dma */

 Reset status */

 Scaler */

 Enable image capture*/

 Disable frame end irq */

 Source clear */

 reset sequence */

 Scaler disable */

 Disable image capture */

 Enable frame end irq */

 construct formats/limits array */

 linear formats */

 tiled formats */

 resource memory */

 resource irq */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2017 Samsung Electronics Co.Ltd

 * Author:

 *	Andrzej Pietrasiewicz <andrzejtp2010@gmail.com>

 YCbCr to RGB */

 RGB to YCbCr */

 SCALER_YUV420_2P_UV */

 SCALER_YUV420_2P_VU */

 SCALER_YUV420_3P */

 SCALER_YUV422_1P_YUYV */

 SCALER_YUV422_1P_UYVY */

 SCALER_YUV422_1P_YVYU */

 SCALER_YUV422_2P_UV */

 SCALER_YUV422_2P_VU */

 SCALER_YUV422_3P */

 SCALER_YUV444_2P_UV */

 SCALER_YUV444_2P_VU */

 SCALER_YUV444_3P */

 SCALER_RGB_565 */

 SCALER_ARGB1555 */

 SCALER_ARGB1555 */

 SCALER_ARGB4444 */

 SCALER_ARGB4444 */

 SCALER_ARGB8888 */

 SCALER_ARGB8888 */

 SCALER_RGBA8888 */

 SCALER_RGBA8888 */

 SCALER_YUV420_2P_UV TILE */

 SCALER_YUV420_2P_VU TILE */

 SCALER_YUV420_3P TILE */

 SCALER_YUV422_1P_YUYV TILE */

 intentional */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2012 Samsung Electronics Co.Ltd

 * Authors: Joonyoung Shim <jy0922.shim@samsung.com>

 vaild register range set from user: 0x0104 ~ 0x0880 */

 general registers */

 command registers */

 registers for base address */

 G2D_SOFT_RESET */

 G2D_INTEN */

 G2D_INTC_PEND */

 G2D_DMA_COMMAND */

 G2D_DMA_STATUS */

 G2D_DMA_HOLD_CMD */

 G2D_BITBLT_START */

 buffer color format */

 buffer valid length */

 maximum buffer pool size of userptr is 64MB as default */

	/*

	 * If set, suspends the runqueue worker after the currently

	 * processed node is finished.

	/*

	 * If set, indicates that the engine is currently busy.

 cmdlist data structure */

 last data offset */

/*

 * A structure of buffer description

 *

 * @format: color format

 * @stride: buffer stride/pitch in bytes

 * @left_x: the x coordinates of left top corner

 * @top_y: the y coordinates of left top corner

 * @right_x: the x coordinates of right bottom corner

 * @bottom_y: the y coordinates of right bottom corner

 *

/*

 * A structure of buffer information

 *

 * @map_nr: manages the number of mapped buffers

 * @reg_types: stores regitster type in the order of requested command

 * @handles: stores buffer handle in its reg_type position

 * @types: stores buffer type in its reg_type position

 * @descs: stores buffer description in its reg_type position

 *

 cmdlist */

 runqueue*/

 this links to base address of new cmdlist */

 check if userptr already exists in userptr_list. */

			/*

			 * also check size because there could be same address

			 * and different size.

			/*

			 * at this moment, maybe g2d dma is accessing this

			 * g2d_userptr memory region so just remove this

			 * g2d_userptr object from userptr_list not to be

			 * referred again and also except it the userptr

			 * pool to be released after the dma access completion.

	/*

	 * check source and destination buffers only.

	 * so the others are always valid.

 This check also makes sure that right_x > left_x. */

 This check also makes sure that bottom_y > top_y. */

 Compute the position of the last byte that the engine accesses. */

	/*

	 * Since right_x > left_x and bottom_y > top_y we already know

	 * that the first_pos < last_pos (first_pos being the position

	 * of the first byte the engine accesses), it just remains to

	 * check if last_pos is smaller then the buffer size.

	/*

	 * commands in run_cmdlist have been completed so unmap all gem

	 * objects in each command node so that they are unreferenced.

/**

 * g2d_remove_runqueue_nodes - remove items from the list of runqueue nodes

 * @g2d: G2D state object

 * @file: if not zero, only remove items with this DRM file

 *

 * Has to be called under runqueue lock.

	/*

	 * The engine is busy and the completion of the current node is going

	 * to poke the runqueue worker, so nothing to do here.

/**

 * g2d_wait_finish - wait for the G2D engine to finish the current runqueue node

 * @g2d: G2D state object

 * @file: if not zero, only wait if the current runqueue node belongs

 *        to the DRM file

 *

 * Should the engine not become idle after a 100ms timeout, a hardware

 * reset is issued.

 If no node is currently processed, we have nothing to do. */

 Check if the currently processed item belongs to us. */

 Wait for the G2D engine to finish. */

	/*

	 * After the hardware reset of the engine we are going to loose

	 * the IRQ which triggers the PM runtime put().

	 * So do this manually here.

 check userptr buffer type. */

 ioctl functions */

	/*

	 * To avoid an integer overflow for the later size computations, we

	 * enforce a maximum number of submitted commands here. This limit is

	 * sufficient for all conceivable usage cases of the G2D.

	/*

	 * If don't clear SFR registers, the cmdlist is affected by register

	 * values of previous cmdlist. G2D hw executes SFR clear command and

	 * a next command at the same time then the next command is ignored and

	 * is executed rightly from next next command, so needs a dummy command

	 * to next command of SFR clear command.

	/*

	 * 'LIST_HOLD' command should be set to the DMA_HOLD_CMD_REG

	 * and GCF bit should be set to INTEN register if user wants

	 * G2D interrupt event once current command list execution is

	 * finished.

	 * Otherwise only ACF bit should be set to INTEN register so

	 * that one interrupt is occurred after all command lists

	 * have been completed.

	/*

	 * Check the size of cmdlist. The 2 that is added last comes from

	 * the implicit G2D_BITBLT_START that is appended once we have

	 * checked all the submitted commands.

 head */

 tail */

 Let the runqueue know that there is work to do. */

 Remove the runqueue nodes that belong to us. */

	/*

	 * Wait for the runqueue worker to finish its current node.

	 * After this the engine should no longer be accessing any

	 * memory belonging to us.

	/*

	 * Even after the engine is idle, there might still be stale cmdlists

	 * (i.e. cmdlisst which we submitted but never executed) around, with

	 * their corresponding GEM/userptr buffers.

	 * Properly unmap these buffers here.

 release all g2d_userptr in pool. */

 allocate dma-aware cmdlist buffer. */

 Suspend operation and wait for engine idle. */

 There should be no locking needed here. */

	/*

	 * Suspend the runqueue worker operation and wait until the G2D

	 * engine is idle.

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Copyright (C) 2011 Samsung Electronics Co.Ltd

 * Authors: Joonyoung Shim <jy0922.shim@samsung.com>

/*

 * This function is to get X or Y size shown via screen. This needs length and

 * start position of CRTC.

 *

 *      <--- length --->

 * CRTC ----------------

 *      ^ start        ^ end

 *

 * There are six cases from a to f.

 *

 *             <----- SCREEN ----->

 *             0                 last

 *   ----------|------------------|----------

 * CRTCs

 * a -------

 *        b -------

 *        c --------------------------

 *                 d --------

 *                           e -------

 *                                  f -------

	/*

	 * The original src/dest coordinates are stored in exynos_state->base,

	 * but we want to keep another copy internal to our driver that we can

	 * clip/modify ourselves.

 set ratio */

 clip to visible area */

 set drm framebuffer data. */

 set plane range to be displayed. */

 translate state into exynos_state */

 SPDX-License-Identifier: GPL-2.0-or-later

/* drivers/gpu/drm/exynos/exynos7_drm_decon.c

 *

 * Copyright (C) 2014 Samsung Electronics Co.Ltd

 * Authors:

 *	Akshu Agarwal <akshua@gmail.com>

 *	Ajay Kumar <ajaykumar.rs@samsung.com>

/*

 * DECON stands for Display and Enhancement controller.

	/*

	 * wait for DECON to signal VSYNC interrupt or return after

	 * timeout which is set to 50ms (refresh rate of 20).

 Check if any channel is enabled. */

 Wait for vsync, as disable channel takes effect at next vsync */

 detach this sub driver from iommu mapping if supported. */

 Find the clock divider value that gets us closest to ideal_clk */

 nothing to do if we haven't set the mode yet */

 setup vertical timing values. */

 setup horizontal timing values.  */

 setup horizontal timing values.  */

 setup horizontal and vertical display size. */

	/*

	 * fields of register with prefix '_F' would be updated

	 * at vsync(same as dma start)

	/*

	 * In case of exynos, setting dma-burst to 16Word causes permanent

	 * tearing for very small buffers, e.g. cursor buffer. Burst Mode

	 * switching which is based on plane size is not recommended as

	 * plane size varies a lot towards the end of the screen and rapid

	 * movement causes unstable DMA which results into iommu crash/tear.

/**

 * decon_shadow_protect_win() - disable updating values from shadow registers at vsync

 *

 * @ctx: display and enhancement controller context

 * @win: window to protect registers for

 * @protect: 1 to protect (disable updates)

	/*

	 * SHADOWCON/PRTCON register is used for enabling timing.

	 *

	 * for example, once only width value of a register is set,

	 * if the dma is started then decon hardware could malfunction so

	 * with protect window setting, the register fields with prefix '_F'

	 * wouldn't be updated at vsync also but updated once unprotect window

	 * is set.

 buffer start address */

 buffer size */

 offset from the start of the buffer to read */

 OSD alpha */

 hardware window 0 doesn't support color key. */

 wincon */

 Enable DMA channel and unprotect windows */

 protect windows */

 wincon */

 if vblank was enabled status, enable it again. */

	/*

	 * We need to make sure that all windows are disabled before we

	 * suspend that connector. Otherwise we might try to scan from

	 * a destroyed buffer later.

 check the crtc is detached already from encoder */

 set wait vsync event to zero and wake up queue. */

 SPDX-License-Identifier: GPL-2.0-or-later

/* exynos_drm_vidi.c

 *

 * Copyright (C) 2012 Samsung Electronics Co.Ltd

 * Authors:

 *	Inki Dae <inki.dae@samsung.com>

 VIDI uses fixed refresh rate of 50Hz */

 vidi has totally three virtual windows. */

 use fake edid data for test. */

 if raw_edid isn't same as fake data then it can't be tested. */

		/*

		 * with connection = 0, free raw_edid

		 * only if raw edid data isn't same as fake data.

	/*

	 * connection request would come from user side

	 * to do hotplug through specific ioctl.

	/*

	 * the edid data comes from user side and it would be set

	 * to ctx->raw_edid through specific ioctl.

 SPDX-License-Identifier: GPL-2.0-or-later

/* exynos_drm_fimd.c

 *

 * Copyright (C) 2011 Samsung Electronics Co.Ltd

 * Authors:

 *	Joonyoung Shim <jy0922.shim@samsung.com>

 *	Inki Dae <inki.dae@samsung.com>

/*

 * FIMD stands for Fully Interactive Mobile Display and

 * as a display controller, it transfers contents drawn on memory

 * to a LCD Panel through Display Interfaces such as RGB or

 * CPU Interface.

 position control register for hardware window 0, 2 ~ 4.*/

/*

 * size control register for hardware windows 0 and alpha control register

 * for hardware windows 1 ~ 4

 size control register for hardware windows 1 ~ 2. */

 color key control register for hardware window 1 ~ 4. */

 color key value register for hardware window 1 ~ 4. */

 I80 trigger control register */

 Exynos3250, 3472, 5260 5410, 5420 and 5422 only supported. */

 Exynos3250, 3472, 5260, 5420 and 5422 only supported. */

 display mode change control register except exynos4 */

 I80 interface control for main LDI register */

 FIMD has totally five hardware windows. */

 HW trigger flag on i80 panel. */

	/*

	 * wait for FIMD to signal VSYNC interrupt or return after

	 * timeout which is set to 50ms (refresh rate of 20).

 Hardware is in unknown state, so ensure it gets enabled properly */

 Check if any channel is enabled. */

 Wait for vsync, as disable channel takes effect at next vsync */

		/*

		 * The frame done interrupt should be occurred prior to the

		 * next TE signal.

 Find the clock divider value that gets us closest to ideal_clk */

 nothing to do if we haven't set the mode yet */

 disable auto frame rate */

 set video type selection to I80 interface */

 setup polarity values */

 setup vertical timing values. */

 setup horizontal timing values.  */

 set bypass selection */

	/* TODO: When MIC is enabled for display path, the lcdblk_mic_bypass

	 * bit should be cleared.

 setup horizontal and vertical display size. */

	/*

	 * fields of register with prefix '_F' would be updated

	 * at vsync(same as dma start)

 OSD alpha */

	/*

	 * In case of s3c64xx, window 0 doesn't support alpha channel.

	 * So the request format is ARGB8888 then change it to XRGB8888.

	/*

	 * Setting dma-burst to 16Word causes permanent tearing for very small

	 * buffers, e.g. cursor buffer. Burst Mode switching which based on

	 * plane size is not recommended as plane size varies alot towards the

	 * end of the screen and rapid movement causes unstable DMA, but it is

	 * still better to change dma-burst than displaying garbage.

 hardware window 0 doesn't support alpha channel. */

/**

 * fimd_shadow_protect_win() - disable updating values from shadow registers at vsync

 *

 * @ctx: local driver data

 * @win: window to protect registers for

 * @protect: 1 to protect (disable updates)

	/*

	 * SHADOWCON/PRTCON register is used for enabling timing.

	 *

	 * for example, once only width value of a register is set,

	 * if the dma is started then fimd hardware could malfunction so

	 * with protect window setting, the register fields with prefix '_F'

	 * wouldn't be updated at vsync also but updated once unprotect window

	 * is set.

 buffer start address */

 buffer end address */

 buffer size */

 OSD position */

 OSD size */

 hardware window 0 doesn't support color key. */

 if vblank was enabled status, enable it again. */

	/*

	 * We need to make sure that all windows are disabled before we

	 * suspend that connector. Otherwise we might try to scan from

	 * a destroyed buffer later.

	 /*

	  * Skips triggering if in triggering state, because multiple triggering

	  * requests can cause panel reset.

 Enters triggering mode */

	/*

	 * Exits triggering mode if vblank is not enabled yet, because when the

	 * VIDINTCON0 register is not set, it can not exit from triggering mode.

 Checks the crtc is detached already from encoder */

	/*

	 * If there is a page flip request, triggers and handles the page flip

	 * event so that current fb can be updated into panel GRAM.

 Wakes up vsync event queue */

 check the crtc is detached already from encoder */

 Exits triggering mode */

 set wait vsync event to zero and wake up queue. */

		/*

		 * The user manual describes that this "DSI_EN" bit is required

		 * to enable I80 24-bit data interface.

 SPDX-License-Identifier: GPL-2.0-or-later

/*

 * Samsung SoC DP (Display Port) interface driver.

 *

 * Copyright (C) 2012 Samsung Electronics Co., Ltd.

 * Author: Jingoo Han <jg1.han@samsung.com>

 Pre-empt DP connector creation if there's a bridge */

 do nothing */

	/*

	 * We just use the drvdata until driver run into component

	 * add function, and then we would set drvdata to null, so

	 * that analogix dp driver would take charge of the drvdata.

 This is for the backward compatibility. */

 The remote port can be either a panel or a bridge */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Exynos DRM Parallel output support.

 *

 * Copyright (c) 2014 Samsung Electronics Co., Ltd

 *

 * Contacts: Andrzej Hajda <a.hajda@samsung.com>

 fimd timings gets precedence over panel modes */

/*

 * Copyright 2012 Red Hat Inc.

 * Parts based on xf86-video-ast

 * Copyright (c) 2005 ASPEED Technology Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors: Dave Airlie <airlied@redhat.com>

 Set SEQ; except Screen Disable field */

 Set CRTC; except base address and offset */

 set AR */

 Set GR */

 HT D[8] */

 HDE D[8] */

 HBS D[8] */

 HBE D[5] */

 HBE D[5] */

 HRS D[5] */

 HRE D[5] */

 vert timings */

 Set Threshold */

/*

 * Primary plane

 Bug: we didn't pin the BO to VRAM in prepare_fb. */

/*

 * Cursor plane

 write checksum + signature */

 TODO: Use mapping abstraction properly */

 TODO: Use mapping abstraction properly */

 TODO: Use mapping abstraction properly */

	/*

	 * Do data transfer to HW cursor BO. If a new cursor image was installed,

	 * point the scanout engine to dst_gbo's offset and page-flip the HWC buffers.

	/*

	 * Update location in HWC signature and registers.

 Dummy write to enable HWC and make the HW pick-up the changes. */

	/*

	 * Allocate backing storage for cursors. The BOs are permanently

	 * pinned to the top end of the VRAM.

	/*

	 * Create the cursor plane. The plane's destroy callback will release

	 * the backing storages' BO memory.

/*

 * CRTC

	/* TODO: Maybe control display signal generation with

	 *       Sync Enable (bit CR17.7).

 no mode checks if CRTC is being disabled */

 BUG: We didn't set format in primary check(). */

	/*

	 * The gamma LUT has to be reloaded after changing the primary

	 * plane's color format.

	/*

	 * HW cursors require the underlying primary plane and CRTC to

	 * display a valid mode and image. This is not the case during

	 * full modeset operations. So we temporarily disable any active

	 * plane, including the HW cursor. Each plane's atomic_update()

	 * helper will re-enable it if necessary.

	 *

	 * We only do this during *full* modesets. It does not affect

	 * simple pageflips on the planes.

	/*

	 * Ensure that no scanout takes place before reprogramming mode

	 * and format registers.

/*

 * Encoder

/*

 * Connector

/*

 * Mode config

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors: Dave Airlie <airlied@redhat.com>

 Defaults */

 Check if we have device-tree properties */

 We do, disable P2A access */

 Not all families have a P2A bridge */

	/*

	 * The BMC will set SCU 0x40 D[12] to 1 if the P2 bridge

	 * is disabled. We force using P2A if VGA only mode bit

	 * is set D[7]

 Patch AST2500 */

 Double check it's actually working */

 P2A works, grab silicon revision */

 Read SCU7c (silicon revision register) */

 We have a P2A bridge but it's disabled */

	/*

	 * If VGA isn't enabled, we need to enable now or subsequent

	 * access to the scratch registers will fail. We also inform

	 * our caller that it needs to POST the chip

	 * (Assumption: VGA not enabled -> need to POST)

 Enable extended register access */

 Find out whether P2A works or whether to use device-tree */

 Identify chipset */

 Check if we support wide screen */

 ast1300 */

 ast1400 */

 ast2510 */

 Check 3rd Tx option (digital output afaik) */

	/*

	 * VGACRA3 Enhanced Color Mode Register, check if DVO is already

	 * enabled, in that case, assume we have a SIL164 TMDS transmitter

	 *

	 * Don't make that assumption if we the chip wasn't enabled and

	 * is at power-on reset, otherwise we'll incorrectly "detect" a

	 * SIL164 when there is none.

		/*

		 * On AST2300 and 2400, look the configuration set by the SoC in

		 * the SOC scratch register #1 bits 11:8 (interestingly marked

		 * as "reserved" in the spec)

 backup firmware */

 Print stuff for diagnostic purposes */

		/*

		 * If some properties are missing, use reasonable

		 * defaults for AST2400

/*

 * Run this function as part of the HW device cleanup; not

 * when the DRM device gets released.

 enable standard VGA decode */

	/*

	 * If we don't have IO space at all, use MMIO now and

	 * assume the chip has MMIO enabled by default (rev 0x20

	 * and higher).

 "map" IO regs if the above hasn't done so already */

 map reserved buffer */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors: Dave Airlie <airlied@redhat.com>

 reset scratch */

 disable standard IO/MEM decode if secondary */

 ast_set_index_reg-mask(ast, AST_IO_CRTC_PORT, 0xa1, 0xff, 0x3); */

 Set Ext. Default */

 Enable RAMDAC for A1 */

/*

 * AST2100/2150 DLL CBR Setting

 unused in DDX driver - here for completeness */

 VGA only */

 AST2100/1100 */

 delay fn */

 AST 2100/2150 DRAM calibration */

 266Mhz */

 16 bits */

 32 bits */

 wait ready */

 Enable DVO */

 AST 2300 DRAM settings */

/*

 * DQSI DLL CBR Setting

 finetuneDQI_L */

 Disable DQI CBR */

 Search margin */

 CBRDLL2 */

 Ger trap info */

 switch freq */

 switch size */

 Wait MCLK2X lock to MCLK */

 Mode Register Setting */

 Calibrate the DQSI delay */

 ECC Memory Initialization */

 Ger trap info */

 switch size */

 Wait MCLK2X lock to MCLK */

 Mode Register Setting */

 Calibrate the DQSI delay */

 ECC Memory Initialization */

 vga only */

 Slow down CPU/AHB CLK in VGA only mode */

 wait ready */

 delay 10 us */

/*

 * Check DRAM Size

 * 1Gb : 0x80000000 ~ 0x87FFFFFF

 * 2Gb : 0x80000000 ~ 0x8FFFFFFF

 * 4Gb : 0x80000000 ~ 0x9FFFFFFF

 * 8Gb : 0x80000000 ~ 0xBFFFFFFF

 Check 8Gbit */

 Check 4Gbit */

 Check 2Gbit */

 Reset MMC */

 CLKIN = 25MHz */

 CLKIN = 24MHz */

 MODEREG4/6 */

 MODEREG5 */

 MODEREG0/2 */

 MODEREG1/3 */

 DDR PHY Setting */

 Controller Setting */

 Wait DDR PHY init done */

 MODEREG4/6 */

 MODEREG5 */

 MODEREG0/2 */

 MODEREG1/3 */

 DDR PHY Setting */

 Controller Setting */

 Train PHY Vref first */

 Fire DFI Init */

 Train DDR Vref next */

 Fire DFI Init */

 Wait DDR PHY init done */

 Patch code */

 Clear bus lock condition */

 check fast reset */

		/*

		 * If "Fast restet" is enabled for ARM-ICE debugger,

		 * then WDT needs to enable, that

		 * WDT04 is WDT#1 Reload reg.

		 * WDT08 is WDT#1 counter restart reg to avoid system deadlock

		 * WDT0C is WDT#1 control reg

		 *	[6:5]:= 01:Full chip

		 *	[4]:= 1:1MHz clock source

		 *	[1]:= 1:WDT will be cleeared and disabled after timeout occurs

		 *	[0]:= 1:WDT enable

 clear fast reset */

 vga only */

 Clear bus lock condition */

 Disable watchdog */

		/*

		 * Reset USB port to patch USB unknown device issue

		 * SCU90 is Multi-function Pin Control #5

		 *	[29]:= 1:Enable USB2.0 Host port#1 (that the mutually shared USB2.0 Hub

		 *				port).

		 * SCU94 is Multi-function Pin Control #6

		 *	[14:13]:= 1x:USB2.0 Host2 controller

		 * SCU70 is Hardware Strap reg

		 *	[23]:= 1:CLKIN is 25MHz and USBCK1 = 24/48 MHz (determined by

		 *				[18]: 0(24)/1(48) MHz)

		 * SCU7C is Write clear reg to SCU70

		 *	[23]:= write 1 and then SCU70[23] will be clear as 0b.

 Modify eSPI reset pin */

 Slow down CPU/AHB CLK in VGA only mode */

 wait ready */

 SPDX-License-Identifier: GPL-2.0

 Get BootAddress */

 -2MB */

 copy image to buffer */

 Init SCU */

 Launch FW */

 Update Scratch */

 D[11:9] = 100b: UEFI handling */

 D[1:0]: Reserved Video Buffer */

 validate FW version */

 version: 1x */

 Read Link Capability */

 1024x768 as default */

 dummy read */

 validate FW version */

 version: 1x */

 Read Link Capability */

 validate FW version */

 validate PnP Monitor */

 Read EDID */

 dummy read */

 validate FW version */

 validate PnP Monitor */

 Read EDID */

 Init SCU DVO Settings */

 delay phase */

 multi-pins for DVO single-edge */

 multi-pins for DVO single-edge */

 multi-pins for DVO single-edge */

 AST2400 */

 multi-pins for DVO single-edge */

 multi-pins for DVO single-edge */

 multi-pins for DVO single-edge */

 multi-pins for DVO single-edge */

 multi-pins for DVO single-edge */

 Force to DVO */

 Init VGA DVO Settings */

	/*

	 * Set DAC source to VGA mode in SCU2C via the P2A

	 * bridge. First configure the P2U to target the SCU

	 * in case it isn't at this stage.

 Then unlock the SCU with the magic password */

 Finally, clear bits [17:16] of SCU2c */

 Disable DVO */

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors: Dave Airlie <airlied@redhat.com>

/*

 * DRM driver

/*

 * PCI driver

/*

 * Copyright 2012 Red Hat Inc.

 *

 * Permission is hereby granted, free of charge, to any person obtaining a

 * copy of this software and associated documentation files (the

 * "Software"), to deal in the Software without restriction, including

 * without limitation the rights to use, copy, modify, merge, publish,

 * distribute, sub license, and/or sell copies of the Software, and to

 * permit persons to whom the Software is furnished to do so, subject to

 * the following conditions:

 *

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR

 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,

 * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL

 * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,

 * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR

 * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE

 * USE OR OTHER DEALINGS IN THE SOFTWARE.

 *

 * The above copyright notice and this permission notice (including the

 * next paragraph) shall be included in all copies or substantial portions

 * of the Software.

 *

/*

 * Authors: Dave Airlie <airlied@redhat.com>

 Don't fail on errors, but performance might be reduced. */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/* prepare/pin all the fb's bo's for scanout.  Note that it is not valid

 * to prepare an fb more multiple different initiator 'id's.  But that

 * should be fine, since only the scanout (mdpN) side of things needs

 * this, the gpu doesn't care about fb's.

 allocate backing bo */

 try regular bo: */

		/* note: if fb creation failed, we can't rely on fb destroy

		 * to unref the bo:

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * Power Management:

	/*

	 * If the GPU is idle, devfreq is not aware, so just ignore

	 * it's requests

 We need target support to do devfreq */

	/*

	 * Don't set the freq_table or max_state and let devfreq build the table

	 * from OPP

	 * After a deferred probe, these may have be left to non-zero values,

	 * so set them back to zero before creating the devfreq device

	/*

	 * Cancel any pending transition to idle frequency:

	/*

	 * Hold devfreq lock to synchronize with get_dev_status()/

	 * target() callbacks

	/*

	 * If we've been idle for a significant fraction of a polling

	 * interval, then we won't meet the threshold of busyness for

	 * the governor to ramp up the freq.. so give some boost

	/*

	 * Reset the polling interval so we aren't inconsistent

	 * about freq vs busy/total cycles

	/*

	 * Hold devfreq lock to synchronize with get_dev_status()/

	 * target() callbacks

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/* For profiling, userspace can:

 *

 *   tail -f /sys/kernel/debug/dri/<minor>/gpu

 *

 * This will enable performance counters/profiling to track the busy time

 * and any gpu specific performance counters that are supported.

 wait for next sample time: */

 interrupted */

 Header line: */

 Sample line: */

 sleep until next sample time: */

 cycle counters (I think).. convert to MHz.. */

 only create on first minor: */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 Unmap the block one page at a time */

 Map the block one page at a time */

	/*

	 * If this is the last attached pagetable for the parent,

	 * disable TTBR0 in the arm-smmu driver

 Get the pagetable configuration from the domain */

	/*

	 * Defer setting the fault handler until we have a valid adreno_smmu

	 * to avoid accidentially installing a GPU specific fault handler for

	 * the display's iommu

 Clone the TTBR1 cfg as starting point for TTBR0 cfg: */

 The incoming cfg will have the TTBR1 quirk enabled */

	/*

	 * If this is the first pagetable that we've allocated, send it back to

	 * the arm-smmu driver as a trigger to set up TTBR0

 Enable stall on iommu fault: */

 Needed later for TLB flush */

	/*

	 * TODO we would like each set of page tables to have a unique ASID

	 * to optimize TLB invalidation.  But iommu_flush_iotlb_all() will

	 * end up flushing the ASID used for TTBR1 pagetables, which is not

	 * what we want.  So for now just use the same ASID as TTBR1.

 The arm-smmu driver expects the addresses to be sign extended */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * Power Management:

 Set the RBBM timer rate to 19.2Mhz */

	/*

	 * Set the clock to a deliberately low rate. On older targets the clock

	 * speed had to be non zero to avoid problems. On newer targets this

	 * will be rounded down to zero anyway so it all works out.

 Don't record write only objects */

 Only store data for non imported buffer objects marked for read */

 Check if the target supports capturing crash state */

 Only save one crash state at a time */

 Fill in the additional crash state information */

 count # of buffers to dump: */

 always dump cmd bo's, but don't double count them: */

 Set the active crash state to be dumped on failure */

 FIXME: Release the crashstate if this errors out? */

/*

 * Hangcheck detection for locked gpu:

 Increment the fault counts */

 Record the crash state */

	/*

	 * Update all the rings with the latest and greatest fence.. this

	 * needs to happen after msm_rd_dump_submit() to ensure that the

	 * bo's referenced by the offending submit are still around.

		/*

		 * For the current (faulting?) ring/submit advance the fence by

		 * one more to clear the faulting submit

 retire completed submits, plus the one that hung: */

		/*

		 * Replay all remaining submits starting with highest priority

		 * ring

		/*

		 * When we get GPU iova faults, we can get 1000s of them,

		 * but we really only want to log the first one.

 Record the crash state */

 some progress has been made.. ya! */

 no progress and not done.. hung! */

 if still more pending work, reset the hangcheck timer: */

 workaround for missing irq: */

/*

 * Performance Counters:

 called under perf_lock */

 read current values: */

 update cntrs: */

 save current values: */

 we could dynamically enable/disable perfcntr registers too.. */

 returns -errno or # of cntrs sampled */

/*

 * Cmdstream submission/retirement:

 Convert 19.2Mhz alwayson ticks to nanoseconds for elapsed time */

 Calculate the clock frequency from the number of CP cycles */

 Update devfreq on transition from active->idle: */

 Retire the commits starting with highest priority */

			/*

			 * If no submit, we are done.  If submit->fence hasn't

			 * been signalled, then later submits are not signalled

			 * either, so we are also done.

 call from irq handler to schedule work to retire bo's */

 add bo's to gpu's ring, and kick gpu: */

	/*

	 * ring->submits holds a ref to the submit, to deal with the case

	 * that a submit completes before msm_ioctl_gem_submit() returns.

 Update devfreq on transition from idle->active: */

/*

 * Init/Cleanup:

 Return a new address space for a msm_drm_private instance */

	/*

	 * If the target doesn't support private address spaces then return

	 * the global one

 Map registers: */

 Get Interrupt: */

 Acquire regulators: */

 Create ringbuffer(s): */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013-2016 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

	/*

	 * Note: Check completed_fence first, as fenceptr is in a write-combine

	 * mapping, so it will be more expensive to read.

 called from workqueue */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2016 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/* Default disabled for now until it has some more testing on the different

 * iommu combinations that can be paired with the driver:

	/*

	 * This will move the obj out of still_in_list to

	 * the purged list

		/*

		 * If it is in the process of being freed, msm_gem_free_object

		 * can be blocked on mm_lock waiting to remove it.  So just

		 * skip it.

		/*

		 * Now that we own a reference, we can drop mm_lock for the

		 * rest of the loop body, to reduce contention with the

		 * retire_submit path (which could make more objects purgeable)

		/*

		 * Note that this still needs to be trylock, since we can

		 * hit shrinker in response to trying to get backing pages

		 * for this obj (ie. while it's lock is already held)

/* since we don't know any better, lets bail after a few

 * and if necessary the shrinker will be invoked again.

 * Seems better than unmapping *everything*

/**

 * msm_gem_shrinker_init - Initialize msm shrinker

 * @dev: drm device

 *

 * This function registers and sets up the msm shrinker.

/**

 * msm_gem_shrinker_cleanup - Clean up msm shrinker

 * @dev: drm device

 *

 * This function unregisters the msm shrinker.

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2017 The Linux Foundation. All rights reserved.

	/*

	 * No lock needed in close and there won't

	 * be any more user ioctls coming our way

	/* We should have already validated that the requested priority is

	 * valid by the time we get here.

/*

 * Create the default submit-queue (id==0), used for backwards compatibility

 * for userspace that pre-dates the introduction of submitqueues.

	/*

	 * Pick a medium priority level as default.  Lower numeric value is

	 * higher priority, so round-up to pick a priority that is not higher

	 * than the middle priority level.

 If a zero length was passed in, return the data size we expect */

 Set the length to the actual size of the data */

	/*

	 * id 0 is the "default" queue and can't be destroyed

	 * by the user

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * Cmdstream submission:

 make sure these don't conflict w/ MSM_SUBMIT_BO_x */

 is current addr in cmdstream correct/valid? */

 obj lock is held */

 active refcnt is held */

 obj is pinned and on active list */

		/* make sure we don't have garbage flags, in case we hit

		 * error path before flags is initialized:

 at least one of READ and/or WRITE flags should be set: */

 in validate_objects() we figure out if this is true: */

		/* normally use drm_gem_object_lookup(), but for bulk lookup

		 * all under single table_lock just hit object_idr directly:

 validate input from userspace: */

 check for overflow: */

/* Unwind bo state, according to cleanup_flags.  In the success case, only

 * the lock is dropped at the end of the submit (and active/pin ref is dropped

 * later when the submit is retired).

 This is where we make sure all the bo's are reserved and pin'd: */

 we lost out in a seqno race, lock and retry.. */

		/* Not expecting -EALREADY here, if the bo was already

		 * locked, we should have gotten -EALREADY already from

		 * the dma_resv_lock_interruptable() call.

			/* NOTE: _reserve_shared() must happen before

			 * _add_shared_fence(), which makes this a slightly

			 * strange place to call it.  OTOH this is a

			 * convenient can-fail point to hook it in.

 exclusive fences must be ordered */

	/*

	 * Increment active_count first, so if under memory pressure, we

	 * don't inadvertently evict a bo needed by the submit in order

	 * to pin an earlier bo in the same submit.

 if locking succeeded, pin bo: */

 iova changed, so address in cmdstream is not valid: */

 process the reloc's and patch up the cmdstream as needed: */

	/* For now, just map the entire thing.  Eventually we probably

	 * to do it page-by-page, w/ kmap() if not vmap()d..

 offset in dwords: */

/* Cleanup submit at end of ioctl.  In the error case, this also drops

 * references, unpins, and drops active refcnt.  In the non-error case,

 * this is done when the submit is retired.

	/* for now, we just have 3d pipe.. eventually this would need to

	 * be more clever to dispatch to appropriate gpu module:

 Get a unique identifier for the submission for logging purposes */

 copy_*_user while holding a ww ticket upsets lockdep */

	/*

	 * Allocate an id which can be used by WAIT_FENCE ioctl to map back

	 * to the underlying fence.

 The scheduler owns a ref now: */

 SPDX-License-Identifier: GPL-2.0

 Copyright (c) 2018 The Linux Foundation. All rights reserved. */

 we can improve by deferring flush for multiple map() */

 32-byte aligned */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/* For debugging crashes, userspace can:

 *

 *   tail -f /sys/kernel/debug/dri/<minor>/rd > logfile.rd

 *

 * to log the cmdstream in a format that is understood by freedreno/cffdump

 * utility.  By comparing the last successfully completed fence #, to the

 * cmdstream for the next fence, you can narrow down which process and submit

 * caused the gpu crash/lockup.

 *

 * Additionally:

 *

 *   tail -f /sys/kernel/debug/dri/<minor>/hangrd > logfile.rd

 *

 * will capture just the cmdstream from submits which triggered a GPU hang.

 *

 * This bypasses drm_debugfs_create_files() mainly because we need to use

 * our own fops for a bit more control.  In particular, we don't want to

 * do anything if userspace doesn't have the debugfs file open.

 *

 * The module-param "rd_full", which defaults to false, enables snapshotting

 * all (non-written) buffers in the submit, rather than just cmdstream bo's.

 * This is useful to capture the contents of (for example) vbo's or textures,

 * or shader programs (if not emitted inline in cmdstream).

 ascii text */

 ascii text */

 u32 gpuaddr, u32 size */

 raw dump */

 raw dump */

 gpu addr of cmdstream */

 u32 param_type, u32 param_val, u32 bitlen */

 empty, clear previous params */

 shader program, raw dump */

 should be power of 2 */

 space used: */

 space available: */

 current submit to read out: */

	/* fifo access is synchronized on the producer side by

	 * struct_mutex held by submit code (otherwise we could

	 * end up w/ cmds logged in different order than they

	 * were executed).  And read_lock synchronizes the reads

		/* Note that smp_load_acquire() is not strictly required

		 * as CIRC_SPACE_TO_END() does not access the tail more

		 * than once.

	/* Note that smp_load_acquire() is not strictly required

	 * as CIRC_CNT_TO_END() does not access the head more than

	 * once.

	/* the parsing tools need to know gpu-id to know which

	 * register database to load.

 only create on first minor: */

	/*

	 * Always write the GPUADDR header so can get a complete list of all the

	 * buffers in the cmd

 But only dump the contents of buffers marked READ */

 called under struct_mutex */

	/* writing into fifo is serialized by caller, and

	 * rd->read_lock is used to serialize the reads

 in dwords */

 snapshot cmdstream bo's (if we haven't already): */

 in dwords */

			/* ignore IB-targets, we've logged the buffer, the

			 * parser tool will follow the IB based on the logged

			 * buffer/gpuaddr, so nothing more to do.

 SPDX-License-Identifier: GPL-2.0

 SPDX-License-Identifier: GPL-2.0

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * fbdev funcs, to implement legacy fbdev interface on top of drm driver

	/* Note: to properly handle manual update displays, we wrap the

	 * basic fbdev ops which write to the framebuffer

	/*

	 * NOTE: if we can be guaranteed to be able to map buffer

	 * in panic (ie. lock-safe, etc) we could avoid pinning the

	 * buffer now:

 initialize fbdev helper */

 the fw fb could be anywhere in memory */

 this will free the backing object */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2016 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 Actually unmap memory for the vma */

 Print a message if we try to purge a vma in use */

 Don't do anything if the memory isn't mapped */

 Remove reference counts for the mapping */

 Increase the usage counter */

 Close an iova.  Warn if it is still in use */

 Initialize a new vma and allocate an iova for it */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2016-2018, 2020-2021 The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * MSM driver version:

 * - 1.0.0 - initial interface

 * - 1.1.0 - adds madvise, and support for submits with > 4 cmd buffers

 * - 1.2.0 - adds explicit fence support for submit ioctl

 * - 1.3.0 - adds GMEM_BASE + NR_RINGS params, SUBMITQUEUE_NEW +

 *           SUBMITQUEUE_CLOSE ioctls, and MSM_INFO_IOVA flag for

 *           MSM_GEM_INFO ioctl.

 * - 1.4.0 - softpin, MSM_RELOC_BO_DUMP, and GEM_INFO support to set/get

 *           GEM object's debug name

 * - 1.5.0 - Add SUBMITQUERY_QUERY ioctl

 * - 1.6.0 - Syncobj support

 * - 1.7.0 - Add MSM_PARAM_SUSPENDS to access suspend count

 * - 1.8.0 - Add MSM_BO_CACHED_COHERENT for supported GPUs (a6xx)

/*

 * Util/helpers:

	/*

	 * Shutdown the hw if we're far enough along where things might be on.

	 * If we run this too early, we'll end up panicking in any variety of

	 * places. Since we don't register the drm device until late in

	 * msm_drm_init, drm_dev->registered is used as an indicator that the

	 * shutdown will be successful.

	/* We must cancel and cleanup any pending vblank enable/disable

	 * work before msm_irq_uninstall() to avoid work re-enabling an

	 * irq after uninstall has disabled it.

 clean up event worker threads */

 a2xx comes with its own MMU */

	/* In the device-tree world, we could have a 'memory-region'

	 * phandle, which gives us a link to our "vram".  Allocating

	 * is all nicely abstracted behind the dma api, but we need

	 * to know the entire size to allocate it all in one go. There

	 * are two cases:

	 *  1) device with no IOMMU, in which case we need exclusive

	 *     access to a VRAM carveout big enough for all gpu

	 *     buffers

	 *  2) device with IOMMU, but where the bootloader puts up

	 *     a splash screen.  In this case, the VRAM carveout

	 *     need only be large enough for fbdev fb.  But we need

	 *     exclusive access to the buffer to avoid the kernel

	 *     using those pages for other purposes (which appears

	 *     as corruption on screen before we have a chance to

	 *     load and do initial modeset)

		/* if we have no IOMMU, then we need to use carveout allocator.

		 * Grab the entire CMA chunk carved out in early startup in

		 * mach-msm:

		/* note that for no-kernel-mapping, the vaddr returned

		 * is bogus, but non-null if allocation succeeded:

 Teach lockdep about lock ordering wrt. shrinker: */

 Bind all our sub-components: */

 valid only for the dummy headless case, where of_node=NULL */

 Enable normalization of plane zpos */

 initialize event thread */

/*

 * DRM operations:

	/* For now, load gpu on open.. to avoid the requirement of having

	 * firmware in the initrd.

/*

 * DRM ioctls:

	/* for now, we just have 3d pipe.. eventually this would need to

	 * be more clever to dispatch to appropriate gpu module:

	/*

	 * Don't pin the memory here - just get an address so that userspace can

	 * be productive

 value returned as immediate, not pointer, so len==0: */

 length check should leave room for terminating null: */

	/*

	 * Map submitqueue scoped "seqno" (which is actually an idr key)

	 * back to underlying dma-fence

	 *

	 * The fence is removed from the fence_idr when the submit is

	 * retired, so if the fence is not found it means there is nothing

	 * to wait for

/*

 * Componentized driver support:

/*

 * NOTE: duplication of the same code as exynos or imx (or probably any other).

 * so probably some room for some helpers

/*

 * Identify what components need to be added by parsing what remote-endpoints

 * our MDP output ports are connected to. In the case of LVDS on MDP4, there

 * is no external component that we need to add since LVDS is within MDP4

 * itself.

	/*

	 * on MDP4 based platforms, the MDP platform device is the component

	 * master that adds other display interface components to itself.

	 *

	 * on MDP5 based platforms, the MDSS platform device is the component

	 * master that adds MDP5 and other display interface components to

	 * itself.

		/*

		 * The LCDC/LVDS port on MDP4 is a speacial case where the

		 * remote-endpoint isn't a component that we need to add

		/*

		 * It's okay if some of the ports don't have a remote endpoint

		 * specified. It just means that the port isn't connected to

		 * any external interface.

	/*

	 * MDP5/DPU based devices don't have a flat hierarchy. There is a top

	 * level parent: MDSS, and children: MDP5/DPU, DSI, HDMI, eDP etc.

	 * Populate the children devices, find the MDP5/DPU node, and then add

	 * the interfaces to our components list.

 add the MDP component itself */

 MDP4 */

/*

 * We don't know what's the best binding to link the gpu with the drm device.

 * Fow now, we just hunt for all the possible gpus that we support, and add them

 * as components.

/*

 * Platform driver:

	/* on all devices that I am aware of, iommu's which can map

	 * any address the cpu can see are used:

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * Cache sync.. this is a bit over-complicated, to fit dma-mapping

 * API.  Really GPU cache is out of scope here (handled on cmdstream)

 * and all we need to do is invalidate newly allocated pages before

 * mapping to CPU as uncached/writecombine.

 *

 * On top of this, we have the added headache, that depending on

 * display generation, the display's iommu may be wired up to either

 * the toplevel drm device (mdss), or to the mdp sub-node, meaning

 * that here we either have dma-direct or iommu ops.

 *

 * Let this be a cautionary tail of abstraction gone wrong.

 allocate pages from VRAM carveout, used when no IOMMU: */

		/* For non-cached buffers, ensure the new pages are clean

		 * because display controller, GPU, etc. are not coherent:

			/* For non-cached buffers, ensure the new

			 * pages are clean because display controller,

			 * GPU, etc. are not coherent:

	/*

	 * vm_ops.open/drm_gem_mmap_obj and close get and put

	 * a reference on obj. So, we dont need to hold one here.

 make sure we have pages attached now */

 We don't use vmf->pgoff since that has the fake offset: */

* get mmap offset */

 Make it mmapable */

/*

 * If close is true, this also closes the VMA (releasing the allocated

 * iova range) in addition to removing the iommu mapping.  In the eviction

 * case (!close), we keep the iova allocated, but only remove the iommu

 * mapping.

 Called with msm_obj locked */

/*

 * get iova and pin it. Should have a matching put

 * limits iova to specified range (in pages)

 get iova and pin it. Should have a matching put */

/*

 * Get an iova but don't pin it. Doesn't need a put because iovas are currently

 * valid for the life of the object

/* get iova without taking a reference, used in places where you have

 * already done a 'msm_gem_get_and_pin_iova' or 'msm_gem_get_iova'

/*

 * Locked variant of msm_gem_unpin_iova()

/*

 * Unpin a iova by updating the reference counts. The memory isn't actually

 * purged until something else (shrinker, mm_notifier, destroy, etc) decides

 * to get rid of it

 GEM does all our handle to object mapping */

	/* increment vmap_count *before* vmap() call, so shrinker can

	 * check vmap_count (is_vunmapable()) outside of msm_obj lock.

	 * This guarantees that we won't try to msm_gem_vunmap() this

	 * same object from within the vmap() call (while we already

	 * hold msm_obj lock)

/*

 * Don't use this!  It is for the very special case of dumping

 * submits from GPU hangs or faults, were the bo may already

 * be MSM_MADV_DONTNEED, but we know the buffer is still on the

 * active list.

/* Update madvise status, returns true if not purged, else

 * false or -errno.

	/* If the obj is inactive, we might need to move it

	 * between inactive lists

 Get rid of any iommu mapping(s): */

	/* Our goal here is to return as much of the memory as

	 * is possible back to the system as we are called from OOM.

	 * To do this we must instruct the shmfs to drop all of its

	 * backing pages, *now*.

/*

 * Unpin the backing pages and make them available to be swapped out.

 Get rid of any iommu mapping(s): */

 TODO cache maintenance */

 TODO cache maintenance */

 don't call directly!  Use drm_gem_object_put() */

 object should not be on active list: */

		/* Don't drop the pages for imported dmabuf, as they are not

		 * ours, just free the array we allocated:

		/* dma_buf_detach() grabs resv lock, so we need to unlock

		 * prior to drm_prime_gem_destroy

 convenience method to construct a GEM buffer object, and userspace handle */

 drop reference from allocate - handle holds it now */

	/* Disallow zero sized objects as they make the underlying

	 * infrastructure grumpy

		/* Call chain get_pages() -> update_inactive() tries to

		 * access msm_obj->mm_list, but it is not initialized yet.

		 * To avoid NULL pointer dereference error, initialize

		 * mm_list to be empty.

		/*

		 * Our buffers are kept pinned, so allocating them from the

		 * MOVABLE zone is a really bad idea, and conflicts with CMA.

		 * See comments above new_inode() why this is required _and_

		 * expected if you're going to pin these pages.

 if we don't have IOMMU, don't bother pretending we can import: */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013-2016 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 TODO move submit path over to using a per-ring lock.. */

 We assume everwhere that MSM_GPU_RINGBUFFER_SZ is a power of 2 */

 currently managing hangcheck ourselves: */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * Helpers to control vblanks while we flush.. basically just to ensure

 * that vblank accounting is switched on, so we get valid seqn/timestamp

 * on pageflip events (if requested)

	/*

	 * Flush hardware updates:

	/*

	 * Wait for flush to complete:

 any connector change, means slow path: */

/* Get bitmask of crtcs that will need to be flushed.  The bitmask

 * can be used with for_each_crtc_mask() iterator, to iterate

 * effected crtcs without needing to preserve the atomic state.

	/*

	 * Ensure any previous (potentially async) commit has

	 * completed:

	/*

	 * Now that there is no in-progress flush, prepare the

	 * current update:

	/*

	 * Push atomic updates down to hardware:

 async updates are limited to single-crtc updates: */

		/*

		 * Start timer if we don't already have an update pending

		 * on this crtc:

		/*

		 * At this point, from drm core's perspective, we

		 * are done with the atomic update, so we can just

		 * go ahead and signal that it is done:

	/*

	 * If there is any async flush pending on updated crtcs, fold

	 * them into the current flush.

	/*

	 * Flush hardware updates:

	/*

	 * Wait for flush to complete:

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 should have already pinned! */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2017-2020, The Linux Foundation. All rights reserved.

/**

 * dp_connector_detect - callback to determine if connector is connected

 * @conn: Pointer to drm connector structure

 * @force: Force detect setting from drm framework

 * Returns: Connector 'is connected' status

/**

 * dp_connector_get_modes - callback to add drm modes via drm_mode_probed_add()

 * @connector: Pointer to drm connector structure

 * Returns: Number of modes added

 pluggable case assumes EDID is read when HPD */

		/*

		 *The get_modes() function might return one mode that is stored

		 * in dp_mode when compliance test is in progress. If not, the

		 * return value is equal to the total number of modes supported

		 * by the sink

 valid DP mode */

/**

 * dp_connector_mode_valid - callback to determine if specified mode is valid

 * @connector: Pointer to drm connector structure

 * @mode: Pointer to drm mode structure

 * Returns: Validity status for specified mode

 connector initialization */

	/*

	 * Enable HPD to let hpd event is handled when cable is connected.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2012-2020, The Linux Foundation. All rights reserved.

	/*

	 * cmd fifo only has depth of 144 bytes

	 * limit buf length to 128 bytes here

 Pack cmd and write to HW */

 addr[19:16] */

 R/W */

 addr[15:8] */

 addr[7:0] */

 len[7:0] */

 index = 0, write */

 Transaction number == 1 */

 i2c */

 INDEX_WRITE */

 read */

 discard first byte */

/**

 * dp_aux_transfer_helper() - helper function for EDID read transactions

 *

 * @aux: DP AUX private structure

 * @input_msg: input message from DRM upstream APIs

 * @send_seg: send the segment to sink

 *

 * return: void

 *

 * This helper function is used to fix EDID reads for non-compliant

 * sinks that do not handle the i2c middle-of-transaction flag correctly.

	/*

	 * Sending the segment value and EDID offset will be performed

	 * from the DRM upstream EDID driver for each block. Avoid

	 * duplicate AUX transactions related to this while reading the

	 * first 16 bytes of each block.

	/*

	 * Send the segment address for every i2c read in which the

	 * middle-of-tranaction flag is set. This is required to support EDID

	 * reads of more than 2 blocks as the segment address is reset to 0

	 * since we are overriding the middle-of-transaction flag for read

	 * transactions.

	/*

	 * Send the offset address for every i2c read in which the

	 * middle-of-transaction flag is set. This will ensure that the sink

	 * will update its read pointer and return the correct portion of the

	 * EDID buffer in the subsequent i2c read trasntion triggered in the

	 * native AUX transfer function.

 reset segment at end of block */

/*

 * This function does the real job to process an AUX transaction.

 * It will call aux_reset() function to reset the AUX channel,

 * if the waiting is timeout.

 Ignore address only message */

 msg sanity check */

 reset aux if link is in connected state */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2012-2020, The Linux Foundation. All rights reserved.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2012-2020, The Linux Foundation. All rights reserved.

 check for EXTENDED_RECEIVER_CAPABILITY_FIELD_PRESENT */

 Limit support upto HBR2 until HBR3 support is added */

 check edid read fail is due to unplug */

 fail safe edid */

 block type extension */

	/*

	 * print resolution info as this is a result

	 * of user initiated action of cable connection

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2017-2020, The Linux Foundation. All rights reserved.

 event thread connection state */

 hpd events */

 100ms */

 state variables */

 wait for audio signaling */

 event related only access by event thread */

 deleted */

 reset video pattern flag on disconnect */

	/*

	 * set sink to normal operation mode -- D0

	 * before dpcd read

 check for any test request issued by sink */

 wait until ST_DISCONNECTED */

 delay = 1 */

 link train failed */

 cable unplugged */

 start sentinel checking in case of missing uevent */

 enable HDP irq_hpd/replug interrupt */

 uevent will complete connection part */

 notify audio subsystem only if sink supports audio */

 disable irq_hpd/replug interrupts */

 unplugged, no more irq_hpd handle */

 triggered by irq_hdp with sink_count = 0 */

 wait until CONNECTED */

 delay = 1 */

 disable HPD plug interrupts */

	/*

	 * We don't need separate work for disconnect as

	 * connect/attention interrupts are disabled

 start sentinel checking in case of missing uevent */

 signal the disconnect event early to ensure proper teardown */

 enable HDP plug interrupt to prepare for next plugin */

 uevent will complete disconnection part */

 irq_hpd can happen at either connected or disconnected state */

 wait until ST_CONNECTED */

 delay = 1 */

 wait until ST_CONNECTED */

 delay = 1 */

 cable unplugged */

 Callback APIs used for cable status change event */

 signal the connect event late to synchronize video and display */

 wait only if audio was enabled */

 signal the disconnect event */

 triggered by irq_hpd with sink_count = 0 */

	/*

	 * if we are reading registers we need the link clocks to be on

	 * however till DP cable is connected this will not happen as we

	 * do not know the resolution to power up with. Hence check the

	 * power_on status before dumping DP registers to avoid crash due

	 * to unclocked access

	/* Enable interrupt first time

	 * we are leaving dp clocks on during disconnect

	 * and never disable interrupt

 re enter delay event into q */

 clean up older event */

 switch to timeout mode */

 timeout with no events in q */

 hpd related interrupts */

 stop sentinel connect pending checking */

 DP controller isr */

 DP aux isr */

 Store DP audio handle inside DP display */

 start from disconnected state */

 turn on dp ctrl/phy */

	/*

	 * set sink to normal operation mode -- D0

	 * before dpcd read

	/*

	 * can not declared display is connected unless

	 * HDMI cable is plugged in and sink_count of

	 * dongle become 1

	 * also only signal audio when disconnected

 mainlink enabled */

 host_init will be called at pm_resume */

 stop sentinel checking */

 manual kick off plug event to train link */

 completed connection */

 stop sentinel checking */

 completed disconnection */

 Default num_components per pixel = 3 */

 Default bpp */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2012-2020, The Linux Foundation. All rights reserved.

 TEST_AUDIO_PERIOD_CH_XX */

 Period - Bits 3:0 */

 TEST_AUDIO_PERIOD_CH_3 (Byte 0x275) */

 Audio Pattern Type - Bits 7:0 */

 Sampling Rate - Bits 3:0 */

 Channel Count - Bits 7:4 */

/**

 * dp_link_is_bit_depth_valid() - validates the bit depth requested

 * @tbd: bit depth requested by the sink

 *

 * Returns true if the requested bit depth is supported.

 DP_TEST_VIDEO_PATTERN_NONE is treated as invalid */

 Read the requested video link pattern (Byte 0x221). */

 Read the requested video link pattern (Byte 0x221). */

/**

 * dp_link_parse_video_pattern_params() - parses video pattern parameters from DPCD

 * @link: Display Port Driver data

 *

 * Returns 0 if it successfully parses the video link pattern and the link

 * bit depth requested by the sink and, and if the values parsed are valid.

 Read the requested color bit depth and dynamic range (Byte 0x232) */

 Dynamic Range */

 Color bit depth */

 resolution timing params */

/**

 * dp_link_parse_link_training_params() - parses link training parameters from

 * DPCD

 * @link: Display Port Driver data

 *

 * Returns 0 if it successfully parses the link rate (Byte 0x219) and lane

 * count (Byte 0x220), and if these values parse are valid.

/**

 * dp_link_parse_phy_test_params() - parses the phy link parameters

 * @link: Display Port Driver data

 *

 * Parses the DPCD (Byte 0x248) for the DP PHY link pattern that is being

 * requested.

/**

 * dp_link_is_video_audio_test_requested() - checks for audio/video link request

 * @link: link requested by the sink

 *

 * Returns true if the requested link is a permitted audio/video link.

/**

 * dp_link_parse_request() - parses link request parameters from sink

 * @link: Display Port Driver data

 *

 * Parses the DPCD to check if an automated link is requested (Byte 0x201),

 * and what type of link automation is being requested (Byte 0x218).

	/**

	 * Read the device service IRQ vector (Byte 0x201) to determine

	 * whether an automated link has been requested by the sink.

	/**

	 * Read the link request byte (Byte 0x218) to determine what type

	 * of automated link has been requested by the sink.

	/*

	 * Send a DP_TEST_ACK if all link parameters are valid, otherwise send

	 * a DP_TEST_NAK.

/**

 * dp_link_parse_sink_count() - parses the sink count

 * @dp_link: pointer to link module data

 *

 * Parses the DPCD to check if there is an update to the sink count

 * (Byte 0x200), and whether all the sink devices connected have Content

 * Protection enabled.

/**

 * dp_link_process_link_training_request() - processes new training requests

 * @link: Display Port link data

 *

 * This function will handle new link training requests that are initiated by

 * the sink. In particular, it will update the requested lane count and link

 * rate, and then trigger the link retraining procedure.

 *

 * The function will return 0 if a link training request has been processed,

 * otherwise it will return -EINVAL.

	/**

	 * Update the voltage and pre-emphasis levels as per DPCD request

	 * vector.

/**

 * dp_link_process_phy_test_pattern_request() - process new phy link requests

 * @link: Display Port Driver data

 *

 * This function will handle new phy link pattern requests that are initiated

 * by the sink. The function will return 0 if a phy link pattern has been

 * processed, otherwise it will return -EINVAL.

/**

 * dp_link_process_link_status_update() - processes link status updates

 * @link: Display Port link module data

 *

 * This function will check for changes in the link status, e.g. clock

 * recovery done on all lanes, and trigger link training if there is a

 * failure/error on the link.

 *

 * The function will return 0 if the a link status update has been processed,

 * otherwise it will return -EINVAL.

/**

 * dp_link_process_ds_port_status_change() - process port status changes

 * @link: Display Port Driver data

 *

 * This function will handle downstream port updates that are initiated by

 * the sink. If the downstream port status has changed, the EDID is read via

 * AUX.

 *

 * The function will return 0 if a downstream port update has been

 * processed, otherwise it will return -EINVAL.

 reset prev_sink_count */

/**

 * dp_link_process_request() - handle HPD IRQ transition to HIGH

 * @dp_link: pointer to link module data

 *

 * This function will handle the HPD IRQ state transitions from LOW to HIGH

 * (including cases when there are back to back HPD IRQ HIGH) indicating

 * the start of a new link training request or sink status update.

	/*

	 * Unless a video pattern CTS test is ongoing, use RGB_VESA

	 * Only RGB_VESA and RGB_CEA supported for now

 use the max level across lanes */

	/**

	 * Adjust the voltage swing and pre-emphasis level combination to within

	 * the allowable range.

	/*

	 * Few simplistic rules and assumptions made here:

	 *    1. Test bit depth is bit depth per color component

	 *    2. Assume 3 color components

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2017-2020, The Linux Foundation. All rights reserved.

	/*

	 * To make sure aux reg writes happens before any other operation,

	 * this function uses writel() instread of writel_relaxed()

	/*

	 * To make sure phy reg writes happens before any other operation,

	 * this function uses writel() instread of writel_relaxed()

	/*

	 * To make sure interface reg writes happens before any other operation,

	 * this function uses writel() instread of writel_relaxed()

	/*

	 * To make sure interface reg writes happens before any other operation,

	 * this function uses writel() instread of writel_relaxed()

	/*

	 * To make sure link reg writes happens before any other operation,

	 * this function uses writel() instread of writel_relaxed()

 aux related catalog functions */

/**

 * dp_catalog_aux_reset() - reset AUX controller

 *

 * @dp_catalog: DP catalog structure

 *

 * return: void

 *

 * This function reset AUX controller

 *

 * NOTE: reset AUX controller will also clear any pending HPD related interrupts

 * 

 h/w recommended delay */

 controller related catalog functions */

 One-to-One mapping */

		/*

		 * To make sure link reg writes happens before other operation,

		 * dp_write_link() function uses writel()

 clear bpp bits */

 Configure clock to synchronous mode */

 Poll for mainlink ready status */

/**

 * dp_catalog_ctrl_reset() - reset DP controller

 *

 * @dp_catalog: DP catalog structure

 *

 * return: void

 *

 * This function reset the DP controller

 *

 * NOTE: reset DP controller will also clear any pending HPD related interrupts

 * 

 h/w recommended delay */

 Poll for mainlink ready status */

 enable HPD plug and unplug interrupts */

 Configure REFTIMER and enable it */

 Enable HPD */

 h/w recommended delay */

 TODO: Update for all lanes instead of just first one */

 Make sure to clear the current pattern before starting a new one */

 00111110000011111000001111100000 */

 00001111100000111110000011111000 */

 1111100000111110 */

 panel related catalog functions */

 TPG config parameters*/

 make sure audio engine is disabled */

 AUDIO_TIMESTAMP_SDP_EN */

 AUDIO_STREAM_SDP_EN */

 AUDIO_COPY_MANAGEMENT_SDP_EN */

 AUDIO_ISRC_SDP_EN  */

 AUDIO_INFOFRAME_SDP_EN  */

 IFRM_REGSRC -> Do not use reg values */

 AUDIO_STREAM_HB3_REGSRC-> Do not use reg values */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2016-2020, The Linux Foundation. All rights reserved.

 Config header and parity byte 1 */

 Config header and parity byte 2 */

 Config header and parity byte 3 */

 Config header and parity byte 1 */

 Config header and parity byte 2 */

 Config header and parity byte 3 */

 Config header and parity byte 1 */

 Config header and parity byte 2 */

 Config header and parity byte 3 */

 Config header and parity byte 1 */

 Config header and parity byte 2 */

 Config header and parity byte 3 */

 Config header and parity byte 1 */

 Config header and parity byte 2 */

	/*

	 * there could be cases where sound card can be opened even

	 * before OR even when DP is not connected . This can cause

	 * unclocked access as the audio subsystem relies on the DP

	 * driver to maintain the correct state of clocks. To protect

	 * such cases check for connection status and bail out if not

	 * connected.

	/*

	 * if audio was not enabled there is no need

	 * to execute the shutdown and we can bail out early.

	 * This also makes sure that we dont cause an unclocked

	 * access when audio subsystem calls this without DP being

	 * connected. is_connected cannot be used here as its set

	 * to false earlier than this call

 signal the dp display to safely shutdown clocks */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2012-2020, The Linux Foundation. All rights reserved.

 30 ms */

 162, 270, 540 and 810 */

 in KHz */

 active h-width */

 bp + fp + pulse */

 no.of.lanes */

 bits */

 444, 420, 422 */

 dsc on/off */

 async mode */

 fec */

 2:1 = 200, 3:1 = 300, 3.75:1 = 375 */

 number of slices per line */

 DP_LINK_RATE -> 162(6), 270(10), 540(20), 810 (30) */

 Default-> LSCLK DIV: 1/4 LCLK  */

 Scrambler reset enable */

 Num of Lanes */

 progressive video */

 sync clock & static Mvid */

/*

 * The structure and few functions present below are IP/Hardware

 * specific implementation. Most of the implementation will not

 * have coding comments

 positive */

 negative */

 output */

 0.976 */

 0.0006 */

 0.49 */

 0.56 */

 0.1 */

 1000 */

 if (hbp_time_fp < delay_start_time_fp) */

 brute force */

 if(diff_abs < 0) diff_abs *= -1 */

 OUTPUTS */

 print success info as this is a result of user initiated action */

 print success info as this is a result of user initiated action */

	/*

	 * As part of previous calls, DP controller state might have

	 * transitioned to PUSH_IDLE. In order to start transmitting

	 * a link training pattern, we have to first do soft reset.

/**

 * dp_ctrl_host_deinit() - Uninitialize DP controller

 * @dp_ctrl: Display Port Driver data

 *

 * Perform required steps to uninitialize DP controller

 * and its resources.

	/*

	 * For better interop experience, used a fixed NVID=0x8000

	 * whenever connected to a VGA dongle downstream.

	/*

	 * Disable and re-enable the mainlink clock since the

	 * link clock might have been adjusted as part of the

	 * link maintenance.

 hw recommended delay before re-enabling clocks */

	/*

	 * The global reset will need DP link related clocks to be

	 * running. Add the global reset just before disabling the

	 * link clocks and core clocks.

	/*

	 * only interested in the lane number after reduced

	 * lane_count = 4, then only interested in 2 lanes

	 * lane_count = 2, then only interested in 1 lane

 training completed successfully */

 link train_1 failed */

 already in RBR = 1.6G */

					/*

					 * some lanes are ready,

					 * reduce lane number

 lane == 1 already */

 end with failure */

 end with failure */

 lane == 1 already */

 link train_2 failed */

 end with failure */

 lane == 1 already */

 link train successfully */

		/*

		 * do not stop train pattern here

		 * stop link training at on_stream

		 * to pass compliance test

		/*

		 * link training failed

		 * end txing train pattern here

 link clk is off */

 stop txing train pattern to end link training */

	/*

	 * Set up transfer unit values and set controller state to send

	 * video.

 set dongle to D3 (power off) mode */

 aux channel down, reinit phy */

 caller do PTR_ERR(opp_table) */

 OPP table is optional */

 in parameters */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2017-2020, The Linux Foundation. All rights reserved.

 Link Information */

		/* To prevent erroneous activation of the compliance

		 * testing code, only accept an actual value of 1 here

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2012-2020, The Linux Foundation. All rights reserved.

 DP specific VDM commands */

 USBPD-TypeC specific Macros */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2012-2020, The Linux Foundation. All rights reserved.

 1.2 V */

 0.9 V */

		/*

		 * The initial binding had a single reg, but in order to

		 * support variation in the sub-region sizes this was split.

		 * dp_ioremap() will fail with -EINVAL here if only a single

		 * reg is specified, so fill in the sub-region offsets and

		 * lengths based on this single region.

 Initialize the CORE power module */

 Initialize the CTRL power module */

 Initialize the STREAM power module */

	/* Map the corresponding regulator information according to

	 * version. Currently, since we only have one supported platform,

	 * mapping the regulator directly.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 pull low */

 pull high */

 pull low */

 pull high */

 pull high */

 pull low */

 pull high */

 pull low */

 enable HPD events: */

 set timeout to 4.1ms (max) for hardware debounce */

 Toggle HPD circuit to trigger HPD sense */

 Disable HPD interrupt */

 Process HPD: */

 ack & disable (temporarily) HPD events: */

 detect disconnect if we are connected or visa versa: */

	/*

	 * some platforms may not have hpd gpio. Rely only on the status

	 * provided by REG_HDMI_HPD_INT_STATUS in this case.

	/* the status we get from reading gpio seems to be more reliable,

	 * so trust that one the most if we didn't manage to get hdmi and

	 * gpio status to agree:

	/* for mdp5/apq8074, we manage our own pixel clk (as opposed to

	 * mdp4/dtv stuff where pixel clk is assigned to mdp/encoder

	 * instead):

 initialize connector */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 enable reference timer for 27us */

 trigger the transfer: */

 read back results of any read transactions: */

 check for NACK: */

 discard first byte: */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2016, The Linux Foundation. All rights reserved.

 pll mmio base */

 tx channel base */

 bit clk = 10 * pix_clk */

 Convert these values to register specific values */

 Initially shut down PHY */

 Power up sequence */

 Bypass VCO calibration */

 TX lanes setup (TX 0/1/2/3) */

	/*

	 * Ensure that vco configuration gets flushed to hardware before

	 * enabling the PLL

 Disable SSC */

 Restart the retiming buffer */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014 The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 Process HPD: */

 Process DDC: */

 Process HDCP: */

 TODO audio.. */

	/*

	 * at this point, hpd has been disabled,

	 * after flush workq, it's safe to deinit hdcp

/* construct hdmi at bind/probe time, grab all the resources.  If

 * we are to EPROBE_DEFER we want to do it here, rather than later

 * at modeset_init() time

 HDCP needs physical address of hdmi register */

/* Second part of initialization, the drm/kms level modeset_init,

 * constructs/initializes mode objects, etc, is called from master

 * driver (not hdmi sub-device's probe/bind!)

 *

 * Any resource (regulator/clk/etc) which could be missing at boot

 * should be handled in msm_hdmi_init() so that failure happens from

 * hdmi sub-device's probe.

 bridge is normally destroyed by drm: */

/*

 * The hdmi device:

/*

 * HDMI audio codec callbacks

 0dB */

 FR and FL speakers */

 FC, LFE, FR and FL speakers */

 RR, RL, FC, LFE, FR and FL speakers */

 FRC, FLC, RR, RL, FC, LFE, FR and FL speakers */

		/*

		 * We are fetching the GPIO lines "as is" since the connector

		 * code is enabling and disabling the lines. Until that point

		 * the power-on default value will be kept.

 This will catch e.g. -PROBE_DEFER */

 Try a second time, stripping down the name */

			/*

			 * Try again after stripping out the "qcom,hdmi-tx"

			 * prefix. This is mainly to match "hpd-gpios" used

			 * in the upstream bindings.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

	/* TODO do we need to wait for final vblank somewhere before

	 * cutting the clocks?

	/*

	 * the AVI_INFOx registers don't map exactly to how the AVI infoframes

	 * are packed according to the spec. The checksum from the header is

	 * written to the LSB byte of AVI_INFO0 and the version is written to

	 * the third byte from the LSB of AVI_INFO3

 initialize bridge */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 maps MSM_HDMI_AUDIO_CHANNEL_n consts used by audio driver to # of channels: */

 Supported HDMI Audio sample rates */

 N parameter for clock regeneration */

 CTS parameter for clock regeneration */

 Audio constants lookup table for hdmi_msm_audio_acr_setup */

 Valid Pixel-Clock rates: 25.2MHz, 27MHz, 27.03MHz, 74.25MHz, 148.5MHz */

  25.200MHz  */

  27.000MHz  */

  27.027MHz */

  74.250MHz */

 148.500MHz */

 Read first before writing */

 Clear N/CTS selection bits */

 divide N by 4 and use multiplier */

 divide N by 2 and use multiplier */

 default to 32k */

 configure infoframe: */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2016, The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * HDMI PLL:

 *

 * To get the parent clock setup properly, we need to plug in hdmi pll

 * configuration into common-clock-framework.

 NOTE: keep sorted highest freq to lowest: */

 1080p60/1080p50 case */

 720p60/720p50/1080i60/1080i50/1080p24/1080p30/1080p25 */

 480p60/480i60 */

 576p50/576i50 */

 640x480p60 */

 Assert PLL S/W reset */

	/* Wait for a short time before de-asserting

	 * to allow the hardware to complete its job.

	 * This much of delay should be fine for hardware

	 * to assert and de-assert.

 De-assert PLL S/W reset */

 Assert PHY S/W reset */

	/*

	 * Wait for a short time before de-asserting to allow the hardware to

	 * complete its job. This much of delay should be fine for hardware to

	 * assert and de-assert.

 De-assert PHY S/W reset */

 Wait 10 us for enabling global power for PHY */

 are we there yet? */

		/*

		 * PLL has still not locked.

		 * Do a software reset and try again

		 * Assert PLL S/W reset first

		/*

		 * Wait for a short duration for the PLL calibration

		 * before checking if the PLL gets locked

 Make sure HDMI PHY/PLL are powered down */

 sanity check: */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2010-2015, The Linux Foundation. All rights reserved.

 QFPROM Registers for HDMI/HDCP */

 type of downstream device */

	/*

	 * store aksv from qfprom

 Clear Interrupts */

 Clear AUTH_FAIL_INFO as well */

 Fetch aksv from QFPROM, this info should be public. */

 check there are 20 ones in AKSV */

 Check for any DDC transfer failures */

		/*

		 * Indicates that the last HDCP HW DDC transfer failed.

		 * This occurs when a transfer is attempted with HDCP DDC

		 * disabled (HDCP_DDC_DISABLE=1) or the number of retries

		 * matches HDCP_DDC_RETRY_CNT.

		 * Failure occurred,  let's clear it.

 First, Disable DDC */

 ACK the Failure to Clear it */

 Check if the FAILURE got Cleared */

 Re-Enable HDCP DDC */

 Reset HDMI DDC software status */

 Reset HDMI DDC Controller */

 If previous msleep is aborted, skip this msleep */

 Wait to be clean on DDC HW engine */

	/*

	 * Disable HPD circuitry.

	 * This is needed to reset the HDCP cipher engine so that when we

	 * attempt a re-authentication, HW would clear the AN0_READY and

	 * AN1_READY bits in HDMI_HDCP_LINK0_STATUS register

 Disable HDCP interrupts */

 Wait to be clean on DDC HW engine */

 Disable encryption and disable the HDCP block */

 Enable HPD circuitry */

	/*

	 * Only retry defined times then abort current authenticating process

 disable HDMI Encrypt */

 Enabling Software DDC */

	/*

	 * Write AKSV read from QFPROM to the HDCP registers.

	 * This step is needed for HDCP authentication and must be

	 * written before enabling HDCP.

	/*

	 * HDCP setup prior to enabling HDCP_CTRL.

	 * Setup seed values for random number An.

 Disable the RngCipher state */

	/*

	 * Ensure that all register writes are completed before

	 * enabling HDCP cipher

	/*

	 * Enable HDCP

	 * This needs to be done as early as possible in order for the

	 * hardware to make An available to read

	/*

	 * If we had stale values for the An ready bit, it should most

	 * likely be cleared now after enabling HDCP cipher

 Clear any DDC failures from previous tries before enable HDCP*/

 clear HDMI Encrypt */

	/*

	 * Disable software DDC before going into part3 to make sure

	 * there is no Arbitration between software and hardware for DDC

 enable HDMI Encrypt */

/*

 * hdcp authenticating part 1

 * Wait Key/An ready

 * Read BCAPS from sink

 * Write BCAPS and AKSV into HDCP engine

 * Write An and AKSV to sink

 * Read BKSV from sink and write into HDCP engine

 Wait for HDCP keys to be checked and validated */

 Read An0 and An1 */

 Read AKSV */

 Copy An and AKSV to byte arrays for transmission */

 Write An to offset 0x18 */

 Write AKSV to offset 0x10 */

 Read BKSV at offset 0x00 */

 check there are 20 ones in BKSV */

 Write BKSV read from sink to HDCP registers */

 receiver (0), repeater (1) */

 Write BCAPS to the hardware */

 Wait for AKSV key and An ready */

 Read BCAPS and send to HDCP engine */

	/*

	 * 1.1_Features turned off by default.

	 * No need to write AInfo since 1.1_Features is disabled.

 Send AKSV and An to sink */

 Read BKSV and send to HDCP engine*/

 Enable HDCP interrupts and ack/clear any stale interrupts */

 read R0' from sink and pass it to HDCP engine */

	/*

	 * HDCP Compliance Test case 1A-01:

	 * Wait here at least 100ms before reading R0'

 Read R0' at offset 0x08 */

 Write R0' to HDCP registers and check to see if it is a match */

 Wait for authenticating result: R0/R0' are matched or not */

 wait for hdcp irq, 10 sec should be long enough */

 Enable HDCP Encryption */

 Read BSTATUS at offset 0x41 */

		/*

		 * If no downstream devices are attached to the repeater

		 * then part II fails.

		 * todo: The other approach would be to continue PART II.

	/*

	 * HDCP Compliance 1B-05:

	 * Check if no. of devices connected to repeater

	 * exceed max_devices_connected from bit 7 of Bstatus.

	/*

	 * HDCP Compliance 1B-06:

	 * Check if no. of cascade connected to repeater

	 * exceed max_cascade_connected from bit 11 of Bstatus.

	/*

	 * Wait until READY bit is set in BCAPS, as per HDCP specifications

	 * maximum permitted time to check for READY bit is five seconds.

 Read BCAPS at offset 0x40 */

 Write BSTATUS and BCAPS to HDCP registers */

/*

 * hdcp authenticating part 2: 2nd

 * read ksv fifo from sink

 * transfer V' from sink to HDCP engine

 * reset SHA engine

	/*

	 * Read KSV FIFO over DDC

	 * Key Selection vector FIFO Used to pull downstream KSVs

	 * from HDCP Repeaters.

	 * All bytes (DEVICE_COUNT * 5) must be read in a single,

	 * auto incrementing access.

	 * All bytes read as 0x00 for HDCP Receivers that are not

	 * HDCP Repeaters (REPEATER == 0).

 reset SHA engine before write ksv fifo */

/*

 * Write KSV FIFO to HDCP_SHA_DATA.

 * This is done 1 byte at time starting with the LSB.

 * Once 64 bytes have been written, we need to poll for

 * HDCP_SHA_BLOCK_DONE before writing any further

 * If the last byte is written, we need to poll for

 * HDCP_SHA_COMP_DONE to wait until HW finish

 Check if need to wait for HW completion */

 check COMP_DONE if last write */

 check BLOCK_DONE if not last write */

 Write KSV byte and set DONE bit[0] for last byte*/

	/*

	 *return -EAGAIN to notify caller to wait for COMP_DONE or BLOCK_DONE

 write ksv fifo into HDCP engine */

 HDCP PartI */

 HDCP PartII */

 clear HDMI Encrypt */

	/*

	 * Disable HPD circuitry.

	 * This is needed to reset the HDCP cipher engine so that when we

	 * attempt a re-authentication, HW would clear the AN0_READY and

	 * AN1_READY bits in HDMI_HDCP_LINK0_STATUS register

	/*

	 * Disable HDCP interrupts.

	 * Also, need to set the state to inactive here so that any ongoing

	 * reauth works will know that the HDCP session has been turned off.

	/*

	 * Cancel any pending auth/reauth attempts.

	 * If one is ongoing, this will wait for it to finish.

	 * No more reauthentication attempts will be scheduled since we

	 * set the current state to inactive.

 Disable encryption and disable the HDCP block */

 Enable HPD circuitry */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 De-serializer delay D/C for non-lbk mode: */

 video_format == HDMI_VFRMT_720x480p60_16_9 */

 No matter what, start from the power down mode: */

 Turn PowerGen on: */

 Turn PLL power on: */

 Write to HIGH after PLL power down de-assert: */

 ASIC power on; PHY REG9 = 0 */

	/* Enable PLL lock detect, PLL lock det will go high after lock

	 * Enable the re-time logic

 Drivers are on: */

 If the RX detector is needed: */

 If we want to use lock enable based on counting: */

 Assert RESET PHY from controller */

 De-assert RESET PHY from controller */

 Turn off Driver */

 Disable PLL */

 Power down PHY, but keep RX-sense: */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2016, The Linux Foundation. All rights reserved.

	/*

	 * we don't have PLL support for these, don't report an error for now

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2020-2021, The Linux Foundation. All rights reserved.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014 The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * Note: Keep RGB formats 1st, followed by YUV formats to avoid breaking

 * mdp_get_rgb_formats()'s implementation.

  name      a  r  g  b   e0 e1 e2 e3  alpha   tight  cpp cnt ... */

 --- RGB formats above / YUV formats below this line --- */

 2 plane YUV */

 1 plane YUV */

 3 plane YUV */

/*

 * Note:

 * @rgb_only must be set to true, when requesting

 * supported formats for RGB pipes.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/* if an mdp_irq's irqmask has changed, such as when mdp5 crtc<->encoder

 * link changes, this must be called to figure out the new global irqmask

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2020-2021, The Linux Foundation. All rights reserved.

 Serialize dumping here */

	/*

	 * If COREDUMP is disabled, the stub will call the free function.

	 * If there is a codedump pending for the device, the dev_coredumpm()

	 * will also free new coredump state.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2016, The Linux Foundation. All rights reserved.

/*

 * interrupt-controller implementation, so sub-blocks (MDP/HDMI/eDP/DSI/etc)

 * can register to get their irq's delivered

 Regulator to enable GDSCs in downstream kernels */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014, The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

	/* Magic unknown register writes:

	 *

	 *    W VBIF:0x004 00000001      (mdss_mdp.c:839)

	 *    W MDP5:0x2e0 0xe9          (mdss_mdp.c:839)

	 *    W MDP5:0x2e4 0x55          (mdss_mdp.c:839)

	 *    W MDP5:0x3ac 0xc0000ccc    (mdss_mdp.c:839)

	 *    W MDP5:0x3b4 0xc0000ccc    (mdss_mdp.c:839)

	 *    W MDP5:0x3bc 0xcccccc      (mdss_mdp.c:839)

	 *    W MDP5:0x4a8 0xcccc0c0     (mdss_mdp.c:839)

	 *    W MDP5:0x4b0 0xccccc0c0    (mdss_mdp.c:839)

	 *    W MDP5:0x4b8 0xccccc000    (mdss_mdp.c:839)

	 *

	 * Downstream fbdev driver gets these register offsets/values

	 * from DT.. not really sure what these registers are or if

	 * different values for different boards/SoC's, etc.  I guess

	 * they are the golden registers.

	 *

	 * Not setting these does not seem to cause any problem.  But

	 * we may be getting lucky with the bootloader initializing

	 * them for us.  OTOH, if we can always count on the bootloader

	 * setting the golden registers, then perhaps we don't need to

	 * care.

 Global/shared object state funcs */

/*

 * This is a helper that returns the private state currently in operation.

 * Note that this would return the "old_state" if called in the atomic check

 * path, and the "new_state" after the atomic swap has been done.

/*

 * This acquires the modeset lock set aside for global state, creates

 * a new duplicated private object state.

 TODO */

	/*

	 * Construct encoders and modeset initialize connector devices

	 * for each external display interface.

	/*

	 * We should ideally have less number of encoders (set up by parsing

	 * the MDP5 interfaces) than the number of layer mixers present in HW,

	 * but let's be safe here anyway

	/*

	 * Construct planes equaling the number of hw pipes, and CRTCs for the

	 * N encoders set up by the driver. The first N planes become primary

	 * planes for the CRTCs, with the remainder as overlay planes:

	/*

	 * Now that we know the number of crtcs we've created, set the possible

	 * crtcs for the encoders

 priv->kms would have been populated by the MDP5 driver */

	/* make sure things are off before attaching iommu (bootloader could

	 * have left things on, in which case we'll start getting faults if

	 * we don't disable):

 max_vblank_count is set on each CRTC */

 Construct RGB pipes: */

 Construct video (VIG) pipes: */

 Construct DMA pipes: */

 Construct cursor pipes: */

 mandatory clocks: */

 optional clocks: */

	/* we need to set a default rate before enabling.  Set a safe

	 * rate first, then figure out hw revision, and then set a

	 * more optimal rate:

 TODO: compute core clock rate at runtime */

	/*

	 * Some chipsets have a Shared Memory Pool (SMP), while others

	 * have dedicated latency buffering per source pipe instead;

	 * this section initializes the SMP:

 set uninit-ed kms */

		/* no interconnect support is not necessarily a fatal

		 * condition, the platform may simply not have an

		 * interconnect driver yet.  But warn about it in case

		 * bootloader didn't setup bus clocks high enough for

		 * scanout.

 to support downstream DT files */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2016 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 grab old_state after mdp5_get_global_state(), since now we hold lock: */

		/* skip if already in-use.. check both new and old state,

		 * since we cannot immediately re-use a pipe that is

		 * released in the current update in some cases:

		 *  (1) mdp5 can have SMP (non-double-buffered)

		 *  (2) hw pipe previously assigned to different CRTC

		 *      (vblanks might not be aligned)

 skip if doesn't support some required caps: */

		/*

		 * don't assign a cursor pipe to a plane that isn't going to

		 * be used as a cursor

		/* possible candidate, take the one with the

		 * fewest unneeded caps bits set:

 reject different types of hwpipes */

 respect priority, eg. VIG0 > VIG1 */

 We don't support SMP and 2 hwpipes/plane together */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014-2015 The Linux Foundation. All rights reserved.

/*

 * CTL - MDP Control Pool Manager

 *

 * Controls are shared between all display interfaces.

 *

 * They are intended to be used for data path configuration.

 * The top level register programming describes the complete data path for

 * a specific data path ID - REG_MDP5_CTL_*(<id>, ...)

 *

 * Hardware capabilities determine the number of concurrent data paths

 *

 * In certain use cases (high-resolution dual pipe), one single CTL can be

 * shared across multiple CRTCs.

 CTL status bitmask */

 pending flush_mask bits */

 REG_MDP5_CTL_*(<id>) registers access info + lock: */

 when do CTL registers need to be flushed? (mask of trigger bits) */

 True if the current CTL has FLUSH bits pending for single FLUSH. */

 Paired CTL to be flushed together */

 number of CTL / Layer Mixers in this hw config: */

 to filter out non-present bits in the current hardware config */

 status for single FLUSH */

 pool of CTLs + lock to protect resource allocation (ctls[i].busy) */

 TODO use this instead of mdp5_write */

 TODO use this instead of mdp5_write */

 Virtual interfaces need not set a display intf (e.g.: Writeback) */

/*

 * send_start_signal() - Overlay Processor Start Signal

 *

 * For a given control operation (display pipeline), a START signal needs to be

 * executed in order to kick off operation and activate all layers.

 * e.g.: DSI command mode, Writeback

/**

 * mdp5_ctl_set_encoder_state() - set the encoder state

 *

 * @ctl:      the CTL instance

 * @pipeline: the encoder's INTF + MIXER configuration

 * @enabled:  true, when encoder is ready for data streaming; false, otherwise.

 *

 * Note:

 * This encoder state is needed to trigger START signal (data path kickoff).

/*

 * Note:

 * CTL registers need to be flushed after calling this function

 * (call mdp5_ctl_commit() with mdp_ctl_flush_mask_ctl() mask)

 for some targets, cursor bit is the same as LM bit */

/**

 * mdp5_ctl_commit() - Register Flush

 *

 * @ctl:        the CTL instance

 * @pipeline:   the encoder's INTF + MIXER configuration

 * @flush_mask: bitmask of display controller hw blocks to flush

 * @start:      if true, immediately update flush registers and set START

 *              bit, otherwise accumulate flush_mask bits until we are

 *              ready to START

 *

 * The flush register is used to indicate several registers are all

 * programmed, and are safe to update to the back copy of the double

 * buffered registers.

 *

 * Some registers FLUSH bits are shared when the hardware does not have

 * dedicated bits for them; handling these is the job of fix_sw_flush().

 *

 * CTL registers need to be flushed in some circumstances; if that is the

 * case, some trigger bits will be present in both flush mask and

 * ctl->pending_ctl_trigger.

 *

 * Return H/W flushed bit mask.

/*

 * mdp5_ctl_pair() - Associate 2 booked CTLs for single FLUSH

 do nothing silently if hw doesn't support */

/*

 * mdp5_ctl_request() - CTL allocation

 *

 * Try to return booked CTL for @intf_num is 1 or 2, unbooked for other INTFs.

 * If no CTL is available in preferred category, allocate from the other one.

 *

 * @return fail if no CTL is available.

 search the preferred */

 initialize the CTL manager: */

 initialize each CTL of the pool: */

	/*

	 * In bonded DSI case, CTL0 and CTL1 are always assigned to two DSI

	 * interfaces to support single FLUSH feature (Flush CTL0 and CTL1 when

	 * only write into CTL0's FLUSH register) to keep two DSI pipes in sync.

	 * Single FLUSH is supported from hw rev v3.0.

 Reserve CTL0/1 for INTF1/2 */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2017 The Linux Foundation. All rights reserved.

/*

 * As of now, there are only 2 combinations possible for source split:

 *

 * Left | Right

 * -----|------

 *  LM0 | LM1

 *  LM2 | LM5

 *

		/*

		 * skip if already in-use by a different CRTC. If there is a

		 * mixer already assigned to this CRTC, it means this call is

		 * a request to get an additional right mixer. Assume that the

		 * existing mixer is the 'left' one, and try to see if we can

		 * get its corresponding 'right' pair.

 skip if doesn't support some required caps: */

		/*

		 * prefer a pair-able LM over an unpairable one. We can

		 * switch the CRTC from Normal mode to Source Split mode

		 * without requiring a full modeset if we had already

		 * assigned this CRTC a pair-able LM.

		 *

		 * TODO: There will be assignment sequences which would

		 * result in the CRTC requiring a full modeset, even

		 * if we have the LM resources to prevent it. For a platform

		 * with a few displays, we don't run out of pair-able LMs

		 * so easily. For now, ignore the possibility of requiring

		 * a full modeset.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014-2015 The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 protect REG_MDP5_LM_* registers */

 if there is a pending flip, these will be non-null: */

	/* Bits have been flushed at the last commit,

	 * used to decide if a vsync has happened since last commit.

 for unref'ing cursor bo's after scanout completes: */

 protect REG_MDP5_LM_CURSOR* registers and cursor scanout_bo*/

 current cursor being scanned out: */

/*

 * flush updates, to make sure hw is updated to new scanout fb,

 * so that we can safely queue unref to current fb (ie. next

 * vblank we know hw is done w/ previous scanout_fb).

 this should not happen: */

 if file!=NULL, this is preclose potential cancel-flip path */

 set STAGE_UNUSED for all layers */

 XXX: What to do here? */

 mdp5_crtc->ctl = NULL; */

/*

 * left/right pipe offsets for the stage array used in blend_setup()

/*

 * blend_setup() - blend all the planes of a CRTC

 *

 * If no base layer is available, border will be enabled as the base layer.

 * Otherwise all layers will be blended based on their stage calculated

 * in mdp5_crtc_atomic_check.

 ctl could be released already when we are shutting down: */

 XXX: Can this happen now? */

 Collect all plane information */

		/*

		 * if we have a right mixer, stage the same pipe as we

		 * have on the left mixer

		/*

		 * if we have a right pipe (i.e, the plane comprises of 2

		 * hwpipes, then stage the right pipe on the right side of both

		 * the layer mixers

 The reset for blending */

 Assign mixer to LEFT side in source split mode */

 Assign mixer to RIGHT side in source split mode */

	/*

	 * the line counter is 1 at the start of the VSYNC pulse and VTOTAL at

	 * the end of VFP. Translate the porch values relative to the line

	 * counter positions.

 last scan line before VSYNC */

 Disable/save vblank irq handling before power is disabled */

		/*

		 * Restore LM cursor state, as it might have been lost

		 * with suspend:

 Restore vblank irq handling after power is enabled */

	/*

	 * these should have been already set up in the encoder's atomic

	 * check (called by drm_atomic_helper_check_modeset)

 is there a helper for this? */

	/*

	 * if we're in source split mode, it's mandatory to have

	 * border out on the base stage

	/* if the bottom-most layer is not fullscreen, we need to use

	 * it for solid-color:

		/*

		 * if any plane on this crtc uses 2 hwpipes, then we need

		 * the crtc to have a right hwmixer.

 bail out early if there aren't any planes */

	/*

	 * we need a right hwmixer if the mode's width is greater than a single

	 * LM's max width

 assign a stage based on sorted zpos property */

 trigger a warning if cursor isn't the highest zorder */

	/* verify that there are not too many planes attached to crtc

	 * and that we don't have conflicting mixer stages:

	/*

	 * If no CTL has been allocated in mdp5_crtc_atomic_check(),

	 * it means we are trying to flush a CRTC whose state is disabled:

	 * nothing else needs to be done.

 XXX: Can this happen now ? */

	/* PP_DONE irq is only used by command mode for now.

	 * It is better to request pending before FLUSH and START trigger

	 * to make sure no pp_done irq missed.

	 * This is safe because no pp_done will happen before SW trigger

	 * in command mode.

 XXX are we leaking out state here? */

	/*

	 * Cursor Region Of Interest (ROI) is a plane read from cursor

	 * buffer to render. The ROI region is determined by the visibility of

	 * the cursor point. In the default Cursor image the cursor point will

	 * be at the top left of the cursor image.

	 *

	 * Without rotation:

	 * If the cursor point reaches the right (xres - x < cursor.width) or

	 * bottom (yres - y < cursor.height) boundary of the screen, then ROI

	 * width and ROI height need to be evaluated to crop the cursor image

	 * accordingly.

	 * (xres-x) will be new cursor width when x > (xres - cursor.width)

	 * (yres-y) will be new cursor height when y > (yres - cursor.height)

	 *

	 * With rotation:

	 * We get negative x and/or y coordinates.

	 * (cursor.width - abs(x)) will be new cursor width when x < 0

	 * (cursor.height - abs(y)) will be new cursor width when y < 0

	/* If cusror buffer overlaps due to rotation on the

	 * upper or left screen border the pixel offset inside

	 * the cursor buffer of the ROI is the positive overlap

	 * distance.

 don't support LM cursors when we have source split enabled */

 enable vblank to complete cursor work: */

 don't support LM cursors when we have source split enabled */

 In case the CRTC is disabled, just drop the cursor update */

 accept negative x/y coordinates up to maximum cursor overlap */

 Should not call this function if crtc is disabled. */

 should this be done elsewhere ? */

 initialize crtc */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014, The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 DSI controller cannot handle active-low sync signals. */

 probably need to get DATA_EN polarity from panel.. */

 get this from panel? */

 Get color format from panel, default is 8bpc */

	/*

	 * For edp only:

	 * DISPLAY_V_START = (VBP * HCYCLE) + HBP

	 * DISPLAY_V_END = (VBP + VACTIVE) * HCYCLE - 1 - HFP

 frame+line? */

	/*

	 * Wait for a vsync so we know the ENABLE=0 latched before

	 * the (connector) source of the vsync's gets disabled,

	 * otherwise we end up in a funny state if we re-enable

	 * before the disable latches, which results that some of

	 * the settings changes for the new modeset (like new

	 * scanout buffer) don't latch properly..

 this isn't right I think */

	/*

	 * This is a bit awkward, but we want to flush the CTL and hit the

	 * START bit at most once for an atomic update.  In the non-full-

	 * modeset case, this is done from crtc->atomic_flush(), but that

	 * is too early in the case of full modeset, in which case we

	 * defer to encoder->enable().  But we need to *know* whether

	 * encoder->enable() will be called to do this:

	/* Switch slave encoder's TimingGen Sync mode,

	 * to use the master's enable signal for the slave encoder.

 Make sure clocks are on when connectors calling this function. */

 Dumb Panel, Sync mode */

 TODO: Expand this to set writeback modes too */

 initialize encoder */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

	/*

	 * Tearcheck emits a blanking signal every vclks_line * vtotal * 2 ticks on

	 * the vsync_clk equating to roughly half the desired panel refresh rate.

	 * This is only necessary as stability fallback if interrupts from the

	 * panel arrive too late or not at all, but is currently used by default

	 * because these panel interrupts are not wired up yet.

	/* Switch slave encoder's trigger MUX, to use the master's

	 * start signal for the slave encoder

 Smart Panel, Sync mode */

 Make sure clocks are on when connectors calling this function. */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014-2015 The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 helper to install properties which are common to planes and crtcs */

 Make sure source dimensions are within bounds. */

		/* If source split is supported, we can go up to 2x

		 * the max LM width, but we'd need to stage another

		 * hwpipe to the right LM. So, the drm_plane would

		 * consist of 2 hwpipes.

 (re)allocate hw pipe if we don't have one or caps-mismatch: */

		/*

		 * (re)allocte hw pipe if we're either requesting for 2 hw pipes

		 * or we're switching from 2 hw pipes to 1 hw pipe because the

		 * new src_w can be supported by 1 hw pipe itself.

 (re)assign hwpipe if needed, otherwise keep old one: */

			/* TODO maybe we want to re-assign hwpipe sometimes

			 * in cases when we no-longer need some caps to make

			 * it available for other planes?

				/*

				 * set it to NULL so that the driver knows we

				 * don't have a right hwpipe when committing a

				 * new state

 atomic_check should have ensured that this doesn't fail */

 don't use fast path if we don't have a hwpipe allocated yet */

 only allow changing of position(crtc x/y or src x/y) in fast path */

	/*

	 * if the visibility of the plane changes (i.e, if the cursor is

	 * clipped out completely, we can't take the async path because

	 * we need to stage/unstage the plane from the Layer Mixer(s). We

	 * also assign/unassign the hwpipe(s) tied to the plane. We avoid

	 * taking the fast path for both these reasons.

 Note: mdp5_plane->pipe_lock must be locked */

 Note: mdp5_plane->pipe_lock must be locked */

 RGB, no CSC */

 2^(26-21) */

	/*

	 * PHASE_STEP_X/Y is coded on 26 bits (25:0),

	 * where 2^21 represents the unity "1" in fixed-point hardware design.

	 * This leaves 5 bits for the integer part (downscale case):

	 *	-> maximum downscale ratio = 0b1_1111 = 31

	/*

	 * Note:

	 * We assume here that:

	 *     1. PCMN filter is used for downscale

	 *     2. bilinear filter is used for upscale

	 *     3. we are in a single pipe configuration

 not using secure mode: */

 bad formats should already be rejected: */

 src values are in Q16 fixed point, convert to integer: */

		/*

		 * if the plane comprises of 2 hw pipes, assume that the width

		 * is split equally across them. The only parameters that varies

		 * between the 2 pipes are src_x and crtc_x

 TODO calc hdecm, vdecm */

 SCALE is used to both scale and up-sample chroma components */

/*

 * Use this func and the one below only after the atomic state has been

 * successfully swapped

 initialize plane */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014-2015 The Linux Foundation. All rights reserved.

 mdp5_cfg must be exposed (used in mdp5.xml.h) */

 first 8 MMBs */

 Two SMP blocks are statically tied to RGB pipes: */

 LM0 and LM3 */

 first 24 MMBs */

 driver supports max of 2 currently */

 driver supports max of 2 currently */

 driver supports max of 2 currently */

 only after mdp5_cfg global pointer's init can we access the hw */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014, The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 fixed MMBs allocation per client */

 register cache */

	/*

	 * Note on SMP clients:

	 * For ViG pipes, fetch Y/Cr/Cb-components clients are always

	 * consecutive, and in that order.

	 *

	 * e.g.:

	 * if mdp5_cfg->smp.clients[SSPP_VIG0] = N,

	 *	Y  plane's client ID is N

	 *	Cr plane's client ID is N + 1

	 *	Cb plane's client ID is N + 2

 allocate blocks for the specified request: */

 we shouldn't be requesting blocks for an in-use client: */

 1/4 of SMP pool that is being fetched */

/*

 * NOTE: looks like if horizontal decimation is used (if we supported that)

 * then the width used to calculate SMP block requirements is the post-

 * decimated width.  Ie. SMP buffering sits downstream of decimation (which

 * presumably happens during the dma from scanout buffer).

 different if BWC (compressed framebuffer?) enabled: */

	/* Newer MDPs have split/packing logic, which fetches sub-sampled

	 * U and V components (splits them from Y if necessary) and packs

	 * them together, writes to SMP using a single client.

		/* if decimation is enabled, HW decimates less on the

		 * sub sampled chroma components

 for hw rev v1.00 */

 Release SMP blocks for all clients of the pipe */

 update global state: */

 clear client's state */

/* NOTE: SMP_ALLOC_* regs are *not* double buffered, so release has to

 * happen after scanout completes.

 grab these *after* we hold the state_lock */

 statically tied MMBs cannot be re-allocated: */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2016-2018, The Linux Foundation. All rights reserved.

/**

 * Register offsets in MDSS register file for the interrupt registers

 * w.r.t. to the MDP base

/**

 * struct dpu_intr_reg - array of DPU register sets

 * @clr_off:	offset to CLEAR reg

 * @en_off:	offset to ENABLE reg

 * @status_off:	offset to STATUS reg

/*

 * struct dpu_intr_reg -  List of DPU interrupt registers

 *

 * When making changes be sure to sync with dpu_hw_intr_reg

/**

 * dpu_core_irq_callback_handler - dispatch core interrupts

 * @arg:		private data of callback handler

 * @irq_idx:		interrupt index

	/*

	 * Perform registered function callback

 Read interrupt status */

 Read enable mask */

 and clear the interrupt */

 Finally update IRQ status based on enable mask */

		/*

		 * Search through matching intr status.

			/*

			 * When callback finish, clear the irq_status

			 * with the matching mask. Once irq_status

			 * is all cleared, the search can be stopped.

 ensure register writes go through */

	/*

	 * The cache_irq_mask and hardware RMW operations needs to be done

	 * under irq_lock and it's the caller's responsibility to ensure that's

	 * held.

 Cleaning any pending interrupt */

 Enabling interrupts with the new mask */

 ensure register write goes through */

	/*

	 * The cache_irq_mask and hardware RMW operations needs to be done

	 * under irq_lock and it's the caller's responsibility to ensure that's

	 * held.

 Disable interrupts based on the new mask */

 Cleaning any pending interrupt */

 ensure register write goes through */

 ensure register writes go through */

 ensure register writes go through */

 ensure register writes go through */

 empty callback list but interrupt is still enabled */

 Create irq callbacks for all possible irq_idx */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

 using a file static variables for debugfs access */

 DPU_SCALER_QSEED3 */

 DPU_SCALER_QSEED3LITE */

 don't need to mutex protect this */

 matrix coeff - convert S15.16 to S4.9 */

 Pre clamp */

 Post clamp */

 Pre-Bias */

 Post-Bias */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, 2020-2021 The Linux Foundation. All rights reserved.

	/*

	 * https://www.kernel.org/doc/htmldocs/drm/ch02s05.html

	 *  Active Region      Front Porch   Sync   Back Porch

	 * <-----------------><------------><-----><----------->

	 * <- [hv]display --->

	 * <--------- [hv]sync_start ------>

	 * <----------------- [hv]sync_end ------->

	 * <---------------------------- [hv]total ------------->

 active width */

 active height */

 DSI controller cannot handle active-low sync signals. */

	/*

	 * For edp only:

	 * DISPLAY_V_START = (VBP * HCYCLE) + HBP

	 * DISPLAY_V_END = (VBP + VACTIVE) * HCYCLE - 1 - HFP

	/*

	 * if (vid_enc->hw->cap->type == INTF_EDP) {

	 * display_v_start += mode->htotal - mode->hsync_start;

	 * display_v_end -= mode->hsync_start - mode->hdisplay;

	 * }

 for DP/EDP, Shift timings to align it to bottom right */

/*

 * programmable_fetch_get_num_lines:

 *	Number of fetch lines in vertical front porch

 * @timing: Pointer to the intf timing information for the requested mode

 *

 * Returns the number of fetch lines in vertical front porch at which mdp

 * can start fetching the next frame.

 *

 * Number of needed prefetch lines is anything that cannot be absorbed in the

 * start of frame time (back porch + vsync pulse width).

 *

 * Some panels have very large VFP, however we only need a total number of

 * lines based on the chip worst case latencies.

 Fetch must be outside active lines, otherwise undefined. */

 Warn fetch needed, but not enough porch in panel config */

/*

 * programmable_fetch_config: Programs HW to prefetch lines by offsetting

 *	the start of fetch into the vertical front porch for cases where the

 *	vsync pulse width and vertical back porch time is insufficient

 *

 *	Gets # of lines to pre-fetch, then calculate VSYNC counter value.

 *	HW layer requires VSYNC counter of first pixel of tgt VFP line.

 *

 * @timing: Pointer to the intf timing information for the requested mode

	/*

	 * Modifying mode has consequences when the mode comes back to us

 Don't care value for video mode */

 setup which pp blk will connect to this intf */

	/*

	 * only decrement the pending flush count if we've actually flushed

	 * hardware. due to sw irq latency, vblank may have already happened

	 * so we need to double-check with hw that it accepted the flush bits

 Signal any waiting atomic commit thread */

 Slave encoders don't report vblank */

 protect against negative */

	/*

	 * For single flush cases (dual-ctl or pp-split), skip setting the

	 * flush bit for the slave intf, since both intfs use same ctl

	 * and HW will only flush the master.

 ctl_flush & timing engine enable will be triggered by framework */

 Wait for kickoff to complete */

	/*

	 * hw supports hardware initiated ctl reset, so before we kickoff a new

	 * frame, need to check and wait for hw initiated ctl reset completion

	/*

	 * Wait for a vsync so we know the ENABLE=0 latched before

	 * the (connector) source of the vsync's gets disabled,

	 * otherwise we end up in a funny state if we re-enable

	 * before the disable latches, which results that some of

	 * the settings changes for the new modeset (like new

	 * scanout buffer) don't latch properly..

	/*

	 * Video mode must flush CTL before enabling timing engine

	 * Video encoders need to turn on their interfaces now

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

 read interface_cfg */

 ACTIVE_H_ENABLE */

 ACTIVE_V_ENABLE */

  DEN Polarity  */

 VSYNC Polarity */

 HSYNC Polarity */

 Interface treats all the pixel data in RGB888 format */

 Note: Display interface select is handled in top block hw layer */

	/*

	 * Fetch should always be outside the active lines. If the fetching

	 * is programmed within active region, hardware behavior is unknown.

	/*

	 * Assign ops

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

	/*

	 * it takes around 30us to have mdp finish resetting its ctl path

	 * poll every 50us so that reset should be completed at 1st poll

 always set BORDER_OUT */

 overflow to ext register if 'i + 1 > 7' */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

/*************************************************************

 * DPU sub blocks config

 DPU top level caps */

 TODO: v2.5 */

 TODO: v2.5 */

 TODO: 2 for LP_DDR4 */

/*************************************************************

 * CTL sub blocks config

/*************************************************************

 * SSPP sub blocks config

 SSPP common configuration */

/*************************************************************

 * MIXER sub blocks config

 SDM845 */

 excluding base layer */

 offsets relative to mixer base */

 SC7180 */

 excluding base layer */

 offsets relative to mixer base */

 SM8150 */

/*************************************************************

 * DSPP sub blocks config

/*************************************************************

 * PINGPONG sub blocks config

/*************************************************************

 * MERGE_3D sub blocks config

/*************************************************************

 * INTF sub blocks config

/*************************************************************

 * VBIF sub blocks config

 VBIF QOS remap */

/*************************************************************

 * PERF data config

 SSPP QOS LUTs */

 TODO: macrotile-qseed is different from macrotile */

 TODO: macrotile-qseed is different from macrotile */

/*************************************************************

 * Hardware catalog init

/*

 * sdm845_cfg_init(): populate sdm845 dpu sub-blocks reg offsets

 * and instance counts.

/*

 * sc7180_cfg_init(): populate sc7180 dpu sub-blocks reg offsets

 * and instance counts.

/*

 * sm8150_cfg_init(): populate sm8150 dpu sub-blocks reg offsets

 * and instance counts.

/*

 * sm8250_cfg_init(): populate sm8250 dpu sub-blocks reg offsets

 * and instance counts.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014-2018 The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 multirect rect index */

/*

 * Default Preload Values

/**

 * enum dpu_plane_qos - Different qos configurations for each pipe

 *

 * @DPU_PLANE_QOS_VBLANK_CTRL: Setup VBLANK qos for the pipe.

 * @DPU_PLANE_QOS_VBLANK_AMORTIZE: Enables Amortization within pipe.

 *	this configuration is mutually exclusive from VBLANK_CTRL.

 * @DPU_PLANE_QOS_PANIC_CTRL: Setup panic for the pipe.

/*

 * struct dpu_plane - local dpu plane structure

 * @aspace: address space pointer

 * @csc_ptr: Points to dpu_csc_cfg structure to use for current

 * @mplane_list: List of multirect planes of the same pipe

 * @catalog: Points to dpu catalog structure

 * @revalidate: force revalidation of all the plane properties

 capabilities from catalog */

 debugfs related stuff */

/**

 * _dpu_plane_calc_bw - calculate bandwidth required for a plane

 * @plane: Pointer to drm plane.

 * @fb:   Pointer to framebuffer associated with the given plane

 * Result: Updates calculated bandwidth in the plane state.

 * BW Equation: src_w * src_h * bpp * fps * (v_total / v_dest)

 * Prefill BW Equation: line src bytes * line_time

/**

 * _dpu_plane_calc_clk - calculate clock required for a plane

 * @plane: Pointer to drm plane.

 * Result: Updates calculated clock in the plane state.

 * Clock equation: dst_w * v_total * fps * (src_h / dst_h)

/**

 * _dpu_plane_calc_fill_level - calculate fill level of the given source format

 * @plane:		Pointer to drm plane

 * @fmt:		Pointer to source buffer format

 * @src_width:		width of source buffer

 * Return: fill level corresponding to the source buffer/format or 0 if error

 NV12 */

 non NV12 */

/**

 * _dpu_plane_get_qos_lut - get LUT mapping based on fill level

 * @tbl:		Pointer to LUT table

 * @total_fl:		fill level

 * Return: LUT setting corresponding to the fill level

 if last fl is zero, use as default */

/**

 * _dpu_plane_set_qos_lut - set QoS LUT of the given plane

 * @plane:		Pointer to drm plane

 * @fb:			Pointer to framebuffer associated with the given plane

/**

 * _dpu_plane_set_danger_lut - set danger/safe LUT of the given plane

 * @plane:		Pointer to drm plane

 * @fb:			Pointer to framebuffer associated with the given plane

/**

 * _dpu_plane_set_qos_ctrl - set QoS control of the given plane

 * @plane:		Pointer to drm plane

 * @enable:		true to enable QoS control

 * @flags:		QoS control mode (enum dpu_plane_qos)

 this feature overrules previous VBLANK_CTRL */

 clear vblank bits */

/**

 * _dpu_plane_set_ot_limit - set OT limit for the given plane

 * @plane:		Pointer to drm plane

 * @crtc:		Pointer to drm crtc

/**

 * _dpu_plane_set_qos_remap - set vbif QoS for the given plane

 * @plane:		Pointer to drm plane

 S15.16 format */

 signed bias */

 unsigned clamp */

 S15.16 format */

 signed bias */

 unsigned clamp */

 don't chroma subsample if decimating */

 update scaler. calculate default config for QSEED3 */

/**

 * _dpu_plane_color_fill - enables color fill on plane

 * @pdpu:   Pointer to DPU plane object

 * @color:  RGB fill color value, [23..16] Blue, [15..8] Green, [7..0] Red

 * @alpha:  8-bit fill alpha value, 255 selects 100% alpha

 * Returns: 0 on success

	/*

	 * select fill format to match user property expectation,

	 * h/w only supports RGB variants

 update sspp */

 override scaler/decimation if solid fill */

		/**

		 * SSPP PD_MEM is split half - one for each RECT.

		 * Tiled formats need 5 lines of buffering while fetching

		 * whereas linear formats need only 2 lines.

		 * So we cannot support more than half of the supported SSPP

		 * width for tiled formats.

 Validate RECT's and set the mode */

 Prefer PARALLEL FETCH Mode over TIME_MX Mode */

 TIME_MX Mode */

/**

 * dpu_plane_get_ctl_flush - get control flush for the given plane

 * @plane: Pointer to drm plane structure

 * @ctl: Pointer to hardware control driver

 * @flush_sspp: Pointer to sspp flush control word

 cache aspace */

	/*

	 * TODO: Need to sort out the msm_framebuffer_prepare() call below so

	 *       we can use msm_atomic_prepare_fb() instead of doing the

	 *       implicit fence and fb prepare by hand here.

 validate framebuffer layout before commit */

 Ensure fb size is supported */

 Ensure src rect is above the minimum size */

 Ensure src is fully encapsulated in fb */

 check src bounds */

 valid yuv image */

 min dst support */

 check decimated source width */

	/*

	 * These updates have to be done immediately before the plane flush

	 * timing, and may not be moved to the atomic_update/mode_set functions.

 force white frame with 100% alpha pipe output on error */

 force 100% alpha */

 flag h/w flush complete */

/**

 * dpu_plane_set_error: enable/disable error condition

 * @plane: pointer to drm_plane structure

 * @error: error value to set

 state->src is 16.16, src_rect is not */

 override for color fill */

 skip remaining processing on color fill */

	/**

	 * when programmed in multirect mode, scalar block will be

	 * bypassed. Still we need to update alpha and bitwidth

	 * ONLY for RECT0

 update format */

 update csc */

 this will destroy the states as well */

 remove previous state, if present */

 Disable panic signal for all active pipes */

 Enable panic signal for all active pipes */

 create overall sub-directory for the pipe */

 don't error check these */

 add register dump support */

 initialize plane */

 create and zero local structure */

 cache local stuff for later */

 initialize underlying h/w driver */

 cache features mask for later */

 success! finalize initialization */

 save user friendly pipe name for later */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014-2021 The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 layer mixer index on dpu_crtc */

 timeout in ms waiting for frame done */

 Calculate MISR over 1 frame */

 Skip first 2 frames in case of "uncooked" CRCs */

	/*

	 * the line counter is 1 at the start of the VSYNC pulse and VTOTAL at

	 * the end of VFP. Translate the porch values relative to the line

	 * counter positions.

 last scan line before VSYNC */

 default to opaque blending */

 coverage blending */

 blend config update */

/**

 * _dpu_crtc_blend_setup - configure crtc mixers

 * @crtc: Pointer to drm crtc structure

 initialize stage cfg */

 stage config flush mask */

/**

 *  _dpu_crtc_complete_flip - signal pending page_flip events

 * Any pending vblank events are added to the vblank_event_list

 * so that the next vblank interrupt shall signal them.

 * However PAGE_FLIP events are not handled through the vblank_event_list.

 * This API signals any pending PAGE_FLIP events requested through

 * DRM_IOCTL_MODE_PAGE_FLIP and are cached in the dpu_crtc->event.

 * @crtc: Pointer to drm crtc structure

	/*

	 * TODO: This function is called from dpu debugfs and as part of atomic

	 * check. When called from debugfs, the crtc->mutex must be held to

	 * read crtc->state. However reading crtc->state from atomic check isn't

	 * allowed (unless you have a good reason, a big comment, and a deep

	 * understanding of how the atomic/modeset locks work (<- and this is

	 * probably not possible)). So we'll keep the WARN_ON here for now, but

	 * really we need to figure out a better way to track our operating mode

 TODO: Returns the first INTF_MODE, could there be multiple values? */

 keep statistics on vblank callback - with auto reset via debugfs */

 ignore vblank when not pending */

 release bandwidth and other resources */

/*

 * dpu_crtc_frame_event_cb - crtc frame event callback API. CRTC module

 * registers this API to encoder for all frame event callbacks like

 * frame_error, frame_done, idle_timeout, etc. Encoder may call different events

 * from different context - IRQ, user thread, commit_thread, etc. Each event

 * should be carefully reviewed and should be processed in proper task context

 * to avoid schedulin delay or properly manage the irq context's bottom half

 * processing.

 Nothing to do on idle event */

 stage config flush mask */

 encoder will trigger pending mask now */

	/*

	 * If no mixers have been allocated in dpu_crtc_atomic_check(),

	 * it means we are trying to flush a CRTC whose state is disabled:

	 * nothing else needs to be done.

	/*

	 * PP_DONE irq is only used by command mode for now.

	 * It is better to request pending before FLUSH and START trigger

	 * to make sure no pp_done irq missed.

	 * This is safe because no pp_done will happen before SW trigger

	 * in command mode.

	/*

	 * If no mixers has been allocated in dpu_crtc_atomic_check(),

	 * it means we are trying to flush a CRTC whose state is disabled:

	 * nothing else needs to be done.

 update performance setting before crtc kickoff */

	/*

	 * Final plane updates: Give each plane a chance to complete all

	 *                      required writes/flushing before crtc's "flush

	 *                      everything" call below.

 Kickoff will be scheduled by outer layer */

/**

 * dpu_crtc_destroy_state - state destroy hook

 * @crtc: drm CRTC

 * @state: CRTC state object to release

	/*

	 * If no mixers has been allocated in dpu_crtc_atomic_check(),

	 * it means we are trying to start a CRTC whose state is disabled:

	 * nothing else needs to be done.

	/*

	 * Encoder will flush/start now, unless it has a tx pending. If so, it

	 * may delay and flush at an irq event (e.g. ppdone)

 acquire bandwidth and other resources */

/**

 * dpu_crtc_duplicate_state - state duplicate hook

 * @crtc: Pointer to drm crtc structure

 duplicate base helper */

 Disable/save vblank irq handling */

		/* in video mode, we hold an extra bandwidth reference

		 * as we cannot drop bandwidth at frame-done if any

		 * crtc is being used in video mode.

 wait for frame_event_done completion */

 disable clk & bw control until clk & bw properties are set */

		/* in video mode, we hold an extra bandwidth reference

		 * as we cannot drop bandwidth at frame-done if any

		 * crtc is being used in video mode.

 Enable/restore vblank irq handling */

 force a full mode set if active state changed */

 get plane state for all drm planes associated with crtc state */

 reset counts at every new blend stage */

 verify z_pos setting before using it */

	/* validate source split:

	 * use pstates sorted by stage to check planes on same stage

	 * we assume that all pipes are in source split so its valid to compare

	 * without taking into account left/right mixer placement

		/**

		 * - planes are enumerated in pipe-priority order such that

		 *   planes with lower drm_id must be left-most in a shared

		 *   blend-stage when using source split.

		 * - planes in source split must be contiguous in width

		 * - planes in source split must have same dest yoff and height

	/*

	 * Normally we would iterate through encoder_mask in crtc state to find

	 * attached encoders. In this case, we might be disabling vblank _after_

	 * encoder_mask has been cleared.

	 *

	 * Instead, we "assign" a crtc to the encoder in enable and clear it in

	 * disable (which is also after encoder_mask is cleared). So instead of

	 * using encoder mask, we'll ask the encoder to toggle itself iff it's

	 * currently assigned to our crtc.

	 *

	 * Note also that this function cannot be called while crtc is disabled

	 * since we use drm_crtc_vblank_on/off. So we don't need to worry

	 * about the assigned crtcs being inconsistent with the current state

	 * (which means no need to worry about modeset locks).

 reset time & count for next measurement */

 CONFIG_DEBUG_FS */

 initialize crtc */

 save user friendly CRTC name for later */

 initialize event handling */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015-2018, 2020-2021 The Linux Foundation. All rights reserved.

/*

 * Tearcheck sync start and continue thresholds are empirically found

 * based on common panels In the future, may want to allow panels to override

 * these default values

 notify all synchronous clients first, then asynchronous clients */

 Signal any waiting atomic commit thread */

 Signal any waiting ctl start interrupt */

 to avoid flooding, only log first time, and "dead" time */

 request a ctl reset before the next kickoff */

 Slave encoders don't report vblank */

 protect against negative */

	/*

	 * TE default: dsi byte clock calculated base on 70 fps;

	 * around 14 ms to complete a kickoff cycle if te disabled;

	 * vclk_line base on 60 fps; write is faster than read;

	 * init == start == rdptr;

	 *

	 * vsync_count is ratio of MDP VSYNC clock frequency to LCD panel

	 * frequency divided by the no. of rows (lines) in the LCDpanel.

	/*

	 * Set the sync_cfg_height to twice vtotal so that if we lose a

	 * TE event coming from the display TE pin we won't stall immediately

	/**

	 * we do separate flush for each CTL and let

	 * CTL_START synchronize them

	/*

	 * Mark kickoff request as outstanding. If there are more than one,

	 * outstanding, then we have to wait for the previous one to complete

 force pending_kickoff_cnt 0 to discard failed kickoff */

 If autorefresh is already disabled, we have nothing to do */

	/*

	 * If autorefresh is enabled, disable it and make sure it is safe to

	 * proceed with current frame commit/push. Sequence fallowed is,

	 * 1. Disable TE

	 * 2. Disable autorefresh config

	 * 4. Poll for frame transfer ongoing to be false

	 * 5. Enable TE back

 only required for master controller */

 only required for master controller */

	/**

	 * re-enable external TE, either for the first time after enabling

	 * or if disabled for Autorefresh

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014-2018, The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * To enable overall DRM driver logging

 * # echo 0x2 > /sys/module/drm/parameters/debug

 *

 * To enable DRM driver h/w logging

 * # echo <mask> > /sys/kernel/debug/dri/0/debug/hw_log_mask

 *

 * See dpu_hw_mdss.h for h/w logging mask definitions (search for DPU_DBG_MASK_)

 Min ib vote 400MB */

 insert padding spaces, if needed */

 main register output */

 make sure offset is a multiple of 4 */

 Global/shared object state funcs */

/*

 * This is a helper that returns the private state currently in operation.

 * Note that this would return the "old_state" if called in the atomic check

 * path, and the "new_state" after the atomic swap has been done.

/*

 * This acquires the modeset lock set aside for global state, creates

 * a new duplicated private object state.

 Call prepare_commit for all affected encoders */

/*

 * Override the encoder enable since we need to setup the inline rotator and do

 * some crtc magic before enabling any bridge that might be present.

 Forward this enable call to the commit hook */

		/*

		 * Wait for post-flush if necessary to delay before

		 * plane_cleanup. For example, wait for vsync in case of video

		 * mode panels. This may be a no-op for command mode panels.

	/*

	 * We support following confiurations:

	 * - Single DSI host (dsi0 or dsi1)

	 * - Two independent DSI hosts

	 * - Bonded DSI0 and DSI1 hosts

	 *

	 * TODO: Support swapping DSI0 and DSI1 in the bonded setup.

/**

 * _dpu_kms_setup_displays - create encoders, bridges and connectors

 *                           for underlying displays

 * @dev:        Pointer to drm device structure

 * @priv:       Pointer to private drm device data

 * @dpu_kms:    Pointer to dpu kms structure

 * Returns:     Zero on success

	/*

	 * Create encoder and query display drivers to create

	 * bridges and connectors

 Create the planes, keeping track of one primary/cursor per crtc */

 Create one CRTC per encoder */

 All CRTCs are compatible with all encoders */

 safe to call these more than once during shutdown */

 dump CTL sub-blocks HW regs info */

 dump DSPP sub-blocks HW regs info */

 dump INTF sub-blocks HW regs info */

 dump PP sub-blocks HW regs info */

 dump SSPP sub-blocks HW regs info */

	/*

	 * Now we need to read the HW catalog and initialize resources such as

	 * clocks, regulators, GDSC/MMAGIC, ioremap the register ranges etc

	/*

	 * max crtc width is equal to the max mixer width * 2 and max height is

	 * is 4K

 Disable vblank irqs aggressively for power-saving */

	/*

	 * _dpu_kms_drm_obj_init should create the DRM related objects

	 * i.e. CRTCs, planes, encoders, connectors and so forth

 OPP table is optional */

 Drop the performance state vote */

 Min vote of BW is required before turning on AXI clk */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

 DPU_SSPP_SRC */

 SSPP_MULTIRECT*/

 SSPP_QOS_CTRL */

 DPU_SSPP_SCALER_QSEED2 */

/*

 * Definitions for ViG op modes

/*

 * Definitions for CSC 10 op modes

 traffic shaper clock in Hz */

		/**

		 * if rect index is RECT_SOLO, we cannot expect a

		 * virtual plane sharing the same SSPP id. So we go

		 * and disable multirect

/*

 * Setup source pixel format, flip,

 ROT90 */

 SRCC3_EN */

FRAME_FORMAT */

 TODO: UBWC v1 case */

 if this is YUV pixel format, enable CSC */

 update scaler opmode, if appropriate */

 clear previous UBWC error */

 program SW pixel extension override for all pipes*/

 color 2 has the same set of registers as color 1 */

 color 0 */

 color 1 and color 2 */

 color 3 */

/*

 * dpu_hw_sspp_setup_rects()

 src and dest rect programming */

 rectangle register programming */

 Assign ops */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

 interface controlling sw trigger */

 clear timer */

 enable heartbeat timer */

 enable WD timer */

 make sure that timers are enabled/disabled for vsync state */

	/*

	 * Assign ops

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

/*

 * DPU supported format packing, bpp, and other format

 * information.

 * DPU currently only supports interleaved RGB formats

 * UBWC support for a pixel format is indicated by the flag,

 * there is additional meta data plane for such formats

/*

 * struct dpu_media_color_map - maps drm format to media format

 * @format: DRM base pixel format

 * @color: Media API color related to DRM format

/*

 * UBWC formats table:

 * This table holds the UBWC formats supported.

 * If a compression ratio needs to be used for this or any other format,

 * the data will be passed by user-space.

	/* ARGB8888 and ABGR8888 purposely have the same color

	 * ordering.  The hardware only supports ABGR8888 UBWC

	 * natively.

/* _dpu_get_v_h_subsample_rate - Get subsample rates for all formats we support

 *   Note: Not using the drm_format_*_subsampling since we have formats

 Due to memset above, only need to set planes of interest */

 planar */

	/*

	 * linear format: allow user allocated pitches if they are greater than

	 * the requirement.

	 * ubwc format: pitch values are computed uniformly across

	 * all the components based on ubwc specifications.

 Per-format logic for verifying active planes */

***********************************************/

      UBWC            **                      */

      buffer          **      DPU PLANE       */

      format          **                      */

***********************************************/

 -------------------  ** -------------------- */

 |      Y meta     |  ** |    Y bitstream   | */

 |       data      |  ** |       plane      | */

 -------------------  ** -------------------- */

 |    Y bitstream  |  ** |  CbCr bitstream  | */

 |       data      |  ** |       plane      | */

 -------------------  ** -------------------- */

 |   Cbcr metadata |  ** |       Y meta     | */

 |       data      |  ** |       plane      | */

 -------------------  ** -------------------- */

 |  CbCr bitstream |  ** |     CbCr meta    | */

 |       data      |  ** |       plane      | */

 -------------------  ** -------------------- */

***********************************************/

 configure Y bitstream plane */

 configure CbCr bitstream plane */

 configure Y metadata plane */

 configure CbCr metadata plane */

***********************************************/

      UBWC            **                      */

      buffer          **      DPU PLANE       */

      format          **                      */

***********************************************/

 -------------------  ** -------------------- */

 |      RGB meta   |  ** |   RGB bitstream  | */

 |       data      |  ** |       plane      | */

 -------------------  ** -------------------- */

 |  RGB bitstream  |  ** |       NONE       | */

 |       data      |  ** |                  | */

 -------------------  ** -------------------- */

                      ** |     RGB meta     | */

                      ** |       plane      | */

                      ** -------------------- */

***********************************************/

 Can now check the pitches given vs pitches expected */

 Populate addresses for simple formats here */

 Populate the plane sizes etc via get_format */

 Populate the addresses given the fb */

 check if anything changed */

	/*

	 * Currently only support exactly zero or one modifier.

	 * All planes use the same modifier.

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

	/*

	 * Assume 4 bits per bit field, 8 fields per 32-bit register so

	 * 16 bit fields maximum across two registers

	/*

	 * Assign ops

 no need to register sub-range in dpu dbg, dump entire vbif io base */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2016-2018, The Linux Foundation. All rights reserved.

/**

 * struct dpu_rm_requirements - Reservation requirements parameter bundle

 * @topology:  selected topology for the display

 * @hw_res:	   Hardware resources required as reported by the encoders

 Clear, setup lists */

 Interrogate HW catalog and create tracking items for hw blocks */

			/*

			 * Don't expect to have hw where lm max widths differ.

			 * If found, take the min.

/**

 * _dpu_rm_check_lm_peer - check if a mixer is a peer of the primary

 * @rm: dpu resource manager handle

 * @primary_idx: index of primary mixer in rm->mixer_blks[]

 * @peer_idx: index of other mixer in rm->mixer_blks[]

 * Return: true if rm->mixer_blks[peer_idx] is a peer of

 *          rm->mixer_blks[primary_idx]

/**

 * _dpu_rm_check_lm_and_get_connected_blks - check if proposed layer mixer meets

 *	proposed use case requirements, incl. hardwired dependent blocks like

 *	pingpong

 * @rm: dpu resource manager handle

 * @global_state: resources shared across multiple kms objects

 * @enc_id: encoder id requesting for allocation

 * @lm_idx: index of proposed layer mixer in rm->mixer_blks[], function checks

 *      if lm, and all other hardwired blocks connected to the lm (pp) is

 *      available and appropriate

 * @pp_idx: output parameter, index of pingpong block attached to the layer

 *      mixer in rm->pingpong_blks[].

 * @dspp_idx: output parameter, index of dspp block attached to the layer

 *      mixer in rm->dspp_blks[].

 * @reqs: input parameter, rm requirements for HW blocks needed in the

 *      datapath.

 * Return: true if lm matches all requirements, false otherwise

 Already reserved? */

 Find a primary mixer */

 Valid primary mixer found, find matching peers */

 each hw_intf needs its own hw_ctrl to program its control path */

 Check if this is just a page-flip */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

 DSPP_PCC */

 Assign ops */

/*

 * SPDX-License-Identifier: GPL-2.0

 * Copyright (c) 2018, The Linux Foundation

 Max BW defined in KBps */

 memory barrier */

 memory barrier */

 memory barrier */

 memory barrier */

	/*

	 * ubwc config is part of the "mdss" region which is not accessible

	 * from the rest of the driver. hardcode known configurations here

 TODO: 0x102e for LP_DDR4 */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015-2021, The Linux Foundation. All rights reserved.

 These register are offset to mixer base + stage base */

/**

 * _stage_offset(): returns the relative offset of the blend registers

 * for the stage to be setup

 * @ctx:     mixer ctx contains the mixer to be programmed

 * @stage: stage index to setup

 SPLIT_LEFT_RIGHT */

 Clear old MISR value (in case it's read before a new value is calculated)*/

 read the existing op_mode configuration */

 Assign ops */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

/**

 * _dpu_vbif_wait_for_xin_halt - wait for the xin to halt

 * @vbif:	Pointer to hardware vbif driver

 * @xin_id:	Client interface identifier

 * @return:	0 if success; error code otherwise

/**

 * _dpu_vbif_apply_dynamic_ot_limit - determine OT based on usecase parameters

 * @vbif:	Pointer to hardware vbif driver

 * @ot_lim:	Pointer to OT limit to be modified

 * @params:	Pointer to usecase parameters

 Dynamic OT setting done only for WFD */

/**

 * _dpu_vbif_get_ot_limit - get OT based on usecase & configuration parameters

 * @vbif:	Pointer to hardware vbif driver

 * @params:	Pointer to usecase parameters

 * @return:	OT limit

	/*

	 * If default ot is not set from dt/catalog,

	 * then do not configure it.

 Modify the limits if the target and the use case requires it */

/**

 * dpu_vbif_set_ot_limit - set OT based on usecase & configuration parameters

 * @dpu_kms:	DPU handler

 * @params:	Pointer to usecase parameters

 *

 * Note this function would block waiting for bus halt.

 set write_gather_en for all write clients */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2012-2015, 2017-2018, The Linux Foundation.

 * All rights reserved.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2014-2018, 2020-2021 The Linux Foundation. All rights reserved.

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

/*

 * Two to anticipate panels that can do cmd/vid dynamic switching

 * plan is to create all possible physical encoder types, and switch between

 * them at runtime

 timeout in frames waiting for frame done */

/**

 * enum dpu_enc_rc_events - events for resource control state machine

 * @DPU_ENC_RC_EVENT_KICKOFF:

 *	This event happens at NORMAL priority.

 *	Event that signals the start of the transfer. When this event is

 *	received, enable MDP/DSI core clocks. Regardless of the previous

 *	state, the resource should be in ON state at the end of this event.

 * @DPU_ENC_RC_EVENT_FRAME_DONE:

 *	This event happens at INTERRUPT level.

 *	Event signals the end of the data transfer after the PP FRAME_DONE

 *	event. At the end of this event, a delayed work is scheduled to go to

 *	IDLE_PC state after IDLE_TIMEOUT time.

 * @DPU_ENC_RC_EVENT_PRE_STOP:

 *	This event happens at NORMAL priority.

 *	This event, when received during the ON state, leave the RC STATE

 *	in the PRE_OFF state. It should be followed by the STOP event as

 *	part of encoder disable.

 *	If received during IDLE or OFF states, it will do nothing.

 * @DPU_ENC_RC_EVENT_STOP:

 *	This event happens at NORMAL priority.

 *	When this event is received, disable all the MDP/DSI core clocks, and

 *	disable IRQs. It should be called from the PRE_OFF or IDLE states.

 *	IDLE is expected when IDLE_PC has run, and PRE_OFF did nothing.

 *	PRE_OFF is expected when PRE_STOP was executed during the ON state.

 *	Resource state should be in OFF at the end of the event.

 * @DPU_ENC_RC_EVENT_ENTER_IDLE:

 *	This event happens at NORMAL priority from a work item.

 *	Event signals that there were no frame updates for IDLE_TIMEOUT time.

 *	This would disable MDP/DSI core clocks and change the resource state

 *	to IDLE.

/*

 * enum dpu_enc_rc_states - states that the resource control maintains

 * @DPU_ENC_RC_STATE_OFF: Resource is in OFF state

 * @DPU_ENC_RC_STATE_PRE_OFF: Resource is transitioning to OFF state

 * @DPU_ENC_RC_STATE_ON: Resource is in ON state

 * @DPU_ENC_RC_STATE_MODESET: Resource is in modeset state

 * @DPU_ENC_RC_STATE_IDLE: Resource is in IDLE state

/**

 * struct dpu_encoder_virt - virtual encoder. Container of one or more physical

 *	encoders. Virtual encoder manages one "logical" display. Physical

 *	encoders manage one intf block, tied to a specific panel/sub-panel.

 *	Virtual encoder defers as much as possible to the physical encoders.

 *	Virtual encoder registers itself with the DRM Framework as the encoder.

 * @base:		drm_encoder base class for registration with DRM

 * @enc_spinlock:	Virtual-Encoder-Wide Spin Lock for IRQ purposes

 * @bus_scaling_client:	Client handle to the bus scaling interface

 * @enabled:		True if the encoder is active, protected by enc_lock

 * @num_phys_encs:	Actual number of physical encoders contained.

 * @phys_encs:		Container of physical encoders managed.

 * @cur_master:		Pointer to the current master in this mode. Optimization

 *			Only valid after enable. Cleared as disable.

 * @cur_slave:		As above but for the slave encoder.

 * @hw_pp:		Handle to the pingpong blocks used for the display. No.

 *			pingpong blocks can be different than num_phys_encs.

 * @intfs_swapped:	Whether or not the phys_enc interfaces have been swapped

 *			for partial update right-only cases, such as pingpong

 *			split where virtual pingpong does not generate IRQs

 * @crtc:		Pointer to the currently assigned crtc. Normally you

 *			would use crtc->state->encoder_mask to determine the

 *			link between encoder/crtc. However in this case we need

 *			to track crtc in the disable() hook which is called

 *			_after_ encoder_mask is cleared.

 * @crtc_kickoff_cb:		Callback into CRTC that will flush & start

 *				all CTL paths

 * @crtc_kickoff_cb_data:	Opaque user data given to crtc_kickoff_cb

 * @debugfs_root:		Debug file system root file node

 * @enc_lock:			Lock around physical encoder

 *				create/destroy/enable/disable

 * @frame_busy_mask:		Bitmask tracking which phys_enc we are still

 *				busy processing current command.

 *				Bit0 = phys_encs[0] etc.

 * @crtc_frame_event_cb:	callback handler for frame event

 * @crtc_frame_event_cb_data:	callback handler private data

 * @frame_done_timeout_ms:	frame done timeout in ms

 * @frame_done_timer:		watchdog timer for frame done event

 * @vsync_event_timer:		vsync timer

 * @disp_info:			local copy of msm_display_info struct

 * @idle_pc_supported:		indicate if idle power collaps is supported

 * @rc_lock:			resource control mutex lock to protect

 *				virt encoder over various state changes

 * @rc_state:			resource controller state

 * @delayed_off_work:		delayed worker to schedule disabling of

 *				clks and resources after IDLE_TIMEOUT time.

 * @vsync_event_work:		worker to handle vsync event for autorefresh

 * @topology:                   topology of the display

 * @idle_timeout:		idle timeout duration in milliseconds

 * @dp:				msm_dp pointer, for DP encoders

 note: do master / slave checking outside */

 return EWOULDBLOCK since we know the wait isn't necessary */

 silently skip irqs that weren't registered */

 Query resources used by phys encs, expected to be without overlap */

	/**

	 * disable split modes since encoder will be operating in as the only

	 * encoder, either for the entire use case in the case of, for example,

	 * single DSI, or for this frame in the case of left/right only partial

	 * update.

	/* Datapath topology selection

	 *

	 * Dual display

	 * 2 LM, 2 INTF ( Split display using 2 interfaces)

	 *

	 * Single display

	 * 1 LM, 1 INTF

	 * 2 LM, 1 INTF (stream merge to support high resolution interfaces)

	 *

	 * Adding color blocks only to primary interface if available in

	 * sufficient number

 perform atomic check on the first physical encoder (master) */

 Reserve dynamic resources now. */

		/*

		 * Release and Allocate resources on every modeset

		 * Dont allocate when active is false.

 this pointers are checked in virt_enable_helper */

 enable DPU core clks */

 enable all the irq */

 disable all the irq */

 disable DPU core clks */

	/*

	 * when idle_pc is not supported, process only KICKOFF, STOP and MODESET

	 * events and return early for other events (ie wb display).

 cancel delayed off work, if any */

 return if the resource control is already in ON state */

		/*

		 * mutex lock is not used as this event happens at interrupt

		 * context. And locking is not required as, the other events

		 * like KICKOFF and STOP does a wait-for-idle before executing

		 * the resource_control

		/*

		 * schedule off work item only when there are no

		 * frames pending

 cancel delayed off work, if any */

 skip if is already OFF or IDLE, resources are off already */

 return if the resource control is already in OFF state */

		/**

		 * expect to arrive here only if in either idle state or pre-off

		 * and in IDLE state the resources are already disabled

		/*

		 * if we are in ON but a frame was just kicked off,

		 * ignore the IDLE event, it's probably a stale timer event

 Query resource that have been reserved in atomic check step. */

 always enable slave encoder before master */

 wait for idle */

 after phys waits for frame-done, should be no more frames pending */

 trigger dump only on the first underrun */

 crtc should always be cleared before re-assigning */

			/**

			 * suppress frame_done without waiter,

			 * likely autorefresh

 One of the physical encoders has become idle */

/**

 * _dpu_encoder_trigger_flush - trigger flush for a physical encoder

 * @drm_enc: Pointer to drm encoder structure

 * @phys: Pointer to physical encoder structure

 * @extra_flush_bits: Additional bit mask to include in flush trigger

/**

 * _dpu_encoder_trigger_start - trigger start for a physical encoder

 * @phys: Pointer to physical encoder structure

 If we timed out, counter is valid and time is less, wait again */

/**

 * _dpu_encoder_kickoff_phys - handle physical encoder kickoff

 *	Iterate through the physical encoders and perform consolidated flush

 *	and/or control start triggering as needed. This is done in the virtual

 *	encoder rather than the individual physical ones in order to handle

 *	use cases that require visibility into multiple physical encoders at

 *	a time.

 * @dpu_enc: Pointer to virtual encoder structure

 update pending counts and trigger kickoff ctl flush atomically */

 don't perform flush/start operations for slave encoders */

		/*

		 * This is cleared in frame_done worker, which isn't invoked

		 * for async commits. So don't set this for async, since it'll

		 * roll over to the next commit.

 for split flush, combine pending flush masks and send to master */

 update only for command mode primary ctl */

	/*

	 * For linetime calculation, only operate on master encoder.

 pixel clock in kHz */

	/*

	 * Line time calculation based on Pixel clock and HTOTAL.

	 * Final unit is in ns.

 prepare for next kickoff, may include waiting on previous kickoff */

 if any phys needs reset, reset all phys, in-order */

 All phys encs are ready to go, trigger the kickoff */

 allow phys encs to handle any post-kickoff business */

 create overall sub-directory for the encoder */

 don't error check these */

	/*

	 * We may create up to NUM_PHYS_ENCODER_TYPES physical encoder types

	 * in this function, check up-front.

		/*

		 * Left-most tile is at index 0, content is controller id

		 * h_tile_instance_ids[2] = {0, 1}; DSI0 = left, DSI1 = right

		 * h_tile_instance_ids[2] = {1, 0}; DSI1 = left, DSI0 = right

 This is called by dpu_kms_encoder_enable */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

VSYNC_COUNTER_EN */

/*

 * dpu_hw_pp_get_autorefresh_config - Get autorefresh config from HW

 * @pp:          DPU pingpong structure

 * @frame_count: Used to return the current frame count from hw

 *

 * Returns: True if autorefresh enabled, false if disabled.

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2015-2018, The Linux Foundation. All rights reserved.

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2016-2018, The Linux Foundation. All rights reserved.

/**

 * enum dpu_perf_mode - performance tuning mode

 * @DPU_PERF_MODE_NORMAL: performance controlled by user mode client

 * @DPU_PERF_MODE_MINIMUM: performance bounded by minimum setting

 * @DPU_PERF_MODE_FIXED: performance bounded by fixed setting

 * @DPU_PERF_MODE_MAX: maximum value, used for error checking

/**

 * _dpu_core_perf_calc_bw() - to calculate BW per crtc

 * @kms:  pointer to the dpu_kms

 * @crtc: pointer to a crtc

 * Return: returns aggregated BW for all planes in crtc.

/**

 * _dpu_core_perf_calc_clk() - to calculate clock per crtc

 * @kms:  pointer to the dpu_kms

 * @crtc: pointer to a crtc

 * @state: pointer to a crtc state

 * Return: returns max clk for all planes in crtc.

 we only need bandwidth check on real-time clients (interfaces) */

 obtain new values */

 convert bandwidth to kb */

Bps_to_icc*/

/**

 * dpu_core_perf_crtc_release_bw() - request zero bandwidth

 * @crtc: pointer to a crtc

 *

 * Function checks a state variable for the crtc, if all pending commit

 * requests are done, meaning no more bandwidth is needed, release

 * bandwidth request.

 Release the bandwidth */

		/*

		 * cases for bus bandwidth update.

		 * 1. new bandwidth vote - "ab or ib vote" is higher

		 *    than current vote for update request.

		 * 2. new bandwidth vote - "ab or ib vote" is lower

		 *    than current vote at end of commit or stop.

	/*

	 * Update the clock after bandwidth vote to ensure

	 * bandwidth is available before clock rate is increased.

 run the driver with max clk and BW vote */

 reset the perf tune params to 0 */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 * Author: Vinay Simha <vinaysimha@inforcecomputing.com>

 this should probably be a helper: */

 TODO, these should come from panel somehow: */

 probably need to get DATA_EN polarity from panel.. */

 get this from panel? */

	/*

	 * Wait for a vsync so we know the ENABLE=0 latched before

	 * the (connector) source of the vsync's gets disabled,

	 * otherwise we end up in a funny state if we re-enable

	 * before the disable latches, which results that some of

	 * the settings changes for the new modeset (like new

	 * scanout buffer) don't latch properly..

 TODO: hard-coded for 18bpp: */

 initialize encoder */

 TODO: do we need different pll in other cases? */

 TODO: different regulators in other cases? */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 * Author: Vinay Simha <vinaysimha@inforcecomputing.com>

 initialize connector */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

 * Copyright (c) 2014, Inforce Computing. All rights reserved.

 *

 * Author: Vinay Simha <vinaysimha@inforcecomputing.com>

 probably need to get DATA_EN polarity from panel.. */

 get this from panel? */

	/*

	 * Wait for a vsync so we know the ENABLE=0 latched before

	 * the (connector) source of the vsync's gets disabled,

	 * otherwise we end up in a funny state if we re-enable

	 * before the disable latches, which results that some of

	 * the settings changes for the new modeset (like new

	 * scanout buffer) don't latch properly..

 initialize encoder */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 which mixer/encoder we route output to: */

 next cursor to scan-out: */

 current cursor being scanned out: */

 if there is a pending flip, these will be non-null: */

	/* Bits have been flushed at the last commit,

	 * used to decide if a vsync has happened since last commit.

 for unref'ing cursor bo's after scanout completes: */

 if file!=NULL, this is preclose potential cancel-flip path */

 statically (for now) map planes to mixer stage (z-order): */

/* setup mixer config, for which we need to consider all crtc's and

 * the planes attached to them

 *

 * TODO may possibly need some extra locking here

 take data from pipe: */

 Disable/save vblank irq handling before power is disabled */

 Restore vblank irq handling after power is enabled */

 TODO anything else to check?

/* called from IRQ to update cursor related registers (if needed).  The

 * cursor registers, other than x/y position, appear not to be double

 * buffered, and changing them other than from vblank seems to trigger

 * underflow.

 take a obj ref + iova ref when we start scanning out: */

 enable cursor: */

 disable cursor: */

 and drop the iova ref + obj rev when done scanning out: */

 drop our previous reference: */

 set dma config, ie. the format the encoder wants. */

 set interface for routing crtc->encoder: */

	/* wait_for_flush_done is the only case for now.

	 * Later we will have command mode CRTC to wait for

	 * other event.

 initialize crtc */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 probably need to get DATA_EN polarity from panel.. */

 get this from panel? */

	/*

	 * Wait for a vsync so we know the ENABLE=0 latched before

	 * the (connector) source of the vsync's gets disabled,

	 * otherwise we end up in a funny state if we re-enable

	 * before the disable latches, which results that some of

	 * the settings changes for the new modeset (like new

	 * scanout buffer) don't latch properly..

 initialize encoder */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 MDP format helper functions */

 helper to install properties which are common to planes and crtcs */

 XXX

 XXX

 atomic_check should have ensured that this doesn't fail */

 src values are in Q16 fixed point, convert to integer: */

 initialize plane */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 max read pending cmd config, 3 pending requests: */

 16 bytes-burst x 8 req */

 16 bytes-burs x 8 req */

 8 bytes-burst x 8 req */

 16 bytes-burst x 4 req */

 disable CSC matrix / YUV by default: */

 TODO */

 if we had >1 encoder, we'd need something more clever: */

		/*

		 * bail out early if there is no panel node (no need to

		 * initialize LCDC encoder and LVDS connector)

 LCDC can be hooked to DMA_P (TODO: Add DMA_S later?) */

 DTV can be hooked to DMA_E: */

 Construct bridge/connector for HDMI: */

 only DSI1 supported for now */

 TODO: Add DMA_S later? */

 construct non-private planes: */

	/*

	 * we currently set up two relatively fixed paths:

	 *

	 * LCDC/LVDS path: RGB1 -> DMA_P -> LCDC -> LVDS

	 *			or

	 * DSI path: RGB1 -> DMA_P -> DSI1 -> DSI Panel

	 *

	 * DTV/HDMI path: RGB2 -> DMA_E -> DTV -> HDMI

	/* NOTE: driver for this regulator still missing upstream.. use

	 * _get_exclusive() and ignore the error if it does not exist

	 * (and hope that the bootloader left it on for us)

	/* make sure things are off before attaching iommu (bootloader could

	 * have left things on, in which case we'll start getting faults if

	 * we don't disable):

 TODO: Chips that aren't apq8064 have a 200 Mhz max_clk */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2014 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 NOTE: keep sorted highest freq to lowest: */

 Wait until LVDS PLL is locked and ready */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

 Init dsi host */

 GET dsi PHY */

 Register to dsi manager */

 Don't fail the bind if the dsi port is not connected */

	/*

	 * check if the dsi encoder output is connected to a panel or an

	 * external bridge. We create a connector only if we're connected to a

	 * drm_panel device. When we're connected to an external bridge, we

	 * assume that the drm_bridge driver will create the connector itself.

 bridge/connector are normally destroyed by drm: */

 don't destroy connector if we didn't make it */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

 1.2 V */

 3.0 V */

 1.8 V */

 3.0 V */

 1.2 V */

 1.8 V */

 1.2 V */

 1.8 V */

 1.2 V */

 1.8 V */

 1.25 V */

 1.8 V */

 1.0 V */

 1.8 V */

 1.25 V */

 0.925 V */

 1.8 V */

 0.9 V */

 1.2 V */

 1.2 V */

 1.2 V */

 1.2 V */

 1.2 V */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

/* According to the current drm framework sequence, take the encoder of

 * DSI_1 as master encoder

	/* We assume 2 dsi nodes have the same information of bonded dsi and

	 * sync-mode, and only one node specifies master in case of bonded mode.

		/* Register slave host first, so that slave DSI device

		 * has a chance to probe, and do not block the master

		 * DSI device's probe.

		 * Also, do not check defer for the slave host,

		 * because only master DSI device adds the panel to global

		 * panel list. The panel's device is the master DSI device.

 PLL0 is to drive both 2 DSI link clocks in bonded DSI mode. */

	/* In case of bonded DSI, some registers in PHY1 have been programmed

	 * during PLL0 clock's set_rate. The PHY1 reset called by host1 here

	 * will silently reset those PHY1 registers. Therefore we need to reset

	 * and enable both PHYs before any PLL clock operation.

	/* disable DSI phy

	 * In bonded dsi configuration, the phy should be disabled for the

	 * first controller only when the second controller is disabled.

	/*

	 * There is only 1 panel in the global panel list for bonded DSI mode.

	 * Therefore slave dsi should get the drm_panel instance from master

	 * dsi.

	/*

	 * Set split display info to kms once bonded DSI panel is connected to

	 * both hosts.

	/*

	 * In bonded DSI mode, we have one connector that can be

	 * attached to the drm_panel.

 Do nothing with the host if it is slave-DSI in case of bonded DSI */

	/*

	 * Enable before preparing the panel, disable after unpreparing, so

	 * that the panel can communicate over the DSI link.

	/* Always call panel functions once, because even for dual panels,

	 * there is only one drm_panel instance.

 if dual dsi, trigger tpg on master first then slave */

 Do nothing with the host if it is slave-DSI in case of bonded DSI */

 Do nothing with the host if it is slave-DSI in case of bonded DSI */

	/*

	 * Do nothing with the host if it is slave-DSI in case of bonded DSI.

	 * It is safe to call dsi_mgr_phy_disable() here because a single PHY

	 * won't be diabled until both PHYs request disable.

 Save PHY status if it is a clock source */

 initialize connector when we're connected to a drm_panel */

	/* Enable HPD to let hpd event is handled

	 * when panel is attached to the host.

 Display driver doesn't support interlace now. */

	/*

	 * For bonded DSI, we only have one drm panel. For this

	 * use case, we register only one bridge/connector.

	 * Skip bridge/connector initialisation if it is

	 * slave-DSI for bonded DSI configuration.

 initialize bridge */

	/*

	 * Try first to create the bridge without it creating its own

	 * connector.. currently some bridges support this, and others

	 * do not (and some support both modes)

 link the internal dsi bridge to the external bridge */

		/*

		 * we need the drm_connector created by the external bridge

		 * driver (or someone else) to feed it to our driver's

		 * priv->connector[] list, mainly for msm_fbdev_init()

	/* In bonded master case, panel requires the same commands sent to

	 * both DSI links. Host issues the command trigger to both links

	 * when DSI_1 calls the cmd transfer function, no matter it happens

	 * before or after DSI_0 cmd transfer.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

	/*

	 * From DSI6G(v3), addition of a 6G_HW_VERSION register at offset 0

	 * makes all other registers 4-byte shifted down.

	 *

	 * In order to identify between DSI6G(v3) and beyond, and DSIv2 and

	 * older, we read the DSI_VERSION register without any shift(offset

	 * 0x1f0). In the case of DSIv2, this hast to be a non-zero value. In

	 * the case of DSI6G, this has to be zero (the offset points to a

	 * scratch register which we never touch)

 older dsi host, there is no register shift */

 old versions */

		/*

		 * newer host, offset 0 has 6G_HW_VERSION, the rest of the

		 * registers are shifted down, read DSI_VERSION again with

		 * the shifted offset

 6G version */

 DSI v2 specific clocks */

 Protect interrupt ctrl register */

 DSI 6G TX buffer*/

 DSI v2 TX buffer */

 connected device info */

 lane data parsed via DT */

 from phy DT */

 get bus clocks */

 get link and source clocks */

 For CPHY, byte_intf_clk is same as byte_clk */

 Drop the performance state vote */

	/*

	 * For bonded DSI mode, the current DRM mode has the complete width of the

	 * panel. Since, the complete panel is driven by two DSI controllers,

	 * the clock rates have to be split between the two dsi controllers.

	 * Adjust the byte and pixel clock rates for each dsi host accordingly.

 CPHY "byte_clk" is in units of 16 bits */

	/*

	 * esc clock is byte clock followed by a 4 bit divider,

	 * we need to find an escape clock frequency within the

	 * mipi DSI spec range within the maximum divider limit

	 * We iterate here between an escape clock frequencey

	 * between 20 Mhz to 5 Mhz and pick up the first one

	 * that can be supported by our divider

		/*

		 * TODO: Ideally, we shouldn't know what sort of divider

		 * is available in mmss_cc, we're just assuming that

		 * it'll always be a 4 bit divider. Need to come up with

		 * a better way here.

		/* Always set low power stop mode for BLLP

		 * to let command engine send packets

 Do not swap RGB colors */

 Do not swap RGB colors */

 Always insert DCS command */

 Always assume dedicated TE pin */

 allow only ack-err-status to generate interrupt */

 take sync start as 0 */

	/*

	 * For bonded DSI mode, the current DRM mode has

	 * the complete width of the panel. Since, the complete

	 * panel is driven by two DSI controllers, the horizontal

	 * timings have to be split between the two dsi controllers.

	 * Adjust the DSI host timing values accordingly.

 command mode */

 image data and 1 byte write_memory_start cmd */

 clocks need to be enabled before reset */

 make sure reset happen */

 command mode */

 delay 4 ms to skip BLLP */

	/*

	 * This is possible if we're tearing down before we've had a chance to

	 * fully initialize. A very real possibility if our probe is deferred,

	 * in which case we'll hit msm_dsi_host_destroy() without having run

	 * through the dsi_tx_buf_alloc().

/*

 * prepare cmd buffer to be txed

 MSM specific command format in memory */

 Last packet */

 Long packet */

 Append 0xff to the end */

/*

 * dsi_short_read1_resp: 1 parameter

 strip out dcs type */

/*

 * dsi_short_read2_resp: 2 parameter

 strip out dcs type */

 strip out 4 byte dcs header */

 4 x 32 bits registers only */

	/*

	 * In case of multiple reads from the panel, after the first read, there

	 * is possibility that there are some bytes in the payload repeating in

	 * the RDBK_DATA registers. Since we read all the parameters from the

	 * panel right from the first byte for every pass. We need to skip the

	 * repeating bytes and then append the new parameters to the rx buffer.

		/* Any data more than 16 bytes will be shifted out.

		 * The temp read buffer should already contain these bytes.

		 * The remaining bytes in read buffer are the repeated bytes.

 to host byte order */

	/* for video mode, do not send cmds more than

	* one pixel line, since it only transmit it

	* during BLLP.

	/* TODO: if the command is sent in LP mode, the bit rate is only

	 * half of esc clk rate. In this case, if the video is already

	 * actively streaming, we need to check more carefully if the

	 * command can be fit into one BLLP.

	/*

	 * dsi controller need to be disabled before

	 * clocks turned on

 make sure clocks enabled */

 dsi controller can only be reset while clocks are running */

 make sure reset happen */

 controller out of reset */

 make sure dsi controller enabled again */

 It is safe to clear here because error irq is disabled. */

 enable dsi error interrupt */

 Writing of an extra 0 needed to clear error bits */

 fifo underflow, overflow */

 disable dsi error interrupt */

 Some gpios defined in panel DT need to be controlled by host */

/*

 * List of supported physical to logical lane mappings.

 * For example, the 2nd entry represents the following mapping:

 *

 * "3012": Logic 3->Phys 0; Logic 0->Phys 1; Logic 1->Phys 2; Logic 2->Phys 3;

	/*

	 * compare DT specified physical-logical lane mappings with the ones

	 * supported by hardware

		/*

		 * the data-lanes array we get from DT has a logical->physical

		 * mapping. The "data lane swap" register field represents

		 * supported configurations in a physical->logical mapping.

		 * Translate the DT mapping to what we understand and find a

		 * configuration that works.

	/*

	 * Get the endpoint of the output port of the DSI host. In our case,

	 * this is mapped to port number with reg = 1. Don't return an error if

	 * the remote endpoint isn't defined. It's possible that there is

	 * nothing connected to the dsi output.

 Get panel node from the output port's endpoint data */

 fixup base address by io offset */

 OPP table is optional */

 do not autoenable, will be enabled later */

 setup workqueue */

 Register mipi dsi host */

		/* If the panel driver has not been probed after host register,

		 * we should defer the host's probe.

		 * It makes sure panel is connected when fbcon detects

		 * connector status and gets the proper display mode to

		 * create framebuffer.

		 * Don't try to defer if there is nothing connected to the dsi

		 * output

	/* TODO: make sure dsi_cmd_mdp is idle.

	 * Since DSI6G v1.2.0, we can set DSI_TRIG_CTRL.BLOCK_DMA_WITHIN_FRAME

	 * to ask H/W to wait until cmd mdp is idle. S/W wait is not needed.

	 * How to handle the old versions? Wait for mdp cmd done?

	/*

	 * mdss interrupt is generated in mdp core clock domain

	 * mdp clock need to be enabled to receive dsi interrupt

 TODO: vote for bus bandwidth */

 TODO: unvote for bus bandwidth */

 first read */

 4 header + 2 crc */

 Clear the RDBK_DATA registers */

 make sure the RDBK registers are cleared */

 release cleared status before transfer */

		/*

		 * once cmd_dma_done interrupt received,

		 * return data from client is ready and stored

		 * at RDBK_DATA register already

		 * since rx fifo is 16 bytes, dcs header is kept at first loop,

		 * after that dcs header lost during shift into registers

 2 crc */

 next start position */

 NOT first read */

	/*

	 * For single Long read, if the requested rlen < 10,

	 * we need to shift the start position of rx

	 * data buffer to skip the bytes which are not

	 * updated.

 Make sure trigger happens */

 Make sure fully reset */

	/* CPHY transmits 16 bits over 7 clock cycles

	 * "byte_clk" is in units of 16-bits (see dsi_calc_pclk),

	 * so multiply by 7 to get the "bitclk rate"

	/* TODO: clock should be turned off for command mode,

	 * and only turned on before MDP START.

	 * This part of code should be enabled once mdp driver support it.

	/* if (msm_panel->mode == MSM_DSI_CMD_MODE) {

	 *	dsi_link_clk_disable(msm_host);

	 *	pm_runtime_put_autosuspend(&msm_host->pdev->dev);

	 * }

	/* Since we have disabled INTF, the video engine won't stop so that

	 * the cmd engine will be blocked.

	 * Reset to disable video engine so that we can send off cmd.

 draw checkered rectangle pattern */

 use 24-bit RGB test pttern */

 initial value for test pattern */

 draw checkered rectangle pattern */

 enable the test pattern generator */

 for command mode need to trigger one frame from tpg */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

/*

 * DSI PLL 28nm - clock diagram (eg: DSI0):

 *

 *         dsi0analog_postdiv_clk

 *                             |         dsi0indirect_path_div2_clk

 *                             |          |

 *                   +------+  |  +----+  |  |\   dsi0byte_mux

 *  dsi0vco_clk --o--| DIV1 |--o--| /2 |--o--| \   |

 *                |  +------+     +----+     | m|  |  +----+

 *                |                          | u|--o--| /4 |-- dsi0pllbyte

 *                |                          | x|     +----+

 *                o--------------------------| /

 *                |                          |/

 *                |          +------+

 *                o----------| DIV3 |------------------------- dsi0pll

 *                           +------+

 v2.0.0 28nm LP implementation */

 Loop filter resistance: */

	/*

	 * Add HW recommended delays after toggling the software

	 * reset bit off and back on.

/*

 * Clock Callbacks

 Force postdiv2 to be div-4 */

 Configure the Loop filter resistance */

 Loop filter capacitance values : c1 and c2 */

 Add hardware recommended delay for correct PLL configuration */

 Check to see if the ref clk doubler is enabled */

 see if it is integer mode or sdm mode */

 integer mode */

 sdm mode */

	/*

	 * PLL power up sequence.

	 * Add necessary delays recommended by hardware.

 DSI Uniphy lock detect setting */

 poll for PLL ready status */

		/*

		 * PLL power up sequence.

		 * Add necessary delays recommended by hardware.

	/*

	 * PLL power up sequence.

	 * Add necessary delays recommended by hardware.

 DSI PLL toggle lock detect setting */

/*

 * PLL Callbacks

	/*

	 * Wait for the registers writes to complete in order to

	 * ensure that the phy is completely disabled

 1.8 V */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2012-2015, The Linux Foundation. All rights reserved.

/*

 * DSI PLL 28nm (8960/A family) - clock diagram (eg: DSI1):

 *

 *

 *                        +------+

 *  dsi1vco_clk ----o-----| DIV1 |---dsi1pllbit (not exposed as clock)

 *  F * byte_clk    |     +------+

 *                  | bit clock divider (F / 8)

 *                  |

 *                  |     +------+

 *                  o-----| DIV2 |---dsi0pllbyte---o---> To byte RCG

 *                  |     +------+                 | (sets parent rate)

 *                  | byte clock divider (F)       |

 *                  |                              |

 *                  |                              o---> To esc RCG

 *                  |                                (doesn't set parent rate)

 *                  |

 *                  |     +------+

 *                  o-----| DIV3 |----dsi0pll------o---> To dsi RCG

 *                        +------+                 | (sets parent rate)

 *                  dsi clock divider (F * magic)  |

 *                                                 |

 *                                                 o---> To pixel rcg

 *                                                  (doesn't set parent rate)

/*

 * Clock Callbacks

 multiply by 2 */

	/*

	 * before enabling the PLL, configure the bit clock divider since we

	 * don't expose it as a clock to the outside world

	 * 1: read back the byte clock divider that should already be set

	 * 2: divide by 8 to get bit clock divider

	 * 3: write it to POSTDIV1

 enable the PLL */

/*

 * Custom byte clock divier clk_ops

 *

 * This clock is the entry point to configuring the PLL. The user (dsi host)

 * will set this clock's rate to the desired byte clock rate. The VCO lock

 * frequency is a multiple of the byte clock rate. The multiplication factor

 * (shown as F in the diagram above) is a function of the byte clock rate.

 *

 * This custom divider clock ensures that its parent (VCO) is set to the

 * desired rate, and that the byte clock postdivider (POSTDIV2) is configured

 * accordingly

 find multiplication factor(wrt byte clock) at which the VCO should be set */

 convert to bit clock in Mhz */

 Our special byte clock divider ops */

/*

 * PLL Callbacks

 prepare and register bytediv */

 DIV2 */

 DIV3 */

 strength control */

 phy ctrl */

	/*

	 * Wait for the registers writes to complete in order to

	 * ensure that the phy is completely disabled

 1.8 V */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

 non LDO mode */

 make sure everything is written before enable */

 1.8 V */

 1.0 V */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2015, The Linux Foundation. All rights reserved.

 reset */

 adjust */

 Precision, should avoid overflow */

 Calculate clk_zero after clk_prepare and hs_rqst */

 Precision, should avoid overflow */

 Precision, should avoid overflow */

 Precision, should avoid overflow */

	/* TODO: verify these calculations against latest downstream driver

	 * everything except clk_post/clk_pre uses calculations from v3 based

	 * on the downstream driver having the same calculations for v3 and v4

	/* recommended min

	 * = roundup((mipi_min_ns + t_hs_trail_ns)/(16*bit_clk_ns), 0) - 1

	/* recommended min

	 * val1 = (tlpx_ns + clk_prepare_ns + clk_zero_ns + hs_rqst_ns)

	 * val2 = (16 * bit_clk_ns)

	 * final = roundup(val1/val2, 0) - 1

 Precision, should avoid overflow */

/*

 * Currently, we only support one SoC for each PHY type. When we have multiple

 * SoCs for the same PHY, we can try to make the index searching a bit more

 * clever.

	/* PLL init will call into clk_register which requires

	 * register access, so we need to enable power and ahb clock.

	/*

	 * Resetting DSI PHY silently changes its PLL registers to reset status,

	 * which will confuse clock driver and result in wrong output rate of

	 * link clocks. Restore PLL status if its PLL is being used as clock

	 * source.

 Returns true if we have to clear DSI_LANE_CTRL.HS_REQ_SEL_PHY */

 Do not try accessing PLL registers if it is switched off */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (c) 2016, The Linux Foundation. All rights reserved.

/*

 * DSI PLL 14nm - clock diagram (eg: DSI0):

 *

 *         dsi0n1_postdiv_clk

 *                         |

 *                         |

 *                 +----+  |  +----+

 *  dsi0vco_clk ---| n1 |--o--| /8 |-- dsi0pllbyte

 *                 +----+  |  +----+

 *                         |           dsi0n1_postdivby2_clk

 *                         |   +----+  |

 *                         o---| /2 |--o--|\

 *                         |   +----+     | \   +----+

 *                         |              |  |--| n2 |-- dsi0pll

 *                         o--------------| /   +----+

 *                                        |/

 SSC enable/disable */

 fixed params */

 calculated */

 protects REG_DSI_14nm_PHY_CMN_CLK_CFG0 register */

/*

 * Private struct for N1/N2 post-divider clocks. These clocks are similar to

 * the generic clk_divider class of clocks. The only difference is that it

 * also sets the slave DSI PLL's post-dividers if in bonded DSI mode

 divider params */

 same flags as used by clk_divider struct */

/*

 * Global list of private DSI PLL struct pointers. We need this for bonded DSI

 * mode, where the master PLL's clk_ops needs access the slave's private data

 fixed input */

	/*

	 * SSC is enabled by default. We might need DT props for configuring

	 * some SSC params like PPM and center/down spread etc.

 down spread by default */

 PPM / 1000 */

 default recommended */

 take lower 16 bits */

 10 bits */

 unit is Mhz */

 10 bits */

 enable */

 make sure register committed */

 confgiure the non frequency dependent pll registers */

 bandgap_timer */

 pll_wakeup_timer */

 de assert pll start and apply pll sw reset */

 stop pll */

 pll sw reset */

 make sure register committed */

 make sure register committed */

 Use the /2 path in Mux */

 data, clk, pll normal operation */

 configure the frequency dependent pll registers */

 plllock_rng */

	/*

	 * High nibble configures the post divider internal to the VCO. It's

	 * fixed to divide by 1 for now.

	 *

	 * 0: divided by 1

	 * 1: divided by 2

	 * 2: divided by 4

	 * 3: divided by 8

 make sure register committed */

/*

 * VCO clock Callbacks

	/* commit the slave DSI PLL registers if we're master. Note that we

	 * don't lock the slave PLL. We just ensure that the PLL/PHY registers

	 * of the master and slave are identical

	/*

	 * Recalculating the rate from dec_start and frac_start doesn't end up

	 * the rate we originally set. Convert the freq to KHz, round it up and

	 * convert it back to MHz.

/*

 * N1 and N2 post-divider clock callbacks

	/* If we're master in bonded DSI mode, then the slave PLL's post-dividers

	 * follow the master's post dividers

/*

 * PLL Callbacks

 also restore post-dividers for slave DSI PLL */

 both N1 and N2 postdividers are 4 bits wide */

 range of each divider is from 1 to 15 */

 N1 postdiv, bits 0-3 in REG_DSI_14nm_PHY_CMN_CLK_CFG0 */

 DSI Byte clock = VCO_CLK / N1 / 8 */

	/*

	 * Skip the mux for now, force DSICLK_SEL to 1, Add a /2 divider

	 * on the way. Don't let it set parent.

	/* DSI pixel clock = VCO_CLK / N1 / 2 / N2

	 * This is the output of N2 post-divider, bits 4-7 in

	 * REG_DSI_14nm_PHY_CMN_CLK_CFG0. Don't let it set parent.

 4 data lanes + 1 clk lane configuration */

 Make sure PLL is not start */

 make sure everything is written before reset and enable */

 reset digital block */

 ensure reset is asserted */

 Remove power down from PLL and all lanes */

 ensure that the phy is completely disabled */

/*

 * SPDX-License-Identifier: GPL-2.0

 * Copyright (c) 2018, The Linux Foundation

/*

 * DSI PLL 7nm - clock diagram (eg: DSI0): TODO: updated CPHY diagram

 *

 *           dsi0_pll_out_div_clk  dsi0_pll_bit_clk

 *                              |                |

 *                              |                |

 *                 +---------+  |  +----------+  |  +----+

 *  dsi0vco_clk ---| out_div |--o--| divl_3_0 |--o--| /8 |-- dsi0_phy_pll_out_byteclk

 *                 +---------+  |  +----------+  |  +----+

 *                              |                |

 *                              |                |         dsi0_pll_by_2_bit_clk

 *                              |                |          |

 *                              |                |  +----+  |  |\  dsi0_pclk_mux

 *                              |                |--| /2 |--o--| \   |

 *                              |                |  +----+     |  \  |  +---------+

 *                              |                --------------|  |--o--| div_7_4 |-- dsi0_phy_pll_out_dsiclk

 *                              |------------------------------|  /     +---------+

 *                              |          +-----+             | /

 *                              -----------| /4? |--o----------|/

 *                                         +-----+  |           |

 *                                                  |           |dsiclk_sel

 *                                                  |

 *                                                  dsi0_pll_post_out_div_clk

 Hardware is V4.1 */

 out */

 protects REG_DSI_7nm_PHY_CMN_CLK_CFG0 register */

/*

 * Global list of private DSI PLL struct pointers. We need this for bonded DSI

 * mode, where the master PLL's clk_ops needs access the slave's private data

 TODO: ssc enable */

 flush, ensure all register writes are done*/

	/*

	 * Reset the PHY digital domain. This would be needed when

	 * coming out of a CX or analog rail power collapse while

	 * ensuring that the pads maintain LP00 or LP11 state

 Ensure that the reset is deasserted */

 Ensure that the reset is deasserted */

 Start PLL */

	/*

	 * ensure all PLL configurations are written prior to checking

	 * for PLL lock.

 Check for PLL lock */

	/*

	 * assert power on reset for PHY digital in case the PLL is

	 * enabled after CX of analog domain power collapse. This needs

	 * to be done before enabling the global clk.

	/*

	 * To avoid any stray glitches while abruptly powering down the PLL

	 * make sure to gate the clock using the clock enable bit before

	 * powering down the PLL

 flush, ensure all register writes are done */

	/*

	 * TODO:

	 *	1. Assumes prescaler is disabled

/*

 * PLL Callbacks

 internal PLL */

 external PLL */

 set PLL src */

/*

 * The post dividers and mux clocks are created using the standard divider and

 * mux API. Unlike the 14nm PHY, the slave PLL doesn't need its dividers/mux

 * state to follow the master PLL's divider/mux state. Therefore, we don't

 * require special clock ops that also configure the slave PLL registers

 BIT CLK: DIV_CTRL_3_0 */

 DSI Byte clock = VCO_CLK / OUT_DIV / BIT_DIV / 8 */

	/* in CPHY mode, pclk_mux will always have post_out_div as parent

	 * don't register a pclk_mux clock and just use post_out_div instead

 PIX CLK DIV : DIV_CTRL_7_4*/

 TODO: Remove this when we have proper display handover support */

 make sure read happened */

 TODO: Support all lane swap configs */

	/*

	 * LPRX and CDRX need to enabled only for physical data lane

	 * corresponding to the logical data lane 0

 Strength ctrl settings */

		/*

		 * Disable LPRX and CDRX for all lanes. And later on, it will

		 * be only enabled for the physical data lane corresponding

		 * to the logical data lane 0

 other settings */

 wait for REFGEN READY */

 TODO: CPHY enable path (this is for DPHY only) */

 Alter PHY configurations if data rate less than 1.5GHZ*/

 For C-PHY, no low power settings for lower clk rate */

 de-assert digital and pll power down */

 Assert PLL core reset */

 turn off resync FIFO */

 program CMN_CTRL_4 for minor_ver 2 chipsets*/

 Configure PHY lane swap (TODO: we need to calculate this) */

 Enable LDO */

 Remove power down from all blocks */

 Select full-rate mode */

 DSI PHY timings */

 DSI lane settings */

 disable all lanes */

 Turn off all PHY blocks */

 make sure phy is turned off */

/*

 * SPDX-License-Identifier: GPL-2.0

 * Copyright (c) 2018, The Linux Foundation

/*

 * DSI PLL 10nm - clock diagram (eg: DSI0):

 *

 *           dsi0_pll_out_div_clk  dsi0_pll_bit_clk

 *                              |                |

 *                              |                |

 *                 +---------+  |  +----------+  |  +----+

 *  dsi0vco_clk ---| out_div |--o--| divl_3_0 |--o--| /8 |-- dsi0_phy_pll_out_byteclk

 *                 +---------+  |  +----------+  |  +----+

 *                              |                |

 *                              |                |         dsi0_pll_by_2_bit_clk

 *                              |                |          |

 *                              |                |  +----+  |  |\  dsi0_pclk_mux

 *                              |                |--| /2 |--o--| \   |

 *                              |                |  +----+     |  \  |  +---------+

 *                              |                --------------|  |--o--| div_7_4 |-- dsi0_phy_pll_out_dsiclk

 *                              |------------------------------|  /     +---------+

 *                              |          +-----+             | /

 *                              -----------| /4? |--o----------|/

 *                                         +-----+  |           |

 *                                                  |           |dsiclk_sel

 *                                                  |

 *                                                  dsi0_pll_post_out_div_clk

 v3.0.0 10nm implementation that requires the old timings settings */

 out */

 protects REG_DSI_10nm_PHY_CMN_CLK_CFG0 register */

/*

 * Global list of private DSI PLL struct pointers. We need this for bonded DSI

 * mode, where the master PLL's clk_ops needs access the slave's private data

 flush, ensure all register writes are done*/

 Start PLL */

	/*

	 * ensure all PLL configurations are written prior to checking

	 * for PLL lock.

 Check for PLL lock */

	/*

	 * To avoid any stray glitches while abruptly powering down the PLL

	 * make sure to gate the clock using the clock enable bit before

	 * powering down the PLL

 flush, ensure all register writes are done */

	/*

	 * TODO:

	 *	1. Assumes prescaler is disabled

/*

 * PLL Callbacks

 internal PLL */

 external PLL */

 set PLL src */

/*

 * The post dividers and mux clocks are created using the standard divider and

 * mux API. Unlike the 14nm PHY, the slave PLL doesn't need its dividers/mux

 * state to follow the master PLL's divider/mux state. Therefore, we don't

 * require special clock ops that also configure the slave PLL registers

 BIT CLK: DIV_CTRL_3_0 */

 DSI Byte clock = VCO_CLK / OUT_DIV / BIT_DIV / 8 */

 PIX CLK DIV : DIV_CTRL_7_4*/

 TODO: Remove this when we have proper display handover support */

 make sure read happened */

 TODO: Support all lane swap configs */

	/*

	 * LPRX and CDRX need to enabled only for physical data lane

	 * corresponding to the logical data lane 0

 Strength ctrl settings */

		/*

		 * Disable LPRX and CDRX for all lanes. And later on, it will

		 * be only enabled for the physical data lane corresponding

		 * to the logical data lane 0

 other settings */

 Toggle BIT 0 to release freeze I/0 */

 wait for REFGEN READY */

 de-assert digital and pll power down */

 Assert PLL core reset */

 turn off resync FIFO */

 Select MS1 byte-clk */

 Enable LDO */

 Configure PHY lane swap (TODO: we need to calculate this) */

 DSI PHY timings */

 Remove power down from all blocks */

 power up lanes */

 TODO: only power up lanes that are used */

 Select full-rate mode */

 DSI lane settings */

 disable all lanes */

 Turn off all PHY blocks */

 make sure phy is turned off */

 SPDX-License-Identifier: GPL-2.0

 Copyright (c) 2018 The Linux Foundation. All rights reserved. */

 ignore IB-targets */

 ignore if there has not been a ctx switch: */

 wait for idle before cache flush/interrupt */

 All fields present (bits 9:0) */

 Disable/Enable Real-Time Stream processing (present but ignored) */

 Enable (2D <-> 3D) implicit synchronization (present but ignored) */

	/* Vertex and Pixel Shader Start Addresses in instructions

 Maximum Contexts */

	/* Write Confirm Interval and The CP will wait the

 NQ and External Memory Swap */

 protected mode error checking (0x1f2 is REG_AXXX_CP_INT_CNTL) */

 Disable header dumping and Header dump address */

 Header dump size */

 enable protected mode */

 halt ME to avoid ucode upload issues on a20x */

 note: kgsl uses 0x00000001 after first reset on a22x */

 note: kgsl uses 0x0000ffff for a20x */

 MPU: physical range */

 same as parameters in adreno_gpu */

 0x200 for msm8960? */

 0x80/0x1a0 for a22x? */

 note: gsl doesn't set this */

	/* NOTE: PM4/micro-engine firmware registers look to be the same

	 * for a2xx and a3xx.. we could possibly push that part down to

	 * adreno_gpu base class.  Or push both PM4 and PFP but

	 * parameterize the pfp ucode addr/data registers..

 Load PM4: */

 Load PFP: */

 clear ME_HALT to start micro engine */

 dump registers before resetting gpu, if enabled: */

 wait for ringbuffer to drain: */

 then wait for GPU to finish: */

 TODO maybe we need to reset GPU here to recover from hang? */

 only RB_INT is expected */

 sentinel */

 sentinel */

 sentinel */

 would be nice to not have to duplicate the _show() stuff with printk(): */

 TODO */

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 *

 * Copyright (c) 2014 The Linux Foundation. All rights reserved.

	/*

	 * Check for a firmware-name property.  This is the new scheme

	 * to handle firmware that may be signed with device specific

	 * keys, allowing us to have a different zap fw path for different

	 * devices.

	 *

	 * If the firmware-name property is found, we bypass the

	 * adreno_request_fw() mechanism, because we don't need to handle

	 * the /lib/firmware/qcom/... vs /lib/firmware/... case.

	 *

	 * If the firmware-name property is not found, for backwards

	 * compatibility we fall back to the fwname from the gpulist

	 * table.

 Request the MDT file from the default location: */

		/*

		 * For new targets, we require the firmware-name property,

		 * if a zap-shader is required, rather than falling back

		 * to a firmware name specified in gpulist.

		 *

		 * Because the firmware is signed with a (potentially)

		 * device specific key, having the name come from gpulist

		 * was a bad idea, and is only provided for backwards

		 * compatibility for older targets.

 Figure out how much memory we need */

 Allocate memory for the firmware image */

	/*

	 * Load the rest of the MDT

	 *

	 * Note that we could be dealing with two different paths, since

	 * with upstream linux-firmware it would be in a qcom/ subdir..

	 * adreno_request_fw() handles this, but qcom_mdt_load() does

	 * not.  But since we've already gotten through adreno_request_fw()

	 * we know which of the two cases it is:

 Send the image to the secure world */

	/*

	 * If the scm call returns -EOPNOTSUPP we assume that this target

	 * doesn't need/support the zap shader so quietly fail

 Short cut if we determine the zap shader isn't available/needed */

 We need SCM to be able to load the firmware */

	/*

	 * Use the aperture start or SZ_16M, whichever is greater. This will

	 * ensure that we align with the allocated pagetable range while still

	 * allowing room in the lower 32 bits for GMEM and whatnot

	/*

	 * Try first to load from qcom/$fwfile using a direct load (to avoid

	 * a potential timeout waiting for usermode helper)

	/*

	 * Then try the legacy location without qcom/ prefix

	/*

	 * Finally fall back to request_firmware() for cases where the

	 * usermode helper is needed (I think mainly android)

 Skip if the firmware has already been loaded */

 reset completed fence seqno: */

 Use this helper to read rptr, since a430 doesn't update rptr in memory */

 XXX pm-runtime??  we *need* the device to be off after this

 so maybe continuing to call ->pm_suspend/resume() is better?

 hmm, oh well? */

 Copy the shadow to the actual register */

	/*

	 * Mask wptr value that we calculate to fit in the HW range. This is

	 * to account for the possibility that the last command fit exactly into

	 * the ringbuffer and rb->next hasn't wrapped to zero yet

 ensure writes to ringbuffer have hit system memory: */

 wait for CP to drain ringbuffer: */

 TODO maybe we need to reset GPU here to recover from hang? */

 Copy at least 'wptr' dwords of the data */

 After wptr find the last non zero dword to save space */

 Some targets prefer to collect their own registers */

 Count the number of registers */

	/*

	 * Ascii85 outputs either a 5 byte string or a 1 byte string. So we

	 * account for the worst case of 5 bytes per dword plus the 1 for '\0'

 len is expected to be in bytes */

		/*

		 * Only dump the non-zero part of the buffer - rarely will

		 * any data completely fill the entire allocated size of

		 * the buffer.

		/*

		 * If we reach here, then the originally captured binary buffer

		 * will be replaced with the ascii85 encoded string

	/*

	 * If this is state collected due to iova fault, so fault related info

	 *

	 * TTBR0 would not be zero, so this is a good way to distinguish

/* Dump common gpu status and scratch registers on any hang, to make

 * the hangcheck logs more useful.  The scratch registers seem always

 * safe to read when GPU has hung (unlike some other regs, depending

 * on how the GPU hung), and they are useful to match up to cmdstream

 * dumps when debugging hangs:

 would be nice to not have to duplicate the _show() stuff with printk(): */

 dump these out in a form that can be parsed by demsm: */

 Use ring->next to calculate free size */

 Get legacy powerlevels from qcom,gpu-pwrlevels and populate the opp table */

		/*

		 * Skip the intentionally bogus clock value found at the bottom

		 * of most legacy frequency tables

 You down with OPP? */

 Find the fastest defined rate */

 Pick a suitably safe clock speed for any target */

			/*

			 * Return success since either the ocmem property was

			 * not specified in device tree, or ocmem support is

			 * not compiled into the kernel.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 *

 * Copyright (c) 2014 The Linux Foundation. All rights reserved.

 ignore IB-targets */

 ignore if there has not been a ctx switch: */

	/* Flush HLSQ lazy updates to make sure there is nothing

	 * pending for indirect loads after the timestamp has

	 * passed:

 wait for idle before cache flush/interrupt */

 BIT(31) of CACHE_FLUSH_TS triggers CACHE_FLUSH_TS IRQ from GPU */

 Dummy set-constant to trigger context rollover */

 Set up 16 deep read/write request queues: */

 Enable WR-REQ: */

 Set up round robin arbitration between both AXI ports: */

 Set up AOOO: */

 Set up 16 deep read/write request queues: */

 Enable WR-REQ: */

 Set up round robin arbitration between both AXI ports: */

 Set up AOOO: */

 Enable 1K sort: */

		/*

		 * Most of the VBIF registers on 8974v2 have the correct

		 * values at power on, so we won't modify those if we don't

		 * need to

 Enable 1k sort: */

 Enable WR-REQ: */

 Set up VBIF_ROUND_ROBIN_QOS_ARB: */

 Set up 16 deep read/write request queues: */

 Enable WR-REQ: */

 Set up round robin arbitration between both AXI ports: */

 Set up VBIF_ROUND_ROBIN_QOS_ARB: */

 Set up AOOO: */

 Enable 1K sort: */

		/* Disable VBIF clock gating. This is to enable AXI running

		 * higher frequency than GPU:

 Make all blocks contribute to the GPU BUSY perf counter: */

 Tune the hystersis counters for SP and CP idle detection: */

	/* Enable the RBBM error reporting bits.  This lets us get

	 * useful information on failure:

 Enable AHB error reporting: */

 Turn on the power counters: */

	/* Turn on hang detection - this spews a lot of useful information

	 * into the RBBM registers on a hang:

 Enable 64-byte cacheline size. HW Default is 32-byte (0x000000E0): */

 Enable Clock gating: */

 Set the OCMEM base address for A330, etc */

 Turn on performance counters: */

 Enable the perfcntrs that we use.. */

	/*

	 * Use the default ringbuffer size and block size but disable the RPTR

	 * shadow

 Set the ringbuffer address */

 setup access protection: */

 RBBM registers */

 CP registers */

 RB registers */

 VBIF registers */

	/* NOTE: PM4/micro-engine firmware registers look to be the same

	 * for a2xx and a3xx.. we could possibly push that part down to

	 * adreno_gpu base class.  Or push both PM4 and PFP but

	 * parameterize the pfp ucode addr/data registers..

 Load PM4: */

 Load PFP: */

 CP ROQ queue sizes (bytes) - RB:16, ST:16, IB1:32, IB2:64 */

		/* NOTE: this (value take from downstream android driver)

		 * includes some bits outside of the known bitfields.  But

		 * A330 has this "MERCIU queue" thing too, which might

		 * explain a new bitfield or reshuffling:

 clear ME_HALT to start micro engine */

 dump registers before resetting gpu, if enabled: */

 wait for ringbuffer to drain: */

 then wait for GPU to finish: */

 TODO maybe we need to reset GPU here to recover from hang? */

 TODO

 sentinel */

 would be nice to not have to duplicate the _show() stuff with printk(): */

 if needed, allocate gmem: */

		/* TODO we think it is possible to configure the GPU to

		 * restrict access to VRAM carveout.  But the required

		 * registers are unknown.  For now just bail out and

		 * limp along with just modesetting.  If it turns out

		 * to not be possible to restrict access, then we must

		 * implement a cmdstream validator.

 allow -ENODATA, ocmem icc is optional */

	/*

	 * Set the ICC path to maximum speed for now by multiplying the fastest

	 * frequency by the bus width (8). We'll want to scale this later on to

	 * improve battery life.

 SPDX-License-Identifier: GPL-2.0

 Copyright (c) 2017-2018 The Linux Foundation. All rights reserved. */

	/*

	 * If we are to assume that the GMU firmware is in fact a rational actor

	 * and is programmed to not send us a larger response than we expect

	 * then we can also assume that if the header size is unexpectedly large

	 * that it is due to memory corruption and/or hardware failure. In this

	 * case the only reasonable course of action is to BUG() to help harden

	 * the failure.

 Cookify any non used data at the end of the write buffer */

 Wait for a response */

 Clear the interrupt */

 Get the next packet */

 If the queue is empty our response never made it */

 All is well, copy over the buffer */

 First dword of the message is the message header - fill it in */

 Currently supporting version 1.1 */

 Send a single "off" entry since the 618 GMU doesn't do bus scaling */

	/*

	 * These are the CX (CNOC) votes - these are used by the GMU but the

	 * votes are known and fixed for the target

	/*

	 * Send a single "off" entry just to get things running

	 * TODO: bus scaling

	/*

	 * These are the CX (CNOC) votes - these are used by the GMU but the

	 * votes are known and fixed for the target

	/*

	 * Send a single "off" entry just to get things running

	 * TODO: bus scaling

	/*

	 * These are the CX (CNOC) votes - these are used by the GMU but the

	 * votes are known and fixed for the target

	/*

	 * Send a single "off" entry just to get things running

	 * TODO: bus scaling

	/*

	 * These are the CX (CNOC) votes - these are used by the GMU but the

	 * votes are known and fixed for the target

	/*

	 * Send a single "off" entry just to get things running

	 * TODO: bus scaling

	/*

	 * These are the CX (CNOC) votes - these are used by the GMU but the

	 * votes are known and fixed for the target

 Send a single "off" entry since the 630 GMU doesn't do bus scaling */

	/*

	 * These are the CX (CNOC) votes.  This is used but the values for the

	 * sdm845 GMU are known and fixed so we can hard code them.

 blocking */

 TODO: bus scaling */

 TODO: should freq and bw fields be non-zero ? */

	/*

	 * We have to get exchange version numbers per the sequence but at this

	 * point th kernel driver doesn't need to know the exact version of

	 * the GMU firmware

	/*

	 * Let the GMU know that there won't be any more HFI messages until next

	 * boot

	/*

	 * Downstream driver sends this in its "a6xx_hw_init" equivalent,

	 * but seems to be no harm in sending it here

 Set up the shared memory header */

	/*

	 * The table size is the size of the table header plus all of the queue

	 * headers

 First queue header is located immediately after the table header */

 Command queue */

 GMU response queue */

 SPDX-License-Identifier: GPL-2.0

 Copyright (c) 2017-2019 The Linux Foundation. All rights reserved. */

 FIXME: add a banner here */

 Turn off the hangcheck timer while we are resetting */

 Queue the GPU handler because we need to treat this as a recovery */

 This can be called from gpu state code so make sure GMU is valid */

 Check to see if the GX rail is still powered */

 This can be called from gpu state code so make sure GMU is valid */

	/*

	 * This can get called from devfreq while the hardware is idle. Don't

	 * bring up the power if it isn't already active

	/*

	 * Send an invalid index as a vote for the bus bandwidth and let the

	 * firmware decide on the right vote

 Set and clear the OOB for DCVS to trigger the GMU */

 SPTP and IFPC both report as IFPC */

 Wait for the GMU to get to its most idle state */

	/* Set the log wptr index

	 * note: downstream saves the value in poweroff and restores it here

/* These are the interrupt / ack bits for each OOB request that are set

 * in a6xx_gmu_set_oob and a6xx_clear_oob

 Trigger a OOB (out of band) request to the GMU */

 Trigger the equested OOB operation */

 Wait for the acknowledge interrupt */

 Clear the acknowledge interrupt */

 Clear a pending OOB state in the GMU */

 Enable CPU control of SPTP power power collapse */

 Disable CPU control of SPTP power power collapse */

 Make sure retention is on */

 Let the GMU know we are starting a boot sequence */

 Let the GMU know we are getting ready for boot */

 Choose the "default" power level as the highest available */

 Let the GMU know the boot sequence has started */

 Let the GMU know that we are about to go into slumber */

 Disable the power counter so the GMU isn't busy */

 Disable SPTP_PC if the CPU is responsible for it */

 Tell the GMU to get ready to slumber */

 Check to see if the GMU really did slumber */

 Put fence into allow mode */

 Wait for the register to finish posting */

 Set up CX GMU counter 0 to count busy ticks */

 Enable the power counter */

 Disable SDE clock gating */

 Setup RSC PDC handshake for sleep and wakeup */

 Load RSC sequencer uCode for sleep and wakeup */

 Load PDC sequencer uCode for power up and power down sequence */

 Set TCS commands used by PDC sequence for low power modes */

 Setup GPU PDC */

 ensure no writes happen before the uCode is fully written */

/*

 * The lowest 16 bits of this value are the number of XO clock cycles for main

 * hysteresis which is set at 0x1680 cycles (300 us).  The higher 16 bits are

 * for the shorter hysteresis that happens after main - this is 0xa (.5 us)

 Set up the idle state for the GMU */

 Disable GMU WB/RB buffer */

 Enable RPMh GPU client */

 this should be a general kernel helper */

 Sanity check the size of the firmware that was loaded */

 Turn on register retention */

 We only need to load the RPMh microcode once */

 Write the iova of the HFI table */

 Set up the lowest idle level on the GMU */

 Enable SPTP_PC if the CPU is responsible for it */

 FIXME: Do we need this wmb() here? */

 Make sure there are no outstanding RPMh votes */

 Force the GMU off in case it isn't responsive */

 Flush all the queues */

 Stop the interrupts */

 Force off SPTP in case the GMU is managing it */

 Make sure there are no outstanding RPMh votes */

 so a6xx_gmu_set_freq() doesn't exit early */

 Turn on the resources */

	/*

	 * "enable" the GX power domain which won't actually do anything but it

	 * will make sure that the refcounting is correct in case we need to

	 * bring down the GX after a GMU failure

 Use a known rate to bring up the GMU */

 Set the bus quota to a reasonable value for boot */

 Enable the GMU interrupt */

 Check to see if we are doing a cold or warm boot */

	/*

	 * Warm boot path does not work on newer GPUs

	 * Presumably this is because icache/dcache regions must be restored

	/*

	 * Turn on the GMU firmware fault interrupt after we know the boot

	 * sequence is successful

 Set the GPU to the current freq */

 On failure, shut down the GMU to leave it in a good state */

 Halt new client requests on GBIF */

 Halt all AXI requests on GBIF */

 The GBIF halt needs to be explicitly cleared */

 Gracefully try to shut down the GMU and by extension the GPU */

	/*

	 * The GMU may still be in slumber unless the GPU started so check and

	 * skip putting it back into slumber if so

 If the GMU isn't responding assume it is hung */

 tell the GMU we want to slumber */

		/*

		 * Let the user know we failed to slumber but don't worry too

		 * much because we are powering down anyway

 Turn off HFI */

 Stop the interrupts and mask the hardware */

 Tell RPMh to power off the GPU */

	/*

	 * Force the GMU off if we detected a hang, otherwise try to shut it

	 * down gracefully

 Remove the bus vote */

	/*

	 * Make sure the GX domain is off before turning off the GMU (CX)

	 * domain. Usually the GMU does this but only if the shutdown sequence

	 * was successful

 no fixed address - use GMU's uncached range */

 skip dummy page */

 range for fixed address */

 use IOMMU_PRIV for icache/dcache */

 Return the 'arc-level' for the given frequency */

	/*

	 * The data comes back as an array of unsigned shorts so adjust the

	 * count accordingly

 Construct a vote for each frequency */

 Get the primary index that matches the arc level */

		/*

		 * Look for a level in in the secondary list that matches. If

		 * nothing fits, use the maximum non zero vote

 Construct the vote */

/*

 * The GMU votes with the RPMh for itself and on behalf of the GPU but we need

 * to construct the list of votes on the CPU and send it over. Query the RPMh

 * voltage levels and build the votes

 Build the GX votes */

 Build the CX votes */

	/*

	 * The OPP table doesn't contain the "off" frequency level so we need to

	 * add 1 to the table size to account for it

 Set the "off" frequency */

	/*

	 * The GMU handles its own frequency switching so build a list of

	 * available frequencies to send during initialization

	/*

	 * The GMU also handles GPU frequency switching so build a list

	 * from the GPU OPP table

 Build the list of RPMh votes that we'll send to the GMU */

 Drop reference taken in of_find_device_by_node */

 Fow now, don't do anything fancy until we get our feet under us */

 Get the list of clocks */

	/* A660 now requires handling "prealloc requests" in GMU firmware

	 * For now just hardcode allocations based on the known firmware.

	 * note: there is no indication that these correspond to "dummy" or

	 * "debug" regions, but this "guess" allows reusing these BOs which

	 * are otherwise unused by a660.

 Allocate memory for the GMU dummy page */

 HFI v1, has sptprac */

 Allocate memory for the GMU debug region */

 Allocate memory for for the HFI queues */

 Allocate memory for the GMU log region */

 Map the GMU registers */

 Get the HFI and GMU interrupts */

	/*

	 * Get a link to the GX power domain to reset the GPU in case of GMU

	 * crash

 Get the power levels for the GMU and GPU */

 Set up the HFI queues */

 Drop reference taken in of_find_device_by_node */

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2016 The Linux Foundation. All rights reserved.

/*

 * The GPMU data block is a block of shared registers that can be used to

 * communicate back and forth. These "registers" are by convention with the GPMU

 * firwmare and not bound to any specific hardware design

 AGC_LM_CONFIG (A540+) */

/*

 * Get the actual voltage value for the operating point at the specified

 * frequency

 Setup thermal limit management */

 Write the block of sequence registers */

 Hard code the A530 GPU thermal sensor ID for the GPMU */

 Until we get clock scaling 0 is always the active power level */

 The threshold is fixed at 6000 for A530 */

 Write the voltage table */

 Write the max power - hard coded to 5448 for A530 */

	/*

	 * For now just write the one voltage level - we will do more when we

	 * can do scaling

 The battery current limiter isn't enabled for A540 */

 For now disable GPMU side throttling */

 Until we get clock scaling 0 is always the active power level */

 Fixed at 6000 for now */

 Enable SP/TP cpower collapse */

 Enable the GPMU microcontroller */

 Turn off protected mode for this operation */

 Kick off the IB to load the GPMU microcode */

 Turn back on protected mode */

 Kick off the GPMU */

	/*

	 * Wait for the GPMU to respond. It isn't fatal if it doesn't, we just

	 * won't have advanced power collapse.

 Enable limits management */

 This init sequence only applies to A530 */

 Not all A5xx chips have a GPMU */

 Set up the limits management */

 Set up SP/TP power collpase */

 Start the GPMU */

 Start the limits management */

	/*

	 * The first dword is the size of the remaining data in dwords. Use it

	 * as a checksum of sorts and make sure it matches the actual size of

	 * the firmware that we read

 The second dword is an ID - look for 2 (GPMU_FIRMWARE_ID) */

	/*

	 * A single type4 opcode can only have so many values attached so

	 * add enough opcodes to load the all the commands

 SPDX-License-Identifier: GPL-2.0-only

/* Copyright (c) 2016-2017 The Linux Foundation. All rights reserved.

 for debugfs files that can be written to, we can't use drm helper: */

	/* TODO do we care about trying to make sure the GPU is idle?

	 * Since this is just a debug feature limited to CAP_SYS_ADMIN,

	 * maybe it is fine to let the user keep both pieces if they

	 * try to reset an active GPU.

 SPDX-License-Identifier: GPL-2.0-only

/*

 * Copyright (C) 2013-2014 Red Hat

 * Author: Rob Clark <robdclark@gmail.com>

 *

 * Copyright (c) 2014,2017 The Linux Foundation. All rights reserved.

 a200 on i.mx51 has only 128kib gmem */

 because a305c is revn==306 */

		/*

		 * Increase inactive period to 250 to avoid bouncing

		 * the GDSC which appears to make it grumpy

		/*

		 * Increase inactive period to 250 to avoid bouncing

		 * the GDSC which appears to make it grumpy

 Adreno 509 uses the same ZAP as 512 */

		/*

		 * Increase inactive period to 250 to avoid bouncing

		 * the GDSC which appears to make it grumpy

		/*

		 * Increase inactive period to 250 to avoid bouncing

		 * the GDSC which appears to make it grumpy

		/*

		 * Increase inactive period to 250 to avoid bouncing

		 * the GDSC which appears to make it grumpy

		/*

		 * Increase inactive period to 250 to avoid bouncing

		 * the GDSC which appears to make it grumpy

 identify gpu: */

	/*

	 * The number one reason for HW init to fail is if the firmware isn't

	 * loaded yet. Try that first and don't bother continuing on

	 * otherwise

 Make sure pm runtime is active and reset any previous errors */

 first search the compat strings for qcom,adreno-XYZ.W: */

 and if that fails, fall back to legacy "qcom,chipid" property: */

	/* on imx5, we don't have a top-level mdp/dpu node

	 * this creates a dummy node for the driver for that case

 for compatibility with imx5 gpu: */

 for backwards compat w/ downstream kgsl DT files: */

 SPDX-License-Identifier: GPL-2.0

 Copyright (c) 2017-2019 The Linux Foundation. All rights reserved. */

 Check that the GMU is idle */

 Check tha the CX master is idle */

 wait for CP to drain ringbuffer: */

 Expanded APRIV doesn't need to issue the WHERE_AM_I opcode */

 Copy the shadow to the actual register */

 Make sure to wrap wptr if we need to */

 Make sure everything is posted before making a decision */

 Execute the table update */

	/*

	 * Write the new TTBR0 to the memstore. This is good for debugging.

	/*

	 * And finally, trigger a uche flush to be sure there isn't anything

	 * lingering in that part of the GPU

	/*

	 * For PM4 the GMU register offsets are calculated from the base of the

	 * GPU registers so we need to add 0x1a800 to the register value on A630

	 * to get the right value from PM4.

 Invalidate CCU depth and color */

 Submit the commands */

		/*

		 * Periodically update shadow-wptr if needed, so that we

		 * can see partial progress of submits with large # of

		 * cmds.. otherwise we could needlessly stall waiting for

		 * ringbuffer state, simply due to looking at a shadow

		 * rptr value that has not been updated

 Write the fence to the scratch register */

	/*

	 * Execute a CACHE_FLUSH_TS event. This will ensure that the

	 * timestamp is written to the memory and then triggers the interrupt

 Don't re-program the registers if they are already correct */

 Disable SP clock before programming HWCG registers */

 Enable SP clock */

 For a615, a616, a618, A619, a630, a640 and a680 */

 note: infinite range */

 These are for a620 and a650 */

 note: infinite range */

 These are for a635 and a660 */

 note: infinite range */

	/*

	 * Enable access protection to privileged registers, fault on an access

	 * protect violation and select the last span to protect from the start

	 * address all the way to the end of the register address space

 last CP_PROTECT to have "infinite" length on the last entry */

 a618 is using the hw default values */

 TODO: get ddr type from bootloader and use 2 for LPDDR4 */

 Enable multiple hardware contexts */

 Enable error detection */

 Don't enable header dump */

 No workarounds enabled */

 Pad rest of the cmds with 0's */

/*

 * Check that the microcode version is new enough to include several key

 * security fixes. Return true if the ucode is safe.

	/*

	 * Targets up to a640 (a618, a630 and a640) need to check for a

	 * microcode version that is patched to support the whereami opcode or

	 * one that is new enough to include it by default.

	 *

	 * a650 tier targets don't need whereami but still need to be

	 * equal to or newer than 0.95 for other security fixes

	 *

	 * a660 targets have all the critical security fixes from the start

		/*

		 * If the lowest nibble is 0xa that is an indication that this

		 * microcode has been patched. The actual version is in dword

		 * [3] but we only care about the patchlevel which is the lowest

		 * nibble of dword [3]

		 *

		 * Otherwise check that the firmware is greater than or equal

		 * to 1.90 which was the first version that had this fix built

		 * in

 Make sure the GMU keeps the GPU on while we set it up */

	/*

	 * Disable the trusted memory range - we don't actually supported secure

	 * memory rendering at this point in time and we don't want to block off

	 * part of the virtual memory space.

 Turn on 64 bit addressing for all blocks */

 enable hardware clockgating */

 VBIF/GBIF start*/

 Make all blocks contribute to the GPU BUSY perf counter */

 Disable L2 bypass in the UCHE */

 Set the GMEM VA range [0x100000:0x100000 + gpu->gmem - 1] */

 Setting the mem pool size */

	/* Setting the primFifo thresholds default values,

	 * and vccCacheSkipDis=1 bit (0x200) for A640 and newer

 Set the AHB default slave response to "ERROR" */

 Turn on performance counters */

 Select CP0 to always count cycles */

 Enable fault detection */

 Set weights for bicubic filtering */

 Protect registers from the CP */

 Set dualQ + disable afull for A660 GPU */

 Enable expanded apriv for targets that support it */

 Enable interrupts */

 Set the ringbuffer address */

	/* Targets that support extended APRIV can use the RPTR shadow from

	 * hardware but all the other ones need to disable the feature. Targets

	 * that support the WHERE_AM_I opcode can use that instead

	/*

	 * Expanded APRIV and targets that support WHERE_AM_I both need a

	 * privileged buffer to store the RPTR shadow

 Always come up on rb 0 */

 Enable the SQE_to start the CP engine */

	/*

	 * Try to load a zap shader into the secure world. If successful

	 * we can use the CP to switch out of secure mode. If not then we

	 * have no resource but to try to switch ourselves out manually. If we

	 * guessed wrong then access to the RBBM_SECVID_TRUST_CNTL register will

	 * be blocked and a permissions violation will soon follow.

		/*

		 * This device does not use zap shader (but print a warning

		 * just in case someone got their dt wrong.. hopefully they

		 * have a debug UART to realize the error of their ways...

		 * if you mess this up you are about to crash horribly)

	/*

	 * Tell the GMU that we are done touching the GPU and it can start power

	 * management

 Take the GMU out of its special boot mode */

	/*

	 * Turn off keep alive that might have been enabled by the hang

	 * interrupt

	/*

	 * The source of the data depends on the mid ID read from FSYNR1.

	 * and the client ID read from the UCHE block

 mid = 3 is most precise and refers to only one block per client */

 For mid=2 the source is TP or VFD except when the client id is 0 */

 For mid=1 just return "UCHE" as a catchall for everything else */

	/*

	 * If we aren't going to be resuming later from fault_worker, then do

	 * it now.

	/*

	 * Print a default message if we couldn't get the data from the

	 * adreno-smmu-priv

 Turn off the hangcheck timer to keep it from bothering us */

	/*

	 * If stalled on SMMU fault, we could trip the GPU's hang detection,

	 * but the fault handler will trigger the devcore dump, and we want

	 * to otherwise resume normally rather than killing the submit, so

	 * just bail.

	/*

	 * Force the GPU to stay on until after we finish

	 * collecting information

 Turn off the hangcheck timer to keep it from bothering us */

	/*

	 * For targets with a MMU500, activate the slice but don't program the

	 * register.  The XBL will take care of that.

	/*

	 * Program the slice IDs for the various GPU blocks and GPU MMU

	 * pagetables

		/*

		 * Program cacheability overrides to not allocate cache

		 * lines on a write miss

	/* On A660, the SCID programming for UCHE traffic is done in

	 * A6XX_GBIF_SCACHE_CNTL0[14:10]

	/*

	 * There is a different programming path for targets with an mmu500

	 * attached, so detect if that is the case

 Force the GPU power on so we can read this register */

 Only read the gpu busy if the hardware is already active */

	/*

	 * This allows GPU to set the bus attributes required to use system

	 * cache on behalf of the iommu page table walker.

	/*

	 * Use the aperture start or SZ_16M, whichever is greater. This will

	 * ensure that we align with the allocated pagetable range while still

	 * allowing room in the lower 32 bits for GMEM and whatnot

	/*

	 * -ENOENT means that the platform doesn't support speedbin which is

	 * fine

	/*

	 * We need to know the platform type before calling into adreno_gpu_init

	 * so that the hw_apriv flag can be correctly set. Snoop into the info

	 * and grab the revision number

	/*

	 * For now only clamp to idle freq for devices where this is known not

	 * to cause power supply issues:

 Check if there is a GMU phandle and set it up */

 FIXME: How do we gracefully handle this? */

